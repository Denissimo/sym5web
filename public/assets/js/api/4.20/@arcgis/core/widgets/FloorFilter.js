/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{substitute as t}from"../intl.js";import{e as s}from"../core/promiseUtils.js";import{watch as i}from"../core/watchUtils.js";import{aliasOf as l}from"../core/accessorSupport/decorators/aliasOf.js";import"../core/lang.js";import"../chunks/ensureType.js";import"../chunks/Logger.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import{R as r}from"../chunks/ResizeObserver.js";import a from"./Widget.js";import c from"./FloorFilter/FloorFilterViewModel.js";import{H as d}from"../chunks/Heading.js";import{s as h,i as u}from"../chunks/widgetUtils.js";import{m as v}from"../chunks/messageBundle.js";import{t as m}from"../chunks/jsxFactory.js";import"../chunks/number.js";import"../chunks/jsonMap.js";import"../chunks/object.js";import"../chunks/locale.js";import"../chunks/string.js";import"../core/Error.js";import"../chunks/Message.js";import"../config.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/assets.js";import"../chunks/metadata.js";import"../chunks/handleUtils.js";import"../chunks/_commonjsHelpers.js";import"../chunks/deprecate.js";import"../chunks/domUtils.js";import"../chunks/Evented.js";import"../core/Accessor.js";import"../chunks/ArrayPool.js";import"../chunks/arrayUtils.js";import"../core/scheduling.js";import"../core/Handles.js";import"../core/Collection.js";import"../chunks/Promise.js";import"../chunks/uuid.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/projector.js";import"../chunks/jsxWidgetSupport.js";import"../core/HandleOwner.js";import"../chunks/Widgets.js";import"../chunks/JSONSupport.js";import"../chunks/write.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../TimeInterval.js";import"../chunks/GoTo.js";import"../chunks/mathUtils.js";const f="esri-widget",p="esri-widget--button",_="esri-widget--button-active",g="esri-button--disabled",M="esri-icon",w="esri-interactive",b="esri-widget__content--empty",y="esri-floor-filter",k="esri-floor-filter__layout--",j="esri-floor-filter__position--",I="esri-floor-filter__button-container",N="esri-floor-filter__button-info",T="esri-floor-filter__button-label",F="esri-floor-filter__browse-button",L="esri-floor-filter__close-levels-button",x="esri-floor-filter__zoom-button",C="esri-floor-filter__zoom-button--levels",S="esri-floor-filter__minimize-toggle-button",B="esri-floor-filter__levels-container",E="esri-floor-filter__level-button",O="esri-floor-filter__separator",z="esri-floor-filter__filter-menu",A="esri-floor-filter__filter-menu-header",U="esri-floor-filter__filter-menu-header-text-group",$="esri-floor-filter__filter-menu-header-text",P="esri-floor-filter__filter-menu-header-subtext",W="esri-floor-filter__filter-menu-header-back",H="esri-floor-filter__filter-menu-search",D="esri-floor-filter__filter-menu-search-input",K="esri-floor-filter__filter-menu-items",R="esri-floor-filter__filter-menu-item-name",Z="esri-floor-filter__filter-menu-item-name--selected",q="esri-floor-filter__filter-menu-site",G="esri-floor-filter__filter-menu-facility",J="esri-floor-filter__selected-item-circle",V="esri-icon-urban-model",Q="esri-icon-zoom-to-object",X="esri-icon-collapse",Y="esri-icon-expand",ee="esri-icon-close",te="esri-icon-search",se="esri-icon-right",ie="esri-icon-left",le=["ArrowUp","ArrowDown","End","Home"];let oe=class extends a{constructor(e,t){super(e,t),this._activeMenu=null,this._activeMenuIndex={levels:-1,menuItems:-1},this._baseNode=null,this._facilitiesListNode=null,this._levelsListNode=null,this._sitesListNode=null,this._searchInput=null,this.enabled=null,this.longNames=null,this.minimized=null,this.pinnedLevels=null,this.site=null,this.facility=null,this.level=null,this.view=null,this.viewModel=new c,this.messages=null,this.messagesCommon=null,this.goToOverride=null,this.headingLevel=2,this._resizeObserver=new r((()=>this.scheduleRender())),this.own(i(this,"_searchInput",(()=>this._focusSearch())))}destroy(){this._resizeObserver.disconnect()}updateWebDocument(){}render(){var e;const{longNames:t}=this,s=t&&this.viewModel.isNormalMode?"expanded":"collapsed",i=this.renderButtons(),l=this.renderFilterMenu(),o=m("div",{class:this.classes(O)}),n=this._getComponentPosition(),r=this._getPosition(n),a="top-right"===n||"bottom-right"===n,c="top-left"===n||"bottom-left"===n,d=u(),h=d&&c||!d&&a?l:i,v=d&&c||!d&&a?i:l;return m("div",{afterCreate:this._afterBaseNodeCreate,key:"floor-filter-menu",class:this.classes(y,f,`${k}${s}`,`${j}${r}`)},h,(null==(e=this.viewModel)?void 0:e.filterMenuOpen)&&o,v)}renderButtons(){const e=this._getComponentPosition(),t=[];return"top"===this._getPosition(e)?(t.push(this.renderBrowseButton()),t.push(this.renderLevelButtons()),t.push(this.renderCloseLevelsButton()),t.push(this.renderZoomButton()),t.push(this.renderCollapseToggleButton())):(t.push(this.renderCollapseToggleButton()),t.push(this.renderZoomButton()),t.push(this.renderCloseLevelsButton()),t.push(this.renderLevelButtons()),t.push(this.renderBrowseButton())),m("div",{key:"button-container",class:this.classes(f,I)},t)}renderBrowseButton(){var e;const{longNames:t,messages:s}=this;return m("button",{key:"browse-button",title:s.buttons.browse,bind:this,class:this.classes(f,p,w,("loading"===this.viewModel.state||"disabled"===this.viewModel.state)&&g,F,(null==(e=this.viewModel)?void 0:e.filterMenuOpen)&&_),"aria-expanded":this.viewModel.filterMenuOpen.toString(),"aria-label":s.buttons.browse,onclick:this._toggleFilterMenu},m("div",{class:this.classes(N)},m("span",{class:this.classes(M,V)}),m("span",{class:this.classes(T)},t&&this.viewModel.isNormalMode&&s.buttons.browse)))}renderLevelButtons(){var e,s,i,l,o;if(null==(e=this.viewModel)||null==(s=e.filterFeatures)||null==(i=s.levels)||!i.levelsInfo||!this.facility)return null;const{facility:n,messagesCommon:r,messages:a}=this,c=null==(l=this.viewModel)?void 0:l.getFacility(n),d=(null==(o=this.viewModel)?void 0:o.getFacilityLevels(n)).map((e=>this.renderLevelButton(e)));if(!d.length)return null;const u=c&&t(a.selector.levelsLabel,{name:`"${c.name}"`});if(this._isWebScene(this.view.map)&&(null==d?void 0:d.length)>1){const e={id:`all--${n}`,facilityId:n,shortName:r.all,longName:r.all,levelNumber:null,verticalOrder:null},t=this.renderLevelButton(e);d.push(t)}return m("ul",{key:"levels-button-container",class:this.classes(B),bind:this,"data-id":"levels",afterCreate:h,"data-node-ref":"_levelsListNode","aria-label":u,onkeydown:this._handleListKeydown},d)}renderLevelButton(e){const{longNames:t}=this,{shortName:s,longName:i,id:l}=e,o=`levels--${l}`,n=this.level===l,r=t&&this.viewModel.isNormalMode?i:s;return this.viewModel.isNormalMode||n||this.viewModel.levelsExpanded?m("li",{key:o},m("button",{"data-id":l,"data-list-id":"levels",bind:this,class:this.classes(p,n?_:null,w,E),onclick:this._levelSelected,onfocus:this._onItemFocus},r)):null}renderCloseLevelsButton(){if(!this.level||this.viewModel.isNormalMode||!this.viewModel.levelsExpanded)return null;const{messagesCommon:e}=this;return m("button",{key:"close-levels-button",title:e.close,bind:this,class:this.classes(f,p,w,L),"aria-label":e.close,onclick:this._closeLevels},m("div",{class:this.classes(N)},m("span",{class:this.classes(M,ee)})))}renderZoomButton(){var e,t,s,i,l;const{longNames:o,messages:n,facility:r,site:a}=this,c=null==(e=this.viewModel)?void 0:e.filterMenuType,d=null==(t=this.viewModel)?void 0:t.filterMenuOpen,h=null==(s=this.viewModel)?void 0:s.getSite(a),u=null==(i=this.viewModel)?void 0:i.getFacility(r),v="site"===c&&d?!h:!u;return m("button",{key:"zoom-button",title:n.buttons.zoomTo,bind:this,class:this.classes(f,p,v&&g,w,(null==(l=this.viewModel)?void 0:l.getFacilityLevels(r).length)>0?C:x),"aria-label":n.buttons.zoomTo,onclick:this._zoomToClicked},m("div",{class:this.classes(N)},m("span",{class:this.classes(M,Q)}),m("span",{class:this.classes(T)},o&&this.viewModel.isNormalMode&&n.buttons.zoomTo)))}renderCollapseToggleButton(){const{longNames:e,messagesCommon:t}=this,s=e?X:Y,i=this.classes(M,s),l=e?t.collapse:t.expand;return m("button",{key:"minimize-toggle-button",title:l,bind:this,class:this.classes(f,p,w,S),"aria-label":l,onclick:this._toggleCollapsed},m("div",{class:this.classes(N)},m("span",{class:i}),m("span",{class:this.classes(T)},e&&this.viewModel.isNormalMode&&t.collapse)))}renderFilterMenu(){var e,t,s;return null!=(e=this.viewModel)&&e.filterMenuOpen?"site"===(null==(t=this.viewModel)?void 0:t.filterMenuType)?this.renderSiteFilterMenu():"facility"===(null==(s=this.viewModel)?void 0:s.filterMenuType)?this.renderFacilityFilterMenu():null:null}renderSiteFilterMenu(){var e,t;const{messages:s,messagesCommon:i}=this,l=this.site?null==(e=this.viewModel)||null==(t=e.getSite(this.site))?void 0:t.name:s.selector.selectSite,o=m("div",{key:"filter-menu-site-header",class:this.classes(`${A}`)},m("div",{class:this.classes(U)},m(d,{level:this.headingLevel,class:this.classes($)},l)),m("button",{bind:this,title:i.close,class:this.classes(M,ee),onclick:this._closeClicked})),n=this.renderSearchInput(),r=this.renderSiteItems();return m("div",{key:"filter-menu-site",class:this.classes(z)},o,n,r)}renderFacilityFilterMenu(){var e,t,s,i;const{messages:l,messagesCommon:o,site:n}=this,r=null==(e=this.viewModel)||null==(t=e.getSite(n))?void 0:t.name,a=this.facility&&(null==(s=this.viewModel)||null==(i=s.getFacility(this.facility))?void 0:i.name)||l.selector.selectFacility,c=this.viewModel.hasMultipleSites?m("button",{bind:this,title:o.back,class:this.classes(W),onclick:this._backClicked},m("span",{class:this.classes(u()?se:ie)})):null,h=this.viewModel.hasMultipleSites?m(d,{level:this.headingLevel+1,class:this.classes(P)},r):null,v=m("div",{key:"filter-menu-site-header",class:this.classes(A)},c,m("div",{class:this.classes(U)},m(d,{level:this.headingLevel,class:this.classes($)},a),h),m("button",{bind:this,title:o.close,class:this.classes(M,ee),onclick:this._closeClicked})),f=this.renderSearchInput(),p=this.renderFacilityItems();return m("div",{key:"filter-menu-facility",class:this.classes(z)},v,f,p)}renderSearchInput(){const{messagesCommon:e}=this;return m("div",{key:"filter-menu-search",class:this.classes(H)},m("span",{class:this.classes(M,te)}),m("input",{bind:this,key:"filter-menu-search__input",afterCreate:h,"data-node-ref":"_searchInput",class:this.classes(D),placeholder:e.search,oninput:this._onSearchChange,onpaste:this._onSearchChange,value:this.viewModel.searchTerm}))}renderBlueCircle(){return m("span",{key:"floor-filter__selected-item-circle",class:this.classes(J)})}renderSiteItems(){var e,t,s,i;if(null==(e=this.viewModel)||null==(t=e.filterFeatures)||null==(s=t.sites)||!s.sitesInfo)return null;const{messages:l}=this,o=this.viewModel.filterFeatures.sites.sitesInfo,n=this.viewModel.filterSites(o).map((e=>this.renderSiteItem(e))),r=0===n.length&&(null==(i=this.viewModel)?void 0:i.searchTerm)&&m("div",{class:this.classes(b)},l.noResults);return m("ul",{key:"filter-menu-items--sites",class:this.classes(K),bind:this,afterCreate:h,"data-node-ref":"_sitesListNode","data-id":"sites",onkeydown:this._handleListKeydown,tabIndex:-1,"aria-label":l.selector.sitesLabel},n,r)}renderSiteItem(e){const{name:t,id:s}=e,i=`filter-menu-site--${s}`,l=this.site===s;return m("li",{key:i},m("button",{"data-id":s,"data-list-id":"sites",bind:this,class:this.classes(q),onclick:this._siteSelected,onfocus:this._onItemFocus},l&&this.renderBlueCircle(),m("span",{class:this.classes(l?Z:R)},t),m("span",{class:this.classes(u()?ie:se)})))}renderFacilityItems(){var e,s,i,l;if(null==(e=this.viewModel)||null==(s=e.filterFeatures)||null==(i=s.facilities)||!i.facilitiesInfo)return null;const{messages:o,site:n}=this,r=this.viewModel.getSite(n),a=this.viewModel.filterFeatures.facilities.facilitiesInfo,c=this.viewModel.filterFacilities(a).map((e=>this.renderFacilityItem(e))),d=0===c.length&&(null==(l=this.viewModel)?void 0:l.searchTerm)&&m("div",{class:this.classes(b)},o.noResults),u=r?t(o.selector.siteFacilitiesLabel,{name:`"${r.name}"`}):o.selector.facilitiesLabel;return m("ul",{key:"filter-menu-items--facilities",class:this.classes(K),bind:this,afterCreate:h,"data-node-ref":"_facilitiesListNode","data-id":"facilities",onkeydown:this._handleListKeydown,tabIndex:-1,"aria-label":u},c,d)}renderFacilityItem(e){const{name:t,id:s}=e,i=`filter-menu-facility--${s}`,l=this.facility===s;return m("li",{key:i},m("button",{"data-id":s,"data-list-id":"facilities",bind:this,class:this.classes(G),onclick:this._facilitySelected,onfocus:this._onItemFocus},l&&this.renderBlueCircle(),m("span",{class:this.classes(l?Z:R)},t)))}_afterBaseNodeCreate(e){var t,s;this._baseNode&&(null==(s=this._resizeObserver)||s.unobserve(this._baseNode));this._baseNode=e,null==(t=this._resizeObserver)||t.observe(this._baseNode)}_toggleCollapsed(){this.longNames=!this.longNames}_toggleFilterMenu(){var e,t;const s=null!=(e=null==(t=this.viewModel)?void 0:t.filterMenuOpen)&&e;this.viewModel.filterMenuOpen=!s}_setFilterMenuType(e){this.viewModel.filterMenuType=e}_zoomToClicked(){var e,t;if(this.site&&"site"===(null==(e=this.viewModel)?void 0:e.filterMenuType)&&null!=(t=this.viewModel)&&t.filterMenuOpen){var s;const e=null==(s=this.viewModel)?void 0:s.getSite(this.site);this.viewModel.goTo(e)}else if(this.facility){var i;const e=null==(i=this.viewModel)?void 0:i.getFacility(this.facility);this.viewModel.goTo(e)}else if(this.site){var l;const e=null==(l=this.viewModel)?void 0:l.getSite(this.site);this.viewModel.goTo(e)}}_onSearchChange(e){var t;const s=e.target;""===s.value?this.viewModel.searchTerm=null:s.value&&(null==(t=this.viewModel)?void 0:t.searchTerm)!==s.value&&(this.viewModel.searchTerm=s.value.toLowerCase().trim())}_closeClicked(){this.viewModel.searchTerm=null,this.viewModel.filterMenuOpen=!1}_backClicked(){this._setFilterMenuType("site"),this.viewModel.searchTerm=null}_siteSelected(e){const t=e.currentTarget.getAttribute("data-id"),s=this.viewModel.getSite(t);let i=!1;this.site!==t&&(this.facility=void 0,this.level=void 0,i=!0,this.viewModel.levelsExpanded=!1),this.site=t,this.viewModel.searchTerm=null,this._setFilterMenuType("facility"),this.viewModel.goTo(s),i&&this.viewModel.setFloors(null)}_facilitySelected(e){const t=e.currentTarget.getAttribute("data-id"),s=this.viewModel.getFacility(t);let i=!1;if(this.facility!==t){if("base-floors"===this.viewModel.filterMode){var l;const e=null==(l=this.viewModel)?void 0:l.getBaseLevel(s);this.level=e?e.id:void 0}else this.level=void 0;i=!0,this.viewModel.levelsExpanded=!1}if(this.facility=t,this.viewModel.goTo(s),i){const e=this.viewModel.getLevel(this.level);this.viewModel.setFloors(e)}if(!this.viewModel.isNormalMode){const e=this.viewModel.getFacilityLevels(t);(null==e?void 0:e.length)>1&&(this.viewModel.levelsExpanded=!0)}setTimeout((()=>{this._focusActiveLevel()}),50)}_levelSelected(e){const t=e.currentTarget.getAttribute("data-id");this.level=t}_closeLevels(){this.viewModel.levelsExpanded=!1}_isWebScene(e){return"esri.WebScene"===e.declaredClass}_getComponentPosition(){var e,t;return null==(e=this.view)||null==(t=e.ui)?void 0:t.getPosition(this.container)}_getPosition(e){switch(e){case"bottom-right":case"bottom-left":return"bottom";default:return"top"}}_handleListKeydown(e){const t=e.currentTarget.getAttribute("data-id");let i=null;"sites"===t||"facilities"===t?(this._activeMenu!==t&&(this._activeMenuIndex.menuItems=-1),this._activeMenu=t,i="menuItems"):"levels"===t&&(i="levels");const l="sites"===t?this._sitesListNode:"facilities"===t?this._facilitiesListNode:"levels"===t?this._levelsListNode:null,o=s(e),n="Tab"===o,r=le.includes(o);r&&e.preventDefault();const a=null==l?void 0:l.getElementsByTagName("li");a&&0!==a.length&&(r||n)&&this.handleItemNavigation(o,e.shiftKey,a,n,i)}handleItemNavigation(e,t,s,i,l){if(!l)return;this._activeMenuIndex[l]===s.length&&this._activeMenuIndex[l]--,-1===this._activeMenuIndex[l]&&this._activeMenuIndex[l]++;const o=this._activeMenuIndex[l];switch(e){case"Home":this._activeMenuIndex[l]=0;break;case"End":this._activeMenuIndex[l]=s.length-1;break;case"ArrowUp":this._activeMenuIndex[l]=this._activeMenuIndex[l]<=0?s.length-1:this._activeMenuIndex[l]-1;break;case"ArrowDown":this._activeMenuIndex[l]=this._activeMenuIndex[l]===s.length-1?0:this._activeMenuIndex[l]+1}if("Tab"===e&&t&&this._activeMenuIndex[l]>=0&&this._activeMenuIndex[l]--,"Tab"===e&&!t&&this._activeMenuIndex[l]<s.length&&this._activeMenuIndex[l]++,o!==this._activeMenuIndex[l]&&this._activeMenuIndex[l]>-1&&this._activeMenuIndex[l]<s.length&&!i){const e=s[this._activeMenuIndex[l]].getElementsByTagName("button"),t=1===(null==e?void 0:e.length)&&e[0];null==t||t.focus()}}_focusSearch(){var e;null==(e=this._searchInput)||e.focus()}_focusActiveLevel(){var e;const{level:t}=this,s=this._levelsListNode,i=null==s?void 0:s.getElementsByTagName("li");if(!t||!s||!i)return;const l=null==(e=this._facilitiesListNode)?void 0:e.getElementsByTagName("li");this._activeMenuIndex.menuItems=l?l.length-1:-1;const o=[];for(let e=0;e<i.length;e++){const t=i[e].getElementsByTagName("button");1===(null==t?void 0:t.length)&&o.push(t[0])}o.forEach(((e,s)=>{e.getAttribute("data-id")===t&&(e.focus(),this._activeMenuIndex.levels=s)}))}_onItemFocus(e){const t=e.currentTarget,s=t.getAttribute("data-list-id"),i=t.getAttribute("data-id"),l="sites"===s?this._sitesListNode:"facilities"===s?this._facilitiesListNode:"levels"===s?this._levelsListNode:null;if(!l)return;const o=null==l?void 0:l.getElementsByTagName("li");if(!o)return;const n=[];Array.from(o).forEach((e=>{const t=e.getElementsByTagName("button");1===(null==t?void 0:t.length)&&n.push(t[0])}));let r=null;switch(s){case"sites":case"facilities":r="menuItems";break;case"levels":r="levels"}r&&n.forEach(((e,t)=>{e.getAttribute("data-id")===i&&this._activeMenuIndex[r]!==t&&(this._activeMenuIndex[r]=t)}))}};e([o()],oe.prototype,"_searchInput",void 0),e([l("viewModel.enabled")],oe.prototype,"enabled",void 0),e([l("viewModel.longNames")],oe.prototype,"longNames",void 0),e([l("viewModel.minimized")],oe.prototype,"minimized",void 0),e([l("viewModel.pinnedLevels")],oe.prototype,"pinnedLevels",void 0),e([l("viewModel.site")],oe.prototype,"site",void 0),e([l("viewModel.facility")],oe.prototype,"facility",void 0),e([l("viewModel.level")],oe.prototype,"level",void 0),e([l("viewModel.view")],oe.prototype,"view",void 0),e([o({type:c})],oe.prototype,"viewModel",void 0),e([o(),v("esri/widgets/FloorFilter/t9n/FloorFilter")],oe.prototype,"messages",void 0),e([o(),v("esri/t9n/common")],oe.prototype,"messagesCommon",void 0),e([l("viewModel.goToOverride")],oe.prototype,"goToOverride",void 0),e([o()],oe.prototype,"headingLevel",void 0),e([l("viewModel.updateWebDocument")],oe.prototype,"updateWebDocument",null),oe=e([n("esri.widgets.FloorFilter")],oe);var ne=oe;export default ne;
