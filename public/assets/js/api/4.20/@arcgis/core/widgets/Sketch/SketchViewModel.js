/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../geometry.js";import t from"../../Graphic.js";import{symbolTypes as i}from"../../symbols.js";import o from"../../core/Collection.js";import{b as r,i as s,u as n,j as a,o as p,c}from"../../core/lang.js";import l from"../../core/Error.js";import{E as h}from"../../chunks/Evented.js";import d from"../../core/Handles.js";import{L as u}from"../../chunks/Logger.js";import{eachAlwaysValues as m,throwIfAborted as y,isAborted as g,createAbortError as v,createAbortController as f,whenOrAbort as _}from"../../core/promiseUtils.js";import{c as w,a as G}from"../../chunks/screenUtils.js";import{init as j,watch as b,on as S,when as k,whenNotOnce as C,whenOnce as x}from"../../core/watchUtils.js";import{property as T}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{subclass as E}from"../../core/accessorSupport/decorators/subclass.js";import{g as I}from"../../chunks/projectionEllipsoid.js";import{c as P}from"../../geometry/Polygon.js";import O from"../../layers/GraphicsLayer.js";import{i as A}from"../../chunks/interactiveToolUtils.js";import{c as M,h as L}from"../../chunks/elevationInfoUtils.js";import H from"../../geometry/Circle.js";import R from"../../views/draw/Draw.js";import D,{p as U,d as V,o as F,i as q,e as W,f as z,g as Z,h as B,j as K,L as N,R as Q,s as Y,b as X,k as J,l as $,P as ee,I as te}from"../../views/draw/DrawAction.js";import{V as ie}from"../../chunks/InputManager.js";import{S as oe}from"../../chunks/keybindings.js";import{HandleOwner as re}from"../../core/HandleOwner.js";import se,{r as ne}from"../../core/Accessor.js";import{a as ae,j as pe,c as ce,b as le,g as he,q as de,p as ue,k as me,d as ye}from"../../chunks/vec2.js";import ge from"../../geometry/SpatialReference.js";import{s as ve}from"../../chunks/MapUtils.js";import{b as fe,M as _e}from"../../chunks/mathUtils.js";import{a as we,f as Ge}from"../../chunks/vec2f64.js";import{d as je}from"../../chunks/Settings.js";import be from"../../views/interactive/snapping/SnappingOptions.js";import{b as Se}from"../../chunks/screenUtils2.js";import{n as ke}from"../../chunks/compilerUtils.js";import Ce from"../../symbols/SimpleMarkerSymbol.js";import xe from"../../symbols/SimpleFillSymbol.js";import Te from"../../symbols/CIMSymbol.js";import Ee from"../../symbols/SimpleLineSymbol.js";import Ie from"../../geometry/Point.js";import"../../geometry/Extent.js";import"../../chunks/string.js";import"../../chunks/object.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/write.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../chunks/arrayUtils.js";import"../../chunks/reader.js";import"../../chunks/deprecate.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../config.js";import"../../chunks/Message.js";import"../../chunks/writer.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polyline.js";import"../../chunks/extentUtils.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../layers/support/fieldUtils.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../chunks/enumeration.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/arcadeOnDemand.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../chunks/locale.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../chunks/chartMediaInfoUtils.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../support/actions/ActionBase.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/uid.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../intl.js";import"../../request.js";import"../../kernel.js";import"../../chunks/assets.js";import"../../chunks/Loadable.js";import"../../chunks/Promise.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../chunks/Thumbnail.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../layers/Layer.js";import"../../chunks/BlendLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../chunks/GraphicsCollection.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/domUtils.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../Popup.js";import"../../chunks/throttle.js";import"../Feature.js";import"../Widget.js";import"../../chunks/uuid.js";import"../../chunks/jsxWidgetSupport.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../chunks/messageBundle.js";import"../../chunks/jsxFactory.js";import"../Feature/FeatureViewModel.js";import"../../rest/support/Query.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../rest/support/StatisticDefinition.js";import"../../rest/support/RelationshipQuery.js";import"../../tasks/QueryTask.js";import"../../chunks/executeForTopCount.js";import"../../chunks/utils5.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../chunks/featureConversionUtils.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../tasks/Task.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../chunks/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/symbolConversion.js";import"../../chunks/commonProperties.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/support/elements.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/FeatureIndex.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/shared.js";import"../../chunks/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/OperationalLayer.js";import"../../chunks/commonProperties2.js";import"../../chunks/PortalLayer.js";import"../../chunks/asyncUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../chunks/labelingInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/Heading.js";import"../support/widget.js";import"../../chunks/accessibleHandler.js";import"../../chunks/vmEvent.js";import"../Spinner/SpinnerViewModel.js";import"../../chunks/AnchorElementViewModel.js";import"../Popup/PopupViewModel.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils2.js";import"../../chunks/ItemCache.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils3.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../../chunks/GoTo.js";import"../../chunks/Queue.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/geodesicConstants.js";import"../../views/draw/MultipointDrawAction.js";import"../../chunks/dehydratedFeatures.js";import"../../chunks/byteSizeEstimations.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/quantizationUtils.js";import"../../chunks/AppendVertex.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/plane.js";import"../../chunks/sphere.js";import"../../chunks/mat4.js";import"../../chunks/ray.js";import"../../chunks/vectorStacks.js";import"../../chunks/quatf64.js";import"../../chunks/mat4f64.js";import"../../views/draw/PointDrawAction.js";import"../../chunks/DrawTool.js";import"../../chunks/dehydratedFeatureComparison.js";import"../../chunks/InteractiveToolBase.js";import"../../geometry/projection.js";import"../../chunks/pe.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/Scheduler.js";import"../../chunks/PromiseQueue.js";import"../../chunks/vec4f32.js";import"../../chunks/frustum.js";import"../../chunks/lineSegment.js";import"../../chunks/LaserlineVisualElement.js";import"../../chunks/VisualElement.js";import"../../chunks/glUtil.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/BufferView.js";import"../../chunks/types.js";import"../../chunks/VertexColor.glsl.js";import"../../chunks/Program.js";import"../../chunks/Texture.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/mat4f32.js";import"../../chunks/Util.js";import"../../chunks/utils4.js";import"../../chunks/geometryDataUtils.js";import"../../chunks/triangle.js";import"../../chunks/CameraSpace.glsl.js";import"../../chunks/ColorMaterial.js";import"../../chunks/vec3f32.js";import"../../chunks/Object3DVisualElement.js";import"../../chunks/Object3D.js";import"../../chunks/mathUtils2.js";import"../../chunks/RibbonLineMaterial.js";import"../../chunks/ElevationProvider.js";import"../../chunks/PiUtils.glsl.js";import"../../chunks/sdfPrimitives.js";import"../../chunks/mat3.js";import"../../chunks/Texture2.js";import"../../chunks/requestImageUtils.js";import"../../chunks/FramebufferObject.js";import"../../chunks/VerticalOffset.glsl.js";import"../../chunks/RightAngleQuadVisualElement.js";import"../../views/draw/PolygonDrawAction.js";import"../../views/draw/PolylineDrawAction.js";import"../../views/draw/SegmentDrawAction.js";import"../../chunks/mat2d.js";import"../../chunks/mat2df64.js";import"../../chunks/quat.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";function Pe(e){switch(e){case 0:break;case 1:return"not owned by a graphics layer";case 2:return"no geometry";case 3:return"the geometry type is not supported";case 4:return"the elevation mode is not supported";case 5:return"the symbol type is not supported"}return""}function Oe(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return 1;if(r(e.geometry))return 2;switch(e.geometry.type){case"polygon":case"point":case"polyline":case"mesh":break;case"multipoint":case"extent":default:return 3}return"on-the-ground"!==M(e)&&L(e)?4:0}function Ae(e){return Le(e).result}function Me(e){return Le(e).geometry}function Le(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return{result:1,geometry:null};if(r(e.geometry))return{result:2,geometry:null};return"on-the-ground"!==M(e)&&L(e)?{result:4,geometry:null}:"point"!==e.geometry.type&&"polyline"!==e.geometry.type&&("polygon"!==e.geometry.type||e.geometry instanceof H)?{result:3,geometry:null}:{result:0,geometry:e.geometry}}let He=null;async function Re(){return He||(He=await import("../../chunks/createUtils.js")),He}function De(e,t,i){if(!t||!e||!e.map)return;const{map:o}=e,r=o.layers.find((e=>e===t));r||o.add(t,i),null!=i&&o.layers.reorder(r,i)}class Ue{constructor(e){this.coordinateHelper=e}}class Ve extends Ue{constructor(e,t){super(e),this.point=t}objectEqual(e){return e instanceof Ve&&F(this.point,e.point)}check(e){return le(e,this.point)<je.pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}intersect(e){const t=[];return e instanceof Fe?t.push(...q({start:e.start,end:e.end,type:e instanceof We?1:0},this.point)):e instanceof Ze&&t.push(...K(e.center,e.radius,this.point)),t.map((t=>new ze(this.coordinateHelper,t,this,e)))}}class Fe extends Ue{constructor(e,t,i){super(e),this.start=t,this.end=i}objectEqual(e){return e instanceof Fe&&(F(this.start,e.start)&&F(this.end,e.end))}intersect(e){const t=[];return e instanceof Ve?t.push(...q({start:this.start,end:this.end,type:this instanceof We?1:0},e.point)):e instanceof Fe?t.push(...W({start:this.start,end:this.end,type:this instanceof We?1:0},{start:e.start,end:e.end,type:e instanceof We?1:0})):e instanceof Ze&&t.push(...z({start:this.start,end:this.end,type:this instanceof We?1:0},e.center,e.radius)),t.map((t=>new ze(this.coordinateHelper,t,this,e)))}}class qe extends Fe{constructor(e,t,i){super(e,t,i),this.dir=we(),this.p=we()}objectEqual(e){return e instanceof qe&&super.objectEqual(e)}check(e){return ae(this.dir,this.end,this.start),ae(this.p,e,this.start),pe(this.dir,this.p)>=0&&U(e,this.start,this.end)<je.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return V(t,e,this.start,this.end),t}}class We extends Fe{constructor(e,t,i){super(e,t,i)}objectEqual(e){return e instanceof We&&super.objectEqual(e)}check(e){return U(e,this.start,this.end)<je.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper.clone(e);return Z(t,e,this.start,this.end),t}}class ze extends Ue{constructor(e,t,i,o){super(e),this.intersection=t,this.first=i,this.second=o}objectEqual(e){return e instanceof ze&&(this.first.objectEqual(e.first)&&this.second.objectEqual(e.second))}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return ce(t,this.intersection),t}intersect(){return[]}}class Ze extends Ue{constructor(e,t,i){super(e),this.center=t,this.radius=i}objectEqual(e){return e instanceof Ze&&(this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius)}check(){return!1}closestTo(e){const t=this.coordinateHelper.clone(e);return B(t,e,this.center,this.radius),t}intersect(e){const t=[];return e instanceof Fe?t.push(...z({start:e.start,end:e.end,type:e instanceof We?1:0},this.center,this.radius)):e instanceof Ve&&t.push(...K(this.center,this.radius,e.point)),t.map((t=>new ze(this.coordinateHelper,t,this,e)))}}class Be{constructor(e,t,i){this.coordinateHelper=e,this.targetPoint=t,this.constraint=i}}class Ke extends Be{constructor({coordinateHelper:e,targetPoint:t,objectId:i,constraint:o}){super(e,t,o),this.objectId=i}}class Ne extends Ke{constructor(e){super({...e,constraint:new We(e.coordinateHelper,e.edgeStart,e.edgeEnd)})}get hints(){return[new N(1,this.constraint.start,this.constraint.end)]}}class Qe extends Be{constructor({coordinateHelper:e,targetPoint:t,constraint:i,previousVertex:o,otherVertex:r,otherVertexType:s,objectId:n}){super(e,t,i),this.previousVertex=o,this.otherVertex=r,this.otherVertexType=s,this.objectId=n}get hints(){const e=this.previousVertex,t=1===this.otherVertexType?this.otherVertex:this.targetPoint,i=1===this.otherVertexType?this.targetPoint:this.otherVertex;return[new N(0,t,i),new N(1,e,t),new Q(this.previousVertex,t,i)]}}let Ye=class extends re{constructor(e){super(e),this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return ve(this.snappingSources,(({snappingSource:e})=>e.updating))||this.updatingHandles.updating}get snappingSources(){var e;const t=this._get("snappingSources")||new Map,i=new Map;if(null!=(e=this.options)&&e.featureSources)for(const e of this.options.featureSources.items){const o=e.layer.uid,r=t.get(o);if(r){t.delete(o),i.set(o,r);continue}if(!e.layer.loaded){this.updatingHandles.addPromise(e.layer.load());continue}const n=this.createSourceInfo(e);s(n)&&i.set(o,n)}for(const[,e]of t)e.destroy();return i}initialize(){var e;(this.updatingHandles.add(this,"snappingSources",(()=>{this.notifyChange("updating")}),1),s(this.view))&&this.handles.add([null==(e=this.view.refreshManager)?void 0:e.on("refresh",(e=>{"interval"===e.trigger&&this.refreshSourceOfLayer(e.layerView.layer)})),this.view.on("layerview-create",(e=>this.updateLayerView(e.layer,e.layerView))),this.view.on("layerview-destroy",(e=>this.updateLayerView(e.layer,null)))])}refreshSourceOfLayer(e){for(const[,{snappingSource:t}]of this.snappingSources)t.layerSource.layer===e&&t.refresh()}updateLayerView(e,t){for(const[,i]of this.snappingSources)i.snappingSource.layerSource.layer===e&&(i.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,i){if(!this.options.effectiveFeatureEnabled)return[];const o=[],r=this.computeScreeenSizeDistanceParameters(e,t),n={distance:r,point:e,coordinateHelper:t.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:e,layerView:r}]of this.snappingSources)!e.layerSource.enabled||s(r)&&r.suspended||o.push(e.fetchCandidates(n,i).then((i=>i.filter((i=>!this.candidateIsExcluded(e,i,t.excludeFeature))))));const a=(await m(o)).flat();return this.addRightAngleCandidates(a,e,r,t),y(i),Y(e,a),a}addRightAngleCandidates(e,t,i,o){var r,a,p,c,l,h,d,u;const m=s(o.vertexHandle)?null==(r=o.vertexHandle.right)||null==(a=r.right)?void 0:a.pos:s(o.geometry)&&"polygon"===o.geometry.type?null==(p=n(null==(c=o.geometry.editGeometry.components[0])?void 0:c.getFirstVertex()))?void 0:p.pos:null,y=s(o.vertexHandle)?null==(l=o.vertexHandle.left)||null==(h=l.left)?void 0:h.pos:s(o.geometry)?null==(d=n(null==(u=o.geometry.editGeometry.components[0])?void 0:u.getLastVertex()))?void 0:d.pos:null,g=e.length;for(let r=0;r<g;r++)this.addRightAngleCandidate(e[r],y,t,i,o,e),this.addRightAngleCandidate(e[r],m,t,i,o,e)}addRightAngleCandidate(e,t,i,o,s,n){if(r(t)||!(e instanceof Ne))return;const a=e.constraint.closestTo(t),p=(a[0]-i[0])/o.x,c=(a[1]-i[1])/o.y;if(p*p+c*c<=1){const i=s.coordinateHelper;n.push(new Qe({coordinateHelper:i,targetPoint:a,otherVertex:t,otherVertexType:0,previousVertex:e.constraint.start,constraint:new qe(i,t,a),objectId:e.objectId}))}}computeScreeenSizeDistanceParameters(e,t){const i=this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1);return r(this.view)?{x:i,y:i}:"2d"===this.view.type?{x:i*this.view.resolution,y:i*this.view.resolution}:this.computeScreeenSizeDistanceParameters3D(e,i,this.view,t)}computeScreeenSizeDistanceParameters3D(e,t,i,o){const{coordinateHelper:r,elevationInfo:s}=o,n=i.state.camera.computeScreenPixelSizeAt(X(e,r,s,i,Je))*i.renderCoordsHelper.unitInMeters/i.mapCoordsHelper.unitInMeters,a=t*n;return{x:a/this.computeScreenMagnitudeOfMapOffset(e,n,0,i,o),y:a/this.computeScreenMagnitudeOfMapOffset(e,0,n,i,o)}}computeScreenMagnitudeOfMapOffset(e,t,i,o,{coordinateHelper:r,elevationInfo:s}){const n=r.clone(e);n[0]+=t,n[1]+=i;const a=J(e,r,s,o),p=J(n,r,s,o),c=p.x-a.x,l=p.y-a.y;return Math.sqrt(c*c+l*l)}get types(){return 3}candidateIsExcluded(e,t,i){if(r(i))return!1;const o=this.getCandidateObjectId(t);if(r(o))return!1;const s=e.layerSource.layer;return"graphics"===s.type?i.uid===o:i.sourceLayer===s&&(!(!i.attributes||!("objectIdField"in s))&&i.attributes[s.objectIdField]===o)}getCandidateObjectId(e){return e instanceof Ke?e.objectId:null}createSourceInfo(e){const t=this.createFeatureSnappingSourceType(e);if(r(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const i=s(this.view)?this.view.allLayerViews.find((t=>t.layer===e.layer)):null;return new Xe(t.source,i)}createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"wfs":return this.createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this.createFeatureSnappingSourceGraphicsLayer(e)}return null}createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source.type){case"feature-layer":{const t=this.getSourceModule("featureService");return s(t.module)?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}case"memory":case"csv":case"geojson":case"wfs":{if("mesh"===e.layer.geometryType)return null;const t=this.getSourceModule("featureCollection");return s(t.module)?{source:new t.module.FeatureCollectionSnappingSource({layerSource:e})}:{loading:t.loader}}}return null}createFeatureSnappingSourceGraphicsLayer(e){const t=this.getSourceModule("graphics");return s(t.module)?{source:new t.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}getSourceModule(e){const t=this.sourceModules[e];if(r(t.loader)){const i=this.loadSourceModule(e).then((e=>{t.module=e}));return t.loader=i,{module:t.module,loader:i}}return{module:t.module,loader:t.loader}}loadSourceModule(e){switch(e){case"featureService":return this.updatingHandles.addPromise(import("../../chunks/FeatureServiceSnappingSource.js"));case"featureCollection":return this.updatingHandles.addPromise(import("../../chunks/FeatureCollectionSnappingSource.js"));case"graphics":return this.updatingHandles.addPromise(import("../../chunks/GraphicsSnappingSource.js"))}return null}};e([T({constructOnly:!0})],Ye.prototype,"spatialReference",void 0),e([T({constructOnly:!0})],Ye.prototype,"view",void 0),e([T()],Ye.prototype,"options",void 0),e([T({readOnly:!0})],Ye.prototype,"updating",null),e([T({readOnly:!0})],Ye.prototype,"snappingSources",null),Ye=e([E("esri.views.interactive.snapping.FeatureSnappingEngine")],Ye);class Xe{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new d;const i=this.snappingSource.layerSource.layer;if("refresh"in i){const t=i;this.handles.add(t.on("refresh",(()=>e.refresh())))}this.handles.add([j(e,"updating",(t=>e.layerSource.updating=t),!0),j(e,"availability",(t=>e.layerSource.availability=t),!0)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const Je=fe();class $e{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=je.shortLineThreshold*je.shortLineThreshold}snap(e,t){return s(t.vertexHandle)?"vertex"!==t.vertexHandle.type?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(e.left.pos,e.right.pos,t)}exceedsShortLineThreshold(e,t,{elevationInfo:i,geometry:o}){const r=o.editGeometry.coordinateHelper;return 0===this.squaredShortLineThreshold||$(J(t,r,i,this.view),J(e,r,i,this.view))>this.squaredShortLineThreshold}squaredProximityTreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}}class et extends Be{constructor({coordinateHelper:e,lineStart:t,lineEnd:i,targetPoint:o}){super(e,o,new We(e,t,i)),this.referenceLineHint=new N(2,t,i)}get hints(){return[this.referenceLineHint,new N(0,this.lineEndClosestToTarget(),this.targetPoint)]}lineEndClosestToTarget(){const e=this.constraint.start,t=this.constraint.end;return _e(pe(ae(it,t,e),ae(tt,this.targetPoint,e)))>0?t:e}}const tt=we(),it=we();class ot extends $e{snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],o=i.edges.length,r=[];if(o<1)return r;const s=t.coordinateHelper,n=J(e,s,t.elevationInfo,this.view),a=i.edges[o-1];let p=a;do{this.edgeExceedsShortLineThreshold(p,t)&&this._processCandidateProposal(p.left.pos,p.right.pos,e,n,t,r),p=p.left.left}while(p&&p!==a);return r}snapExistingVertex(e,t){const i=[],o=n(t.vertexHandle),r=o.component;if(r.edges.length<2)return i;const s=t.coordinateHelper,a=J(e,s,t.elevationInfo,this.view),p=o.left,c=o.right;p&&c&&this.edgeExceedsShortLineThreshold(p,t)&&this.edgeExceedsShortLineThreshold(c,t)&&this._processCandidateProposal(p.left.pos,c.right.pos,e,a,t,i);const l=r.edges[0];let h=l;do{h!==o.left&&h!==o.right&&this.edgeExceedsShortLineThreshold(h,t)&&this._processCandidateProposal(h.left.pos,h.right.pos,e,a,t,i),h=h.right.right}while(h&&h!==l);return i}_processCandidateProposal(e,t,i,o,r,s){const n=Z(we(),i,e,t),a=r.coordinateHelper,p=a.fromXYZ(n,a.getZ(i,0));$(o,J(p,a,r.elevationInfo,this.view))<this.squaredProximityTreshold(r.pointer)&&s.push(new et({coordinateHelper:r.coordinateHelper,lineStart:e,lineEnd:t,targetPoint:p}))}}class rt extends Be{constructor({coordinateHelper:e,referenceLine:t,lineStart:i,targetPoint:o}){const r=e.clone(i);ae(r,he(r,r,t.right.pos),t.left.pos),super(e,o,new We(e,i,r)),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new N(0,this.constraint.start,this.targetPoint),new ee(this.constraint.start,this.targetPoint),...this._referenceLines.map((e=>new N(1,e.edge.left.pos,e.edge.right.pos,e.fadeLeft,e.fadeRight)))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach((i=>{e.right.right===i.edge&&(i.fadeLeft=!1,t.fadeRight=!1),e.left.left===i.edge&&(i.fadeRight=!1,t.fadeLeft=!1)})),this._referenceLines.push(t)}}class st extends $e{constructor(){super(...arguments),this._tmpProjection=we()}snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],o=i.edges.length,r=i.vertices.length,s=[];if(o<2)return s;const n=J(e,t.coordinateHelper,t.elevationInfo,this.view),a=i.vertices[r-1],p=i.vertices[0],c=i.edges[o-1];let l=c;do{this.edgeExceedsShortLineThreshold(l,t)&&(this._checkEdgeForParalleLines(l,a.pos,e,n,t,s),this._checkEdgeForParalleLines(l,p.pos,e,n,t,s)),l=l.left.left}while(l&&l!==c);return s}snapExistingVertex(e,t){const i=[],o=n(t.vertexHandle),r=o.component;if(r.edges.length<3)return i;const s=J(e,t.coordinateHelper,t.elevationInfo,this.view),a=o.left,p=o.right,c=r.vertices[0],l=r.vertices.length,h=r.vertices[l-1],d=r.edges[0];let u=d;do{u!==a&&u!==p&&this.edgeExceedsShortLineThreshold(u,t)&&(a&&this._checkEdgeForParalleLines(u,a.left.pos,e,s,t,i),p&&this._checkEdgeForParalleLines(u,p.right.pos,e,s,t,i),o===c?this._checkEdgeForParalleLines(u,h.pos,e,s,t,i):o===h&&this._checkEdgeForParalleLines(u,c.pos,e,s,t,i)),u=u.right.right}while(u&&u!==d);return i}_checkEdgeForParalleLines(e,t,i,o,r,s){const n=e.left.pos,a=e.right.pos;if(Z(this._tmpProjection,t,n,a),le(this._tmpProjection,t)<je.parallelLineThreshold)return;Z(this._tmpProjection,i,n,a,t);const p=r.coordinateHelper,c=p.fromXYZ(this._tmpProjection,p.getZ(i,0));if($(o,J(c,p,r.elevationInfo,this.view))<this.squaredProximityTreshold(r.pointer)){if(this.parallelToPreviousCandidate(e,s))return;s.push(new rt({coordinateHelper:p,referenceLine:e,lineStart:t,targetPoint:c}))}}parallelToPreviousCandidate(e,t){const i=e.left.pos,o=e.right.pos;for(const r of t)if(Z(this._tmpProjection,o,r.constraint.start,r.constraint.end,i),le(this._tmpProjection,o)<je.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}class nt extends $e{constructor(){super(...arguments),this._tmp=we()}snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],o=i.vertices.length,r=[];if(o<2)return r;const s=J(e,t.coordinateHelper,t.elevationInfo,this.view),n=i.vertices[o-1];this._checkForSnappingCandidate(r,n.left,n.pos,e,n.left.left.pos,n.pos,t,e,s);const a=i.vertices[0];return this._checkForSnappingCandidate(r,a.right,a.pos,e,a.right.right.pos,a.pos,t,e,s),r}snapExistingVertex(e,t){const i=[],o=n(t.vertexHandle),r=o.component,s=r.vertices.length;if(s<3)return i;const a=J(e,t.coordinateHelper,t.elevationInfo,this.view),p=o.left,c=o.right,l=r.vertices[0],h=r.vertices[s-1];if(!p)return this._checkForSnappingCandidate(i,l.right.right.right,l.right.right.pos,e,l.right.right.right.right.pos,l.right.right.pos,t,e,a),i;if(!c)return this._checkForSnappingCandidate(i,h.left.left.left,h.left.left.pos,e,h.left.left.left.left.pos,h.left.left.pos,t,e,a),i;if(p&&p.left.left){const o=p.left.left;this._checkForSnappingCandidate(i,o,p.left.pos,e,o.left.pos,p.left.pos,t,e,a)}if(c&&c.right.right){const o=c.right.right;this._checkForSnappingCandidate(i,o,c.right.pos,e,o.right.pos,c.right.pos,t,e,a)}return i}_checkForSnappingCandidate(e,t,i,o,r,s,n,a,p){if(!this.edgeExceedsShortLineThreshold(t,n))return;ae(this._tmp,t.right.pos,t.left.pos);const c=Ge(this._tmp[1],-this._tmp[0]),l=pe(c,ae(this._tmp,o,i))/de(c),h=n.coordinateHelper,d=h.fromXYZ(ue(we(),s,c,l),h.getZ(a,0));$(p,J(d,h,n.elevationInfo,this.view))<this.squaredProximityTreshold(n.pointer)&&e.push(new Qe({coordinateHelper:h,targetPoint:d,constraint:new qe(h,s,ue(h.createNew(),s,c,_e(l))),previousVertex:r,otherVertex:s,otherVertexType:1}))}}class at extends Be{constructor({coordinateHelper:e,targetPoint:t,point1:i,point2:o}){super(e,t,new Ze(e,me(pt,i,o,.5),.5*ye(i,o))),this.p1=i,this.p2=o}get hints(){return[new N(1,this.targetPoint,this.p1),new N(1,this.targetPoint,this.p2),new Q(this.p1,this.targetPoint,this.p2)]}}const pt=we();class ct extends $e{snapNewVertex(e,t){const i=t.geometry.editGeometry.components[0],o=[],r=i.vertices.length;if("polygon"!==t.geometry.type||r<2)return o;const s=i.vertices[0],n=i.vertices[r-1];return this._processCandidateProposal(s.pos,n.pos,e,t,o),o}snapExistingVertex(e,t){const i=[],o=n(t.vertexHandle),r=o.component;return r.edges.length<2?i:"polyline"!==t.geometry.type||0!==o.index&&o.index!==r.vertices.length-1?(this._processCandidateProposal(o.left.left.pos,o.right.right.pos,e,t,i),i):i}_processCandidateProposal(e,t,i,o,r){if(!this.exceedsShortLineThreshold(e,t,o))return;const s=me(we(),e,t,.5),n=.5*ye(e,t),a=B(we(),i,s,n),p=o.coordinateHelper,c=p.fromXYZ(a,p.getZ(i,0)),l=J(i,p,o.elevationInfo,this.view);$(l,J(c,p,o.elevationInfo,this.view))<this.squaredProximityTreshold(o.pointer)&&r.push(new at({coordinateHelper:p,targetPoint:c,point1:e,point2:t}))}}let lt=class extends se{constructor(e){super(e),this.updating=!1,this._snappers=new o}initialize(){this._snappers.push(new st(this.view,this.options),new ot(this.view,this.options),new nt(this.view,this.options),new ct(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t){if(!this.options.effectiveSelfEnabled)return[];const i=[];for(const o of this._snappers.items)i.push(...o.snap(e,t));return Y(e,i),i}};e([T({readOnly:!0})],lt.prototype,"updating",void 0),e([T({constructOnly:!0})],lt.prototype,"view",void 0),e([T()],lt.prototype,"options",null),lt=e([E("esri.views.interactive.snapping.SelfSnappingEngine")],lt);class ht extends Be{constructor(e,t,i,o){super(e,t,new ze(e,t,i.constraint,o.constraint)),this.first=i,this.second=o}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new te(this.targetPoint)]}}let dt=class extends(h.EventedMixin(re)){constructor(e){super(e),this.options=new be,this.engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}initialize(){this.handles.add([ne((()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:o}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:o}}),(()=>{this.doneSnapping(),this.emit("changed")})),this.watch("options",(e=>{for(const t of this.engines)t.options=e}),!0),j(this.view,"ready",(e=>this.onViewReady(e)),!0)])}destroy(){this.destroyEngines()}get updating(){return this.engines.some((e=>e.updating))}onViewReady(e){var t,i;(this.destroyEngines(),e)&&(this.engines=[new lt({view:this.view,options:this.options}),new Ye({view:this.view,spatialReference:null!=(t=null==(i=this.view)?void 0:i.spatialReference)?t:ge.WGS84,options:this.options})])}destroyEngines(){for(const e of this.engines)e.destroy();this.engines.length=0}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}async snap(e,t,i){const o=t.coordinateHelper.fromPoint(e),r=await this.fetchCandidates(o,t,i);return{get valid(){return!g(i)},apply:()=>{const{snappedPoint:e,hints:i}=this.processCandidates(o,r,t);return this.removeVisualization(),s(t.visualizer)&&this.handles.add(t.visualizer.draw(i,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),ut),e}}}update(e,t){this.removeVisualization();let i=e;const o=[];if(s(this._currentMainCandidate)){const r=t.coordinateHelper,s=r.fromPoint(e),n=this._currentMainCandidate.constraint.closestTo(s);if($(J(s,r,t.elevationInfo,this.view),J(n,r,t.elevationInfo,this.view))<this.squaredPointProximityThreshold(t.pointer)){i=r.createDehydratedPoint(n),this._currentMainCandidate.targetPoint=n,o.push(...this._currentMainCandidate.hints);for(const e of this._currentOtherActiveCandidates)e.targetPoint=n,o.push(...e.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return s(t.visualizer)&&this.handles.add(t.visualizer.draw(o,{coordinateHelper:t.coordinateHelper,elevationInfo:t.elevationInfo,view:this.view}),ut),i}doneSnapping(){this.removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}removeVisualization(){this.handles.remove(ut)}async fetchCandidates(e,t,i){return(await Promise.all(this.engines.map((o=>o.fetchCandidates(e,t,i))))).flat()}processCandidates(e,t,i){if(t.length<1)return this.doneSnapping(),{snappedPoint:i.coordinateHelper.createDehydratedPoint(e),hints:[]};Y(e,t);const o=this._currentMainCandidate;if(s(o)){const r=this.findOldConstraintInNewCandidates(o,t);if(r>=0){if(!(t[r]instanceof ht))return this.intersectWithOtherCandidates(r,t,e,i);if(le(e,o.targetPoint)<this.squaredPointProximityThreshold(i.pointer))return this.updateSnappingCandidate(o,t,i)}}return this.intersectWithOtherCandidates(0,t,e,i)}findOldConstraintInNewCandidates(e,t){return e instanceof ht?this.findOldCandidateIndex(t,e.first)>=0&&this.findOldCandidateIndex(t,e.second)>=0?0:-1:this.findOldCandidateIndex(t,e)}intersectWithOtherCandidates(e,t,i,o){const r=t[e],s=[],n=o.coordinateHelper;for(let a=0;a<t.length;++a){if(a===e)continue;const p=t[a];for(const e of r.constraint.intersect(p.constraint)){const t=n.fromXYZ(e.intersection,r.targetPoint[2]);s.push([new ht(n,t,r,p),$(J(i,o.coordinateHelper,o.elevationInfo,this.view),J(t,o.coordinateHelper,o.elevationInfo,this.view))])}}return s.length>0&&(s.sort(((e,t)=>e[1]-t[1])),s[0][1]<this.squaredPointProximityThreshold(o.pointer))?this.updateSnappingCandidate(s[0][0],t,o):this.updateSnappingCandidate(r,t,o)}updateSnappingCandidate(e,t,i){this.doneSnapping(),this._currentMainCandidate=e;const o=this._currentMainCandidate.targetPoint,r=[];r.push(...e.hints);for(const i of t){if(e instanceof ht){if(i.constraint.objectEqual(e.first.constraint)||i.constraint.objectEqual(e.second.constraint))continue}else if(i.constraint.objectEqual(e.constraint))continue;i.constraint.check(o)&&(i.targetPoint=o,this._currentOtherActiveCandidates.push(i),r.push(...i.hints))}return{snappedPoint:i.coordinateHelper.createDehydratedPoint(o),hints:r}}squaredPointProximityThreshold(e){return"touch"===e?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}findOldCandidateIndex(e,t){let i=-1;for(let o=0;o<e.length;++o)if(t.constraint.objectEqual(e[o].constraint)){i=o;break}return i}get test(){return{visualizationsActive:this.handles.has(ut),engines:this.engines}}};e([T({constructOnly:!0})],dt.prototype,"view",void 0),e([T()],dt.prototype,"options",void 0),e([T({readOnly:!0})],dt.prototype,"updating",null),e([T()],dt.prototype,"engines",void 0),e([T()],dt.prototype,"squaredMouseProximityTreshold",null),e([T()],dt.prototype,"squaredTouchProximityThreshold",null),dt=e([E("esri.views.interactive.snapping.SnappingManager")],dt);const ut="visualization-handle";let mt=class extends h.EventedAccessor{constructor(e){super(e),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw":case"draw-3d":return null;default:ke(this.activeComponent)}return null}addToHistory(e){this.history.redo=[],this.history.undo.push(e)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this.reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}reset(){this.activeComponent.reset()}refreshComponent(){const e=this.activeComponent;e&&("box"!==e.type&&"reshape"!==e.type&&"graphic-mover"!==e.type||e.refresh())}set undo(e){this._set("undo",(()=>{this.canUndo()&&e()}))}set redo(e){this._set("redo",(()=>{this.canRedo()&&e()}))}};e([T()],mt.prototype,"activeComponent",void 0),e([T()],mt.prototype,"cancelled",void 0),e([T()],mt.prototype,"history",void 0),e([T()],mt.prototype,"tool",null),e([T()],mt.prototype,"type",void 0),e([T()],mt.prototype,"canUndo",null),e([T()],mt.prototype,"canRedo",null),e([T()],mt.prototype,"onEnd",void 0),e([T()],mt.prototype,"undo",null),e([T()],mt.prototype,"redo",null),e([T()],mt.prototype,"toggleTool",void 0),e([T()],mt.prototype,"addToSelection",void 0),e([T()],mt.prototype,"removeFromSelection",void 0),mt=e([E("esri.widgets.Sketch.support.OperationHandle")],mt);const yt=u.getLogger("esri.widgets.Sketch.SketchViewModel"),gt={defaultZ:0},vt={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};let ft=class extends h.EventedAccessor{constructor(e){super(e),this._activeFillGraphic=null,this._activeLineGraphic=null,this._centerIndicatorGraphic=null,this._centerSymbol=new Ce({style:"cross",size:6,color:[255,255,255]}),this._defaultSegmentOffset=48,this._numUpdating=0,this._handles=new d,this._internalGraphicsLayer=new O({listMode:"hide",internal:!0,title:"SVM Internal"}),this._lineGraphic=null,this._operationHandle=null,this._vertexGraphics=[],this._viewHandles=new d,this._doUnnormalization=!1,this.activeFillSymbol=new xe({style:"solid",color:[150,150,150,.2],outline:{color:[50,50,50],width:0}}),this.activeLineSymbol=new Te({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[3.75,3.75],lineDashEnding:"HalfPattern",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:1.6,color:[255,255,255,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:2,color:[0,0,0,255]}]}}}),this.activeVertexSymbol=new Ce({style:"circle",size:6,color:[255,127,0,1],outline:{color:[50,50,50],width:1}}),this.allowDeleteKey=!0,this.layer=null,this.pointSymbol=new Ce({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new xe({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new Ee({color:[130,130,130,1],width:2}),this._snappingManager=null,this.updateGraphics=new o,this.updateOnGraphicClick=!0,this.updatePointSymbol=new Ce({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new xe({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new Ee({color:[12,207,255],width:2}),this.vertexSymbol=new Ce({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=gt,this.defaultUpdateOptions=vt,this.snappingOptions=new be}initialize(){this._handles.add([b(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=s(this.layer)?this.layer.elevationInfo:null})),S(this,"view.map.layers","change",(e=>{e.removed.includes(this.layer)&&this.cancel()})),S(this,"layer.graphics","change",(e=>{if(s(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),j(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=s(this.layer)?this.layer.elevationInfo:null}),!0),j(this,"view",(e=>{a(this._snappingManager),e&&(this._snappingManager=new dt({view:e,options:this.snappingOptions}),"3d"===e.type&&(import("../../chunks/editingTools.js"),import("../../chunks/GraphicsLayerView3D.js")))}),!0)])}destroy(){this.cancel(),this._handles=a(this._handles),this._viewHandles=a(this._viewHandles),this._removeDefaultLayer(),a(this._draw),a(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get _draw(){return"ready"===this.state||"active"===this.state?new R({view:this.view}):null}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return this.view&&"3d"===this.view.type&&s(this.activeComponent)&&"draw-3d"===this.activeComponent.type?n(this.activeComponent.createGraphic):this._get("createGraphic")}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...gt,...e})}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...vt,...e,reshapeOptions:{...vt.reshapeOptions,...null==e?void 0:e.reshapeOptions}})}set snappingOptions(e){s(this._snappingManager)&&(this._snappingManager.options=e),this._set("snappingOptions",e)}get state(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),i=this._operationHandle;return t&&i?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:e,map:i}=t;e&&(t.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;const i="view-ready";this._handles.remove(i),e&&this._handles.add(k(e,"ready",(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),!0),i),this._set("view",e)}cancel(){this._moduleLoaderAbortController=p(this._moduleLoaderAbortController),this._viewReadyAbortController=p(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:i}=this,o=t.toArray();i.removeMany(o),this.cancel(),this._emitDeleteEvent({graphics:o,tool:e})}}async create(e,t){if(await this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),v();if(this.cancel(),this.view.activeTool=null,!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");const i=await this._setupCreateOperation(e,t);if(r(i)||this.destroyed)return;let o=null;"2d"===this.view.type&&(o=this.view.map.layers.findIndex((e=>e.id===D.SNAPPING_GRAPHICS_LAYER_ID)),o=o>-1?o:null),De(this.view,this._internalGraphicsLayer,o);i.on("complete",(()=>{if(i===this._operationHandle){const t=this.createGraphic,o=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),i.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:o?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}})),this._operationHandle=i,this.view.ready&&A(this.view)&&this.view.focus()}async update(e,t){await this._waitViewReady();const{layer:i,view:o,state:s}=this;if("disabled"===s)throw o||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),i||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),v();this.cancel(),this.view.activeTool=null;const n=Array.isArray(e)?e:[e];if(null==e||!n||!n.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(n.some((e=>e.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):r(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===o.type&&!o.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied IMapView."),!0))))return;const a=await this._setupUpdateOperation(n,t);this.destroyed||r(a)||bt(a)||(De(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(a,t),this.emit("update",{graphics:n,state:"start",aborted:!1,tool:a.tool,toolEventInfo:null,type:"update"}))}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const t=[];switch(this.view.type){case"2d":{const r=await this.view.hitTest(e);if(r.results.length>0){const e=r.results[0];if(e.graphic){var i,o;const r=e.graphic;"vector-tile"!==(null==(i=r.layer)?void 0:i.type)&&"imagery"!==(null==(o=r.layer)?void 0:o.type)&&t.push(e)}}}break;case"3d":{const i=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&i.push(e)}));const o=await this.view.hitTest(e,{exclude:i});if(o.results.length>0){const e=o.results[0];(!o.ground.mapPoint||this.view.map.ground.opacity<1||o.ground.distance-e.distance>-Math.min(3*o.ground.distance,"global"===this.view.viewingMode?I(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}_generateViewHandles(e){return[e.on("immediate-click",(async t=>{const i="active"===this.state&&"create"===this._operationHandle.type;if("disabled"===this.state||i||!this.updateOnGraphicClick)return;this._beginAsyncOperation();const o=(await t.async((()=>this._getFirstHit(Se(t))))).results;let r=null;if(o.length){for(const i of o)if(i.graphic){const o=i.graphic;if(this.updateGraphics.includes(o)||o.layer===this.layer){t.stopPropagation(),r=o;break}"2d"!==e.type||this._isComponentGraphic(o)||"active"!==this.state||this.cancel()}}else"active"===this.state&&this.cancel();s(r)&&!this.updateGraphics.includes(r)&&await this.update([r],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}}),this._endAsyncOperation()}),ie.WIDGET)]}async _setupCreateOperation(e,t){if(!e)return null;const i={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...t};let o;if("2d"===this.view.type)switch(e){case"point":o=this._setupCreatePointOperation(e,i);break;case"multipoint":o=await this._setupCreateMultipointOperation(e,i);break;case"polygon":case"polyline":o=await this._setupCreatePolyOperation(e,i);break;case"rectangle":o=await this._setupCreateRectangleOperation(e,i);break;case"circle":o=await this._setupCreateCircleOperation(e,i)}else{const t=await this._setupCreate3DOperation(e,this.view,i);if(r(t)||bt(t))return null;o=t}return o}async _setupCreate3DOperation(e,t,i){if("multipoint"===e)return null;this._removeCreateOperationGraphics();const o="rectangle"!==e,a="rectangle"!==e;this.snappingOptions.enabledToggled=!1;const p=await this._requireModule(import("../../chunks/editingTools.js"));if(bt(p))return p;if(this.destroyed)return null;const c=new p.module.DrawGraphicTool({view:t,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...i,elevationInfo:this.layer.elevationInfo,geometryType:e,createGraphicSymbol:this._getGraphicSymbolFromTool(e),snapToScene:!s(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode,snappingManager:this._snappingManager,forceUniformSize:a,centered:o});this.view.tools.add(c);let l=null;this.view.activeTool=c;const h=[this.view.on("key-down",(t=>{if(t.key===oe.pan)t.stopPropagation(),t.repeat||(c.enabled=!1);else if(t.key===oe.complete)t.stopPropagation(),c.completeCreateOperation();else if(t.key!==oe.vertexAdd||t.repeat)t.key===oe.undo?(t.stopPropagation(),d.undo()):t.key===oe.redo?(t.stopPropagation(),d.redo()):t.key!==oe.snappingToggle||"rectangle"===e||"circle"===e||t.repeat?t.key!==oe.constraint||"rectangle"!==e&&"circle"!==e||t.repeat?t.key===oe.center&&(t.repeat||(c.centered=!o,t.stopPropagation())):(c.forceUniformSize=!a,t.stopPropagation()):(this.snappingOptions.enabledToggled=!0,t.stopPropagation());else{const e=c.drawOperation.geometryType;"polyline"!==e&&"polygon"!==e||(t.stopPropagation(),c.drawOperation.commitStagedVertex())}}),ie.WIDGET),this.view.on("key-up",(t=>{t.key===oe.pan?c.enabled=!0:t.key===oe.snappingToggle&&"rectangle"!==e&&"circle"!==e?(this.snappingOptions.enabledToggled=!1,t.stopPropagation()):t.key!==oe.constraint||"rectangle"!==e&&"circle"!==e?t.key===oe.center&&(c.centered=o,t.stopPropagation()):(c.forceUniformSize=a,t.stopPropagation())}),ie.WIDGET),c.on("vertex-add",(t=>{switch(l=r(l)?"start":"active",t.operation){case"apply":this.emit("create",{graphic:n(c.createGraphic),state:l,tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[n(c.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[n(c.createGraphic)],tool:e})}})),c.on("cursor-update",(e=>{c.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:n(c.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),c.on("vertex-remove",(t=>{switch(t.operation){case"apply":this.emit("create",{graphic:n(c.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[n(c.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[n(c.createGraphic)],tool:e})}})),c.on("complete",(e=>{this._removeCreateOperationGraphics(),this._set("createGraphic",n(e.graphic)),l="complete",e.aborted?d&&d.cancel():d&&d.complete()}))],d=new mt({activeComponent:c,tool:e,type:"update",onEnd:()=>{var e;h.forEach((e=>e.remove())),h.length=0,null==(e=this.view.tools)||e.remove(c),c.destroy()},undo:()=>{c.canUndo&&c.undo()},redo:()=>{c.canRedo&&c.redo()},canUndo:()=>c.canUndo,canRedo:()=>c.canRedo});return d}_getGraphicSymbolFromTool(e){switch(e){case"point":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;default:return null}}_setupCreatePointOperation(e,i){const o={elevationInfo:this.layer.elevationInfo,hasZ:i.hasZ,defaultZ:i.defaultZ,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},r=this._draw.create(e,o),n=[r.on("cursor-update",(e=>{s(e.vertexIndex)?this._displayCrosshairCursor():this._displayDefaultCursor()})),r.on("draw-complete",(e=>{const i=this.createPointFromVertex(e.vertices[0]),o=new t(i,this.pointSymbol);this._set("createGraphic",o),p&&p.complete()}))],a=[this.view.on("key-down",(e=>{e.key===oe.cancel&&(p&&p.cancel(),e.stopPropagation())}),ie.WIDGET)],p=this._operationHandleForCreateAction(r,[...n,...a],e);return p}async _setupCreateMultipointOperation(e,t){const i=await Re(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},r=this._draw.create(e,o);let s=null;const n=[],a=this._operationHandleForCreateAction(r,n,e);return n.push(r.on("vertex-add",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,a=n[r];s=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-remove",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,a=n[r];s=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-update",(t=>{const{type:o,vertexIndex:r,vertices:n}=t,a=n[r];s=t,this._drawMultipointGraphic(i,n,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}]},type:"create"})})),r.on("cursor-update",(e=>{s=e})),r.on("draw-complete",(e=>{const t=e.vertices.slice(0),o=i.createMultipoint(t,this.view.spatialReference);o&&this.createGraphic&&(this.createGraphic.geometry=o),a&&a.complete()})),r.on("undo",(e=>{const t=e.vertices,o=s&&"cursor-update"!==s.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,o)})),r.on("redo",(e=>{const t=e.vertices,o=s&&"cursor-update"!==s.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(i,t,o)}))),n.push(this.view.on("pointer-move",(()=>this._displayCrosshairCursor()),ie.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(a,e)),ie.WIDGET)),a}async _setupCreatePolyOperation(e,t){const i=await Re(),o={...t,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0};let r=null;("polyline"===e||"polygon"===e)&&(r=this._draw.create(e,o));let n=null;const a=[r.on("vertex-add",(t=>{const{type:o,vertexIndex:r,vertices:s}=t,a=s[r];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-remove",(t=>{const{type:o,vertexIndex:r,vertices:s}=t,a=s[r];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}],type:o},type:"create"})})),r.on("vertex-update",(t=>{const{type:o,vertexIndex:r,vertices:s}=t,a=s[r];this._snapLastPolygonVertexToFirst(e,s),n=t,this._drawVertexGraphics(i,e,s,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:r}]},type:"create"})})),r.on("cursor-update",(t=>{const{type:o,vertices:r}=t;if(t.mapPoint&&(this._snapLastPolygonVertexToFirst(e,r),n=t,this._drawVertexGraphics(i,e,r,{userClicked:!1}),r.length>1)){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:o},type:"create"})}})),r.on("draw-complete",(t=>{const o=t.vertices.slice(0);let r=null;"polyline"===e?r=i.createPolyline([o],this.view.spatialReference,this._doUnnormalization):"polygon"===e&&(r=i.createPolygon([o],this.view.spatialReference,this._doUnnormalization,!0)),r&&(this.createGraphic.geometry=r),c&&c.complete()})),r.on("undo",(t=>{const o=t.vertices,r=n&&"cursor-update"!==n.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,o),o.length&&this._drawVertexGraphics(i,e,o,{userClicked:r})})),r.on("redo",(t=>{const o=t.vertices,r=n&&"cursor-update"!==n.type;this._resetCreateOperationGraphics(),this._snapLastPolygonVertexToFirst(e,o),o.length&&this._drawVertexGraphics(i,e,o,{userClicked:r})}))],p=[this.view.on("pointer-move",(e=>{s(r.getCoordsFromScreenPoint(w(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),ie.WIDGET),this.view.on("key-down",(e=>{e.key!==oe.snappingToggle||e.repeat?e.key===oe.undo&&c&&c.canUndo()?(e.stopPropagation(),c.undo()):e.key===oe.redo&&c&&c.canRedo()?(e.stopPropagation(),c.redo()):e.key===oe.cancel&&c&&c.cancel():(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),ie.WIDGET),this.view.on("key-up",(e=>{e.key===oe.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),ie.WIDGET)];if("polygon"===e){const e=(e,t,i)=>{if(!e||!e.layer||!e.visible)return!1;const o=this.view.toScreen(e.geometry);return this._isWithinScreenDistance(o,t,i)},t=t=>{if(!(this._vertexGraphics.length<=2))return e(this._vertexGraphics[0],t,this._getVertexIntersectDistance())};let i=!1;p.push(this.view.on("pointer-move",(()=>{i=!1}),ie.WIDGET),this.view.on("pointer-down",(o=>{if(t(o))return i=!0,void o.stopPropagation();this._vertexGraphics.some((t=>e(t,o,this._getVertexIntersectDistance())))&&o.stopPropagation()}),ie.WIDGET),this.view.on("pointer-up",(e=>{i&&(e.stopPropagation(),r.complete())})))}const c=this._operationHandleForCreateAction(r,[...a,...p],e);return c}async _setupCreateCircleOperation(e,i){const o=await Re(),r={...i,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},n=this._draw.create(e,r);let a=!1,p=!0;const c=[n.on("vertex-add",(t=>{const{type:i,vertexIndex:r,vertices:s}=t,c=s[r];this._drawSegmentGraphic(o,e,s,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:r}],type:i},type:"create"})})),n.on("cursor-update",(t=>{const{type:i,vertices:r}=t;if(this._drawSegmentGraphic(o,e,r,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem),2===r.length){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),n.on("draw-complete",(e=>{const i=e.vertices.slice(0);let r;1===i.length?(i.push(n.viewAlignedCoordinateSystem.makeMapPoint(i[0][0]+this._defaultSegmentOffset*this.view.resolution,i[0][1])),r=o.createCircle(i,n.viewAlignedCoordinateSystem,!0,this.view.resolution)):r=a?o.createEllipse(i,n.viewAlignedCoordinateSystem,p):o.createCircle(i,n.viewAlignedCoordinateSystem,p,this.view.resolution),this.createGraphic?this.createGraphic.geometry=r:(this._removeCreateGraphic(),this._set("createGraphic",new t(r,this.polygonSymbol))),h&&h.complete()}))],l=[this.view.on("pointer-move",(e=>{s(n.getCoordsFromScreenPoint(w(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),ie.WIDGET),this.view.on("key-down",(t=>{t.key===oe.constraint?a||(a=!0,this._drawSegmentGraphic(o,e,n.vertices,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem)):t.key===oe.center?p&&(p=!1,this._drawSegmentGraphic(o,e,n.vertices,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem)):t.key===oe.cancel&&h&&h.cancel()}),ie.WIDGET),this.view.on("key-up",(t=>{t.key===oe.constraint?(a=!1,this._drawSegmentGraphic(o,e,n.vertices,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem)):t.key===oe.center&&(p=!0,this._drawSegmentGraphic(o,e,n.vertices,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem))}),ie.WIDGET)],h=this._operationHandleForCreateAction(n,[...c,...l],e);return h}async _setupCreateRectangleOperation(e,i){const o=await Re(),r={...i,elevationInfo:this.layer.elevationInfo,snappingManager:this._snappingManager,interactiveUndoDisabled:!0},n=this._draw.create(e,r);let a=!1,p=!1;const c=[n.on("vertex-add",(t=>{const{type:i,vertexIndex:r,vertices:s}=t,c=s[r];this._drawSegmentGraphic(o,e,s,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:c,vertices:[{coordinates:c,componentIndex:0,vertexIndex:r}],type:i},type:"create"})})),n.on("cursor-update",(t=>{const{type:i,vertices:r}=t;if(this._drawSegmentGraphic(o,e,r,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem),2===r.length){const t=r[r.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:i},type:"create"})}})),n.on("draw-complete",(e=>{const i=e.vertices.slice(0);let r=null;1===i.length&&(a=!1,p=!1),r=a?o.createSquare(i,n.viewAlignedCoordinateSystem,p):o.createRectangle(i,n.viewAlignedCoordinateSystem,p),this.createGraphic?this.createGraphic.geometry=r:(this._removeCreateGraphic(),this._set("createGraphic",new t(r,this.polygonSymbol))),h&&h.complete()}))],l=[this.view.on("pointer-move",(e=>{s(n.getCoordsFromScreenPoint(w(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),ie.WIDGET),this.view.on("key-down",(t=>{t.key===oe.constraint?a||(a=!0,this._drawSegmentGraphic(o,e,n.vertices,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem)):t.key===oe.center?p||(p=!0,this._drawSegmentGraphic(o,e,n.vertices,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem)):t.key===oe.cancel&&h&&h.cancel()}),ie.WIDGET),this.view.on("key-up",(t=>{t.key===oe.constraint?(a=!1,this._drawSegmentGraphic(o,e,n.vertices,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem)):t.key===oe.center&&(p=!1,this._drawSegmentGraphic(o,e,n.vertices,{centered:p,constrainToggle:a},n.viewAlignedCoordinateSystem))}),ie.WIDGET)],h=this._operationHandleForCreateAction(n,[...c,...l],e);return h}async _setupUpdateOperation(e,t){const{layer:i,view:o}=this,r={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...t,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...null==t?void 0:t.reshapeOptions}},s=r.tool;for(const t of e)i.remove(t),i.add(t);if("3d"===o.type){if(0===e.length)return null;switch(s){case"move":return this._setupMove3DOperation(e,r,o,s);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=Ae(e[0]);return 0===t?this._setupReshape3DOperation(e[0],r,o):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Pe(t)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,r,o)}}switch(s){case"move":return this._setupMoveOperation(e,r,o);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=Ae(e[0]);return 0===t?this._setupTransformOrReshapeOperation(e,s,r,o):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Pe(t)}).`),null)}case"transform":return this._setupTransformOrReshapeOperation(e,1===e.length&&"point"===c(e[0].geometry,"type")?"reshape":s,r,o)}}async _setupMove3DOperation(e,t,i,o,r=!1){for(const t of e){const e=Oe(t);if(0!==e)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${Pe(e)}).`),null}const s=await this._requireModule(import("../../chunks/editingTools.js"));if(bt(s))return s;const n=new s.module.GraphicMoveTool({view:i,enableZ:t.enableZ,snappingManager:this._snappingManager});this.view.tools.add(n),n.graphics.addMany(e),r||this.updateGraphics.addMany(e);const a=[],p=new mt({activeComponent:n,tool:o,type:"update",onEnd:()=>{var e;a.forEach((e=>e.remove())),a.length=0,null==(e=this.view.tools)||e.remove(n),n.destroyed||n.destroy()},undo:()=>{_t(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{wt(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:e=>{this.updateGraphics.push(e),n.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?n.graphics.remove(e):p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;if("transform"!==o)return;const e=this.updateGraphics.getItemAt(0);if(0!==Ae(e))return;const r=await this._setupReshape3DOperation(e,t,i,!0);bt(r)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(r,t))}});return a.push(...this._getHandlesForComponent(p,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),ie.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===oe.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),ie.WIDGET),i.on("key-up",(e=>{e.key===oe.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),ie.WIDGET)),p}_setupGraphicTransform3DOperation(e,t,i,o=!1){if(1===e.length&&0===function(e){var t;if("graphics"!==(null==(t=e.layer)?void 0:t.type))return 1;if(r(e.geometry))return 2;switch(e.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return 0;default:return 3}const i=s(e.symbol)&&"point-3d"===e.symbol.type&&e.symbol.symbolLayers;return i&&i.length>0&&i.some((e=>"object"===e.type))?"on-the-ground"!==M(e)&&L(e)?4:0:5}(e[0])){const r=e[0],n=r.geometry;if(s(n)&&("point"===n.type||"mesh"===n.type))return this._setupPointTransform3DOperation(r,t,i);if(s(n)&&("polygon"===n.type||"polyline"===n.type))return this._setupPolyTransform3DOperation(r,t,i,o)}return this._setupMove3DOperation(e,t,i,"transform",o)}async _setupPointTransform3DOperation(e,t,i){const o="transform",{enableRotation:r,enableScaling:s,enableZ:n}=t,a=await this._requireModule(import("../../chunks/editingTools.js"));if(bt(a))return a;const p=new a.module.GraphicTransformTool({graphic:e,view:i,enableRotation:r,enableScaling:s,enableZ:n,snappingManager:this._snappingManager});this.view.tools.add(p),this.updateGraphics.add(e);const c=[],l=new mt({activeComponent:p,tool:o,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(p),p.destroyed||p.destroy()},undo:()=>{_t(l,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{wt(l,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);bt(o)||(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(o,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),l.complete()},toggleTool:()=>{}});return c.push(...this._getHandlesForComponent(l,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(l,e,t)),ie.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(l,e),e.key===oe.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),ie.WIDGET),i.on("key-up",(e=>{e.key===oe.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),ie.WIDGET)),l}async _setupPolyTransform3DOperation(e,t,i,o=!1){const r="transform",{enableRotation:s,enableScaling:n,enableZ:a,preserveAspectRatio:p}=t,c=await this._requireModule(import("../../chunks/editingTools.js"));if(bt(c))return c;const l=new c.module.ExtentTransformTool({graphic:e,view:i,enableRotation:s,enableScaling:n,enableZ:a,preserveAspectRatio:p});this.view.tools.add(l),o||this.updateGraphics.add(e);const h=[],d=new mt({activeComponent:l,tool:r,type:"update",onEnd:()=>{var e;h.forEach((e=>e.remove())),h.length=0,null==(e=this.view.tools)||e.remove(l),l.destroyed||l.destroy()},canUndo:()=>l.canUndo,undo:()=>{l.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r})},canRedo:()=>l.canRedo,redo:()=>{l.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);bt(o)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(o,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),d.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;const e=this.updateGraphics.getItemAt(0);if(0!==Ae(e))return;const o=await this._setupReshape3DOperation(e,t,i,!0);bt(o)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(o,t))}});return h.push(...this._getHandlesForComponent(d,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(d,e,t)),ie.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(d,e)),ie.WIDGET),this.view.on("key-down",(e=>{e.key!==oe.constraint||e.repeat||(l.preserveAspectRatio=!l.preserveAspectRatio,e.stopPropagation())}),ie.WIDGET),this.view.on("key-up",(e=>{e.key===oe.constraint&&(l.preserveAspectRatio=!l.preserveAspectRatio,e.stopPropagation())}),ie.WIDGET)),d}async _setupMoveOperation(e,t,i){const o="move";this.updateGraphics.addMany(e);const r=await this._getGraphicMover(e,t,i);if(bt(r))return r;const s=new mt({activeComponent:r,tool:o,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),p.forEach((e=>e.remove())),a.forEach((e=>e.remove())),p=[],a=[],r.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const e=this.updateGraphics.toArray();_t(s,e),s.refreshComponent(),this._emitUndoEvent({graphics:e,tool:o})},redo:()=>{const e=this.updateGraphics.toArray();wt(s,e),s.refreshComponent(),this._emitRedoEvent({graphics:e,tool:o})},addToSelection:e=>{this.updateGraphics.push(e),r.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);s.history.undo.forEach((e=>e.updates.splice(t,1))),s.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const i=this.updateGraphics.toArray();this.emit("update",{graphics:i,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?r.graphics=i:s.complete()}});let n=!1,a=[i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(s,e,t)),ie.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(s,e),e.key!==oe.constraint||e.repeat||(n=!0,r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),ie.WIDGET),i.on("key-up",(e=>{e.key===oe.constraint&&n&&(n=!1,r.enableMoveAllGraphics=!r.enableMoveAllGraphics)}),ie.WIDGET)],p=this._getHandlesForComponent(s,t);return s}async _setupReshape3DOperation(e,t,i,o=!1){const r="reshape",s=await this._requireModule(import("../../chunks/editingTools.js"));if(bt(s))return s;this.snappingOptions.enabledToggled=!1;const n=new s.module.GraphicReshapeTool({view:i,graphic:e,enableZVertex:t.enableZ&&"move"===t.reshapeOptions.vertexOperation,enableZShape:t.enableZ&&"move"===t.reshapeOptions.shapeOperation,enableMoveGraphic:"move"===t.reshapeOptions.shapeOperation||"move-xy"===t.reshapeOptions.shapeOperation,enableMidpoints:"split"===t.reshapeOptions.edgeOperation,enableEdgeOffset:"offset"===t.reshapeOptions.edgeOperation,snappingManager:this._snappingManager});i.tools.add(n),o||this.updateGraphics.add(e);const a=[],p=new mt({activeComponent:n,tool:r,type:"update",onEnd:()=>{var e;a.forEach((e=>e.remove())),a.length=0,null==(e=this.view.tools)||e.remove(n),n.destroyed||n.destroy()},canUndo:()=>n.canUndo,undo:()=>{n.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r})},canRedo:()=>n.canRedo,redo:()=>{n.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r})},addToSelection:async e=>{this.updateGraphics.add(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"});const o=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);bt(o)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(o,t))},removeFromSelection:e=>{this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),p.complete()},toggleTool:async()=>{if(!1===t.toggleToolOnClick)return;const e=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),t,i,!0);bt(e)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(e,t))}});return a.push(...this._getHandlesForComponent(p,t),i.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e,t)),ie.WIDGET),i.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===oe.snappingToggle&&(this.snappingOptions.enabledToggled=!0,e.stopPropagation())}),ie.WIDGET),i.on("key-up",(e=>{e.key===oe.snappingToggle&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation())}),ie.WIDGET)),p}async _setupTransformOrReshapeOperation(e,t,i,o){const{multipleSelectionEnabled:r}=i;this.updateGraphics.addMany(e);const n="transform"===t?await this._getBox(e,i,o):await this._getReshape(e,i,o);if(bt(n))return n;const a=new mt({activeComponent:n,type:"update",onEnd:()=>{c.forEach((e=>e.remove())),p.forEach((e=>e.remove())),c=[],p=[],a.activeComponent&&!a.activeComponent.destroyed&&a.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{_t(a,this.updateGraphics.toArray()),a.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a.tool})},redo:()=>{wt(a,this.updateGraphics.toArray()),a.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a.tool})},addToSelection:async e=>{let t=a.activeComponent;if("reshape"===t.type){const t=[...this.updateGraphics,e];this.updateGraphics.removeAll();const r=await this._setupMoveOperation(t,i,o);if(bt(r))return;a.onEnd(),a.destroy(),this._setUpdateOperationHandle(r,i)}else this.updateGraphics.add(e),t=t,t.graphics=this.updateGraphics.toArray(),t.refresh(),a.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async e=>{const t=this.updateGraphics.indexOf(e);a.history.undo.forEach((e=>e.updates.splice(t,1))),a.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e);const i=this.updateGraphics.toArray();0===i.length?a.complete():1===i.length&&s(i[0].geometry)&&"point"===i[0].geometry.type?a.toggleTool():a.activeComponent.graphics=i,this.emit("update",{graphics:i,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const e=this.updateGraphics.getItemAt(0);if(s(e.geometry)&&("transform"===a.tool&&"extent"===e.geometry.type||"reshape"===a.tool&&"point"===e.geometry.type))return;let t=null;"transform"===a.tool?t=await this._getReshape([e],i,o):"reshape"===a.tool&&(t=await this._getBox([e],i,o)),bt(t)||(a.activeComponent.destroy(),a.activeComponent=t,a.activeComponent&&(c.forEach((e=>e.remove())),c=this._getHandlesForComponent(a,i)))}});let p=[o.on("immediate-click",(async e=>{var t;const i=await e.async((()=>this._getFirstHit(Se(e))));null!=(t=i.results)&&t.length?i.results.some((t=>{if(t.graphic){var i;const o=t.graphic;if(null!=(i=e.native)&&i.shiftKey&&r)return e.stopPropagation(),a.addToSelection(o),!0;if(o.layer===this.layer)return a.complete(),!0}return!1})):a.complete()}),ie.WIDGET),o.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(a,e),e.key!==oe.snappingToggle||e.repeat||(this.snappingOptions.enabledToggled=!0,e.stopPropagation()),e.key===oe.constraint&&!e.repeat&&a){const e=a.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),ie.WIDGET),o.on("key-up",(e=>{var t;if(e.key===oe.snappingToggle&&"reshape"===(null==a||null==(t=a.activeComponent)?void 0:t.type)&&(this.snappingOptions.enabledToggled=!1,e.stopPropagation()),e.key===oe.constraint&&a){const e=a.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),ie.WIDGET)],c=this._getHandlesForComponent(a,i);return a}async _getGraphicMover(e,t,i){const{enableMoveAllGraphics:o}=t,r=await this._requireModule(import("../../chunks/GraphicMover.js"));return bt(r)?r:new r.module.default({enableMoveAllGraphics:o,graphics:e,view:i,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:i})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:i})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,i){const{enableRotation:o,enableScaling:r,preserveAspectRatio:s}=t,n=await this._requireModule(import("../../chunks/Box.js"));return bt(n)?n:new n.module.default({graphics:e,enableRotation:o,enableScaling:r,preserveAspectRatio:s,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}async _getReshape(e,t,i){var o,r;const s="split"===(null==(o=t.reshapeOptions)?void 0:o.edgeOperation),n="move"===(null==(r=t.reshapeOptions)?void 0:r.shapeOperation),a=await this._requireModule(import("../../chunks/Reshape.js"));return bt(a)?a:new a.module.default({enableMidpoints:s,enableMovement:n,graphic:e[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:i,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMove:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onMoveStop:({dx:e,dy:t,mover:i,type:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:i,type:o},type:"update"}),onVertexAdd:({added:e,type:t,vertices:i})=>{const o=e.map((e=>P(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:o,vertices:i,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:i})=>{const o=e.map((e=>P(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:o,vertices:i,type:t},type:"update"})}}})}_getHandlesForComponent(e,t){const i=e.activeComponent;switch(i.type){case"graphic-mover":return[i.on("graphic-click",(({graphic:t,viewEvent:i})=>{var o;null!=(o=i.native)&&o.shiftKey&&(i.stopPropagation(),e.removeFromSelection(t))})),i.on("graphic-move-start",(t=>e.addToHistory(jt(t.allGraphics))))];case"box":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(jt(t.graphics)))),i.on("rotate-start",(t=>e.addToHistory(jt(t.graphics)))),i.on("scale-start",(t=>e.addToHistory(jt(t.graphics))))];case"reshape":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(e,t,i))),i.on("move-start",(t=>e.addToHistory(jt([t.mover])))),i.on("reshape-start",(t=>e.addToHistory(jt([t.graphic])))),i.on("vertex-add",(t=>e.addToHistory(jt([t.oldGraphic])))),i.on("vertex-remove",(t=>e.addToHistory(jt([t.oldGraphic]))))];case"move-3d":return[i.on("graphic-move-start",(t=>{e.addToHistory(jt(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),i.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),i.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[i.on("record-undo",(({record:t})=>{e.addToHistory({updates:[t]})})),i.on("graphic-translate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-start"},type:"update"})})),i.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),i.on("graphic-rotate-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-start"},type:"update"})})),i.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),i.on("graphic-scale-start",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-start"},type:"update"})})),i.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale-stop"},type:"update"})})),i.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),i.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),i.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.xScale,yScale:e.yScale,type:"scale"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"reshape-3d":return[i.on("reshape",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],e,t):e.toggleTool()}))];case"draw":case"draw-3d":return null;default:return}}_onTransformOrReshape2DGraphicClick(e,t,i){var o;const{graphic:r,viewEvent:s}=i;return null!=(o=s.native)&&o.shiftKey?(s.stopPropagation(),e.removeFromSelection(r)):t.toggleToolOnClick?(s.stopPropagation(),e.toggleTool()):void 0}_setUpdateOperationHandle(e,t){this._operationHandle=e;const i=this.view.map;this._disablePopup(t);e.on("complete",(()=>{if(e===this._operationHandle){const o=this.updateGraphics.toArray(),r=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:o,state:"complete",aborted:e.cancelled,tool:r,toolEventInfo:null,type:"update"})}}))}async _getCommonUpdateOperationClickHandlers(e,t,i){const o=Se(t),r=(await t.async((()=>this._getFirstHit(o)))).results;if(!r.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(r.map((e=>e.graphic)),e,i))return void t.stopPropagation();r.some((e=>e.graphic&&this.updateGraphics.includes(e.graphic)))?t.stopPropagation():e.complete()}_toggleSelection(e,t,i){const o=!!i.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!o||e.layer!==this.layer)&&(this.updateGraphics.includes(e)?t.removeFromSelection(e):t.addToSelection(e),!0))))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const i=t.key;i===oe.undo&&e.canUndo()?(t.stopPropagation(),e.undo()):i===oe.redo&&e.canRedo()?(t.stopPropagation(),e.redo()):i===oe.cancel?(t.stopPropagation(),e.cancel()):this.allowDeleteKey&&oe.delete.includes(i)&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const t=this.activeComponent,i=this.updateGraphics.toArray();r(t)||"reshape-3d"===t.type||("reshape"!==t.type||1===i.length&&"point"===c(i[0].geometry,"type"))&&(e.stopPropagation(),this.delete())}_drawMultipointGraphic(e,i,o){let r=null;if(!o&&i.length>1){const t=i.slice(0);t.pop(),r=e.createMultipoint(t,this.view.spatialReference)}else r=e.createMultipoint(i,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new t(r,this.pointSymbol)),o&&1===i.length&&this._internalGraphicsLayer.add(this.createGraphic)}_drawVertexGraphics(e,i,o,r){if(!o.length)return;const{_doUnnormalization:s,activeLineSymbol:n,activeVertexSymbol:a,polygonSymbol:p,polylineSymbol:c,vertexSymbol:l,view:{spatialReference:h}}=this,d=!(!r||!r.userClicked),u="polygon"===i,m=u?p:c;if(1===o.length){this._removeLineGraphic(),this._removeActiveLineGraphic();const i=this.createPointFromVertex(o[0]),r=u?e.createPolygon([o],h,s,!0):e.createPolyline([o],h,s);this._vertexGraphics.length?this._vertexGraphics[0].geometry=i:this._vertexGraphics.push(new t(i,a)),this.createGraphic?this.createGraphic.set({geometry:r,symbol:m}):this._set("createGraphic",new t(r,m)),d&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===o.length){const i=this.createPointFromVertex(o[1]),r=e.createPolyline([o],h,s),n=u?e.createPolygon([o],h,s,!0):e.createPolyline([o],h,s);if(!this._vertexGraphics.length){const e=this.createPointFromVertex(o[0]),i=new t(e,l);this._vertexGraphics.push(i)}if(1===this._vertexGraphics.length){const e=this._vertexGraphics[0],o=new t(i,l);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(o),this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}else this._vertexGraphics[1].geometry=i;this._showActiveLineGraphic(r);const a=this._vertexGraphics[0];d&&(this._activeLineGraphic.symbol=c,a.symbol=l,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.set({geometry:n,symbol:m}):this._set("createGraphic",new t(n,m)),this._internalGraphicsLayer.remove(a),this._internalGraphicsLayer.add(a)}else if(o.length>2){const r=u?e.createPolygon([o],h,s,!0):e.createPolyline([o],h,s);"polygon"===i&&this._showFillGraphic(r);const p=o.map((e=>e.slice())),y=p.pop(),g=[p[p.length-1],y],v=e.createPolyline([p],h,s),f=e.createPolyline([g],h,s);this._showLineGraphic(v),this._showActiveLineGraphic(f);for(let e=0;e<p.length;e++){const t=this._vertexGraphics[e];if(t)d||e!==this._vertexGraphics.length-1?t.symbol=l:t.symbol=a;else{const t=this.createPointFromVertex(o[e]);this._showVertexGraphic(t)}}if(d){this._activeLineGraphic.symbol=c;const e=o.length-1,t=this.createPointFromVertex(o[e]);this._showVertexGraphic(t)}else this._activeLineGraphic.symbol=n;this.createGraphic?this.createGraphic.set({geometry:r,symbol:m}):(this._removeCreateGraphic(),this._set("createGraphic",new t(r,m)));for(const e of this._vertexGraphics)this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}}_drawSegmentGraphic(e,i,o,r,n){if(!o.length)return;const a=!(null==r||!r.centered),p=!(null==r||!r.constrainToggle);let c;1===o.length?this._removeCenterIndicatorGraphic():("rectangle"===i?c=p?e.createSquare(o,n,a):e.createRectangle(o,n,a):"circle"===i&&(c=p?e.createEllipse(o,n,a):e.createCircle(o,n,a,this.view.resolution)),s(c)&&c.extent&&c.extent.center&&this._showCenterIndicatorGraphic(c.extent.center)),c?this.createGraphic?this.createGraphic.geometry=c:(this._removeCreateGraphic(),this._set("createGraphic",new t(c,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}_showCenterIndicatorGraphic(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new t(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))}_removeCenterIndicatorGraphic(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)}_showActiveLineGraphic(e){this._activeLineGraphic?(this._activeLineGraphic.set({geometry:e,symbol:this.activeLineSymbol}),this._internalGraphicsLayer.remove(this._activeLineGraphic)):this._activeLineGraphic=new t(e,this.activeLineSymbol),this._internalGraphicsLayer.add(this._activeLineGraphic)}_showFillGraphic(e){this._activeFillGraphic?(this._activeFillGraphic.set({geometry:e,symbol:this.activeFillSymbol}),this._internalGraphicsLayer.remove(this._activeFillGraphic)):this._activeFillGraphic=new t(e,this.activeFillSymbol),this._internalGraphicsLayer.add(this._activeFillGraphic)}_showLineGraphic(e){this._lineGraphic?(this._lineGraphic.set({geometry:e,symbol:this.polylineSymbol}),this._internalGraphicsLayer.remove(this._lineGraphic)):this._lineGraphic=new t(e,this.polylineSymbol),this._internalGraphicsLayer.add(this._lineGraphic)}_showVertexGraphic(e,i){const o=i?this.activeVertexSymbol:this.vertexSymbol,r=new t(e,o);this._vertexGraphics.push(r),this._internalGraphicsLayer.add(r)}_resetCreateOperationGraphics(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()}_removeCreateGraphic(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))}_removeCreateOperationGraphics(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()}_removeActiveLineGraphic(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)}_removeActiveFillGraphic(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)}_removeLineGraphic(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)}_removeVertexGraphics(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach((e=>e.destroy())),this._vertexGraphics=[])}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)}_operationHandleForCreateAction(e,t,i){return new mt({activeComponent:this._draw,tool:i,type:"create",onEnd:()=>{t.forEach((e=>e.remove())),t.length=0,this._removeCreateOperationGraphics(),this._internalGraphicsLayer&&this._internalGraphicsLayer.remove(this.createGraphic),this._displayDefaultCursor()},undo:()=>{e.undo(),this._emitUndoEvent({graphics:[this.createGraphic],tool:i})},redo:()=>{e.redo(),this._emitRedoEvent({graphics:[this.createGraphic],tool:i})},canUndo:()=>e&&e.canUndo(),canRedo:()=>e&&e.canRedo()})}_isComponentGraphic(e){const{activeComponent:t}=this;return!(!e||r(t))&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===t.type||"reshape"===t.type)&&t.isUIGraphic(e))}_snapLastPolygonVertexToFirst(e,t){if("polygon"!==e&&t.length<=2)return;const i=t[0],o=t[t.length-1],r=this.view.toScreen(new Ie(i[0],i[1],this.view.spatialReference)),s=this.view.toScreen(new Ie(o[0],o[1],this.view.spatialReference));this._isWithinScreenDistance(r,s,this._getVertexIntersectDistance())&&(o[0]=i[0],o[1]=i[1])}_getVertexIntersectDistance(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?G(this.vertexSymbol.size)/2+3:3}_isWithinScreenDistance(e,t,i){const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)<=i}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayCrosshairCursor(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(e,t,i){yt.error(new l(e,t,i))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const i=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:i}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}createPointFromVertex(e){return e.length>2?new Ie(e[0],e[1],e[2],this.view.spatialReference):new Ie(e[0],e[1],this.view.spatialReference)}test(){return{operationHandle:this._operationHandle,defaultUpdateOptions:vt}}wait(){return C(this,"updating")}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||s(e)&&e.toggleToolOnClick}_disablePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&r(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=t.autoOpenEnabled,t.autoOpenEnabled=!1)}_restorePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&s(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}async _waitViewReady(){this.view&&(p(this._viewReadyAbortController),this._viewReadyAbortController=f(),await _(x(this.view,"ready"),this._viewReadyAbortController.signal))}};function _t(e,t){Gt("undo",e.history.undo,e.history.redo,t)}function wt(e,t){Gt("redo",e.history.redo,e.history.undo,t)}function Gt(e,t,i,o){const r=t.pop().updates,n=[];o.forEach(((t,i)=>{const o=r[i];null!=o&&("geometry"in o&&s(o.geometry)&&(n.push({geometry:t.geometry}),t.geometry=o.geometry),"symbol"in o&&s(o.symbol)&&(n.push({symbol:t.symbol}),t.symbol=o.symbol),"undo"in o&&(n.push(o),o[e](t)))})),i.push({updates:n})}function jt(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function bt(e){return"requireError"in e&&"aborted"===e.requireError}e([T({readOnly:!0})],ft.prototype,"_draw",null),e([T()],ft.prototype,"updating",null),e([T()],ft.prototype,"_operationHandle",void 0),e([T({readOnly:!0})],ft.prototype,"activeTool",null),e([T()],ft.prototype,"activeFillSymbol",void 0),e([T()],ft.prototype,"activeLineSymbol",void 0),e([T()],ft.prototype,"activeVertexSymbol",void 0),e([T()],ft.prototype,"allowDeleteKey",void 0),e([T({readOnly:!0})],ft.prototype,"createGraphic",null),e([T()],ft.prototype,"defaultCreateOptions",null),e([T()],ft.prototype,"defaultUpdateOptions",null),e([T()],ft.prototype,"layer",void 0),e([T({types:i})],ft.prototype,"pointSymbol",void 0),e([T({types:i})],ft.prototype,"polygonSymbol",void 0),e([T({types:i})],ft.prototype,"polylineSymbol",void 0),e([T({type:be,nonNullable:!0})],ft.prototype,"snappingOptions",null),e([T()],ft.prototype,"_snappingManager",void 0),e([T({readOnly:!0})],ft.prototype,"state",null),e([T({readOnly:!0})],ft.prototype,"updateGraphics",void 0),e([T()],ft.prototype,"updateOnGraphicClick",void 0),e([T({types:i})],ft.prototype,"updatePointSymbol",void 0),e([T({types:i})],ft.prototype,"updatePolygonSymbol",void 0),e([T({types:i})],ft.prototype,"updatePolylineSymbol",void 0),e([T({types:i})],ft.prototype,"vertexSymbol",void 0),e([T({value:null})],ft.prototype,"view",null),e([T()],ft.prototype,"cancel",null),e([T()],ft.prototype,"complete",null),e([T()],ft.prototype,"delete",null),e([T()],ft.prototype,"create",null),e([T()],ft.prototype,"update",null),e([T()],ft.prototype,"undo",null),e([T()],ft.prototype,"redo",null),e([T()],ft.prototype,"canUndo",null),e([T()],ft.prototype,"canRedo",null),e([T()],ft.prototype,"toggleUpdateTool",null),ft=e([E("esri.widgets.Sketch.SketchViewModel")],ft);var St=ft;export default St;export{Ne as E,Ke as F,Ve as P,Ae as a,De as b,Me as g,Oe as i};
