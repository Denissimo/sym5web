/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Color.js";import i,{e as s,a as o}from"../../core/Accessor.js";import{o as r,i as a,j as n,d as l,b as c,m as u,f as d}from"../../core/lang.js";import h from"../../core/Handles.js";import{createTask as p,after as m,throwIfAborted as _}from"../../core/promiseUtils.js";import{c as w,b as v,f}from"../../chunks/screenUtils.js";import{c as y,d as g}from"../../chunks/timeUtils.js";import{property as T}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/Logger.js";import{subclass as P}from"../../core/accessorSupport/decorators/subclass.js";import{b}from"../../chunks/mathUtils.js";import{l as j}from"../../chunks/earthUtils.js";import{d as k}from"../../chunks/sunUtils.js";import O from"../../core/Collection.js";import{r as S}from"../../chunks/collectionUtils.js";import{m as A}from"../../chunks/handleUtils.js";import{t as D}from"../../chunks/throttle.js";import{b as U}from"../../chunks/traversalUtils.js";import"../../chunks/colorUtils.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/deprecate.js";import"../../chunks/metadata.js";import"../../chunks/ArrayPool.js";import"../../chunks/arrayUtils.js";import"../../core/scheduling.js";import"../../core/Error.js";import"../../chunks/Message.js";import"../../chunks/Evented.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/write.js";import"../../geometry/SpatialReference.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../chunks/projectionEllipsoid.js";import"../../chunks/mat4.js";import"../../chunks/mat4f64.js";let C=class extends i{constructor(){super({}),this.color=new e([50,50,50,.7]),this.intervalOptions=new O([y(15,"minutes","milliseconds"),y(30,"minutes","milliseconds"),y(1,"hours","milliseconds"),y(2,"hours","milliseconds"),y(3,"hours","milliseconds")]),this.interval=this.intervalOptions.getItemAt(0)}set intervalOptions(t){this._set("intervalOptions",S(t,this._get("intervalOptions")))}};t([T({type:e})],C.prototype,"color",void 0),t([T()],C.prototype,"interval",void 0),t([T({type:O})],C.prototype,"intervalOptions",null),C=t([P("esri.widgets.ShadowAccumulation.DiscreteOptions")],C);var V=C;let z=class extends i{constructor(){super(...arguments),this.color=new e([0,0,255,.7]),this.mode="continuous"}};t([T({type:e})],z.prototype,"color",void 0),t([T()],z.prototype,"mode",void 0),z=t([P("esri.widgets.ShadowAccumulation.DurationOptions")],z);var E,R=z;!function(t){t.PointerMove="pointer-move",t.Main="main"}(E||(E={}));let x=class extends i{constructor(t){super(t),this._handles=new h,this._screenPoint=null,this._accumulatedShadowTime=null,this._shadowTimeTask=null,this._updateAccumulatedShadowTime=(t,e)=>{this._shadowTimeTask=r(this._shadowTimeTask),this._shadowTimeTask=p((async i=>{const{results:s,ground:o}=await t.hitTest(e);if(0===s.length&&!o.mapPoint)return void(this._accumulatedShadowTime=null);const r=await this.getDuration(e,i);this._accumulatedShadowTime=r}))},this._throttledUpdateAccumulatedShadowTime=D(this._updateAccumulatedShadowTime,300)}initialize(){this._handles.add(s((()=>({enabled:this.enabled,view:this.view})),(({enabled:t,view:e})=>{t&&a(e)?this._startTracking(e):this._stopTracking()})))}destroy(){this._handles=n(this._handles)}get screenPoint(){return this.enabled?this._screenPoint:null}get accumulatedShadowTime(){return this.enabled?this._accumulatedShadowTime:null}get testData(){return{setThrottleDelay:t=>{this._throttledUpdateAccumulatedShadowTime.remove(),this._throttledUpdateAccumulatedShadowTime=D(this._updateAccumulatedShadowTime,t)}}}_startTracking(t){const e=this._handles;if(e.has(E.Main))return;const i=()=>{e.has(E.PointerMove)||e.add(t.on("pointer-move",(e=>{const i=w(e.x,e.y);this._screenPoint=i,this._throttledUpdateAccumulatedShadowTime(t,i)})),E.PointerMove)},s=()=>{e.remove(E.PointerMove),this._screenPoint=null,this._accumulatedShadowTime=null};e.add([this._throttledUpdateAccumulatedShadowTime,t.on("pointer-enter",i),t.on("pointer-leave",s),t.on("pointer-down",s),t.on("pointer-drag",s),t.on("pointer-up",i),t.on("click",(e=>{const i=w(e.x,e.y);this._screenPoint=i,this._updateAccumulatedShadowTime(t,i)})),A((()=>{this._shadowTimeTask=r(this._shadowTimeTask)}))],E.Main),i()}_stopTracking(){this._handles.remove(E.Main)}};t([T()],x.prototype,"getDuration",void 0),t([T()],x.prototype,"view",void 0),t([T()],x.prototype,"enabled",void 0),t([T()],x.prototype,"screenPoint",null),t([T()],x.prototype,"accumulatedShadowTime",null),t([T()],x.prototype,"_screenPoint",void 0),t([T()],x.prototype,"_accumulatedShadowTime",void 0),t([T()],x.prototype,"_shadowTimeTask",void 0),x=t([P("esri.widgets.ShadowAccumulation.ShadowTooltipViewModel")],x);let M=class extends i{constructor(){super(...arguments),this.color=new e([255,0,0,.7]),this.value=y(4,"hours","milliseconds"),this.minValue=0,this.maxValue=y(8,"hours","milliseconds")}};t([T({type:e})],M.prototype,"color",void 0),t([T()],M.prototype,"value",void 0),t([T()],M.prototype,"minValue",void 0),t([T()],M.prototype,"maxValue",void 0),M=t([P("esri.widgets.ShadowAccumulation.ThresholdOptions")],M);var G=M;const N=[],F=b(),B=[],L=y(1,"hours","milliseconds");let H=class extends i{constructor(t){super(t),this.view=null,this.tooltip=new x({getDuration:(t,e)=>this.getDuration(t,e)}),this.startTimeOfDay=y(10,"hours","milliseconds"),this.endTimeOfDay=y(16,"hours","milliseconds"),this.visualizationType="threshold",this.thresholdOptions=new G,this.durationOptions=new R,this.discreteOptions=new V,this._running=!0,this._handles=new h,this._stopPreviewingTask=null,this._forcePreview=null,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this._handles.add([s((()=>({view:this.view,tooltipEnabled:this._tooltipEnabled})),(({view:t,tooltipEnabled:e})=>{this.tooltip.view=t,this.tooltip.enabled=e})),s((()=>this._getForcePreviewDependencies()),(()=>{r(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=p((async t=>{await m(300,t),_(t),this._forcePreview=!1})))})),o((()=>this._updateVisualizationParameters())),o((()=>this._setShadowAccumulationParameters({lightDirections:this._lightDirections}))),o((()=>this._setShadowAccumulationParameters({enabled:this._running}))),o((()=>this._setShadowAccumulationParameters({previewing:this._previewing})))])}destroy(){this.stop(),this._handles=n(this._handles),n(this.tooltip)}get state(){return a(this.view)&&this.view.ready&&a(this._referencePosition)?"ready":"disabled"}set date(t){const e=new Date(t);e.setHours(0,0,0,0),this._set("date",e)}get utcOffset(){return l(this._utcOffset,this._utcOffsetAuto)}set utcOffset(t){this._utcOffset=t}get testData(){return{setAutoRestoreForcedPreviewEnabled:t=>{this._autoRestoreForcePreviewEnabled=t},setForcedPreview:t=>{this._forcePreview=t},isPreviewing:()=>this._previewing}}get _previewing(){const{view:t}=this;return!(!c(t)&&!c(t.allLayerViews))||(this._forcePreview||!t.stationary||t.allLayerViews.some((t=>I(t)&&t.updating)))}get _utcOffsetAuto(){const t=this._referencePosition;return u(t,0,(t=>j(t[0],!1)))}get _dateUTCOffset(){let t=this.date;return t=g(t,-t.getTimezoneOffset(),"minutes"),t=g(t,-this.utcOffset,"hours"),t}get _startDateTimeUTC(){return g(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return g(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return d(this.view,(t=>d(t.environmentManager,(t=>t.referencePositionWGS84Comparable))))}get _sampleCount(){switch(this.visualizationType){case"threshold":case"duration":return 255;case"discrete":{const t=this.discreteOptions.interval;return t>0?Math.floor(this._duration/t):255}}}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){const{view:t}=this;if(c(t))return N;const e="global"===t.viewingMode?F:this._referencePosition;if(c(e))return N;const i=this._sampleCount,s=new Array(i);for(let t=0;t<i;++t)s[t]=b();k(this._startDateTimeUTC,this._endDateTimeUTC,e,t.viewingMode,s),B.length=0;const o=U(0,i,B),r=new Array(i);for(let t=0;t<i;++t)r[t]=s[o[t]];return r}get _tooltipEnabled(){return"ready"===this.state&&"discrete"!==this.visualizationType&&this._running&&!this._previewing}start(){this._running=!0}stop(){this._running=!1}setRunning(t){this._running=t}async getDuration(t,e){const{view:i,_renderView:s}=this;if(c(i)||c(s))return 0;const o=i.state.camera.screenToRender(v(t.x,t.y),f()),r=s.readAccumulatedShadow(o),a=this._sampleCount;if(0===a)return 0;return r*a*(this._duration/a)}_setShadowAccumulationParameters(t){const e=this._renderView;c(e)||e.setRenderParameters({shadowAccumulationOptions:t})}_updateVisualizationParameters(){if(this._running)switch(this.visualizationType){case"threshold":this._updateThresholdVisualizationParameters();break;case"duration":this._updateDurationVisualizationParameters();break;case"discrete":this._updateDiscreteVisualizationParameters()}}_updateThresholdVisualizationParameters(){const{value:t,color:i}=this.thresholdOptions,s=this._duration,o=i,r=o.clone();r.a=0,this._setShadowAccumulationParameters({visualization:1,thresholdColors:[e.toUnitRGBA(r),e.toUnitRGBA(o)],threshold:s>0?t/this._duration:0})}_updateDurationVisualizationParameters(){const{color:t,mode:e}=this.durationOptions;this._updateGradientColorRamp(t);const i=this._duration,s=i>0&&"hourly"===e?L/i:0;this._setShadowAccumulationParameters({visualization:0,bandsEnabled:s>0,bandSize:s})}_updateDiscreteVisualizationParameters(){this._updateGradientColorRamp(this.discreteOptions.color),this._setShadowAccumulationParameters({visualization:0,bandsEnabled:!1,bandSize:0})}_updateGradientColorRamp(t){const i=t,s=i.clone();s.a=0;const o=[e.toUnitRGBA(s),e.toUnitRGBA(i)];this._setShadowAccumulationParameters({gradientColorRamp:o})}get _renderView(){const{view:t}=this;if(c(t))return null;const e=t._stage;return c(e)?null:e.renderView}_getForcePreviewDependencies(){const{view:t}=this;if(c(t))return null;const e=t.slicePlane,i=t.allLayerViews.toArray().filter(I),s=i.map((t=>t.layer)).filter(a),o=i.map((t=>t.visible)),r=s.map((t=>t.visible)),n=s.map((t=>t.opacity)),l=s.filter((function(t){return"definitionExpression"in t})).map((t=>t.definitionExpression)),u=i.filter((function(t){return"filter"in t})).map((t=>t.filter));return{slicePlane:e,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:o,layerVisibilities:r,layerOpacities:n,filters:u,definitionExpressions:l}}};function I(t){if(t.suspended)return!1;switch(t.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"ogc-feature-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"slice-3d":case"stream-3d":case"wms-3d":return!0;case"area-measurement-3d":case"base-dynamic-3d":case"direct-line-measurement-3d":case"imagery-3d":case"imagery-tile-3d":case"line-of-sight-3d":case"map-image-3d":case"point-cloud-3d":case"tile-3d":case"vector-tile-3d":case"voxel-3d":case"wfs-3d":case"wmts-3d":case"voxel-3d":return!1;case"group":return t.layerViews.toArray().some((t=>I(t)));default:return!1}}t([T()],H.prototype,"state",null),t([T()],H.prototype,"view",void 0),t([T()],H.prototype,"tooltip",void 0),t([T({nonNullable:!0})],H.prototype,"date",null),t([T({nonNullable:!0})],H.prototype,"utcOffset",null),t([T({nonNullable:!0})],H.prototype,"startTimeOfDay",void 0),t([T({nonNullable:!0})],H.prototype,"endTimeOfDay",void 0),t([T({nonNullable:!0})],H.prototype,"visualizationType",void 0),t([T({type:G,nonNullable:!0})],H.prototype,"thresholdOptions",void 0),t([T({type:R,nonNullable:!0})],H.prototype,"durationOptions",void 0),t([T({type:V,nonNullable:!0})],H.prototype,"discreteOptions",void 0),t([T()],H.prototype,"_running",void 0),t([T()],H.prototype,"_handles",void 0),t([T()],H.prototype,"_stopPreviewingTask",void 0),t([T()],H.prototype,"_forcePreview",void 0),t([T()],H.prototype,"_autoRestoreForcePreviewEnabled",void 0),t([T()],H.prototype,"_previewing",null),t([T()],H.prototype,"_utcOffset",void 0),t([T()],H.prototype,"_utcOffsetAuto",null),t([T()],H.prototype,"_dateUTCOffset",null),t([T()],H.prototype,"_startDateTimeUTC",null),t([T()],H.prototype,"_endDateTimeUTC",null),t([T()],H.prototype,"_referencePosition",null),t([T()],H.prototype,"_sampleCount",null),t([T()],H.prototype,"_duration",null),t([T()],H.prototype,"_lightDirections",null),t([T()],H.prototype,"_tooltipEnabled",null),H=t([P("esri.widgets.ShadowAccumulation.ShadowAccumulationViewModel")],H);var J=H;export default J;
