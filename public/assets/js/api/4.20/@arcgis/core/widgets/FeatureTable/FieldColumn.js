/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{property as e}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/ensureType.js";import"../../chunks/Logger.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import{b as n,c as o,a as r,f as s}from"../../chunks/number.js";import l from"../../layers/support/CodedValueDomain.js";import{isNumericField as a,isStringField as u}from"../../layers/support/fieldUtils.js";import d from"../FeatureForm/InputField.js";import{E as c}from"../../chunks/Evented.js";import{HandleOwnerMixin as p}from"../../core/HandleOwner.js";import{watch as m}from"../../core/watchUtils.js";import h from"./Grid/support/ButtonMenu.js";import{r as v}from"../../chunks/widgetUtils.js";import f from"../support/DatePicker.js";import g from"../support/TimePicker.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/Message.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/enumeration.js";import"../../chunks/JSONSupport.js";import"../../core/Accessor.js";import"../../chunks/deprecate.js";import"../../chunks/ArrayPool.js";import"../../chunks/arrayUtils.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../core/Error.js";import"../../chunks/write.js";import"../../layers/support/Domain.js";import"../../chunks/domains.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../intl.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../core/Handles.js";import"../../core/Collection.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../Widget.js";import"../../chunks/domUtils.js";import"../../chunks/Promise.js";import"../../chunks/uuid.js";import"../../chunks/projector.js";import"../../chunks/jsxWidgetSupport.js";import"./Grid/support/ButtonMenuViewModel.js";import"./Grid/support/ButtonMenuItem.js";import"../../chunks/Popover.js";import"../../chunks/jsxFactory.js";import"../../chunks/moment.js";import"../support/DatePickerViewModel.js";import"../../chunks/MomentElementViewModel.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../support/TimePickerViewModel.js";const y="esri-icon-arrow-up",F="esri-icon-arrow-down",j="esri-column__menu-container",b="esri-icon-handle-horizontal",E="esri-column__sorter",w="Enter",C="Spacebar";let _=class extends(p(c.EventedAccessor)){constructor(t){super(t),this._menuContainer=null,this.activeRowIndex=null,this.autoWidth=!1,this.cellValueFormatFunction=({value:t})=>v.sanitize(t),this.flexGrow=1,this.footerRenderFunction=null,this.frozen=!1,this.grid=null,this.header=null,this.headerRenderFunction=t=>{const{root:e}=t,{header:i,headerMenuEnabled:n,path:o,sortable:r}=this;if(this.removeCellContent(e),r)return this.headerSorterRenderFunction(t),void(n&&this.headerMenuRenderFunction(t));n&&this.headerMenuRenderFunction(t);const s=i||o;e.innerHTML!==s&&(e.innerHTML=s)},this.headerMenuRenderFunction=({root:t})=>{var e,i;(null==(e=this.menu)||null==(i=e.items)?void 0:i.length)&&t.appendChild(this._menuContainer)},this.headerSorterRenderFunction=({root:t})=>{var e;const{header:i,path:n,sortElement:o}=this,r=i||n;if(!o)return void(t.innerHTML=r);o.innerHTML!==r&&o.setAttribute("innerHTML",r),t.appendChild(o);const s=null==(e=this.grid)?void 0:e.getSlotElementByName(t.slot),l=null==s?void 0:s.parentElement;l&&!l.onkeydown&&(l.onkeydown=({key:t})=>{t!==w&&t!==C||o.click()})},this.hidden=!1,this.headerMenuEnabled=!0,this.menu=null,this.menuConfig=null,this.messages=null,this.messagesCommon=null,this.renderFunction=({root:t,column:e,rowData:i})=>{const n=this.getCellValue(e,i),o=this.cellValueFormatFunction({column:e,rowData:i,value:n});t.innerHTML!==o&&(t.innerHTML=o)},this.resizable=!0,this.sortable=!0,this.sortElement=null,this.textAlign="start",this.width=200}initialize(){const{messages:t,path:e}=this;this._set("sortElement",this.createSortElement()),this.sortElement.setAttribute("path",e),this._menuContainer=document.createElement("div"),this._menuContainer.classList.add(j),this.menu=new h({label:null==t?void 0:t.options,iconClass:b,...this.menuConfig}),this.menu.container=this._menuContainer,this.menu.set("items",this.getMenuItems()),this.handles.add([m(this,"hidden",(()=>{var t;return null==(t=this.menu)?void 0:t.set("open",!1)}))])}destroy(){var t;null==(t=this.menu)||t.destroy()}set direction(t){this.sortable&&(this.sortElement&&(t?this.sortElement.direction!==t&&this.sortElement.setAttribute("direction",t):this.sortElement.removeAttribute("direction")),this._set("direction",t))}get direction(){return this._get("direction")||null}set path(t){this.sortElement&&this.sortElement.path!==t&&this.sortElement.setAttribute("path",t),this._set("path",t)}getMenuItems(){const{menuConfig:t,sortable:e}=this,i=null==t?void 0:t.items,n=this.getSortMenuItems(),o=[];return e&&o.push(...n),(null==i?void 0:i.length)&&o.push(...i),o.length?o:null}getSortMenuItems(){const{messages:t}=this;return[{selected:"asc"===this.direction,iconClass:y,label:null==t?void 0:t.sortAsc,autoCloseMenu:!0,clickFunction:()=>this.set("direction","asc"!==this.direction?"asc":null)},{selected:"desc"===this.direction,iconClass:F,label:null==t?void 0:t.sortDesc,autoCloseMenu:!0,clickFunction:()=>this.set("direction","desc"!==this.direction?"desc":null)}]}getCellValue(t,e){var i;return null!=(i=null==e?void 0:e.item[null==t?void 0:t.path])?i:""}createSortElement(){const{direction:t,header:e,path:i}=this,n=e||i,o=document.createElement("vaadin-grid-sorter");return o.classList.add(E),o.setAttribute("path",i),t&&o.setAttribute("direction",t),o.innerHTML=n,o.setAttribute("title",n),o}removeCellContent(t){if(t)for(;t.firstChild;)try{t.removeChild(t.firstChild)}catch(t){}}};t([e()],_.prototype,"activeRowIndex",void 0),t([e()],_.prototype,"autoWidth",void 0),t([e()],_.prototype,"cellValueFormatFunction",void 0),t([e()],_.prototype,"direction",null),t([e()],_.prototype,"flexGrow",void 0),t([e()],_.prototype,"footerRenderFunction",void 0),t([e()],_.prototype,"frozen",void 0),t([e()],_.prototype,"grid",void 0),t([e()],_.prototype,"header",void 0),t([e()],_.prototype,"headerRenderFunction",void 0),t([e()],_.prototype,"headerMenuRenderFunction",void 0),t([e()],_.prototype,"headerSorterRenderFunction",void 0),t([e()],_.prototype,"hidden",void 0),t([e()],_.prototype,"headerMenuEnabled",void 0),t([e()],_.prototype,"menu",void 0),t([e()],_.prototype,"menuConfig",void 0),t([e()],_.prototype,"messages",void 0),t([e()],_.prototype,"messagesCommon",void 0),t([e()],_.prototype,"path",null),t([e()],_.prototype,"renderFunction",void 0),t([e()],_.prototype,"resizable",void 0),t([e()],_.prototype,"sortable",void 0),t([e({readOnly:!0})],_.prototype,"sortElement",void 0),t([e()],_.prototype,"textAlign",void 0),t([e()],_.prototype,"width",void 0),_=t([i("esri.widgets.FeatureTable.Grid.Column")],_);var k=_;const I="esri-editor-column__cell-input",M="esri-editor-column__cell-input--container",V="Enter",D="Escape";let L=class extends k{constructor(t){super(t),this.activeEditInfo=null,this.cellValueValidatorFunction=({oldValue:t,value:e})=>t!==e,this.editable=!1,this.inputRenderFunction=({root:t,column:e,rowData:i})=>{var n,o;if(null!=(n=this.activeEditInfo)&&n.updating)return;if(!this.editable)return;const r=this.getCellValue(e,i),s=this.createInputElement({root:t,column:e,rowData:i,value:r});this._set("activeEditInfo",{column:e,input:s,root:t,rowData:i,updating:!0,oldValue:r});const l=this.createInputContainer();l.appendChild(s),this.removeCellContent(t),t.appendChild(l),s.focus(),s instanceof HTMLInputElement&&s.select(),null==(o=this.grid)||o.notifyResize()},this.loadingMessage="",this.inputType="text",this.maxLength=null,this.parseInputValueFunction=({input:t})=>t.value,this.renderFunction=t=>{var e;const{root:i,column:n,rowData:o}=t,{activeEditInfo:r}=this;if(r&&r.updating)return;const s=this.getCellValue(n,o),l=this.cellValueFormatFunction({column:n,rowData:o,value:s});i.onclick=()=>i.focus(),i.ondblclick=()=>this.inputRenderFunction(t),i.ontouchend=()=>this.inputRenderFunction(t);const a=null==(e=this.grid)?void 0:e.getSlotElementByName(i.slot),u=null==a?void 0:a.parentElement;u&&!u.onkeydown&&(u.onkeydown=e=>{e.key!==V||this.activeEditInfo||this.inputRenderFunction(t),e.key===D&&this.activeEditInfo&&this.cancel()}),(null==l?void 0:l.toString())!==i.innerHTML&&(i.innerHTML=l)},this.required=!1,this.store=null,this.updateRowItemFunction=({rowData:t,column:e,value:i})=>{t.item[e.path]=i},this.updateStoreItemFunction=({rowData:t,column:e,value:i})=>{var n;return null==(n=this.store)?void 0:n.updateItem({index:t.index,name:e.path,value:i})}}cancel(){var t;const{activeEditInfo:e}=this;if(!e)return;const{column:i,root:n,rowData:o,oldValue:r}=e;this._set("activeEditInfo",null);const s=this.cellValueFormatFunction({column:i,rowData:o,value:r});n.innerHTML=s,null==(t=this.grid)||t.notifyResize()}createInputContainer(){const t=document.createElement("div");return t.classList.add(M),t}createInputElement({value:t}){const e=document.createElement("input");return e.classList.add(I),e.maxLength=this.maxLength,e.type=this.inputType,e.value=t,e.onblur=()=>{e.onblur=null,this.submit()},e}async submit(){var t;const{activeEditInfo:e}=this;if(!e)return;const{column:i,input:n,root:o,rowData:r,oldValue:s}=e,l=this.parseInputValueFunction({input:n,column:i,rowData:r});if(!this.cellValueValidatorFunction({value:l,oldValue:s,column:i,rowData:r}))this.cancel();else{o.innerHTML=this.loadingMessage,null==(t=this.grid)||t.notifyResize();try{var a;await this.updateStoreItemFunction({rowData:r,column:i,value:l}),this.updateRowItemFunction({rowData:r,column:i,value:l});const t=this.getCellValue(i,r),e=this.cellValueFormatFunction({column:i,rowData:r,value:t});o.innerHTML=e,this.emit("value-change",{column:i,rowData:r,value:t}),this._set("activeEditInfo",null),null==(a=this.grid)||a.notifyResize()}catch(t){this.cancel()}}}};t([e({readOnly:!0})],L.prototype,"activeEditInfo",void 0),t([e()],L.prototype,"cellValueValidatorFunction",void 0),t([e()],L.prototype,"editable",void 0),t([e()],L.prototype,"inputRenderFunction",void 0),t([e({constructOnly:!0})],L.prototype,"loadingMessage",void 0),t([e()],L.prototype,"inputType",void 0),t([e()],L.prototype,"maxLength",void 0),t([e()],L.prototype,"parseInputValueFunction",void 0),t([e()],L.prototype,"renderFunction",void 0),t([e()],L.prototype,"required",void 0),t([e()],L.prototype,"store",void 0),t([e()],L.prototype,"updateRowItemFunction",void 0),t([e()],L.prototype,"updateStoreItemFunction",void 0),L=t([i("esri.widgets.FeatureTable.EditorColumn")],L);var R=L;const T="Escape",x="esri-field-column__header-content",S="esri-field-column__cell-input",O="esri-field-column__cell__input-container",H="esri-field-column__cell__date-input-container",z="esri-field-column__cell__date-input-wrapper",U="esri-field-column__button",A="esri-icon-save",P="esri-icon-trash",q="esri-icon-locked",G=o("short-date-short-time"),B=o("short-date"),N=n({digitSeparator:!0,places:null});let W=class extends R{constructor(t){super(t),this._inputField=null,this.alias=null,this.cellValueFormatFunction=({rowData:t,value:e})=>{if(this.formatFunction){const{config:t,field:i}=this;return this.formatFunction({config:t,field:i,value:v.sanitize(e)})}if(null===e)return"&nbsp;";const{config:i,field:l,type:u}=this,{item:{feature:d}}=t,c=this._getDomainForFeature(d);if(c)return this._getComputedDomain(e,c);if("date"===u){var p;const t=null!=i&&null!=(p=i.format)&&p.dateFormat?o(i.format.dateFormat):!1===(null==i?void 0:i.includeTime)?B:G;return e?r(e,t):null}if(a(l)){const t=null!=i&&i.format?n(i.format):N;return s(parseFloat(e),t)}return v.sanitize(e)},this.cellValueValidatorFunction=({oldValue:t,value:e})=>t!==e,this.config=null,this.defaultValue=null,this.description=null,this.editingEnabled=!1,this.field=null,this.formatFunction=null,this.headerRenderFunction=t=>{const{root:e}=t,{editable:i,editingEnabled:n,headerMenuEnabled:o,sortable:r}=this;if(this.removeCellContent(e),e.classList.add(x),n&&!i&&e.appendChild(this.createLockedElement()),r)this.headerSorterRenderFunction(t);else{const{header:t,path:i}=this,n=document.createElement("div");n.innerHTML=t||i,e.appendChild(n)}o&&this.headerMenuRenderFunction(t)},this.inputRenderFunction=({root:t,column:e,rowData:i})=>{var n,o;if(null!=(n=this.activeEditInfo)&&n.updating)return;if(!this.editable)return;const r=this.getCellValue(e,i),s=this.createInputElement({root:t,column:e,rowData:i,value:r});if(this._set("activeEditInfo",{column:e,input:s,root:t,rowData:i,updating:!0,oldValue:r}),"date"===this.type)return void this._renderDateEditors(r,t,s);const l=this.createInputContainer();l.appendChild(s),this.removeCellContent(t),t.appendChild(l),s.focus(),s instanceof HTMLInputElement&&s.select(),null==(o=this.grid)||o.notifyResize()},this.layer=null,this.menuConfig=null,this.name=null,this.nullable=!0,this.parseInputValueFunction=({input:t})=>{const e=this._inputField,i=t.value,{required:n,type:o}=e;return n||""!==i?"number"===o||"date"===o?parseFloat(i):i:null},this.path=null,this.type=null,this.updateRowItemFunction=({rowData:t,column:e,value:i})=>{t.item.feature.attributes[e.path]=i}}get editable(){var t,e,i;return this.editingEnabled?this.config?!1!==this.config.editable&&(null==(e=this.field)?void 0:e.editable):null==(i=this.field)?void 0:i.editable:!!this.config&&(!0===this.config.editable&&(null==(t=this.field)?void 0:t.editable))}get header(){var t;return(null==(t=this.config)?void 0:t.label)||this.alias||this.path||null}get hidden(){const{config:t}=this;return!1===(null==t?void 0:t.visible)||this._get("hidden")||!1}set hidden(t){this._set("hidden",t)}get loadingMessage(){var t;return(null==(t=this.messages)?void 0:t.loading)||"..."}get maxLength(){var t,e;const i=null==(t=this.field)?void 0:t.length,n=null==(e=this.config)?void 0:e.maxLength;return!isNaN(n)&&n>=-1&&(-1===i||n<=i)?n:i}get required(){const t=this.get("field.nullable"),e=this.get("config.required");return this.editable&&(!t||!0===e)}get sortable(){var t;return!1!==(null==(t=this.config)?void 0:t.sortable)}createInputElement({rowData:t,value:e}){const{item:i}=t;if(!i||!i.feature)return null;this._inputField=this._setUpInputField(i.feature,e);const{field:n,maxLength:o,required:r}=this,{domain:s}=this._inputField;let l=null;"coded-value"===(null==s?void 0:s.type)?(l=this._createSelectElement(e,s.codedValues.map((({code:t,name:e})=>({value:t,name:e}))),this._inputField),l.onchange=()=>{l.onblur=null,d()}):(l=document.createElement("input"),l.type=a(n)?"number":"text",o>-1&&(l.maxLength=o)),l.classList.add(S),l.value=e,l.required=r;let u=!1;l.onkeydown=t=>{u=t.key===T},l.onblur=()=>{l.onblur=null,d()};const d=()=>{u?this.cancel():this.submit(),this._inputField=null};return l}createInputContainer(){const t=document.createElement("div");return t.classList.add(O),t}createLockedElement(){const t=document.createElement("div");return t.classList.add(q),t}getCellValue({path:t},{item:e}){var i,n,o;return null!=(i=null==e||null==(n=e.feature)||null==(o=n.attributes)?void 0:o[t])?i:null}_renderDateEditors(t,e,i){var n;const{config:o,messagesCommon:r}=this,s=t?new Date(t):new Date(Date.now()),l=new f({dateInputEnabled:!0,value:s}),a=new g({value:s});i.value=s.getTime().toString();let u=!t;const d=()=>{u=!0;const t=this._getCombinedDateTime(l.value,a.value);i.value=t.getTime().toString()},c=()=>{u?this.submit():this.cancel()},p=()=>{i.value=null,this.submit()};l.watch("value",(()=>d())),a.watch("value",(()=>d()));const m=document.createElement("div"),h=document.createElement("div");l.container=m,a.container=h;const v=document.createElement("button");v.classList.add(U,A),v.onclick=()=>c(),v.title=null==r?void 0:r.save;const y=document.createElement("button");y.classList.add(U,P),y.onclick=()=>p(),y.title=null==r?void 0:r.clear;const F=document.createElement("div");F.classList.add(z),F.appendChild(m),!1!==o.includeTime&&F.appendChild(h);const j=document.createElement("div");j.classList.add(H),j.appendChild(F),j.appendChild(v),j.appendChild(y),l.when((()=>{var t;return null==(t=this.grid)?void 0:t.notifyResize()})),a.when((()=>{var t;return null==(t=this.grid)?void 0:t.notifyResize()})),this.removeCellContent(e),e.appendChild(j),null==(n=this.grid)||n.notifyResize()}_createSelectElement(t,e,i){let n=!1;const o=e.map((e=>{e.value===t&&(n=!0);const i=document.createElement("option");return i.text=e.name,i.value=e.value,i}));if(null!=t&&""!==t&&!n){const e=document.createElement("option");e.text=t,e.value=t,o.unshift(e)}if(!i.required&&null==i.value){const t=document.createElement("option");t.value="",o.unshift(t)}const r=document.createElement("select");return o.forEach((t=>r.add(t))),r.value=t,r}_setUpInputField(t,e){const{config:i,field:n,layer:o}=this,r=new d({config:i,feature:t,field:n,layer:o,group:null,messages:null});return r.set("value",e),r}_isDomainCompatible(t){const{field:e}=this;if(t&&"coded-value"===t.type){const i=typeof t.codedValues[0].code;if("string"===i&&u(e)||"number"===i&&a(e))return!0}return!(!t||"range"!==t.type||!a(e))}_getDomainForFeature(t){const{layer:e,name:i}=this,{typeIdField:n}=e,o=n===i,r=this.get("field.domain");if(o&&!r)return new l({name:"__internal-type-based-coded-value-domain__",codedValues:e.types.map((({id:t,name:e})=>({code:t,name:e})))});const s=n&&e.getFieldDomain(i,{feature:t})||r,a=this.get("config.domain");return this._isDomainCompatible(a)?a:s}_getComputedDomain(t,e){if(!e)return null;if("range"===e.type)return t;if("coded-value"===e.type){const i=e.codedValues.filter((e=>e.hasOwnProperty("code")&&e.code===t));return i&&i.length?i[0].name:t}return null}_getCombinedDateTime(t,e){return new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.getHours(),e.getMinutes(),e.getSeconds())}};t([e({readOnly:!0,aliasOf:"field.alias"})],W.prototype,"alias",void 0),t([e()],W.prototype,"cellValueFormatFunction",void 0),t([e()],W.prototype,"cellValueValidatorFunction",void 0),t([e()],W.prototype,"config",void 0),t([e({readOnly:!0,aliasOf:"field.defaultValue"})],W.prototype,"defaultValue",void 0),t([e({readOnly:!0,aliasOf:"field.description"})],W.prototype,"description",void 0),t([e({readOnly:!0})],W.prototype,"editable",null),t([e()],W.prototype,"editingEnabled",void 0),t([e()],W.prototype,"field",void 0),t([e()],W.prototype,"formatFunction",void 0),t([e({readOnly:!0})],W.prototype,"header",null),t([e()],W.prototype,"hidden",null),t([e()],W.prototype,"headerRenderFunction",void 0),t([e()],W.prototype,"inputRenderFunction",void 0),t([e()],W.prototype,"layer",void 0),t([e({readOnly:!0})],W.prototype,"loadingMessage",null),t([e()],W.prototype,"maxLength",null),t([e({readOnly:!0,aliasOf:"config.menuConfig"})],W.prototype,"menuConfig",void 0),t([e({readOnly:!0,aliasOf:"field.name"})],W.prototype,"name",void 0),t([e({readOnly:!0,aliasOf:"field.nullable"})],W.prototype,"nullable",void 0),t([e()],W.prototype,"parseInputValueFunction",void 0),t([e({readOnly:!0,aliasOf:"field.name"})],W.prototype,"path",void 0),t([e({readOnly:!0})],W.prototype,"required",null),t([e()],W.prototype,"sortable",null),t([e({readOnly:!0,aliasOf:"field.type"})],W.prototype,"type",void 0),t([e()],W.prototype,"updateRowItemFunction",void 0),W=t([i("esri.widgets.FeatureTable.FieldColumn")],W);var J=W;export default J;export{k as C};
