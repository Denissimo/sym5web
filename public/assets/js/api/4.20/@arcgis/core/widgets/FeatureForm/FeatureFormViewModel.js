/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import{fetchMessageBundle as o}from"../../intl.js";import{E as s}from"../../chunks/Evented.js";import{HandleOwnerMixin as i}from"../../core/HandleOwner.js";import{L as r}from"../../chunks/Logger.js";import{R as n}from"../../core/Accessor.js";import{init as l}from"../../core/watchUtils.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{cast as a}from"../../core/accessorSupport/decorators/cast.js";import{subclass as m}from"../../core/accessorSupport/decorators/subclass.js";import u from"../../form/FormTemplate.js";import{l as d}from"../../chunks/arcadeOnDemand.js";import c from"./FieldConfig.js";import y from"./FieldGroupConfig.js";import f from"./InputField.js";import h from"./InputFieldGroup.js";import j from"../../layers/support/RangeDomain.js";import{o as g}from"../../chunks/locale.js";import"../../geometry.js";import"../../chunks/ensureType.js";import"../../geometry/Extent.js";import"../../chunks/string.js";import"../../chunks/object.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/write.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../chunks/arrayUtils.js";import"../../core/Error.js";import"../../chunks/Message.js";import"../../config.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../chunks/deprecate.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Collection.js";import"../../layers/support/fieldUtils.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../chunks/enumeration.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../chunks/chartMediaInfoUtils.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../support/actions/ActionBase.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../request.js";import"../../chunks/Loadable.js";import"../../chunks/Promise.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../chunks/assets.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../chunks/Thumbnail.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/uid.js";import"../../core/Handles.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/support/elements.js";function b(e,t,o,s=!0){return e.map((e=>{if("field"===e.type)return function(e,t,o){const{description:s,domain:i,editable:r,fieldName:n,hint:l,input:p,label:a,requiredExpression:m,visibilityExpression:u}=e,d=t[m]||null,y=t[u]||null,f=new c({description:s,domain:i,editable:r,hint:l,label:a,name:n,requiredExpression:d,visibilityExpression:y});if(p)if("barcode-scanner"===p.type||"text-area"===p.type||"text-box"===p.type)f.editorType=p.type,f.minLength=p.minLength,f.maxLength=p.maxLength;else if("combo-box"===p.type||"radio-buttons"===p.type)f.editorType=p.type,f.noValueOptionLabel=p.noValueOptionLabel,f.showNoValueOption=p.showNoValueOption;else if("switch"===p.type)f.editorType=p.type,f.offValue=p.offValue,f.onValue=p.onValue;else if("datetime-picker"===p.type){f.editorType=p.type,f.includeTime=p.includeTime;const{max:e,min:t}=p;if(e||t){const o="range"===(null==i?void 0:i.type)?Math.min(null==e?void 0:e.getTime(),i.maxValue):null==e?void 0:e.getTime(),s="range"===(null==i?void 0:i.type)?Math.max(null==t?void 0:t.getTime(),i.minValue):null==t?void 0:t.getTime();f.domain=new j({maxValue:o,minValue:s,name:"__internal-range-domain-based-on-datetime-picker-input__"})}}else o.push({type:"unsupported-input-type",details:p});return f}(e,t,o);if("group"===e.type){if(!s)return o.push({type:"nested-group",details:e}),null;const i=t[e.visibilityExpression]||null;return new y({description:e.description,state:e.initialState,fieldConfig:b(e.elements,t,o,!1),label:e.label,visibilityExpression:i})}return o.push({type:"unsupported-element-type",details:e}),null})).filter((e=>!!e))}function _(e){return!!e.inputFields}function v(e){return!!e.fieldConfig}const F=new t({attributes:{}}),C="esri.widgets.FeatureForm.FeatureFormViewModel",k=r.getLogger(C);let S=class extends(i(s.EventedAccessor)){constructor(e){super(e),this._arcade=null,this._fieldPool=new n(f),this._fieldGroupPool=new n(h),this._featureClone=F.clone(),this._initialFeature=F.clone(),this._needsArcade=!1,this.messages=null,this.strict=!1}initialize(){const e=async()=>this.messages=await o("esri/widgets/FeatureForm/t9n/FeatureForm");e(),this.handles.add(g(e));const t=l(this,"fieldConfig",(async e=>{const o=[];e&&e.forEach((e=>{o.push(e.visibilityExpression),v(e)?e.fieldConfig.forEach((({requiredExpression:e,visibilityExpression:t})=>{o.push(e,t)})):o.push(e.requiredExpression)}));const s=o.filter((e=>!!e)),i=s.length>0;if(i){const e=await d(),{arcadeUtils:o}=e;s.some((e=>o.hasGeometryOperations(e)))&&(await o.enableGeometryOperations(),t.remove()),this._arcade=e,this.notifyChange("inputFields")}this._needsArcade=i}));this.handles.add(t)}destroy(){this.fieldConfig=null,this.feature=null,this.layer=null,this._fieldPool.destroy(),this._fieldGroupPool.destroy()}get _allInputFields(){return this.inputFields.reduce(((e,t)=>_(t)?[...e,...t.inputFields]:[...e,t]),[])}get _inputFieldCache(){const e=this._get("_inputFieldCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.get("layer.fields")||[]).forEach((t=>e.set(t,this._fieldPool.acquire()))),e}get _inputFieldGroupCache(){const e=this._get("_inputFieldGroupCache")||new Map;e.forEach((e=>this._disposeInputOrGroup(e))),e.clear();return(this.fieldConfig||[]).filter(v).forEach((t=>e.set(t,this._fieldGroupPool.acquire()))),e}get description(){var e;return null==(e=this.formTemplate)?void 0:e.description}set description(e){void 0===e?this._clearOverride("description"):this._override("description",e)}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():F.clone(),this._initialFeature=this._featureClone.clone(),this._set("feature",e)}get fieldConfig(){const{formTemplate:e}=this;if(!e)return null;const{config:t,encounteredUnsupportedTypes:o}=function(e){var t;const o={},s=[];return null==(t=e.expressionInfos)||t.map((e=>o[e.name]=e.expression)),{config:b(e.elements,o,s),encounteredUnsupportedTypes:s}}(e);return o.length>0&&k.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",o),t}set fieldConfig(e){e?this._override("fieldConfig",e):this._clearOverride("fieldConfig")}castFieldConfig(e){return e?e.map((e=>e instanceof c||e instanceof y?e:v(e)?new y(e):new c(e))):null}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get inputFields(){const{_arcade:e,_inputFieldCache:t,_inputFieldGroupCache:o,_featureClone:s,messages:i,_needsArcade:r,layer:n,state:l}=this,p=s.clone();if("ready"!==l||r&&!e)return[];const a=this.get("layer.fields")||[],m=this.fieldConfig||[];let u;return u=0!==m.length?m.map((s=>{if(v(s)){const r=o.get(s),l=s.fieldConfig.map((o=>{const s=a.find((e=>e.name===o.name)),l=t.get(s);return l.set({arcade:e,field:s,config:o,feature:p,group:r,initialFeature:this._initialFeature,layer:n,messages:i,value:this.getValue(s.name)}),l})).filter((e=>e.visible));return r.set({arcade:e,config:s,feature:p,inputFields:l}),r}const r=a.find((e=>e.name===s.name)),l=t.get(r);return l.set({arcade:e,field:r,config:s,feature:p,group:null,initialFeature:this._initialFeature,layer:n,messages:i,value:this.getValue(r.name)}),l})):a.map((o=>{const s=t.get(o);return s.set({arcade:e,config:null,field:o,feature:p,group:null,initialFeature:this._initialFeature,layer:n,messages:i,value:this.getValue(o.name)}),s})),u.filter((e=>e.visible))}get layer(){var e;return null!=(e=this.feature)&&e.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){e?this._override("layer",e):this._clearOverride("layer")}get state(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}get title(){var e;return null==(e=this.formTemplate)?void 0:e.title}set title(e){void 0===e?this._clearOverride("title"):this._override("title",e)}get valid(){const e=this._allInputFields;return e.length>0&&e.every((({valid:e})=>e))}findField(e){return this._allInputFields.find((t=>t.name===e))}getValue(e){var t;const{_featureClone:o,layer:s}=this,i=!(null==s||!s.getField(e));return null!=(t=o.getAttribute(e))?t:i?null:void 0}setValue(e,t){const{_featureClone:o,strict:s}=this,i=this.findField(e);if(t=""===t?null:t,!i||o.getAttribute(e)===t)return;i.value=t;if(this.get("layer.typeIdField")===i.name&&"types"in this.layer){const e=new Set;this.layer.types.forEach((t=>Object.keys(t.domains).forEach((t=>e.add(t))))),e.forEach((e=>{const t=this.findField(e);t&&t.notifyChange("domain")}))}s&&!i.valid||(o.setAttribute(e,t),this.notifyChange("inputFields"),this._emitChangeEvent(i))}getValues(){return{...this._featureClone.attributes}}submit(){const e=this._allInputFields,t=e.filter((e=>e.valid)).map((({name:e})=>e)),o=e.filter((e=>!e.valid)).map((({name:e})=>e)),s=this.getValues();this.emit("submit",{valid:t,invalid:o,values:s})}_disposeInputOrGroup(e){_(e)?this._disposeGroup(e):this._disposeInput(e)}_disposeGroup(e){e.inputFields.forEach((e=>this._disposeInput(e))),this._fieldGroupPool.release(e)}_disposeInput(e){this._fieldPool.release(e)}_emitChangeEvent({name:e,valid:t,value:o}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:o,valid:t})}};e([p({readOnly:!0})],S.prototype,"_allInputFields",null),e([p({readOnly:!0})],S.prototype,"_inputFieldCache",null),e([p({readOnly:!0})],S.prototype,"_inputFieldGroupCache",null),e([p()],S.prototype,"description",null),e([p()],S.prototype,"feature",null),e([p()],S.prototype,"fieldConfig",null),e([a("fieldConfig")],S.prototype,"castFieldConfig",null),e([p({type:u})],S.prototype,"formTemplate",null),e([p({readOnly:!0,dependsOn:["messages","feature","fieldConfig","layer.fields","layer.loaded","state"]})],S.prototype,"inputFields",null),e([p()],S.prototype,"layer",null),e([p()],S.prototype,"messages",void 0),e([p()],S.prototype,"state",null),e([p()],S.prototype,"strict",void 0),e([p()],S.prototype,"title",null),e([p()],S.prototype,"valid",null),e([p()],S.prototype,"getValues",null),e([p()],S.prototype,"submit",null),S=e([m(C)],S);var I=S;export default I;
