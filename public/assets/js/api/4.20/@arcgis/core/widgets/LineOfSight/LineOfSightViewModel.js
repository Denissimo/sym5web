/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{L as e}from"../../chunks/Logger.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import{b as i,i as o,o as r,r as n,t as a,j as l,f as p,m as c}from"../../core/lang.js";import"../../chunks/ensureType.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import h from"../../Color.js";import m from"../../core/Collection.js";import d from"../../core/Handles.js";import{h as g,m as y}from"../../chunks/handleUtils.js";import{createTask as _,ignoreAbortErrors as j}from"../../core/promiseUtils.js";import v,{e as b,r as f}from"../../core/Accessor.js";import{j as k,d as C,f as S,n as O,g as w,b as T,s as L,v as I,X as E,T as V}from"../../chunks/mathUtils.js";import M from"../../geometry/Point.js";import{c as P,f as A}from"../../chunks/lineSegment.js";import{s as R}from"../../chunks/screenUtils.js";import{c as D,a as U,b as F}from"../../chunks/ray.js";import{c as x}from"../../chunks/vectorStacks.js";import{g as H}from"../../chunks/dehydratedFeatures.js";import{a as z}from"../../chunks/ray2.js";import{e as G}from"../../chunks/tileUtils.js";import{I as N}from"../../chunks/Intersector.js";import{t as B}from"../../chunks/intersectorUtilsConversions.js";import{a as W,M as q}from"../../chunks/manipulatorUtils.js";import{d as Q}from"../../chunks/manipulatorUtils2.js";import{G as J}from"../../chunks/ColorMaterial.js";import"../../chunks/RibbonLineMaterial.js";import"../../geometry.js";import{I as $,T as K}from"../../chunks/Scheduler.js";import{c as X}from"../../chunks/mat4f64.js";import{L as Z}from"../../chunks/LineVisualElement.js";import{L as Y}from"../../chunks/LaserlineVisualElement.js";import{I as tt,c as et}from"../../chunks/InteractiveToolBase.js";import st from"./LineOfSightTarget.js";import{c as it,r as ot}from"../../chunks/collectionUtils.js";import{I as rt}from"../../chunks/InteractiveToolViewModel.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import"../../chunks/Message.js";import"../../chunks/colorUtils.js";import"../../chunks/ArrayPool.js";import"../../chunks/Evented.js";import"../../core/scheduling.js";import"../../chunks/arrayUtils.js";import"../../core/Error.js";import"../../chunks/deprecate.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/write.js";import"../../geometry/SpatialReference.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../chunks/quatf64.js";import"../../chunks/vec2f64.js";import"../../chunks/vec4f64.js";import"../../chunks/byteSizeEstimations.js";import"../../chunks/uid.js";import"../../chunks/aaBoundingBox.js";import"../../geometry/Extent.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/quantizationUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../layers/support/Field.js";import"../../chunks/enumeration.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/vec2.js";import"../../chunks/mat4.js";import"../../chunks/vec4.js";import"../../chunks/boundedPlane.js";import"../../chunks/plane.js";import"../../chunks/sphere.js";import"../../chunks/Object3D.js";import"../../chunks/mathUtils2.js";import"../../chunks/utils4.js";import"../../chunks/Util.js";import"../../chunks/verticalOffsetUtils.js";import"../../chunks/mat3.js";import"../../chunks/quat.js";import"../../chunks/vec3f32.js";import"../../chunks/compilerUtils.js";import"../../geometry/projection.js";import"../../chunks/unitUtils.js";import"../../chunks/projectionEllipsoid.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/ElevationProvider.js";import"../../chunks/Camera.js";import"../../chunks/frustum.js";import"../../chunks/BufferView.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/types.js";import"../../chunks/VertexColor.glsl.js";import"../../chunks/Program.js";import"../../chunks/Texture.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/mat4f32.js";import"../../chunks/geometryDataUtils.js";import"../../chunks/triangle.js";import"../../chunks/elevationInfoUtils.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../layers/support/fieldUtils.js";import"../../chunks/arcadeOnDemand.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../chunks/locale.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../chunks/chartMediaInfoUtils.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../support/actions/ActionBase.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../portal/Portal.js";import"../../intl.js";import"../../chunks/Loadable.js";import"../../chunks/Promise.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../chunks/Thumbnail.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/PiUtils.glsl.js";import"../../core/watchUtils.js";import"../../chunks/PromiseQueue.js";import"../../chunks/vec4f32.js";import"../../chunks/Object3DVisualElement.js";import"../../chunks/VisualElement.js";import"../../chunks/lineUtils.js";import"../../chunks/triangulationUtils.js";import"../../chunks/earcut.js";import"../../chunks/deduplicate.js";import"../../chunks/MapUtils.js";import"../../chunks/vec2f32.js";import"../../chunks/FramebufferObject.js";import"../../chunks/glUtil.js";import"../../chunks/PhysicallyBasedRendering.glsl.js";import"../../chunks/CameraSpace.glsl.js";import"../../chunks/interactiveToolUtils.js";import"../../chunks/domUtils.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../../core/HandleOwner.js";import"../Popup.js";import"../../chunks/throttle.js";import"../Feature.js";import"../Widget.js";import"../../chunks/uuid.js";import"../../chunks/jsxWidgetSupport.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../chunks/messageBundle.js";import"../../chunks/jsxFactory.js";import"../Feature/FeatureViewModel.js";import"../../rest/support/Query.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/DataLayerSource.js";import"../../rest/support/StatisticDefinition.js";import"../../rest/support/RelationshipQuery.js";import"../../tasks/QueryTask.js";import"../../chunks/executeForTopCount.js";import"../../chunks/utils5.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../chunks/featureConversionUtils.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../tasks/Task.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../chunks/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/symbolConversion.js";import"../../chunks/commonProperties.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/support/elements.js";import"../../geometry/HeightModelInfo.js";import"../../layers/Layer.js";import"../../chunks/FeatureIndex.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/shared.js";import"../../chunks/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/BlendLayer.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/OperationalLayer.js";import"../../chunks/commonProperties2.js";import"../../chunks/ElevationInfo.js";import"../../chunks/PortalLayer.js";import"../../chunks/asyncUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../chunks/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../chunks/labelingInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/Heading.js";import"../support/widget.js";import"../../chunks/accessibleHandler.js";import"../../chunks/vmEvent.js";import"../Spinner/SpinnerViewModel.js";import"../../chunks/AnchorElementViewModel.js";import"../Popup/PopupViewModel.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils2.js";import"../../chunks/ItemCache.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils3.js";import"../../chunks/InputManager.js";import"../../chunks/Queue.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../../chunks/GoTo.js";let nt=class extends v{constructor(t){super(t)}initialize(){this._intersector=new N(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0}getScreenPointIntersection(t){const e=R(t,x.get()),s=z(this.view.state.camera,e,ct);return this._getRayIntersection(s)}_getRayIntersection(t){if(i(t))return null;this.view.sceneIntersectionHelper.intersectToolIntersectorRay(t,this._intersector);const e=this._intersector.results.min,s=at;if(!e||!e.getIntersectionPoint(s))return null;const r=this.view.renderCoordsHelper.fromRenderCoords(s,this.view.spatialReference),n=T();k(n,e.normal);const a=C(n,t.direction)>0?-1:1;S(n,n,a);const l=B(e,this.view);if(o(l)){const s=l.layer,i=l.sourceLayer;let o;if(i)switch(i.type){case"scene":o=H(l,i.objectIdField);break;case"integrated-mesh":{const t=e.target;o=`${t.metadata.nodeIndex}/${t.metadata.componentIndex}`;break}default:o=l.uid}else o=l.uid;return{type:"Graphic",id:`${s.uid}/${o}`,ray:U(t),normal:n,point:r}}if("TerrainRenderer"===e.intersector){return{type:"Terrain",id:e.target.metadata.tile.lij.slice(),ray:U(t),normal:n,point:r}}return null}_canUpdateFromIntersectionResult(t,e){if(i(t)||!e||t.type!==e.type)return!1;switch(t.type){case"Terrain":{const s=t.id,i=e.id;return s[0]===i[0]&&s[1]===i[1]&&s[2]===i[2]||G(s,i)}case"Graphic":case"I3S":return t.id===e.id}}updateFromIntersectionResult(t){let e;if("Terrain"===t.type&&o(t.point)){const s=at,i=lt,o=pt;this.view.renderCoordsHelper.toRenderCoords(t.point,i),this.view.renderCoordsHelper.worldUpAtPosition(i,o);const r=this.view.basemapTerrain.elevationBounds,n=this.view.renderCoordsHelper.getAltitude(i),a=r?Math.abs(r.max-r.min)/Math.abs(n):100,l=n>0?1:-1;O(o,o),S(o,o,l*a),w(s,i,o),F(s,i,ct),e=this._getRayIntersection(ct)}else e=this._getRayIntersection(t.ray);return this._canUpdateFromIntersectionResult(e,t)?e.point:null}};t([s()],nt.prototype,"view",void 0),nt=t([u("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightRayIntersector")],nt);const at=T(),lt=T(),pt=T(),ct=D();let ut=class extends v{constructor(t){super(t),this.enabled=!0,this.glowColor=new h([255,127,0]),this.glowWidth=8,this.innerColor=new h([255,255,255]),this.innerWidth=.75,this.globalAlpha=.75}};t([s({type:Boolean})],ut.prototype,"enabled",void 0),t([s({type:h})],ut.prototype,"glowColor",void 0),t([s({type:Number})],ut.prototype,"glowWidth",void 0),t([s({type:h})],ut.prototype,"innerColor",void 0),t([s({type:Number})],ut.prototype,"innerWidth",void 0),t([s({type:Number})],ut.prototype,"globalAlpha",void 0),ut=t([u("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightLaserLineConfiguration")],ut);let ht=class extends v{constructor(t){super(t),this.size=.5,this.color=new h([255,127,0,.75])}};t([s({type:Number})],ht.prototype,"size",void 0),t([s({type:h})],ht.prototype,"color",void 0),ht=t([u("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightObserverConfiguration")],ht);let mt=class extends v{constructor(t){super(t),this.size=.5,this.visibleColor=new h([3,252,111,.75]),this.occludedColor=new h([252,3,69,.75]),this.undefinedColor=new h([127,127,127,.75])}};t([s({type:Number})],mt.prototype,"size",void 0),t([s({type:h})],mt.prototype,"visibleColor",void 0),t([s({type:h})],mt.prototype,"occludedColor",void 0),t([s({type:h})],mt.prototype,"undefinedColor",void 0),mt=t([u("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTargetConfiguration")],mt);class dt extends v{constructor(t){super(t),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new h([3,252,111,1]),this.visibleOuterColor=new h([3,252,111,.15]),this.occludedInnerColor=new h([252,3,69,1]),this.occludedOuterColor=new h([252,3,69,.1]),this.undefinedInnerColor=new h([255,255,255,1]),this.undefinedOuterColor=new h([127,127,127,.2])}}t([s({type:Number})],dt.prototype,"innerWidth",void 0),t([s({type:Number})],dt.prototype,"outerWidth",void 0),t([s({type:h})],dt.prototype,"visibleInnerColor",void 0),t([s({type:h})],dt.prototype,"visibleOuterColor",void 0),t([s({type:h})],dt.prototype,"occludedInnerColor",void 0),t([s({type:h})],dt.prototype,"occludedOuterColor",void 0),t([s({type:h})],dt.prototype,"undefinedInnerColor",void 0),t([s({type:h})],dt.prototype,"undefinedOuterColor",void 0);let gt=class extends v{constructor(t){super(t),this.laserLine=new ut,this.observer=new ht,this.target=new mt,this.lineOfSight=new dt}};function yt(t,e,s){return{geometry:J.createSphereGeometry(t,32,32),material:W(h.toUnitRGBA(e)),stateMask:s}}function _t(t){const e=[];return t.customColor1&&e.push(yt(t.size,t.customColor1,16)),t.customColor2&&e.push(yt(t.size,t.customColor2,32)),t.customColor3&&e.push(yt(t.size,t.customColor3,64)),t.color&&e.push(yt(t.size,t.color)),e}t([s({type:ut})],gt.prototype,"laserLine",void 0),t([s({type:ht})],gt.prototype,"observer",void 0),t([s({type:mt})],gt.prototype,"target",void 0),t([s({type:dt})],gt.prototype,"lineOfSight",void 0),gt=t([u("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightToolConfiguration")],gt);let jt=class extends v{constructor(t){super(t),this.inputPoints={isValid:!1,observer:T(),target:T(),observerAdjusted:T(),targetAdjusted:T()},this.computationResult={start:T(),end:T(),intersection:T(),isValid:!1,isTargetVisible:!1}}updateComputationResults(){this.notifyChange("computationResult")}updateInputPoints(){this.notifyChange("inputPoints")}};t([s()],jt.prototype,"target",void 0),t([s()],jt.prototype,"inputPoints",void 0),t([s()],jt.prototype,"computationResult",void 0),jt=t([u("esri.views.3d.interactive.graphics.LineOfSight.LineOfSightAnalysis")],jt);let vt=class extends v{constructor(t){super(t),this._tasks=$,this._handles=new d,this._analysisHandles=new d}initialize(){var t;const e=null==(t=this.view.resourceController)?void 0:t.scheduler;e&&(this._tasks=e.registerTask(K.LINE_OF_SIGHT_TOOL));this._handles.add([b((()=>this.model.observer),(t=>this._onObserverChange(t))),this._connectAnalyses(),this._connectTargets()]),this._intersector=new N(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0}destroy(){this._handles.destroy(),this._analysisHandles.destroy(),this._analyses.removeAll()}get updating(){return this._tasks.updating}get priority(){return this._tasks.priority}set priority(t){this._tasks.priority=t}get _viewData(){return this.model.viewData}get _analyses(){return this._viewData.analyses}get _observerEngineLocation(){return this._viewData.observerEngineLocation}set _observerEngineLocation(t){this._viewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}getLineOfSightComputationDependencies(t){const{inputPoints:e}=t;return{inputPoints:e}}computeAnalysis(t,e=!1){const{analysis:s}=t,{inputPoints:i,computationResult:o}=s,{observerAdjusted:r,targetAdjusted:n}=i,{start:a,end:l}=o;k(a,r),k(l,n);e||this._canComputeAnalysis(s)?this._computeAnalysisIntersection(t):this._interpolateAnalysisIntersection(t),s.updateComputationResults()}_adjustStartEndPositions(t){const e=this._screenPixelSize,s=this.view,{inputPoints:i}=t,{observer:o,target:r,observerAdjusted:n,targetAdjusted:a}=i,l=bt;L(l,r,o);const p=e;O(l,l),S(l,l,Math.min(p,1)),w(n,o,l),L(l,o,r);const c=s.state.camera.computeScreenPixelSizeAt(r);O(l,l),S(l,l,Math.min(c,1)),w(a,r,l)}_computeAnalysisIntersection({analysis:t,interpolationInfo:e}){const{view:s}=this,{sceneIntersectionHelper:o,renderCoordsHelper:r}=s;if(i(o))return;const n=this._intersector,{computationResult:a,inputPoints:l}=t,{observer:p,target:c}=l,{start:u,end:h}=a,m=F(u,h,ft);o.intersectToolIntersectorRay(m,n);const d=a.intersection,g=bt,y=!!n.results.min&&n.results.min.getIntersectionPoint(d);let _=!0;if(y){k(e.originalIntersection,d),k(e.originalObserver,u),k(e.originalTarget,h),r.fromRenderCoords(d,g,s.spatialReference);const t=1-I(h,c)/I(u,c);_=I(p,d)>=t*I(p,c)}const j=new M(g,s.spatialReference);t.target.intersectedLocation=_?null:j,t.target.intersectedGraphic=_?null:B(n.results.min,s),t.target.visible=!!y&&_,a.isValid=l.isValid=!0,a.isTargetVisible=_}_interpolateAnalysisIntersection({analysis:t,interpolationInfo:e}){const{computationResult:s,inputPoints:i,target:o}=t,{start:r,end:n,intersection:a}=s,{originalIntersection:l,originalObserver:p,originalTarget:c}=e;if(k(a,l),i.isValid){const t=bt,e=I(p,l)/I(p,c);E(t,r,p),S(t,t,1-e),w(a,a,t),E(t,n,c),S(t,t,e),w(a,a,t),s.isValid=!0}else o.intersectedLocation=null,o.intersectedGraphic=null,o.visible=void 0,s.isValid=!1,s.isTargetVisible=!1}_canComputeAnalysis(t){const e=this.model.observer,s=this.view.frustum;if(i(e)||i(t.target.location)||i(s))return!1;const{observerAdjusted:o,targetAdjusted:r}=t.inputPoints,n=s.intersectsPoint(o),a=s.intersectsPoint(r);return n&&a}_onObserverChange(t){if(i(t))return void this.model.targets.removeAll();const e=T();this.view.renderCoordsHelper.toRenderCoords(t,e),this._observerEngineLocation=e,this.priority=K.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverChangeForAnalysis(t){t.inputPoints.isValid=!1}_onObserverEngineForAnalysis(t,e){const{inputPoints:s}=t;k(s.observer,e),this._adjustStartEndPositions(t),t.updateInputPoints(),this.priority=K.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetLocationChange(t,e){const{inputPoints:s}=t;s.isValid=!1,this.view.renderCoordsHelper.toRenderCoords(e,s.target),this._adjustStartEndPositions(t),t.updateInputPoints(),this.priority=K.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectAnalysisToTarget(t){return b((()=>({analysis:t,targetLocation:t.target.location})),(({analysis:t,targetLocation:e})=>{o(e)&&this._onTargetLocationChange(t,e)}))}_connectAnalysisToObserver(t){return b((()=>({analysis:t,observer:this.model.observer})),(({analysis:t})=>{this._onObserverChangeForAnalysis(t)}))}_connectAnalysisToObserverEngine(t){return b((()=>({analysis:t,observer:this._observerEngineLocation})),(({analysis:t,observer:e})=>{this._onObserverEngineForAnalysis(t,e)}))}_connectAnalysisForCompute(t){let e=a;const s={analysis:t,interpolationInfo:{originalIntersection:T(),originalObserver:T(),originalTarget:T()}};return g([b((()=>this.getLineOfSightComputationDependencies(t)),(()=>{e=r(e),e=_((async t=>{await j(this._tasks.schedule((()=>this.computeAnalysis(s)),t))}))})),y((()=>e=r(e)))])}_connectAnalysis(t){const e=this._analysisHandles;e.has(t)||e.add([this._connectAnalysisToTarget(t),this._connectAnalysisToObserver(t),this._connectAnalysisToObserverEngine(t),this._connectAnalysisForCompute(t)])}_disconnectAnalysis(t){this._analysisHandles.remove(t)}_onAnalysesCollectionChange(t){t.added.forEach((t=>this._connectAnalysis(t))),t.removed.forEach((t=>this._disconnectAnalysis(t)))}_onTargetsChange(t){this._analyses.removeAll(),t.items.length>0&&this._onTargetCollectionChange({target:t,added:t.items,removed:[],moved:[]})}_onTargetCollectionChange(t){const e=this._analyses;t.added.forEach((t=>{e.some((e=>e.target===t))||e.add(new jt({target:t}))})),t.removed.forEach((t=>{const s=e.find((e=>e.target===t));e.remove(s)}))}_connectAnalyses(){let t=null;return g([b((()=>this._analyses),(e=>{t=n(t),t=e.on("change",(t=>this._onAnalysesCollectionChange(t))),this._onAnalysesCollectionChange({target:e,added:e.items,removed:[],moved:[]})})),y((()=>t=n(t)))])}_connectTargets(){let t=null;return g([b((()=>this.model.targets),(e=>{t=n(t),t=e.on("change",(t=>this._onTargetCollectionChange(t))),this._onTargetsChange(e)})),y((()=>t=n(t)))])}};t([s()],vt.prototype,"model",void 0),t([s()],vt.prototype,"view",void 0),t([s()],vt.prototype,"updating",null),t([s()],vt.prototype,"priority",null),t([s()],vt.prototype,"_viewData",null),t([s()],vt.prototype,"_analyses",null),t([s()],vt.prototype,"_observerEngineLocation",null),t([s()],vt.prototype,"_screenPixelSize",null),t([s()],vt.prototype,"_tasks",void 0),vt=t([u("esri.views.3d.interactive.graphics.LineOfSight.LineOfSightController")],vt);const bt=T(),ft=D();let kt=class extends v{constructor(t){super(t),this._handle=null,this._analysisHandles=new d,this._lineOfSightVisualizations=[]}initialize(){this._handle=this._connectAnalyses()}destroy(){this._handle=n(this._handle),this._analysisHandles=l(this._analysisHandles)}get _viewData(){return this.model.viewData}get _analyses(){return this._viewData.analyses}get _configuration(){return this._viewData.configuration.lineOfSight}createLineOfSightVisualization(){const t=this._configuration,e=this.view,s={visibleLineVisualElement:new Z({view:e,attached:!0,width:t.outerWidth,color:h.toUnitRGBA(t.visibleOuterColor),innerWidth:t.innerWidth,innerColor:h.toUnitRGBA(t.visibleInnerColor)}),occludedLineVisualElement:new Z({view:e,attached:!0,width:t.outerWidth,color:h.toUnitRGBA(t.occludedOuterColor),innerWidth:t.innerWidth,innerColor:h.toUnitRGBA(t.occludedInnerColor)}),undefinedLineVisualElement:new Z({view:e,attached:!0,width:t.outerWidth,color:h.toUnitRGBA(t.undefinedOuterColor),innerWidth:t.innerWidth,innerColor:h.toUnitRGBA(t.undefinedInnerColor)})};return this._lineOfSightVisualizations.push(s),s}destroyLineOfSightVisualization(t){t.visibleLineVisualElement=l(t.visibleLineVisualElement),t.occludedLineVisualElement=l(t.occludedLineVisualElement),t.undefinedLineVisualElement=l(t.undefinedLineVisualElement),this._lineOfSightVisualizations.splice(this._lineOfSightVisualizations.indexOf(t),1)}updateLineOfSightVisualization(t,e){const s=this.model.visible,i=this._configuration,{computationResult:o,inputPoints:r}=t,{start:n,end:a,intersection:l,isValid:p,isTargetVisible:c}=o,{observer:u}=r,m=wt;m[12]=u[0],m[13]=u[1],m[14]=u[2];const d=L(Ct,n,u),g=L(St,a,u),y=L(Ot,l,u),{visibleLineVisualElement:_,occludedLineVisualElement:j,undefinedLineVisualElement:v}=e;_.geometry=null,j.geometry=null,v.geometry=null,p?c?(_.geometry=[[V(d),V(g)]],_.transform=m,_.color=h.toUnitRGBA(i.visibleOuterColor)):(_.geometry=[[V(d),V(y)]],_.transform=m,_.color=h.toUnitRGBA(i.occludedOuterColor),j.geometry=[[V(y),V(g)]],j.transform=m):(v.geometry=[[V(d),V(g)]],v.transform=m),_.visible=s,j.visible=s,v.visible=s}getLineOfSightVisualizationDependencies(t){const{computationResult:e}=t,{occludedOuterColor:s,visibleOuterColor:i}=this._configuration;return{computationResult:e,occludedOuterColor:s,visibleOuterColor:i,visible:this.model.visible}}testData(){return{visualizations:this._lineOfSightVisualizations}}_connectAnalysis(t){const e=this._analysisHandles;if(e.has(t))return;const s=this.createLineOfSightVisualization();e.add([b((()=>this.getLineOfSightVisualizationDependencies(t)),(()=>this.updateLineOfSightVisualization(t,s))),y((()=>this.destroyLineOfSightVisualization(s)))])}_disconnectAnalysis(t){this._analysisHandles.remove(t)}_connectAnalyses(){let t=null;return g([b((()=>this._analyses),(e=>{t=n(t),t=e.on("change",(t=>this._onAnalysesCollectionChange(t))),this._onAnalysesCollectionChange({target:e,added:e.items,removed:[],moved:[]})})),y((()=>t=n(t)))])}_onAnalysesCollectionChange(t){t.added.forEach((t=>this._connectAnalysis(t))),t.removed.forEach((t=>this._disconnectAnalysis(t)))}};t([s({constructOnly:!0})],kt.prototype,"model",void 0),t([s({constructOnly:!0})],kt.prototype,"view",void 0),t([s()],kt.prototype,"_viewData",null),t([s()],kt.prototype,"_analyses",null),t([s()],kt.prototype,"_configuration",null),kt=t([u("esri.views.3d.interactive.graphics.LineOfSight.LineOfSightView")],kt);const Ct=T(),St=T(),Ot=T(),wt=X(),Tt=m.ofType(st);let Lt=class extends tt{constructor(t){super(t),this._showTracker=!0,this._someManipulatorsFocused=!1,this._tasks=$,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._handles=new d,this._manipulatorHandles=new d,this._analysisHandles=new d,this.lineOfSightView=new kt({model:t.model,view:t.view}),this.lineOfSightController=new vt({model:t.model,view:t.view})}initialize(){var t;const e=b((()=>this.state),(t=>{switch(t){case"created":this.complete();break;default:this.finishToolCreation()}}));this._intersector=new nt({view:this.view});const s=this._handles,i=null==(t=this.view.resourceController)?void 0:t.scheduler;i&&(this._tasks=i.registerTask(K.LINE_OF_SIGHT_TOOL)),this._observerManipulator=this._createObserverManipulator(),s.add([e,f((()=>({...this.configuration.observer})),(()=>this._updateObserverManipulatorStyle())),this._createLineOfSightTracker(),b((()=>this.model.observer),(t=>this._onObserverChange(t))),b((()=>({...this.configuration.laserLine})),(()=>this._createVisualElements())),this._connectAnalyses()]),p(this.view.pointsOfInterest,(t=>s.add(this._connectObserverToContentChange(t)))),this.continue()}destroy(){this.detach(),this.manipulators.remove(this._observerManipulator),this.lineOfSightView.destroy(),this.lineOfSightController.destroy(),this._handles=l(this._handles),this._analysisHandles=l(this._analysisHandles),this._manipulatorHandles=l(this._manipulatorHandles),this._removeVisualElements(),this._intersector=null,this._set("model",null)}get state(){return this._showTracker?"creating":o(this.model.observer)?"created":"ready"}get cursor(){return this._someManipulatorsFocused?null:this._showTracker?"crosshair":null}get isSupported(){var t;return"3d"===(null==(t=this.view)?void 0:t.type)}get updating(){return c(this._tasks,!1,(t=>t.updating))||c(this.lineOfSightController,!1,(t=>t.updating))}get configuration(){return this._viewData.configuration}set configuration(t){this._viewData.configuration=t}get _viewData(){return this.model.viewData}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}get _analyses(){return this._viewData.analyses}get _observerEngineLocation(){return this._viewData.observerEngineLocation}set _observerEngineLocation(t){this._viewData.observerEngineLocation=t}get _shouldRenderTracker(){return this._showTracker&&o(this.model.observer)&&!this._someManipulatorsFocused}get _isCameraDirty(){const t=this.model.observer,{view:e}=this,{renderCoordsHelper:s}=e;if(i(t)||i(s))return!1;const o=It;s.toRenderCoords(t,o);const r=e.state.camera.computeScreenPixelSizeAt(o);return Math.abs((r-this._screenPixelSize)/this._screenPixelSize)>.1}continue(){this.view.activeTool=this,this._showTracker=!0,this._manipulatorFocusChanged()}stop(){this._showTracker=!1,this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._manipulatorFocusChanged()}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"key-down":this._keyDownHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){switch(t.type){case"immediate-click":this._clickHandler(t)}}onShow(){this.model.visible=!0}onHide(){this.model.visible=!1}_setPriority(t){this._tasks.priority=t,this.lineOfSightController.priority=t}_createLineOfSightTracker(){const t=new st({location:new M}),e=new jt({target:t}),s=this._createTargetManipulator(e);s.available=!1,s.interactive=!1;const i=this.lineOfSightView.createLineOfSightVisualization(),o={analysis:e,interpolationInfo:{originalIntersection:T(),originalObserver:T(),originalTarget:T()}};let r=null;const a=b((()=>this._shouldRenderTracker),(t=>{r=n(r),i.visibleLineVisualElement.attached=t,i.occludedLineVisualElement.attached=t,i.undefinedLineVisualElement.attached=t,t&&(r=g([f((()=>({...this.configuration.target})),(()=>this._updateTargetManipularStyle(s))),b((()=>this._observerEngineLocation),(t=>this._onObserverEngineLocationChange(s,t))),b((()=>this.lineOfSightController.getLineOfSightComputationDependencies(e)),(()=>this.lineOfSightController.computeAnalysis(o,!0))),b((()=>this.lineOfSightView.getLineOfSightVisualizationDependencies(e)),(()=>this.lineOfSightView.updateLineOfSightVisualization(e,i))),b((()=>this._getLineOfSightManipulatorStateDependencies(e)),(()=>this._updateManipulatorState(s))),f((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:t})=>this._onCameraChange(s,t))),f((()=>c(this.view.map,1,(t=>t.ground.opacity))),((t,e)=>this._onGroundOpacityChange(s,t,e))),b((()=>this.view.slicePlane),(()=>this._onSlicePlaneChange(s))),f((()=>e.target.location),(t=>this._onTargetLocationChange(s,t)))]))}));return this._trackerManipulator=s,y((()=>{a.remove(),r=n(r),this.lineOfSightView.destroyLineOfSightVisualization(i),this._removeManipulator(s)}))}_removeManipulator(t){this.manipulators.remove(t),this._manipulatorHandles.remove(t),t.metadata=null}_createManipulator(t,e,s){const i=function(t,e){const s=_t(e),i=new q({view:t,renderObjects:s,elevationInfo:{mode:"absolute-height",offset:0}});Q(i);for(const t in e)i[t]=e[t];return i}(this.view,t);return i.metadata=s,this._manipulatorHandles.add([e(i),i.events.on("focus-changed",(()=>this._manipulatorFocusChanged())),i.events.on("grab-changed",(t=>this._manipulatorGrabChanged(i,t))),i.events.on("immediate-click",(t=>t.stopPropagation()))],i),this.manipulators.add(i),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE),i}_createTargetManipulator(t,e,s){const i=this.configuration,o={size:i.target.size,customColor1:i.target.visibleColor,customColor2:i.target.occludedColor,customColor3:i.target.undefinedColor},r=this._createManipulator(o,(t=>this._createTargetManipulatorDragPipeline(t)),{analysis:t,intersection:s});return this._setTargetManipulatorLocation(r,e),r}_createObserverManipulator(){const t=this.configuration,e={size:t.observer.size,color:t.observer.color,visible:!0};return this._createManipulator(e,(t=>this._createObserverManipulatorDragPipeline(t)),null)}_updateTargetManipularStyle(t){const e=this.configuration.target,s={size:e.size,customColor1:e.visibleColor,customColor2:e.occludedColor,customColor3:e.undefinedColor};t.renderObjects=_t(s)}_updateObserverManipulatorStyle(){const t=this._observerManipulator,e=this.configuration.observer,s={size:e.size,color:e.color,visible:t.available};t.renderObjects=_t(s)}_manipulatorFocusChanged(){this._someManipulatorsFocused=this.manipulators.some((t=>t.manipulator.focused)),this._updateLaserLineRenderer()}_screenToIntersection(){return t=>{const e=this._intersector.getScreenPointIntersection(t.screenEnd);return i(e)?null:{...t,intersection:e}}}_createTargetManipulatorDragPipeline(t){return et(t,((e,s,i)=>{s.next(this._screenToIntersection()).next(this._updateAnalysisDragStep(t)).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelAnalysisDragStep(t)).next((()=>this._updateLaserLineRenderer()))}))}_createObserverManipulatorDragPipeline(t){return et(t,((t,e,s)=>{e.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),s.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return t=>(this.model.observer=t.intersection.point,this._observerManipulator.metadata=t.intersection,t)}_cancelObserverDragStep(){const t=o(this.model.observer)?this.model.observer.clone():null,e=this._observerManipulator.metadata;return s=>(this.model.observer=t,this._observerManipulator.metadata=e,s)}_updateAnalysisDragStep(t){return e=>(t.metadata.analysis.target.location=e.intersection.point,t.metadata.intersection=e.intersection,e)}_cancelAnalysisDragStep(t){const{metadata:e}=t,{analysis:s,intersection:i}=e,o=c(s.target.location,null,(t=>t.clone())),r=i;return e=>(s.target.location=o,t.metadata.intersection=r,e)}_manipulatorGrabChanged(t,e){switch(e.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}this._manipulatorFocusChanged()}_updateManipulatorState(t){const e=t.metadata.analysis,{isValid:s,isTargetVisible:i}=e.computationResult;t.state=s?i?16:32:64}_getLineOfSightManipulatorStateDependencies(t){const{isValid:e,isTargetVisible:s}=t.computationResult;return{isValid:e,isTargetVisible:s}}_setTargetManipulatorLocation(t,e){i(e)||(t.location=e,this._onTargetManipulatorLocationChange(t))}_updateLaserLineRenderer(){if(i(this._laserlineVisualElement))return;const t=this._laserlineVisualElement,e=o(this._grabbedManipulator)?this._grabbedManipulator:this._shouldRenderTracker&&this.model.observer?this._trackerManipulator:null;this.configuration.laserLine.enabled&&o(e)?(t.heightManifoldTarget=e.renderLocation,e!==this._observerManipulator?t.lineVerticalPlaneSegment=A(this._observerManipulator.renderLocation,e.renderLocation,Et):t.lineVerticalPlaneSegment=null):(t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)}_createVisualElements(){const t=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new Y({view:this.view,attached:!0,style:{glowColor:h.toUnitRGB(t.glowColor),glowWidth:t.glowWidth,innerColor:h.toUnitRGB(t.innerColor),innerWidth:t.innerWidth,globalAlpha:t.globalAlpha}}),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_removeVisualElements(){o(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverChange(t){i(t)?this._observerManipulator.available=!1:(this._observerManipulator.metadata=null,this._observerManipulator.available=!0,this._observerManipulator.location=t,this._setTargetManipulatorLocation(this._trackerManipulator,t),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_onTargetLocationChange(t,e){t.metadata.intersection=null,this._setTargetManipulatorLocation(t,e),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onGroundOpacityChange(t,e,s){1!==e&&1!==s||e===s||(this._onTargetManipulatorLocationChange(t),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_onCameraChange(t,e){const{analysis:s}=t.metadata;s.inputPoints.isValid&&!e||(this._onTargetManipulatorLocationChange(t),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_onSlicePlaneChange(t){this._onTargetManipulatorLocationChange(t),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onObserverEngineLocationChange(t,e){const{analysis:s}=t.metadata,{inputPoints:i}=s,{observer:o}=i;k(o,e),this._adjustInputPoints(i,this._observerManipulator.metadata,t.metadata.intersection),s.updateInputPoints()}_onTargetManipulatorLocationChange(t){const e=this.view.renderCoordsHelper;if(i(e))return;const{metadata:s}=t,{analysis:o,intersection:r}=s,{inputPoints:n}=o,{target:a}=n;e.toRenderCoords(t.location,a),this._adjustInputPoints(n,this._observerManipulator.metadata,r),o.updateInputPoints()}_onAnalysesCollectionChange(t){t.added.forEach((t=>this._connectAnalysis(t))),t.removed.forEach((t=>this._disconnectAnalysis(t)))}_addPointFromClickEvent(t){const e=this._intersector.getScreenPointIntersection(t);if(!i(e)&&!i(e.point))if(this.model.observer){const t=new st({location:e.point}),s=new jt({target:t});this._connectAnalysis(s,e),this._analyses.add(s),this.model.targets.add(t)}else this.model.observer=e.point,this._observerManipulator.metadata=e}_clickHandler(t){this._showTracker&&(this._addPointFromClickEvent({x:t.x,y:t.y}),t.stopPropagation())}_doubleClickHandler(t){this._showTracker&&(this.stop(),t.stopPropagation())}_keyDownHandler(t){this._showTracker&&"Escape"===t.key&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(!this._showTracker)return;const e={x:t.x,y:t.y},s=this._intersector.getScreenPointIntersection(e);o(s)&&(this._setTargetManipulatorLocation(this._trackerManipulator,s.point),this._updateLaserLineRenderer(),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_refineObserverManipulatorPosition(){const t=this._observerManipulator,e=t.metadata;if(this._analyses.length<1||i(e))return;const s=this._intersector.updateFromIntersectionResult(e);if(i(s))return;t.location=s;const o=T();this.view.renderCoordsHelper.toRenderCoords(t.location,o),this._observerEngineLocation=o}_refineTargetManipulatorPosition(t){const{intersection:e}=t.metadata;if(i(e))return;const s=this._intersector.updateFromIntersectionResult(e);this._setTargetManipulatorLocation(t,s)}_adjustInputPoints(t,e,s){const i=It,{observer:r,target:n,observerAdjusted:a,targetAdjusted:l}=t;o(e)?k(i,e.normal):L(i,n,r);const p=this._screenPixelSize;O(i,i),S(i,i,Math.min(p,1)),w(a,r,i),o(s)?k(i,s.normal):L(i,r,n);const c=this.view.state.camera.computeScreenPixelSizeAt(n);O(i,i),S(i,i,Math.min(c,1)),w(l,n,i)}_connectAnalyses(){let t=null;return g([b((()=>this._analyses),(e=>{t=n(t),t=e.on("change",(t=>this._onAnalysesCollectionChange(t))),this._onAnalysesCollectionChange({target:e,added:e.items,removed:[],moved:[]})})),y((()=>t=n(t)))])}_connectAnalysis(t,e){const s=this._analysisHandles;if(s.has(t))return;const{target:i}=t,o=this._createTargetManipulator(t,i.location,e),r=[b((()=>this._getLineOfSightManipulatorStateDependencies(t)),(()=>this._updateManipulatorState(o))),b((()=>this._observerEngineLocation),(t=>this._onObserverEngineLocationChange(o,t))),f((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:t})=>this._onCameraChange(o,t))),f((()=>c(this.view.map,1,(t=>t.ground.opacity))),((t,e)=>this._onGroundOpacityChange(o,t,e))),b((()=>this.view.slicePlane),(()=>this._onSlicePlaneChange(o))),f((()=>t.target.location),(t=>this._onTargetLocationChange(o,t))),f((()=>({...this.configuration.target})),(()=>this._updateTargetManipularStyle(o))),y((()=>{this._removeManipulator(o)}))];p(this.view.pointsOfInterest,(t=>r.push(this._connectTargetToContentChange(o,t)))),s.add(r,t),this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_disconnectAnalysis(t){this._analysisHandles.remove(t)}_connectObserverToContentChange(t){let e=a;const s=()=>{e=r(e),i(this._observerManipulator.metadata)||(e=_((async t=>{this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE),await j(this._tasks.schedule((()=>this._refineObserverManipulatorPosition()),t))})))},o=t.contentGeometryUpdates.events.on("request-update",s),n=this.view.elevationProvider.on("elevation-change",s);return y((()=>{e=r(e),o.remove(),n.remove()}))}_connectTargetToContentChange(t,e){let s=a;const i=()=>{s=r(s),s=_((async e=>{this._setPriority(K.LINE_OF_SIGHT_TOOL_INTERACTIVE),await j(this._tasks.schedule((()=>{this._refineTargetManipulatorPosition(t),this._onTargetManipulatorLocationChange(t)}),e))}))},o=e.contentGeometryUpdates.events.on("request-update",i),n=this.view.elevationProvider.on("elevation-change",i);return y((()=>{s=r(s),o.remove(),n.remove()}))}};t([s({constructOnly:!0})],Lt.prototype,"view",void 0),t([s({constructOnly:!0})],Lt.prototype,"model",void 0),t([s({constructOnly:!0})],Lt.prototype,"lineOfSightView",void 0),t([s({constructOnly:!0})],Lt.prototype,"lineOfSightController",void 0),t([s({readOnly:!0})],Lt.prototype,"state",null),t([s({readOnly:!0})],Lt.prototype,"cursor",null),t([s({readOnly:!0})],Lt.prototype,"isSupported",null),t([s({readOnly:!0})],Lt.prototype,"updating",null),t([s({type:gt})],Lt.prototype,"configuration",null),t([s()],Lt.prototype,"_viewData",null),t([s()],Lt.prototype,"_screenPixelSize",null),t([s()],Lt.prototype,"_showTracker",void 0),t([s()],Lt.prototype,"_analyses",null),t([s()],Lt.prototype,"_observerEngineLocation",null),t([s()],Lt.prototype,"_shouldRenderTracker",null),t([s()],Lt.prototype,"_someManipulatorsFocused",void 0),t([s()],Lt.prototype,"_isCameraDirty",null),t([s()],Lt.prototype,"_tasks",void 0),t([s()],Lt.prototype,"_laserlineVisualElement",void 0),t([s()],Lt.prototype,"_grabbedManipulator",void 0),Lt=t([u("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],Lt);const It=T(),Et=P();let Vt=class extends v{constructor(){super(...arguments),this.analyses=new m,this.configuration=new gt,this.observerEngineLocation=T()}};t([s()],Vt.prototype,"analyses",void 0),t([s({type:gt})],Vt.prototype,"configuration",void 0),t([s()],Vt.prototype,"observerEngineLocation",void 0),Vt=t([u("esri.views.3d.interactive.graphics.LineOfSight.LineOfSightViewData")],Vt);let Mt=class extends v{constructor(t){super(t),this.observer=null,this.viewData=new Vt,this.visible=!0}get targets(){return this._get("targets")||new Tt}set targets(t){this._set("targets",ot(t,this.targets,Tt))}};t([s()],Mt.prototype,"observer",void 0),t([s({type:Tt,cast:it,nonNullable:!0})],Mt.prototype,"targets",null),t([s()],Mt.prototype,"viewData",void 0),t([s()],Mt.prototype,"visible",void 0),Mt=t([u("esri.views.3d.interactive.graphics.LineOfSight.LineOfSight")],Mt);const Pt=e.getLogger("esri.widgets.LineOfSight.LineOfSightViewModel");let At=class extends rt{constructor(t){super(t),this.supportedViewType="3d",this.model=new Mt,this.observer=null,this.targets=new Tt}get state(){return this.isDisabled?"disabled":this.tool?this.tool.state:"ready"}start(){return this.createTool()}clear(){this.removeTool(),this.observer=null,this.targets.removeAll()}continue(){this.tool&&this.tool.continue()}stop(){this.tool&&this.tool.stop()}createToolParams(){return{toolConstructor:Lt,constructorArguments:()=>({model:this.model})}}logUnsupportedError(){this.logError("LineOfSight widget is not implemented for MapView")}logError(...t){Pt.error(...t)}};t([s({readOnly:!0})],At.prototype,"state",null),t([s()],At.prototype,"model",void 0),t([s()],At.prototype,"tool",void 0),t([s({aliasOf:"model.observer"})],At.prototype,"observer",void 0),t([s({aliasOf:"model.targets"})],At.prototype,"targets",void 0),At=t([u("esri.widgets.lineOfSight.LineOfSightViewModel")],At);var Rt=At;export default Rt;
