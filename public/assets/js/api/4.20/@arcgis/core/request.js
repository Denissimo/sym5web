/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"./config.js";import{id as t}from"./kernel.js";import r from"./core/Error.js";import{i as s,h as n,clone as o,g as a,u as i}from"./core/lang.js";import{isAborted as l,createAbortController as c,onAbort as u,isAbortError as d,createAbortError as p}from"./core/promiseUtils.js";import{getOrigin as m,isDataProtocol as h,isBlobProtocol as f,normalize as w,getInterceptor as y,isTrustedServer as g,toHTTPS as b,addQueryParameter as q,objectToQuery as k,getProxyRule as T,getProxyUrl as v,addQueryParameters as O,hasSameOrigin as E,appUrl as x,addProxyRule as S}from"./core/urlUtils.js";import"./chunks/object.js";import"./chunks/Logger.js";import"./chunks/string.js";import"./chunks/Message.js";const L=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function C(e){const t=m(e,!0);return t&&t.endsWith(".arcgis.com")&&!L.includes(t)&&!e.endsWith("/sharing/rest/generateToken")}function j(e,t,r=!1,o){return new Promise(((a,i)=>{if(l(o))return void i(U());let c=()=>{p(),i(new Error(`Unable to load ${t}`))},u=()=>{const t=e;p(),a(t)},d=()=>{if(!e)return;const t=e;p(),t.src="",i(U())};const p=()=>{n("esri-image-decode")||(e.removeEventListener("error",c),e.removeEventListener("load",u)),c=null,u=null,e=null,s(o)&&o.removeEventListener("abort",d),d=null,r&&URL.revokeObjectURL(t)};s(o)&&o.addEventListener("abort",d),n("esri-image-decode")?e.decode().then(u,c):(e.addEventListener("error",c),e.addEventListener("load",u))}))}function U(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}async function _(s,o){const d=h(s),p=f(s);p||d||(s=w(s));const b={url:s,requestOptions:{...i(o)}};let q=y(s);if(q){const e=await async function(e,t){if(null!=e.responseData)return e.responseData;e.headers&&(t.requestOptions.headers={...t.requestOptions.headers,...e.headers});e.query&&(t.requestOptions.query={...t.requestOptions.query,...e.query});if(e.before){let s,n;try{n=await e.before(t)}catch(e){s=N("request:interceptor",e,t)}if((n instanceof Error||n instanceof r)&&(s=N("request:interceptor",n,t)),s)throw e.error&&e.error(s),s;return n}}(q,b);if(null!=e)return{data:e,getHeader:A,requestOptions:b.requestOptions,url:b.url};q.after||q.error||(q=null)}if(s=b.url,"image"===(o=b.requestOptions).responseType){if(n("host-webworker")||n("host-node"))throw N("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),b)}else if(d)throw N("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+o.responseType),b);if("head"===o.method){if(o.body)throw N("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),b);if(d||p)throw N("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),b)}if(await async function(){n("host-webworker")?P||(P=await import("./chunks/request.js")):_._abortableFetch||(_._abortableFetch=a.fetch.bind(a))}(),P)return P.execute(s,o);const k=c();u(o,(()=>k.abort()));const T={controller:k,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:q,params:b,redoRequest:!1,useIdentity:D.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},v=await async function(r){var s,n;let o,i;await async function(r){const s=r.params.url,n=r.params.requestOptions,o=r.controller.signal,i=n.body;let c=null,u=null,d=null;M&&"HTMLFormElement"in a&&(i instanceof FormData?c=i:i instanceof HTMLFormElement&&(u=i,c=new FormData(u)));"string"==typeof i&&(d=i);r.fetchOptions={cache:n.cacheBust&&!_._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:n.headers||{},method:"head"===n.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:o},(c||d)&&(r.fetchOptions.body=c||d);"anonymous"===n.authMode&&(r.useIdentity=!1);r.hasToken=!!(/token=/i.test(s)||n.query&&n.query.token||c&&c.get&&c.get("token")||u&&u.elements.token),!r.hasToken&&e.apiKey&&C(s)&&(n.query||(n.query={}),n.query.token=e.apiKey,r.hasToken=!0);if(r.useIdentity&&!r.hasToken&&!r.credentialToken&&!W(s)&&!l(o)){let e;"immediate"===n.authMode?(await $(),e=await t.getCredential(s,{signal:o}),r.credential=e):"no-prompt"===n.authMode?(await $(),e=await t.getCredential(s,{prompt:!1,signal:o}).catch((()=>{})),r.credential=e):t&&(e=t.findCredential(s)),e&&(r.credentialToken=e.token,r.useSSL=!!e.ssl)}}(r);try{do{[o,i]=await z(r)}while(!await K(r,o,i))}catch(e){const t=N("request:server",e,r.params,o);throw t.details.ssl=r.useSSL,r.interceptor&&r.interceptor.error&&r.interceptor.error(t),t}const c=r.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(c)&&!r.hasToken&&!r.credentialToken&&null!=(s=i)&&null!=(n=s.user)&&n.username&&!g(c)){const e=m(c,!0);e&&D.trustedServers.push(e)}const u=r.credential;if(u&&t){const e=t.findServerInfo(u.server);let r=e&&e.owningSystemUrl;if(r){r=r.replace(/\/?$/,"/sharing");const e=t.findCredential(r,u.userId);e&&-1===t._getIdenticalSvcIdx(r,e)&&e.resources.unshift(r)}}return{data:i,getHeader:o?e=>o.headers.get(e):A,requestOptions:r.params.requestOptions,ssl:r.useSSL,url:r.params.url}}(T);return q&&q.after&&q.after(v),v}let P;const D=e.request,M="FormData"in a,R=[499,498,403,401],F=["COM_0056","COM_0057","SB_0008"],I=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],A=()=>null,H=Symbol();function B(e){const t=m(e);return!t||t.endsWith(".arcgis.com")||_._corsServers.includes(t)||g(t)}function N(e,t,s,n){let a="Error";const i={url:s.url,requestOptions:s.requestOptions,getHeader:A,ssl:!1};if(t instanceof r)return t.details?(t.details=o(t.details),t.details.url=s.url,t.details.requestOptions=s.requestOptions):t.details=i,t;if(t){const e=n&&(e=>n.headers.get(e)),r=n&&n.status,s=t.message;s&&(a=s),e&&(i.getHeader=e),i.httpStatus=(null!=t.httpCode?t.httpCode:t.code)||r||0,i.subCode=t.subcode,i.messageCode=t.messageCode,"string"==typeof t.details?i.messages=[t.details]:i.messages=t.details,i.raw=H in t?t[H]:t}return d(t)?p():new r(e,a,i)}async function $(){t||await import("./identity/IdentityManager.js")}function W(e){return I.some((t=>t.test(e)))}async function z(e){let r=e.params.url;const s=e.params.requestOptions,o=e.fetchOptions,a=f(r)||h(r),i=s.responseType||"json",l=a?0:null!=s.timeout?s.timeout:D.timeout;let c=!1;if(!a){e.useSSL&&(r=b(r)),s.cacheBust&&"default"===o.cache&&(r=q(r,"request.preventCache",Date.now()));let a={...s.query};e.credentialToken&&(a.token=e.credentialToken);let i=k(a);n("esri-url-encodes-apostrophe")&&(i=i.replace(/'/g,"%27"));const l=r.length+1+i.length;let u;c="delete"===s.method||"post"===s.method||"put"===s.method||!!s.body||l>D.maxUrlLength;const d=s.useProxy||!!T(r);if(d){const e=v(r);u=e.path,!c&&u.length+1+l>D.maxUrlLength&&(c=!0),e.query&&(a={...e.query,...a})}if("HEAD"===o.method&&(c||d)){if(c){if(l>D.maxUrlLength)throw N("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw N("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(d)throw N("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(c?(o.method="delete"===s.method?"DELETE":"put"===s.method?"PUT":"POST",s.body?r=O(r,a):(o.body=k(a),o.headers["Content-Type"]="application/x-www-form-urlencoded")):r=O(r,a),d&&(e.useProxy=!0,r=`${u}?${r}`),a.token&&M&&o.body instanceof FormData){const e=o.body;e.set?e.set("token",a.token):e.append("token",a.token)}if(s.hasOwnProperty("withCredentials"))e.withCredentials=s.withCredentials;else if(!E(r,x))if(g(r))e.withCredentials=!0;else if(t){const s=t.findServerInfo(r);s&&s.webTierAuth&&(e.withCredentials=!0)}e.withCredentials&&(o.credentials="include")}let u,d,w=0,y=!1;l>0&&(w=setTimeout((()=>{y=!0,e.controller.abort()}),l));try{if("native-request-init"===s.responseType)d=o,d.url=r;else if("image"!==s.responseType||"default"!==o.cache||"GET"!==o.method||c||function(e){if(e)for(const t of Object.getOwnPropertyNames(e))if(e[t])return!0;return!1}(s.headers)||!a&&!e.useProxy&&D.proxyUrl&&!B(r)){if(u=await _._abortableFetch(r,o),e.useProxy||function(e){const t=m(e);t&&!_._corsServers.includes(t)&&_._corsServers.push(t)}(r),"native"===s.responseType)d=u;else if("HEAD"!==o.method)if(u.ok){switch(i){case"array-buffer":d=await u.arrayBuffer();break;case"blob":case"image":d=await u.blob();break;default:d=await u.text()}if(w&&(clearTimeout(w),w=0),"json"===i||"xml"===i||"document"===i)if(d)switch(i){case"json":d=JSON.parse(d);break;case"xml":d=G(d,"application/xml");break;case"document":d=G(d,"text/html")}else d=null;if(d){if("array-buffer"===i||"blob"===i){const e=u.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(e)&&d["blob"===i?"size":"byteLength"]<=750)try{const e=await new Response(d).json();e.error&&(d=e)}catch{}}"image"===i&&d instanceof Blob&&(d=await J(URL.createObjectURL(d),e,!0))}}else d=await u.text()}else d=await J(r,e)}catch(t){if("AbortError"===t.name){if(y)throw new Error("Timeout exceeded");throw p("Request canceled")}if(!(!u&&t instanceof TypeError&&D.proxyUrl)||s.body||"delete"===s.method||"head"===s.method||"post"===s.method||"put"===s.method||e.useProxy||B(r))throw t;e.redoRequest=!0,S({proxyUrl:D.proxyUrl,urlPrefix:m(r)})}finally{w&&clearTimeout(w)}return[u,d]}function G(e,t){let r;try{r=(new DOMParser).parseFromString(e,t)}catch{}if(!r||r.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return r}async function K(e,r,s){if(e.redoRequest)return e.redoRequest=!1,!1;const n=e.params.requestOptions;if(!r||"native"===n.responseType||"native-request-init"===n.responseType)return!0;let o,a,i,l;if(!r.ok)throw o=new Error(`Unable to load ${r.url} status: ${r.status}`),o[H]=s,o;null!=s&&s.error&&(o=s.error),o&&(a=Number(o.code),i=o.hasOwnProperty("subcode")?Number(o.subcode):null,l=o.messageCode,l=l&&l.toUpperCase());const c=n.authMode;if(403===a&&(4===i||o.message&&o.message.toLowerCase().indexOf("ssl")>-1&&-1===o.message.toLowerCase().indexOf("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==c||498===a)&&-1!==R.indexOf(a)&&!W(e.params.url)&&(403!==a||-1===F.indexOf(l)&&(null==i||2===i&&e.credentialToken))){await $();try{const r=await t.getCredential(e.params.url,{error:N("request:server",o,e.params),prompt:"no-prompt"!==c,signal:e.controller.signal,token:e.credentialToken});return e.credential=r,e.credentialToken=r.token,e.useSSL=e.useSSL||r.ssl,!1}catch(t){if("no-prompt"===c)return e.credential=null,e.credentialToken=null,!1;o=t}}if(o)throw o;return!0}function J(e,t,r=!1){const s=t.controller.signal,n=new Image;return t.withCredentials?n.crossOrigin="use-credentials":n.crossOrigin="anonymous",n.alt="",n.src=e,j(n,e,r,s)}_._abortableFetch=null,_._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];var X=Object.freeze({__proto__:null,default:_});export default _;export{j as l,X as r,C as s};
