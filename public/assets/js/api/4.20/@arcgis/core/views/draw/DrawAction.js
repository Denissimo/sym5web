/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{E as t}from"../../chunks/Evented.js";import{i as s,b as i,o as r,d as o}from"../../core/lang.js";import{createTask as n}from"../../core/promiseUtils.js";import{c as a,b as c,p as l}from"../../chunks/screenUtils.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{L as h}from"../../chunks/Logger.js";import{subclass as m}from"../../core/accessorSupport/decorators/subclass.js";import u from"../../layers/GraphicsLayer.js";import{m as d}from"../../chunks/dehydratedFeatures.js";import"../../geometry.js";import y from"../../Graphic.js";import"../../symbols.js";import{h as g,m as f}from"../../chunks/handleUtils.js";import{b as _,a as j,i as v,p as x,d as b,g as V,e as S,j as k,q as P,c as C,l as D,h as w,s as G}from"../../chunks/vec2.js";import{a as I,b as M}from"../../chunks/vec2f64.js";import{b as L,J as R,D as z,p as E,d as O,q as U,a as T,n as H,g as A,f as Z,U as F,j as N,k as q}from"../../chunks/mathUtils.js";import B from"../../Color.js";import{d as Y}from"../../chunks/Settings.js";import X from"../../geometry/Point.js";import{g as Q}from"../../chunks/elevationInfoUtils.js";import W from"../../symbols/SimpleMarkerSymbol.js";import J from"../../symbols/SimpleLineSymbol.js";import K from"../../symbols/CIMSymbol.js";import $ from"../../geometry/Polyline.js";import{a as ee,V as te,A as se,E as ie,c as re,C as oe}from"../../chunks/AppendVertex.js";import{c as ne,r as ae,s as ce,a as le,y as pe,n as he}from"../../chunks/plane.js";import{e as me,p as ue}from"../../chunks/sphere.js";import{e as de}from"../../chunks/arrayUtils.js";import"../../core/Accessor.js";import"../../chunks/deprecate.js";import"../../chunks/metadata.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../core/Error.js";import"../../chunks/Message.js";import"../../chunks/object.js";import"../../config.js";import"../../chunks/string.js";import"../../layers/Layer.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/Identifiable.js";import"../../chunks/Loadable.js";import"../../chunks/Promise.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/write.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/BlendLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../chunks/GraphicsCollection.js";import"../../core/Collection.js";import"../../chunks/collectionUtils.js";import"../../chunks/ElevationInfo.js";import"../../layers/support/fieldUtils.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../chunks/enumeration.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/arcadeOnDemand.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/projectionEllipsoid.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../chunks/locale.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../chunks/chartMediaInfoUtils.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols/Symbol.js";import"../../chunks/colorUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../portal/Portal.js";import"../../intl.js";import"../../chunks/assets.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../chunks/Thumbnail.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/uid.js";import"../../chunks/byteSizeEstimations.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/quantizationUtils.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/vectorStacks.js";import"../../chunks/quatf64.js";import"../../chunks/mat4f64.js";import"../../chunks/mat4.js";import"../../chunks/ray.js";const ye={main:new B([255,127,0]),selected:new B([255,255,255]),outline:new B([0,0,0,.5]),selectedOutline:new B([255,255,255]),hoverOutline:new B([255,255,255]),secondary:new B([255,255,255]),secondaryOutline:new B([100,100,100]),transparent:new B([0,0,0,0])};function ge(e,t){if(t)for(const s in t)e[s]=t[s]}class fe{constructor(e){this.size=8,this.hoverSize=10,this.color=ye.main,this.hoverColor=ye.main,this.outlineColor=ye.outline,this.hoverOutlineColor=ye.hoverOutline,ge(this,e)}}class _e{constructor(e){this.color=ye.secondary,this.hoverColor=ye.main,ge(this,e)}}class je{constructor(e){this.color=ye.transparent,this.hoverColor=ye.transparent,this.outlineColor=ye.main,this.hoverOutlineColor=ye.main,this.stagedColor=ye.transparent,this.stagedOutlineColor=ye.secondary,ge(this,e)}}class ve{constructor(e){this.vertex=new fe,this.midpoint=new fe({color:ye.secondary,outlineColor:ye.secondaryOutline,size:6}),this.selected=new fe({color:ye.selected,hoverColor:ye.selected,hoverOutlineColor:ye.hoverOutline}),ge(this,e)}}class xe{constructor(e){this.center=new fe({color:ye.secondaryOutline}),this.fill=new je,this.line=new _e,this.vertex=new fe({color:ye.selected,outlineColor:ye.main,hoverColor:ye.selected,hoverOutlineColor:ye.secondaryOutline}),ge(this,e)}}const be=new class{constructor(e){this.reshapeGraphics=new ve,this.transformGraphics=new xe,ge(this,e)}};function Ve(e,t){const s=e.x-t.x,i=e.y-t.y;return s*s+i*i}function Se(e,t){const s=e.length===t.length&&e[0]===t[0]&&e[1]===t[1];switch(e.length){case 2:return s;case 3:return s&&e[2]===t[2];case 4:return s&&e[3]===t[3]}return!1}function ke(e,t,s,i){return"2d"===i.type?i.toScreen(t.toPoint(e,Ie)):(Pe(e,t,s,i,we),i.state.camera.projectToScreen(we,Ge),a(Ge[0],Ge[1]))}function Pe(e,t,s,i,r=L()){const o=t.toXYZ(e);return o[2]=Q(i,o,t.spatialReference,s)||0,i.renderCoordsHelper.toRenderCoords(o,t.spatialReference,r),r}function Ce(e,t,s,i,r,o,n){const a=s.toXYZ(e),c=s.toXYZ(t),l=Q(r,a,s.spatialReference,i),p=Q(r,c,s.spatialReference,i),h=(null==l?p:null==p?l:Math.min(l,p))||0;a[2]=h,c[2]=h,r.renderCoordsHelper.toRenderCoords(a,s.spatialReference,o),r.renderCoordsHelper.toRenderCoords(c,s.spatialReference,n)}function De(e,t){t.sort(((t,s)=>_(t.targetPoint,e)-_(s.targetPoint,e)))}const we=L(),Ge=c(),Ie=new X;class Me{}class Le extends Me{constructor(e){super(),this.intersectionPoint=e}equals(e){return e instanceof Le&&Se(this.intersectionPoint,e.intersectionPoint)}}h.getLogger("esri.views.interactive.snapping.hints.LineSnappingHint");class Re extends Me{constructor(e,t,s,i=!0,r=!0){super(),this.type=e,this.lineStart=t,this.lineEnd=s,this.fadeLeft=i,this.fadeRight=r}equals(e){return e instanceof Re&&(this.type===e.type&&Se(this.lineStart,e.lineStart)&&Se(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight)}}h.getLogger("esri.views.interactive.snapping.hints.ParallelSnappingHint");class ze extends Me{constructor(e,t){super(),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof ze&&(Se(this.lineStart,e.lineStart)&&Se(this.lineEnd,e.lineEnd))}}class Ee extends Me{constructor(e){super(),this.point=e}equals(e){return e instanceof Ee&&Se(this.point,e.point)}}h.getLogger("esri.views.interactive.snapping.hints.RightAngleSnappingHint");class Oe extends Me{constructor(e,t,s){super(),this.previousVertex=e,this.centerVertex=t,this.nextVertex=s}equals(e){return e instanceof Oe&&(Se(this.previousVertex,e.previousVertex)&&Se(this.centerVertex,e.centerVertex)&&Se(this.nextVertex,e.nextVertex))}}class Ue{draw(e,t){const s=this.getUniqueHints(e),i=[];for(const e of s)e instanceof Le&&i.push(this.visualizeIntersectionPoint(e,t)),e instanceof Re&&i.push(this.visualizeLine(e,t)),e instanceof ze&&i.push(this.visualizeParallelSign(e,t)),e instanceof Oe&&i.push(this.visualizeRightAngleQuad(e,t)),e instanceof Ee&&i.push(this.visualizePoint(e,t));return g(i)}getUniqueHints(e){const t=[];for(const s of e){let e=!0;for(const i of t)if(s.equals(i)){e=!1;break}e&&t.push(s)}return t}}class Te extends Ue{constructor(e){super(),this.graphicsLayer=e}visualizeIntersectionPoint(e,t){return this._visualizeSnappingIndicator(new X({x:e.intersectionPoint[0],y:e.intersectionPoint[1],spatialReference:t.coordinateHelper.spatialReference}),Ze)}visualizePoint(e,t){return this._visualizeSnappingIndicator(new X({x:e.point[0],y:e.point[1],spatialReference:t.coordinateHelper.spatialReference}),Fe)}visualizeLine(e,t){return this._visualizeSnappingIndicator(new $({paths:[[e.lineStart,e.lineEnd]],spatialReference:t.coordinateHelper.spatialReference}),Ne)}visualizeParallelSign(e,t){return this._visualizeSnappingIndicator(new $({paths:[[e.lineStart,e.lineEnd]],spatialReference:t.coordinateHelper.spatialReference}),qe)}visualizeRightAngleQuad(e,t){return this._visualizeSnappingIndicator(new $({paths:[[e.previousVertex,e.centerVertex,e.nextVertex]],spatialReference:t.coordinateHelper.spatialReference}),Qe(e))}_visualizeSnappingIndicator(e,t){const s=new y({geometry:e,symbol:t});return this.graphicsLayer.add(s),f((()=>{this.graphicsLayer.remove(s)}))}}const He=ye.main.toArray(),Ae=[...ye.main.toRgb(),100],Ze=new W({outline:new J({width:1.5,color:He}),size:15,color:[0,0,0,0]}),Fe=new W({outline:{width:.5,color:[0,0,0,1]},size:10,color:He}),Ne=new K({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:l(Y.lineHintWidthTarget),color:He}]}}}),qe=new K({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,anchorPoint:{x:0,y:-1,z:0},anchorPointUnits:"Relative",size:5,markerPlacement:{type:"CIMMarkerPlacementOnLine",placePerPart:!0,angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-5,ymin:-1.5,xmax:5,ymax:1.5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[7,0],[-7,0],[-7,1.5],[7,1.5]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:He}]}}],scaleSymbolsProportionally:!0,respectFrame:!0},{type:"CIMVectorMarker",enable:!0,anchorPoint:{x:0,y:1,z:0},anchorPointUnits:"Relative",size:5,markerPlacement:{type:"CIMMarkerPlacementOnLine",placePerPart:!0,angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-5,ymin:-1.5,xmax:5,ymax:1.5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[7,0],[-7,0],[-7,-1.5],[7,-1.5]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:He}]}}],scaleSymbolsProportionally:!0,respectFrame:!0}]}}}),Be=e=>new K({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,anchorPoint:{x:.5,y:.5,z:0},anchorPointUnits:"Relative",size:l(Y.rightAngleHintSize),rotation:e,markerPlacement:{type:"CIMMarkerPlacementOnVertices",placePerPart:!0,angleToLine:!0,placeOnEndPoints:!1},frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[5,-5],[-5,-5],[-5,5],[5,5],[5,-5]]]},symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",miterLimit:10,width:l(Y.rightAngleHintOutlineSize),color:He},{type:"CIMSolidFill",enable:!0,color:Ae}]}}],scaleSymbolsProportionally:!0,respectFrame:!0}]}}}),Ye=Be(45),Xe=Be(225),Qe=(()=>{const e=I(),t=I(),s=L();return i=>(j(e,i.centerVertex,i.previousVertex),j(t,i.nextVertex,i.previousVertex),v(s,e,t),s[2]<0?Ye:Xe)})();class We{constructor(e,t,s){this.editGeometry=e,this.vertices=t,this.operation=s,this.undone=!1}apply(){this.vertices.forEach((e=>this.operation.apply(e))),this.editGeometry.components.forEach((e=>e.unnormalizeVertexPositions()));const e={updatedVertices:this.vertices,operation:this.undone?"redo":"apply"};this.editGeometry.emit("change",e)}undo(){this.vertices.forEach((e=>this.operation.undo(e)));const e={updatedVertices:this.vertices,operation:"undo"};this.editGeometry.emit("change",e),this.undone=!0}canAccumulate(e){if(this.undone||e.vertices.length!==this.vertices.length)return!1;for(let t=0;t<e.vertices.length;++t)if(e.vertices[t]!==this.vertices[t])return!1;return this.operation.canAccumulate(e.operation)}accumulate(e){if(e instanceof We&&this.canAccumulate(e)){this.vertices.forEach((t=>this.operation.accumulate(t,e.operation))),this.operation.accumulateParams(e.operation),this.editGeometry.components.forEach((e=>e.unnormalizeVertexPositions()));const t={updatedVertices:this.vertices,operation:"apply"};return this.editGeometry.emit("change",t),!0}return!1}}class Je{constructor(e){this.helper=e}}class Ke{constructor(e,t,s=0){this.editGeometry=e,this.vertices=t,this.minNumberOfVertices=s,this.removedVertices=null}apply(){let e="redo";null==this.removedVertices?(this.removedVertices=[],this.vertices.forEach((e=>{const t=this._removeVertex(e);s(t)&&this.removedVertices.push(t)})),e="apply"):this.removedVertices.forEach((e=>{this._removeVertex(e.removedVertex)}));const t={removedVertices:this.vertices,operation:e};this.editGeometry.emit("change",t)}undo(){this.removedVertices.forEach((e=>{this._undoRemoveVertex(e)}));const e={addedVertices:this.vertices,operation:"undo"};this.editGeometry.emit("change",e)}accumulate(){return!1}_removeVertex(e){const t=e.component;if(t.vertices.length<=this.minNumberOfVertices)return null;const s={removedVertex:e,createdEdge:null},i=e.left,r=e.right;return t.vertices.splice(t.vertices.indexOf(e),1),i&&(t.edges.splice(t.edges.indexOf(i),1),i.left.right=null),r&&(t.edges.splice(t.edges.indexOf(r),1),r.right.left=null),0===e.index&&r&&this.vertices.length>0&&t.swapVertices(t.vertices.indexOf(r.right),0),i&&r&&(s.createdEdge=new ee(t,i.left,r.right),t.edges.push(s.createdEdge)),r&&t.updateVertexIndex(r.right,r.right.index-1),s}_undoRemoveVertex(e){const t=e.removedVertex,s=e.removedVertex.component,i=t.left,r=t.right;e.createdEdge&&s.edges.splice(s.edges.indexOf(e.createdEdge),1),s.vertices.push(t),i&&(s.edges.push(i),i.left.right=i),r&&(s.edges.push(r),r.right.left=r),s.updateVertexIndex(t,t.index)}}class $e{constructor(e,t,s){this.editGeometry=e,this.edge=t,this.t=s,this.createdVertex=null,this.left=null,this.right=null}apply(){let e="redo";const t=this.edge,s=t.component,r=t.component.data,o=t.left,n=t.right;s.edges.splice(s.edges.indexOf(t),1),i(this.createdVertex)&&(e="apply",this.createdVertex=new te(t.component)),s.vertices.push(this.createdVertex),this.createdVertex.pos=r.coordinateHelper.lerp(t.left.pos,t.right.pos,this.t,r.coordinateHelper.createNew()),i(this.left)&&(this.left=new ee(s,o,this.createdVertex)),this.left.left.left?s.edges.push(this.left):s.edges.unshift(this.left),o.right=this.left,i(this.right)&&(this.right=new ee(s,this.createdVertex,n)),s.edges.push(this.right),n.left=this.right,s.updateVertexIndex(this.createdVertex,o.index+1);const a={addedVertices:[this.createdVertex],operation:e};this.editGeometry.emit("change",a)}undo(){if(i(this.createdVertex)||i(this.left)||i(this.right))return null;const e=this.edge,t=e.component,s=this.createdVertex.left,r=this.createdVertex.right,o=s.left,n=r.right;t.vertices.splice(t.vertices.indexOf(this.createdVertex),1),t.edges.splice(t.edges.indexOf(this.left),1),t.edges.splice(t.edges.indexOf(this.right),1),this.edge.left.left?t.edges.push(this.edge):t.edges.unshift(this.edge),o.right=e,n.left=e,t.updateVertexIndex(o,o.index);const a={removedVertices:[this.createdVertex],operation:"undo"};this.editGeometry.emit("change",a)}accumulate(){return!1}}class et extends Je{constructor(e,t,s,i){super(e),this.dx=t,this.dy=s,this.dz=i}move(e,t,s,i){this.helper.addDelta(e.pos,t,s,i)}apply(e){this.move(e,this.dx,this.dy,this.dz)}undo(e){this.move(e,-this.dx,-this.dy,-this.dz)}canAccumulate(e){return e instanceof et}accumulate(e,t){this.move(e,t.dx,t.dy,t.dz)}accumulateParams(e){this.dx+=e.dx,this.dy+=e.dy,this.dz+=e.dz}}function tt(e,t){return e[0]*t[1]-e[1]*t[0]}function st(e,t,s){const i=(t[0]-e[0])*(s[1]-e[1])-(t[1]-e[1])*(s[0]-e[0]);return Math.abs(i)/b(t,s)}function it(e,t,s,i,r=s){return j(ht,i,s),j(ut,t,r),function(e,t,s){const i=k(s,t)/P(s);S(e,s,i)}(dt,ut,ht),V(e,r,dt)}function rt(e,t,s,i){j(ht,i,s),j(ut,t,s);const r=k(ht,ut)/P(ht);return r>0?x(e,s,ht,r):C(e,s)}function ot(e,t,s,i){j(ht,t,s);const r=i/D(ht);return x(e,s,ht,r)}function nt(e,t){return it(ut,t,e.start,e.end),R(ut[0],t[0])&&R(ut[1],t[1])?[M(t)]:[]}function at(e,t,s){return ot(ut,s,e,t),R(ut[0],s[0])&&R(ut[1],s[1])?[M(s)]:[]}function ct(e,t){const s=e.start,i=e.end,r=t.start,o=t.end,n=j(ht,i,s),a=j(mt,o,r),c=tt(n,a);if(Math.abs(c)<=pt)return[];const l=j(ut,s,r),p=tt(a,l)/c,h=tt(n,l)/c;if(p>=0){if(h>=0||1===t.type)return[x(dt,s,n,p)]}else if(1===e.type&&(h>=0||1===t.type))return[x(dt,s,n,p)];return[]}function lt(e,t,s){const i=[],r=j(ht,e.end,e.start),o=j(mt,e.start,t),n=P(r),a=2*k(r,o),c=a*a-4*n*(P(o)-s*s);if(0===c){const t=-a/(2*n);(1===e.type||t>=0)&&i.push(x(dt,e.start,r,t))}else if(c>0){const t=Math.sqrt(c),s=(-a+t)/(2*n);(1===e.type||s>=0)&&i.push(x(dt,e.start,r,s));const o=(-a-t)/(2*n);(1===e.type||o>=0)&&i.push(x(ut,e.start,r,o))}return i}const pt=1e-6,ht=I(),mt=I(),ut=I(),dt=I();class yt extends Je{constructor(e,t,s,i=0,r=0){super(e),this.planeType=t,this.edge=s,this.distance=i,this._plane=ne(),this._offsetPlane=ne(),this._minDistance=-1/0,this._maxDistance=1/0,0===r&&this._initialize()}get plane(){return this._plane}get requiresSplitEdgeLeft(){return!this._left.isOriginalDirection}get requiresSplitEdgeRight(){return!this._right.isOriginalDirection}get edgeDirection(){return this._edgeDirection}_initialize(){this._initializeNeighbors(),this._initializePlane(),this._initializeDistanceConstraints()}_initializeNeighbors(){var e,t,s,i;const r=this._toXYZ(this.edge.left.pos),o=this._toXYZ(null==(e=this.edge.left.left)||null==(t=e.left)?void 0:t.pos),n=this._toXYZ(this.edge.right.pos),a=this._toXYZ(null==(s=this.edge.right.right)||null==(i=s.right)?void 0:i.pos);this._edgeDirection=z(L(),r,n),this._left=this._computeNeighbor(r,o,this._edgeDirection),this._right=this._computeNeighbor(n,a,this._edgeDirection)}_toXYZ(e){return s(e)?this.helper.toXYZ(e):null}_computeNeighbor(e,t,s){if(i(t))return{start:e,end:t,direction:E(-s[1],s[0],0),isOriginalDirection:!0};const r=z(L(),e,t),o=!this._passesBisectingAngleThreshold(r,s);return{start:e,end:t,direction:o?this._bisectVectorsPerpendicular(s,r):r,isOriginalDirection:!o}}_passesBisectingAngleThreshold(e,t){const s=Math.abs(me(t,e));return s>=gt&&s<=Math.PI-gt}_bisectVectorsPerpendicular(e,t){const s=O(e,t)<0?e:U(L(),e),i=Math.abs(O(s,t));if(!(i<.001||i>.999))return this._bisectDirection(s,t);const r=T(L(),s,[0,0,1]);return H(r,r)}_bisectDirection(e,t){const s=A(L(),e,t);return H(s,s)}_initializePlane(){const e=this._computeNormalDirection(this._left),t=this._computeNormalDirection(this._right);O(e,t)<0&&U(t,t),ae(this._left.start,this._bisectDirection(e,t),this._plane)}_computeNormalDirection(e){const t=T(L(),e.direction,this._edgeDirection);H(t,t);const s=T(L(),this._edgeDirection,t);return 1===this.planeType&&(s[2]=0),H(s,s)}_initializeDistanceConstraints(){s(this._left.end)&&!this.requiresSplitEdgeLeft&&this._updateDistanceConstraint(ce(this._plane,this._left.end)),s(this._right.end)&&!this.requiresSplitEdgeRight&&this._updateDistanceConstraint(ce(this._plane,this._right.end)),this._updateIntersectDistanceConstraint(this._plane)}_updateDistanceConstraint(e){e<=0&&(this._minDistance=Math.max(this._minDistance,e)),e>=0&&(this._maxDistance=Math.min(this._maxDistance,e))}_updateIntersectDistanceConstraint(e){const t=he(e),s=this._edgeDirection,i=A(L(),this._left.start,this._left.direction),r=A(L(),this._right.start,this._right.direction),o=this._pointInBasis2D(I(),t,s,this._left.start),n=this._pointInBasis2D(I(),t,s,i),a=this._pointInBasis2D(I(),t,s,this._right.start),c=this._pointInBasis2D(I(),t,s,r),[l]=ct({start:n,end:o,type:1},{start:c,end:a,type:1});if(!l)return;const p=j(I(),o,n);w(p,p);const h=j(I(),l,n),m=k(p,h),u=A(L(),i,Z(L(),this._left.direction,-m)),d=ce(e,u);this._updateDistanceConstraint(d)}_pointInBasis2D(e,t,s,i){return e[0]=ue(t,i),e[1]=ue(s,i),e}_offset(e,t){Number.isFinite(this._minDistance)&&(t=Math.max(this._minDistance,t)),Number.isFinite(this._maxDistance)&&(t=Math.min(this._maxDistance,t)),le(this._plane,this._offsetPlane),this._offsetPlane[3]-=t;const i=(e,t,i)=>s(t)&&pe(this._offsetPlane,e,A(L(),e,t),i),r=L();(e===this.edge.left?i(this._left.start,this._left.direction,r):i(this._right.start,this._right.direction,r))&&this.helper.copy(this.helper.fromXYZ(r,void 0,this.helper.getM(e.pos)),e.pos)}signedDistanceToPoint(e){return ce(this.plane,this.helper.toXYZ(this.helper.fromPoint(e)))}apply(e){this._offset(e,this.distance)}undo(e){this._offset(e,0)}canAccumulate(e){return e instanceof yt&&this.edge.left.index===e.edge.left.index&&this.edge.right.index===e.edge.right.index&&this.edge.component===e.edge.component&&this._maybeEqualsVec3(this._left.direction,e._left.direction)&&this._maybeEqualsVec3(this._right.direction,e._right.direction)&&F(he(this._plane),he(e._plane))}accumulate(e,t){const s=this._plane[3]-t._plane[3]+t.distance;this._offset(e,s)}accumulateParams(e){const t=e.distance-e._plane[3];this.distance=t+this._plane[3]}clone(){const e=new yt(this.helper,this.planeType,this.edge,this.distance,1);return le(this._plane,e._plane),le(this._offsetPlane,e._offsetPlane),e._maxDistance=this._maxDistance,e._minDistance=this._minDistance,e._left=this._cloneNeighbor(this._left),e._right=this._cloneNeighbor(this._right),e._edgeDirection=N(L(),this._edgeDirection),e}_maybeEqualsVec3(e,t){return i(e)&&i(t)||s(e)&&s(t)&&F(e,t)}_cloneNeighbor({start:e,end:t,direction:i,isOriginalDirection:r}){return{start:N(L(),e),end:s(t)?N(L(),t):null,direction:N(L(),i),isOriginalDirection:r}}}const gt=q(15);class ft extends Je{constructor(e,t,s,i=0){super(e),this.origin=t,this.angle=s,this.accumulationType=i}rotate(e,t){this.helper.rotate(e.pos,this.origin,t)}apply(e){this.rotate(e,this.angle)}undo(e){this.rotate(e,-this.angle)}canAccumulate(e){return e instanceof ft&&de(this.origin,e.origin)}accumulate(e,t){const s=1===t.accumulationType;this.rotate(e,s?t.angle-this.angle:t.angle)}accumulateParams(e){const t=1===e.accumulationType;this.angle=t?e.angle:this.angle+e.angle}}class _t extends Je{constructor(e,t,s,i,r,o=0){super(e),this.origin=t,this.axis1=s,this.factor1=i,this.factor2=r,this.accumulationType=o,this.axis2=G(I(),s[1],-s[0])}scale(e,t,s){this.helper.scale(e.pos,this.origin,this.axis1,t),this.helper.scale(e.pos,this.origin,this.axis2,s)}apply(e){this.scale(e,this.factor1,this.factor2)}undo(e){this.scale(e,1/this.factor1,1/this.factor2)}canAccumulate(e){return e instanceof _t&&de(this.origin,e.origin)&&de(this.axis1,e.axis1)}accumulate(e,t){1===t.accumulationType?this.scale(e,t.factor1/this.factor1,t.factor2/this.factor2):this.scale(e,t.factor1,t.factor2)}accumulateParams(e){const t=1===e.accumulationType;this.factor1=t?e.factor1:this.factor1*e.factor1,this.factor2=t?e.factor2:this.factor2*e.factor2}}class jt{constructor(){this.operations=[],this.closed=!1}close(){this.closed=!0}apply(){for(const e of this.operations)e.apply()}undo(){for(let e=this.operations.length-1;e>=0;e--)this.operations[e].undo()}accumulate(e){if(this.closed)return!1;const t=this.operations.length?this.operations[this.operations.length-1]:null;return t&&t.accumulate(e)||(this.operations.push(e),e.apply()),!0}}class vt extends t{constructor(e,t){super(),this.editGeometry=e,this.type=t,this._geometry=null,this._dirty=!0,this._listener=this.editGeometry.on("change",(e=>{this._dirty=!0,e.addedVertices&&this.emit("vertex-add",{type:"vertex-add",vertices:e.addedVertices,operation:e.operation}),e.removedVertices&&this.emit("vertex-remove",{type:"vertex-remove",vertices:e.removedVertices,operation:e.operation}),e.updatedVertices&&this.emit("vertex-update",{type:"vertex-update",vertices:e.updatedVertices,operation:e.operation})}))}destroy(){this._listener.remove()}splitEdge(e,t){return this.editGeometry.apply(new $e(this.editGeometry,e,t))}updateVertices(e,t,s=1){return this.editGeometry.apply(new We(this.editGeometry,e,t),s)}moveVertices(e,t,s,i,r=1){return this.updateVertices(e,new et(this.editGeometry.coordinateHelper,t,s,i),r)}scaleVertices(e,t,s,i,r,o=1,n=0){return this.updateVertices(e,new _t(this.editGeometry.coordinateHelper,t,s,i,r,n),o)}rotateVertices(e,t,s,i=1,r=0){return this.updateVertices(e,new ft(this.editGeometry.coordinateHelper,t,s,r),i)}removeVertices(e){return this.editGeometry.apply(new Ke(this.editGeometry,e,this._minNumVerticesPerType))}appendVertex(e){return 0===this.editGeometry.components.length?null:this.editGeometry.apply(new se(this.editGeometry,this.editGeometry.components[0],e))}offsetEdge(e,t,s,i=1){return this.updateVertices([t.left,t.right],new yt(this.editGeometry.coordinateHelper,e,t,s),i)}canRemoveVertex(){return this.editGeometry.components[0].vertices.length>this._minNumVerticesPerType}createUndoGroup(){const e=new jt;return this.editGeometry.apply(e),{remove:()=>e.close()}}undo(){return this.editGeometry.undo()}get canUndo(){return this.editGeometry.canUndo}redo(){return this.editGeometry.redo()}get canRedo(){return this.editGeometry.canRedo}get geometry(){if(this._dirty){switch(this.type){case"point":this._geometry=this.editGeometry.toPoint();break;case"polyline":this._geometry=this.editGeometry.toPolyline();break;case"polygon":this._geometry=this.editGeometry.toPolygon()}this._dirty=!1}return this._geometry}get _minNumVerticesPerType(){switch(this.type){case"point":return 1;case"polyline":return 2;case"polygon":return 3;default:return 0}}static fromGeometry(e,t){return new vt(ie.fromGeometry(e,t),e.type)}}class xt{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.geometry=e.geometry,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer}get coordinateHelper(){return this.geometry.editGeometry.coordinateHelper}}var bt;let Vt=bt=class extends t.EventedAccessor{constructor(e){var t;super(e),this._hasZ=null,this._cursorScreenPoint=null,this._snappingTask=null,this._stagedVertex=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this._nativeEventHistory={undoStack:[],redoStack:[]},this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=re(e.hasZ,!1,e.view.spatialReference,"local"),this._snappingManager=e.snappingManager,this._editGeometry=new vt(new ie(this._coordinateHelper),null!=(t=e.editGeometryType)?t:"polygon"),this._snappingGraphicsLayer=new u({id:bt.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new xt({geometry:this._editGeometry,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new Te(this._snappingGraphicsLayer)}),this._activeComponent=new oe(this._editGeometry.editGeometry),this._editGeometry.editGeometry.components.push(this._activeComponent)}initialize(){"2d"===this.view.type&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this._snappingTask=r(this._snappingTask),this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),s(this._snappingManager)&&this._snappingManager.doneSnapping(),this._editGeometry.destroy()}get _committedVertices(){return this._editGeometry.editGeometry.components[0].vertices.map((e=>e.pos))}get vertices(){return s(this._stagedVertex)?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return s(this._hasZ)?this._hasZ:"3d"===this.view.type}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}canUndo(){return this._editGeometry.editGeometry.canUndo}canRedo(){return this._editGeometry.editGeometry.canRedo}undo(){this.canUndo()&&this._editGeometry.undo()}redo(){this.canRedo()&&this._editGeometry.redo()}getCoordsFromScreenPoint(e){const t=this.screenToMap(e);return s(t)?t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]:null}getCoordsAndPointFromScreenPoint(e){const t=this.screenToMap(e);return s(t)?t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}:null}_pushCursorVertex(e){const t=d(e[0],e[1],null,this.view.spatialReference);this._stagedVertexUnsnapped=t,i(this._snappingManager)?this._stagedVertex=t:(this._stagedVertex=this._snappingManager.update(t,this._snappingContext),this._snappingTask=n((async e=>{if(s(this._snappingManager)){const s=await this._snappingManager.snap(t,this._snappingContext,e);return s.valid&&(this._stagedVertex=s.apply(),this.notifyChange("vertices")),s}return null})))}_popCursorVertex(){this._stagedVertex=null,this._stagedVertexUnsnapped=null,this.notifyChange("vertices")}getGeometryZValue(){return this.defaultZ}screenToMap(e){let t=null;if("3d"===this.view.type)if(this.hasZ){const s=o(this.elevationInfo,St);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(c(e.x,e.y),s,this.getGeometryZValue())}else{const i=o(this.elevationInfo,kt);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(c(e.x,e.y),i,0),s(t)&&(t.z=void 0)}else t=this.view.toMap(e),s(t)&&(t.z=this.hasZ?this.getGeometryZValue():void 0);return t}_isDuplicateOfLastVertex(e){const t=this._editGeometry.editGeometry.components[0].getLastVertex();if(s(t)&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:i,y:r}=this._coordinateHelper.createDehydratedPoint(e);return!(!s(this._lastVertexUnsnapped)||i!==this._lastVertexUnsnapped.x||r!==this._lastVertexUnsnapped.y)}_vertexAddHandler(e){const t=s(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);s(t)&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};Vt.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",e([p({readOnly:!0})],Vt.prototype,"vertices",null),e([p({type:Boolean,nonNullable:!0})],Vt.prototype,"interactiveUndoDisabled",void 0),e([p({readOnly:!0})],Vt.prototype,"history",void 0),e([p({readOnly:!0})],Vt.prototype,"redoHistory",void 0),e([p()],Vt.prototype,"snapToScene",void 0),e([p()],Vt.prototype,"view",void 0),e([p()],Vt.prototype,"elevationInfo",void 0),e([p({nonNullable:!0})],Vt.prototype,"defaultZ",void 0),e([p()],Vt.prototype,"hasZ",null),Vt=bt=e([m("esri.views.draw.DrawAction")],Vt);const St={mode:"absolute-height",offset:0},kt={mode:"on-the-ground",offset:0};var Pt=Vt;export default Pt;export{vt as E,Le as I,Re as L,et as M,yt as O,ze as P,Oe as R,xt as S,We as U,Ue as a,Pe as b,Ce as c,rt as d,ct as e,lt as f,it as g,ot as h,nt as i,at as j,ke as k,Ve as l,ft as m,_t as n,Se as o,st as p,be as q,Te as r,De as s,Ee as t};
