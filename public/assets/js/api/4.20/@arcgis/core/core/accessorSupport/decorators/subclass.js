/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"../../lang.js";import{d as e}from"../../../chunks/ensureType.js";import{L as t}from"../../../chunks/Logger.js";import{s as r}from"../../../chunks/object.js";import{M as n}from"../../../chunks/Message.js";import{p as o,g as i,b as s}from"../../../chunks/metadata.js";import"../../../config.js";import"../../../chunks/string.js";import"../../../chunks/handleUtils.js";let a,c=[];const u=t.getLogger("esri.core.Accessor");function f(e){void 0!==a&&a.onObservableAccessed(e)}let p=!1,l=!1;function y(e,t,r){if(p)return d(e,t,r);g(e);const n=t.call(r);return j(),n}function d(e,t,r){const n=p;p=!0,g(e);let o=null;try{o=t.call(r)}catch(e){l&&u.error(e)}return j(),p=n,o}function g(e){a=e,c.push(e)}function j(){const e=c.pop();a=c.length>0?c[c.length-1]:void 0,void 0!==e&&e.onTrackingEnd()}function b(e,t){if(32&t.flags)return;const r=l;l=!1,64&t.flags?d(t,t.metadata.get,e):w(e,t),l=r}const m=[];function w(e,t){128&t.flags||(t.flags|=128,d(t,(()=>{const r=t.metadata.dependsOn||m;for(const t of r)if("string"==typeof t&&-1===t.indexOf("."))h(e,t,!1);else{const r=o(t);for(let t=0,n=e;t<r.length&&null!=n&&"object"==typeof n;++t)n=h(n,r[t],t!==r.length-1)}})),t.flags&=-129)}function h(e,t,r){const n="?"===t[t.length-1]?t.slice(0,-1):t;if(null!=e.getItemAt||Array.isArray(e)){const t=parseInt(n,10);if(!isNaN(t))return Array.isArray(e)?e[t]:e.getItemAt(t)}const o=i(e),s=null==o?void 0:o.properties.get(n);return s&&(f(s),b(e,s)),r?e[n]:void 0}class v extends n{constructor(e,t,r){if(super(e,t,r),!(this instanceof v))return new v(e,t,r)}}function A(e){return!!e&&e.prototype&&e.prototype.declaredClass&&0===e.prototype.declaredClass.indexOf("esri.core.Collection")}v.prototype.type="warning";const O=t.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function _(e,t,n){var o,i;e&&(!n&&!t.read||null!=(o=t.read)&&o.reader||!1===(null==(i=t.read)?void 0:i.enabled)||function(e){if("types"in e)return x(e.types);return T(e.type)}(e)&&r("read.reader",P(e),t))}function P(e){var t;const r=null!=(t=e.ndimArray)?t:0;if(r>1)return function(e){var t;const r=M(e),n=k.bind(null,r),o=null!=(t=e.ndimArray)?t:0;return(e,t,r)=>{if(null==e)return e;e=n(e,r,o);let i=o,s=e;for(;i>0&&Array.isArray(s);)i--,s=s[0];if(void 0!==s)for(let t=0;t<i;t++)e=[e];return e}}(e);if(1===r)return C(e);if("type"in e&&N(e.type)){var n,o;const t=null==(n=e.type.prototype)||null==(o=n.itemType)?void 0:o.Type,r=C("function"==typeof t?{type:t}:{types:t});return(t,n,o)=>{const i=r(t,n,o);return i?new e.type(i):i}}return M(e)}function M(e){return"type"in e?function(e){if(e.prototype.read)return(t,r,n)=>{if(null==t)return t;const o=typeof t;if("object"!==o)return void O.error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${o}'`);const i=new e;return i.read(t,n),i};return e.fromJSON}(e.type):function(e){var t;let r=null;const n=null!=(t=e.errorContext)?t:"type";return(t,o,i)=>{if(null==t)return t;const a=typeof t;if("object"!==a)return void O.error(`Expected JSON value of type 'object' to deserialize, but got '${a}'`);r||(r=function(e){const t={};for(const o in e.typeMap){var r,n;const i=e.typeMap[o],a=s(i.prototype);if("function"==typeof e.key)continue;const c=a.properties[e.key];if(!c)continue;null!=(r=c.json)&&r.type&&Array.isArray(c.json.type)&&1===c.json.type.length&&"string"==typeof c.json.type[0]&&(t[c.json.type[0]]=i);const u=null==(n=c.json)?void 0:n.write;if(!u||!u.writer){t[o]=i;continue}const f=u.target,p="string"==typeof f?f:e.key,l={};u.writer(o,l,p),l[p]&&(t[l[p]]=i)}return t}(e));const c=e.key;if("string"!=typeof c)return;const u=t[c],f=u?r[u]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!f){const e=`Type '${u||"unknown"}' is not supported`;return i&&i.messages&&t&&i.messages.push(new v(`${n}:unsupported`,e,{definition:t,context:i})),void O.error(e)}const p=new f;return p.read(t,i),p}}(e.types)}function k(e,t,r,n){return 0!==n&&Array.isArray(t)?t.map((t=>k(e,t,r,n-1))):e(t,void 0,r)}function C(e){const t=M(e);return(e,r,n)=>{if(null==e)return e;if(Array.isArray(e)){const r=[];for(const o of e){const e=t(o,void 0,n);void 0!==e&&r.push(e)}return r}const o=t(e,void 0,n);return void 0!==o?[o]:void 0}}function N(e){if(!A(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&("function"==typeof t.Type?T(t.Type):x(t.Type))}function T(e){return!Array.isArray(e)&&(!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||N(e)))}function x(e){for(const t in e.typeMap){if(!T(e.typeMap[t]))return!1}return!0}function z(e){e.name&&(e.read&&"object"==typeof e.read?void 0===e.read.source&&(e.read.source=e.name):e.read={source:e.name},e.write&&"object"==typeof e.write?void 0===e.write.target&&(e.write.target=e.name):e.write={target:e.name})}function S(e){"boolean"==typeof e.read?e.read={enabled:e.read}:"function"==typeof e.read?e.read={enabled:!0,reader:e.read}:e.read&&"object"==typeof e.read&&void 0===e.read.enabled&&(e.read.enabled=!0)}function $(e){"boolean"==typeof e.write?e.write={enabled:e.write}:"function"==typeof e.write?e.write={enabled:!0,writer:e.write}:e.write&&"object"==typeof e.write&&void 0===e.write.enabled&&(e.write.enabled=!0)}function E(e,t){var n;if(!t.write||t.write.writer||!1===t.write.enabled&&!t.write.overridePolicy)return;const o=null!=(n=null==e?void 0:e.ndimArray)?n:0;var i;e&&(1===o||"type"in e&&A(e.type))?t.write.writer=I:t.write.writer=o>1?(i=o,function(e,t,n,o){let s;if(null===e)s=null;else{s=U(e,o,i);let t=i,r=s;for(;t>0&&Array.isArray(r);)t--,r=r[0];if(void 0!==r)for(let e=0;e<t;e++)s=[s]}r(n,s,t)}):J}function J(e,t,n,o){r(n,L(e,o),t)}function L(e,t){return e&&"function"==typeof e.write?e.write({},t):e&&"function"==typeof e.toJSON?e.toJSON():"number"==typeof e?V(e):e}function V(e){return e===-1/0?-Number.MAX_VALUE:e===1/0?Number.MAX_VALUE:isNaN(e)?null:e}function I(e,t,n,o){let i;null===e?i=null:e&&"function"==typeof e.map?(i=e.map((e=>L(e,o))),"function"==typeof i.toArray&&(i=i.toArray())):i=[L(e,o)],r(n,i,t)}function U(e,t,r){return 0!==r&&Array.isArray(e)?e.map((e=>U(e,t,r-1))):L(e,t)}function K(e,t){return F(e,"read",t)}function X(e,t){return F(e,"write",t)}function F(e,t,r){let n=e&&e.json;if(e&&e.json&&e.json.origins&&r){const o=e.json.origins[r.origin];o&&("any"===t||t in o)&&(n=o)}return n}function W(t){const r=function(t){if(t.type)return function(t){if(!t.type)return;let r=0,n=t.type;for(;Array.isArray(n)&&!e(n);)n=n[0],r++;return{type:n,ndimArray:r}}(t);return function(e){if(!e.types)return;let t=0,r=e.types;for(;Array.isArray(r);)r=r[0],t++;return{types:r,ndimArray:t}}(t)}(t);if(t.json.origins)for(const e in t.json.origins){const n=t.json.origins[e];_(r,n,!1),E(r,n)}_(r,t.json,!0),E(r,t.json)}const q=[{processPrototypePropertyMetadata(e,t){(function(e){if(e.json||(e.json={}),S(e.json),$(e.json),z(e.json),e.json.origins)for(const t in e.json.origins)S(e.json.origins[t]),$(e.json.origins[t]),z(e.json.origins[t]);return!0})(t)&&(!function(e){if(e.json&&e.json.origins){const t=e.json.origins,r={"web-document":["web-scene","web-map"]};for(const e in r)if(t[e]){const n=t[e];r[e].forEach((e=>{t[e]=n})),delete t[e]}}}(t),W(t))}}];const B=new Set,D=new Set;function G(e){return t=>{t.prototype.declaredClass=e,function(e,t){for(const r of q)if(r.processPrototypePropertyMetadata)for(const n in e){const o=e[n];r.processPrototypePropertyMetadata(n,o,e,t)}}(s(t.prototype).properties,e),Q(t);const r=[],n=[];let o=t.prototype;for(;o;)o.hasOwnProperty("initialize")&&!B.has(o.initialize)&&(B.add(o.initialize),r.push(o.initialize)),o.hasOwnProperty("destroy")&&!D.has(o.destroy)&&(D.add(o.destroy),n.push(o.destroy)),o=Object.getPrototypeOf(o);B.clear(),D.clear();class i extends t{constructor(...e){if(super(...e),this.constructor===i&&"function"==typeof this.postscript){if(r.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let e=r.length-1;e>=0;e--)r[e].call(this)}}),n.length){let e=!1;Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!e){e=!0;for(let e=0;e<n.length;e++)n[e].call(this)}}})}this.postscript(...e)}}}return i.__accessorMetadata__=s(t.prototype),i.prototype.declaredClass=e,i}}function H(e,t){return null==t.get?function(){const t=this.__accessor__.properties.get(e);if(void 0===t)return;f(t);const r=this.__accessor__.store;return r.has(e)?r.get(e):t.metadata.value}:function(){const t=this.__accessor__.properties.get(e);if(void 0!==t)return t.getComputed()}}function Q(e){const t=e.prototype,r=t.declaredClass,n=s(t).properties;!function(e,t){for(const r of q)if(r.processClassPropertyMetadata)for(const n in e){const o=e[n];r.processClassPropertyMetadata(n,o,e,t)}}(n,r);const o={};for(const e of Object.getOwnPropertyNames(n)){const t=n[e];o[e]={enumerable:!0,configurable:!0,get:H(e,t),set(r){const n=this.__accessor__;if(void 0!==n){if(!Object.isFrozen(this)){if(n.initialized&&t.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${e}' of ${this.declaredClass}`);if(2===n.lifecycle&&t.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${e}' of ${this.declaredClass}`);n.set(e,r)}}else Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:r})}}}Object.defineProperties(e.prototype,o)}export{v as W,w as a,F as b,X as c,P as d,b as i,V as n,K as o,Q as processClass,y as r,G as subclass,f as t};
