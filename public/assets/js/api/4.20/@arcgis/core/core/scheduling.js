/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{g as t,a as e}from"./lang.js";import{P as s,i,r as h,a as n}from"../chunks/arrayUtils.js";import{createResolver as r,isAborted as a,createAbortError as o}from"./promiseUtils.js";import"./Error.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/Message.js";const l=t.queueMicrotask?t.queueMicrotask:e=>{t.Promise.resolve().then(e)},c=[];let u=[];function d(t){c.push(t),1===c.length&&l((()=>{for(const t of u)t();const t=c.slice();c.length=0;for(const e of t)e()}))}!function(t){t.before=function(t){return u.push(t),{remove(){u=u.filter((e=>e!==t))}}}}(d||(d={}));var f=d;class g{constructor(t,e=29){this.name=t,this._counter=0,this._items=new Array(e)}record(t){this._items[++this._counter%this._items.length]=t}get median(){return this._items.slice().sort()[Math.floor(this._items.length/2)]}get average(){return this._items.reduce(((t,e)=>t+e),0)/this._items.length}get last(){return this._items[this._counter%this._items.length]}}var m;!function(t){const e=(t,e,s,i)=>{let h=e,n=e;const r=s>>>1,a=t[h-1];for(;n<=r;){n=h<<1,n<s&&i(t[n-1],t[n])<0&&++n;const e=t[n-1];if(i(e,a)<=0)break;t[h-1]=e,h=n}t[h-1]=a},s=(t,e)=>t<e?-1:t>e?1:0;t.sort=function(t,i,h,n){void 0===i&&(i=0),void 0===h&&(h=t.length),void 0===n&&(n=s);for(let s=h>>>1;s>i;s--)e(t,s,h,n);const r=i+1;for(let s=h-1;s>i;s--){const h=t[i];t[i]=t[s],t[s]=h,e(t,r,s,n)}},t.iterableSort=function*(t,i,h,n){void 0===i&&(i=0),void 0===h&&(h=t.length),void 0===n&&(n=s);for(let s=h>>>1;s>i;s--)e(t,s,h,n),yield;const r=i+1;for(let s=h-1;s>i;s--){const h=t[i];t[i]=t[s],t[s]=h,e(t,r,s,n),yield}}}(m||(m={}));var _=m;class p{constructor(t){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new s,t&&(t.initialSize&&(this.data=new Array(t.initialSize)),t.allocator&&(this._allocator=t.allocator),void 0!==t.deallocator&&(this._deallocator=t.deallocator),t.shrink&&(this._shrink=()=>v(this)))}toArray(){return this.data.slice(0,this.length)}getItemAt(t){if(!(t<0||t>=this._length))return this.data[t]}get length(){return this._length}set length(t){if(t>this._length){if(this._allocator){for(;this._length<t;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=t}else{if(this._deallocator)for(let e=t;e<this._length;++e)this.data[e]=this._deallocator(this.data[e]);this._length=t,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(t){this.data[this._length++]=t}pushArray(t,e=t.length){for(let s=0;s<e;s++)this.data[this._length++]=t[s]}fill(t,e){for(let s=0;s<e;s++)this.data[this._length++]=t}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const t=this.data[this._length];return++this._length,t}unshift(t){this.data.unshift(t),this._length++,v(this)}pop(){if(0===this.length)return;const t=this.data[this.length-1];return this.length=this.length-1,this._shrink(),t}remove(t){const e=i(this.data,t,this.length,this._hint);if(-1!==e)return this.data.splice(e,1),this.length=this.length-1,t}removeUnordered(t){const e=h(this.data,t,this.length,this._hint);return void 0!==e&&(this.length=this.length-1),this._shrink(),e}removeUnorderedIndex(t){if(!(t>=this.length||t<0))return this.swapElements(t,this.length-1),this.pop()}removeUnorderedMany(t,e=t.length,s){this.length=n(this.data,t,this.length,e,this._hint,s),this._shrink()}front(){if(0!==this.length)return this.data[0]}back(){if(0!==this.length)return this.data[this.length-1]}swapElements(t,e){t>=this.length||e>=this.length||t===e||([this.data[t],this.data[e]]=[this.data[e],this.data[t]])}sort(t){_.sort(this.data,0,this.length,t)}iterableSort(t){return _.iterableSort(this.data,0,this.length,t)}some(t,e){for(let s=0;s<this.length;++s)if(t.call(e,this.data[s],s,this.data))return!0;return!1}filterInPlace(t,e){let s=0;for(let i=0;i<this._length;++i){const h=this.data[i];t.call(e,h,i,this.data)&&(this.data[i]=this.data[s],this.data[s]=h,s++)}if(this._deallocator)for(let t=s;t<this._length;t++)this.data[t]=this._deallocator(this.data[t]);return this._length=s,this._shrink(),this}forAll(t,e){const s=this.length,i=this.data;for(let h=0;h<s;++h)t.call(e,i[h],h,i)}map(t,e){const s=new Array(this.length);for(let i=0;i<this.length;++i)s[i]=t.call(e,this.data[i],i,this.data);return s}reduce(t,e){let s=e;for(let e=0;e<this.length;++e)s=t(s,this.data[e],e,this.data);return s}has(t){const e=this.length,s=this.data;for(let i=0;i<e;++i)if(s[i]===t)return!0;return!1}}function v(t){t.data.length>1.5*t.length&&(t.data.length=Math.floor(1.1*t.length))}function k(t){return t}function w(t){return 1e3*t}function A(t){return t}function j(t){return.001*t}class b{constructor(t){this.phases=t,this.paused=!1,this.ticks=-1,this.removed=!1}}class y{constructor(t){this.callback=t,this.isActive=!0}remove(){this.isActive=!1}}let M=0,T=0;const F={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},x=["prepare","preRender","render","postRender","update"],D=[],S=new p;class U{constructor(t){this._task=t}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const q={frameTasks:S,willDispatch:!1,clearFrameTasks:function(t=!1){S.forAll((t=>{t.removed=!0})),t&&N()},dispatch:B,executeFrameTasks:function(t){const e=t-M;M=t;const s=T>0?T:1e3/60,i=Math.max(0,e-s);for(let h=0;h<x.length;h++){const n=performance.now(),r=x[h];S.forAll((n=>{var a;if(n.paused||n.removed)return;0===h&&n.ticks++;n.phases[r]&&(F.time=t,F.deltaTime=0===n.ticks?0:e,F.elapsedFrameTime=performance.now()-t,F.frameDuration=s-i,null==(a=n.phases[r])||a.call(n,F))})),G[h].record(performance.now()-n)}N(),H.record(performance.now()-t)}};function P(t){const e=new y(t);return D.push(e),q.willDispatch||(q.willDispatch=!0,f(B)),e}function E(t){const e=new b(t);return S.push(e),null==I&&(M=performance.now(),I=requestAnimationFrame(R)),new U(e)}let I=null;function z(t){T=Math.max(0,t)}function R(){const t=performance.now();I=null,I=S.length>0?requestAnimationFrame(R):null,q.executeFrameTasks(t)}const L=new p;function N(){S.forAll((t=>{t.removed&&L.push(t)})),S.removeUnorderedMany(L.data,L.length),L.clear()}function B(){for(;D.length;){const t=e(D.shift());t.isActive&&t.callback()}q.willDispatch=!1}function C(t=1,e){const s=r(),i=()=>{a(e)?s.reject(o()):0===t?s():(--t,f((()=>i())))};return i(),s.promise}const G=x.map((t=>new g(t))),H=new g("total");export{U as FrameTaskHandle,k as M,p as P,A as S,g as a,E as addFrameTask,w as b,j as c,q as debug,f as n,G as performanceInfo,H as performanceTotal,P as schedule,z as setFrameDuration,C as waitTicks};
