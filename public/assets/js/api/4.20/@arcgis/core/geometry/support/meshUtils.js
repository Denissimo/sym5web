/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{b as t,i as r}from"../../core/lang.js";import o from"../Mesh.js";import{M as e,b as s,u as n,g as i}from"../../chunks/georeference.js";import{L as a}from"../../chunks/Logger.js";import{g as c,f as p,b as m}from"../../chunks/mathUtils.js";import u,{M as l}from"./MeshComponent.js";import"../../chunks/tslib.es6.js";import"../../core/Error.js";import"../../chunks/Message.js";import"../../chunks/object.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/Loadable.js";import"../../chunks/Promise.js";import"../../core/Accessor.js";import"../../chunks/deprecate.js";import"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/metadata.js";import"../../chunks/handleUtils.js";import"../../chunks/ArrayPool.js";import"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/arrayUtils.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../Extent.js";import"../Geometry.js";import"../../chunks/JSONSupport.js";import"../../chunks/write.js";import"../../chunks/reader.js";import"../SpatialReference.js";import"../../chunks/writer.js";import"../Point.js";import"../../core/accessorSupport/decorators/cast.js";import"./webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/zmUtils.js";import"../../chunks/axisAngleDegrees.js";import"../../chunks/quat.js";import"../../chunks/vec4.js";import"../../chunks/quatf64.js";import"../../chunks/triangulationUtils.js";import"../../chunks/earcut.js";import"../../chunks/deduplicate.js";import"../projection.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/projectionEllipsoid.js";import"../../chunks/mat4.js";import"../Multipoint.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../Polyline.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"./GeographicTransformation.js";import"./GeographicTransformationStep.js";import"../../chunks/mat3.js";import"../../chunks/mat4f64.js";import"../../chunks/projection.js";import"../../chunks/BufferView.js";import"../../chunks/vec2.js";import"../../chunks/vec3.js";import"./MeshMaterial.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"./MeshTexture.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/screenshotUtils.js";import"./MeshMaterialMetallicRoughness.js";const f=a.getLogger("esri.geometry.support.triangleMeshMerge");function h(o,s){if(0===o.length)return f.error("merge()","Must specify one more more geometries to merge"),null;const n=o[0].spatialReference;for(const t of o){if(!t.spatialReference.equals(n))return f.error("merge()","Geometries must all be in the same spatial reference"),null;if(!t.loaded)return f.error("merge()","Geometries must all be loaded before merging"),null}const i=function(o){let s=null,n=!0;const i=m();let a=0,u=!1;for(const e of o)if(!r(s)||!t(e.transform)&&e.transform.equals(s)||(n=!1),r(e.transform)){if(r(s)&&s.geographic!==e.transform.geographic)return f.error("merge()","Inconsistent geographic mode for provided geometries transform. Some are geographic while others are not, unable to merge geometries."),null;t(s)&&(s=e.transform),e.transform.geographic&&(u=!0),a++,c(i,i,e.transform.origin)}if(t(s))return{transform:null,rebake:!1};if(n)return{transform:s.clone(),rebake:!1};const l=p(i,i,1/a);return{transform:new e({origin:l,geographic:u}),rebake:!0}}(o);if(t(i))return null;const a=function(t){let r=0,o=0,e=0,s=0,n=0;const i=function(t){let r=!1,o=!1,e=!1,s=!1;for(const n of t){const t=n.vertexAttributes;if(t&&t.position&&(t.uv&&(r=!0),t.normal&&(o=!0),t.tangent&&(s=!0),t.color&&(e=!0),o&&r&&e&&s))break}return{normal:o,uv:r,color:e,tangent:s}}(t);for(const a of t){const t=a.vertexAttributes;t&&t.position&&(r+=t.position.length,i.uv&&(o+=t.position.length/d.position*d.uv),i.normal&&(e+=t.position.length/d.position*d.normal),i.color&&(s+=t.position.length/d.position*d.color),i.tangent&&(n+=t.position.length/d.position*d.tangent))}return new l({position:new Float64Array(r),uv:o?new Float32Array(o):null,normal:e?new Float32Array(e):null,tangent:n?new Float32Array(n):null,color:s?new Uint8Array(s):null})}(o),u=[],h={position:0,uv:0,normal:0,tangent:0,color:0},g=new Map,v=new Map;for(const t of o){const r=j(t,i);if(s&&s.reuseMaterials&&t.components)for(const r of t.components)r.material&&g.set(r.material,r.material);k(t,h,g,v,u),b("position",r,a,h,0),b("normal",r,a,h,0),b("tangent",r,a,h,0),b("uv",t.vertexAttributes,a,h,0),b("color",t.vertexAttributes,a,h,255)}return{vertexAttributes:a,components:u,transform:i.transform,spatialReference:n}}function j(t,o){if(!o.rebake)return t.vertexAttributes;const e=s(t.vertexAttributes,t.transform,t.spatialReference);return r(o.transform)?n(e,o.transform.getOriginPoint(t.spatialReference),{geographic:o.transform.geographic}):e}function g(t,r,o){(function(t,r){return r.normal>0&&!t.vertexAttributes.normal})(t,r)&&"source"===o.shading&&(o.shading="flat")}function k(t,r,o,e,s){if(t.components)for(const n of t.components){const i=n.cloneWithDeduplication(o,e);for(let t=0;t<i.faces.length;t++)i.faces[t]+=r.position/3;g(t,r,i),s.push(i)}else if(t.vertexAttributes&&t.vertexAttributes.position){const o=t.vertexAttributes.position.length/3,e=new Uint32Array(o);for(let t=0;t<o;t++)e[t]=t+r.position;const n=new u({faces:e});g(t,r,n),s.push(n)}}function b(o,e,s,n,i){if(!e)return;const a=e.position;if(!a)return;const c=e[o],p=s[o];if(t(c)){let t=n[o];const e=d[o];if(r(p)){for(let r=0;r<a.length;r+=3)for(let r=0;r<e;r++)p[t++]=i;n[o]=t}}else r(p)&&r(c)&&(!function(t,r,o,e,s){for(let n=0;n<s;n++)o[e++]=t[r++]}(c,0,p,n[o],c.length),n[o]+=c.length)}const d={position:3,normal:3,tangent:4,uv:2,color:4};async function v(t,r,o){return(await import("../../chunks/elevation.js")).create(t,r,o)}async function w(t,r){await t.load();return(await import("../../chunks/elevationSampler.js")).create(t,r)}function A(t,r,o){return i(t,r,o)}function M(t,r,o){return n(t,r,o)}function y(t){const e=h(t);return r(e)?new o(e):null}export{w as createElevationSampler,v as createFromElevation,A as georeference,y as merge,M as ungeoreference};
