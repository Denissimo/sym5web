/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import t from"../request.js";import{i as e}from"../core/lang.js";import{join as r,urlToObject as n}from"../core/urlUtils.js";import{getJsonType as o}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as i}from"../geometry/support/normalizeUtils.js";import{p as s}from"./pbfQueryUtils.js";import{a as u}from"./queryZScale.js";function a(t){const e={};for(const r in t){if("declaredClass"===r)continue;const n=t[r];if(null!=n&&"function"!=typeof n)if(Array.isArray(n)){e[r]=[];for(let t=0;t<n.length;t++)e[r][t]=a(n[t])}else"object"==typeof n?n.toJSON&&(e[r]=JSON.stringify(n)):e[r]=n}return e}function l(t,r){const n=t.geometry,i=t.toJSON(),s=i;if(e(n)&&(s.geometry=JSON.stringify(n),s.geometryType=o(n),s.inSR=n.spatialReference.wkid||JSON.stringify(n.spatialReference)),i.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=i.groupByFieldsForStatistics.join(",")),i.objectIds&&(s.objectIds=i.objectIds.join(",")),i.orderByFields&&(s.orderByFields=i.orderByFields.join(",")),!i.outFields||!i.returnDistinctValues&&(null!=r&&r.returnCountOnly||null!=r&&r.returnExtentOnly||null!=r&&r.returnIdsOnly)?delete s.outFields:-1!==i.outFields.indexOf("*")?s.outFields="*":s.outFields=i.outFields.join(","),i.outSR?s.outSR=i.outSR.wkid||JSON.stringify(i.outSR):n&&(i.returnGeometry||i.returnCentroid)&&(s.outSR=s.inSR),i.returnGeometry&&delete i.returnGeometry,i.outStatistics&&(s.outStatistics=JSON.stringify(i.outStatistics)),i.pixelSize&&(s.pixelSize=JSON.stringify(i.pixelSize)),i.quantizationParameters&&(s.quantizationParameters=JSON.stringify(i.quantizationParameters)),i.parameterValues&&(s.parameterValues=JSON.stringify(i.parameterValues)),i.rangeValues&&(s.rangeValues=JSON.stringify(i.rangeValues)),i.dynamicDataSource&&(s.layer=JSON.stringify({source:i.dynamicDataSource}),delete i.dynamicDataSource),i.timeExtent){const t=i.timeExtent,{start:e,end:r}=t;null==e&&null==r||(s.time=e===r?e:`${null==e?"null":e},${null==r?"null":r}`),delete i.timeExtent}return s}async function y(t,r,n,o){const i=e(r.timeExtent)&&r.timeExtent.isEmpty?{data:{features:[]}}:await S(t,r,"json",o);return u(r,n,i.data),i}async function c(t,r,n,o){if(e(r.timeExtent)&&r.timeExtent.isEmpty)return Promise.resolve({data:n.createFeatureResult()});const i=await m(t,r,o),u=i;return u.data=s(i.data,n),u}function m(t,e,r){return S(t,e,"pbf",r)}function f(t,r,n){return e(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):S(t,r,"json",n,{returnIdsOnly:!0})}function d(t,r,n){return e(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):S(t,r,"json",n,{returnIdsOnly:!0,returnCountOnly:!0})}function p(t,r,n){return e(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):S(t,r,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}).then((t=>{const e=t.data;if(e.hasOwnProperty("extent"))return t;if(e.features)throw new Error("Layer does not support extent calculation.");if(e.hasOwnProperty("count"))throw new Error("Layer does not support extent calculation.");return t}))}function S(o,s,u,y={},c={}){const m="string"==typeof o?n(o):o,f=s.geometry?[s.geometry]:[];return y.responseType="pbf"===u?"array-buffer":"json",i(f,null,y).then((n=>{const o=n&&n[0];e(o)&&((s=s.clone()).geometry=o);const i=a({...m.query,f:u,...c,...l(s,c)});return t(r(m.path,"query"),{...y,query:{...i,...y.query}})}))}var x=Object.freeze({__proto__:null,queryToQueryStringParameters:l,executeQuery:y,executeQueryPBF:c,executeQueryPBFBuffer:m,executeQueryForIds:f,executeQueryForCount:d,executeQueryForExtent:p,runQuery:S});export{p as a,f as b,y as c,c as d,d as e,m as f,a as m,x as q,S as r};
