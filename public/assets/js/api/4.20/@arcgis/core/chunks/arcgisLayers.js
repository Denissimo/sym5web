/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../request.js";import r from"../core/Error.js";import{b as a,i as t}from"../core/lang.js";import{getFilename as l,urlToObject as n}from"../core/urlUtils.js";import{p as s,f as o}from"./arcgisLayerUrl.js";import{l as i}from"./lazyLayerLoader.js";import"../config.js";import"./object.js";import"../kernel.js";import"./Logger.js";import"./string.js";import"./Message.js";import"../core/promiseUtils.js";import"./persistableUrlUtils.js";async function u(e){var u;const f=null==(u=e.properties)?void 0:u.customParameters,m=await async function(e,u){let y=s(e);a(y)&&(y=await async function(e,r){var a;const s=await p(e,r);let i=null,u=null;const y=s.type;"Feature Layer"===y||"Table"===y?(i="FeatureServer",u=s.id):"indexedVector"===y?i="VectorTileServer":s.hasOwnProperty("mapName")?i="MapServer":s.hasOwnProperty("bandCount")&&s.hasOwnProperty("pixelSizeX")?i="ImageServer":s.hasOwnProperty("maxRecordCount")&&s.hasOwnProperty("allowGeometryUpdates")?i="FeatureServer":s.hasOwnProperty("streamUrls")?i="StreamServer":c(s)?(i="SceneServer",u=s.id):s.hasOwnProperty("layers")&&c(null==(a=s.layers)?void 0:a[0])&&(i="SceneServer");if(!i)return null;const d=null!=u?o(e):null;return{title:t(d)&&s.name||l(e),serverType:i,sublayer:u,url:{path:t(d)?d.serviceUrl:n(e).path}}}(e,u));if(a(y))throw new r("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:e});const{serverType:f,sublayer:m}=y;let v;const I={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(f){case"MapServer":v=null!=m?"FeatureLayer":async function(e,r){return(await p(e,r)).tileInfo}(e,u).then((e=>e?"TileLayer":"MapImageLayer"));break;case"ImageServer":v=p(e,u).then((e=>{const r=e.tileInfo&&e.tileInfo.format;return e.tileInfo?!r||"LERC"!==r.toUpperCase()||e.cacheType&&"elevation"!==e.cacheType.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"}));break;case"SceneServer":v=p(y.url.path,u).then((e=>{const r={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};if(e&&Array.isArray(e.layers)&&e.layers.length>0){const a=e.layers[0].layerType;if(null!=r[a])return r[a]}return"SceneLayer"}));break;default:v=I[f]}const b={FeatureLayer:!0,SceneLayer:!0},S="FeatureServer"===f,w={parsedUrl:y,Constructor:null,layerOrTableId:S?m:null,sublayerIds:null,tableIds:null},h=await v;if(b[h]&&null==m){const r=await async function(e,r,a){var t,l;let n,s=!1;if("FeatureServer"===r){const r=await async function(e,r){var a,t;let l=await p(e,r);l=l||{},l.layers=(null==(a=l.layers)?void 0:a.filter(d))||[];const n={serviceJSON:l};if(l.currentVersion<10.5)return n;const s=await p(e+"/layers",r);return n.layersJSON={layers:(null==s||null==(t=s.layers)?void 0:t.filter(d))||[],tables:(null==s?void 0:s.tables)||[]},n}(e,a);s=!!r.layersJSON,n=r.layersJSON||r.serviceJSON}else n=await p(e,a);const o=null==(t=n)?void 0:t.layers,i=null==(l=n)?void 0:l.tables;return{layerIds:(null==o?void 0:o.map((e=>e.id)).reverse())||[],tableIds:(null==i?void 0:i.map((e=>e.id)).reverse())||[],layerInfos:s?o:[],tableInfos:s?i:[]}}(e,f,u);S&&(w.sublayerInfos=r.layerInfos,w.tableInfos=r.tableInfos);if(1!==r.layerIds.length+r.tableIds.length)w.sublayerIds=r.layerIds,w.tableIds=r.tableIds;else if(S){var L,O;w.layerOrTableId=null!=(L=r.layerIds[0])?L:r.tableIds[0],w.sourceJSON=null!=(O=r.layerInfos[0])?O:r.tableInfos[0]}}return w.Constructor=await async function(e){return(0,i[e])()}(h),w}(e.url,f),v={...e.properties,url:e.url};if(!m.sublayerIds)return null!=m.layerOrTableId&&(v.layerId=m.layerOrTableId,v.sourceJSON=m.sourceJSON),new m.Constructor(v);const I=new(0,(await import("../layers/GroupLayer.js")).default)({title:m.parsedUrl.title});return function(e,r,a){function l(e,l){const n={...a,layerId:e,sublayerTitleMode:"service-name"};return t(l)&&(n.sourceJSON=l),new r.Constructor(n)}r.sublayerIds.forEach((a=>{const t=l(a,y(r.sublayerInfos,a));e.add(t)})),r.tableIds.forEach((a=>{const t=l(a,y(r.tableInfos,a));e.tables.add(t)}))}(I,m,v),I}function y(e,r){return e?e.find((e=>e.id===r)):null}function c(e){return(null==e?void 0:e.hasOwnProperty("store"))&&e.hasOwnProperty("id")&&"number"==typeof e.id}function d(e){return!e.type||"Feature Layer"===e.type}async function p(r,a){return(await e(r,{responseType:"json",query:{f:"json",...a}})).data}export{u as fromUrl};
