/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{T as t}from"./definitions.js";function e(t,e){return t.x===e.x&&t.y===e.y}function i(t,e){return t.x=e.y,t.y=-e.x,t}function x(t,e){return t.x=-e.y,t.y=e.x,t}function r(t,e){return t.x=e.x,t.y=e.y,t}function n(t,e){return t.x=-e.x,t.y=-e.y,t}function s(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function y(t,e){return t.x*e.x+t.y*e.y}function o(t,e,i,x){return t.x=e.x*i+e.y*x,t.y=e.x*x-e.y*i,t}class h{constructor(t,e,i){this.writeVertex=t,this.writeTriangle=e,this.canUseThinTessellation=i,this.prevNormal={x:void 0,y:void 0},this.nextNormal={x:void 0,y:void 0},this.textureNormalLeft={x:0,y:1},this.textureNormalRight={x:0,y:-1},this.textureNormal={x:void 0,y:void 0},this.joinNormal={x:void 0,y:void 0},this.inner={x:void 0,y:void 0},this.outer={x:void 0,y:void 0},this.roundStart={x:void 0,y:void 0},this.roundEnd={x:void 0,y:void 0},this.startBreak={x:void 0,y:void 0},this.endBreak={x:void 0,y:void 0},this.innerPrev={x:void 0,y:void 0},this.innerNext={x:void 0,y:void 0},this.bevelStart={x:void 0,y:void 0},this.bevelEnd={x:void 0,y:void 0},this.bevelMiddle={x:void 0,y:void 0}}tessellate(i,x){!function(t){if(!t)return;const i=t.length;if(i<=1)return;let x=0;for(let r=1;r<i;r++)e(t[r],t[x])||++x===r||(t[x]=t[r]);t.length=x+1}(i),this.canUseThinTessellation&&x.halfWidth<t&&!x.offset?this.tessellateThin_(i,x):this.tessellate_(i,x)}tessellateThin_(t,e){if(t.length<2)return;const i=e.wrapDistance||65535;let x=e.initialDistance||0,r=!1,n=t[0].x,s=t[0].y;const y=t.length;for(let e=1;e<y;++e){r&&(r=!1,x=0);let y=t[e].x,o=t[e].y,h=y-n,l=o-s,a=Math.sqrt(h*h+l*l);if(h/=a,l/=a,x+a>i){r=!0;const t=(i-x)/a;a=i-x,y=(1-t)*n+t*y,o=(1-t)*s+t*o,--e}const c=this.writeVertex(n,s,0,0,h,l,l,-h,0,-1,x),d=this.writeVertex(n,s,0,0,h,l,-l,h,0,1,x);x+=a;const u=this.writeVertex(y,o,0,0,h,l,l,-h,0,-1,x),v=this.writeVertex(y,o,0,0,h,l,-l,h,0,1,x);this.writeTriangle(c,d,u),this.writeTriangle(d,u,v),n=y,s=o}}tessellate_(t,h){const l=t[0],a=t[t.length-1],c=e(l,a),d=c?3:2;if(t.length<d)return;const u=h.pixelCoordRatio,v=null!=h.capType?h.capType:0,f=null!=h.joinType?h.joinType:2,w=null!=h.miterLimit?Math.min(h.miterLimit,4):2,g=null!=h.roundLimit?Math.min(h.roundLimit,1.05):1.05,T=null!=h.halfWidth?h.halfWidth:2,m=!!h.textured;let V,b,N=null,k=null;const p=this.prevNormal,L=this.nextNormal;let M=-1,E=-1;const B=this.joinNormal;let S,_;const j=this.textureNormalLeft,P=this.textureNormalRight,A=this.textureNormal;let D=-1,U=-1;const R=h.wrapDistance||65535;let W=h.initialDistance||0;const q=this.writeVertex,X=this.writeTriangle,C=function(t,e,i,x,r,n){const s=q(V,b,S,_,i,x,t,e,r,n,W);return D>=0&&U>=0&&s>=0&&X(D,U,s),D=U,U=s,s};c&&(N=t[t.length-2],L.x=a.x-N.x,L.y=a.y-N.y,E=s(L),L.x/=E,L.y/=E);let z=!1;for(let e=0;e<t.length;++e){if(z&&(z=!1,W=0),N&&(p.x=-L.x,p.y=-L.y,M=E,W+M>R&&(z=!0)),z){const i=(R-W)/M;M=R-W,N={x:(1-i)*N.x+i*t[e].x,y:(1-i)*N.y+i*t[e].y},--e}else N=t[e];V=N.x,b=N.y;const h=e<=0&&!z,l=e===t.length-1;if(h||(W+=M),k=l?c?t[1]:null:t[e+1],k?(L.x=k.x-V,L.y=k.y-b,E=s(L),L.x/=E,L.y/=E):(L.x=void 0,L.y=void 0),!c){if(h){x(B,L),S=B.x,_=B.y,2===v&&(C(-L.y-L.x,L.x-L.y,L.x,L.y,0,-1),C(L.y-L.x,-L.x-L.y,L.x,L.y,0,1)),1===v&&(C(-L.y-L.x,L.x-L.y,L.x,L.y,-1,-1),C(L.y-L.x,-L.x-L.y,L.x,L.y,-1,1)),1!==v&&0!==v||(C(-L.y,L.x,L.x,L.y,0,-1),C(L.y,-L.x,L.x,L.y,0,1));continue}if(l){i(B,p),S=B.x,_=B.y,1!==v&&0!==v||(C(p.y,-p.x,-p.x,-p.y,0,-1),C(-p.y,p.x,-p.x,-p.y,0,1)),2===v&&(C(p.y-p.x,-p.x-p.y,-p.x,-p.y,0,-1),C(-p.y-p.x,p.x-p.y,-p.x,-p.y,0,1)),1===v&&(C(p.y-p.x,-p.x-p.y,-p.x,-p.y,1,-1),C(-p.y-p.x,p.x-p.y,-p.x,-p.y,1,1));continue}}let a,d,q=(G=L,-((F=p).x*G.y-F.y*G.x));if(Math.abs(q)<.01)y(p,L)>0?(B.x=p.x,B.y=p.y,q=1,a=Number.MAX_VALUE,d=!0):(x(B,L),q=1,a=1,d=!1);else{B.x=(p.x+L.x)/q,B.y=(p.y+L.y)/q,a=s(B);const t=(a-1)*T*u;d=a>4||t>M&&t>E}S=B.x,_=B.y;let X=f;switch(f){case 0:a<1.05&&(X=2);break;case 1:a<g&&(X=2);break;case 2:a>w&&(X=0)}switch(X){case 2:if(C(B.x,B.y,-p.x,-p.y,0,-1),C(-B.x,-B.y,-p.x,-p.y,0,1),l)break;if(m){const t=z?0:W;D=this.writeVertex(V,b,S,_,L.x,L.y,B.x,B.y,0,-1,t),U=this.writeVertex(V,b,S,_,L.x,L.y,-B.x,-B.y,0,1,t)}break;case 0:{const t=q<0;let e,s,y,h;if(t){const t=D;D=U,U=t,e=j,s=P}else e=P,s=j;if(d)y=t?x(this.innerPrev,p):i(this.innerPrev,p),h=t?i(this.innerNext,L):x(this.innerNext,L);else{const e=t?n(this.inner,B):r(this.inner,B);y=e,h=e}const a=t?i(this.bevelStart,p):x(this.bevelStart,p);C(y.x,y.y,-p.x,-p.y,e.x,e.y);const c=C(a.x,a.y,-p.x,-p.y,s.x,s.y);if(l)break;const u=t?x(this.bevelEnd,L):i(this.bevelEnd,L);if(d){const t=this.writeVertex(V,b,S,_,-p.x,-p.y,0,0,0,0,W);D=this.writeVertex(V,b,S,_,L.x,L.y,h.x,h.y,e.x,e.y,W),U=this.writeVertex(V,b,S,_,L.x,L.y,u.x,u.y,s.x,s.y,W),this.writeTriangle(c,t,U)}else{if(m){const t=this.bevelMiddle;t.x=(a.x+u.x)/2,t.y=(a.y+u.y)/2,o(A,t,-p.x,-p.y),C(t.x,t.y,-p.x,-p.y,A.x,A.y),o(A,t,L.x,L.y),D=this.writeVertex(V,b,S,_,L.x,L.y,t.x,t.y,A.x,A.y,W),U=this.writeVertex(V,b,S,_,L.x,L.y,h.x,h.y,e.x,e.y,W)}else{const t=D;D=U,U=t}C(u.x,u.y,L.x,L.y,s.x,s.y)}if(t){const t=D;D=U,U=t}break}case 1:{const t=q<0;let e,s;if(t){const t=D;D=U,U=t,e=j,s=P}else e=P,s=j;const h=t?n(this.inner,B):r(this.inner,B);let c,u;d?(c=t?x(this.innerPrev,p):i(this.innerPrev,p),u=t?i(this.innerNext,L):x(this.innerNext,L)):(c=h,u=h);const v=t?i(this.roundStart,p):x(this.roundStart,p),f=t?x(this.roundEnd,L):i(this.roundEnd,L),w=C(c.x,c.y,-p.x,-p.y,e.x,e.y),g=C(v.x,v.y,-p.x,-p.y,s.x,s.y);if(l)break;const T=this.writeVertex(V,b,S,_,-p.x,-p.y,0,0,0,0,W);d||this.writeTriangle(D,U,T);const N=n(this.outer,h),k=this.writeVertex(V,b,S,_,L.x,L.y,f.x,f.y,s.x,s.y,W);let M,E;const R=a>2;if(R){let e;a!==Number.MAX_VALUE?(N.x/=a,N.y/=a,e=y(p,N),e=(a*(e*e-1)+1)/e):e=-1,M=t?i(this.startBreak,p):x(this.startBreak,p),M.x+=p.x*e,M.y+=p.y*e,E=t?x(this.endBreak,L):i(this.endBreak,L),E.x+=L.x*e,E.y+=L.y*e}o(A,N,-p.x,-p.y);const X=this.writeVertex(V,b,S,_,-p.x,-p.y,N.x,N.y,A.x,A.y,W);o(A,N,L.x,L.y);const z=m?this.writeVertex(V,b,S,_,L.x,L.y,N.x,N.y,A.x,A.y,W):X,F=T,G=m?this.writeVertex(V,b,S,_,L.x,L.y,0,0,0,0,W):T;let H=-1,I=-1;if(R&&(o(A,M,-p.x,-p.y),H=this.writeVertex(V,b,S,_,-p.x,-p.y,M.x,M.y,A.x,A.y,W),o(A,E,L.x,L.y),I=this.writeVertex(V,b,S,_,L.x,L.y,E.x,E.y,A.x,A.y,W)),m?R?(this.writeTriangle(F,g,H),this.writeTriangle(F,H,X),this.writeTriangle(G,z,I),this.writeTriangle(G,I,k)):(this.writeTriangle(F,g,X),this.writeTriangle(G,z,k)):R?(this.writeTriangle(T,g,H),this.writeTriangle(T,H,I),this.writeTriangle(T,I,k)):(this.writeTriangle(T,g,X),this.writeTriangle(T,z,k)),d?(D=this.writeVertex(V,b,S,_,L.x,L.y,u.x,u.y,e.x,e.y,W),U=k):(D=m?this.writeVertex(V,b,S,_,L.x,L.y,u.x,u.y,e.x,e.y,W):w,this.writeTriangle(D,G,k),U=k),t){const t=D;D=U,U=t}break}}}var F,G}}export{h as L};
