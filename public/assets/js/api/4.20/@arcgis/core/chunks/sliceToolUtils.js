/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"../geometry.js";import{n as e}from"./compilerUtils.js";import{L as t}from"./Logger.js";import{k as r,j as s,l as i,e as a,g as o,f as n,s as c,n as d,b as l,d as g,a as u,A as m,u as p,p as h,r as f}from"./mathUtils.js";import{h as b,i as w,b as y}from"../core/lang.js";import{e as v}from"./screenUtils.js";import{i as j,r as M,s as _,m as k,a as P,t as C,w as x}from"./mat4.js";import{c as O}from"./mat4f64.js";import{r as S}from"./quat.js";import{r as U,f as R,c as W,n as L,u as T,i as A}from"./boundedPlane.js";import{r as E,g as G}from"./plane.js";import{c as I}from"./ray.js";import{k as F}from"./sphere.js";import{b as V,s as D,d as z}from"./vectorStacks.js";import{M as q,d as B}from"./manipulatorUtils.js";import{L as H}from"./LineVisualElement.js";import{c as N}from"./vec4.js";import{f as $}from"./vec4f32.js";import{O as J}from"./Object3DVisualElement.js";import{D as K,P as Q,G as X,C as Y}from"./ColorMaterial.js";import{_ as Z}from"./tslib.es6.js";import{S as ee,g as te,b as re,P as se,D as ie,c as ae,a1 as oe,R as ne,u as ce,a6 as de,a8 as le,ai as ge,a9 as ue,a0 as me}from"./VertexColor.glsl.js";import{m as pe,s as he,d as fe}from"./VertexArrayObject.js";import{c as be}from"./ray2.js";import{I as we}from"./ImageMaterial.js";import{N as ye}from"./NativeLineMaterial.js";import{R as ve}from"./RibbonLineMaterial.js";import je from"../widgets/Slice/SlicePlane.js";import Me from"../geometry/Point.js";const _e=b("mac")?"Meta":"Control",ke="Shift",Pe=2500,Ce=.02,xe=Math.cos(r(45)),Oe=Math.cos(r(5)),Se=.95,Ue=.3,Re=[1,.5,0],We=2,Le=1,Te=[...Re,.7],Ae=[0,0,0,.04],Ee=[...Re,.5],Ge=[...Re,1],Ie=[1,1,1,1],Fe=[1,.8,.6,1],Ve=[1,.93,.86,1],De=[...Re,1],ze=[...Re,1];var qe=Object.freeze({__proto__:null,build:function(){const e=new ee;return e.extensions.add("GL_OES_standard_derivatives"),e.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),e.varyings.add("vUV","vec2"),e.vertex.code.add(te`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),e.fragment.uniforms.add("backgroundColor","vec4").add("gridColor","vec4").add("ratio","float").add("gridWidth","float"),e.fragment.code.add(te`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}});class Be extends re{initializeProgram(e){const t=Be.shader.get().build();return new se(e.rctx,t,ie)}bindPass(e,t){ae(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("backgroundColor",e.backgroundColor),this.program.setUniform4fv("gridColor",e.gridColor),this.program.setUniform1f("gridWidth",e.gridWidth)}bindDraw(e){oe(this.program,e),this.program.rebindTextures()}initializePipeline(){return pe({blending:he(1,1,771,771),depthTest:{func:513},colorWrite:fe})}}Be.shader=new ne(qe,(()=>Promise.resolve().then((function(){return qe}))));class He extends le{constructor(e){super(e,$e)}intersect(e,t,r,s,i,a,o){return ge(e,t,s,i,a,void 0,o)}createBufferWriter(){return new K(Q)}getGLMaterial(e){return 0===e.output?new Ne(e):void 0}}class Ne extends de{constructor(e){super(e),this._technique=new Be(this._techniqueRep.constructionContext,null),this.updateParameters()}updateParameters(){}beginSlot(e){return 8===e}bind(e){this._technique.bindPass(this._material.params,e)}}Z([ce()],Ne.prototype,"_technique",void 0);const $e={backgroundColor:[1,0,0,.5],gridColor:[0,1,0,.5],gridWidth:4,...ue};class Je extends J{constructor(e){super(e),this._material=null,this._renderOccluded=4,this._gridWidth=1,this._gridColor=$(1,0,0,1),this._backgroundColor=$(1,0,0,1),this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(e){this._gridWidth!==e&&(this._gridWidth=e,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(e){N(this._gridColor,e),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){N(this._backgroundColor,e),this._updateMaterial()}createExternalResources(){this._material=new He(this.materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(e){w(this._material)&&e(this._material)}createGeometries(e){if(w(this._material)){const t=X.createSquareGeometry();e.addGeometry(t,this._material)}}get materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){w(this._material)&&this._material.setParameterValues(this.materialParameters)}}const Ke=t.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Qe(e,t,r,i,a,o,c,l){return function(e,t,r,i,a,o){const c=g(e,t),l=V.get(),m=V.get();switch(0===i?Math.abs(c)>xe?1:2:i){case 2:{const i=Math.abs(c)<=Oe?e:r.viewUp;u(l,i,t),s(m,t);break}case 1:u(l,r.viewUp,t),u(m,t,l);break;case 3:{const s=Math.abs(c)<=Oe?t:r.viewUp;u(l,s,e),u(m,e,l);break}}const p=u(V.get(),l,m);g(p,r.viewForward)>0&&n(m,m,-1);d(a,l),d(o,m)}(t,c.worldUpAtPosition(e,V.get()),a,o,l.basis1,l.basis2),n(l.basis1,l.basis1,r),n(l.basis2,l.basis2,i),s(l.origin,e),G(l.basis2,l.basis1,l.origin,l.plane),l}function Xe(e,t,r){const s=t.worldUpAtPosition(e.origin,V.get()),i=e.basis1,a=wt(e,s),o=Math.round(a/kt)*kt;return U(e,o-a,i,r)}function Ye(e,t,r,a,d,l){const u=s(V.get(),d.origin);o(u,u,n(V.get(),d.basis1,e.direction[0]<0?1:-1)),o(u,u,n(V.get(),d.basis2,e.direction[1]<0?1:-1));const m=i(d.basis1),p=i(d.basis2),h=c(V.get(),r,u),f=c(V.get(),t,u);let b=0,w=0;if(gt(e)){const t=lt(d),r=lt(l);b=m-.5*e.direction[0]*g(d.basis1,f)/m,w=p-.5*e.direction[1]*g(d.basis2,f)/p;const s=r/t;b*=s,w*=s}const y=b+.5*e.direction[0]*g(d.basis1,h)/m,v=w+.5*e.direction[1]*g(d.basis2,h)/p,j=n(V.get(),d.basis1,y/m),M=n(V.get(),d.basis2,v/p);(y<=0||ct(l.origin,j,a)<=1600)&&s(j,l.basis1),(v<=0||ct(l.origin,M,a)<=1600)&&s(M,l.basis2);const _=s(V.get(),u);return o(_,_,n(V.get(),j,e.direction[0]<0?-1:1)),o(_,_,n(V.get(),M,e.direction[1]<0?-1:1)),R(_,j,M,l)}function Ze(e,t){return.4*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function et(e,t,r,s){const i=u(V.get(),t,r);return u(i,i,t),E(e,i,s)}function tt(e,t){return B(e.basis1,e.basis2,e.origin,t)}function rt(e,t,r,i){const a=t.worldUpAtPosition(e.origin,V.get()),o=V.get();switch(r){case 1:s(o,a);break;case 2:s(o,e.basis1)}return E(e.origin,o,i)}function st(e,t,r,s){const i=nt(r,2),a=D.get();M(a,t,i.edge*Math.PI/2);const c=d(V.get(),i.basis);let l=n(V.get(),c,i.direction*s.computeScreenPixelSizeAt(i.position)*40);o(l,l,i.position);const g=s.projectToRenderScreen(l,v(V.get())),u=function(e,t){const[r,s,i,a]=e.viewport,o=Math.min(i,a)/16;let n=!0;t[0]<r+o?(t[0]=r+o,n=!1):t[0]>r+i-o&&(t[0]=r+i-o,n=!1);t[1]<s+o?(t[1]=s+o,n=!1):t[1]>s+a-o&&(t[1]=s+a-o,n=!1);return n}(s,g);be(s,g,_t),d(_t.direction,_t.direction);const m=V.get();!u&&A(r,_t,m)&&(l=m),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=p(l),u?e.state|=Mt:e.state&=~Mt}function it(e,t,r,s){const c=i(s.basis1),d=i(s.basis2),l=dt(s),g=lt(s),u=a(V.get(),0,0,0);o(u,n(V.get(),s.basis1,t.direction[0]),n(V.get(),s.basis2,t.direction[1])),o(u,s.origin,u);let m=0,p=1;if(gt(t))1===t.direction[0]&&-1===t.direction[1]?m=kt:1===t.direction[0]&&1===t.direction[1]?m=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(m=3*Math.PI/2),p=g;else{const e=0!==t.direction[0]?1:2;m=1===e?kt:0,p=(1===e?d:c)-l}const h=j(D.get());M(h,h,m),_(h,h,a(V.get(),p,p,p)),k(h,r,h),h[12]=0,h[13]=0,h[14]=0,e.modelTransform=h,e.renderLocation=u}function at(e,t,r,s){const i=s.worldUpAtPosition(r.origin,V.get()),a=nt(r,0),o=j(D.get());M(o,o,a.edge*Math.PI/2),P(o,o,-wt(r,i)),k(o,t,o),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=a.position}function ot(e,t,r){const s=nt(r,1),i=j(D.get());M(i,i,s.edge*Math.PI/2),P(i,i,kt),k(i,t,i),i[12]=0,i[13]=0,i[14]=0,e.modelTransform=i,e.renderLocation=s.position}function nt(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:o(V.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:o(V.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:c(V.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:c(V.get(),e.origin,e.basis2),edge:t}}}function ct(e,t,r){const s=r.projectToRenderScreen(o(V.get(),e,t),v(V.get())),i=r.projectToRenderScreen(c(V.get(),e,t),v(V.get()));return m(c(s,s,i))}function dt(e){const t=i(e.basis1),r=i(e.basis2);return.3*Math.min(t,r)}function lt(e){return dt(e)}function gt(e){return 0!==e.direction[0]&&0!==e.direction[1]}function ut(e,t=1){const r=0===t?40:0,s=[h(r,0,-24),h(r,0,24)],i=function(e,t){const r=c(l(),e[e.length-1],e[e.length-2]);if(d(r,r),n(r,r,12),o(r,r,e[e.length-1]),t){const t=c(l(),e[0],e[1]);return d(t,t),n(t,t,12),o(t,t,e[0]),[t,...e,r]}return[...e,r]}(s,!0),g=(e,t)=>function(e,t,r){const s=s=>{const i=(s?t:e).slice(0),g=c(V.get(),i[0],i[1]);d(g,g);const u=c(V.get(),i[i.length-1],i[i.length-2]);if(d(u,u),r.padding>0){const e=n(l(),u,-r.padding);if(i[i.length-1]=o(e,e,i[i.length-1]),r.bothEnds){const e=n(l(),g,-r.padding);i[0]=o(e,e,i[0])}}const m=s?r.tipFocusMultiplier:1,p=r.tipLength*(r.focusTipLength?m:1),f=r.tipRadius*m,b=j(D.get());if(r.padding>0){const e=p/4,t=a(V.get(),0,e,0),s=1+r.padding/e;C(b,b,t),_(b,b,a(V.get(),s,s,s)),C(b,b,n(t,t,-1/s))}const y=j(O()),v=h(0,1,0),M=x(O(),S(z.get(),v,u));M[12]=i[i.length-1][0],M[13]=i[i.length-1][1],M[14]=i[i.length-1][2],k(M,M,b);const P=[{part:"tube",geometry:function(e,t,r){const s=[];if(w(t))s.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else{const t=12;for(let r=0;r<t;r++){const i=r/t*2*Math.PI;s.push([Math.cos(i)*e,Math.sin(i)*e])}}return X.createPathExtrusionGeometry(s,r,[],[],!1)}(r.tubeRadius*(s?r.tubeFocusMultiplier:1)+r.padding,r.flat,i),transform:y}];let U,R;if(w(r.flat)?U=X.createExtrudedTriangle(p,f,f,r.flat.thickness):(U=X.createConeGeometry(p,f,24,!1,!1,!0),R=X.createConeGeometry(p,f,24,!1,!0,!1)),P.push({part:"tip",geometry:U,transform:M}),R&&P.push({part:"cap",geometry:R,transform:M}),r.bothEnds){const e=x(O(),S(z.get(),v,g));e[12]=i[0][0],e[13]=i[0][1],e[14]=i[0][2],k(e,e,b),P.push({part:"tip",geometry:U,transform:e}),R&&P.push({part:"cap",geometry:R,transform:e})}return P};return{normal:s(!1),focused:s(!0)}}(s,s,{tubeRadius:3,tipRadius:11,tipLength:22.5,tubeFocusMultiplier:1.15,tipFocusMultiplier:1.15,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t}),u=g(0,!1),m=g(2.25,!0),p=new Y({color:Ie,cullFace:2,renderOccluded:16}),f=new Y({color:Fe,cullFace:2,renderOccluded:16}),b=new Y({color:Ve,cullFace:2,renderOccluded:16}),y=new Y({color:ze,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2}),v=X.createPolylineGeometry([[r,0,0],[r-40,0,0]]),M=X.createPolylineGeometry([[r,0,0],[r-40,0,0]]),P=new ye({color:De,renderOccluded:4});return new q({view:e,renderObjects:[...u.normal.map((({part:e,geometry:t,transform:r})=>({geometry:t,material:"tip"===e?p:"cap"===e?f:b,transform:r,stateMask:1|jt}))),...m.normal.map((({geometry:e,transform:t})=>({geometry:e,material:y,transform:t,stateMask:1|jt}))),{geometry:v,material:P,stateMask:1|jt|Mt},...u.focused.map((({part:e,geometry:t,transform:r})=>({geometry:t,material:"tip"===e?p:"cap"===e?f:b,transform:r,stateMask:2|jt}))),...m.focused.map((({geometry:e,transform:t})=>({geometry:e,material:y,transform:t,stateMask:2|jt}))),{geometry:M,material:P,stateMask:2|jt|Mt}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[i]},collisionPriority:1,radius:11,state:jt})}function mt(e,t){const r=new we({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:16}),s=40,i=27*1.1,a=e=>{const t=new Uint32Array([0,1,2,2,3,0]);return new me([["position",{size:3,data:[s-e,-e,0,s+e,-e,0,s+e,e,0,s-e,e,0],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1]}]],[["position",t],["uv0",t]])},o=X.createPolylineGeometry([[0,0,0],[13,0,0]]),n=X.createPolylineGeometry([[0,0,0],[10.299999999999997,0,0]]),c=new ye({color:Ge,renderOccluded:4}),d=[{geometry:a(27),material:r,stateMask:1|jt},{geometry:o,material:c,stateMask:1|jt},{geometry:a(i),material:r,stateMask:2|jt},{geometry:n,material:c,stateMask:2|jt}];return new q({view:e,renderObjects:d,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[s,0,0]},collisionPriority:1,radius:13.5,state:jt})}function pt(e){return new H({view:e,attached:!0,color:Te,width:1,writeDepthEnabled:!1,renderOccluded:4,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function ht(e){return new Je({view:e,attached:!0,backgroundColor:[...Ae],gridColor:Ee,gridWidth:4,renderOccluded:4})}function ft(e,t){const r=gt(t),s=r?[h(1,0,0),h(0,0,0),h(0,1,0)]:[h(1,0,0),h(-1,0,0)],i=X.createPolylineGeometry(s),a=[...Re,1],o=r?4:1,n=2*o,c=e=>e>1?(e=>new ve({color:a,width:e,renderOccluded:4}))(e):new ye({color:a,renderOccluded:4}),d=[{geometry:i,material:c(o),stateMask:1|Pt},{geometry:i,material:c(n),stateMask:2|Pt},{geometry:i,material:c(1),stateMask:Ct}],l=new q({view:e,renderObjects:d,collisionType:{type:"line",paths:[s]},autoScaleRenderObjects:!1,worldSized:!0,radius:r?6:4,idHint:r?1:2});return l.state=Pt,l}function bt(e,t,r,s=new je){if(y(e))return null;const a=w(s.position)?s.position:new Me;t.fromRenderCoords(e.origin,a,r),s.position=a;const o=t.worldUpAtPosition(e.origin,V.get()),n=t.worldBasisAtPosition(e.origin,1,V.get());return s.width=2*i(e.basis1),s.height=2*i(e.basis2),s.tilt=f(wt(e,o)),s.heading=f(function(e,t,r){return F(e.basis1,r,t)-kt}(e,o,n)),s}function wt(e,t){return F(t,e.basis2,e.basis1)+kt}function yt(e,t,s=W()){return y(e)||y(e.position)?null:t.toRenderCoords(e.position,s.origin)?(t.worldBasisAtPosition(s.origin,0,s.basis1),t.worldBasisAtPosition(s.origin,1,s.basis2),G(s.basis2,s.basis1,s.origin,s.plane),U(s,-r(e.heading),L(s),s),U(s,r(e.tilt),s.basis1,s),n(s.basis1,s.basis1,e.width/2),n(s.basis2,s.basis2,e.height/2),T(s),s):(Ke.error(`Failed to project slice plane position, projection from ${e.position.spatialReference.wkid} is not supported`),null)}function vt(t){switch(t.type){case"building-scene":case"csv":case"direct-line-measurement":case"area-measurement":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"line-of-sight":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"slice":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return e(t.type),!1}}const jt=16,Mt=32,_t=I(),kt=Math.PI/2,Pt=16,Ct=32;export{Se as A,gt as B,Mt as C,jt as D,Pt as E,Ct as F,Ee as G,lt as H,Ce as I,Le as P,pt as a,tt as b,ht as c,We as d,Te as e,Xe as f,Ae as g,ut as h,vt as i,mt as j,ft as k,ke as l,_e as m,rt as n,Ue as o,bt as p,Ze as q,Ye as r,yt as s,Qe as t,Pe as u,st as v,at as w,ot as x,it as y,et as z};
