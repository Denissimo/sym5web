/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../request.js";import{isSymbol3D as t}from"../symbols.js";import{i as r,a as o}from"./devEnvironmentUtils.js";import s from"../core/Error.js";import{normalize as n,removeFile as l,urlToObject as a}from"../core/urlUtils.js";import m from"../portal/Portal.js";import i from"../portal/PortalQueryParams.js";import{h as y}from"../core/lang.js";import{f as u}from"./persistableUrlUtils.js";import{fromJSON as f}from"../symbols/support/jsonUtils.js";import{S as c}from"../symbols/Symbol3D.js";import{T as p}from"./Thumbnail.js";const b=()=>!!y("enable-feature:disable-context-navigation"),d=()=>!!y("enable-feature:direct-3d-object-feature-layer-display"),h={};function j(e,t,r){const o=t.portal||m.getDefault();let n;const l=`${o.url} - ${o.user&&o.user.username} - ${e}`;return h[l]||(h[l]=function(e,t,r){return t.load(r).then((()=>{const o=new i({disableExtraQuery:!0,query:`owner:${$} AND type:${D} AND typekeywords:"${e}"`});return t.queryItems(o,r)})).then((({results:t})=>{let o=null;const n=e.toLowerCase();if(t&&Array.isArray(t))for(const e of t){if(e.typeKeywords.some((e=>e.toLowerCase()===n))&&e.type===D&&e.owner===$){o=e;break}}if(!o)throw new s("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return o.load(r)}))}(e,o,r).then((e=>(n=e,e.fetchData()))).then((t=>({data:t,baseUrl:n.itemUrl,styleName:e})))),h[l]}function w(e,t,r){return e.styleUrl?function(e,t){return U(e,t).then((t=>({data:t.data,baseUrl:l(e),styleUrl:e})))}(e.styleUrl,r):e.styleName?j(e.styleName,t,r):Promise.reject(new s("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function g(e,t,r,o){return e.name?e.styleName&&"Esri2DPointSymbolsStyle"===e.styleName?function(e,t,r){const o=E.replace(/\{SymbolName\}/gi,e.name);return U(o,r).then((e=>{const r=S(e.data);return f(r,{portal:t.portal,url:a(l(o)),origin:"portal-item"})}))}(e,t,o):w(e,t,o).then((s=>N(s,e.name,t,r,o))):Promise.reject(new s("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference"))}function N(e,n,m,i,b){const d=e.data,h={portal:m.portal,url:a(e.baseUrl),origin:"portal-item"},j=d.items.find((e=>e.name===n));if(!j){const e=`The symbol name '${n}' could not be found`;return Promise.reject(new s("symbolstyleutils:symbol-name-not-found",e,{symbolName:n}))}let w=u(function(e,t){if("cimRef"===t)return e.cimRef;if(e.formatInfos&&!y("enable-feature:force-wosr"))for(const t of e.formatInfos)if("gltf"===t.type)return t.href;return e.webRef}(j,i),h),g=j.thumbnail&&j.thumbnail.href;const N=j.thumbnail&&j.thumbnail.imageData;r()&&(w=o(w),g=o(g));const $={portal:m.portal,url:a(l(w)),origin:"portal-item"};return U(w,b).then((r=>{const o="cimRef"===i?S(r.data):r.data,s=f(o,$);if(s&&t(s)){if(g){const e=u(g,h);s.thumbnail=new p({url:e})}else N&&(s.thumbnail=new p({url:`data:image/png;base64,${N}`}));e.styleUrl?s.styleOrigin=new c({portal:m.portal,styleUrl:e.styleUrl,name:n}):e.styleName&&(s.styleOrigin=new c({portal:m.portal,styleName:e.styleName,name:n}))}return s}))}function S(e){return null===e||"CIMSymbolReference"===e.type?e:{type:"CIMSymbolReference",symbol:e}}function U(t,r){const o={responseType:"json",query:{f:"json"},...r};return e(n(t),o)}const $="esri_en",D="Style",E="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var P=Object.freeze({__proto__:null,fetchStyle:w,resolveWebStyleSymbol:g,fetchSymbolFromStyle:N,styleNameFromItem:function(e){for(const t of e.typeKeywords)if(/^Esri.*Style$/.test(t)&&"Esri Style"!==t)return t}});export{b as d,d as e,w as f,g as r,P as s};
