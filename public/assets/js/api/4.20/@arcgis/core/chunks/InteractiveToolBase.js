/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{i as t,b as e,u as n,clone as a}from"../core/lang.js";import{c as r,p as i}from"./mathUtils.js";import{c as s}from"./screenUtils.js";import{project as o}from"../geometry/projection.js";import{a as l}from"./aaBoundingRect.js";import{c}from"./extentUtils.js";import{c as h}from"../geometry/Polygon.js";import{_ as u}from"./tslib.es6.js";import p from"../core/Accessor.js";import{createResolver as m}from"../core/promiseUtils.js";import{property as d}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./Logger.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{b as y}from"./interactiveToolUtils.js";import g from"../core/Collection.js";function x(t,e,n,a){if(null==a||t.hasZ||(a=void 0),"point"===t.type)return t.x+=e,t.y+=n,t.hasZ&&null!=a&&(t.z+=a),t;if("multipoint"===t.type){const r=t.points;for(let t=0;t<r.length;t++)r[t]=S(r[t],e,n,a);return t}if("extent"===t.type)return t.xmin+=e,t.xmax+=e,t.ymin+=n,t.ymax+=n,null!=a&&(t.zmin+=a,t.zmax+=a),t;const r=h(t),i="polyline"===t.type?t.paths:t.rings;for(let t=0;t<r.length;t++){const i=r[t];for(let t=0;t<i.length;t++)i[t]=S(i[t],e,n,a)}return"paths"in t?t.paths=i:t.rings=i,t}function _(t,e,n,a,r){const i=t.clone(),s=a.resolution;if("point"===i.type){if(r)x(i,e*s,-n*s);else{const t=a.state.transform,r=a.state.inverseTransform,s=t[0]*i.x+t[2]*i.y+t[4],o=t[1]*i.x+t[3]*i.y+t[5];i.x=r[0]*(s+e)+r[2]*(o+n)+r[4],i.y=r[1]*(s+e)+r[3]*(o+n)+r[5]}return i}if("multipoint"===i.type){if(r)x(i,e*s,-n*s);else{const t=i.points,r=a.state.transform,s=a.state.inverseTransform;for(let a=0;a<t.length;a++){const i=t[a],o=r[0]*i[0]+r[2]*i[1]+r[4],l=r[1]*i[0]+r[3]*i[1]+r[5],c=s[0]*(o+e)+s[2]*(l+n)+s[4],h=s[1]*(o+e)+s[3]*(l+n)+s[5];t[a]=M(i,c,h,void 0)}}return i}if("extent"===i.type){if(r)x(i,e*s,-n*s);else{const t=a.state.transform,r=a.state.inverseTransform,s=t[0]*i.xmin+t[2]*i.ymin+t[4],o=t[1]*i.xmin+t[3]*i.ymin+t[5],l=t[0]*i.xmax+t[2]*i.ymax+t[4],c=t[1]*i.xmax+t[3]*i.ymax+t[5];i.xmin=r[0]*(s+e)+r[2]*(o+n)+r[4],i.ymin=r[1]*(s+e)+r[3]*(o+n)+r[5],i.xmax=r[0]*(l+e)+r[2]*(c+n)+r[4],i.ymax=r[1]*(l+e)+r[3]*(c+n)+r[5]}return i}if(r)x(i,e*s,-n*s);else{const t=h(i),r="polyline"===i.type?i.paths:i.rings,s=a.state.transform,o=a.state.inverseTransform;for(let a=0;a<t.length;a++){const r=t[a];for(let t=0;t<r.length;t++){const a=r[t],i=s[0]*a[0]+s[2]*a[1]+s[4],l=s[1]*a[0]+s[3]*a[1]+s[5],c=o[0]*(i+e)+o[2]*(l+n)+o[4],h=o[1]*(i+e)+o[3]*(l+n)+o[5];r[t]=M(a,c,h,void 0)}}"paths"in i?i.paths=r:i.rings=r}return i}function v(t,e,n,a){if("point"===t.type){const{x:r,y:i}=t,s=a?a[0]:r,o=a?a[1]:i,l=t.clone(),c=(r-s)*e+s,h=(i-o)*n+o;return l.x=c,l.y=h,l}if("multipoint"===t.type){const r=h(t),i=l(),[s,o,u,p]=c(i,[r]),m=a?a[0]:(s+u)/2,d=a?a[1]:(p+o)/2,f=t.clone(),y=f.points;for(let t=0;t<y.length;t++){const a=y[t],[r,i]=a,s=(r-m)*e+m,o=(i-d)*n+d;y[t]=M(a,s,o,void 0)}return f}if("extent"===t.type){const{xmin:r,xmax:i,ymin:s,ymax:o}=t,l=a?a[0]:(r+i)/2,c=a?a[1]:(o+s)/2,h=t.clone();if(h.xmin=(r-l)*e+l,h.ymax=(o-c)*n+c,h.xmax=(i-l)*e+l,h.ymin=(s-c)*n+c,h.xmin>h.xmax){const t=h.xmin,e=h.xmax;h.xmin=e,h.xmax=t}if(h.ymin>h.ymax){const t=h.ymin,e=h.ymax;h.ymin=e,h.ymax=t}return h}const r=h(t),i=l(),[s,o,u,p]=c(i,r),m=a?a[0]:(s+u)/2,d=a?a[1]:(p+o)/2,f=t.clone(),y="polyline"===f.type?f.paths:f.rings;for(let t=0;t<r.length;t++){const a=r[t];for(let r=0;r<a.length;r++){const i=a[r],[s,o]=i,l=(s-m)*e+m,c=(o-d)*n+d;y[t][r]=M(i,l,c,void 0)}}return"paths"in f?f.paths=y:f.rings=y,f}function E(t,e,n,a,r,i){const s=Math.sqrt((n-t)*(n-t)+(a-e)*(a-e));return Math.sqrt((r-t)*(r-t)+(i-e)*(i-e))/s}function b(t,e,n,a,r,i){const s=180*Math.atan2(e-a,t-n)/Math.PI;return 180*Math.atan2(e-i,t-r)/Math.PI-s}function S(t,e,n,a){return M(t,t[0]+e,t[1]+n,null!=t[2]&&null!=a?t[2]+a:void 0)}function M(t,e,n,a){const r=[e,n];return t.length>2&&r.push(null!=a?a:t[2]),t.length>3&&r.push(t[3]),r}function w(n,a){return n.events.on("drag",function(n,a){let r=null,i=null;return s=>{if("cancel"===s.action)return void(t(i)&&(i.execute({action:"cancel"}),r=null,i=null));const o={action:s.action,screenStart:s.start,screenEnd:s.screenPoint};"start"===s.action&&e(r)&&(r=new O,i=new O,a(n,r,i,s.pointerType,o)),t(r)&&r.execute(o),"end"===s.action&&t(r)&&(r=null,i=null)}}(n,a))}function A(t,e){const n=[t.x,t.y,t.z],a=e,r=[Math.cos(a),Math.sin(a)],i=Math.sqrt(r[0]*r[0]+r[1]*r[1]);if(0===i)return null;r[0]/=i,r[1]/=i;const s=t=>{const e=(t.x-n[0])*r[0]+(t.y-n[1])*r[1];t.x=n[0]+e*r[0],t.y=n[1]+e*r[1]};return t=>(s(t.mapStart),s(t.mapEnd),t)}function j(n,a){let r=null;return s=>{if("start"===s.action&&(r=function(n,a,r){const s=n.geometry;if(e(s))return null;if("mesh"===s.type)return function(n,a,r,s){if(t(a.transform))return function(n,a,r,s){const l=R(r.getOriginPoint(a.spatialReference),s),c=a.spatialReference;if(e(l))return null;return{move:(e,a,s)=>{const h=x(l.clone(),e,a,s);if(h.spatialReference.equals(c))r.origin=i(h.x,h.y,h.z);else{const e=o(h,c);t(e)&&(r.origin=i(e.x,e.y,e.z))}n.notifyGeometryChanged()}}}(n,a,a.transform,r);if(!a.spatialReference.equals(r))return null;let l=0,c=0,h=0;return{move:(t,e,r)=>{const i=t-l,o=e-c,u=r-h;if(i||o||u){const p=a.origin.clone().offset(i,o,u);a.centerAt(p,{geographic:1===s}),n.notifyGeometryChanged(),l=t,c=e,h=r}}}}(n,s,a,r);const l=R(s,a),c=s.spatialReference;if(e(l))return null;return{move:(t,e,a)=>{const r=x(l.clone(),t,e,a);r.spatialReference.equals(c)?n.geometry=r:n.geometry=o(r,c)}}}(n,s.mapStart.spatialReference,a)),e(r))return null;const l=s.mapEnd.x-s.mapStart.x,c=s.mapEnd.y-s.mapStart.y,h=s.mapEnd.z-s.mapStart.z;return r.move(l,c,h),{...s,translationX:l,translationY:c,translationZ:h}}}function R(t,n){return e(t)?null:t.spatialReference.equals(n)?t.clone():o(t,n)}function T(n,a=null,r){let i=null;const s=t(a)&&!n.spatialReference.equals(a)?e=>t(e)?o(e,a):e:t=>t,l={exclude:[],...r};return a=>{if("start"===a.action&&(i=s(n.toMap(a.screenStart,l))),e(i))return null;const r=s(n.toMap(a.screenEnd,l));return t(r)?{...a,mapStart:i,mapEnd:r}:null}}function C(e,a){const r=e.map((t=>n(j(t,a)))).filter((e=>t(e)));return t=>{const e=t.mapEnd.x-t.mapStart.x,n=t.mapEnd.y-t.mapStart.y,a=t.mapEnd.z-t.mapStart.z;return r.forEach((e=>e(t))),{...t,translationX:e,translationY:n,translationZ:a}}}function I(t,e){const n=new Map;for(const r of e)n.set(r,a(t[r]));return e=>(n.forEach(((e,n)=>{t[n]=e})),e)}function z(e){return t(e.geometry)&&"mesh"===e.geometry.type?function(e,n){const a=t(n.transform)?n.transform.clone():null,r=n.vertexAttributes.clonePositional();return t=>(n.transform=a,n.vertexAttributes=r,e.notifyGeometryChanged(),t)}(e,e.geometry):I(e,["geometry"])}function F(e){const a=e.map((t=>n(z(t)))).filter((e=>t(e)));return t=>(a.forEach((e=>e(t))),t)}function D(){let t=0,e=0,n=0;return a=>{"start"===a.action&&(t=a.mapStart.x,e=a.mapStart.y,n=a.mapStart.z);const r=a.mapEnd.x-t,i=a.mapEnd.y-e,s=a.mapEnd.z-n;return t=a.mapEnd.x,e=a.mapEnd.y,n=a.mapEnd.z,{...a,mapDeltaX:r,mapDeltaY:i,mapDeltaZ:s,mapDeltaSpatialReference:a.mapStart.spatialReference}}}function P(){let t=0,e=0;return n=>{"start"===n.action&&(t=n.screenStart.x,e=n.screenStart.y);const a=n.screenEnd.x-t,r=n.screenEnd.y-e;return t=n.screenEnd.x,e=n.screenEnd.y,{...n,screenDeltaX:a,screenDeltaY:r}}}function q(t,e){let n=null,a=0,i=0;return o=>{if("start"===o.action&&(n=t.toScreen(e),n.x<0||n.x>t.width||n.y<0||n.y>t.height?n=null:(a=o.screenStart.x-n.x,i=o.screenStart.y-n.y)),null==n)return null;const l=r(o.screenEnd.x-a,0,t.width),c=r(o.screenEnd.y-i,0,t.height),h=s(l,c);return o.screenStart=n,o.screenEnd=h,o}}class O{constructor(){this.execute=()=>{}}next(e,n=new O){return t(e)&&(this.execute=a=>{const r=e(a);t(r)&&n.execute(r)}),n}}class U{constructor(){this._isToolEditable=!0,this._manipulators=new g,this._nextManipulatorId=0,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,e=0){return this.addMany([t],e)[0]}addMany(t,e=0){return t.map((t=>{const n=this._nextManipulatorId++,a={id:n,manipulator:t,visibilityPredicate:e,attached:!1};return this._manipulators.add(a),this._attached&&this._updateManipulatorAttachment(a),n}))}remove(t){if("number"==typeof t){const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).id===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}const e=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).manipulator===e){const e=this._manipulators.splice(t,1)[0];return this._detachManipulator(e),e.id}return null}removeAll(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((t=>{this._updateManipulatorAttachment(t)})),this._attached=!0}detach(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._attached=!1}destroy(){this._manipulators.forEach((({manipulator:t})=>{t.destroy&&t.destroy()})),this._manipulators.destroy(),this._resourceContexts=null}on(t,e){return this._manipulators.on(t,(t=>{e(t)}))}forEach(t){for(const e of this._manipulators.items)t(e)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach((e=>t.push(e.manipulator))),t}intersect(e,n){let a=null,r=Number.MAX_VALUE;return this._manipulators.forEach((({id:i,manipulator:s,attached:o})=>{if(!o||!s.interactive)return;const l=s.intersectionDistance(e,n);t(l)&&l<r&&(r=l,a={id:i,manipulator:s})})),a}findById(t){if(e(t))return null;for(const e of this._manipulators.items)if(t===e.id)return e.manipulator;return null}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const e=t.manipulator;e.grabbing=!1,e.dragging=!1,e.hovering=!1,e.selected=!1,e.detach&&e.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return 2===t.visibilityPredicate||(this._isToolEditable?0===t.visibilityPredicate:1===t.visibilityPredicate)}}let k=class extends p{constructor(t){super(t),this.toolState="pending",this.attached=!1,this.created=!1,this.completed=!1,this.manipulators=new U,this.updating=!1,this._editableFlags=new Array,this._creationStartedResolver=m(),this._creationFinishedResolver=m()}get active(){return null!=this.view&&this.view.activeTool===this}get isSupported(){return!0}set visible(t){this._set("visible",t),t||y(this,!1),this.attached&&(t?this._show():this._hide())}get editable(){return this.hasEditableFlag(0)}set editable(t){this.setEditableFlag(0,t)}attach(){!this.attached&&this.isSupported&&(this.manipulators.attach(),this.onAttach(),this.visible&&this.onShow(),this._set("attached",!0))}detach(){this.attached&&(this.onHide(),this.onDetach(),this.manipulators.detach(),this._set("attached",!1))}handleInputEvent(t){this.attached&&this.onInputEvent(t)}handleInputEventAfter(t){this.attached&&this.onInputEventAfter(t)}destroy(){switch(this.toolState){case"pending":break;case"creating":case"created":this.manipulators.destroy()}this.toolState="destroyed",this._set("view",null),this._set("created",!1),this._set("completed",!1)}setEditableFlag(t,e){this._editableFlags[t]=e,this.manipulators.isToolEditable=this._editableFlags.every((t=>null==t||t)),this._updateManipulatorAttachment(),0===t&&this.notifyChange("editable"),this.onEditableChange()}hasEditableFlag(t){const e=this._editableFlags[t];return null==e||e}whenCreationStarted(){return this._creationStartedResolver.promise}when(){return this._creationFinishedResolver.promise}rejectCreation(t){switch(this.toolState){case"pending":case"creating":this._creationStartedResolver.resolve(this)}this._creationFinishedResolver.reject(t)}initialize(){}onAttach(){}onDetach(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.hasEditableFlag(0)&&this.hasEditableFlag(1)}startToolCreation(){switch(this.toolState){case"pending":this._creationStartedResolver.resolve(this),this.toolState="creating";break;case"creating":case"created":case"destroyed":default:throw new Error(`unexpected tool state ${this.toolState}`)}}finishToolCreation(){switch(this.toolState){case"pending":this.startToolCreation();case"creating":this.created||(this._set("created",!0),this._creationFinishedResolver.resolve(this)),this.toolState="created";break;case"created":if(!this.created)throw new Error(`expected this.created to match toolstate ${this.toolState}`);break;case"destroyed":default:throw new Error(`unexpected tool state ${this.toolState}`)}}complete(){this.finishToolCreation(),this._set("completed",!0)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.attached&&this.visible?this.manipulators.attach():this.manipulators.detach()}};u([d()],k.prototype,"toolState",void 0),u([d({constructOnly:!0})],k.prototype,"view",void 0),u([d({readOnly:!0})],k.prototype,"active",null),u([d({value:!0})],k.prototype,"visible",null),u([d({value:!0})],k.prototype,"editable",null),u([d({readOnly:!0})],k.prototype,"attached",void 0),u([d({readOnly:!0})],k.prototype,"created",void 0),u([d({readOnly:!0})],k.prototype,"completed",void 0),u([d({readOnly:!0})],k.prototype,"manipulators",void 0),u([d({readOnly:!0})],k.prototype,"updating",void 0),k=u([f("esri.views.interactive.InteractiveToolBase")],k);export{O as E,k as I,U as M,z as a,q as b,w as c,j as d,A as e,P as f,D as g,C as h,F as i,_ as j,v as k,E as l,b as m,I as r,T as s};
