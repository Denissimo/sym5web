/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"./_rollupPluginBabelHelpers.js";import"../geometry.js";import t from"../request.js";import n from"../core/Error.js";import{L as i}from"./Logger.js";import{b as a,d as r,i as s}from"../core/lang.js";import o,{W as l,e as c}from"../geometry/SpatialReference.js";import{project as d}from"../geometry/support/webMercatorUtils.js";import{a as u,c as f,b as m}from"./featureConversionUtils.js";import{O as p}from"./OptimizedFeatureSet.js";import{v as g,i as y,c as w}from"./geojson.js";import{a as b}from"./clientSideDefaults.js";import h from"../layers/support/FieldsIndex.js";import{k as j}from"./fieldType.js";import F from"../rest/support/FeatureSet.js";const I=i.getLogger("esri.layers.graphics.sources.ogcfeature");async function T(e,i,r={},s=5){const{links:o}=e,l=W(o,"items","application/geo+json")||W(o,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(a(l))throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{data:c}=await t(l.href,{signal:r.signal,query:{limit:s,...r.customParameters,token:r.apiKey},headers:{accept:"application/geo+json"}});await g(c);const d=y(c,{geometryType:i.geometryType}),u=i.fields||d.fields||[],f=null!=i.hasZ?i.hasZ:d.hasZ,m=d.geometryType,p=i.objectIdField||d.objectIdFieldName||"OBJECTID";let w=i.timeInfo;const F=u.find((e=>e.name===p));if(!F){if(!d.objectIdFieldType)throw new n("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");u.unshift({name:p,alias:p,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else F.type="esriFieldTypeOID",F.editable=!1,F.nullable=!1;if(p!==d.objectIdFieldName){const e=u.find((e=>e.name===d.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}if(!m)throw new n("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");u===d.fields&&d.unknownFields.length>0&&I.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:d.unknownFields}});for(const e of u){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new n("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(-1===j.jsonValues.indexOf(e.type))throw new n("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(w){const e=new h(u);if(w.startTimeField){const t=e.get(w.startTimeField);t?(w.startTimeField=t.name,t.type="esriFieldTypeDate"):w.startTimeField=null}if(w.endTimeField){const t=e.get(w.endTimeField);t?(w.endTimeField=t.name,t.type="esriFieldTypeDate"):w.endTimeField=null}if(w.trackIdField){const t=e.get(w.trackIdField);t?w.trackIdField=t.name:(w.trackIdField=null,I.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:w}}))}w.startTimeField||w.endTimeField||(I.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:w}}),w=null)}return{drawingInfo:b(m),geometryType:m,fields:u,hasZ:!!f,objectIdField:p,timeInfo:w}}async function k(e,i={}){const{links:r}=e,s=W(r,"data","application/json")||W(r,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(a(s))throw new n("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:l,signal:c}=i,{data:d}=await t(s.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:o}});return d}async function S(e,i={}){const{links:r}=e,s=W(r,"conformance","application/json")||W(r,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(a(s))throw new n("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:l,signal:c}=i,{data:d}=await t(s.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:o}});return d}async function x(e,n={}){const{apiKey:i,customParameters:a,signal:r}=n,{data:s}=await t(e,{signal:r,headers:{accept:"application/json"},query:{...a,token:i}});return s}async function v(e,n={}){const i="application/vnd.oai.openapi+json;version=3.0",r=W(e.links,"service-desc",i);if(a(r))return I.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:s,customParameters:o,signal:l}=n,{data:c}=await t(r.href,{signal:l,headers:{accept:i},query:{...o,token:s}});return c}function N(t){const n=e(/^http:\/\/www\.opengis.net\/def\/crs\/(.*)\/(.*)\/(.*)$/i,{authority:1,version:2,code:3}).exec(t),i=null==n?void 0:n.groups;if(!i)return null;const{authority:a,code:r}=i;switch(a.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return o.GCS_NAD_1927;case"crs83":return new o({wkid:4269});case"crs84":case"crs84h":return o.WGS84;default:return null}case"esri":case"epsg":{const e=Number.parseInt(r,10);return Number.isNaN(e)?null:900913===e?o.WebMercator:new o({wkid:e})}default:return null}}async function q(e,t,n){const i=await O(e,t,n);return F.fromJSON(i)}async function O(e,t,n){const i=await M(e,t,n);return u(i)}async function M(e,i,c){const{capabilities:{query:{maxRecordCount:u}},collection:g,layerDefinition:y,queryParameters:{apiKey:b,customParameters:h},spatialReference:j,supportedCrs:F}=e,{links:I}=g,T=W(I,"items","application/geo+json")||W(I,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(a(T))throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:k,num:S,start:x,timeExtent:v,where:N}=i;if(i.objectIds)throw new n("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const q=o.fromJSON(j),O=r(i.outSpatialReference,q),M=O.isWGS84?null:D(O,F),C=function(e,t){if(!function(e){return s(e)&&"extent"===e.type}(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:P(e)};const i=D(n,t);if(i)return{bbox:P(e),"bbox-crs":i};if(n.isWebMercator)return{bbox:P(d(e,o.WGS84))};return null}(k,F),R=function(e){if(a(e))return null;const{start:t,end:n}=e;return`${s(t)?t.toISOString():".."}/${s(n)?n.toISOString():".."}`}(v),G=function(e){if(a(e)||!e||"1=1"===e)return null;return e}(N),$=null!=S?S:null!=x&&void 0!==x?10:u,{data:Z}=await t(T.href,{...c,query:{...h,...C,crs:M,datetime:R,query:G,limit:$,startindex:x,token:b},headers:{accept:"application/geo+json"}});let K=!1;if(Z.links){K=!!Z.links.find((e=>"next"===e.rel))}!K&&Number.isInteger(Z.numberMatched)&&Number.isInteger(Z.numberReturned)&&(K=Z.numberReturned<Z.numberMatched);const{fields:L,globalIdField:J,hasM:_,hasZ:A,objectIdField:E}=y,B=y.geometryType,U=w(Z,{geometryType:B,hasZ:A,objectIdField:E});if(!M&&O.isWebMercator)for(const e of U)if(e.geometry){const t=f(e.geometry,B,A,!1);t.spatialReference=o.WGS84,e.geometry=m(d(t,O))}for(const e of U)e.objectId=e.attributes[E];const z=M||!M&&O.isWebMercator?O.toJSON():l,H=new p;return H.exceededTransferLimit=K,H.features=U,H.fields=L,H.geometryType=B,H.globalIdFieldName=J,H.hasM=_,H.hasZ=A,H.objectIdFieldName=E,H.spatialReference=z,H}function D(e,t){return t.find((t=>{const n=N(t);return c(n,e)}))}function P(e){const{xmin:t,ymin:n,xmax:i,ymax:a}=e;return`${t},${n},${i},${a}`}function W(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}export{O as a,x as b,S as c,k as d,v as e,T as f,N as g,M as h,q};
