/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{i as e,b as t,A as r,y as s}from"../core/lang.js";import{a6 as i,d as a}from"./VertexColor.glsl.js";import{n as o}from"./compilerUtils.js";import n from"../core/Error.js";import{E as l}from"./Evented.js";import{a6 as h,G as m}from"./mathUtils.js";import{createAbortController as u,onAbort as d,createAbortError as p}from"../core/promiseUtils.js";import{isBlobProtocol as c,isDataProtocol as g}from"../core/urlUtils.js";import{r as x}from"./requestImageUtils.js";import{l as f}from"../request.js";import{g as T}from"./assets.js";import{T as w,i as I}from"./Texture.js";import{k as y,v as F}from"./VertexArrayObject.js";import{C as D}from"./utils4.js";import{L as M}from"./Logger.js";import{a as _}from"./Util.js";import{F as A}from"./FramebufferObject.js";class b extends i{constructor(e){super(e),this._textureIDs=new Set,this._textureRepository=e.textureRep,this._textureId=e.textureId,this._initTransparent=!!e.initTextureTransparent,this._texture=this._acquire(this._textureId),this._textureNormal=this._acquire(e.normalTextureId),this._textureEmissive=this._acquire(e.emissiveTextureId),this._textureOcclusion=this._acquire(e.occlusionTextureId),this._textureMetallicRoughness=this._acquire(e.metallicRoughnessTextureId)}dispose(){this._textureIDs.forEach((e=>this._textureRepository.release(e))),this._textureIDs.clear()}updateTexture(e){e!==this._textureId&&(this._release(this._textureId),this._textureId=e,this._texture=this._acquire(this._textureId))}bindTextures(t){e(this._texture)&&t.bindTexture(this._texture.glTexture,"tex"),e(this._textureNormal)&&t.bindTexture(this._textureNormal.glTexture,"normalTexture"),e(this._textureEmissive)&&t.bindTexture(this._textureEmissive.glTexture,"texEmission"),e(this._textureOcclusion)&&t.bindTexture(this._textureOcclusion.glTexture,"texOcclusion"),e(this._textureMetallicRoughness)&&t.bindTexture(this._textureMetallicRoughness.glTexture,"texMetallicRoughness")}bindTextureScale(t){const r=e(this._texture)&&this._texture.glTexture;r&&r.descriptor.textureCoordinateScaleFactor?t.setUniform2fv("textureCoordinateScaleFactor",r.descriptor.textureCoordinateScaleFactor):t.setUniform2f("textureCoordinateScaleFactor",1,1)}_acquire(e){if(!t(e))return this._textureIDs.add(e),this._textureRepository.acquire(e,this._initTransparent)}_release(e){t(e)||(this._textureIDs.delete(e),this._textureRepository.release(e))}}let E,S=null,v=null;async function C(){return t(v)&&(v=function(){if(t(E)){const e=e=>T(`esri/libs/basisu/${e}`);E=import("./basis_transcoder.js").then((function(e){return e.b})).then((({default:t})=>t({locateFile:e}).then((e=>(e.initializeBasis(),delete e.then,e)))))}return E}(),S=await v),v}function O(e,t,r,s,i){const a=y(t?37496:37492),o=i&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*s*a*o)}function U(e){return e.getNumImages()>=1&&!e.isUASTC()}function L(e){return e.getFaces()>=1&&e.isETC1S()}function P(e,t,r,s,i,a,o,n){const{compressedTextureETC:l,compressedTextureS3TC:h}=e.capabilities,[m,u]=l?s?[1,37496]:[0,37492]:h?s?[3,33779]:[2,33776]:[13,6408],d=t.hasMipmap?r:Math.min(1,r),p=[];for(let e=0;e<d;e++)p.push(new Uint8Array(o(e,m))),n(e,m,p[e]);const c=p.length>1,g=c?9987:9729,x={...t,samplingMode:g,hasMipmap:c,internalFormat:u,width:i,height:a};return new w(e,x,{type:"compressed",levels:p})}const N=M.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function j(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const R=j("DXT1"),H=j("DXT3"),V=j("DXT5");function q(e,t,r){const{textureData:s,internalFormat:i,width:a,height:o}=function(e,t){const r=new Int32Array(e,0,31);if(542327876!==r[0])return N.error("Invalid magic number in DDS header"),null;if(!(4&r[20]))return N.error("Unsupported format, must contain a FourCC code"),null;const s=r[21];let i,a;switch(s){case R:i=8,a=33776;break;case H:i=16,a=33778;break;case V:i=16,a=33779;break;default:return N.error("Unsupported FourCC code:",(o=s,String.fromCharCode(255&o,o>>8&255,o>>16&255,o>>24&255))),null}var o;let n=1,l=r[4],m=r[3];0==(3&l)&&0==(3&m)||(N.warn("Rounding up compressed texture size to nearest multiple of 4."),l=l+3&-4,m=m+3&-4);const u=l,d=m;131072&r[2]&&!1!==t&&(n=Math.max(1,r[7]));1===n||h(l)&&h(m)||(N.warn("Ignoring mipmaps of non power of two sized compressed texture."),n=1);let p,c,g=r[1]+4;const x=[];for(let t=0;t<n;++t)c=(l+3>>2)*(m+3>>2)*i,p=new Uint8Array(e,g,c),x.push(p),g+=c,l=Math.max(1,l>>1),m=Math.max(1,m>>1);return{textureData:{type:"compressed",levels:x},internalFormat:a,width:u,height:d}}(r,t.hasMipmap);return t.samplingMode=s.levels.length>1?9987:9729,t.hasMipmap=s.levels.length>1,t.internalFormat=i,t.width=a,t.height=o,new w(e,t,s)}class k extends D{constructor(e,t){super(),this.data=e,this.type=4,this.glTexture=null,this.powerOfTwoStretchInfo=null,this.loadingPromise=null,this.loadingController=null,this.events=new l,this.params=t||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:10497,t:10497},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||1,this.estimatedTexMemRequired=k.estimateTexMemRequired(this.data,this.params),this.startPreload()}startPreload(){const e=this.data;t(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))}startPreloadVideoElement(e){c(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)}startPreloadImageElement(e){g(e.src)||c(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static estimateTexMemRequired(e,i){if(t(e))return 0;if(r(e)||s(e))return i.encoding===k.KTX2_ENCODING?function(e,r){if(t(S))return e.byteLength;const s=new S.KTX2File(new Uint8Array(e)),i=L(s)?O(s.getLevels(),s.getHasAlpha(),s.getWidth(),s.getHeight(),r):0;return s.close(),s.delete(),i}(e,i.mipmap):i.encoding===k.BASIS_ENCODING?function(e,r){if(t(S))return e.byteLength;const s=new S.BasisFile(new Uint8Array(e)),i=U(s)?O(s.getNumLevels(0),s.getHasAlpha(),s.getImageWidth(0,0),s.getImageHeight(0,0),r):0;return s.close(),s.delete(),i}(e,i.mipmap):e.byteLength;const{width:a,height:o}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?k.getDataDimensions(e):i;return(i.mipmap?4/3:1)*a*o*(i.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}createDescriptor(e){var t;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!=(t=this.params.maxAnisotropy)?t:this.params.mipmap?e.parameters.maxMaxAnisotropy:1}}load(i,a){if(e(this.glTexture))return this.glTexture;if(e(this.loadingPromise))return this.loadingPromise;const o=this.data;return t(o)?(this.glTexture=new w(i,this.createDescriptor(i),null),this.glTexture):"string"==typeof o?this.loadFromURL(i,a,o):o instanceof Image?this.loadFromImageElement(i,a,o):o instanceof HTMLVideoElement?this.loadFromVideoElement(i,a,o):o instanceof ImageData||o instanceof HTMLCanvasElement?this.loadFromImage(i,o,a):(r(o)||s(o))&&this.params.encoding===k.DDS_ENCODING?this.loadFromDDSData(i,o):(r(o)||s(o))&&this.params.encoding===k.KTX2_ENCODING?this.loadFromKTX2(i,o):(r(o)||s(o))&&this.params.encoding===k.BASIS_ENCODING?this.loadFromBasis(i,o):s(o)?this.loadFromPixelData(i,o):r(o)?this.loadFromPixelData(i,new Uint8Array(o)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(r,s,i){if(!(this.data instanceof HTMLVideoElement)||t(this.glTexture))return i;if(this.data.readyState<2||i===this.data.currentTime)return i;if(e(this.powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:i}=this.powerOfTwoStretchInfo;i.setData(this.data),this.drawStretchedTexture(r,s,e,t,i,this.glTexture)}else{const{width:e,height:t}=this.data,{width:r,height:s}=this.glTexture.descriptor;e!==r||t!==s?this.glTexture.updateData(0,0,0,Math.min(e,r),Math.min(t,s),this.data):this.glTexture.setData(this.data)}return this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap(),this.data.currentTime}loadFromDDSData(e,t){return this.glTexture=q(e,this.createDescriptor(e),t),this.glTexture}loadFromKTX2(e,r){return this.loadAsync((()=>async function(e,r,s){t(S)&&(S=await C());const i=new S.KTX2File(new Uint8Array(s));if(!L(i))return null;i.startTranscoding();const a=P(e,r,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),((e,t)=>i.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,r)=>i.transcodeImage(r,e,0,0,t,0,-1,-1)));return i.close(),i.delete(),a}(e,this.createDescriptor(e),r).then((e=>(this.glTexture=e,e)))))}loadFromBasis(e,r){return this.loadAsync((()=>async function(e,r,s){t(S)&&(S=await C());const i=new S.BasisFile(new Uint8Array(s));if(!U(i))return null;i.startTranscoding();const a=P(e,r,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),((e,t)=>i.getImageTranscodedSizeInBytes(0,e,t)),((e,t,r)=>i.transcodeImage(r,0,e,t,0,0)));return i.close(),i.delete(),a}(e,this.createDescriptor(e),r).then((e=>(this.glTexture=e,e)))))}loadFromPixelData(e,t){_(this.params.width>0&&this.params.height>0);const r=this.createDescriptor(e);return r.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,r.width=this.params.width,r.height=this.params.height,this.glTexture=new w(e,r,t),this.glTexture}loadAsync(e){const t=u();this.loadingController=t;const r=e(t.signal);this.loadingPromise=r;const s=()=>{this.loadingController===t&&(this.loadingController=null),this.loadingPromise===r&&(this.loadingPromise=null)};return r.then(s,s),r}loadFromURL(e,t,r){return this.loadAsync((async s=>{const i=await x(r,{signal:s});return this.loadFromImage(e,i,t)}))}loadFromImageElement(e,t,r){return r.complete?this.loadFromImage(e,r,t):this.loadAsync((async s=>{const i=await f(r,r.src,!1,s);return this.loadFromImage(e,i,t)}))}loadFromVideoElement(e,t,r){return r.readyState>=2?this.loadFromImage(e,r,t):this.loadFromVideoElementAsync(e,t,r)}loadFromVideoElementAsync(t,r,s){return this.loadAsync((i=>new Promise(((a,o)=>{const l=()=>{s.removeEventListener("loadeddata",h),s.removeEventListener("error",m),e(u)&&u.remove()},h=()=>{s.readyState>=2&&(l(),a(this.loadFromImage(t,s,r)))},m=e=>{l(),o(e||new n("Failed to load video"))};s.addEventListener("loadeddata",h),s.addEventListener("error",m);const u=d(i,(()=>m(p())))}))))}loadFromImage(e,t,r){const s=k.getDataDimensions(t);this.params.width=s.width,this.params.height=s.height;const i=this.createDescriptor(e);return i.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(e,i)||h(s.width)&&h(s.height)?(i.width=s.width,i.height=s.height,this.glTexture=new w(e,i,t),this.glTexture):(this.glTexture=this.makePowerOfTwoTexture(e,t,s,i,r),this.glTexture)}requiresPowerOfTwo(e,t){const r=33071,s="number"==typeof t.wrapMode?t.wrapMode===r:t.wrapMode.s===r&&t.wrapMode.t===r;return!I(e.gl)&&(t.hasMipmap||!s)}makePowerOfTwoTexture(e,t,r,s,i){const{width:a,height:n}=r,l=m(a),h=m(n);let u;switch(s.width=l,s.height=h,this.params.powerOfTwoResizeMode){case 2:s.textureCoordinateScaleFactor=[a/l,n/h],u=new w(e,s),u.updateData(0,0,0,a,n,t);break;case 1:case null:case void 0:u=this.stretchToPowerOfTwo(e,t,s,i);break;default:o(this.params.powerOfTwoResizeMode)}return s.hasMipmap&&u.generateMipmap(),u}stretchToPowerOfTwo(e,t,r,s){const i=new w(e,r),o=new A(e,{colorTarget:0,depthStencilTarget:0},i),n=new w(e,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),l=a(e);return this.drawStretchedTexture(e,s,o,l,n,i),this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:l,sourceTexture:n,framebuffer:o}:(l.dispose(!0),n.dispose(),o.detachColorTexture(),e.bindFramebuffer(null),o.dispose()),i}drawStretchedTexture(e,t,r,s,i,a){e.bindFramebuffer(r);const o=e.getViewport();e.setViewport(0,0,a.descriptor.width,a.descriptor.height);const n=t.program;e.useProgram(n),n.setUniform4f("color",1,1,1,1),n.bindTexture(i,"tex"),e.bindVAO(s),e.setPipelineState(t.pipeline),e.drawArrays(5,0,F(s,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height)}unload(){if(e(this.powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:r}=this.powerOfTwoStretchInfo;t.dispose(!0),r.dispose(),e.dispose(),this.glTexture=null,this.powerOfTwoStretchInfo=null}if(e(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),e(this.loadingController)){const e=this.loadingController;this.loadingController=null,this.loadingPromise=null,e.abort()}this.events.emit("unloaded")}}k.DDS_ENCODING="image/vnd-ms.dds",k.KTX2_ENCODING="image/ktx2",k.BASIS_ENCODING="image/x.basis";export{b as G,k as T,C as l};
