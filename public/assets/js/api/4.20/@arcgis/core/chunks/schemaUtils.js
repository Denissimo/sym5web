/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"../renderers/ClassBreaksRenderer.js";import"../renderers/DictionaryRenderer.js";import"../renderers/DotDensityRenderer.js";import"../renderers/HeatmapRenderer.js";import"../renderers/Renderer.js";import e from"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../renderers/support/jsonUtils.js";import t from"../core/Error.js";import{u as r,i,h as n,d as s,clone as a}from"../core/lang.js";import{L as l}from"./Logger.js";import{a as o,t as u}from"./screenUtils.js";import{fromJSON as c}from"../symbols/support/jsonUtils.js";import{b as f,a as p}from"./enums.js";import{l as d}from"./Utils12.js";import{c as m,h as y}from"./MaterialKey.js";import{g as h}from"./visualVariablesUtils2.js";import{C as g,R as b}from"./CIMSymbolHelper.js";import{u as x}from"./definitions.js";import{i as v,t as w,r as M,s as S}from"./mat2d.js";import{c as V}from"./mat2df32.js";import{s as z,a as I,e as E,j,t as T}from"./vec2.js";import{c as F}from"./vec2f32.js";import{a as R}from"./aaBoundingRect.js";import{d as N}from"./extentUtils.js";import{isPoint as k}from"../geometry/support/jsonUtils.js";import{normalizeMapX as O}from"../geometry/support/normalizeUtils.js";import{a as P}from"./normalizeUtilsCommon.js";import{g as C}from"../geometry/SpatialReference.js";import{b as L,s as U,g as B,a as J}from"./BidiText.js";import{c as K}from"./clusterUtils2.js";import{t as q}from"./util2.js";const A=Math.PI/180,D=V(),$=F(),G=512,H=50;function W(e,t){if(!t.isWrappable)return null;const[r,i]=P(t);return e[2]>i?[R([e[0],e[1],i,e[3]]),R([r,e[1],r+e[2]-i,e[3]])]:e[0]<r?[R([r,e[1],e[2],e[3]]),R([i-(r-e[0]),e[1],i,e[3]])]:null}function X(e,t,r,i,n,s,a){if(!i||!r.symbol)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;const l=i;if(!k(l)){N(e,l);let i=t[0];0===i&&(i=ce(r),t[0]=i);const s=n*i/2;return e[0]-=s,e[1]-=s,e[2]+=s,e[3]+=s,e}{const i=l.x,o=l.y;"esriTS"===r.symbol.type&&0===t[2]&&0===t[3]&&fe(t,r.symbol,r.mosaicItem),function(e,t,r,i,n,s,a,l){let o;switch(i.type){case"esriSMS":case"esriPMS":o=le(t,r,i,s,a,0);break;case"esriTS":o=ue(t,r,i,n,s,0);break;case"cim":case"CIMSymbolReference":case"expanded-cim":o=oe(t,r,i,s,a,0)}let u,c,f=0;for(let e=0;e<o.rings[0].length-1;e++)c=o.rings[0][e],u=(t-c[0])*(t-c[0])+(r-c[1])*(r-c[1]),f=Math.max(f,u);f=Math.sqrt(f);let p=O(t-f,l),d=O(t+f,l);if(p>d){const e=C(l);if(e){const[t,r]=e.valid;p=t,d=r}}e[0]=p,e[1]=r-f,e[2]=d,e[3]=r+f}(e,i,o,r.symbol,t,n,s,a)}return e}function Y(e){return"text"===e||"esriTS"===e}function Q(e){return"simple-marker"===e||"picture-marker"===e||"esriSMS"===e||"esriPMS"===e}function Z(e){switch(r(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}const _=F(),ee=F(),te=F(),re=F(),ie=F(),ne=F(),se=F();function ae(e,t,r,i){z(te,t,r);const n=e.paths;let s,a,l,o,u,c,f,p,d,m=1/0;for(let e=0;e<n.length;e++){const y=n[e];if(!(y.length<2))for(let e=1;e<y.length;e++)s=y[e-1][0],l=y[e-1][1],a=y[e][0],o=y[e][1],u=Math.min(s,a)-i,c=Math.min(l,o)-i,f=Math.max(s,a)+i,p=Math.max(l,o)+i,t<u||t>f||r<c||r>p||(z(_,s,l),z(ee,a,o),I(re,ee,_),I(ie,_,te),E(ne,re,j(re,ie)/j(re,re)),I(se,ie,ne),d=j(se,se),m>d&&(m=d))}return Math.sqrt(m)<=i}function le(e,t,r,i,n,s){let a,l;const u=o(r.xoffset),c=o(r.yoffset),f=A*r.angle,p=A*s;switch(r.type){case"esriSMS":a=l=o(r.size);break;case"esriPMS":a=o(r.width),l=o(r.height)}n<.04&&(i=.04*i/n);const d=v(D);w(d,d,z($,e,t)),M(d,d,p-f),S(d,d,z($,i,-i)),w(d,d,z($,u,-c));const m=[0,0];T(m,z($,-.5*a,-.5*l),d);const y=[0,0];T(y,z($,-.5*a,.5*l),d);const h=[0,0];T(h,z($,.5*a,-.5*l),d);const g=[0,0];return T(g,z($,.5*a,.5*l),d),{rings:[[m,h,g,y,m]]}}function oe(e,t,r,i,n,s){const a=g.getEnvelope(r.data);if(!a)return null;n<.04&&(i=.04*i/n);const l=o(a.width),u=o(a.height),c=o(a.x),f=o(a.y),p=0*A,d=A*s,m=v(D);w(m,m,z($,e,t)),M(m,m,d-p),S(m,m,z($,i,i));const y=[0,0];T(y,z($,c,f+u),m);const h=[0,0];T(h,z($,c,f),m);const b=[0,0];T(b,z($,c+l,f+u),m);const x=[0,0];return T(x,z($,c+l,f),m),{rings:[[y,b,x,h,y]]}}function ue(e,t,r,i,n,s){const a=o(r.xoffset),l=o(r.yoffset),u=A*r.angle,c=A*s,f=v(D);w(f,f,z($,e,t)),M(f,f,c),S(f,f,z($,n,-n));const p=i[0]+i[2]/2,d=i[1]+i[3]/2;w(f,f,z($,a,-l)),w(f,f,z($,p,d)),M(f,f,u),w(f,f,z($,-p,-d));const m=[0,0];T(m,z($,i[0],i[1]),f);const y=[0,0];T(y,z($,i[0],i[1]+i[3]),f);const h=[0,0];T(h,z($,i[0]+i[2],i[1]),f);const g=[0,0];return T(g,z($,i[0]+i[2],i[1]+i[3]),f),{rings:[[m,h,g,y,m]]}}function ce(e){switch(e.symbol.type){case"esriSFS":case"esriPFS":{const t=e.symbol.outline;return t?t.width:0}case"esriSLS":return o(e.symbol.width);case"esriSMS":return o(e.symbol.size);case"esriPMS":return o(Math.max(e.symbol.width,e.symbol.height));case"esriTS":{const t=[0,0,0,0];fe(t,e.symbol,e.mosaicItem);const r=Math.max(Math.abs(t[0]),Math.abs(t[1]));return Math.max(t[2],t[3])+r}case"expanded-cim":{const t=g.getEnvelope(e.symbol.data);return t.width!==-1/0&&t.height!==-1/0||(t.width=10,t.height=10,t.x=0,t.y=0),o(Math.sqrt(t.width*t.width+t.height*t.height))}case"composite-symbol":{if(!e.symbol.layers.length)return 0;const t=e.symbol.layers.length-1;return ce({symbol:e.symbol.layers[t],mosaicItem:null})}case"label":default:return 0}}function fe(e,t,r){if(!r||0===r.glyphMosaicItems.length)return e;const i=L(t.text)[1],n=r.glyphMosaicItems,s=U(n,i,{scale:o(t.font.size)/24,angle:t.angle,xOffset:t.xoffset,yOffset:t.yoffset,hAlign:B(t.horizontalAlignment||"center"),vAlign:J(t.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(t.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(t.lineHeight||1,4)),decoration:t.font.decoration||"none",isCIM:!1}).bounds;return e[0]=o(s.x-s.halfWidth),e[1]=o(s.y-s.halfHeight),e[2]=o(s.width),e[3]=o(s.height),e}const pe={"simple-marker":1,"picture-marker":1,text:0,"simple-line":0,"simple-fill":0,"picture-fill":0,cim:1,"web-style":1};function de(e){if(!("visualVariables"in e))return 0;if(!e.hasVisualVariables("size"))return 0;const t=e.getVisualVariablesForType("size");if(!t[0])return 0;const r=t[0];if("stops"===r.transformationType)return r.stops.map((e=>e.size)).reduce(we,0);if("clamped-linear"===r.transformationType){let e=-1/0,t=-1/0;return e="number"==typeof r.maxSize?r.maxSize:r.maxSize.stops.map((e=>e.size)).reduce(we,0),t="number"==typeof r.minSize?r.minSize:r.minSize.stops.map((e=>e.size)).reduce(we,0),Math.max(e,t)}return"real-world-size"===r.transformationType?30:void 0}async function me(e,t,r){if(!e||r&&"cluster"===r.type)return 0;if("heatmap"===e.type)return Math.round(3*e.blurRadius);if("dot-density"===e.type)return 0;if("dictionary"===e.type)return"esriGeometryPoint"===t||"esriGeometryMultipoint"===t?100:200;const i=e.getSymbols(),n=de(e),s=[];for(const e of i)s.push(xe(e,n));const a=await Promise.all(s);return o(a.reduce(we,0))}const ye=[0,0,0,0];function he(e,t){return null==e?t:e}const ge={sdf:!0,code:99,metrics:x.metrics,rect:new b(0,0,24,24),page:0,textureBinding:2};async function be(e,t){if("simple-marker"===e.type){const r=Math.max(he(e.size,12),t);return ve(e)+.707*r}if("picture-marker"===e.type){const r=Math.max(he(e.height,12),t),i=he(e.width,12)*(r/he(e.height,12))/2,n=r/2;return ve(e)+Math.sqrt(i*i+n*n)}if("text"===e.type){const t=function(e){const t=e.text&&e.text.length;if(!t)return{glyphMosaicItems:[ge]};const r=[];for(let i=0;i<t;i++)r.push({...ge,code:e.text.charCodeAt(i)});return{glyphMosaicItems:r}}(e);fe(ye,e.toJSON(),t);const r=Math.abs(ye[0]),i=Math.abs(ye[1]),n=ye[2],s=ye[3];return Math.max(r,i)+Math.max(n,s)}if("simple-line"===e.type){const r=e,i=Math.max(he(r.width,.75),t)/2;return r.marker?Math.max(6*r.width,2*t):i}if("simple-fill"===e.type||"picture-fill"===e.type)return Math.max(function(e,t){return null==e.outline?t:he(e.outline.width,t)}(e,0),t)/2;if("cim"===e.type){const t=g.getEnvelope(e.data);return t?Math.sqrt(t.width*t.width+t.height*t.height):0}return"web-style"===e.type?be(await e.fetchCIMSymbol(),t):0}async function xe(e,t){return function(e){return e.type in pe}(e)?Math.min(await be(e,t),75):0}function ve(e){const t=he(e.xoffset,0),r=he(e.yoffset,0);return Math.sqrt(t*t+r*r)}function we(e,t){return Math.max(e,t)}const Me=l.getLogger("esri.renderers.visualVariables.support.utils"),Se=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const t=e.clone(),r=t.visualVariables.map((e=>ze(e)?Ie(e):e));return t.visualVariables=r,t};function Ve(e){return e.map((e=>ze(e)?Ie(e.clone()):e))}function ze(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function Ie(e){return e.stops=function(e,t){if(t.length<=8)return t;if(Me.warn(`Found ${t.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),t.length>16)return function(e,t){const[r,...i]=t,n=i.pop(),s=i[0].value,a=i[i.length-1].value,l=(a-s)/6,o=[];for(let r=s;r<a;r+=l){let n=0;for(;r>=i[n].value;)n++;const s=i[n],a=t[n-1],l=r-a.value,c=s.value===a.value?1:l/(s.value-a.value);if("color"===e){const e=i[n],s=t[n-1],a=e.color.clone();a.r=Ee(s.color.r,a.r,c),a.g=Ee(s.color.g,a.g,c),a.b=Ee(s.color.b,a.b,c),a.a=Ee(s.color.a,a.a,c),o.push({value:r,color:a,label:e.label})}else if("size"===e){const e=i[n],s=t[n-1],a=u(e.size),l=Ee(u(s.size),a,c);o.push({value:r,size:l,label:e.label})}else{const e=i[n],s=Ee(t[n-1].opacity,e.opacity,c);o.push({value:r,opacity:s,label:e.label})}}return[r,...o,n]}(e,t);return function(e){const[t,...r]=e,i=r.pop();for(;r.length>6;){let e=0,t=0;for(let i=1;i<r.length;i++){const n=r[i-1],s=r[i],a=Math.abs(s.value-n.value);a>t&&(t=a,e=i)}r.splice(e,1)}return[t,...r,i]}(t)}(e.type,e.stops),e}function Ee(e,t,r){return(1-r)*e+r*t}const je=l.getLogger("esri.views.2d.layers.features.schemaUtils"),Te={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function Fe(e){return y(e)}function Re(e){switch(e.type){case"line-marker":var t;return{type:"line-marker",color:null==(t=e.color)?void 0:t.toJSON(),placement:e.placement,style:e.style};default:return c(e.toJSON()).toJSON()}}function Ne(e,t,r){if(!e)return null;let n=0,s=!1,a=0;switch(i(t)&&(a=de(t),"visualVariables"in t&&(n=function(e){if(!e)return f.NONE;let t=0;for(const r of e)if("size"===r.type){const e=h(r);t|=e,"outline"===r.target&&(t|=e<<4)}else"color"===r.type?t|=f.COLOR:"opacity"===r.type?t|=f.OPACITY:"rotation"===r.type&&(t|=f.ROTATION);return t}(t.visualVariables||[]),s="dot-density"===t.type)),e.type){case"simple-fill":case"picture-fill":return function(e,t,r,i){const n=m(p.FILL,t,!1,r),s=i?Fe(n):n,a=e.clone(),l=a.outline;a.outline=null;const o=[],u={materialKey:s,hash:a.hash(),...Re(a)};if(o.push(u),l){const e=m(p.LINE,t,!0,!1),r={materialKey:i?Fe(e):e,hash:l.hash(),...Re(l)};o.push(r)}return{type:"composite-symbol",layers:o,hash:o.reduce(((e,t)=>t.hash+e),"")}}(e,n,s,r);case"simple-marker":case"picture-marker":return function(e,t,r,i){const n=m(p.MARKER,t,!1,!1),s=i?Fe(n):n,a=Re(e);return{materialKey:s,hash:e.hash(),...a,angle:e.angle,maxVVSize:r}}(e,n,a,r);case"simple-line":return function(e,t,r){const i=m(p.LINE,t,!1,!1),n=r?Fe(i):i,s=e.clone(),a=s.marker;s.marker=null;const l=[];if(l.push({materialKey:n,hash:s.hash(),...Re(s)}),a){var o;const e=m(p.MARKER,t,!1,!1),i=r?Fe(e):e;a.color=null!=(o=a.color)?o:s.color,l.push({materialKey:i,hash:a.hash(),lineWidth:s.width,...Re(a)})}return{type:"composite-symbol",layers:l,hash:l.reduce(((e,t)=>t.hash+e),"")}}(e,n,r);case"text":return function(e,t,r,i){const n=m(p.TEXT,t,!1,!1),s=i?Fe(n):n,a=Re(e);return{materialKey:s,hash:e.hash(),...a,angle:e.angle,maxVVSize:r}}(e,n,a,r);case"label":return function(e,t,r){const i=e.toJSON(),n=m(p.LABEL,t,!1,!1,i.labelPlacement);return{materialKey:r?Fe(n):n,hash:e.hash(),...i,labelPlacement:i.labelPlacement}}(e,n,r);case"cim":return{type:"cim",rendererKey:n,data:e.data,maxVVSize:a};case"web-style":return{...Re(e),type:"web-style",hash:e.hash(),rendererKey:n,maxVVSize:a};default:throw new Error(`symbol not supported ${e.type}`)}}function ke(e,r){const i=a(e);return i.some((e=>function(e,r){const i=e.labelPlacement,n=Te[r];if(!e.symbol)return je.warn("No ILabelClass symbol specified."),!0;if(!n)return je.error(new t("mapview-labeling:unsupported-geometry-type",`Unable to create labels for Feature Layer, ${r} is not supported`)),!0;if(!n.some((e=>e===i))){const t=n[0];i&&je.warn(`Found invalid label placement type ${i} for ${r}. Defaulting to ${t}`),e.labelPlacement=t}return!1}(e,r)))?[]:i}function Oe(e){return n("esri-2d-update-debug")&&console.debug("Created new schema",Pe(e,!0)),Pe(e)}function Pe(r,n=!1){try{var s,a;const l=function(r,n=!1){const s=new Array;return s.push(function(r,n,s=!1){const a={indexCount:0,fields:{}},l="featureReduction"in r&&r.featureReduction,o=l?"aggregate":"feature";if("sublayers"in r){const e={type:"subtype",subtypeField:r.subtypeField,renderers:{}},n={type:"subtype",mapping:{},target:"feature"},l={type:"subtype",classes:{}},u={type:"symbol",target:"feature",aggregateFields:[],attributes:a,storage:n,mesh:{matcher:e,aggregateMatcher:null,labels:l}},c=new Set;let f=0;for(const{renderer:u,subtypeCode:p,labelingInfo:d,labelsVisible:m}of r.sublayers){const r=Ae(a,o,u,s),y=qe(a,o,u),h=m&&d;if("visualVariables"in u&&u.visualVariables&&u.visualVariables.length)throw new t("ValidationError","Visual variables are currently not supported for subtype layers");if("dictionary"===r.type)throw new t("ValidationError","Dictionary renderer is not supported in subtype layers");if("subtype"===r.type)throw new t("ValidationError","Nested subtype renderers is not supported");if(i(y)&&"subtype"===y.type)throw new t("ValidationError","Nested subtype storage is not supported");if(i(y)&&"dot-density"===y.type)throw new t("ValidationError","Dot density attributes are not supported in subtype layers");if(c.has(p))throw new t("ValidationError","Subtype codes for sublayers must be unique");c.add(p),e.renderers[p]=r,n.mapping[p]=y,h&&(l.classes[p]=h.map((e=>Ke(u,a,e,"feature",f++,s))))}return u}switch(r.renderer.type){case"heatmap":{const{blurRadius:e,fieldOffset:t,field:i}=r.renderer;return{type:"heatmap",aggregateFields:[],attributes:a,target:o,storage:null,mesh:{blurRadius:e,fieldOffset:t,field:Be(a,{target:o,field:i,resultType:"numeric"}).field}}}default:{const i=[],n="aggregate"===o?K(i,r.renderer,l,null):r.renderer;!function(e,t){const r={mesh:!0,storage:!0};for(const i of t){const{name:t,outStatistic:n}=i,{statisticType:s,onStatisticField:a}=n;let l=null,o=null,u=null;const c="numeric",f="feature";if("onStatisticValueExpression"in n){o=Je(e,{type:"expression",target:f,valueExpression:n.onStatisticValueExpression,resultType:c}).fieldIndex}else if("onStatisticNormalizationField"in n){l=Je(e,{type:"field",target:f,field:a,resultType:c}).field,u=n.onStatisticNormalizationField}else{l=Je(e,{type:"field",target:f,field:a,resultType:c}).field}Je(e,{type:"statistic",target:"aggregate",name:t,context:r,inField:l,inNormalizationField:u,inFieldIndex:o,statisticType:s})}}(a,i);const u=Ae(a,o,n,s);let c=null;const f=qe(a,o,n),p=q(r.geometryType);let d=r.labelsVisible&&r.labelingInfo||[],m=[];if(l){if("selection"===l.type)throw new t("ValidationError","Mapview does not support `selection` reduction type",l);if(l.symbol){const t=new e({symbol:l.symbol,visualVariables:"visualVariables"in n?n.visualVariables:null});c=Ae(a,o,t,s)}m=l&&l.labelsVisible&&l.labelingInfo||[]}d=ke(d,p),m=ke(m,p);let y=0;const h=[...d.map((e=>Ke(n,a,e,"feature",y++,s))),...m.map((e=>Ke(n,a,e,"aggregate",y++,s)))];return{type:"symbol",target:o,attributes:a,aggregateFields:i,storage:f,mesh:{matcher:u,labels:{type:"simple",classes:h},aggregateMatcher:c}}}}}(r,n)),s}(r,n),u={};l.map((e=>function(e,r,i){switch(i.target){case"feature":return void Ue(e,Le(r),i);case"aggregate":{if(!("featureReduction"in r))return;const n=r.featureReduction;if("selection"===n.type)throw new t("ValidationError","Mapview does not support `selection` reduction type",n);return Ue(e,Le(r),i),void function(e,t,r){e.aggregate||(e.aggregate={name:"aggregate",input:"feature",filters:null,attributes:{},params:{clusterRadius:o(t.clusterRadius/2),clusterPixelBuffer:64*Math.ceil(o(t.clusterMaxSize)/64),fields:r.aggregateFields}});Ce(e.aggregate,r.attributes.fields)}(e,n,i)}}}(u,r,e)));return{source:{definitionExpression:r.definitionExpression,fields:r.fields.map((e=>e.toJSON())),gdbVersion:r.gdbVersion,historicMoment:null==(s=r.historicMoment)?void 0:s.getTime(),outFields:r.availableFields,pixelBuffer:r.pixelBuffer,spatialReference:r.spatialReference.toJSON(),timeExtent:null==(a=r.timeExtent)?void 0:a.toJSON()},attributes:{fields:{},indexCount:0},processors:l,targets:u}}catch(e){if("ValidationError"===e.fieldName)return je.error(e),null;throw e}}function Ce(e,t){for(const r in t){const i=t[r];if(i.target!==e.name)continue;const n=e.attributes[r];n?(n.context.mesh=n.context.mesh||i.context.mesh,n.context.storage=n.context.storage||i.context.storage):e.attributes[r]=i}return e}function Le(e){var t,r,i,n,s;return[null!=(t=null==(r=e.filter)?void 0:r.toJSON())?t:null,null!=(i=null==(n=e.effect)||null==(s=n.filter)?void 0:s.toJSON())?i:null]}function Ue(e,t,r){return e.feature||(e.feature={name:"feature",input:"source",filters:t,attributes:{}}),Ce(e.feature,r.attributes.fields),e}function Be(e,t){return t.field?Je(e,{...t,type:"field",field:t.field}):t.valueExpression?Je(e,{...t,type:"expression",valueExpression:t.valueExpression}):{field:null,fieldIndex:null}}function Je(e,t){switch(t.type){case"expression":{const r=t.valueExpression;if(!e.fields[r]){const i=e.indexCount++;e.fields[r]={...t,name:r,fieldIndex:i}}return{fieldIndex:e.fields[r].fieldIndex}}case"label-expression":{const r=JSON.stringify(t.label);if(!e.fields[r]){const i=e.indexCount++;e.fields[r]={...t,name:r,fieldIndex:i}}return{fieldIndex:e.fields[r].fieldIndex}}case"field":{const r=t.field;return"aggregate"===t.target&&e.fields[r]||(e.fields[r]={...t,name:r}),{field:r}}case"statistic":return e.fields[t.name]={...t},{field:t.name}}}function Ke(e,t,r,i,n,s=!1){const a=Je(t,{type:"label-expression",target:i,context:{mesh:!0},resultType:"string",label:{labelExpression:r.labelExpression,labelExpressionInfo:r.labelExpressionInfo?{expression:r.labelExpressionInfo.expression}:null,symbol:!!r.symbol,where:r.where}}),{fieldIndex:l}=a;return{...Ne(r,e,s),fieldIndex:l,target:i,index:n}}function qe(e,t,r){switch(r.type){case"dot-density":return function(e,t,r){if(!r||!r.length)return{type:"dot-density",mapping:[],target:t};return{type:"dot-density",mapping:r.map(((r,i)=>{const{field:n,fieldIndex:s}=Be(e,{valueExpression:r.valueExpression,field:r.field,resultType:"numeric",target:t});return{binding:i,field:n,fieldIndex:s}})),target:t}}(e,t,r.attributes);case"simple":case"class-breaks":case"unique-value":case"dictionary":return function(e,t,r){if(!r||!r.length)return{type:"visual-variable",mapping:[],target:t};const i={storage:!0},n="numeric";return{type:"visual-variable",mapping:Ve(r).map((r=>{var s;const a=d(r.type),{field:l,fieldIndex:o}=Be(e,{target:t,valueExpression:r.valueExpression,field:r.field,context:i,resultType:n});switch(r.type){case"size":return"$view.scale"===r.valueExpression?null:{type:"size",binding:a,field:l,fieldIndex:o,normalizationField:Be(e,{target:t,field:r.normalizationField,context:i,resultType:n}).field,valueRepresentation:null!=(s=r.valueRepresentation)?s:null};case"color":return{type:"color",binding:a,field:l,fieldIndex:o,normalizationField:Be(e,{target:t,field:r.normalizationField,context:i,resultType:n}).field};case"opacity":return{type:"opacity",binding:a,field:l,fieldIndex:o,normalizationField:Be(e,{target:t,field:r.normalizationField,context:i,resultType:n}).field};case"rotation":return{type:"rotation",binding:a,field:l,fieldIndex:o}}})).filter((e=>e)),target:t}}(e,t,r.visualVariables);case"heatmap":return null}}function Ae(e,r,i,n=!1){const a=s(e,{indexCount:0,fields:{}});switch(i.type){case"simple":case"dot-density":return function(e,t,r,i=!1){const n=t.getSymbols();return{type:"simple",symbol:Ne(n.length?n[0]:null,t,i),isDotDensity:r}}(0,i,"dot-density"===i.type,n);case"class-breaks":return function(e,t,r,i=!1){const n={mesh:!0,use:"renderer.field"},s=r.backgroundFillSymbol,{field:a,fieldIndex:l}=Be(e,{target:t,field:r.field,valueExpression:r.valueExpression,resultType:"numeric",context:n}),o=r.normalizationType,u="log"===o?"esriNormalizeByLog":"percent-of-total"===o?"esriNormalizeByPercentOfTotal":"field"===o?"esriNormalizeByField":null,c=r.classBreakInfos.map((e=>({symbol:Ne(e.symbol,r,i),min:e.minValue,max:e.maxValue}))).sort(((e,t)=>e.min-t.min));return{type:"interval",attributes:e.fields,field:a,fieldIndex:l,backgroundFillSymbol:Ne(s,r,i),defaultSymbol:Ne(r.defaultSymbol,r,i),intervals:c,normalizationField:r.normalizationField,normalizationTotal:r.normalizationTotal,normalizationType:u,isMaxInclusive:r.isMaxInclusive}}(a,r,i,n);case"unique-value":return function(e,r,i,n=!1){const s=[],a=i.backgroundFillSymbol,l={target:r,context:{mesh:!0},resultType:"string"};if(i.field&&"string"!=typeof i.field)throw new t("ValidationError","Expected renderer.field to be a string",i);const{field:o,fieldIndex:u}=Be(e,{...l,field:i.field,valueExpression:i.valueExpression});for(const e of i.uniqueValueInfos)s.push({value:""+e.value,symbol:Ne(e.symbol,i,n)});return{type:"map",attributes:e.fields,field:o,fieldIndex:u,field2:Be(e,{...l,field:i.field2}).field,field3:Be(e,{...l,field:i.field3}).field,fieldDelimiter:i.fieldDelimiter,backgroundFillSymbol:Ne(a,i),defaultSymbol:Ne(i.defaultSymbol,i),map:s}}(a,r,i,n);case"dictionary":return function(e,t,r=!1){return{type:"dictionary",renderer:t.toJSON()}}(0,i,n)}}export{H as P,G as T,Y as a,ue as b,le as c,ae as d,oe as e,Z as f,X as g,Ae as h,Q as i,W as j,Ne as k,me as l,Oe as m,Se as s};
