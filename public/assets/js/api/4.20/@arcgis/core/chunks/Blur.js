/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"./VertexArrayObject.js";import{F as t}from"./FramebufferObject.js";import"../core/lang.js";import"./Texture.js";import{V as e}from"./brushes.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"../core/Error.js";import"./Message.js";import"./mathUtils.js";import"./definitions.js";import"./vec4f32.js";import"./Utils12.js";import"./enums.js";import"./ArrayPool.js";import"./ShaderCompiler.js";import"./Program.js";import"./mat3f32.js";import"./number2.js";import"./vec2f32.js";import"./config.js";import"./GeometryUtils.js";import"./arrayUtils.js";import"./MaterialKey.js";import"./rasterUtils.js";const r=[1,0],s=[0,1];class i{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(t,r,s){const{context:i}=t,{type:o,radius:a}=s;if(0===a)return;this._createOrResizeResources(t),this._quad||(this._quad=new e(i,[-1,-1,1,-1,-1,1,1,1]));const n=this._quad;n.bind(),"blur"===o?this._gaussianBlur(t,r,a):this._radialBlur(t,r),n.unbind()}_gaussianBlur(t,e,i){const{context:o,state:a,painter:n,pixelRatio:l}=t,{size:u}=a,{materialManager:p}=n,m=this._programDesc,d=this._quad,c=[Math.round(l*u[0]),Math.round(l*u[1])],b=this._blurFBO,h=p.getProgram(t,m.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);o.useProgram(h),o.setBlendingEnabled(!1),o.bindFramebuffer(b),o.bindTexture(e.colorTexture,4),h.setUniform1i("u_colorTexture",4),h.setUniform2fv("u_texSize",c),h.setUniform2fv("u_direction",r),h.setUniform1f("u_sigma",i),d.draw(),o.bindFramebuffer(e),o.setStencilWriteMask(0),o.setStencilTestEnabled(!1),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1),o.bindTexture(b.colorTexture,5),h.setUniform1i("u_colorTexture",5),h.setUniform2fv("u_direction",s),d.draw(),o.setBlendingEnabled(!0),o.setBlendFunction(1,771),o.setStencilTestEnabled(!0)}_radialBlur(t,e){const{context:r,painter:s}=t,{materialManager:i}=s,o=this._programDesc,a=this._quad,n=this._blurFBO;r.bindFramebuffer(n);const l=i.getProgram(t,o.radialBlur);r.useProgram(l),r.setBlendingEnabled(!1),r.bindTexture(e.colorTexture,4),l.setUniform1i("u_colorTexture",4),a.draw(),r.bindFramebuffer(e),r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setBlendingEnabled(!0);const u=i.getProgram(t,o.blit);r.useProgram(u),r.bindTexture(n.colorTexture,5),u.setUniform1i("u_texture",5),r.setBlendFunction(1,771),a.draw()}_createOrResizeResources(e){const{context:r,state:s,pixelRatio:i}=e,{size:o}=s,a=Math.round(i*o[0]),n=Math.round(i*o[1]);this._blurFBO&&this._size[0]===a&&this._size[1]===n||(this._size[0]=a,this._size[1]=n,this._blurFBO?this._blurFBO.resize(a,n):this._blurFBO=new t(r,{colorTarget:0,depthStencilTarget:0,width:a,height:n},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:a,height:n}))}}export{i as Blur};
