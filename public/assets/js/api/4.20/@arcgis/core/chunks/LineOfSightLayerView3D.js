/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{b as e,i as s,o,r as i,t as r,j as n,f as a,d as l,m as p}from"../core/lang.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./Logger.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{L as y}from"./LayerView3D.js";import"../geometry.js";import u,{e as d}from"../core/Accessor.js";import j from"../core/Handles.js";import{h,m as g}from"./handleUtils.js";import{createTask as b,ignoreAbortErrors as v}from"../core/promiseUtils.js";import{b as f,j as _,s as C,n as S,f as L,g as O,v as w,X as V,T as A}from"./mathUtils.js";import{c as I,b as E}from"./ray.js";import{I as T}from"./Intersector.js";import{t as P}from"./intersectorUtilsConversions.js";import{I as D,T as U}from"./Scheduler.js";import R from"../geometry/Point.js";import M from"../core/Collection.js";import x from"../Color.js";import{c as F}from"./mat4f64.js";import{L as H}from"./LineVisualElement.js";import z from"../views/layers/LayerView.js";import"./metadata.js";import"../config.js";import"./object.js";import"./string.js";import"./Message.js";import"../core/watchUtils.js";import"../core/Error.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./arrayUtils.js";import"./jsonMap.js";import"./JSONSupport.js";import"./write.js";import"./unitUtils.js";import"./projectionEllipsoid.js";import"../geometry/SpatialReference.js";import"./writer.js";import"./deprecate.js";import"./ArrayPool.js";import"../core/scheduling.js";import"./Ellipsoid.js";import"./reader.js";import"./arcgisLayerUrl.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./Evented.js";import"./vectorStacks.js";import"./quatf64.js";import"./vec2f64.js";import"./vec4f64.js";import"./mat4.js";import"./vec4.js";import"./boundedPlane.js";import"./lineSegment.js";import"./plane.js";import"./sphere.js";import"./Object3D.js";import"./mathUtils2.js";import"./utils4.js";import"./uid.js";import"./Util.js";import"./vec2.js";import"./verticalOffsetUtils.js";import"./mat3.js";import"./quat.js";import"./vec3f32.js";import"./PromiseQueue.js";import"./colorUtils.js";import"./vec4f32.js";import"./Object3DVisualElement.js";import"./VisualElement.js";import"./ColorMaterial.js";import"./VertexColor.glsl.js";import"./Program.js";import"./Texture.js";import"./VertexArrayObject.js";import"./mat4f32.js";import"./geometryDataUtils.js";import"./triangle.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"./BufferView.js";import"../geometry/projection.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./dehydratedFeatures.js";import"./byteSizeEstimations.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../Graphic.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./number.js";import"./locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"./chartMediaInfoUtils.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../support/actions/ActionBase.js";import"./Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/StylePattern3D.js";import"./colors.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../intl.js";import"./Loadable.js";import"./Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"./Thumbnail.js";import"./Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./frustum.js";import"./InterleavedLayout.js";import"./types.js";import"./lineUtils.js";import"./triangulationUtils.js";import"./earcut.js";import"./deduplicate.js";import"./RibbonLineMaterial.js";import"./compilerUtils.js";import"./ElevationProvider.js";import"./PiUtils.glsl.js";import"./MapUtils.js";import"./vec2f32.js";import"./FramebufferObject.js";import"./Camera.js";import"./glUtil.js";import"./PhysicallyBasedRendering.glsl.js";import"../core/HandleOwner.js";let G=class extends u{constructor(t){super(t),this.inputPoints={isValid:!1,observer:f(),target:f(),observerAdjusted:f(),targetAdjusted:f()},this.computationResult={start:f(),end:f(),intersection:f(),isValid:!1,isTargetVisible:!1},this.result=null}updateComputationResults(){this.notifyChange("computationResult")}updateInputPoints(){this.notifyChange("inputPoints")}};t([m()],G.prototype,"target",void 0),t([m()],G.prototype,"inputPoints",void 0),t([m()],G.prototype,"computationResult",void 0),t([m()],G.prototype,"result",void 0),G=t([c("esri.views.3d.layers.analysis.LineOfSight.LineOfSightAnalysis")],G);let B=class extends u{constructor(t){super(t)}};t([m()],B.prototype,"target",void 0),t([m()],B.prototype,"intersectedGraphic",void 0),t([m()],B.prototype,"intersectedLocation",void 0),t([m()],B.prototype,"visible",void 0),B=t([c("esri.views.3d.layers.analysis.LineOfSight.LineOfSightResult")],B);let k=class extends u{constructor(t){super(t),this._tasks=D,this._handles=new j,this._analysisHandles=new j}initialize(){var t;const e=null==(t=this.view.resourceController)?void 0:t.scheduler;e&&(this._tasks=e.registerTask(U.LINE_OF_SIGHT_TOOL));this._handles.add([d((()=>this.layer.observer),(t=>this._onObserverChange(t))),this._connectAnalyses(),this._connectTargets()]),this._intersector=new T(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0}destroy(){this._handles.destroy(),this._analysisHandles.destroy(),this._analyses.removeAll()}get updating(){return this._tasks.updating}get priority(){return this._tasks.priority}set priority(t){this._tasks.priority=t}get _analyses(){return this.layerViewData.analyses}get _observerEngineLocation(){return this.layerViewData.observerEngineLocation}set _observerEngineLocation(t){this.layerViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}getLineOfSightComputationDependencies(t){const{inputPoints:e}=t;return{inputPoints:e}}computeAnalysis(t,e=!1){const{analysis:s}=t,{inputPoints:o,computationResult:i}=s,{observerAdjusted:r,targetAdjusted:n}=o,{start:a,end:l}=i;_(a,r),_(l,n);e||this._canComputeAnalysis(s)?this._computeAnalysisIntersection(t):this._interpolateAnalysisIntersection(t),s.updateComputationResults()}_adjustStartEndPositions(t){const e=this._screenPixelSize,s=this.view,{inputPoints:o}=t,{observer:i,target:r,observerAdjusted:n,targetAdjusted:a}=o,l=N;C(l,r,i);const p=e;S(l,l),L(l,l,Math.min(p,1)),O(n,i,l),C(l,i,r);const m=s.state.camera.computeScreenPixelSizeAt(r);S(l,l),L(l,l,Math.min(m,1)),O(a,r,l)}_computeAnalysisIntersection({analysis:t,interpolationInfo:s}){const{view:o}=this,{sceneIntersectionHelper:i,renderCoordsHelper:r}=o;if(e(i))return;const n=this._intersector,{computationResult:a,inputPoints:l}=t,{observer:p,target:m}=l,{start:c,end:y}=a,u=E(c,y,W);i.intersectToolIntersectorRay(u,n);const d=a.intersection,j=N,h=!!n.results.min&&n.results.min.getIntersectionPoint(d);let g=!0;if(h){_(s.originalIntersection,d),_(s.originalObserver,c),_(s.originalTarget,y),r.fromRenderCoords(d,j,o.spatialReference);const t=1-w(y,m)/w(c,m);g=w(p,d)>=t*w(p,m)}const b=new R(j,o.spatialReference);t.result=new B({target:t.target,intersectedGraphic:g?null:P(n.results.min,o),intersectedLocation:g?null:b,visible:!!h&&g}),a.isValid=l.isValid=!0,a.isTargetVisible=g}_interpolateAnalysisIntersection({analysis:t,interpolationInfo:e}){const{computationResult:s,inputPoints:o}=t,{start:i,end:r,intersection:n}=s,{originalIntersection:a,originalObserver:l,originalTarget:p}=e;if(_(n,a),o.isValid){const t=N,e=w(l,a)/w(l,p);V(t,i,l),L(t,t,1-e),O(n,n,t),V(t,r,p),L(t,t,e),O(n,n,t),s.isValid=!0}else t.result=null,s.isValid=!1,s.isTargetVisible=!1}_canComputeAnalysis(t){const s=this.layer.observer,o=this.view.frustum;if(e(s)||e(t.target)||e(o))return!1;const{observerAdjusted:i,targetAdjusted:r}=t.inputPoints,n=o.intersectsPoint(i),a=o.intersectsPoint(r);return n&&a}_onObserverChange(t){if(e(t))return void this.layer.targets.removeAll();const s=f();this.view.renderCoordsHelper.toRenderCoords(t,s),this._observerEngineLocation=s,this.priority=U.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverChangeForAnalysis(t){t.inputPoints.isValid=!1}_onObserverEngineForAnalysis(t,e){const{inputPoints:s}=t;_(s.observer,e),this._adjustStartEndPositions(t),t.updateInputPoints(),this.priority=U.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetLocationChange(t,e){const{inputPoints:s}=t;s.isValid=!1,this.view.renderCoordsHelper.toRenderCoords(e,s.target),this._adjustStartEndPositions(t),t.updateInputPoints(),this.priority=U.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectAnalysisToTarget(t){return d((()=>({analysis:t,target:t.target})),(({analysis:t,target:e})=>{s(e)&&this._onTargetLocationChange(t,e)}))}_connectAnalysisToObserver(t){return d((()=>({analysis:t,observer:this.layer.observer})),(({analysis:t})=>{this._onObserverChangeForAnalysis(t)}))}_connectAnalysisToObserverEngine(t){return d((()=>({analysis:t,observer:this._observerEngineLocation})),(({analysis:t,observer:e})=>{this._onObserverEngineForAnalysis(t,e)}))}_connectAnalysisForCompute(t){let e=r;const s={analysis:t,interpolationInfo:{originalIntersection:f(),originalObserver:f(),originalTarget:f()}};return h([d((()=>this.getLineOfSightComputationDependencies(t)),(()=>{e=o(e),e=b((async t=>{await v(this._tasks.schedule((()=>this.computeAnalysis(s)),t))}))})),g((()=>e=o(e)))])}_connectAnalysis(t){const e=this._analysisHandles;e.has(t)||e.add([this._connectAnalysisToTarget(t),this._connectAnalysisToObserver(t),this._connectAnalysisToObserverEngine(t),this._connectAnalysisForCompute(t)])}_disconnectAnalysis(t){this._analysisHandles.remove(t)}_onAnalysesCollectionChange(t){t.added.forEach((t=>this._connectAnalysis(t))),t.removed.forEach((t=>this._disconnectAnalysis(t)))}_onTargetsChange(t){return this._analyses.removeAll(),t.items.length>0&&t.forEach((t=>this._addTarget(t))),t.on("change",(t=>this._onTargetCollectionChange(t)))}_onTargetCollectionChange(t){t.added.forEach((t=>this._addTarget(t))),t.removed.forEach((t=>this._removeTarget(t)))}_addTarget(t){const e=this._analyses;e.some((e=>e.target===t))||e.add(new G({target:t}))}_removeTarget(t){const e=this._analyses,s=e.find((e=>e.target===t));e.remove(s)}_connectAnalyses(){let t=null;return h([d((()=>this._analyses),(e=>{t=i(t),t=e.on("change",(t=>this._onAnalysesCollectionChange(t))),e.forEach((t=>this._connectAnalysis(t)))})),g((()=>t=i(t)))])}_connectTargets(){let t=null;return h([d((()=>this.layer.targets),(e=>{t=i(t),t=this._onTargetsChange(e)})),g((()=>t=i(t)))])}};t([m({constructOnly:!0})],k.prototype,"layer",void 0),t([m({constructOnly:!0})],k.prototype,"layerViewData",void 0),t([m({constructOnly:!0})],k.prototype,"view",void 0),t([m()],k.prototype,"updating",null),t([m()],k.prototype,"priority",null),t([m()],k.prototype,"_analyses",null),t([m()],k.prototype,"_observerEngineLocation",null),t([m()],k.prototype,"_screenPixelSize",null),t([m()],k.prototype,"_tasks",void 0),k=t([c("esri.views.3d.layers.analysis.LineOfSight.LineOfSightController")],k);const N=f(),W=I();let q=class extends u{constructor(t){super(t),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new x([3,252,111,1]),this.visibleOuterColor=new x([3,252,111,.15]),this.occludedInnerColor=new x([252,3,69,1]),this.occludedOuterColor=new x([252,3,69,.1]),this.undefinedInnerColor=new x([255,255,255,1]),this.undefinedOuterColor=new x([127,127,127,.2])}};t([m({type:Number})],q.prototype,"innerWidth",void 0),t([m({type:Number})],q.prototype,"outerWidth",void 0),t([m({type:x})],q.prototype,"visibleInnerColor",void 0),t([m({type:x})],q.prototype,"visibleOuterColor",void 0),t([m({type:x})],q.prototype,"occludedInnerColor",void 0),t([m({type:x})],q.prototype,"occludedOuterColor",void 0),t([m({type:x})],q.prototype,"undefinedInnerColor",void 0),t([m({type:x})],q.prototype,"undefinedOuterColor",void 0),q=t([c("esri.views.3d.layers.analysis.LineOfSight.LineOfSightConfiguration")],q);let Q=class extends u{constructor(){super(...arguments),this.analyses=new M,this.configuration=new q,this.observerEngineLocation=f()}};t([m()],Q.prototype,"analyses",void 0),t([m({type:q})],Q.prototype,"configuration",void 0),t([m()],Q.prototype,"observerEngineLocation",void 0),Q=t([c("esri.views.3d.layers.analysis.LineOfSight.LineOfSightLayerViewData")],Q);let J=class extends u{constructor(t){super(t),this._handle=null,this._analysisHandles=new j}initialize(){this._handle=this._connectAnalyses()}destroy(){this._handle=i(this._handle),this._analysisHandles=n(this._analysisHandles)}get _analyses(){return this.layerViewData.analyses}get _configuration(){return this.layerViewData.configuration}createLineOfSightVisualization(){const t=this._configuration,e={view:this.view,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth};return{visibleLineVisualElement:new H({...e,color:x.toUnitRGBA(t.visibleOuterColor),innerColor:x.toUnitRGBA(t.visibleInnerColor)}),occludedLineVisualElement:new H({...e,color:x.toUnitRGBA(t.occludedOuterColor),innerColor:x.toUnitRGBA(t.occludedInnerColor)}),undefinedLineVisualElement:new H({...e,color:x.toUnitRGBA(t.undefinedOuterColor),innerColor:x.toUnitRGBA(t.undefinedInnerColor)})}}destroyLineOfSightVisualization(t){t.visibleLineVisualElement=n(t.visibleLineVisualElement),t.occludedLineVisualElement=n(t.occludedLineVisualElement),t.undefinedLineVisualElement=n(t.undefinedLineVisualElement)}updateLineOfSightVisualization(t,e){const s=this._configuration,{computationResult:o,inputPoints:i}=t,{start:r,end:n,intersection:a,isValid:l,isTargetVisible:p}=o,{observer:m}=i,c=Z;c[12]=m[0],c[13]=m[1],c[14]=m[2];const y=C(X,r,m),u=C(K,n,m),d=C(Y,a,m),{visibleLineVisualElement:j,occludedLineVisualElement:h,undefinedLineVisualElement:g}=e;j.geometry=null,h.geometry=null,g.geometry=null,l?p?(j.geometry=[[A(y),A(u)]],j.transform=c,j.color=x.toUnitRGBA(s.visibleOuterColor)):(j.geometry=[[A(y),A(d)]],j.transform=c,j.color=x.toUnitRGBA(s.occludedOuterColor),h.geometry=[[A(d),A(u)]],h.transform=c):(g.geometry=[[A(y),A(u)]],g.transform=c)}getLineOfSightVisualizationDependencies(t){const{computationResult:e}=t,{occludedOuterColor:s,visibleOuterColor:o}=this._configuration;return{computationResult:e,occludedOuterColor:s,visibleOuterColor:o}}_connectAnalysis(t){const e=this._analysisHandles;if(e.has(t))return;const s=this.createLineOfSightVisualization();e.add([d((()=>this.getLineOfSightVisualizationDependencies(t)),(()=>this.updateLineOfSightVisualization(t,s))),g((()=>this.destroyLineOfSightVisualization(s)))])}_disconnectAnalysis(t){this._analysisHandles.remove(t)}_connectAnalyses(){let t=null;return h([d((()=>this._analyses),(e=>{t=i(t),t=e.on("change",(t=>this._onAnalysesCollectionChange(t))),this._onAnalysesCollectionChange({target:e,added:e.items,removed:[],moved:[]})})),g((()=>t=i(t)))])}_onAnalysesCollectionChange(t){t.added.forEach((t=>this._connectAnalysis(t))),t.removed.forEach((t=>this._disconnectAnalysis(t)))}};t([m({constructOnly:!0})],J.prototype,"layer",void 0),t([m({constructOnly:!0})],J.prototype,"view",void 0),t([m({constructOnly:!0})],J.prototype,"layerViewData",void 0),t([m()],J.prototype,"_analyses",null),t([m()],J.prototype,"_configuration",null),J=t([c("esri.views.3d.layers.analysis.LineOfSight.LineOfSightView")],J);const X=f(),K=f(),Y=f(),Z=F();let $=class extends(y(z)){constructor(){super(...arguments),this.type="line-of-sight-3d",this._layerViewData=new Q}initialize(){const t=this.view,e=this.layer,s=this._layerViewData;this._analysisController=new k({layer:e,layerViewData:s,view:t}),this._analysisView=new J({layer:e,layerViewData:s,view:t})}destroy(){this._analysisController=n(this._analysisController),this._analysisView=n(this._analysisView)}get results(){return this._layerViewData.analyses.map((t=>t.result))}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}getResultForTarget(t){const e=this._layerViewData.analyses.find((e=>e.target===t)),s=a(e,(t=>t.result));return l(s,null)}isUpdating(){return p(this._analysisController,!1,(t=>t.updating))}};t([m({readOnly:!0})],$.prototype,"type",void 0),t([m()],$.prototype,"layer",void 0),t([m({readOnly:!0})],$.prototype,"results",null),t([m()],$.prototype,"priority",null),t([m()],$.prototype,"_layerViewData",void 0),t([m()],$.prototype,"_analysisController",void 0),t([m()],$.prototype,"_analysisView",void 0),$=t([c("esri.views.3d.layers.LineOfSightLayerView3D")],$);var tt=$;export default tt;export{$ as LineOfSightLayerView3D};
