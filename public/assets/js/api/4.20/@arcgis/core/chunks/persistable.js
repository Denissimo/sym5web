/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{i as t,b as r,c as e}from"../core/lang.js";import{i}from"./multiOriginJSONSupportUtils.js";import{getPathExtension as o,isAbsolute as n,isBlobProtocol as s,join as p}from"../core/urlUtils.js";import{g as a}from"./uuid.js";import{a as u}from"./metadata.js";import{n as c}from"../core/Accessor.js";import{propertyJSONMeta as l}from"../core/accessorSupport/decorators/property.js";import{r as f,t as m,i as g,p as y}from"./persistableUrlUtils.js";function d(t){return h[function(t){if(t instanceof Blob)return t.type;return function(t){const r=o(t);return w[r]||v}(t.url)}(t)]||j}const h={},v="text/plain",j=h[v],w={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(const t in w)h[w[t]]=t;function U(e){const p=t(e)&&e.origins?e.origins:[void 0];return(a,h)=>{const v=function(e,p,a){if(t(e)&&"resource"===e.type)return function(e,p,a){const l=u(p,a);return{type:String,read:(t,r,e)=>{const i=f(t,r,e);return l.type===String?i:"function"==typeof l.type?new l.type({url:i}):void 0},write:{writer(p,u,f,y){if(!y||!y.resources)return"string"==typeof p?void(u[f]=m(p,y)):void(u[f]=p.write({},y));const h=function(t){if(r(t))return null;if("string"==typeof t)return t;return t.url}(p),v=h?m(h,{...y,verifyItemRelativeUrls:y&&y.verifyItemRelativeUrls?{writtenUrls:y.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null},1):null,j=l.type!==String&&(!i(this)||y&&y.origin&&this.originIdOf(a)>c(y.origin));y&&y.portalItem&&t(v)&&!n(v)?j?function(t,r,e,i,n,s,p,a){const u=p.portalItem.resourceFromPath(i),c=I(e,i,p),l=d(c),f=o(u.path);if(l!==f)return void b(t,r,e,i,n,s,p,a);x(t,r,u,c,p.resources.toUpdate),n[s]=i}(this,a,p,v,u,f,y,e):function(t,r,e,i){i.resources.toKeep.push({resource:i.portalItem.resourceFromPath(t)}),r[e]=t}(v,u,f,y):y&&y.portalItem&&(r(v)||t(g(v))||s(v)||j)?b(this,a,p,v,u,f,y,e):u[f]=v}}}}(e,p,a);switch(t(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:t,write:r}=y;return{read:t,write:r}}}}(e,a,h);for(const t of p){const r=l(a,t,h);for(const t in v)r[t]=v[t]}}}function b(t,r,i,o,n,u,c,l){const f=a(),m=I(i,o,c),g=p(e(l,"prefix"),f),y=`${g}.${d(m)}`,h=c.portalItem.resourceFromPath(y);s(o)&&c.resources.pendingOperations.push(async function(t){const r=(await import("../request.js").then((function(t){return t.r}))).default,{data:e}=await r(t,{responseType:"blob"});return e}(o).then((t=>{h.path=`${g}.${d(t)}`,n[u]=h.itemRelativeUrl})).catch((()=>{}))),x(t,r,h,m,c.resources.toAdd),n[u]=h.itemRelativeUrl}function x(t,r,e,i,o){o.push({resource:e,content:i,finish:e=>{!function(t,r,e){"string"==typeof t[r]?t[r]=e.url:t[r].url=e.url}(t,r,e)}})}function I(t,r,e){return"string"==typeof t?{url:r}:new Blob([JSON.stringify(t.toJSON(e))],{type:"application/json"})}export{U as p};
