/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{eachAlways as t}from"../core/promiseUtils.js";import e from"../geometry/Point.js";import{h as s,b as r,i}from"../core/lang.js";import{e as o,f as n}from"./quat.js";import{I as a,e as c,d as h}from"./quatf64.js";import{e as u,s as l,a as f,aa as m,n as p,b as d,z as g,Z as b,u as A,O as x}from"./mathUtils.js";import w from"../geometry/support/MeshMaterialMetallicRoughness.js";import{c as y}from"./georeference.js";import"../geometry.js";import E from"../core/Error.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"./Message.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./metadata.js";import"./handleUtils.js";import"../core/accessorSupport/decorators/cast.js";import"./reader.js";import"../core/accessorSupport/decorators/subclass.js";import"./writer.js";import"../geometry/Geometry.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"./ArrayPool.js";import"./arrayUtils.js";import"../core/scheduling.js";import"./write.js";import"../geometry/SpatialReference.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"./vec4.js";import"../Color.js";import"./colorUtils.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"./persistableUrlUtils.js";import"../core/urlUtils.js";import"./screenshotUtils.js";import"./unitUtils.js";import"./jsonMap.js";import"./projectionEllipsoid.js";import"./mat4.js";import"./mat4f64.js";import"./mat3.js";import"../geometry/projection.js";import"../geometry/Extent.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./aaBoundingRect.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./axisAngleDegrees.js";import"./BufferView.js";import"./vec2.js";import"./vec3.js";import"./projection.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";class v{constructor(t,e){if(!t)throw new Error("GLB requires a JSON gltf chunk");this.length=v.HEADER_SIZE,this.length+=v.CHUNK_HEADER_SIZE;const s=this.textToArrayBuffer(t);if(this.length+=this.alignTo(s.byteLength,4),e&&(this.length+=v.CHUNK_HEADER_SIZE,this.length+=e.byteLength,e.byteLength%4))throw new Error("Expected BIN chunk length to be divisible by 4 at this point");this.buffer=new ArrayBuffer(this.length),this.outView=new DataView(this.buffer),this.writeHeader();const r=this.writeChunk(s,12,1313821514,32);e&&this.writeChunk(e,r,5130562)}writeHeader(){this.outView.setUint32(0,v.MAGIC,!0),this.outView.setUint32(4,v.VERSION,!0),this.outView.setUint32(8,this.length,!0)}writeChunk(t,e,s,r=0){const i=this.alignTo(t.byteLength,4);for(this.outView.setUint32(e,i,!0),this.outView.setUint32(e+=4,s,!0),this.writeArrayBuffer(this.outView.buffer,t,e+=4,0,t.byteLength),e+=t.byteLength;e%4;)r&&this.outView.setUint8(e,r),e++;return e}writeArrayBuffer(t,e,s,r,i){new Uint8Array(t,s,i).set(new Uint8Array(e,r,i),0)}textToArrayBuffer(t){if(s("esri-text-encoder"))return(new TextEncoder).encode(t).buffer;const e=new Uint8Array(t.length);for(let s=0;s<e.length;++s)e[s]=t.charCodeAt(s);return e.buffer}alignTo(t,e){return e*Math.ceil(t/e)}}var T,R,j,C,B,M,O;v.HEADER_SIZE=12,v.CHUNK_HEADER_SIZE=8,v.MAGIC=1179937895,v.VERSION=2,function(t){t[t.External=0]="External",t[t.DataURI=1]="DataURI",t[t.GLB=2]="GLB"}(T||(T={})),function(t){t[t.External=0]="External",t[t.DataURI=1]="DataURI",t[t.GLB=2]="GLB"}(R||(R={})),function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(j||(j={})),function(t){t.SCALAR="SCALAR",t.VEC2="VEC2",t.VEC3="VEC3",t.VEC4="VEC4",t.MAT2="MAT2",t.MAT3="MAT3",t.MAT4="MAT4"}(C||(C={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(B||(B={})),function(t){t.OPAQUE="OPAQUE",t.MASK="MASK",t.BLEND="BLEND"}(M||(M={})),function(t){t[t.NoColor=0]="NoColor",t[t.FaceColor=1]="FaceColor",t[t.VertexColor=2]="VertexColor"}(O||(O={}));class S{constructor(t,e,s,r,i){this.buffer=t,this.componentType=s,this.dataType=r,this.data=[],this.isFinalized=!1,this.accessorIndex=-1,this.accessorAttribute=null,this.accessorMin=null,this.accessorMax=null,e.bufferViews||(e.bufferViews=[]),this.index=e.bufferViews.length,this.bufferView={buffer:t.index,byteLength:-1,target:i};const o=this.getElementSize();o>=4&&i!==j.ELEMENT_ARRAY_BUFFER&&(this.bufferView.byteStride=o),e.bufferViews.push(this.bufferView)}push(t){const e=this.data.length;if(this.data.push(t),this.accessorIndex>=0){const s=e%this.numComponentsForDataType(),r=this.accessorMin[s];this.accessorMin[s]="number"!=typeof r?t:Math.min(r,t);const i=this.accessorMax[s];this.accessorMax[s]="number"!=typeof i?t:Math.max(i,t)}}get dataSize(){return this.data.length*this.sizeComponentType()}get size(){return t=this.dataSize,(e=4)*Math.ceil(t/e);var t,e}getByteOffset(){if(!this.isFinalized)throw new Error("Cannot get BufferView offset until it is finalized");return this.buffer.getByteOffset(this)}get byteOffset(){if(!this.isFinalized)throw new Error("Cannot get BufferView offset until it is finalized");return this.buffer.getByteOffset(this)}writeOutToBuffer(t,e=this.size){const s=new DataView(t,e),r=this.sizeComponentType();for(let t=0;t<this.data.length;++t)this.writeValue(s,t*r,this.data[t])}writeAsync(t){if(this.asyncWritePromise)throw new Error("Can't write multiple bufferView vlaues asynchronously");return this.asyncWritePromise=t.then((t=>{const e=new Uint8Array(t);for(let t=0;t<e.byteLength;++t)this.data.push(e[t]);delete this.asyncWritePromise})),this.asyncWritePromise}startAccessor(t){if(this.accessorIndex>=0)throw new Error("Accessor was started without ending the previous one");this.accessorIndex=this.data.length,this.accessorAttribute=t;const e=this.numComponentsForDataType();this.accessorMin=new Array(e),this.accessorMax=new Array(e)}endAccessor(){if(this.accessorIndex<0)throw new Error("An accessor was not started, but was attempted to be ended");const t=this.getElementSize(),e=this.numComponentsForDataType(),s=(this.data.length-this.accessorIndex)/e;if(s%1)throw new Error("An accessor was ended with missing component values");for(let t=0;t<this.accessorMin.length;++t)"number"!=typeof this.accessorMin[t]&&(this.accessorMin[t]=0),"number"!=typeof this.accessorMax[t]&&(this.accessorMax[t]=0);const r={byteOffset:t*(this.accessorIndex/e),componentType:this.componentType,count:s,type:this.dataType,min:this.accessorMin,max:this.accessorMax,name:this.accessorAttribute};switch(this.accessorAttribute){case"TEXCOORD_0":case"TEXCOORD_1":case"COLOR_0":case"WEIGHTS_0":switch(this.componentType){case 5121:case 5123:r.normalized=!0}}return this.accessorIndex=-1,this.accessorAttribute=null,this.accessorMin=null,this.accessorMax=null,r}get finalized(){return this.finalizedPromise?this.finalizedPromise:this.isFinalized?this.finalizedPromise=Promise.resolve():this.finalizedPromise=new Promise((t=>this.finalizedPromiseResolve=t))}finalize(){const e=this.bufferView;return new Promise((e=>{const s=this.buffer.getViewFinalizePromises(this);this.asyncWritePromise&&s.push(this.asyncWritePromise),e(t(s))})).then((()=>{this.isFinalized=!0,e.byteOffset=this.getByteOffset(),e.byteLength=this.dataSize,this.finalizedPromiseResolve&&this.finalizedPromiseResolve()}))}getElementSize(){return this.sizeComponentType()*this.numComponentsForDataType()}sizeComponentType(){switch(this.componentType){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5125:case 5126:return 4}}numComponentsForDataType(){switch(this.dataType){case C.SCALAR:return 1;case C.VEC2:return 2;case C.VEC3:return 3;case C.VEC4:case C.MAT2:return 4;case C.MAT3:return 9;case C.MAT4:return 16}}writeValue(t,e,s){switch(this.componentType){case 5120:t.setInt8(e,s);break;case 5121:t.setUint8(e,s);break;case 5122:t.setInt16(e,s,!0);break;case 5123:t.setUint16(e,s,!0);break;case 5125:t.setUint32(e,s,!0);break;case 5126:t.setFloat32(e,s,!0);break;default:throw new Error(`Unsupported data type: ${this.componentType}`)}}}class L{constructor(t){this.gltf=t,this.bufferViews=[],this.isFinalized=!1,t.buffers||(t.buffers=[]),this.index=t.buffers.length;const e={byteLength:-1};t.buffers.push(e),this.buffer=e}addBufferView(t,e,s){if(this.finalizePromise)throw new Error("Cannot add buffer view after fiinalizing buffer");const r=new S(this,this.gltf,t,e,s);return this.bufferViews.push(r),r}getByteOffset(t){let e=0;for(const s of this.bufferViews){if(s===t)return e;e+=s.size}throw new Error("Given bufferView was not present in this buffer")}getViewFinalizePromises(t){const e=[];for(const s of this.bufferViews){if(t&&s===t)return e;e.push(s.finalized)}return e}getArrayBuffer(){if(!this.isFinalized)throw new Error("Cannot get ArrayBuffer from Buffer before it is finalized");const t=this.getTotalSize(),e=new ArrayBuffer(t);let s=0;for(const t of this.bufferViews)t.writeOutToBuffer(e,s),s+=t.size;return e}finalize(){if(this.finalizePromise)throw new Error(`Buffer ${this.index} was already finalized`);return this.finalizePromise=new Promise((e=>{e(t(this.getViewFinalizePromises()))})).then((()=>{this.isFinalized=!0;const t=this.getArrayBuffer();this.buffer.byteLength=t.byteLength,this.buffer.uri=t})),this.gltf.extras.promises.push(this.finalizePromise),this.finalizePromise}getTotalSize(){let t=0;for(const e of this.bufferViews)t+=e.size;return t}}function z(t,e){r(t.vertexAttributes.normal)&&(t.vertexAttributes.normal=new Float32Array(t.vertexAttributes.position.length));const s=e.faces.length/3;for(let r=0;r<s;++r){const s=e.faces[3*r+0],i=e.faces[3*r+1],o=e.faces[3*r+2],n=u(V,t.vertexAttributes.position[3*s+0],t.vertexAttributes.position[3*s+1],t.vertexAttributes.position[3*s+2]),a=u(I,t.vertexAttributes.position[3*i+0],t.vertexAttributes.position[3*i+1],t.vertexAttributes.position[3*i+2]),c=u(N,t.vertexAttributes.position[3*o+0],t.vertexAttributes.position[3*o+1],t.vertexAttributes.position[3*o+2]),h=l(a,a,n),p=l(c,c,n),d=f(h,h,p);m(t.vertexAttributes.normal[3*s+0])&&(t.vertexAttributes.normal[3*s+0]=0),m(t.vertexAttributes.normal[3*s+1])&&(t.vertexAttributes.normal[3*s+1]=0),m(t.vertexAttributes.normal[3*s+2])&&(t.vertexAttributes.normal[3*s+2]=0),m(t.vertexAttributes.normal[3*i+0])&&(t.vertexAttributes.normal[3*i+0]=0),m(t.vertexAttributes.normal[3*i+1])&&(t.vertexAttributes.normal[3*i+1]=0),m(t.vertexAttributes.normal[3*i+2])&&(t.vertexAttributes.normal[3*i+2]=0),m(t.vertexAttributes.normal[3*o+0])&&(t.vertexAttributes.normal[3*o+0]=0),m(t.vertexAttributes.normal[3*o+1])&&(t.vertexAttributes.normal[3*o+1]=0),m(t.vertexAttributes.normal[3*o+2])&&(t.vertexAttributes.normal[3*o+2]=0),t.vertexAttributes.normal[3*s+0]+=d[0],t.vertexAttributes.normal[3*s+1]+=d[1],t.vertexAttributes.normal[3*s+2]+=d[2],t.vertexAttributes.normal[3*i+0]+=d[0],t.vertexAttributes.normal[3*i+1]+=d[1],t.vertexAttributes.normal[3*i+2]+=d[2],t.vertexAttributes.normal[3*o+0]+=d[0],t.vertexAttributes.normal[3*o+1]+=d[1],t.vertexAttributes.normal[3*o+2]+=d[2]}for(let e=0;e<t.vertexAttributes.normal.length;e+=3)u(U,t.vertexAttributes.normal[e],t.vertexAttributes.normal[e+1],t.vertexAttributes.normal[e+2]),p(U,U),t.vertexAttributes.normal[e+0]=U[0],t.vertexAttributes.normal[e+1]=U[1],t.vertexAttributes.normal[e+2]=U[2]}const V=d(),I=d(),N=d(),U=d();async function F(t){const e=P(t);if(r(e))throw new E("imageToArrayBuffer","Unsupported image type");const s=async t=>{if(!t)throw new E("imageToArrayBuffer","Unable to convert image to PNG");const e=new FileReader,s=new Promise((t=>{e.addEventListener("loadend",(()=>{t(e.result)}))}));return e.readAsArrayBuffer(t),s};if(e.toBlob)return new Promise(((t,r)=>{e.toBlob((e=>{s(e).then(t,r)}),"image/png")}));if("msToBlob"in e)return s(e.msToBlob());throw new E("imageToArrayBuffer","Could not convert canvas to blob")}function P(t){if(t instanceof HTMLCanvasElement)return t;if(t instanceof HTMLVideoElement)return null;const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");return t instanceof HTMLImageElement?s.drawImage(t,0,0,t.width,t.height):t instanceof ImageData&&s.putImageData(t,t.width,t.height),e}class _{constructor(t,e,s){this.params={},this.materialMap=new Array,this.gltf={asset:{version:"2.0",copyright:t.copyright,generator:t.generator},extras:{options:e,binChunkBuffer:null,promises:[]}},s&&(this.params=s),this.addScenes(t)}addScenes(t){this.gltf.scene=t.defaultScene;const e=this.gltf.extras.options.bufferOutputType===T.GLB||this.gltf.extras.options.imageOutputType===R.GLB;e&&(this.gltf.extras.binChunkBuffer=new L(this.gltf)),t.forEachScene((t=>{this.addScene(t)})),e&&this.gltf.extras.binChunkBuffer.finalize()}addScene(t){this.gltf.scenes||(this.gltf.scenes=[]);const e={};t.name&&(e.name=t.name),t.forEachNode((t=>{e.nodes||(e.nodes=[]);const s=this.addNode(t);e.nodes.push(s)})),this.gltf.scenes.push(e)}addNode(t){this.gltf.nodes||(this.gltf.nodes=[]);const e={};t.name&&(e.name=t.name);const s=t.translation;g(s,b)||(e.translation=A(s));const r=t.rotation;o(r,a)||(e.rotation=c(r));const i=t.scale;g(i,x)||(e.scale=A(i)),t.mesh&&t.mesh.vertexAttributes.position?e.mesh=this.addMesh(t.mesh):t.forEachNode((t=>{e.children||(e.children=[]);const s=this.addNode(t);e.children.push(s)}));const n=this.gltf.nodes.length;return this.gltf.nodes.push(e),n}addMesh(t){this.gltf.meshes||(this.gltf.meshes=[]);const s={primitives:[]},r=this.gltf.extras.options.bufferOutputType===T.GLB;let o;o=r?this.gltf.extras.binChunkBuffer:new L(this.gltf);const n=t.clone();this.params.origin||(this.params.origin=function(t){if(i(t.transform))return t.transform.getOriginPoint(t.spatialReference);const s=t.extent.xmax-t.extent.width/2,r=t.extent.ymax-t.extent.height/2,o=t.extent.zmin;return new e({x:s,y:r,z:o,spatialReference:t.extent.spatialReference})}(n)),n.rotate(-90,0,0,{origin:this.params.origin}),function(t){if(t.components){for(const e of t.components)"smooth"===e.shading&&e.faces&&z(t,e);t.vertexAttributesChanged()}}(n);const a=y(n.vertexAttributes,n.transform,this.params.origin,{geographic:this.params.geographic,unit:"meters"});n.vertexAttributes.position=a.position,n.vertexAttributes.normal=a.normal,n.vertexAttributes.tangent=a.tangent;const c=o.addBufferView(5126,C.VEC3,j.ARRAY_BUFFER);let h,u,l,f;n.vertexAttributes.normal&&(h=o.addBufferView(5126,C.VEC3,j.ARRAY_BUFFER)),n.vertexAttributes.uv&&(u=o.addBufferView(5126,C.VEC2,j.ARRAY_BUFFER)),n.vertexAttributes.tangent&&(l=o.addBufferView(5126,C.VEC4,j.ARRAY_BUFFER)),n.vertexAttributes.color&&(f=o.addBufferView(5121,C.VEC4,j.ARRAY_BUFFER)),c.startAccessor("POSITION"),h&&h.startAccessor("NORMAL"),u&&u.startAccessor("TEXCOORD_0"),l&&l.startAccessor("TANGENT"),f&&f.startAccessor("COLOR_0");const m=n.vertexAttributes.position.length/3;for(let t=0;t<m;++t)c.push(n.vertexAttributes.position[3*t+0]),c.push(n.vertexAttributes.position[3*t+1]),c.push(n.vertexAttributes.position[3*t+2]),h&&i(n.vertexAttributes.normal)&&(h.push(n.vertexAttributes.normal[3*t+0]),h.push(n.vertexAttributes.normal[3*t+1]),h.push(n.vertexAttributes.normal[3*t+2])),u&&i(n.vertexAttributes.uv)&&(u.push(n.vertexAttributes.uv[2*t+0]),u.push(n.vertexAttributes.uv[2*t+1])),l&&i(n.vertexAttributes.tangent)&&(l.push(n.vertexAttributes.tangent[4*t+0]),l.push(n.vertexAttributes.tangent[4*t+1]),l.push(n.vertexAttributes.tangent[4*t+2]),l.push(n.vertexAttributes.tangent[4*t+3])),f&&i(n.vertexAttributes.color)&&(f.push(n.vertexAttributes.color[4*t+0]),f.push(n.vertexAttributes.color[4*t+1]),f.push(n.vertexAttributes.color[4*t+2]),f.push(n.vertexAttributes.color[4*t+3]));const p=c.endAccessor(),d=this.addAccessor(c.index,p);let g,b,A,x,w;if(h){const t=h.endAccessor();g=this.addAccessor(h.index,t)}if(u){const t=u.endAccessor();b=this.addAccessor(u.index,t)}if(l){const t=l.endAccessor();A=this.addAccessor(l.index,t)}if(f){const t=f.endAccessor();x=this.addAccessor(f.index,t)}n.components&&n.components.length>0&&n.components[0].faces?(w=o.addBufferView(5125,C.SCALAR,j.ELEMENT_ARRAY_BUFFER),this.addMeshVertexIndexed(w,n.components,s,d,g,b,A,x)):this.addMeshVertexNonIndexed(n.components,s,d,g,b,A,x),c.finalize(),h&&h.finalize(),u&&u.finalize(),l&&l.finalize(),w&&w.finalize(),f&&f.finalize(),r||o.finalize();const E=this.gltf.meshes.length;return this.gltf.meshes.push(s),E}addMaterial(t){if(null===t)return;const e=this.materialMap.indexOf(t);if(-1!==e)return e;this.gltf.materials||(this.gltf.materials=[]);const s={};switch(t.alphaMode){case"mask":s.alphaMode=M.MASK;break;case"auto":case"blend":s.alphaMode=M.BLEND}.5!==t.alphaCutoff&&(s.alphaCutoff=t.alphaCutoff),t.doubleSided&&(s.doubleSided=t.doubleSided),s.pbrMetallicRoughness={};const r=t=>t**2.1,o=t=>{const e=t.toRgba();return e[0]=r(e[0]/255),e[1]=r(e[1]/255),e[2]=r(e[2]/255),e};if(i(t.color)&&(s.pbrMetallicRoughness.baseColorFactor=o(t.color)),i(t.colorTexture)&&(s.pbrMetallicRoughness.baseColorTexture={index:this.addTexture(t.colorTexture)}),i(t.normalTexture)&&(s.normalTexture={index:this.addTexture(t.normalTexture)}),t instanceof w){if(i(t.emissiveTexture)&&(s.emissiveTexture={index:this.addTexture(t.emissiveTexture)}),i(t.emissiveColor)){const e=o(t.emissiveColor);s.emissiveFactor=[e[0],e[1],e[2]]}i(t.occlusionTexture)&&(s.occlusionTexture={index:this.addTexture(t.occlusionTexture)}),i(t.metallicRoughnessTexture)&&(s.pbrMetallicRoughness.metallicRoughnessTexture={index:this.addTexture(t.metallicRoughnessTexture)}),s.pbrMetallicRoughness.metallicFactor=t.metallic,s.pbrMetallicRoughness.roughnessFactor=t.roughness}else s.pbrMetallicRoughness.metallicFactor=1,s.pbrMetallicRoughness.roughnessFactor=1;const n=this.gltf.materials.length;return this.gltf.materials.push(s),this.materialMap.push(t),n}addTexture(t){this.gltf.textures||(this.gltf.textures=[]);const e={sampler:this.addSampler(t),source:this.addImage(t)},s=this.gltf.textures.length;return this.gltf.textures.push(e),s}addImage(t){this.gltf.images||(this.gltf.images=[]);const e={};if(t.url)e.uri=t.url;else{e.extras=t.data;for(let e=0;e<this.gltf.images.length;++e)if(t.data===this.gltf.images[e].extras)return e;switch(this.gltf.extras.options.imageOutputType){case R.GLB:{const s=this.gltf.extras.binChunkBuffer.addBufferView(5121,C.SCALAR);s.writeAsync(F(t.data)).then((()=>{s.finalize()})),e.bufferView=s.index,e.mimeType="image/png";break}case R.DataURI:e.uri=function(t){const e=P(t);return i(e)?e.toDataURL():""}(t.data);break;default:this.gltf.extras.promises.push(F(t.data).then((t=>{e.uri=t})))}}const s=this.gltf.images.length;return this.gltf.images.push(e),s}addSampler(t){this.gltf.samplers||(this.gltf.samplers=[]);let e=10497,s=10497;if("string"==typeof t.wrap)switch(t.wrap){case"clamp":e=33071,s=33071;break;case"mirror":e=33648,s=33648}else{switch(t.wrap.vertical){case"clamp":s=33071;break;case"mirror":s=33648}switch(t.wrap.horizontal){case"clamp":e=33071;break;case"mirror":e=33648}}const r={wrapS:e,wrapT:s};for(let t=0;t<this.gltf.samplers.length;++t)if(JSON.stringify(r)===JSON.stringify(this.gltf.samplers[t]))return t;const i=this.gltf.samplers.length;return this.gltf.samplers.push(r),i}addAccessor(t,e){this.gltf.accessors||(this.gltf.accessors=[]);const s={bufferView:t,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type,min:e.min,max:e.max,name:e.name};e.normalized&&(s.normalized=!0);const r=this.gltf.accessors.length;return this.gltf.accessors.push(s),r}addMeshVertexIndexed(t,e,s,r,i,o,n,a){for(const c of e){t.startAccessor("INDICES");for(let e=0;e<c.faces.length;++e)t.push(c.faces[e]);const e=t.endAccessor(),h={attributes:{POSITION:r},indices:this.addAccessor(t.index,e),material:this.addMaterial(c.material)};i&&"flat"!==c.shading&&(h.attributes.NORMAL=i),o&&(h.attributes.TEXCOORD_0=o),n&&"flat"!==c.shading&&(h.attributes.TANGENT=n),a&&(h.attributes.COLOR_0=a),s.primitives.push(h)}}addMeshVertexNonIndexed(t,e,s,r,i,o,n){const a={attributes:{POSITION:s}};r&&(a.attributes.NORMAL=r),i&&(a.attributes.TEXCOORD_0=i),o&&(a.attributes.TANGENT=o),n&&(a.attributes.COLOR_0=n),t&&(a.material=this.addMaterial(t[0].material)),e.primitives.push(a)}}class G{constructor(){this.copyright="",this.defaultScene=0,this.generator="",this._scenes=[]}addScene(t){if(this._scenes.indexOf(t)>=0)throw new Error("Scene already added");this._scenes.push(t)}removeScene(t){const e=this._scenes.indexOf(t);e>=0&&this._scenes.splice(e,1)}forEachScene(t){this._scenes.forEach(t)}}class D{constructor(){this.name="",this.nodes=[]}addNode(t){if(this.nodes.indexOf(t)>=0)throw new Error("Node already added");this.nodes.push(t)}forEachNode(t){this.nodes.forEach(t)}}class k{constructor(){this.name="",this.mesh=null,this.translation=d(),this.rotation=h(),this.scale=A(x),this.nodes=[]}addNode(t){if(this.nodes.indexOf(t)>=0)throw new Error("Node already added");this.nodes.push(t)}forEachNode(t){this.nodes.forEach(t)}set rotationAngles(t){n(this.rotation,t[0],t[1],t[2])}}function H(s,r,i){const o=new _(s,r=r||{},i);let n=o.params;n?n.origin||(n.origin=new e({x:-1,y:-1,z:-1})):n={origin:new e({x:-1,y:-1,z:-1})};const a=n.origin,c=o.gltf,h=c.extras.promises;let u=1,l=1,f=null;return t(h).then((()=>{const t={origin:a};delete c.extras;const e="number"==typeof r.jsonSpacing?r.jsonSpacing:4,s=JSON.stringify(c,((e,s)=>{if("extras"!==e){if(s instanceof ArrayBuffer){if(function(t){if(t.byteLength<8)return!1;const e=new Uint8Array(t);return 137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]}(s))switch(r.imageOutputType){case R.DataURI:case R.GLB:break;case R.External:default:{const e=`img${l}.png`;return l++,t[e]=s,e}}switch(r.bufferOutputType){case T.DataURI:return function(t){const e=[],s=new Uint8Array(t);for(let t=0;t<s.length;t++)e.push(String.fromCharCode(s[t]));return"data:application/octet-stream;base64,"+btoa(e.join(""))}(s);case T.GLB:if(f)throw new Error("Already encountered an ArrayBuffer, there should only be one in the GLB format.");return void(f=s);case T.External:default:{const e=`data${u}.bin`;return u++,t[e]=s,e}}}return s}}),e);return r.bufferOutputType===T.GLB||r.imageOutputType===R.GLB?t["model.glb"]=new v(s,f).buffer:t["model.gltf"]=s,t}))}class Y{constructor(t,e){this.file={type:"model/gltf-binary",data:t},this.origin=e}buffer(){return Promise.resolve(this.file)}download(t){return new Promise((()=>{const e=new Blob([this.file.data],{type:this.file.type});let s=t;s||(s="model.glb");if("glb"!==s.split(".").pop()&&(s+=".glb"),window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,s);else{const t=document.createElement("a"),r=URL.createObjectURL(e);t.href=r,t.download=s,document.body.appendChild(t),t.click(),setTimeout((function(){document.body.removeChild(t),window.URL.revokeObjectURL(r)}),0)}}))}}function W(t,e){const s=new G,r=new D;s.addScene(r);const i=new k;return r.addNode(i),i.mesh=t,function(t,e){return H(t,{bufferOutputType:T.GLB,imageOutputType:R.GLB,jsonSpacing:0},e)}(s,e).then((t=>new Y(t["model.glb"],t.origin)))}export{W as toBinaryGLTF};
