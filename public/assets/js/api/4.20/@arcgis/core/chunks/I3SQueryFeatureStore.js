/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"../geometry.js";import t from"../core/Accessor.js";import{i as r,P as s}from"./arrayUtils.js";import{L as n}from"./Logger.js";import{b as i,i as o}from"../core/lang.js";import{z as a}from"./unitUtils.js";import{whenOnce as c}from"../core/watchUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as u}from"../core/accessorSupport/decorators/subclass.js";import{x as p,g as d,e as y}from"./mathUtils.js";import{WhereClause as f}from"../core/sql/WhereClause.js";import{projectBoundingSphere as h,load as g,project as m,projectVectorToVector as j}from"../geometry/projection.js";import{c as b,t as S}from"./aaBoundingBox.js";import{f as w,u as E,b as x,a as I,d as O}from"./aaBoundingRect.js";import{canProject as R,project as F}from"../geometry/support/webMercatorUtils.js";import{p as v,j as Q,n as _}from"./I3SUtil.js";import M from"../views/layers/support/FeatureFilter.js";import G from"../geometry/SpatialReference.js";import C from"../core/Error.js";import J from"../core/Handles.js";import N from"../geometry/Extent.js";import{Q as A}from"./QueryEngine.js";import V from"../rest/support/FeatureSet.js";import B from"../rest/support/Query.js";import{g as W}from"./centroid.js";import{a as k}from"./OptimizedFeature.js";import{E as L}from"./Evented.js";import{a as T}from"./vec4f64.js";const q=n.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let U,D=class extends t{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){c(this,"filter.geometry").then((()=>this.loadAsyncModule(async function(){if(U)return U;return U=await import("../geometry/geometryEngine.js"),U}().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))}get sortedObjectIds(){if(i(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=o(this.filter)?this.filter.where:null;if(i(e)||!e)return null;try{return f.create(e,this.layerFieldsIndex)}catch(e){q.error(`Failed to parse filter where clause: ${e}`)}return null}addFilters(e,t,r,s){const n=this.sortedObjectIds;o(n)&&e.push((e=>v(n,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const i=this.parsedGeometry;if(o(i)){const n=this.spatialRelationship;e.push(((e,o)=>function(e,t,r,s,n,i,o){const a=i[0].spatialReference||s.spatialReference;if(!h(t.node.mbs,n,P,a))return void q.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=$(P,a),l=function(e,t,r,s,n){const i=t.renderSpatialReference,o=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,u;switch(e){case"intersects":l=(e,t)=>U.intersects(e,t)?0:2,u=K;break;case"contains":l=(e,t)=>U.contains(e,t)?2:1,u=K;break;case"disjoint":default:l=(e,t)=>U.disjoint(e,t)?2:1,u=X}return{collection:s,object:n,type:e,maskSR:r,renderSR:i,aabbCache:o,triangle:a,positions:c,triangleTest:l,geometryTest:u}}(o,s,a,r,t.objectHandle);for(const r of i){if(0===e.length)return;switch(H(r,c,o)){case 1:return void(e.length=0);case 0:continue}Q(e,t.featureIds,(e=>Y(r,e,l)))}}(e,o,s,t,r,i,n)))}}isMBSGeoemtryVisible(e,t,r){const s=this.parsedGeometry;if(o(s)){const n=this.spatialRelationship,i=s[0].spatialReference||t;if(!h(e,r,P,i))return q.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return function(e,t,r,s){const n=$(e,r);return t.every((e=>1!==H(e,n,s)))}(P,s,i,n)}return!0}get parsedGeometry(){if(i(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(i(e))return null;const{distance:t,units:r}=this.filter,s=this.spatialRelationship,n="mesh"===e.type?e.extent:e;if(i(t)||0===t)return z(n,s);const o=r||a(n.spatialReference);if(n.spatialReference.isWGS84){return z(this._geometryEngine.geodesicBuffer(n,t,o),s)}if(R(n,G.WGS84)){return z(F(this._geometryEngine.geodesicBuffer(F(n,G.WGS84),t,o),n.spatialReference),s)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(g().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let c=null;try{c=m(n,G.WGS84)}catch(e){}if(c)try{c=m(this._geometryEngine.geodesicBuffer(c,t,o),n.spatialReference)}catch(e){c=null}return c||q.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`),z(c,s)}get spatialRelationship(){return o(this.filter)?this.filter.spatialRelationship:"intersects"}static checkSupport(e){return e.timeExtent?(q.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):null!=(t=e.spatialRelationship)&&Z.indexOf(t)>=0||(q.warn(`Filters with spatialRelationship other than ${Z.join(", ")} are not supported for mesh scene layers`),!1);var t}};e([l({type:M})],D.prototype,"filter",void 0),e([l()],D.prototype,"layerFieldsIndex",void 0),e([l()],D.prototype,"loadAsyncModule",void 0),e([l()],D.prototype,"applyFilters",void 0),e([l()],D.prototype,"addSqlFilter",void 0),e([l({readOnly:!0})],D.prototype,"sortedObjectIds",null),e([l({readOnly:!0})],D.prototype,"parsedWhereClause",null),e([l({readOnly:!0})],D.prototype,"parsedGeometry",null),e([l({readOnly:!0})],D.prototype,"spatialRelationship",null),e([l()],D.prototype,"_projectionEngineLoaded",void 0),e([l()],D.prototype,"_geometryEngine",void 0),D=e([u("esri.views.3d.layers.i3s.I3SMeshViewFilter")],D);const Z=["contains","intersects","disjoint"];function z(e,t){if(!e)return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let r=0;r<e.rings.length;++r){const s=w(1/0,1/0,-1/0,-1/0);E(s,e.rings[r]),t[r]={type:"polygon",rings:[e.rings[r]],spatialReference:e.spatialReference,aabr:s}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const n=new Set,i=new s;for(let e=0;e<t.length;++e){const s=t[e];for(let r=e+1;r<t.length;++r){const e=t[r];if(e.aabr[0]>=s.aabr[2])break;n.add(e)}n.forEach((e=>{if(s!==e)if(e.aabr[2]<=s.aabr[0])n.delete(e);else if(U.intersects(s,e)){s.rings=s.rings.concat(e.rings),x(s.aabr,e.aabr),delete s._geVersion,n.delete(e);const o=r(t,e,t.length,i);t.splice(o,1)}})),n.add(s)}for(const e of t)delete e.aabr;return t}return[e]}const P=[0,0,0,0];function $(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},s=!t.isWGS84&&!t.isWebMercator?U.buffer(r,e[3],1):U.geodesicBuffer(r,e[3],1);return s.type="polygon",s}function H(e,t,r){switch(r){case"intersects":case"contains":return K(e,t);case"disjoint":return X(e,t)}}function K(e,t){return U.intersects(e,t)?U.contains(e,t)?0:2:1}function X(e,t){return U.intersects(e,t)?U.contains(e,t)?1:2:0}function Y(e,t,r){const{collection:s,object:n,renderSR:i,maskSR:o,geometryTest:a,aabbCache:c}=r;let l=c.get(t);if(!l){const e=s.getObjectTransform(n);s.getComponentAabb(n,t,ee);const r=[[ee[0],ee[1],0],[ee[0],ee[4],0],[ee[3],ee[4],0],[ee[3],ee[1],0]];for(let t=0;t<4;++t)p(r[t],r[t],e.rotationScale),d(r[t],r[t],e.position),j(r[t],i,r[t],o);l={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:o},l.rings[0][4]=l.rings[0][0],c.set(t,l)}switch(a(e,l)){case 1:return!1;case 0:return!0}const{triangle:u,triangleTest:f,positions:h}=r,g=u.rings[0][0],m=u.rings[0][1],b=u.rings[0][2],S=s.getObjectTransform(n);s.getComponentPositions(n,t,h);const{indices:w,data:E,stride:x,startIndex:I,endIndex:O}=h;for(let t=I;t<O;t+=3){const r=x*w[t+0],s=x*w[t+1],n=x*w[t+2];y(g,E[r+0],E[r+1],E[r+2]),y(m,E[s+0],E[s+1],E[s+2]),y(b,E[n+0],E[n+1],E[n+2]),p(g,g,S.rotationScale),p(m,m,S.rotationScale),p(b,b,S.rotationScale),d(g,g,S.position),d(m,m,S.position),d(b,b,S.position),j(g,i,g,o),j(m,i,m,o),j(b,i,b,o);const a=m[0]-g[0],c=m[1]-g[1],l=b[0]-g[0],h=b[1]-g[1];if(!(Math.abs(a*h-c*l)<2.3283064365386963e-10))switch(delete u._geVersion,f(e,u)){case 1:return!1;case 0:return!0}}switch(r.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}}const ee=b(),te=A;let re=class extends t{constructor(e){super(e),this._dataQueryEngineInstance=null,this._handles=new J}get defaultQueryJSON(){return new B({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}initialize(){this._handles.add(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))}destroy(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:N.fromJSON(s)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(e,t){const r=this._ensureQueryJSON(e);if(r.returnGeometry)throw new C("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(r.returnCentroid)throw new C("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const s=await this.dataQueryEngine.executeQuery(r,t),n=V.fromJSON(s);return n.features.forEach((e=>{e.geometry=null})),n}_ensureQueryJSON(e){if(i(e))return this.defaultQueryJSON;const t=e.toJSON();return t.outSpatialReference||(e.outSpatialReference=this.spatialReference),t}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||"OBJECTID",t=this.layer.fields.map((e=>e.toJSON())),r=this.layerView.view.resourceController.scheduler,s=this.spatialReference.toJSON(),n=this.priority,i=this.spatialIndex;return this._dataQueryEngineInstance=new te({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:t,timeInfo:null,spatialReference:s,objectIdField:e,featureStore:i,scheduler:r,priority:n}),this._dataQueryEngineInstance}};e([l({constructOnly:!0})],re.prototype,"layerView",void 0),e([l({constructOnly:!0})],re.prototype,"priority",void 0),e([l({constructOnly:!0})],re.prototype,"spatialIndex",void 0),e([l({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],re.prototype,"spatialReference",void 0),e([l({readOnly:!0,aliasOf:"layerView.i3slayer"})],re.prototype,"layer",void 0),e([l({readOnly:!0})],re.prototype,"defaultQueryJSON",null),re=e([u("esri.views.3d.layers.i3s.I3SQueryEngine")],re);var se=re;class ne{constructor(e){this.objectIdField=e.objectIdField,this.getFeatureExtent=e.getFeatureExtent}getObjectId(e){return e.id}getAttributes(e){const{meta:t,index:r}=e,s={};this.objectIdField&&(s[this.objectIdField]=e.id);const n=o(t.attributeInfo)&&t.attributeInfo.attributeData;if(o(n))for(const e of Object.keys(n))s[e]=_(n[e],r);return s}getAttribute(e,t){if(t===this.objectIdField)return e.id;const{meta:r,index:s}=e,n=o(r.attributeInfo)&&r.attributeInfo.attributeData;return o(n)?_(n[t],s):null}getGeometry(e){if(e.geometry)return e.geometry;const[t,r,s,n,i]=this.getFeatureExtent(e,ie);return new k([5],[t,r,s,n,r,s,n,i,s,t,i,s,t,r,s])}getCentroid(e,t){if(e.geometry)return W(new k,e.geometry,t.hasZ,t.hasM);const[r,s,n,i,o,a]=this.getFeatureExtent(e,ie);return new k([0],[(r+i)/2,(s+o)/2,(n+a)/2])}cloneWithGeometry(e,t){const{id:r,index:s,meta:n}=e;return{id:r,index:s,meta:n,geometry:t}}}const ie=b();let oe=class extends t{constructor(e){super(e),this.events=new L}destroy(){}forEach(e){this.forAllFeatures((t=>(e(t),1)))}forEachBounds(e,t,r){const s=this.getFeatureExtent;for(const n of e)t(s(n,r))}forEachInBounds(e,t){this.forAllFeatures((r=>{const s=this.getFeatureExtent(r,ce);return O(e,S(s,le))&&t(r),1}),(t=>{if(h(t.node.mbs,this.sourceSpatialReference,ae,this.viewSpatialReference),ae[0]>=e[0]&&ae[2]<=e[2]&&ae[1]>=e[1]&&ae[3]<=e[3])return 1;const r=Math.max(e[0],Math.min(ae[0],e[2])),s=Math.max(e[1],Math.min(ae[1],e[3])),n=ae[0]-r,i=ae[1]-s;return n*n+i*i<=ae[3]*ae[3]?1:2}))}};e([l({constructOnly:!0})],oe.prototype,"featureAdapter",void 0),e([l({constructOnly:!0})],oe.prototype,"forAllFeatures",void 0),e([l({constructOnly:!0})],oe.prototype,"getFeatureExtent",void 0),e([l({constructOnly:!0})],oe.prototype,"sourceSpatialReference",void 0),e([l({constructOnly:!0})],oe.prototype,"viewSpatialReference",void 0),oe=e([u("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],oe);const ae=T(),ce=b(),le=I();var ue=oe;export{D as I,se as a,ue as b,ne as c};
