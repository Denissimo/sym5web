/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import t from"../Viewpoint.js";import e from"../core/Collection.js";import{i as n,c as r,b as a}from"../core/lang.js";import{a as o}from"./unitUtils.js";import{P as s,Q as i}from"./mathUtils.js";import{i as c,t as u,r as f,s as l,f as m,a as y,b as p}from"./mat2d.js";import{c as g}from"./mat2df64.js";import{s as x,c as h,n as b,e as d,f as w,t as j,g as G,a as A,h as M,i as R,j as v,l as S}from"./vec2.js";import{a as k,f as q}from"./vec2f64.js";import P from"../geometry/Extent.js";import F from"../geometry/Geometry.js";import I from"../geometry/Point.js";import N,{j as z,g as V}from"../geometry/SpatialReference.js";import{e as E}from"./Ellipsoid.js";import{canProject as L,project as O}from"../geometry/support/webMercatorUtils.js";const W=180/Math.PI;function C(t,e,n,r){return r&&n&&!r.equals(n)&&L(r,n)&&r.isWebMercator?r.isWebMercator?function(t,e){let n=e[1];return n>89.99999?n=89.99999:n<-89.99999&&(n=-89.99999),n=Math.sin(s(n)),x(t,s(e[0])*E.radius,.5*E.radius*Math.log((1+n)/(1-n)))}(t,e):function(t,e,n){const r=i(e[0]/E.radius);return x(t,n?r:r-360*Math.floor((r+180)/360),i(.5*Math.PI-2*Math.atan(Math.exp(-1*e[1]/E.radius))))}(t,e):h(t,e)}function Q(t){return t.wkid?t:t.spatialReference||N.WGS84}function U(t,e){return e.type?x(t,e.x,e.y):h(t,e)}function B(t){return o(t)}function D(t,e){return Math.max(t.width/e[0],t.height/e[1])*(n=t.spatialReference,z(n)?39.37*B(n)*96:1);var n}async function T(t,o,s,i){let c,u;if(!t)return null;if(Array.isArray(t)&&!t.length)return null;if(e.isCollection(t)&&(t=t.toArray()),Array.isArray(t)&&t.length&&"object"==typeof t[0]){const e=t.every((t=>"attributes"in t)),r=t.some((t=>!t.geometry));let a=t;if(e&&r&&o&&o.allLayerViews){const e=new Map;for(const n of t){const t=n.layer,r=e.get(t)||[],a=n.attributes[t.objectIdField];null!=a&&r.push(a),e.set(t,r)}const r=[];e.forEach(((t,e)=>{const n=o.allLayerViews.find((t=>t.layer.id===e.id));if("queryFeatures"in n){const a=e.createQuery();a.objectIds=t,a.returnGeometry=!0,r.push(n.queryFeatures(a))}}));const s=await Promise.all(r),i=[];for(const t of s)if(t&&t.features&&t.features.length)for(const e of t.features)n(e.geometry)&&i.push(e.geometry);a=i}for(const t of a)i=await T(t,o,s,i);return i}if(Array.isArray(t)&&2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1])c=new I(t);else if(t instanceof F)c=t;else if("geometry"in t)if(t.geometry)c=t.geometry;else if(t.layer){const e=t.layer,n=o.allLayerViews.find((t=>t.layer.id===e.id));if("queryFeatures"in n){const a=e.createQuery();a.objectIds=[t.attributes[e.objectIdField]],a.returnGeometry=!0;const o=await n.queryFeatures(a);c=r(o,"features",0,"geometry")}}if(a(c))return null;if(u="point"===c.type?new P({xmin:c.x,ymin:c.y,xmax:c.x,ymax:c.y,spatialReference:c.spatialReference}):c.extent,!u)return null;const f=L(u,s);if(!u.spatialReference.equals(s)&&f)u=O(u,s);else if(!f)return null;return i=i?i.union(u):u.clone()}async function H(e,r){if(!e||!r)return new t({targetGeometry:new I,scale:0,rotation:0});let a=r.spatialReference;const{constraints:o,padding:s,viewpoint:i,size:c}=r,u=[s?c[0]-s.left-s.right:c[0],s?c[1]-s.top-s.bottom:c[1]];let f=null;e instanceof t?f=e:e.viewpoint?f=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(f=e.target);let l=null;f&&f.targetGeometry?l=f.targetGeometry:e instanceof P?l=e:(e||e&&("center"in e||"extent"in e||"target"in e))&&(l=await T(e.center,r,a)||await T(e.extent,r,a)||await T(e.target,r,a)||await T(e,r,a)),!l&&i&&i.targetGeometry?l=i.targetGeometry:!l&&r.extent&&(l=r.extent);const m=Q(l);if(a||(a=Q(r.spatialReference||r.extent||l)),!L(l,a)&&m&&!m.equals(a))return null;const y=U(k(),l.center?l.center:l),p=new I(C(y,y,m,a),a);let g=null;g=f&&n(f.targetGeometry)&&"point"===f.targetGeometry.type?f.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&o&&o.effectiveLODs?o.zoomToScale(e.zoom):Array.isArray(l)||"point"===l.type||"extent"===l.type&&0===l.width&&0===l.height?r.extent&&L(r.extent,a)?D(O(r.extent,a),u):r.extent?D(r.extent,u):i.scale:L(l.extent,a)?D(O(l.extent,a),u):D(l.extent,u);const x=function(t){if(t&&(!Array.isArray(t)||"number"!=typeof t[0])&&("object"==typeof t||Array.isArray(t)&&"object"==typeof t[0])){if("layer"in t&&t.layer&&t.layer.minScale&&t.layer.maxScale){const e=t.layer;return{min:e.minScale,max:e.maxScale}}if(Array.isArray(t)&&t.length&&t.every((t=>"layer"in t))){let e=0,n=0;for(const r of t){const t=r.layer;t&&t.minScale&&t.maxScale&&(e=t.minScale<e?t.minScale:e,n=t.maxScale>n?t.maxScale:n)}return e&&n?{min:e,max:n}:null}}}(e);x&&(x.min&&x.min>g?g=x.min:x.max&&x.max<g&&(g=x.max));let h=0;f?h=f.rotation:e.hasOwnProperty("rotation")?h=e.rotation:i&&(h=i.rotation);let b=new t({targetGeometry:p,scale:g,rotation:h});return o&&(b=o.fit(b),o.constrainByGeometry(b),o.rotationEnabled||(b.rotation=h)),b}function J(t,e){const n=t.targetGeometry,r=e.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function K(t,e,n){return n?x(t,.5*(e[0]-n.right+n.left),.5*(e[1]-n.bottom+n.top)):d(t,e,.5)}const X=function(){const t=k();return function(e,n,r){const a=n.targetGeometry;U(t,a);const o=.5*_(n);return e.xmin=t[0]-o*r[0],e.ymin=t[1]-o*r[1],e.xmax=t[0]+o*r[0],e.ymax=t[1]+o*r[1],e.spatialReference=a.spatialReference,e}}();function Y(t,e,n,r,a){return ut(t,e,n.center),t.scale=D(n,r),a&&a.constraints&&a.constraints.constrain(t),t}const Z=function(){const t=k();return function(e,n,r){return w(e,function(t,e){return d(t,e,.5)}(e,n),K(t,n,r))}}(),$=function(){const t=g(),e=k();return function(n,r,a,o){const s=_(r),i=tt(r);return x(e,s,s),y(t,e),f(t,t,i),u(t,t,Z(e,a,o)),u(t,t,[0,o.top-o.bottom]),x(n,t[4],t[5])}}();function _(t){return t.scale*(e=t.targetGeometry,n(e)&&z(e.spatialReference)?1/(39.37*B(e.spatialReference)*96):1);var e}function tt(t){return s(t.rotation)||0}const et=function(){const t=k(),e=k(),n=k();return function(r,a,o,s,i,m){return b(t,a),d(e,o,.5*m),x(n,1/s*m,-1/s*m),c(r),u(r,r,e),i&&f(r,r,i),l(r,r,n),u(r,r,t),r}}(),nt=function(){const t=k();return function(e,n,r,a){const o=_(n),s=tt(n);return U(t,n.targetGeometry),et(e,t,r,o,s,a)}}(),rt=function(){const t=k();return function(e,n,r,a){const o=_(n);return U(t,n.targetGeometry),et(e,t,r,o,0,a)}}();function at(t){if(t.isWrappable){const e=V(t);return e.valid[1]-e.valid[0]}return 0}function ot(t,e){return Math.round(at(t)/e)}function st(t,e){return H(t,e)}const it=function(){const t=k(),e=k(),n=[0,0,0];return function(r,a,o){A(t,r,a),M(t,t),A(e,r,o),M(e,e),R(n,t,e);let s=Math.acos(v(t,e)/(S(t)*S(e)))*W;return n[2]<0&&(s=-s),isNaN(s)&&(s=0),s}}(),ct=function(){const t=k();return function(e,n,r,a){const o=e.targetGeometry;return J(e,n),$(t,n,r,a),o.x+=t[0],o.y+=t[1],e}}(),ut=function(){const t=k();return function(e,n,r){J(e,n);const a=e.targetGeometry,o=Q(r),s=Q(a);return U(t,r),C(t,t,o,s),a.x=t[0],a.y=t[1],e}}(),ft=function(){const t=k();return function(e,n,r,a,o){o||(o="center"),w(t,r,a),d(t,t,.5);const s=t[0],i=t[1];switch(o){case"center":x(t,0,0);break;case"left":x(t,-s,0);break;case"top":x(t,0,i);break;case"right":x(t,s,0);break;case"bottom":x(t,0,-i);break;case"top-left":x(t,-s,i);break;case"bottom-left":x(t,-s,-i);break;case"top-right":x(t,s,i);break;case"bottom-right":x(t,s,-i)}return dt(e,n,t),e}}();function lt(t,e,n){return J(t,e),t.rotation+=n,t}function mt(t,e,n){return J(t,e),t.rotation=n,t}const yt=function(){const t=k();return function(e,n,r,a,o){return J(e,n),isNaN(r)||0===r||(ht(t,a,n,o),e.scale=n.scale*r,bt(t,t,e,o),dt(e,e,x(t,t[0]-a[0],a[1]-t[1]))),e}}();function pt(t,e,n){return J(t,e),t.scale=n,t}const gt=function(){const t=k();return function(e,n,r,a,o,s){return J(e,n),isNaN(r)||0===r||(ht(t,o,n,s),e.scale=n.scale*r,e.rotation+=a,bt(t,t,e,s),dt(e,e,x(t,t[0]-o[0],o[1]-t[1]))),e}}(),xt=function(){const t=k(),e=k();return function(n,r,a,o,s,i,c){return Z(e,i,c),G(t,s,e),o?gt(n,r,a,o,t,i):yt(n,r,a,t,i)}}(),ht=function(){const t=g();return function(e,n,r,a){return j(e,n,function(t,e,n,r){return nt(t,e,n,r),p(t,t)}(t,r,a,1))}}(),bt=function(){const t=g();return function(e,n,r,a){return j(e,n,nt(t,r,a,1))}}(),dt=function(){const t=k(),e=g();return function(n,r,a){J(n,r);const o=_(r),s=n.targetGeometry;return m(e,tt(r)),l(e,e,q(o,o)),j(t,a,e),s.x+=t[0],s.y+=t[1],n}}();export{ct as a,ut as b,J as c,pt as d,st as e,ft as f,D as g,gt as h,et as i,_ as j,X as k,nt as l,rt as m,ot as n,Z as o,K as p,lt as q,mt as r,Y as s,dt as t,it as u,xt as v,at as w};
