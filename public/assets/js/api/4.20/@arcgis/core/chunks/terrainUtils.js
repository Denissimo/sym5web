/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{r as e,i as t,clone as s,b as r,l as i,d as n}from"../core/lang.js";import{V as o}from"./VectorTile.js";import{_ as a}from"./tslib.es6.js";import l from"../request.js";import u from"../core/Accessor.js";import{r as c}from"./arrayUtils.js";import h from"../core/Error.js";import{createResolver as m,onAbort as d,createAbortError as p,throwIfAborted as f,isAbortError as g,createAbortController as _}from"../core/promiseUtils.js";import{property as T}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./Logger.js";import{subclass as x}from"../core/accessorSupport/decorators/subclass.js";import{a as k}from"./Util.js";import{T as y}from"./Scheduler.js";import{c as b,a as w,b as v,d as I,e as S,f as j,h as L,i as C}from"./rasterUtils.js";import{b as z,j as R,s as E,d as M,g as Q,f as W}from"./mathUtils.js";import{c as G,r as q,p as U,a as O}from"./aaBoundingRect.js";import{T as P,c as F}from"./TerrainConst.js";import{canProjectToWGS84ComparableLonLat as A}from"../geometry/projection.js";import{f as N,h as B}from"../geometry/SpatialReference.js";class H{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new D}}class D{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class V{constructor(e,t,s,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=r.map((e=>new H(e)))}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,k(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}class $ extends class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}{constructor(e,t,s,r,i){super(r),this.url=e,this.options=t,this.docType=s,this.key=i,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0}}let K=class extends u{constructor(){super(...arguments),this.tasks=new Map,this.onLoadQueue=new Array,this.doneQueue=new Array,this.updating=!1}setup(e,t,s){this.loadQueue=new V(((e,t)=>this.startLoading(e,t)),((e,t)=>this.doneLoadingCallback(e,t)),e,t),s&&(this.taskHandle=s.registerTask(y.STREAM_DATA_LOADER,this))}destroy(){this.taskHandle=e(this.taskHandle),this.tasks.forEach((e=>{e.abortController&&e.abortController.abort()})),this.loadQueue.destroy(),this.loadQueue=null,this.onLoadQueue=null,this.doneQueue=null,this.tasks=null}hasDownloadSlots(e){return this.loadQueue.hasQuota(e)}request(e,s,r,i={}){const n=m();n.__signal=t(i)?i.signal:null;const o=this.createOrUpdateTask(e,s,r,i,n);return d(i,(()=>this.cancelRequest(o,n))),n.promise}createTask(e,t,s,r,i,n){const o=new $(e,t,s,r,i);return this.updateTask(o,n),this.tasks.set(i,o),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(o),o}cancelRequest(e,t){c(e.resolvers,t),t.reject(p()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1))}taskKey(e,t,s){return`${e}:${t}:${s}`}updateTask(e,t){e.resolvers.push(t)}createOrUpdateTask(e,s,r,i,n){const o=t(i)&&i.uid||e,a=this.taskKey(o,s,r),l=this.tasks.get(a);return l?(this.updateTask(l,n),l):this.createTask(e,i,s,r,a,n)}doneLoadingCallback(e,t){this.loadQueue&&(k(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t))}get running(){return this.doneQueue.length>0||this.onLoadQueue.length>0}runTask(e){for(;!e.done&&this.onLoadQueue.length>0;){const t=this.onLoadQueue.shift();f(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this.doneQueue.length>0;){const t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||p()),this.doneLoading(t.task,t.err),e.madeProgress()}}doneLoading(e,t){let r=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const i of e.resolvers)if(t)g(t)?i.reject(t):i.reject(new h("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--r;const t=r<=0?e.result:s(e.result);i.resolve(t)}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1)}startLoading(e,t){if(4===e.status)return!1;let s,r;switch(e.startTime=performance.now(),e.status=2,e.docType){case"binary":r="array-buffer",s=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=_();const i=e.abortController.signal;e.request=l(e.url,{...e.options,responseType:r,timeout:s,signal:i});let n=()=>{};const o=s=>{e.duration=performance.now()-e.startTime,e.size=s instanceof ArrayBuffer?s.byteLength:e.size||0,e.result=s,this.taskHandle?this.onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=s=>{2===e.status&&t(e,s),n()};return"image+type"!==e.docType?(e.request.then((e=>o(e.data)),a),!0):(e.request.then((t=>{const u=t.data,c=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);if(137===t[0]&&80===t[1])return"image/png";if(71===t[0]&&73===t[1])return"image/gif";if(66===t[0]&&77===t[1])return"image/bmp";if(255===t[0]&&216===t[1])return"image/jpeg";return"unknown"}(u);if(r="image",e.size=u.byteLength,"unknown"===c)return e.request=l(e.url,{responseType:r,timeout:s,signal:i}),void e.request.then((e=>o(e.data)),a);const h=new Blob([u],{type:c}),m=window.URL.createObjectURL(h);n=()=>window.URL.revokeObjectURL(m),e.request=l(m,{responseType:r,timeout:s,signal:i}),e.request.then((e=>o(new J(e.data,c,n))),a)}),a),!0)}get test(){return{loadQueue:this.loadQueue}}};a([T({readOnly:!0})],K.prototype,"updating",void 0),K=a([x("esri.views.3d.support.StreamDataLoader")],K);class J{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return"image/jpeg"===this.type}}var X=K;const Y={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"};class Z{constructor(e,t,s=null,r=null){this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=e,this.source=t,this.width=s||t.width,this.height=r||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this.isRendereredSource?{...Y,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||Y}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){if(t(e)&&e.length>0){this._bandIds&&e.every(((e,t)=>!!this._bandIds[t]&&e===this._bandIds[t]))||(this._bandIds=e,this._dirty=!0)}else this._bandIds=null}get interpolation(){return this._interpolation}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===e?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(e,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=b(e,this.transformGrid))),!0)}getUniforms(){const e=w(this.scale,this.offset),{symbolizerParameters:t,transformGrid:s,width:r,height:i,opacity:n}=this;return{basic:e,common:v(s,[r,i],[this.source.width,this.source.height],n),colormap:t.colormap?I(t.colormap,t.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?S(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?j(this.symbolizerParameters):null}}getTextures(){const e=new Array,t=[];return this._rasterTexture&&(t.push(this._rasterTexture),e.push("u_image"),this._transformGridTexture&&(t.push(this._transformGridTexture),e.push("u_transformGrid")),this._colormapTexture&&(t.push(this._colormapTexture),e.push("u_colormap"))),{names:e,textures:t}}get memoryUsage(){if(r(this._memoryUsed)){const e=this.getTextures();if(null==e)return 0;this._memoryUsed=e.textures.map((e=>e.descriptor.width*e.descriptor.height*4)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}release(){return this._rasterTexture=i(this._rasterTexture),this._transformGridTexture=i(this._transformGridTexture),this._colormapTexture=i(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,s){const i=this.source?this.source.extractBands(s):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const n=r(s)&&r(this.bandIds)||t(s)&&t(this.bandIds)&&s.join("")===this.bandIds.join("");if(this._rasterTexture){if(n)return;this._rasterTexture.dispose(),this._rasterTexture=null}this._rasterTexture=L(e,i,this.interpolation||"nearest",this.isRendereredSource)}_updateColormapTexture(e){const t=this._colormap,s=this.symbolizerParameters.colormap;return s?t?s.length!==t.length||s.some(((e,s)=>e!==t[s]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=C(e,s),void(this._colormap=s)):void 0:(this._colormapTexture=C(e,s),void(this._colormap=s)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}const ee=z(),te=z(),se=z(),re=z();function ie(e,t,s,r){R(ee,s),ee[r]=t[r];const i=E(ee,ee,t),n=E(te,e,t),o=M(n,i),a=M(i,i);let l;l=o<=0?t:a<=o?s:Q(ee,t,W(i,i,o/a));const u=E(ee,e,l);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}var ne=Object.freeze({__proto__:null,isInsideExtent:function(e,t,s=0){const r=e.extent;if(0===s)return G(r,t);const i=Math.min(r[2]-r[0],r[3]-r[1]);return q(r,t,s*i)},tiltToExtentEdge:function(e,t,s){const r=e.extent;se[0]=r[0],se[1]=r[1],se[2]=s,re[0]=r[2],re[1]=r[3],re[2]=s;let i=1/0,n=1/0;return t[0]<se[0]?i=ie(t,se,re,0):t[0]>re[0]&&(i=ie(t,re,se,0)),t[1]<se[1]?n=ie(t,se,re,1):t[1]>re[1]&&(n=ie(t,re,se,1)),Math.min(i,n)},checkIfTileInfoSupportedForViewSR:function(e,t,s){if(e.spatialReference.isGeographic)return new h("tilingscheme:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes");const r=P.checkUnsupported(e);if(r)return r;const i=function(e,t){const s=e.lods,r=s[0].resolution*2**s[0].level,i=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],o=U(t),a=O();P.computeRowColExtent(o,i,n,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>F){const t=s[0].scale*2**s[0].level;let i=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/r;const n=Math.floor(Math.log(i)/Math.log(10));return i=Math.ceil(i/10**n)*10**n,new h("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+i.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:i,requiredNumRootTiles:l,allowedNumRootTiles:F})}return null}(e,s);return i||(t&&!e.spatialReference.equals(t)?new h("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null)}});var oe=Object.freeze({__proto__:null,isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0},checkIfTileInfoSupportedForViewSR:function(e,t){const s=e.lods.length-1,r=e.spatialReference,i=A(r)||N(r)||B(r);if(r.isWebMercator){if(!P.makeWebMercatorAuxiliarySphere(s).compatibleWith(e))return new h("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!i)return new h("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!P.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e))return e.spatialReference.isWGS84?new h("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new h("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}if(t&&!e.spatialReference.equals(t))return new h("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}});class ae{constructor(e){this._texture=e,this._refCount=1}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}const le={1:oe,2:ne};function ue(e,t){e||console.warn("Terrain: "+t)}const ce=80/180*Math.PI,he=110/180*Math.PI;function me(e,s,r){const i=le[e.viewingMode];let o;if(i.isInsideExtent(e,s))o=n(e.getElevation(s[0],s[1],s[1],e.spatialReference),0);else{if(!i.isInsideExtent(e,s,1.2))return 0;const r=e.getTileWithElevation(s[0],s[1],s[1],e.spatialReference);o=.5*((t(r)?r.elevationBounds[0]:e.elevationBounds.min)+(t(r)?r.elevationBounds[1]:e.elevationBounds.max));const n=i.tiltToExtentEdge(e,s,o);if(n>ce&&n<he)return 0}const a=s[2]-o;return Math.abs(a)<r?0:a<0?-1:1}function de(e){return ge(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function pe(e){return"vector-tile"===(null==e?void 0:e.type)}function fe(e){return"imagery-tile"===(null==e?void 0:e.type)||"wcs"===(null==e?void 0:e.type)}function ge(e){return"imagery-tile-3d"===(null==e?void 0:e.type)}function _e(e){return"tile-3d"===(null==e?void 0:e.type)}function Te(e){return"vector-tile-3d"===(null==e?void 0:e.type)}function xe(e){return"elevation-3d"===(null==e?void 0:e.type)}function ke(e){return e&&(_e(e)||ge(e)||xe(e)||Te(e)||function(e){return"wmts-3d"===(null==e?void 0:e.type)}(e))}function ye(e){var t;return(null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof Z}function be(e){var t;return(null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof o}function we(e){var t;return(null==e||null==(t=e.sourceLayerInfo)?void 0:t.data)instanceof ae}function ve(e){var t;const s=null==e||null==(t=e.sourceLayerInfo)?void 0:t.data;return s instanceof HTMLImageElement||s instanceof J||s instanceof HTMLCanvasElement||s instanceof ImageData}function Ie(e){return t(e)&&"release"in e&&e.release(),null}function Se(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function je(e,t,s,r){return le[r].checkIfTileInfoSupportedForViewSR(e,s,t)}function Le(e,t,s){let r,i;if("wmts"===e.type){const n=e.activeLayer;if(n){const e=n.tileMatrixSet;if(e)r=e.tileInfo,i=e.fullExtent;else{const e=n.tileMatrixSets;if(e){const r=e.find((e=>null==je(e.tileInfo,e.fullExtent,t,s)));if(r)return{tileInfo:r.tileInfo,fullExtent:r.fullExtent}}}}}else i=fe(e)?e.getCompatibleFullExtent(t):e.fullExtent,r=pe(e)&&!Ce.force512VTL?e.compatibleTileInfo256:fe(e)?e.getCompatibleTileInfo(t,i,2===s):e.tileInfo;return r&&i&&null==je(r,i,t,s)?{tileInfo:r,fullExtent:i}:{tileInfo:null,fullExtent:null}}const Ce={force512VTL:!1};export{J as I,Z as R,X as S,ae as T,Le as a,pe as b,je as c,Te as d,be as e,ye as f,de as g,ve as h,fe as i,we as j,me as k,ke as l,xe as m,ge as n,_e as o,Ie as r,Se as u,ue as w};
