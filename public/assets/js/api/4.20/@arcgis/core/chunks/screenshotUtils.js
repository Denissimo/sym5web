/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import"../core/lang.js";import{c as t}from"./mathUtils.js";function i(i,h){const{format:e,quality:o,rotation:a,disableDecorations:n}=i||{},r=f(i,h.padding),l=function(t,i){const h={x:0,y:0,width:i.width,height:i.height};if(t&&t.area){null!=t.area.x&&(h.x=Math.floor(t.area.x)),null!=t.area.y&&(h.y=Math.floor(t.area.y));const e=null!=t.area.width?Math.floor(t.area.width):null,o=null!=t.area.height?Math.floor(t.area.height):null;if(h.width=i.width-h.x,h.height=i.height-h.y,null!=e&&null!=o)h.width=Math.min(h.width,e),h.height=Math.min(h.height,o);else if(null==e&&null!=o){const t=Math.min(h.width,e);h.height=t/h.width*h.height,h.width=t}else if(null!=e&&null==o){const t=Math.min(h.height,o);h.width=t/h.height*h.width,h.height=t}}return function(t,i){const h=Math.floor(Math.max(t.x,0)),e=Math.floor(Math.max(t.y,0)),o=Math.floor(Math.min(t.width,i.width-h)),a=Math.floor(Math.min(t.height,i.height-e)),n={x:h,y:e,width:o,height:a},r=n.width/n.height,l=t.width/t.height;if(l===r)return n;if(l>r){const t=Math.floor(n.width/l),i=n.height-t;return{x:n.x,y:Math.floor(n.y+i/2),width:n.width,height:t}}const g=Math.floor(n.height*l),d=n.width-g;return{x:Math.floor(n.x+d/2),y:n.y,width:g,height:n.height}}(function(t,i){if(!i||null==i.width||null==i.height)return t;const h=i.width/i.height,e=t.width/t.height;if(e===h)return t;if(e<h){const i=Math.floor(t.height*h);return t.x-=(i-t.width)/2,t.width=i,t}const o=Math.floor(t.width/h);return t.y-=(o-t.height)/2,t.height=o,t}(h,t),i)}(i,{width:h.width-r.left-r.right,height:h.height-r.top-r.bottom}),{width:g,height:d}=function(t,i){if(!t)return i;const h=t.width,e=t.height;if(null!=h&&null!=e)return{width:Math.floor(h),height:Math.floor(e)};if(null==h&&null==e)return i;const o=i.width/i.height;if(null==e)return{width:Math.floor(h),height:Math.floor(h/o)};return{width:Math.floor(e*o),height:Math.floor(e)}}(i,l),u=function(t){switch(t){case"png":case"jpg":case"jpeg":return t;case null:case void 0:default:return c}}(e),w=s[u];return{format:u,quality:t(null!=o?o:w,0,100),area:l,width:g,height:d,rotation:a,disableDecorations:!!n,ignoreBackground:!(!i||!i.ignoreBackground),ignorePadding:!(!i||!i.ignorePadding)}}function h(t,h){const e=i(t,h),o=e.area,a=e.width/o.width,n=f(e,h.padding),r=n.left+n.right,l=n.top+n.bottom,g=h.width-r,d=h.height-l,u=Math.floor(g*a+r),c=Math.floor(d*a+l),s=t&&t.layers?t.layers:[],w=e.ignoreBackground,m=e.ignorePadding;return{framebufferWidth:u,framebufferHeight:c,region:{x:Math.floor(o.x*a)+n.left,y:Math.floor(o.y*a)+n.top,width:e.width,height:e.height},format:e.format,quality:e.quality,rotation:e.rotation,pixelRatio:a,layers:s,disableDecorations:e.disableDecorations,ignoreBackground:w,ignorePadding:m}}function e(t,i,h,e){e.premultipliedAlpha&&function(t){const i=t.data,h=i.length;for(let t=0;t<h;t+=4){const h=i[t+3];if(h>0){const e=h/255;i[t+0]=i[t+0]/e,i[t+1]=i[t+1]/e,i[t+2]=i[t+2]/e}}}(t),h.width=t.width,h.height=t.height;const o=h.getContext("2d");o.putImageData(t,0,0),e.flipY&&function(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}(o);const a=o.getImageData(0,0,t.width,t.height),n=function(t,i){const h=u[i.format],e=i.quality/100;return t.toDataURL(h,e)}(h,i);return h.width=0,h.height=0,{dataUrl:n,data:a}}function o(t,i,h){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(d)try{return new ImageData(t,i)}catch(t){d=!1}return l(t,i,h)}function a(t,i,h,e){if(!i||!h)throw new Error("Cannot construct image data without dimensions");if(d)try{return new ImageData(t,i,h)}catch(t){d=!1}const o=l(i,h,e);return o.data.set(t,0),o}function n(t,i,h,e=0,o=0,a=t.width-e,n=t.height-o,r=!1){const{data:l}=t,{width:g,height:d,data:f}=i,u=a/g,c=n/d,s=Math.ceil(u/2),w=Math.ceil(c/2),m=t.width;for(let t=0;t<d;t++)for(let i=0;i<g;i++){const a=4*(i+(r?d-t-1:t)*g);let n=0,M=0,p=0,y=0,x=0,b=0;const j=(t+.5)*c;for(let a=Math.floor(t*c);a<(t+1)*c;a++){const t=Math.abs(j-(a+.5))/w,r=(i+.5)*u,g=t*t;for(let t=Math.floor(i*u);t<(i+1)*u;t++){const i=Math.abs(r-(t+.5))/s,d=Math.sqrt(g+i*i);if(d>=1)continue;let f=2*d*d*d-3*d*d+1;const u=4*(e+t+(o+a)*m);b+=f*l[u+3],M+=f,!h&&l[u+3]<255&&(f=f*l[u+3]/255),p+=f*l[u],y+=f*l[u+1],x+=f*l[u+2],n+=f}}f[a]=p/n,f[a+1]=y/n,f[a+2]=x/n,f[a+3]=b/M}return i}function r(t,i,h){if(!i)return t;const{framebufferWidth:e,framebufferHeight:o,pixelRatio:a,region:n}=t,r=f(t,h),l=r.left+r.right,g=r.top+r.bottom,d=e-l,u=o-g,c=Math.min(8,Math.min((2048-l)/d,(2048-g)/u));return c<1.5?t:{...t,framebufferWidth:Math.round(d*c)+l,framebufferHeight:Math.round(u*c)+g,pixelRatio:a*c,resample:{region:{x:Math.round((n.x-r.left)*c)+r.left,y:Math.round((n.y-r.top)*c)+r.top,width:Math.round(n.width*c),height:Math.round(n.height*c)},width:e,height:o}}}function l(t,i,h){return h||(h=function(){g||(g=document.createElement("canvas"),g.width=1,g.height=1);return g}()),h.getContext("2d").createImageData(t,i)}let g=null,d=!0;function f(t,i){return!i||t&&t.ignorePadding?w:i}const u={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},c="png",s={png:100,jpg:98,jpeg:98},w={top:0,right:0,bottom:0,left:0};export{o as c,e,n as r,r as s,h as t,a as w};
