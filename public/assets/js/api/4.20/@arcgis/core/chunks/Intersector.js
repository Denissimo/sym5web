/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{i as t}from"../core/lang.js";import{c as r,I as s}from"./mat4f64.js";import{b as i,f as e,l as a,g as n,j as o,n as h,u as d,h as l,t as c}from"./mathUtils.js";import{c as m,a as f,b as y}from"./ray.js";import{d as u}from"./mat4.js";import{t as p}from"./vec4.js";import{a as g}from"./vec4f64.js";import{e as O}from"./boundedPlane.js";import{O as _}from"./Object3D.js";import{I as L,g as v}from"./verticalOffsetUtils.js";import{i as j}from"./utils4.js";class b{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}function P(t){return(r,s,i)=>(l(I,r,s,i),!O(t,I))}class E{constructor(){this.min=new T,this.max=new T,this.hud=new T,this.ground=new T}init(t){this.min.init(t),this.max.init(t),this.hud.init(t),this.ground.init(t),this.all=[]}}class T{constructor(t){this.normal=i(),this.transformation=r(),this._ray=m(),this.init(t)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return e(A,this.ray.direction,this.dist),a(A)}getIntersectionPoint(t){return!!this.hasIntersectionPoint&&(e(A,this.ray.direction,this.dist),n(t,this.ray.origin,A),!0)}getTransformedNormal(t){return o(N,this.normal),N[3]=0,p(N,N,this.transformation),o(t,N),h(t,t),t}init(t){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",t?f(t,this._ray):this._ray=m()}set(t,r,s,i,e,a,n,h,l,c){t instanceof _&&(t={type:"stage",obj:t}),this.dist=s,o(this.normal,i),u(this.transformation,e),this.target=t,this.name=r,this.drapedLayerOrder=a,this.center=n?d(n):null,this.geometryId=h,this.triangleNr=l,this.drapedLayerGraphicOrder=c}copyFrom(t){f(t.ray,this._ray),this.dist=t.dist,this.target=t.target,this.name=t.name,this.drapedLayerOrder=t.drapedLayerOrder,this.center=t.center?d(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,o(this.normal,t.normal),u(this.transformation,t.transformation)}}const I=i(),A=i(),N=g();class w{constructor(t){this.options=new b,this.results=new E,this.transform=new L,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=1e-5,this.verticalOffset=null,this._ray={origin:i(),direction:i()},this._rayEndPoint=i(),this._rayStartPointTransformed=i(),this._rayEndPointTransformed=i(),this.viewingMode=null==t?1:t}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(t,r){this.resetWithRay(y(t,r,this._ray))}resetWithRay(t){t!==this._ray&&f(t,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,n(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}intersect(r=null,s,i,e,a,n){this.point=s,this.camera=i,this.filterPredicate=a,this.tolerance=null==e?1e-5:e;const o=v(this.verticalOffset);if(t(r)&&r.length>0){const s=n?t=>{n(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const i of r){const r=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();t(r)?(t(o)?r.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,s,o):r.forEachAlongRay(this._ray.origin,this._ray.direction,s),this.options.selectionMode&&this.options.hud&&r.forEachDegenerateObject(s)):i.objects.forAll((t=>s(t)))}}this.sortResults()}intersectObject(r){this._numObjectsTested++;const i=r.geometryRecords;if(!i)return;const e=r.id,a=r.transformation;let n;const o=v(this.verticalOffset);for(const h of i){const{geometry:i,material:d,instanceParameters:l}=h;if(j(l))continue;n=i.id,this.transform.setAndInvalidateLazyTransforms(a,h.getShaderTransformation()),c(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),c(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const m=this.transform.transform;t(o)&&(o.objectTransform=this.transform),d.intersect(i,l,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((i,a,o,h,d,l)=>{if(i>=0){if(t(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,i))return;const c=`Object3D ${e}`;if(d)return void((null==this.results.hud.dist||i<this.results.hud.dist)&&this.results.hud.set(r,c,i,a,s,h,l,n,o));const f=t=>t.set(r,c,i,a,m,h,null,n,o);if((null==this.results.min.drapedLayerOrder||h>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||i<this.results.min.dist)&&f(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||h<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||i>this.results.max.dist)&&f(this.results.max),2===this.options.store){const t=new T(this._ray);f(t),this.results.all.push(t)}}}),h.shaderTransformation)}}sortResults(){this.results.all.sort(((t,r)=>t.dist!==r.dist?t.dist-r.dist:t.drapedLayerOrder!==r.drapedLayerOrder?(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==r.drapedLayerOrder?r.drapedLayerOrder:Number.MAX_VALUE):(void 0!==r.drapedLayerGraphicOrder?r.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)))}}w.DEFAULT_TOLERANCE=1e-5;export{w as I,T as a,P as s};
