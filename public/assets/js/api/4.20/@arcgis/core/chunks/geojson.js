/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{O as t,a as n}from"./OptimizedFeature.js";const o={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function r(e){return o[e]}function*i(e){switch(e.type){case"Feature":yield e;break;case"FeatureCollection":for(const t of e.features)t&&(yield t)}}function*s(e){if(!e)return null;switch(e.type){case"Point":yield e.coordinates;break;case"LineString":case"MultiPoint":yield*e.coordinates;break;case"MultiLineString":case"Polygon":for(const t of e.coordinates)yield*t;break;case"MultiPolygon":for(const t of e.coordinates)for(const e of t)yield*e}}function c(e){for(const t of e)if(t.length>2)return!0;return!1}function u(e){let t=0;for(let n=0;n<e.length;n++){const o=e[n],r=e[(n+1)%e.length];t+=o[0]*r[1]-r[0]*o[1]}return t<=0}function l(e){const t=e[0],n=e[e.length-1];return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]||e.push(t),e}function f(e,t,n){switch(t.type){case"LineString":return function(e,t,n){return p(e,t.coordinates,n),e}(e,t,n);case"MultiLineString":return function(e,t,n){for(const o of t.coordinates)p(e,o,n);return e}(e,t,n);case"MultiPoint":return function(e,t,n){return p(e,t.coordinates,n),e}(e,t,n);case"MultiPolygon":return function(e,t,n){for(const o of t.coordinates){a(e,o[0],n);for(let t=1;t<o.length;t++)y(e,o[t],n)}return e}(e,t,n);case"Point":return function(e,t,n){return g(e,t.coordinates,n),e}(e,t,n);case"Polygon":return function(e,t,n){const o=t.coordinates;a(e,o[0],n);for(let t=1;t<o.length;t++)y(e,o[t],n);return e}(e,t,n)}}function a(e,t,n){const o=l(t);u(o)?p(e,o,n):d(e,o,n)}function y(e,t,n){const o=l(t);u(o)?d(e,o,n):p(e,o,n)}function p(e,t,n){for(const o of t)g(e,o,n);e.lengths.push(t.length)}function d(e,t,n){for(let o=t.length-1;o>=0;o--)g(e,t[o],n);e.lengths.push(t.length)}function g(e,t,n){const[o,r,i]=t;e.coords.push(o,r),n.hasZ&&e.coords.push(i||0)}function m(e){switch(typeof e){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function h(t){if(!t)throw new e("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==t.type&&"FeatureCollection"!==t.type)throw new e("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:t});const{crs:n}=t;if(!n)return;const o="string"==typeof n?n:"name"===n.type?n.properties.name:"EPSG"===n.type?n.properties.code:null,r=new RegExp(".*(CRS84H?|4326)$","i");if(!o||!r.test(o))throw new e("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:n})}function w(e,t={}){const n=[],o=new Set,u=new Set;let l,f=!1,a=Number.NEGATIVE_INFINITY,y=null,p=!1,{geometryType:d=null}=t,g=!1;for(const t of i(e)){const{geometry:e,properties:i,id:h}=t;if(!e||(d||(d=r(e.type)),r(e.type)===d)){if(!f){f=c(s(e))}if(p||(p=null!=h,p&&(l=typeof h,"number"===l&&(y=Object.keys(i).filter((e=>i[e]===h))))),p&&"number"===l&&null!=h&&(a=Math.max(a,h),y.length>1?y=y.filter((e=>i[e]===h)):1===y.length&&(y=i[y[0]]===h?y:[])),!g&&i){let e=!0;for(const t in i){if(o.has(t))continue;const r=i[t];if(null==r){e=!1,u.add(t);continue}const s=m(r);"unknown"!==s?(u.delete(t),o.add(t),n.push({name:t,alias:t,type:s})):u.add(t)}g=e}}}const h=y&&1===y.length&&y[0]||null;if(h)for(const e of n)e.name===h&&(e.type="esriFieldTypeOID");return{fields:n,geometryType:d,hasZ:f,maxObjectId:Math.max(0,a),objectIdFieldName:h,objectIdFieldType:l,unknownFields:Array.from(u)}}function P(e,o){return Array.from(function*(e,o={}){const{geometryType:i,objectIdField:s}=o;for(const u of e){var c;const{geometry:e,properties:l,id:a}=u;if(e&&r(e.type)!==i)continue;const y=l||{};let p=null!=(c=y[s])?c:null;s&&null!=a&&!y[s]&&(y[s]=p=a);const d=new t(e?f(new n,e,o):null,y,null,p);yield d}}(i(e),o))}export{P as c,r as g,w as i,h as v};
