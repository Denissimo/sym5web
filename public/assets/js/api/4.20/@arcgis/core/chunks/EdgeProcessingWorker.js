/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import{d as t}from"./deduplicate.js";import{v as e,e as n,a as s,g as o,d as r,u as a,w as i,t as c,B as l,f,i as u,c as g,h as d,r as p,m,b as h,k as w,p as v,n as y,l as A,j as I,o as b,y as S,z as V,x as N,s as x,A as E,C as L,D as U,q as j,E as B,F as D,G as k,H as F,I as W,J as M}from"./BufferView.js";import{n as P}from"./InterleavedLayout.js";import{g as _}from"./glUtil.js";import{R as z,j as O}from"./arrayUtils.js";import{g as R,n as C,b as H,k as T,e as q,j as $,d as G,i as J,D as K,a as Q,s as X,w as Y}from"./mathUtils.js";import{B as Z}from"../core/lang.js";const tt=P().vec3f("position").u16("componentIndex").u16("u16padding"),et=P().vec2u8("sideness"),nt=_(et),st=P().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),ot=st.clone().vec3f("normal"),rt=st.clone().vec3f("normalA").vec3f("normalB"),at=new Map([["position0",0],["position1",1],["componentIndex",2],["variantOffset",3],["variantStroke",4],["variantExtension",5],["normal",6],["normalA",6],["normalB",7],["sideness",8]]);class it{updateSettings(t){this.settings=t,this.edgeHashFunction=t.reducedPrecision?gt:ut}write(t,e,n){const s=this.edgeHashFunction(n);wt.seed=s;const o=wt.getIntRange(0,255),r=wt.getIntRange(0,this.settings.variants-1),a=wt.getFloat(),i=255*(.5*function(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7),1.2)+.5);t.position0.setVec(e,n.position0),t.position1.setVec(e,n.position1),t.componentIndex.set(e,n.componentIndex),t.variantOffset.set(e,o),t.variantStroke.set(e,r),t.variantExtension.set(e,i)}trim(t,e){return t.slice(0,e)}}const ct=new Float32Array(6),lt=new Uint32Array(ct.buffer),ft=new Uint32Array(1);function ut(t){const e=ct;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],ft[0]=5381;for(let t=0;t<lt.length;t++)ft[0]=31*ft[0]+lt[t];return ft[0]}function gt(t){const e=ct;e[0]=dt(t.position0[0]),e[1]=dt(t.position0[1]),e[2]=dt(t.position0[2]),e[3]=dt(t.position1[0]),e[4]=dt(t.position1[1]),e[5]=dt(t.position1[2]),ft[0]=5381;for(let t=0;t<lt.length;t++)ft[0]=31*ft[0]+lt[t];return ft[0]}function dt(t){return Math.round(1e4*t)/1e4}class pt{constructor(){this.commonWriter=new it}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return ot.createBuffer(t)}write(t,e,n){this.commonWriter.write(t,e,n),R(ht,n.faceNormal0,n.faceNormal1),C(ht,ht),t.normal.setVec(e,ht)}trim(t,e){return this.commonWriter.trim(t,e)}}pt.Layout=ot,pt.glLayout=_(ot,1);class mt{constructor(){this.commonWriter=new it}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return rt.createBuffer(t)}write(t,e,n){this.commonWriter.write(t,e,n),t.normalA.setVec(e,n.faceNormal0),t.normalB.setVec(e,n.faceNormal1)}trim(t,e){return this.commonWriter.trim(t,e)}}mt.Layout=rt,mt.glLayout=_(rt,1);const ht=H(),wt=new z;function vt(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:At(t.layout)}}function yt(t){return function(t){const e=P();return e.stride=t.stride,e.fieldNames=t.fieldNames,t.fields.forEach((t=>e.fields.set(t[0],{...t[1],constructor:St(t[1].constructor)}))),e}(t.layout).createView(t.buffer)}function At(t){const e=new Array;return t.fields.forEach(((t,n)=>{const s={...t,constructor:bt(t.constructor)};e.push([n,s])})),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const It=[e,n,s,o,r,a,i,c,l,f,u,g,d,p,m,h,w,v,y,A,I,b,S,V,N,x,E,L,U,j,B,D,k,F,W,M];function bt(t){return`${t.ElementType}_${t.ElementCount}`}function St(t){return Vt.get(t)}const Vt=new Map;function Nt(t,e,n){const s=e/3,o=new Uint32Array(n+1),r=new Uint32Array(n+1),a=(t,e)=>{t<e?o[t+1]++:r[e+1]++};for(let e=0;e<s;e++){const n=t[3*e],s=t[3*e+1],o=t[3*e+2];a(n,s),a(s,o),a(o,n)}let i=0,c=0;for(let t=0;t<n;t++){const e=o[t+1],n=r[t+1];o[t+1]=i,r[t+1]=c,i+=e,c+=n}const l=new Uint32Array(6*s),f=o[n],u=(t,e,n)=>{if(t<e){const s=o[t+1]++;l[2*s]=e,l[2*s+1]=n}else{const s=r[e+1]++;l[2*f+2*s]=t,l[2*f+2*s+1]=n}};for(let e=0;e<s;e++){const n=t[3*e],s=t[3*e+1],o=t[3*e+2];u(n,s,e),u(s,o,e),u(o,n,e)}const g=(t,e)=>{const n=2*t,s=e-t;for(let t=1;t<s;t++){const e=l[n+2*t],s=l[n+2*t+1];let o=t-1;for(;o>=0&&l[n+2*o]>e;o--)l[n+2*o+2]=l[n+2*o],l[n+2*o+3]=l[n+2*o+1];l[n+2*o+2]=e,l[n+2*o+3]=s}};for(let t=0;t<n;t++)g(o[t],o[t+1]),g(f+r[t],f+r[t+1]);const d=new Int32Array(3*s),p=(e,n)=>e===t[3*n]?0:e===t[3*n+1]?1:e===t[3*n+2]?2:-1,m=(t,e)=>{const n=p(t,e);d[3*e+n]=-1},h=(t,e,n,s)=>{const o=p(t,e);d[3*e+o]=s;const r=p(n,s);d[3*s+r]=e};for(let t=0;t<n;t++){let e=o[t];const n=o[t+1];let s=r[t];const a=r[t+1];for(;e<n&&s<a;){const n=l[2*e],o=l[2*f+2*s];n===o?(h(t,l[2*e+1],o,l[2*f+2*s+1]),e++,s++):n<o?(m(t,l[2*e+1]),e++):(m(o,l[2*f+2*s+1]),s++)}for(;e<n;)m(t,l[2*e+1]),e++;for(;s<a;){m(l[2*f+2*s],l[2*f+2*s+1]),s++}}return d}It.forEach((t=>Vt.set(bt(t),t)));function xt(t,e,n,s=Dt){const o=t.vertices.position,r=t.vertices.componentIndex,a=T(s.anglePlanar),i=T(s.angleSignificantEdge),c=Math.cos(i),l=Math.cos(a),f=jt.edge,u=f.position0,g=f.position1,d=f.faceNormal0,p=f.faceNormal1,m=function(t){const e=t.faces.length/3,n=t.vertices.position,s=t.faces,o=Bt.v0,r=Bt.v1,a=Bt.v2,i=new Float32Array(3*e);for(let t=0;t<e;t++){const e=s[3*t+0],c=s[3*t+1],l=s[3*t+2];n.getVec(e,o),n.getVec(c,r),n.getVec(l,a),X(r,r,o),X(a,a,o),Q(o,r,a),C(o,o),i[3*t+0]=o[0],i[3*t+1]=o[1],i[3*t+2]=o[2]}return i}(t),h=function(t){const e=t.faces.length/3,n=t.faces,s=t.neighbors;let o=0;for(let t=0;t<e;t++){const e=s[3*t+0],r=s[3*t+1],a=s[3*t+2],i=n[3*t+0],c=n[3*t+1],l=n[3*t+2];o+=-1===e||i<c?1:0,o+=-1===r||c<l?1:0,o+=-1===a||l<i?1:0}const r=new Int32Array(4*o);let a=0;for(let t=0;t<e;t++){const e=s[3*t+0],o=s[3*t+1],i=s[3*t+2],c=n[3*t+0],l=n[3*t+1],f=n[3*t+2];(-1===e||c<l)&&(r[a++]=c,r[a++]=l,r[a++]=t,r[a++]=e),(-1===o||l<f)&&(r[a++]=l,r[a++]=f,r[a++]=t,r[a++]=o),(-1===i||f<c)&&(r[a++]=f,r[a++]=c,r[a++]=t,r[a++]=i)}return r}(t),w=h.length/4,v=e.allocate(w);let y=0;const A=w,I=n.allocate(A);let b=0,S=0,V=0;const N=O(0,w),x=new Float32Array(w);Z(x,((t,e,n)=>{o.getVec(h[4*e+0],u),o.getVec(h[4*e+1],g),n[e]=Y(u,g)})),N.sort(((t,e)=>x[e]-x[t]));const E=new Array,L=new Array;for(let t=0;t<w;t++){const s=N[t],i=x[s],w=h[4*s+0],A=h[4*s+1],U=h[4*s+2],j=h[4*s+3],B=-1===j;if(o.getVec(w,u),o.getVec(A,g),B)q(d,m[3*U+0],m[3*U+1],m[3*U+2]),$(p,d),f.componentIndex=r.get(w),f.cosAngle=G(d,p);else{if(q(d,m[3*U+0],m[3*U+1],m[3*U+2]),q(p,m[3*j+0],m[3*j+1],m[3*j+2]),f.componentIndex=r.get(w),f.cosAngle=G(d,p),Lt(f,l))continue;f.cosAngle<-.9999&&$(p,d)}S+=i,V++,B||Et(f,c)?(e.write(v,y++,f),E.push(i)):Ut(f,a)&&(n.write(I,b++,f),L.push(i))}const U=new Float32Array(E.reverse()),j=new Float32Array(L.reverse());return{regular:{instancesData:e.trim(v,y),lodInfo:{lengths:U}},silhouette:{instancesData:n.trim(I,b),lodInfo:{lengths:j}},averageEdgeLength:S/V}}function Et(t,e){return t.cosAngle<e}function Lt(t,e){return t.cosAngle>e}function Ut(t,e){const n=J(t.cosAngle),s=jt.fwd,o=jt.ortho;K(s,t.position1,t.position0);return n*(G(Q(o,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}const jt={edge:{position0:H(),position1:H(),faceNormal0:H(),faceNormal1:H(),componentIndex:0,cosAngle:0},ortho:H(),fwd:H()},Bt={v0:H(),v1:H(),v2:H()},Dt={anglePlanar:4,angleSignificantEdge:35};function kt(e){const n=function(e,n,s,o){if(n){return{faces:s,facesLength:o,neighbors:Nt(s,o,e.count),vertices:e}}const r=t(e.buffer,e.stride/4,{originalIndices:s,originalIndicesLength:o}),a=Nt(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:a,vertices:tt.createView(r.buffer)}}(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return Ft.updateSettings(e.writerSettings),Wt.updateSettings(e.writerSettings),xt(n,Ft,Wt)}const Ft=new pt,Wt=new mt;var Mt=Object.freeze({__proto__:null,wrappedWork:async function(t){const e=function(t){return{data:tt.createView(t.dataBuffer),indices:"Uint32Array"===t.indicesType?new Uint32Array(t.indicesBuffer):"Uint16Array"===t.indicesType?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}(t),n=kt(e),s=[e.data.buffer];return{result:function(t,e){e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer);return{regular:{instancesData:vt(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:vt(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}(n,s),transferList:s}},work:kt});export{at as E,pt as R,mt as S,et as V,tt as a,Mt as b,nt as g,yt as u,kt as w};
