/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{u as r,f as o,i as s}from"../core/lang.js";import{a as i}from"./mat3.js";import{c as a}from"./quatf64.js";import{p as n}from"./mathUtils.js";import{f as m}from"./vec4f64.js";import p,{M as l}from"../geometry/support/MeshComponent.js";import c from"../geometry/support/MeshMaterialMetallicRoughness.js";import u from"../geometry/support/MeshTexture.js";import{B as f,a as j,g,b as d,e as y,l as x,m as b,n as h}from"./BufferView.js";import{t as v,a as w,f as M,s as C,c as U,b as A}from"./vec3.js";import{D as S,l as T,c as B,C as E,t as R,f as F,n as I,g as q,s as D,a as O,h as P,b as G,d as N,e as k}from"./DefaultMaterial_COLOR_GAMMA.js";import{a as L}from"./georeference.js";import{d as z}from"./geometryDataUtils.js";import"./colorUtils.js";import"./ensureType.js";import"./Logger.js";import"../config.js";import"./object.js";import"./string.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./Message.js";import"../core/promiseUtils.js";import"./tslib.es6.js";import"./JSONSupport.js";import"../core/Accessor.js";import"./deprecate.js";import"../core/accessorSupport/decorators/property.js";import"./metadata.js";import"./handleUtils.js";import"./ArrayPool.js";import"../core/accessorSupport/decorators/subclass.js";import"./arrayUtils.js";import"../core/scheduling.js";import"./write.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/MeshMaterial.js";import"./reader.js";import"./writer.js";import"./persistableUrlUtils.js";import"./screenshotUtils.js";import"./vec2.js";import"./vec4.js";import"./types.js";import"./asyncUtils.js";import"./mat4f64.js";import"./compilerUtils.js";import"./Version.js";import"./mat4.js";import"./quat.js";import"./unitUtils.js";import"./jsonMap.js";import"./projectionEllipsoid.js";import"../geometry/SpatialReference.js";import"./Ellipsoid.js";import"../geometry/projection.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"./pe.js";import"./assets.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./aaBoundingRect.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./axisAngleDegrees.js";import"./projection.js";import"./triangle.js";import"./vectorStacks.js";import"./vec2f64.js";import"./lineSegment.js";async function V(i,a,p){const x=new S(function(t){if(null==t||!t.resolveFile)return null;return{busy:!1,request:async(r,o,i)=>{const a=t.resolveFile(r),n="image"===o?"image":"binary"===o?"array-buffer":"json";return(await e(a,{responseType:n,signal:s(i)?i.signal:null})).data}}}(p)),b=(await T(x,a,p,!0)).model,h=b.lods.shift(),v=new Map,w=new Map;b.textures.forEach(((t,e)=>{return v.set(e,new u({data:(r=t).data,wrap:K(r.parameters.wrap)}));var r})),b.materials.forEach(((e,s)=>w.set(s,function(e,s){const i=new t((p=e.color,l=e.opacity,m(H(p[0]),H(p[1]),H(p[2]),l))),a=e.emissiveFactor?new t(function(t){return n(H(t[0]),H(t[1]),H(t[2]))}(e.emissiveFactor)):null;var p,l;return new c({color:i,colorTexture:r(o(e.textureColor,(t=>s.get(t)))),normalTexture:r(o(e.textureNormal,(t=>s.get(t)))),emissiveColor:a,emissiveTexture:r(o(e.textureEmissive,(t=>s.get(t)))),occlusionTexture:r(o(e.textureOcclusion,(t=>s.get(t)))),alphaMode:J(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r(o(e.textureMetallicRoughness,(t=>s.get(t))))})}(e,v))));const M=function(t){let e=0;const r={color:!1,tangent:!1,normal:!1,texCoord0:!1};for(const{attributes:{position:o,normal:s,color:i,tangent:a,texCoord0:n}}of t.parts)e+=o.count,s&&(r.normal=!0),i&&(r.color=!0),a&&(r.tangent=!0),n&&(r.texCoord0=!0);return{writeIndex:0,vertexAttributes:{position:B(f,e),normal:r.normal?B(j,e):null,tangent:r.tangent?B(g,e):null,color:r.color?B(d,e):null,texCoord0:r.texCoord0?B(y,e):null},components:[]}}(h);for(const t of h.parts)_(M,t,w);const{position:C,normal:U,tangent:A,color:E,texCoord0:R}=M.vertexAttributes,F={position:C.typedBuffer,normal:s(U)?U.typedBuffer:null,tangent:s(A)?A.typedBuffer:null,uv:s(R)?R.typedBuffer:null,color:s(E)?E.typedBuffer:null},I=L(F,i,p);return{transform:I.transform,components:M.components,spatialReference:i.spatialReference,vertexAttributes:new l({position:I.vertexAttributes.position,normal:I.vertexAttributes.normal,tangent:I.vertexAttributes.tangent,color:F.color,uv:F.uv})}}function _(t,e,r){const{position:o,normal:n,tangent:m,color:l,texCoord0:c}=t.vertexAttributes,u=t.writeIndex,f=e.attributes.position.count;if(v(o.slice(u,f),e.attributes.position,e.transform),s(e.attributes.normal)&&s(n)){const t=i(a(),e.transform);w(n.slice(u,f),e.attributes.normal,t)}else s(n)&&M(n,0,0,1,{dstIndex:u,count:f});if(s(e.attributes.tangent)&&s(m)){const t=i(a(),e.transform);R(m.slice(u,f),e.attributes.tangent,t)}else s(m)&&F(m,0,0,1,1,{dstIndex:u,count:f});if(s(e.attributes.texCoord0)&&s(c)?I(c.slice(u,f),e.attributes.texCoord0):s(c)&&q(c,0,0,{dstIndex:u,count:f}),s(e.attributes.color)&&s(l)){const t=e.attributes.color,r=l.slice(u,f);if(4===t.elementCount)t instanceof g?D(r,t,255):t instanceof d?O(r,t):t instanceof x&&P(r,t,8);else{F(r,255,255,255,255);const e=b.fromTypedArray(r.typedBuffer,r.typedBufferStride);t instanceof j?C(e,t,255):t instanceof b?U(e,t):t instanceof h&&A(e,t,8)}}else s(l)&&F(l.slice(u,f),255,255,255,255);const y=function(t,e){switch(e){case 4:return k(t,z);case 5:return N(t);case 6:return G(t)}}(e.indices||f,e.primitiveType);if(u)for(let t=0;t<y.length;t++)y[t]+=u;t.components.push(new p({faces:y,material:r.get(e.material).clone(),trustSourceNormals:!0})),t.writeIndex+=f}function J(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function K(t){return{horizontal:Q(t.s),vertical:Q(t.t)}}function Q(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function H(t){return t**(1/E)*255}export{V as loadGLTFMesh};
