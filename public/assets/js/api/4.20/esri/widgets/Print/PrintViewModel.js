// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../intl ../../request ../../Viewpoint ../../core/Collection ../../core/Error ../../core/Handles ../../core/Loadable ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../geometry/Extent ../../portal/Portal ../../rest/print ../../rest/support/fileFormat ../../rest/support/layoutTemplate ../../rest/support/PrintParameters ../../views/2d/viewpointUtils ./CustomTemplate ../../intl/date".split(" "),
function(q,f,e,D,E,F,u,G,H,g,O,P,Q,R,I,J,x,K,y,z,L,M,A,B){function N(m){m.layoutOptions||(m.layoutOptions={});m.layoutOptions.customTextElements||(m.layoutOptions.customTextElements=[]);m.layoutOptions.customTextElements.find(t=>"date"in t)||({customTextElements:m}=m.layoutOptions,m.push({date:B.formatDate(Date.now(),B.convertDateFormatToIntlOptions("short-date"))}))}const C=F.ofType(A);e=function(m){function t(a){a=m.call(this,a)||this;a._handles=new G;a.allowedFormats="all";a.allowedLayouts="all";
a.defaultTemplates=new C;a.extraParameters=null;a.includeDefaultTemplates=!0;a.effectivePrintServiceUrl=null;a.error=null;a.portal=x.getDefault();a.printServiceUrl=null;a.scaleEnabled=!1;a.templatesInfo=null;a.updateDelay=1E3;a.view=null;a.print=a.print.bind(q._assertThisInitialized(a));return a}q._inheritsLoose(t,m);var r=t.prototype;r.destroy=function(){this._handles.destroy();this.view=this._handles=null};r.load=function(){var a=q._asyncToGenerator(function*(b){this.addResolvingPromise(this._loadResources(b).catch(h=>
this.error=h));return this});return function(b){return a.apply(this,arguments)}}();r.print=function(){var a=q._asyncToGenerator(function*(b){const {view:h,extraParameters:k,updateDelay:d}=this;if(!h)throw new u("print:view-required","view is not set");const c=this._getExtent(h.viewpoint,this.scaleEnabled?b.outScale:void 0);N(b);b=new L({view:h,template:b,extent:c,extraParameters:k,updateDelay:d});try{return yield K.execute(this.effectivePrintServiceUrl,b)}catch(l){throw new u("print:export-error",
"print-task:cim-symbol-unsupported"===l.name?l.message:"An error occurred while exporting the web map.",{error:l});}});return function(b){return a.apply(this,arguments)}}();r._loadResources=function(){var a=q._asyncToGenerator(function*(b){let h=[];var {printServiceUrl:k}=this;if(!k){var d;if(this.destroyed)return;({portal:k}=this);try{yield k.load(b)}catch(l){throw new u("print:could-not-load-portal","Cannot load print resource information from portal",{url:this.effectivePrintServiceUrl});}if(k=
null==(d=k.helperServices)?void 0:d.printTask){var c;this._set("effectivePrintServiceUrl",k.url);h=(null!=(c=null==k?void 0:k.templates)?c:[]).map(l=>A.fromJSON(l))}}0<h.length&&this.defaultTemplates.addMany(h);yield this._loadServiceDescription(b)});return function(b){return a.apply(this,arguments)}}();r._loadServiceDescription=function(){var a=q._asyncToGenerator(function*(b){b=yield this._getPrintTemplatesFromService(b);this._set("templatesInfo",b)});return function(b){return a.apply(this,arguments)}}();
r._getPrintTemplatesFromService=function(a){if(-1===this.effectivePrintServiceUrl.toLowerCase().split("/").indexOf("gpserver"))throw new u("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl});return D(this.effectivePrintServiceUrl,{...a,query:{f:"json"},timeout:6E4}).then(b=>{b=b&&b.data;let h=null,k=null;(b&&b.parameters).forEach(d=>{var c=d.choiceList&&d.choiceList.slice(),l;c&&c.length&&d.defaultValue&&(l=c.indexOf(d.defaultValue));
-1<l&&(c.splice(l,1),c.unshift(d.defaultValue));l=(p,v)=>{const n="all"===v?p:p.filter(w=>-1<v.indexOf(w));return 0===n.length?p:n};if("Format"===d.name)c=l(c.map(y.fromJSON),this.allowedFormats),d=y.fromJSON(d.defaultValue),h={defaultValue:c.includes(d)?d:c[0],choiceList:c};else if("Layout_Template"===d.name){c=c.filter(n=>"map_only"!==n.toLowerCase());let p,v;c.some((n,w)=>{n=n.toLowerCase();if(-1<n.indexOf("letter")&&-1<n.indexOf("landscape"))return p=w,!0;-1<n.indexOf("a4")&&-1<n.indexOf("landscape")&&
(p=w);return!1});p&&(v=c[p],c.splice(p,1),c.unshift(v));c=l(c.map(z.fromJSON),this.allowedLayouts);d=z.fromJSON(d.defaultValue);k={defaultValue:c.includes(d)?d:c[0],choiceList:c}}});this.error=null;return{format:h,layout:k}}).catch(b=>{throw new u("print:unavailable-service-info","Can't fetch templates info from service",{error:b});})};r._getExtent=function(a,b){b=b||this.view.scale;const h=this.get("view.size");a=a?a.targetGeometry:null;return M.getExtent(new J,new E({scale:b,targetGeometry:a}),
h)};q._createClass(t,[{key:"state",get:function(){return"loading"===this.loadStatus?"initializing":this.error||"failed"===this.loadStatus?"error":this.get("view.ready")&&"loaded"===this.loadStatus?"ready":"disabled"}}]);return t}(H);f.__decorate([g.property()],e.prototype,"allowedFormats",void 0);f.__decorate([g.property()],e.prototype,"allowedLayouts",void 0);f.__decorate([g.property({type:C})],e.prototype,"defaultTemplates",void 0);f.__decorate([g.property()],e.prototype,"extraParameters",void 0);
f.__decorate([g.property()],e.prototype,"includeDefaultTemplates",void 0);f.__decorate([g.property({aliasOf:{source:"printServiceUrl",overridable:!0},readOnly:!0})],e.prototype,"effectivePrintServiceUrl",void 0);f.__decorate([g.property()],e.prototype,"error",void 0);f.__decorate([g.property({type:x})],e.prototype,"portal",void 0);f.__decorate([g.property()],e.prototype,"printServiceUrl",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"state",null);f.__decorate([g.property()],e.prototype,
"scaleEnabled",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"templatesInfo",void 0);f.__decorate([g.property()],e.prototype,"updateDelay",void 0);f.__decorate([g.property()],e.prototype,"view",void 0);return e=f.__decorate([I.subclass("esri.widgets.Print.PrintViewModel")],e)});