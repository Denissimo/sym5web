// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/has ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../rest/support/AttachmentQuery ../../../rest/support/Query".split(" "),function(g,k,D,h,
u,y,v,E,F,l,K,L,M,G,H,z){function A(w,p,d){I.error(new v(w,p,d))}const I=F.getLogger("esri.widgets.FeatureTable.support.FeatureStore");h=function(w){function p(a){a=w.call(this,a)||this;a._loaded=!1;a._loadError=!1;a._loading=!1;a._editOperationQueue=[];a._queryOperationQueue=[];a._objectIds=new y;a._hasStaleCache=!1;a.count=0;a.failures=new y;a.itemCache=new y;a.relatedRecordsEnabled=!1;return a}g._inheritsLoose(p,w);var d=p.prototype;d.destroy=function(){this.layer=null;this.itemCache&&this.itemCache.destroy();
this.failures&&this.failures.destroy();this._set("itemCache",null)};d.load=function(){var a=g._asyncToGenerator(function*(){this._reset();const {layer:b}=this;if(!b)return Promise.resolve();this._loading=!0;this.notifyChange("state");try{yield b.when(),yield this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(c){throw this._reset(),this._loadError=!0,this.notifyChange("state"),A("store:load-error","An error ocurred.",{error:c}),c;}});return function(){return a.apply(this,
arguments)}}();d.addItems=function(){var a=g._asyncToGenerator(function*(b){});return function(b){return a.apply(this,arguments)}}();d.fetchItems=function(){var a=g._asyncToGenerator(function*(b){const {page:c,pageSize:e}=b;b=c*e;const f=b+e,{layer:n,state:m}=this;if(!n||"loaded"!==m)return Promise.resolve([]);this.notifyChange("querying");b=yield this._query({start:b,num:f,page:c,pageSize:e});this.notifyChange("state");return b});return function(b){return a.apply(this,arguments)}}();d.query=function(){var a=
g._asyncToGenerator(function*(b){const {layer:c,state:e}=this;if(!c||"loaded"!==e)return[];this.notifyChange("querying");b=yield this._query(b);this.notifyChange("state");return b});return function(b){return a.apply(this,arguments)}}();d.removeItemAt=function(){var a=g._asyncToGenerator(function*(b){});return function(b){return a.apply(this,arguments)}}();d.reset=function(){var a=g._asyncToGenerator(function*(){this._reset()});return function(){return a.apply(this,arguments)}}();d.updateItem=function(){var a=
g._asyncToGenerator(function*(b){return this._update(b)});return function(b){return a.apply(this,arguments)}}();d.getItemByObjectId=function(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.find(e=>e.feature.attributes[c]===a)};d.getLocalItemAt=function(a){return this.itemCache.getItemAt(a)};d.getItemAt=function(a){return Promise.resolve(this.itemCache.getItemAt(a))};d.getObjectIdIndex=function(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.findIndex(e=>e.feature.attributes[c]===
a)};d._reset=function(){this.itemCache.removeAll();this.failures.removeAll();this._editOperationQueue=[];this._queryOperationQueue=[];this._loadError=this._loaded=this._loading=this._hasStaleCache=!1;this._set("count",0);this._objectIds.removeAll();this.notifyChange("querying");this.notifyChange("syncing");this.notifyChange("state")};d._getIdsFromFeatures=function(a){return a.map(b=>b.attributes[this.layer.objectIdField])};d._toFeatureData=function(a,b){const {layer:{objectIdField:c}}=this;return a.map(e=>
{var {attributes:f}=e;f=f[c];return{objectId:f,feature:e,attachments:b?b[f]:null,relatedRecords:null}})};d._update=function(){var a=g._asyncToGenerator(function*(b){const {layer:c}=this,{operations:e}=c.capabilities;if(!e.supportsUpdate)throw new v("store:update-error","Update is not supported.");const {index:f,name:n,value:m}=b;b=yield this.getItemAt(f);if(!b||!b.feature)throw new v("store:update-error","Feature with provided 'objectId' not found.");const {feature:x}=b,q=E.clone(x.attributes);q[n]=
m;b=new D({attributes:q});const t=c.applyEdits({updateFeatures:[b]}).then(r=>{const {updateFeatureResults:B}=r,C=B.find(J=>!!J.error);if(C)throw C.error;-1<this._editOperationQueue.indexOf(()=>t)&&B&&B.length&&(x.attributes=q);return r});return this._queueEditOperation(()=>t)});return function(b){return a.apply(this,arguments)}}();d._query=function(){var a=g._asyncToGenerator(function*(b){const {refresh:c}=b;if(!0===c)return this.itemCache.removeAll(),this._syncLayerInfo().then(()=>this._queryFeatureData(b));
this._hasStaleCache&&(yield this._updateIds(),this._hasStaleCache=!1);return this._queryFeatureData(b)});return function(b){return a.apply(this,arguments)}}();d._queryFeatureData=function(){var a=g._asyncToGenerator(function*(b){var c=this;return this._queueQueryOperation(g._asyncToGenerator(function*(){const {features:e}=yield c._queryFeatures(b);var f=c._getIdsFromFeatures(e);f=yield c._queryAttachments(f);return c._toFeatureData(e,f)||[]}))});return function(b){return a.apply(this,arguments)}}();
d._syncLayerInfo=function(){var a=g._asyncToGenerator(function*(){yield this._updateCount();yield this._updateIds()});return function(){return a.apply(this,arguments)}}();d._updateCount=function(){var a=g._asyncToGenerator(function*(){yield this._queryCount().then(b=>this._set("count",b))});return function(){return a.apply(this,arguments)}}();d._updateIds=function(){var a=g._asyncToGenerator(function*(){var b,c,e;null!=(b=this.layer)&&null!=(c=b.capabilities)&&null!=(e=c.query)&&e.supportsPagination||
(this._objectIds.removeAll(),yield this._queryObjectIds().then(f=>this._objectIds.addMany(f)))});return function(){return a.apply(this,arguments)}}();d._queryCount=function(){const {filterGeometry:a,layer:b,returnGeometry:c}=this;return b.queryFeatureCount(new z({geometry:a,returnGeometry:c,where:this._getWhere()}))};d._queryObjectIds=function(){const {filterGeometry:a,layer:b,orderByFields:c,returnGeometry:e}=this,{capabilities:{query:{supportsCacheHint:f,supportsOrderBy:n}}}=b,m=new z({geometry:a,
outFields:[b.objectIdField],returnGeometry:e,where:this._getWhere()});n&&(m.orderByFields=c);f&&(m.cacheHint=!0);return b.queryObjectIds(m)};d._queryFeatures=function(){var a=g._asyncToGenerator(function*(b){const {layer:c}=this;if(!c.capabilities.operations.supportsQuery)return Promise.reject(new v("store:query-error","Layer does not support query operation."));const {filterGeometry:e,layer:{capabilities:{query:{supportsCacheHint:f,supportsOrderBy:n,supportsPagination:m}}},orderByFields:x,returnGeometry:q}=
this,{start:t,pageSize:r}=b;b=new z({returnGeometry:q,outFields:["*"]});m?(b.start=t,b.num=r,b.where=this._getWhere()):b.objectIds=this._getObjectIdsForPage(t,r);n&&(b.orderByFields=x);e&&(b.geometry=e);f&&(b.cacheHint=!0);return c.queryFeatures(b)});return function(b){return a.apply(this,arguments)}}();d._getObjectIdsForPage=function(a,b){const c=this._objectIds.toArray();return c.length>=a+b?c.slice(a,a+b):c.slice(a)};d._queryAttachments=function(a){const {attachmentsEnabled:b,layer:c}=this,{capabilities:{data:{supportsAttachment:e},
operations:{supportsQueryAttachments:f}}}=c;return b&&e&&f?c.queryAttachments(new H({objectIds:a,where:this._getWhere()})):Promise.resolve(null)};d._queueQueryOperation=function(a){this._queryOperationQueue.push(a);this.notifyChange("querying");return a().then(b=>-1<this._queryOperationQueue.indexOf(a)?(this.itemCache.addMany(b),b):[]).catch(b=>{A("store:query-error","An error ocurred.",{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueQueryOperation(a)},cancel:()=>this.failures.remove(c)};
this.failures.add(c);return[]}).then(b=>{u.remove(this._queryOperationQueue,a);this.notifyChange("querying");return b})};d._queueEditOperation=function(a){this._editOperationQueue.push(a);this.notifyChange("syncing");return a().then(()=>{u.remove(this._editOperationQueue,a);this.notifyChange("syncing")}).catch(b=>{A("store:edit-error","An error ocurred.",{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueEditOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);
u.remove(this._editOperationQueue,a);this.notifyChange("syncing");throw b;})};d._getWhere=function(){return this.where||this.layer.definitionExpression||"1\x3d1"};g._createClass(p,[{key:"attachmentsEnabled",set:function(a){this._reset();this._set("attachmentsEnabled",a);this.notifyChange("state")}},{key:"filterGeometry",set:function(a){this._reset();this._set("filterGeometry",a);this.notifyChange("state")}},{key:"layer",set:function(a){this._reset();this._set("layer",a);this.notifyChange("state")}},
{key:"orderByFields",get:function(){return this._get("orderByFields")||[]},set:function(a){u.equals(a,this.orderByFields)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",a))}},{key:"querying",get:function(){return 0<this._queryOperationQueue.length}},{key:"returnGeometry",set:function(a){this._reset();this._set("returnGeometry",a);this.notifyChange("state")}},{key:"state",get:function(){const {layer:a,_loaded:b,_loadError:c,_loading:e}=this;return c?"error":!a||this.get("layer.loadError")?
"disabled":e?"loading":"loaded"===this.get("layer.loadStatus")&&b?"loaded":"ready"}},{key:"syncing",get:function(){return 0<this._editOperationQueue.length}},{key:"where",get:function(){return this._get("where")||null},set:function(a){this._reset();this._set("where",a);this.notifyChange("state")}}]);return p}(h);k.__decorate([l.property()],h.prototype,"attachmentsEnabled",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"count",void 0);k.__decorate([l.property({readOnly:!0})],h.prototype,
"failures",void 0);k.__decorate([l.property()],h.prototype,"filterGeometry",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"itemCache",void 0);k.__decorate([l.property({value:null})],h.prototype,"layer",null);k.__decorate([l.property()],h.prototype,"orderByFields",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"querying",null);k.__decorate([l.property()],h.prototype,"relatedRecordsEnabled",void 0);k.__decorate([l.property({value:!1})],h.prototype,"returnGeometry",null);k.__decorate([l.property({readOnly:!0})],
h.prototype,"state",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"syncing",null);k.__decorate([l.property()],h.prototype,"where",null);return h=k.__decorate([G.subclass("esri.widgets.FeatureTable.support.FeatureStore")],h)});