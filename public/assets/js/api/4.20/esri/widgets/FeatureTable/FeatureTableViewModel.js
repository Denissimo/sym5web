// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Collection ../../core/HandleOwner ../../core/Handles ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./AttachmentsColumn ./FieldColumn ./Grid/Grid ./Grid/GridViewModel ./support/FeatureStore ../../intl/locale ../../intl/messages".split(" "),
function(q,f,D,e,E,F,G,r,h,Q,R,S,T,H,I,J,y,K,L,z,M,A){e=function(B){function w(a){var b=B.call(this,a)||this;b._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"];b._highlights=new G;b.cellClassNameGenerator=(k,n)=>k.path||null;b.dataProvider=function(){var k=q._asyncToGenerator(function*(n,l){const {store:m}=q._assertThisInitialized(b),{page:v,pageSize:t,sortOrders:u}=n;n=b._sortOrdersToLayerOrderByFields(u);l&&(m?(yield m.set({orderByFields:n}),"loaded"!==m.state&&"loading"!==
m.state&&(yield m.load()),l&&l(yield m.fetchItems({page:v,pageSize:t}))):l&&l([]))});return function(n,l){return k.apply(this,arguments)}}();b.editingEnabled=!1;b.grid=null;b.hiddenFields=new E;b.highlightOnRowSelectEnabled=!0;b.itemIdPath="objectId";b.messagesCommon=null;b.relatedRecordsEnabled=!1;b.store=null;b.view=null;const {hiddenFields:c,itemIdPath:g}=q._assertThisInitialized(b);c.addMany(b._defaultHiddenFields);b._set("store",new z);b._set("grid",new K({itemIdPath:g,viewModel:q._assertThisInitialized(b)}));
return b}q._inheritsLoose(w,B);var d=w.prototype;d.initialize=function(){var a=this;const b=function(){var c=q._asyncToGenerator(function*(){a.messages=yield A.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable");a.messagesCommon=yield A.fetchMessageBundle("esri/t9n/common")});return function(){return c.apply(this,arguments)}}();b();this.handles.add([M.onLocaleChange(b),r.on(this,"grid.selectedItems","change",c=>this._onSelectionChange(c)),r.watch(this,"relatedRecordsEnabled",c=>this.store.relatedRecordsEnabled=
c),r.watch(this,["layer.loaded"],()=>{var c;null!=(c=this.layer)&&c.loaded&&this._onLayerLoad()}),r.watch(this.store,"state",c=>{if("loaded"===c){var g;null==(g=this.grid)?void 0:g.scrollToTop()}}),r.watch(this,["editingEnabled","messages"],()=>{var c;return(null==(c=this.layer)?void 0:c.loaded)&&this._generateColumns()}),r.watch(this,"layer.definitionExpression",(c,g)=>(c||g)&&"loaded"===this.store.state&&this.refresh())])};d.destroy=function(){var a,b;this._resetColumns();this.handles.removeAll();
this._highlights.removeAll();this._highlights.destroy();null==(a=this.grid)?void 0:a.destroy();null==(b=this.columns)?void 0:b.destroy();this.view=this.layer=null};d.clearHighlights=function(){this._highlights.removeAll()};d.clearSelection=function(){var a;null==(a=this.grid)?void 0:a.clearSelection()};d.deselectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid.deselectRows(a)};d.getObjectIdIndex=function(a){var b;return null==(b=this.store)?void 0:b.getObjectIdIndex(a)};d.getValue=
function(a,b){var c;a=this.store.getItemByObjectId(a);return null==a?void 0:null==(c=a.feature)?void 0:c.attributes[b]};d.refresh=function(){var a;null==(a=this.grid)?void 0:a.refresh()};d.selectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid.selectRows(a)};d.scrollToIndex=function(a){var b;null==(b=this.grid)?void 0:b.scrollToIndex(a)};d._onLayerLoad=function(){const a=this.layer.capabilities.query.maxRecordCount;a&&a<this.pageSize&&this.grid&&(this.grid.pageSize=a);this._generateColumns()};
d._generateColumns=function(){this._resetColumns();this.columns.addMany([...this._createFieldColumns()]);this.attachmentsEnabled&&this.columns.push(this._createAttachmentsColumn())};d._createFieldColumns=function(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()};d._createColumnsFromConfigs=function(){var a,b;const {editingEnabled:c,fieldConfigs:g,grid:k,hiddenFields:n,layer:l,messages:m,messagesCommon:v,store:t}=this,u=null!=(a=
null==(b=this.layer)?void 0:b.fields)?a:[];return g.filter(p=>(u||[]).find(x=>p.name===x.name)).map(p=>{const x=p.direction||null,N=p.formatFunction||null,C=(u||[]).find(O=>p.name===O.name),P=!1===p.visible||!0!==p.visible&&-1<n.indexOf(C.name);return new y({config:p,direction:x,editingEnabled:c,field:C,formatFunction:N,grid:k,hidden:P,layer:l,store:t,messages:m,messagesCommon:v})})};d._createColumnsFromFields=function(){var a,b;const {editingEnabled:c,grid:g,hiddenFields:k,layer:n,messages:l,messagesCommon:m,
store:v}=this;return(null!=(a=null==(b=this.layer)?void 0:b.fields)?a:[]).map(t=>{const u=-1<k.indexOf(t.name);return new y({editingEnabled:c,field:t,grid:g,hidden:u,layer:n,store:v,messages:l,messagesCommon:m})})};d._createAttachmentsColumn=function(){var a;return new J({header:null==(a=this.messages)?void 0:a.attachments})};d._sortOrdersToLayerOrderByFields=function(a){return a&&a.length?a.filter((b,c,g)=>g.map(k=>k.path).indexOf(b.path)===c).map(({direction:b,path:c})=>b?c+" "+b.toUpperCase():
""):[]};d._highlight=function(a){var {view:b}=this;b=b&&a&&b.allLayerViews.items.find(({layer:c})=>c===a.layer);I.highlightsSupported(b)&&this._highlights.add(b.highlight(a),`feature-${a.getObjectId()}`)};d._unhighlight=function(a){a&&this._highlights.remove(`feature-${a.getObjectId()}`)};d._getStoreItemsFromSelectionParams=function(a){const b=[];a=a instanceof Array?a:[a];a.forEach(c=>{const g=c instanceof D?c:null;c=g?g.getObjectId():c;"number"!==typeof c&&"string"!==typeof c||b.push({objectId:c})});
return b};d._onSelectionChange=function(a){const {highlightOnRowSelectEnabled:b}=this,{added:c,removed:g}=a;b&&c.forEach(k=>this._highlight(k.feature));b&&g.forEach(k=>this._unhighlight(k.feature))};d._resetColumns=function(){this.columns.items.forEach(a=>a.destroy());this.columns.removeAll()};q._createClass(w,[{key:"attachmentsEnabled",set:function(a){this.attachmentsEnabled!==a&&(this._set("attachmentsEnabled",a),this._generateColumns(),this.store.attachmentsEnabled=a)}},{key:"fieldConfigs",set:function(a){var b;
this._set("fieldConfigs",a);(null==(b=this.layer)?0:b.loaded)&&this._generateColumns()}},{key:"filterGeometry",set:function(a){if(this.filterGeometry||a)this.clearSelection(),this._set("filterGeometry",a),this.store.filterGeometry=a}},{key:"layer",set:function(a){var b;this._set("layer",a);null==(b=this.grid)?void 0:b.clearSort();this._resetColumns();(this.store.layer=a)&&(a.loaded?this._onLayerLoad():a.load());this.notifyChange("state")}},{key:"messages",set:function(a){var b;null==(b=this.grid)?
void 0:b.set("messages",a);this._set("messages",a)}}]);return w}(F.HandleOwnerMixin(L));f.__decorate([h.property()],e.prototype,"attachmentsEnabled",null);f.__decorate([h.property()],e.prototype,"cellClassNameGenerator",void 0);f.__decorate([h.property()],e.prototype,"dataProvider",void 0);f.__decorate([h.property()],e.prototype,"editingEnabled",void 0);f.__decorate([h.property()],e.prototype,"fieldConfigs",null);f.__decorate([h.property()],e.prototype,"filterGeometry",null);f.__decorate([h.property({readOnly:!0})],
e.prototype,"grid",void 0);f.__decorate([h.property()],e.prototype,"hiddenFields",void 0);f.__decorate([h.property()],e.prototype,"highlightOnRowSelectEnabled",void 0);f.__decorate([h.property({readOnly:!0})],e.prototype,"itemIdPath",void 0);f.__decorate([h.property()],e.prototype,"layer",null);f.__decorate([h.property()],e.prototype,"messages",null);f.__decorate([h.property()],e.prototype,"messagesCommon",void 0);f.__decorate([h.property()],e.prototype,"relatedRecordsEnabled",void 0);f.__decorate([h.property({readOnly:!0,
type:z})],e.prototype,"store",void 0);f.__decorate([h.property()],e.prototype,"view",void 0);return e=f.__decorate([H.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],e)});