// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Color ../../Graphic ../../symbols ../../core/Collection ../../core/Error ../../core/Evented ../../core/Handles ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../geometry/support/graphicsUtils ../../intl/locale ../../layers/GraphicsLayer ../../rest/networkService ../../rest/support/FeatureSet ../../rest/support/RouteParameters ../../tasks/RouteTask ./support/directionsUtils ../support/GoTo ../../symbols/SimpleMarkerSymbol ../../symbols/PictureMarkerSymbol ../../symbols/SimpleLineSymbol".split(" "),
function(x,g,N,O,f,F,y,P,Q,R,S,G,B,k,ea,fa,ha,T,U,V,C,W,X,H,I,w,Y,D,J,Z){const aa=R.getLogger("esri.widgets.Directions.DirectionsViewModel"),K={first:new D({color:[105,220,255,1],size:19,outline:{color:[51,51,51,1],width:3}}),middle:new D({color:[51,51,51,1],size:12,outline:{color:[105,220,255,1],width:3}}),last:new J({width:23,height:23,url:`data:image/svg+xml;base64,${btoa('\x3csvg width\x3d"30" height\x3d"30" viewBox\x3d"0 0 30 30" xmlns\x3d"http://www.w3.org/2000/svg"\x3e\x3cg fill-rule\x3d"nonzero" fill\x3d"none"\x3e\x3cpath d\x3d"M15.15.3C6.9.3.3 6.9.3 15.15S6.9 29.7 15.15 29.7 29.7 23.1 29.7 15.15C29.7 6.9 23.25.3 15.15.3z" fill\x3d"#333"/\x3e\x3cpath d\x3d"M15 4.8C9.3 4.8 4.8 9.45 4.8 15c0 5.55 4.65 10.2 10.2 10.2 5.55 0 10.2-4.5 10.2-10.2 0-5.55-4.5-10.2-10.2-10.2z" fill\x3d"#69DCFF"/\x3e\x3cpath fill\x3d"#333" d\x3d"M10.5 10.5h9v9h-9z"/\x3e\x3c/g\x3e\x3c/svg\x3e')}`}),
unlocated:new J({height:18,width:18,url:`data:image/svg+xml;base64,${btoa('\x3csvg width\x3d"20" height\x3d"20" viewBox\x3d"0 0 20 20" xmlns\x3d"http://www.w3.org/2000/svg"\x3e\x3cg fill\x3d"none" fill-rule\x3d"evenodd"\x3e\x3cpath d\x3d"M10.1.2C4.6.2.2 4.6.2 10.1s4.4 9.7 9.9 9.7 9.7-4.4 9.7-9.7c0-5.5-4.3-9.9-9.7-9.9z" fill\x3d"#333" fill-rule\x3d"nonzero"/\x3e\x3cpath d\x3d"M10 2.7c-4.08 0-7.3 3.328-7.3 7.3s3.328 7.3 7.3 7.3 7.3-3.22 7.3-7.3c0-3.972-3.22-7.3-7.3-7.3z" fill\x3d"#69DCFF" fill-rule\x3d"nonzero"/\x3e\x3cpath d\x3d"M11.414 10l5.304-5.303-1.415-1.415L10 8.586 4.697 3.282 3.282 4.697 8.586 10l-5.304 5.303 1.415 1.415L10 11.414l5.303 5.304 1.415-1.415L11.414 10z" fill\x3d"#333"/\x3e\x3c/g\x3e\x3c/svg\x3e')}`}),
waypoint:new D({color:[255,255,255,1],size:10,outline:{color:[20,89,127,1],width:2.5}})};f=function(L){function z(a){a=L.call(this,a)||this;a._handles=new Q;a._routeLayer=new C({listMode:"hide"});a._highlightLayer=new C({listMode:"hide"});a._stopId=9999;a._stopLayer=new C({listMode:"hide"});a._serviceDescriptionLoadStatus=0;a.apiKey=void 0;a.departureTime="now";a.lastRoute=null;a.routeSymbol=new Z({color:[105,220,255,1],width:7,cap:"round",join:"round"});a.routeParameters=new H({doNotLocateOnRestrictedElements:!0,
ignoreInvalidLocations:!0,directionsOutputType:"complete",findBestSequence:!1,preserveFirstStop:!0,preserveLastStop:!0,restrictUTurns:"at-dead-ends-and-intersections",directionsLengthUnits:"kilometers",returnBarriers:!1,returnDirections:!0,returnPolygonBarriers:!1,returnPolylineBarriers:!1,returnRoutes:!1,returnStops:!0,returnZ:!0,startTime:null,startTimeIsUTC:!0,stops:null,useHierarchy:!0,useTimeWindows:!1});a.routeServiceUrl="https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World";
a.serviceDescription=null;a.error=null;a.stops=new F;a.view=null;return a}x._inheritsLoose(z,L);var n=z.prototype;n.initialize=function(){this._handles.add([B.on(this,"stops","change",()=>{this.clearResults();this._addStopsToLayer()}),B.init(this,"view.map",(a,b)=>{const d=[this._routeLayer,this._stopLayer,this._highlightLayer];b&&b.removeMany(d);a&&a.addMany(d)}),B.watch(this,"lastRoute",()=>this._addRouteToLayer())])};n.destroy=function(){this.stops.destroy();const a=this.get("view.map");a&&a.removeMany([this._routeLayer,
this._stopLayer,this._highlightLayer])};n.load=function(){var a=x._asyncToGenerator(function*(){if(!this.serviceDescription)try{this._serviceDescriptionLoadStatus=1,this.notifyChange("state"),yield this._loadServiceDescription(),this._serviceDescriptionLoadStatus=2,this.notifyChange("state")}catch(d){var b="identity-manager:user-aborted"===d.name;this._serviceDescriptionLoadStatus=b?4:3;this.notifyChange("state");if(!b)throw b=new y("directions-view-model:service-metadata-unavailable","Cannot load route service metadata",
{error:d}),this._set("error",b),b;}});return function(){return a.apply(this,arguments)}}();n.highlightSegment=function(a){const {view:b,_highlightLayer:d}=this;if(b&&!S.isNone(a.symbol)){this.clearHighlights();var e=a.symbol.clone();e.color=new N([0,0,0,.8]);e.width=Math.ceil(e.width/2);a=new O({geometry:a.geometry,symbol:e});d.graphics.add(a)}};n.clearHighlights=function(){this._highlightLayer.graphics.removeAll()};n.centerAt=function(a){const {view:b}=this;b&&this.callGoTo({target:a})};n.clearResults=
function(){this._set("lastRoute",null)};n.getDirections=function(){var {state:a}=this;if("unauthenticated"===a||"initializing"===a||"disabled"===a||3===this._serviceDescriptionLoadStatus)return Promise.reject(new y("directions-view-model:not-loaded","Cannot get directions until view model loads."));this._set("error",null);this._activeRouteController&&(this._activeRouteController.abort(),this._activeRouteController=null);const {apiKey:b,departureTime:d}=this;a="now"===d;const e="now"===d?new Date:
d;if(e&&!a){const h=6E4*e.getTimezoneOffset();e.setTime(e.getTime()-h)}const l=this.routeParameters.clone();l.set({startTime:e,startTimeIsUTC:a,directionsLanguage:this._directionsLanguage,apiKey:b});this.selectedTravelMode&&(l.travelMode=this.selectedTravelMode);if(1>=this.stops.length)return a=new y("directions-view-model:not-enough-stops","Not enough stops for routing"),this._set("error",a),Promise.reject(a);a=new AbortController;const {signal:r}=a;this._activeRouteController=a;a=this._enqueue(()=>
{const h=this.stops.clone().toArray(),v={},M=c=>{const u=c&&c.routeResults&&c.routeResults[0]&&c.routeResults[0].stops||[];(c&&c.routeResults&&c.routeResults[0]&&c.routeResults[0].directions&&c.routeResults[0].directions.features||[]).map(m=>{for(let p=0;p<h.length;p++)if(-1<m.attributes.text.indexOf(h[p].attributes.Name)){const A=h[p].attributes.Name;m.attributes.text=m.attributes.text.replace(A,v[A]);m._associatedStop=h[p];break}});h.map(m=>m.attributes.Name=v[m.attributes.Name]);u.map(m=>{m.attributes.Name=
v[m.attributes.Name]})},ca=c=>{if(c&&c.routeResults&&c.routeResults[0]){c=c.routeResults[0];const u=c.stops||[],m=this.stops.clone().toArray();let p=c.directions&&c.directions.routeName||c.routeName||"";u.map((A,ba)=>{const q=A.attributes,t=m[ba].attributes;p=p.replace(q.Name,t.Name);Object.keys(q).forEach(E=>{0===E.indexOf("Cumul_")&&(t[E]=q[E])});t.ArriveCurbApproach=q.ArriveCurbApproach;t.ArriveTime=q.ArriveTime;t.ArriveTimeUTC=q.ArriveTimeUTC;t.DepartCurbApproach=q.DepartCurbApproach;t.DepartTime=
q.DepartTime;t.DepartTimeUTC=q.DepartTimeUTC;t.Sequence=q.Sequence;t.Status=q.Status});c.directions&&(c.directions.routeName=p);null!==c.route&&(c.route.attributes.Name=p);c.routeName=p}},da=c=>{c=c&&c.routeResults&&c.routeResults[0]&&c.routeResults[0].stops||[];const u=this.stops.toArray();let m=c.length===u.length,p=0;for(;m&&p<c.length;)m=m&&v[c[p].attributes.Name]===u[p++].attributes.Name;return m};(()=>{h.map(c=>{c=c.attributes;const u=`${(c.Name||"[not yet geocoded]").substr(0,100)}_#${++this._stopId}`;
v[u]=c.Name;c.Name=u})})();l.stops=new X({features:h});return this._routeTask.solve(l,{signal:r}).then(c=>{if(da(c))return ca(c),M(c),this._set("lastRoute",c),c;aa.warn("Response stops don't match current stops of the ViewModel, invalidating the results.");this._set("lastRoute",null);return null}).catch(c=>{M(null);throw c;})}).then(h=>{this._activeRouteController=null;this.notifyChange("state");this.zoomToRoute();return h}).catch(h=>{this._activeRouteController=null;this.notifyChange("state");if(!G.isAbortError(h))throw h=
new y("directions-view-model:unable-to-route","Unable to route to these addresses",{error:h}),this._set("error",h),h;});this.notifyChange("state");return a};n.getCostAttribute=function(a){const b=this.serviceDescription&&this.serviceDescription.networkDataset.networkAttributes||[];let d="";for(let e=0;e<b.length;e++)if(b[e].name===a&&"esriNAUTCost"===b[e].usageType){d=b[e];break}return d};n.reset=function(){this.stops.removeAll();this.clearHighlights();this._set("lastRoute",null)};n.zoomToRoute=function(){const {directionLines:a,
view:b}=this;if(a&&b){var d=U.graphicsExtent(a);this.callGoTo({target:d.expand(d.width>d.height?2:1)})}};n._loadServiceDescription=function(){var a=x._asyncToGenerator(function*(){const b=yield W.fetchServiceDescription(this.routeServiceUrl,this.apiKey);this._set("serviceDescription",b)});return function(){return a.apply(this,arguments)}}();n._enqueue=function(a){this._requestQueueTail||(this._requestQueueTail=Promise.resolve());const b=new Promise((d,e)=>{this._requestQueueTail.catch(()=>{}).then(()=>
{try{const l=a.call(this);G.isPromiseLike(l)?l.then(d,e):d(l)}catch(l){e(l)}})});return this._requestQueueTail=b};n._addStopsToLayer=function(){this._stopLayer.graphics.removeAll();const a=this.stops.clone().map((b,d)=>{const {first:e,middle:l,last:r,unlocated:h,waypoint:v}=this.stopSymbols;w.isWaypoint(b)?b.symbol=v:b.symbol=void 0===b.attributes.Status?0===d?e:d===this.stops.length-1?r:l:w.isWaypoint(b)?v:w.isStopLocated(b)?w.isFirstStop(b)?e:w.isLastStop(b)?r:l:h;return b});this._stopLayer.graphics.addMany(a)};
n._addRouteToLayer=function(){this._routeLayer.graphics.removeAll();const {directionLines:a}=this;a&&(a.forEach(b=>{b.symbol=this.routeSymbol}),this._routeLayer.graphics.addMany(a))};x._createClass(z,[{key:"_directionsLanguage",get:function(){const {routeParameters:a,serviceDescription:b}=this,{directionsSupportedLanguages:d}=b;if(d){var e=(a.directionsLanguage||V.getLocale()).slice(0,2);return d.find(l=>l.toLowerCase().slice(0,2)===e)}}},{key:"_routeTask",get:function(){return new I(this.routeServiceUrl)}},
{key:"impedanceAttribute",get:function(){var a,b,d,e,l,r;const h=null!=(a=null!=(b=null==(d=this.routeParameters)?void 0:null==(e=d.travelMode)?void 0:e.impedanceAttributeName)?b:null==(l=this.routeParameters)?void 0:l.impedanceAttribute)?a:null==(r=this.serviceDescription)?void 0:r.impedance;return this.getCostAttribute(h)}},{key:"maxStops",set:function(a){this._set("maxStops",2>=a?2:50<a?50:a)}},{key:"selectedTravelMode",get:function(){var {serviceDescription:a}=this;if(!a)return null;const {defaultTravelMode:b,
supportedTravelModes:d=[]}=a;a=null;for(let e=0;e<d.length;e++)d[e].id===b&&(a=d[e]);return a||d[0]||null},set:function(a){void 0===a?this._clearOverride("selectedTravelMode"):this._override("selectedTravelMode",a)}},{key:"state",get:function(){const a=this._serviceDescriptionLoadStatus;return 4===a?"unauthenticated":0===a?"disabled":1===a?"initializing":this._activeRouteController?"routing":3===a||this.error?"error":"ready"}},{key:"stopSymbols",set:function(a){this._set("stopSymbols",{...K,...a})}},
{key:"timeAttribute",get:function(){var a,b,d,e,l,r;const h=null!=(a=null!=(b=null==(d=this.routeParameters)?void 0:null==(e=d.travelMode)?void 0:e.timeAttributeName)?b:null==(l=this.routeParameters)?void 0:l.directionsTimeAttribute)?a:null==(r=this.serviceDescription)?void 0:r.directionsTimeAttribute;return this.getCostAttribute(h)}},{key:"travelModes",get:function(){var a,b;return null!=(a=null==(b=this.serviceDescription)?void 0:b.supportedTravelModes)?a:[]}}]);return z}(Y.GoToMixin(P.EventedAccessor));
g.__decorate([k.property()],f.prototype,"_directionsLanguage",null);g.__decorate([k.property({type:I})],f.prototype,"_routeTask",null);g.__decorate([k.property()],f.prototype,"apiKey",void 0);g.__decorate([k.property()],f.prototype,"departureTime",void 0);g.__decorate([k.property({aliasOf:"lastRoute.routeResults.0.directions.features"})],f.prototype,"directionLines",void 0);g.__decorate([k.property({readOnly:!0})],f.prototype,"impedanceAttribute",null);g.__decorate([k.property({readOnly:!0})],f.prototype,
"lastRoute",void 0);g.__decorate([k.property({value:50})],f.prototype,"maxStops",null);g.__decorate([k.property()],f.prototype,"routeSymbol",void 0);g.__decorate([k.property({type:H})],f.prototype,"routeParameters",void 0);g.__decorate([k.property()],f.prototype,"routeServiceUrl",void 0);g.__decorate([k.property()],f.prototype,"selectedTravelMode",null);g.__decorate([k.property({readOnly:!0})],f.prototype,"serviceDescription",void 0);g.__decorate([k.property({readOnly:!0})],f.prototype,"state",null);
g.__decorate([k.property()],f.prototype,"error",void 0);g.__decorate([k.property({type:F})],f.prototype,"stops",void 0);g.__decorate([k.property({value:K})],f.prototype,"stopSymbols",null);g.__decorate([k.property({readOnly:!0})],f.prototype,"timeAttribute",null);g.__decorate([k.property()],f.prototype,"travelModes",null);g.__decorate([k.property()],f.prototype,"view",void 0);g.__decorate([k.property()],f.prototype,"getDirections",null);g.__decorate([k.property()],f.prototype,"zoomToRoute",null);
return f=g.__decorate([T.subclass("esri.widgets.Directions.DirectionsViewModel")],f)});