// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Evented ../../core/HandleOwner ../../core/ObjectPool ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ./TemplateItem ./TemplateItemGroup".split(" "),function(u,f,e,x,v,y,g,D,E,F,G,z,w,A){const B=({layer:n})=>({key:n,label:n.title}),C=({layer:n})=>n.geometryType;e=
function(n){function q(a){a=n.call(this,a)||this;a._itemPool=new v(w);a._groupPool=new v(A);a.filterFunction=null;a.groupBy="layer";a.selectedItem=null;return a}u._inheritsLoose(q,n);var h=q.prototype;h.destroy=function(){this._templateToLayer.clear()};h.refresh=function(){this.notifyChange("items")};h.select=function(a){a=(null==a?void 0:a.clone())||null;this._set("selectedItem",a);this.emit("select",{item:a,template:(null==a?void 0:a.template)||null})};h._getTemplatesForLayer=function(a){const b=
a.templates||[];a=(a.types||[]).map(d=>d.templates).reduce((d,p)=>[...d,...p],[]);return[...b,...a]};h._createItem=function(a){const b=this._itemPool.acquire();b.set({template:a,layer:this._templateToLayer.get(a)});return b};h._createGroup=function(a,b){const d=this._groupPool.acquire();d.set("label",a);d.items=b;return d};h._releasePreviousItems=function(){this._destroyItems(this._get("items"))};h._destroyItems=function(a){a&&(a[0]instanceof w?a.forEach(b=>this._destroyItem(b)):a.forEach(b=>this._destroyGroup(b)))};
h._destroyGroup=function(a){a.items.forEach(b=>this._destroyItem(b));a.items.length=0;this._groupPool.release(a)};h._destroyItem=function(a){a.layer=null;a.template=null;this._itemPool.release(a)};u._createClass(q,[{key:"_templateToLayer",get:function(){const a=new Map;for(const {layer:b,templates:d}of this._featureTemplateInfos)for(const p of d)a.set(p,b);return a}},{key:"layers",get:function(){return this._get("layers")},set:function(a){this.handles.remove("layers");if(a){const b=()=>this.notifyChange("state");
this.handles.add(a.map(d=>y.when(d,"loadStatus",b)),"layers")}this._set("layers",a)}},{key:"state",get:function(){const {layers:a}=this;return a&&0!==a.length?a.some(b=>"loading"===b.loadStatus||"not-loaded"===b.loadStatus)?"loading":"ready":"disabled"}},{key:"_featureTemplateInfos",get:function(){return this.layers?this.layers.filter(({capabilities:a,loaded:b})=>b&&a.operations.supportsEditing&&a.operations.supportsAdd).map(a=>{const b=this._getTemplatesForLayer(a);return{layer:a,templates:b}}).filter(a=>
null!=a&&0<a.templates.length):[]}},{key:"numberOfFeatureTemplates",get:function(){return this._featureTemplateInfos.reduce((a,b)=>a+b.templates.length,0)}},{key:"items",get:function(){var a=this._featureTemplateInfos;if(0===a.length)return this._releasePreviousItems(),[];const {groupBy:b}=this;if("none"===b)return a=a.map(({templates:c})=>c.filter(({name:k})=>!this.filterFunction||this.filterFunction({label:k}))).map(c=>c.map(k=>this._createItem(k))).reduce((c,k)=>[...c,...k],[]),this._releasePreviousItems(),
a;a=a.reduce((c,{layer:k,templates:r})=>{r.forEach(m=>{var l=("layer"===b?B:"geometry"===b?C:b)({template:m,layer:k});if(l){const t="string"===typeof l?l:l.key;l="string"===typeof l?l:l.label;c.has(t)||c.set(t,{label:l,templates:[]});c.get(t).templates.push(m)}});return c},new Map);if(0===a.size)return this._releasePreviousItems(),[];const d=[],{filterFunction:p}=this;a.forEach(c=>{const {label:k,templates:r}=c;!p||this.filterFunction(c)?d.push(this._createGroup(k,r.map(m=>this._createItem(m)))):
(c=r.filter(({name:m})=>this.filterFunction({label:m})).map(m=>this._createItem(m)),0<c.length&&d.push(this._createGroup(k,c)))});this._releasePreviousItems();return d}}]);return q}(x.HandleOwnerMixin(e.EventedAccessor));f.__decorate([g.property({readOnly:!0})],e.prototype,"_templateToLayer",null);f.__decorate([g.property()],e.prototype,"filterFunction",void 0);f.__decorate([g.property()],e.prototype,"groupBy",void 0);f.__decorate([g.property()],e.prototype,"layers",null);f.__decorate([g.property()],
e.prototype,"state",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"_featureTemplateInfos",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"numberOfFeatureTemplates",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"items",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"selectedItem",void 0);f.__decorate([g.property()],e.prototype,"select",null);return e=f.__decorate([z.subclass("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],e)});