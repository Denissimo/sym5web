// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../geometry ../../core/asyncUtils ../../core/Collection ../../core/HandleOwner ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../geometry/support/contains ../../geometry/support/webMercatorUtils ../../geometry/SpatialReference".split(" "),function(r,u,q,A,w,B,x,v,G,
H,I,J,C,D,y,E){function z(f,g){return f&&"copyright"in f&&(!g||"function"===typeof f.originOf&&"user"===f.originOf("copyright"))}function F(f,g){return f.length!==g.length||f.some((m,e)=>m.text!==g[e].text)}function t(f,g,m){m&&g&&(f.find(e=>e.layerView===g&&e.text===m)||f.push({text:m,layerView:g}))}const n=[];q=function(f){function g(e){var a=f.call(this,e)||this;a.clear=()=>{a._fetchedAttributionData.clear();a._pendingAttributions.clear();a.handles.remove("suspension");a.notifyChange("state")};
a._pendingAttributions=new Set;a._fetchedAttributionData=new Map;a.items=new w;a.view=null;a._allLayerViewsChange=b=>{a.handles.remove("suspension");const c=a.get("view.allLayerViews");c&&a.handles.add(c.map(d=>d.watch(["suspended","attributionVisible"],a._updateAttributionItems)),"suspension");b&&b.removed&&b.removed.forEach(d=>{a._pendingAttributions.delete(d);a._fetchedAttributionData.delete(d)});a._updateAttributionItems()};a._updateAttributionItems=()=>{const b=a.get("view.allLayerViews");n.length=
0;b?(b.forEach(c=>{if(!c.suspended&&c.get("layer.attributionVisible")){var d=c.layer;if(z(d,"user"))t(n,c,d.copyright);else if(d.hasAttributionData)if(a._fetchedAttributionData.has(c)){var h=a._fetchedAttributionData.get(c);h?t(n,c,a._getDynamicAttribution(h,a.view,d)):z(d)&&t(n,c,d.copyright)}else a._fetchAttributionData(c);else(h=d.get("portalItem.accessInformation"))?t(n,c,h):t(n,c,d.copyright)}}),F(a.items,n)&&(a.items.removeAll(),a.items.addMany(n)),n.length=0,a.notifyChange("state")):a.clear()};
a.handles.add([x.on(r._assertThisInitialized(a),"view.allLayerViews","change",a._allLayerViewsChange,a._allLayerViewsChange,a.clear),x.whenTrue(r._assertThisInitialized(a),"view.stationary",()=>a._updateAttributionItems())]);return a}r._inheritsLoose(g,f);var m=g.prototype;m.destroy=function(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear();this.items.removeAll()};m._fetchAttributionData=function(){var e=r._asyncToGenerator(function*(a){if(!this._pendingAttributions.has(a)){this._pendingAttributions.add(a);
var b=yield A.result(a.layer.fetchAttributionData());this._pendingAttributions.has(a)&&(b=b.ok?this._createContributionIndex(b.value,"bing-maps"===a.layer.type):null,this._pendingAttributions.delete(a),this._fetchedAttributionData.set(a,b));this._updateAttributionItems()}});return function(a){return e.apply(this,arguments)}}();m._createContributionIndex=function(e,a){e=e.contributors;const b={};if(!e)return b;for(let p=0;p<e.length;p++){const l=e[p];var c=l.coverageAreas;if(!c)return;for(const k of c){var d=
k.bbox,h=k.zoomMin-(a&&k.zoomMin?1:0);c=k.zoomMax-(a&&k.zoomMax?1:0);for(d={extent:y.geographicToWebMercator({xmin:d[1],ymin:d[0],xmax:d[3],ymax:d[2],spatialReference:E.WGS84}),attribution:l.attribution||"",score:null!=k.score?k.score:100,id:p};h<=c;h++)b[h]=b[h]||[],b[h].push(d)}}b.maxKey=Math.max.apply(null,Object.keys(b));return b};m._getDynamicAttribution=function(e,a,b){const {extent:c,scale:d}=a;b=b.tileInfo.scaleToZoom(d);b=Math.min(e.maxKey,Math.round(b));if(!c||null==b||-1>=b)return"";e=
e[b];const h=y.project(c.center.clone().normalize(),a.spatialReference),p={};return e?e.filter(l=>{const k=!p[l.id]&&h&&D.extentContainsPoint(l.extent,h);k&&(p[l.id]=!0);return k}).sort((l,k)=>k.score-l.score||l.objectId-k.objectId).map(l=>l.attribution).join(", "):""};r._createClass(g,[{key:"state",get:function(){return this.get("view.ready")?0<this._pendingAttributions.size?"loading":"ready":"disabled"}}]);return g}(B.HandleOwner);u.__decorate([v.property({readOnly:!0,type:w})],q.prototype,"items",
void 0);u.__decorate([v.property({readOnly:!0})],q.prototype,"state",null);u.__decorate([v.property()],q.prototype,"view",void 0);return q=u.__decorate([C.subclass("esri.widgets.Attribution.AttributionViewModel")],q)});