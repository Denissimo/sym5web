// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/HandleOwner ../../core/maybe ../../core/promiseUtils ../../core/time ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../webdoc/Widgets ../../webdoc/widgets/FloorFilter ../support/GoTo".split(" "),function(y,m,B,I,l,C,J,K,
z,n,P,Q,R,S,L,M,N,O){l=function(D){function A(a){a=D.call(this,a)||this;a.filterMenuOpen=!1;a.filterMenuType="site";a.filterMode="base-floors";a.levelsExpanded=!0;a.searchTerm=null;a.view=null;a._updateFloorFilterTask=null;return a}y._inheritsLoose(A,D);var h=A.prototype;h.initialize=function(){this.handles.add([z.init(this,"view.map",a=>{C.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null);this._updateFloorFilterTask=J.createTask(()=>this._updateFloorFilterFromMap(a).then(()=>
{this._setInitialViewState()}))}),z.init(this,"view",(a,b)=>{this._unregisterWidget(b);this._registerWidget(a)},!0),z.watch(this,"view.widthBreakpoint",a=>{this._viewWidthBreakpoint=a}),z.watch(this,"view.heightBreakpoint",a=>{this._viewHeightBreakpoint=a})])};h.destroy=function(){this._unregisterWidget(this.view);this.view=null;C.isSome(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)};h.filterFacilities=function(a){let b=a;this.searchTerm&&(b=
a.filter(c=>{({name:c}=c);return c.toLowerCase().includes(this.searchTerm.toLowerCase())}));this.site&&(b=b.filter(c=>c.siteId===this.site));return b.sort((c,d)=>{c=c.name;d=d.name;return c>d?1:c===d?0:-1})};h.filterSites=function(a){let b=a;this.searchTerm&&(b=a.filter(c=>{({name:c}=c);return c.toLowerCase().includes(this.searchTerm.toLowerCase())}));return b.sort((c,d)=>{c=c.name;d=d.name;return c>d?1:c===d?0:-1})};h.getBaseLevel=function(a){var b,c;const d=null==(b=this.filterFeatures)?void 0:
null==(c=b.levels)?void 0:c.levelsInfo;let e=null;if(a){const {id:f}=a;d&&0<d.length&&d.forEach(g=>{0===g.verticalOrder&&g.facilityId===f&&(e=g)})}return e};h.getFacility=function(a){var b,c,d,e;return null!=(b=null==(c=this.filterFeatures)?void 0:null==(d=c.facilities)?void 0:null==(e=d.facilitiesInfo)?void 0:e.find(f=>f.id===a))?b:null};h.getFacilityLevels=function(a){var b,c;return a&&null!=(b=this.filterFeatures)&&null!=(c=b.levels)&&c.levelsInfo?this.filterFeatures.levels.levelsInfo.filter(d=>
d.facilityId===a).sort((d,e)=>{d=d.verticalOrder;e=e.verticalOrder;return d>e?-1:d===e?0:1}):[]};h.getLevel=function(a){var b,c,d,e;return null!=(b=null==(c=this.filterFeatures)?void 0:null==(d=c.levels)?void 0:null==(e=d.levelsInfo)?void 0:e.find(f=>f.id===a))?b:null};h.getSite=function(a){var b,c,d,e;return null!=(b=null==(c=this.filterFeatures)?void 0:null==(d=c.sites)?void 0:null==(e=d.sitesInfo)?void 0:e.find(f=>f.id===a))?b:null};h.goTo=function(a){var {view:b}=this;b&&a&&({geometry:a}=a,a&&
a.extent&&(b={duration:K.Milliseconds(1E3),easing:"out-back"},this.callGoTo({target:a.extent,options:b})))};h.setFloors=function(a){var b,c,d;null==(b=this.view)?void 0:null==(c=b.map)?void 0:null==(d=c.layers)?void 0:d.forEach(e=>{"feature"===e.type&&this._computeViewAllModeFloors(e)});this.view.floors=new B(this._computeFloors(a))};h.updateWebDocument=function(a){if("esri.WebMap"===a.declaredClass){var b,c,d;const e=new N({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,
site:null!=(b=this.site)?b:null,facility:null!=(c=this.facility)?c:null,level:null!=(d=this.level)?d:null});a.widgets?a.widgets.floorFilter=e:a.widgets=new M({floorFilter:e})}};h._computeFloors=function(a){if("single-floor"===this.filterMode)this._computeSingleFloor(a);else if("base-floors"===this.filterMode)return"3d"===this.view.type?this._computeBaseFloors3D(a):this._computeBaseFloors(a);return this._computeEmptyFloors()};h._computeSingleFloor=function(a){if(!a)return this._computeEmptyFloors();
const b=[];"all"===(null==a?void 0:a.id)?this.getFacilityLevels(a.facilityId).forEach(c=>{c.id&&b.push(c.id)}):a&&b.push(a.id);return b};h._computeBaseFloors=function(a){var b,c;const d=null==(b=this.filterFeatures)?void 0:null==(c=b.levels)?void 0:c.levelsInfo;if(!d||!d.length)return this._computeEmptyFloors();const e=[];"all"===(null==a?void 0:a.id)?this.getFacilityLevels(a.facilityId).forEach(g=>{g.id&&e.push(g.id)}):a&&e.push(a.id);const f=null==a?void 0:a.facilityId;d.forEach(g=>{const {id:k,
facilityId:p,verticalOrder:r}=g;f||0!==r||e.includes(k)?p===f||0!==r||e.includes(k)||e.push(k):e.push(k)});return e};h._computeBaseFloors3D=function(a){var b,c;const d=null==(b=this.filterFeatures)?void 0:null==(c=b.levels)?void 0:c.levelsInfo;if(!d||!d.length)return this._computeEmptyFloors();const e=[];b=null==a?void 0:a.id.split("--");1<(null==b?void 0:b.length)&&"all"===b[0]?this.getFacilityLevels(a.facilityId).forEach(g=>{g.id&&e.push(g.id)}):a&&e.push(a.id);const f=null==a?void 0:a.facilityId;
d.forEach(g=>{const {id:k,facilityId:p}=g;f||e.includes(k)?p===f||e.includes(k)||e.push(k):e.push(k)});return e};h._computeEmptyFloors=function(){return[]};h._setFilterLayers=function(){var {view:a}=this;if(!this._isOverridden("filterLayers")){if("esri.WebMap"!==a.map.declaredClass&&"esri.WebScene"!==a.map.declaredClass)throw new I("Map must be a webmap or webscene");{var b;a=a.map;const p=null==a?void 0:a.layers;if(0<(null==p?void 0:null==(b=p.items)?void 0:b.length)){var c,d,e,f,g,k;const r={siteLayer:null,
facilityLayer:null,levelLayer:null},w=null==(c=a.floorInfo)?void 0:null==(d=c.siteLayer)?void 0:d.layerId,q=null==(e=a.floorInfo)?void 0:null==(f=e.facilityLayer)?void 0:f.layerId,t=null==(g=a.floorInfo)?void 0:null==(k=g.levelLayer)?void 0:k.layerId;p.items.filter(u=>"feature"===u.type||"scene"===u.type).forEach(u=>{const v=u.id;v&&(v===w?r.siteLayer=u:v===q?r.facilityLayer=u:v===t&&(r.levelLayer=u))});this.filterLayers=r}}}};h._getFilterFeatures=function(){var a=y._asyncToGenerator(function*(){if(this._isOverridden("filterFeatures"))return Promise.resolve(this.filterFeatures);
const b={sites:null,facilities:null,levels:null};var c=yield this._getSites();b.sites=c;c=yield this._getFacilities();b.facilities=c;c=yield this._getLevels();b.levels=c;return b});return function(){return a.apply(this,arguments)}}();h._getSites=function(){var a=y._asyncToGenerator(function*(){var b,c;const {filterLayers:d,view:e}=this;var f=e.map;const {siteLayer:g}=d,k={sitesInfo:[]};if(!g||null==f||null==(b=f.floorInfo)||!b.siteLayer)return k;b=g.createQuery();b.where="1\x3d1";b.returnGeometry=
!0;b.outFields=["*"];b.returnZ=!0;"scene"===g.type&&(b.multipatchOption="xyFootprint");const {siteIdField:p,nameField:r}=f.floorInfo.siteLayer;f=yield g.queryFeatures(b);0<(null==f?void 0:null==(c=f.features)?void 0:c.length)&&f.features.forEach(w=>{var q=w.attributes;w=w.geometry;const t=q[p];q=q[r];t&&q&&k.sitesInfo.push({id:t,name:q,geometry:w})});return k});return function(){return a.apply(this,arguments)}}();h._getFacilities=function(){var a=y._asyncToGenerator(function*(){var b,c;const {filterLayers:d,
view:e}=this;var f=e.map;const {facilityLayer:g}=d,k={facilitiesInfo:[]};if(!g||null==f||null==(b=f.floorInfo)||!b.facilityLayer)return k;b=g.createQuery();b.where="1\x3d1";b.returnGeometry=!0;b.outFields=["*"];b.returnZ=!0;"scene"===g.type&&(b.multipatchOption="xyFootprint");const {facilityIdField:p,siteIdField:r,nameField:w}=f.floorInfo.facilityLayer;f=yield g.queryFeatures(b);0<(null==f?void 0:null==(c=f.features)?void 0:c.length)&&f.features.forEach(q=>{var t=q.attributes;q=q.geometry;const u=
t[p],v=t[r];t=t[w];u&&t&&k.facilitiesInfo.push({id:u,siteId:v,name:t,geometry:q})});return k});return function(){return a.apply(this,arguments)}}();h._getLevels=function(){var a=y._asyncToGenerator(function*(){var b,c;const {filterLayers:d,view:e}=this;var f=e.map;const {levelLayer:g}=d,k={levelsInfo:[]};if(!g||null==f||null==(b=f.floorInfo)||!b.levelLayer)return k;b=g.createQuery();b.where="1\x3d1";b.returnGeometry=!0;b.outFields=["*"];b.returnZ=!0;const {levelIdField:p,facilityIdField:r,longNameField:w,
shortNameField:q,levelNumberField:t,verticalOrderField:u}=f.floorInfo.levelLayer;f=yield g.queryFeatures(b);0<(null==f?void 0:null==(c=f.features)?void 0:c.length)&&f.features.forEach(v=>{var x=v.attributes;v=x[p];const E=x[r],F=x[w],G=x[q],H=x[t];x=x[u];v&&E&&F&&G&&"number"===typeof H&&"number"===typeof x&&k.levelsInfo.push({id:v,facilityId:E,longName:F,shortName:G,levelNumber:H,verticalOrder:x})});return k});return function(){return a.apply(this,arguments)}}();h._registerWidget=function(a){(null==
a?0:a.persistableViewModels.some(b=>b===this))||(null==a?void 0:a.persistableViewModels.add(this))};h._unregisterWidget=function(a){null==a?void 0:a.persistableViewModels.remove(this)};h._setInitialViewState=function(){this.view&&(this._setFilterLayers(),this._getFilterFeatures().then(a=>{a&&(this.filterFeatures=a,this.hasFacilities&&this.hasLevels?(this.hasMultipleSites||(this.filterMenuType="facility"),this.view.when().then(()=>{if(this.facility&&this.level){this.filterMenuType="facility";var b=
this.getFacility(this.facility),c=this.getLevel(this.level);this.setFloors(c);this.goTo(b)}else this.facility&&!this.level?(this.filterMenuType="facility",b=this.getFacility(this.facility),c=this.getBaseLevel(b),this.site||(this.site=b.siteId||void 0),this.level=(null==c?void 0:c.id)||void 0,this.setFloors(c),this.goTo(b)):!this.facility&&this.level?(this.filterMenuType="facility",b=this.getLevel(this.level),c=this.getFacility(null==b?void 0:b.facilityId),this.facility=(null==c?void 0:c.id)||void 0,
this.site||(this.site=(null==c?void 0:c.siteId)||void 0),this.setFloors(b),this.goTo(c)):!this.site||this.facility||this.level?this.setFloors(null):(this.filterMenuType="site",b=this.getSite(this.site),this.setFloors(null),this.goTo(b))})):console.error("Facilities and Levels are required for the Floor Filter widget"))}).catch(a=>{console.error("Couldn't retrieve sites, facilities, and levels",a)}))};h._callOverride=function(a,b){this._override(a,b)};h._updateFloorFilterFromMap=function(){var a=y._asyncToGenerator(function*(b){var c;
b&&"esri.WebMap"===b.declaredClass&&(b=null==b?void 0:null==(c=b.widgets)?void 0:c.floorFilter)&&(this._isOverridden("enabled")||(this.enabled=b.enabled),this._isOverridden("longNames")||(this.longNames=b.longNames),this._isOverridden("minimized")||(this.minimized=b.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=b.pinnedLevels),this._isOverridden("site")||(this.site=b.site),this._isOverridden("facility")||(this.facility=b.facility),this._isOverridden("level")||(this.level=b.level))});
return function(b){return a.apply(this,arguments)}}();h._computeViewAllModeFloors=function(a){var b;const {filterFeatures:c}=this;if(null!=(b=a.floorInfo)&&b.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const {level:d,facility:e}=this,f=[];c.levels.levelsInfo.forEach(g=>{const {id:k,facilityId:p}=g;e&&p===e?d&&k===d&&f.push(k):f.push(k)});a.floorInfo.viewAllLevelIds=new B(f)}};y._createClass(A,[{key:"enabled",set:function(a){this._callOverride("enabled",a)}},{key:"facility",
set:function(a){if(a&&this._isOverridden("facility")){const b=this.getFacility(a);this.hasMultipleSites&&(this.site=(null==b?void 0:b.siteId)||void 0)}this._callOverride("facility",a)}},{key:"filterFeatures",set:function(a){this._callOverride("filterFeatures",a)}},{key:"filterLayers",set:function(a){this._callOverride("filterLayers",a)}},{key:"hasFacilities",get:function(){var a,b,c,d;return(null==(a=this.filterLayers)?void 0:a.facilityLayer)&&0<(null==(b=this.filterFeatures)?void 0:null==(c=b.facilities)?
void 0:null==(d=c.facilitiesInfo)?void 0:d.length)}},{key:"hasLevels",get:function(){var a,b,c,d;return(null==(a=this.filterLayers)?void 0:a.levelLayer)&&0<(null==(b=this.filterFeatures)?void 0:null==(c=b.levels)?void 0:null==(d=c.levelsInfo)?void 0:d.length)}},{key:"hasMultipleSites",get:function(){var a,b,c,d;return(null==(a=this.filterLayers)?void 0:a.siteLayer)&&1<(null==(b=this.filterFeatures)?void 0:null==(c=b.sites)?void 0:null==(d=c.sitesInfo)?void 0:d.length)}},{key:"isNormalMode",get:function(){let a=
!0;const b=this._viewWidthBreakpoint,c=this._viewHeightBreakpoint;if("small"===b||"xsmall"===b||"small"===c||"xsmall"===c)a=!1;return a}},{key:"level",set:function(a){if(a){var b=null,c=null;b=null==a?void 0:a.split("--");if(1<(null==b?void 0:b.length)&&"all"===b[0])c=b[1],b={id:a,facilityId:c,shortName:null,longName:null,levelNumber:null,verticalOrder:null};else{var d;b=this.getLevel(a);c=null==(d=b)?void 0:d.facilityId}if(this.level!==a||this.isNormalMode||this.levelsExpanded){if(b&&this.hasFacilities&&
this.hasLevels){this.facility=c;if(this.hasMultipleSites){var e;this.site=null==(e=this.getFacility(c))?void 0:e.siteId}this.setFloors(b)}else this._isOverridden("level")&&(this.site=this.facility=void 0,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null));this._callOverride("level",a)}else a=this.getFacilityLevels(c),1<(null==a?void 0:a.length)&&(this.levelsExpanded=!0)}else this._callOverride("level",a),this.site=this.facility=void 0,this.setFloors(null)}},{key:"longNames",
set:function(a){this._callOverride("longNames",a)}},{key:"minimized",set:function(a){this._callOverride("minimized",a)}},{key:"pinnedLevels",set:function(a){this._callOverride("pinnedLevels",a)}},{key:"site",set:function(a){this._callOverride("site",a)}},{key:"state",get:function(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}}]);return A}(O.GoToMixin(l.HandleOwner));m.__decorate([n.property({value:!1})],l.prototype,
"enabled",null);m.__decorate([n.property({value:void 0})],l.prototype,"facility",null);m.__decorate([n.property({value:null})],l.prototype,"filterFeatures",null);m.__decorate([n.property({value:null})],l.prototype,"filterLayers",null);m.__decorate([n.property()],l.prototype,"filterMenuOpen",void 0);m.__decorate([n.property()],l.prototype,"filterMenuType",void 0);m.__decorate([n.property()],l.prototype,"filterMode",void 0);m.__decorate([n.property()],l.prototype,"hasFacilities",null);m.__decorate([n.property()],
l.prototype,"hasLevels",null);m.__decorate([n.property()],l.prototype,"hasMultipleSites",null);m.__decorate([n.property({readOnly:!0})],l.prototype,"isNormalMode",null);m.__decorate([n.property({value:void 0})],l.prototype,"level",null);m.__decorate([n.property({value:!1})],l.prototype,"longNames",null);m.__decorate([n.property()],l.prototype,"levelsExpanded",void 0);m.__decorate([n.property({value:!1})],l.prototype,"minimized",null);m.__decorate([n.property({value:!1})],l.prototype,"pinnedLevels",
null);m.__decorate([n.property()],l.prototype,"searchTerm",void 0);m.__decorate([n.property({value:void 0})],l.prototype,"site",null);m.__decorate([n.property({readOnly:!0})],l.prototype,"state",null);m.__decorate([n.property()],l.prototype,"view",void 0);m.__decorate([n.property()],l.prototype,"_viewHeightBreakpoint",void 0);m.__decorate([n.property()],l.prototype,"_viewWidthBreakpoint",void 0);m.__decorate([n.property()],l.prototype,"updateWebDocument",null);return l=m.__decorate([L.subclass("esri/widgets/FloorFilter/FloorFilterViewModel")],
l)});