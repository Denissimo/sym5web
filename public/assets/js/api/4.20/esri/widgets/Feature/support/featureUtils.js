// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../intl ../../../core/Logger ../../../core/maybe ../../../core/string ../../../intl/date ../../../intl/number ../../../layers/support/fieldUtils ../../../popup/support/FieldInfoFormat ../../../support/arcadeOnDemand".split(" "),function(g,l,ha,J,K,n,m,y,L,M,N){function p(){p=l._asyncToGenerator(function*(a,b){return"function"===typeof a?a.call(null,b):a});return p.apply(this,arguments)}function z(a){return A.test(a)}function O(a,b){if(!z(b)||
!a)return null;const c=b.replace(A,"").toLowerCase();let e;a.some(d=>d.name.toLowerCase()===c?(e=d,!0):!1);return e}function q(a,b){return(b=r(b,a))?b.name:a}function r(a,b){return a&&"function"===typeof a.getField?a.getField(b):null}function B({formattedAttributes:a,template:b,fieldInfoMap:c}){return`${n.replace(n.replace(b,e=>{{const d=c.get(e.toLowerCase());e=`{${d&&d.fieldName||e}}`}return e}),a).replace(P,"")}`.trim()}function Q(a,b,c=!1){const e=b[a];"string"===typeof e&&(c=(c?encodeURIComponent(e):
e).replace(R,"%27"),b[a]=c)}function S(a,b=!1){const c={...a};Object.keys(c).forEach(e=>Q(e,c,b));return c}function C(a,b){return a.replace(T,(c,e,d)=>(c=r(b,d))?`{${c.name}}`:e)}function U(a,b,c){return(a=C(a,c))?a.replace(V,(e,d,f)=>{d=`${d||f}`.trim();return n.replace(e,S(b,d&&"{"!==d[0]))}):a}function D(a,b){const c=b.fieldName;var e=E(b.fieldInfos,c),d=null==e?void 0:e.clone();e=b.preventPlacesFormatting;b=r(b.layer,c);d&&b&&"date"===b.type&&(b=d.format||new M,b.dateFormat=b.dateFormat||"short-date-short-time",
d.format=b);d=d&&d.format;"string"!==typeof a||!d||null!=d.dateFormat||null==d.places&&null==d.digitSeparator||(b=Number(a),isNaN(b)||(a=b));return"string"===typeof a||null==a||null==d?a:e?y.formatNumber(a,{...y.convertNumberFormatToIntlOptions(d),minimumFractionDigits:0,maximumFractionDigits:20}):d.format(a)}function E(a,b){if(a&&a.length&&b){var c=b.toLowerCase(),e=void 0;a.some(d=>d.fieldName&&d.fieldName.toLowerCase()===c?(e=d,!0):!1);return e}}function W({fieldName:a,graphic:b,layer:c}){if(t(a)||
!c||"function"!==typeof c.getFeatureType)return null;const {typeIdField:e}=c;return e&&a===e?(a=c.getFeatureType(b))?a.name:null:null}function X({fieldName:a,value:b,graphic:c,layer:e}){return t(a)||!e||"function"!==typeof e.getFieldDomain?null:(a=e.getFieldDomain(a,{feature:c}))&&"coded-value"===a.type?a.getName(b):null}function F(a){return"string"===typeof a?a.replace(Y,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):a}function Z(a){const {value:b,fieldName:c,fieldInfos:e,fieldInfoMap:d,layer:f,graphic:h}=
a;return null==b?"":(a=X({fieldName:c,value:b,graphic:h,layer:f}))||(a=W({fieldName:c,graphic:h,layer:f}))?a:d.get(c.toLowerCase())?D(b,{fieldInfos:e,fieldName:c,layer:f}):(a=f&&f.fieldsIndex)&&a.isDateField(c)?m.formatDate(b,u):F(b)}function aa(a,b){return v.apply(this,arguments)}function v(){v=l._asyncToGenerator(function*(a,b){var c,e;const {layer:d,graphic:f,outFields:h,objectIds:k,returnGeometry:G,spatialReference:ba}=a;a=k[0];if("number"!==typeof a&&"string"!==typeof a)return H.warn("Could not query required fields for the specified feature. The feature's ID is invalid.",
{layer:d,graphic:f,objectId:a,requiredFields:h}),null;if(null==(c=d.capabilities)||null==(e=c.operations)||!e.supportsQuery)return H.warn("The specified layer cannot be queried. The following fields will not be available.",{layer:d,graphic:f,requiredFields:h,returnGeometry:G}),null;c=d.createQuery();c.objectIds=k;c.outFields=null!=h&&h.length?h:[d.objectIdField];c.returnGeometry=!!G;c.outSpatialReference=ba;return(yield d.queryFeatures(c,b)).features[0]});return v.apply(this,arguments)}function ca(a){return w.apply(this,
arguments)}function w(){w=l._asyncToGenerator(function*(a){var b;if(null==(b=a.expressionInfos)||!b.length)return!1;b=yield N.loadArcade();({arcadeUtils:{hasGeometryFunctions:b}}=b);return b(a)});return w.apply(this,arguments)}function x(){x=l._asyncToGenerator(function*({graphic:a,popupTemplate:b,layer:c,spatialReference:e},d){if(c&&b&&("function"===typeof c.load&&(yield c.load(d)),a.attributes)){var f=a.attributes[c.objectIdField];if(null!=f){f=[f];var h=yield b.getRequiredFields(c.fieldsIndex),
k=L.featureHasFields(h,a);h=k?[]:h;b=b.returnGeometry||(yield ca(b));if(!k||b)if(c=yield aa({layer:c,graphic:a,outFields:h,objectIds:f,returnGeometry:b,spatialReference:e},d))c.geometry&&(a.geometry=c.geometry),c.attributes&&(a.attributes={...a.attributes,...c.attributes})}}});return x.apply(this,arguments)}function t(a=""){return a?-1!==a.indexOf("relationships/"):!1}function I({attributes:a,graphic:b,relatedInfo:c}){a&&b&&c&&Object.keys(b.attributes).forEach(e=>{var d={layerId:c.relation.id.toString(),
fieldName:e};a[d?`${"relationships/"}${d.layerId}/${d.fieldName}`:""]=b.attributes[e]})}function da(a,b){a&&b&&(b.relatedFeatures&&b.relatedFeatures&&b.relatedFeatures.forEach(c=>I({attributes:a,graphic:c,relatedInfo:b})),b.relatedStatsFeatures&&b.relatedStatsFeatures&&b.relatedStatsFeatures.forEach(c=>I({attributes:a,graphic:c,relatedInfo:b})))}const H=J.getLogger("esri.widgets.Feature.support.featureUtils"),P=/href=(""|'')/gi,T=/(\{([^\{\r\n]+)\})/g,R=/'/g,A=/^\s*expression\//i,Y=/(\n)/gi,ea=/[\u00A0-\u9999<>&]/gim,
V=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,fa=/^(?:mailto:|tel:)/,u=m.convertDateFormatToIntlOptions("short-date-short-time");g.applyTextFormattingHTML=F;g.createfieldInfoMap=function(a,b){const c=new Map;a&&a.forEach(e=>{const d=q(e.fieldName,b);e.fieldName=d;c.set(d.toLowerCase(),e)});return c};g.fixTokens=C;g.formatAttributes=function({fieldInfos:a,attributes:b,layer:c,graphic:e,fieldInfoMap:d,relatedInfos:f}){const h={...b};null==f?void 0:f.forEach(k=>da(h,k));Object.keys(h).forEach(k=>{h[k]=Z({fieldName:k,
fieldInfos:a,fieldInfoMap:d,layer:c,value:h[k],graphic:e})});return h};g.formatEditInfo=function(a,b){const {creatorField:c,creationDateField:e,editorField:d,editDateField:f}=a;if(b){a=b[f];if("number"===typeof a)return b=b[d],{type:"edit",date:m.formatDate(a,u),user:b};a=b[e];return"number"===typeof a?(b=b[c],{type:"create",date:m.formatDate(a,u),user:b}):null}};g.formatValueToFieldInfo=D;g.getAllFieldInfos=function(a){const b=[];if(!a)return b;const {fieldInfos:c,content:e}=a;c&&b.push(...c);if(!e||
!Array.isArray(e))return b;e.forEach(d=>{"fields"===d.type&&(d=d&&d.fieldInfos)&&b.push(...d)});return b};g.getFieldInfo=E;g.getFieldInfoLabel=function(a,b){return(b=O(b,null==a?void 0:a.fieldName))?b.title||null:a?a.label||a.fieldName:null};g.getFixedFieldName=q;g.getFixedFieldNames=function(a,b){return a&&a.map(c=>q(c,b))};g.getSourceLayer=function(a){if(!K.isNone(a))return a.get("sourceLayer")||a.get("layer")};g.graphicCallback=function(a,b){return p.apply(this,arguments)};g.htmlEntities=function(a){return a.replace(ea,
b=>`&#${b.charCodeAt(0)};`)};g.isExpressionField=z;g.isRelatedField=t;g.queryUpdatedFeature=function(a,b){return x.apply(this,arguments)};g.shouldOpenInNewTab=function(a=""){if(a)return!fa.test(a.trim().toLowerCase())};g.substituteAttributes=B;g.substituteFieldsInLinksAndAttributes=function({attributes:a,globalAttributes:b,layer:c,text:e,expressionAttributes:d,fieldInfoMap:f}){return e?B({formattedAttributes:b,template:U(e,{...b,...d,...a},c),fieldInfoMap:f}):""};Object.defineProperty(g,"__esModule",
{value:!0})});