// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../core/Accessor ../../core/Handles ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/throttle ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../popup/content/TextContent ./FeatureAttachments/FeatureAttachmentsViewModel ./FeatureContent/FeatureContentViewModel ./FeatureFields/FeatureFieldsViewModel ./FeatureMedia/FeatureMediaViewModel ./support/arcadeFeatureUtils ./support/featureUtils ./support/relatedFeatureUtils".split(" "),
function(u,m,E,g,F,G,B,A,H,I,p,P,Q,R,J,K,L,C,M,x,N,q,w){const O=G.getLogger("esri.widgets.FeatureViewModel");g=function(D){function y(a){var b=D.call(this,a)||this;b._handles=new F;b._featureAbortController=null;b.graphicChangedThrottled=H.throttle(b.graphicChanged,1,u._assertThisInitialized(b));b._expressionAttributes=null;b.content=null;b.contentViewModels=[];b.defaultPopupTemplateEnabled=!1;b.formattedAttributes=null;b.lastEditInfo=null;b.relatedInfos=new Map;b.title="";b.view=null;b._handles.add(I.init(u._assertThisInitialized(b),
["graphic","_effectivePopupTemplate"],()=>b.graphicChangedThrottled()));return b}u._inheritsLoose(y,D);var f=y.prototype;f.destroy=function(){this._clear();this._cancelFeatureQuery();this._handles.destroy();this.graphic=this._handles=null;this._destroyContentViewModels();this.relatedInfos.clear()};f.setActiveMedia=function(a,b){a=this.contentViewModels[a];a instanceof x&&a.setActiveMedia(b)};f.nextMedia=function(a){a=this.contentViewModels[a];a instanceof x&&a.next()};f.previousMedia=function(a){a=
this.contentViewModels[a];a instanceof x&&a.previous()};f._clear=function(){this._set("title","");this._set("content",null);this._set("formattedAttributes",null)};f.graphicChanged=function(){var a=u._asyncToGenerator(function*(){this._cancelFeatureQuery();this._clear();const {graphic:b}=this;if(b){var c=A.createAbortController();this._featureAbortController=c;try{yield this._queryFeature({signal:c.signal})}catch(e){O.error("error","error loading popupTemplate for graphic",{error:e,graphic:b})}this._featureAbortController===
c&&(this._featureAbortController=null)}});return function(){return a.apply(this,arguments)}}();f._cancelFeatureQuery=function(){const {_featureAbortController:a}=this;a&&a.abort();this._featureAbortController=null};f._compileContent=function(a){this._destroyContentViewModels();if(this.graphic)return Array.isArray(a)?a.map((b,c)=>{if("attachments"===b.type)return this._compileAttachments(b,c);if("custom"===b.type)return this._compileCustom(b,c);if("fields"===b.type)return this._compileFields(b,c);
if("media"===b.type)return this._compileMedia(b,c);if("text"===b.type)return this._compileText(b,c)}):"string"===typeof a?this._compileText(new K({text:a}),0).text:a};f._destroyContentViewModels=function(){this.contentViewModels.forEach(a=>a&&!a.destroyed&&a.destroy());this._set("contentViewModels",[])};f._compileAttachments=function(a,b){const {graphic:c}=this,{description:e,title:d}=a;this.contentViewModels[b]=new L({graphic:c,...this._compileTitleAndDesc({title:d,description:e})});return a};f._compileCustom=
function(a,b){const {graphic:c}=this,{creator:e,destroyer:d}=a;this.contentViewModels[b]=new C({graphic:c,creator:e,destroyer:d});return a};f._compileTitleAndDesc=function({title:a,description:b}){const {_fieldInfoMap:c,_sourceLayer:e,graphic:d,formattedAttributes:h,_expressionAttributes:k}=this,{attributes:r}=d,n=h.global;return{title:q.substituteFieldsInLinksAndAttributes({attributes:r,fieldInfoMap:c,globalAttributes:n,expressionAttributes:k,layer:e,text:a}),description:q.substituteFieldsInLinksAndAttributes({attributes:r,
fieldInfoMap:c,globalAttributes:n,expressionAttributes:k,layer:e,text:b})}};f._compileFields=function(a,b){const {_effectivePopupTemplate:c,formattedAttributes:e}=this,d=a.clone();a=(null==a?void 0:a.fieldInfos)||(null==c?void 0:c.fieldInfos);const h=null==c?void 0:c.expressionInfos,k={...e.global,...e.content[b]},{description:r,title:n}=d;a=new M({attributes:k,expressionInfos:h,fieldInfos:a,...this._compileTitleAndDesc({title:n,description:r})});this.contentViewModels[b]=a;d.fieldInfos=a.formattedFieldInfos.slice(0);
return d};f._compileMedia=function(a,b){const {graphic:c,_fieldInfoMap:e,_effectivePopupTemplate:d,relatedInfos:h,_sourceLayer:k,_expressionAttributes:r}=this;var {attributes:n}=c;const t=this.formattedAttributes.global;a=a.clone();const {description:l,mediaInfos:v,title:z}=a;n=new x({activeMediaInfoIndex:a.activeMediaInfoIndex||0,attributes:n,layer:k,fieldInfoMap:e,formattedAttributes:t,expressionAttributes:r,mediaInfos:v,popupTemplate:d,relatedInfos:h,...this._compileTitleAndDesc({title:z,description:l})});
a.mediaInfos=n.formattedMediaInfos.slice(0);this.contentViewModels[b]=n;return a};f._compileText=function(a,b){a=a.clone();const {graphic:c,_fieldInfoMap:e,_sourceLayer:d,_expressionAttributes:h}=this;if(a&&a.text){const {attributes:k}=c;a.text=q.substituteFieldsInLinksAndAttributes({attributes:k,fieldInfoMap:e,globalAttributes:this.formattedAttributes.global,expressionAttributes:h,layer:d,text:a.text})}this.contentViewModels[b]=new C({graphic:c,creator:a.text});return a};f._compileLastEditInfo=function(){const {_effectivePopupTemplate:a,
_sourceLayer:b,graphic:c}=this;if(a){var {lastEditInfoEnabled:e}=a,d=null==b?void 0:b.editFieldsInfo;if(e&&d)return q.formatEditInfo(d,c.attributes)}};f._compileTitle=function(a){const {_fieldInfoMap:b,_sourceLayer:c,graphic:e,_expressionAttributes:d}=this,{attributes:h}=e;return q.substituteFieldsInLinksAndAttributes({attributes:h,fieldInfoMap:b,globalAttributes:this.formattedAttributes.global,expressionAttributes:d,layer:c,text:a})};f._getTitle=function(){var a=u._asyncToGenerator(function*(){const {_effectivePopupTemplate:b,
graphic:c}=this;return q.graphicCallback(null==b?void 0:b.title,{graphic:c})});return function(){return a.apply(this,arguments)}}();f._getContent=function(){var a=u._asyncToGenerator(function*(){const {_effectivePopupTemplate:b,graphic:c}=this;return q.graphicCallback(null==b?void 0:b.content,{graphic:c})});return function(){return a.apply(this,arguments)}}();f._queryFeature=function(){var a=u._asyncToGenerator(function*(b){const {_featureAbortController:c,_sourceLayer:e,graphic:d,_effectivePopupTemplate:h,
spatialReference:k,map:r,view:n}=this,{content:{value:t},title:{value:l}}=yield A.eachAlways({content:this._getContent(),title:this._getTitle()});c===this._featureAbortController&&d&&(yield q.queryUpdatedFeature({graphic:d,popupTemplate:h,layer:e,spatialReference:k},b),{expressionAttributes:{value:b}}=yield A.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(b),expressionAttributes:N.createCompiledExpressions({popupTemplate:this._effectivePopupTemplate,spatialReference:k,graphic:d,
map:r,view:n})}),c===this._featureAbortController&&d&&(this._expressionAttributes=b,this._set("formattedAttributes",this._createFormattedAttributes(t,b)),this._set("title",this._compileTitle(l)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(t)||null)))});return function(b){return a.apply(this,arguments)}}();f._createFormattedAttributes=function(a,b){const {_effectivePopupTemplate:c,graphic:e,relatedInfos:d,_sourceLayer:h,_fieldInfoMap:k}=this,
r={...e.attributes,...b},n={global:q.formatAttributes({fieldInfos:null==c?void 0:c.fieldInfos,graphic:e,attributes:r,layer:h,fieldInfoMap:k,relatedInfos:d}),content:[]};Array.isArray(a)&&a.forEach((t,l)=>{"fields"===t.type&&t.fieldInfos&&(n.content[l]=q.formatAttributes({fieldInfos:t.fieldInfos,graphic:e,attributes:r,layer:h,fieldInfoMap:k,relatedInfos:d}))});return n};f._checkForRelatedFeatures=function(a){const {graphic:b,_effectivePopupTemplate:c}=this;return this._queryRelatedInfos(b,q.getAllFieldInfos(c),
a)};f._queryRelatedInfos=function(){var a=u._asyncToGenerator(function*(b,c,e){const {relatedInfos:d,_sourceLayer:h}=this;d.clear();const k=B.isSome(h.associatedLayer)?yield h.associatedLayer.load(e):h;if(k){var r=c.filter(l=>l&&q.isRelatedField(l.fieldName));if(r&&r.length){c.forEach(l=>this._configureRelatedInfo(l,k));var n=yield w.queryLayerInfos({relatedInfos:d,layer:k},e);Object.keys(n).forEach(l=>{var v;const z=d.get(l.toString());l=null==(v=n[l])?void 0:v.value;z&&l&&(z.layerInfo=l.data)});
var t=yield w.queryRelatedFeatures({graphic:b,relatedInfos:d,layer:k},e);Object.keys(t).forEach(l=>{var v;w.setRelatedFeatures(null==(v=t[l])?void 0:v.value,d.get(l.toString()))})}}});return function(b,c,e){return a.apply(this,arguments)}}();f._configureRelatedInfo=function(a,b){const {relatedInfos:c}=this,e=w.getRelatedFieldInfo(a.fieldName);if(e){var {layerId:d,fieldName:h}=e;d&&(b=c.get(d.toString())||w.createRelatedInfo(d,b))&&(w.updateRelatedInfo({relatedInfo:b,fieldName:h,fieldInfo:a}),this.relatedInfos.set(d,
b))}};u._createClass(y,[{key:"_effectivePopupTemplate",get:function(){return B.isSome(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}},{key:"_fieldInfoMap",get:function(){return q.createfieldInfoMap(q.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)}},{key:"_sourceLayer",get:function(){return q.getSourceLayer(this.graphic)}},{key:"graphic",set:function(a){this._set("graphic",a?a.clone():null)}},{key:"spatialReference",get:function(){return this.get("view.spatialReference")||
null},set:function(a){void 0===a?this._clearOverride("spatialReference"):this._override("spatialReference",a)}},{key:"map",get:function(){return this.get("view.map")||null},set:function(a){void 0===a?this._clearOverride("map"):this._override("map",a)}},{key:"waitingForContent",get:function(){return!!this._featureAbortController}}]);return y}(g);m.__decorate([p.property()],g.prototype,"_featureAbortController",void 0);m.__decorate([p.property({readOnly:!0})],g.prototype,"_effectivePopupTemplate",null);
m.__decorate([p.property({readOnly:!0})],g.prototype,"_fieldInfoMap",null);m.__decorate([p.property({readOnly:!0})],g.prototype,"_sourceLayer",null);m.__decorate([p.property({readOnly:!0})],g.prototype,"content",void 0);m.__decorate([p.property({readOnly:!0})],g.prototype,"contentViewModels",void 0);m.__decorate([p.property({type:Boolean})],g.prototype,"defaultPopupTemplateEnabled",void 0);m.__decorate([p.property({readOnly:!0})],g.prototype,"formattedAttributes",void 0);m.__decorate([p.property({type:E,
value:null})],g.prototype,"graphic",null);m.__decorate([p.property({readOnly:!0})],g.prototype,"lastEditInfo",void 0);m.__decorate([p.property()],g.prototype,"relatedInfos",void 0);m.__decorate([p.property()],g.prototype,"spatialReference",null);m.__decorate([p.property({readOnly:!0})],g.prototype,"title",void 0);m.__decorate([p.property()],g.prototype,"map",null);m.__decorate([p.property({readOnly:!0})],g.prototype,"waitingForContent",null);m.__decorate([p.property()],g.prototype,"view",void 0);
return g=m.__decorate([J.subclass("esri.widgets.FeatureViewModel")],g)});