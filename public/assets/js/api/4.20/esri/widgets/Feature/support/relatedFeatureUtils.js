// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../request ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../rest/support/Query ../../../rest/support/RelationshipQuery ../../../rest/support/StatisticDefinition ../../../tasks/QueryTask ./featureUtils".split(" "),function(h,v,w,q,x,l,y,m,z,A,B,C){function D(b,a){if(!a.relationships)return null;let c=null;({relationships:a}=a);a.some(e=>e.id===parseInt(b,10)?(c=e,!0):!1);return c}
function r({originRelationship:b,relationships:a,layerId:c}){let e;a&&a.some(d=>{`${d.relatedTableId}`===c&&d.id===b.id&&(e=d);return!!e});return e}function E(b,a){a=a.toLowerCase();for(const c in b)if(c.toLowerCase()===a)return b[c];return null}function F(b,a,c,e){const d=new z;d.outFields=["*"];d.relationshipId="number"===typeof a.id?a.id:parseInt(a.id,10);d.objectIds=[b.attributes[c.objectIdField]];return c.queryRelatedFeatures(d,e)}function G(b,a,c){let e=0;const d=[];for(;e<a.length;)d.push(`${b} IN (${a.slice(e,
c+e)})`),e+=c;return d.join(" OR ")}function H(b,a,c,e){return n.apply(this,arguments)}function n(){n=v._asyncToGenerator(function*(b,a,c,e){var d=c.layerId.toString();const {layerInfo:f,queryTask:g,relation:k,relatedFields:I,outStatistics:p}=a;d=r({originRelationship:k,relationships:f.relationships,layerId:d});if(d.relationshipTableId&&d.keyFieldInRelationshipTable){c=(yield F(b,d,c,e))[b.attributes[c.objectIdField]];if(!c)return null;const K=c.features.map(J=>J.attributes[f.objectIdField]);if(0<
(null==p?void 0:p.length)&&f.supportsStatistics)return a=new m,a.where=G(f.objectIdField,K,1E3),a.outFields=I,a.outStatistics=p,a={features:Promise.resolve(c),statsFeatures:g.execute(a)},l.eachAlways(a)}return(d=null==d?void 0:d.keyField)?(c=y.isNumericField(L(f.fields,d)),b=E(b.attributes,k.keyField),d=c?`${d}=${b}`:`${d}='${b}'`,b=g.execute(new m({where:d,outFields:a.relatedFields}),e),a=a.outStatistics&&0<a.outStatistics.length&&f.supportsStatistics?g.execute(new m({where:d,outFields:a.relatedFields,
outStatistics:a.outStatistics}),e):null,e={features:b},a&&(e.statsFeatures=a),l.eachAlways(e)):null});return n.apply(this,arguments)}function L(b,a){if(null!=b){a=a.toLowerCase();for(const c of b)if(c&&c.name.toLowerCase()===a)return c}return null}const t=x.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),u=new Map;h.createRelatedInfo=function(b,a){if(b=D(b,a)){var c=`${a.url}/${b.relatedTableId}`;a=new B({url:c,sourceSpatialReference:a.spatialReference});return{url:c,queryTask:a,relation:b,
relatedFields:[],outStatistics:[]}}};h.getDestinationRelation=r;h.getRelatedFieldInfo=function(b){if(!C.isRelatedField(b))return null;const [a,c]=b.split("/").slice(1);return{layerId:a,fieldName:c}};h.queryLayerInfos=function({relatedInfos:b,layer:a},c){const e={};b.forEach((d,f)=>{({relation:d}=d);if(!d)throw f=new q("relation-required","A relation is required on a layer to retrieve related records."),t.error(f),f;({relatedTableId:d}=d);if("number"!==typeof d)throw f=new q("A related table ID is required on a layer to retrieve related records."),
t.error(f),f;d=`${a.url}/${d}`;const g=u.get(d),k=g?g:w(d,{query:{f:"json"},signal:c&&c.signal});g||u.set(d,k);e[f]=k});return l.eachAlways(e)};h.queryRelatedFeatures=function({graphic:b,relatedInfos:a,layer:c},e){const d={};a.forEach((f,g)=>{f.layerInfo&&(d[g]=H(b,f,c,e))});return l.eachAlways(d)};h.setRelatedFeatures=function(b,a){if(a&&b){var {features:c,statsFeatures:e}=b;b=c&&c.value;a.relatedFeatures=b?b.features:[];b=e&&e.value;a.relatedStatsFeatures=b?b.features:[]}};h.updateRelatedInfo=function({relatedInfo:b,
fieldName:a,fieldInfo:c}){b.relatedFields.push(a);c.statisticType&&(a=new A({statisticType:c.statisticType,onStatisticField:a,outStatisticFieldName:a}),b.outStatistics.push(a))};Object.defineProperty(h,"__esModule",{value:!0})});