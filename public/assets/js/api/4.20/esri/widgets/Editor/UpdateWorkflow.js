// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./Edits ./UpdateWorkflowData ./Workflow ./workflowUtils".split(" "),function(l,G,A,B,t,H,x,O,P,Q,R,I,J,K,L,M,u){var y;x=y=function(C){function v(b){b=
C.call(this,b)||this;b.type="update";return b}l._inheritsLoose(v,C);v.create=function(b,q,a){b=new y({data:new L({edits:new K.Edits,viewModel:b}),onCommit:function(){var k=l._asyncToGenerator(function*(d){const g=d.edits.feature,c=g.sourceLayer,e=g.clone();if(!d.edits.attributesModified){const {objectIdField:h}=c;e.attributes={[h]:g.getAttribute(h)}}d.edits.geometryModified||(e.geometry=null);yield a(c,{updateFeatures:[e]})});return function(d){return k.apply(this,arguments)}}()});b._set("steps",
this._createWorkflowSteps(b,q));return b};var D=v.prototype;D.highlight=function(b){var {data:{viewModel:{view:q}}}=this;q=b&&q.allLayerViews.items.find(({layer:a})=>a===b.layer);J.highlightsSupported(q)&&this.handles.add(q.highlight(b),"candidate-highlight")};D.unhighlight=function(){this.handles.remove("candidate-highlight")};v._createWorkflowSteps=function(b,q="awaiting-feature-to-update"){const {data:a,handles:k}=b;return u.createWorkflowSteps(["awaiting-feature-to-update","awaiting-update-feature-candidate",
"editing-existing-feature","adding-attachment","editing-attachment"],q,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",setUp(){var d=this;return l._asyncToGenerator(function*(){const {spinnerViewModel:g,view:c}=a.viewModel;let e=null;k.add({remove(){e&&(e.abort(),e=null)}},d.id);a.edits.feature=null;const h=c.on("immediate-click",p=>{g.location=p.mapPoint;g.visible=!0;e&&e.abort();const {editableItems:m}=a.viewModel;e=t.createAbortController();(new Promise((r,n)=>{t.onAbort(e.signal,
()=>n(t.createAbortError()));r(u.fetchCandidates(m,c,p,e.signal))})).then(r=>{t.throwIfAborted(e);a.candidates=r.reduce((n,f)=>f.error?n:[...n,...f.value],[]);a.viewModel.spinnerViewModel.visible=1===a.candidates.length;0!==a.candidates.length&&(1===a.candidates.length?(a.edits.feature=a.candidates[0],a.viewModel.activeWorkflow.go("editing-existing-feature").catch(()=>{}).then(()=>a.viewModel.spinnerViewModel.visible=!1)):a.viewModel.activeWorkflow.next())})});k.add(h,d.id)})()},tearDown(){var d=
this;return l._asyncToGenerator(function*(){k.remove(d.id)})()}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",setUp(){var d=this;return l._asyncToGenerator(function*(){const {edits:g}=a;g.feature=null;k.add(H.watch(g,"feature",c=>{b.unhighlight();b.highlight(c)}),d.id)})()},tearDown(){var d=this;return l._asyncToGenerator(function*(){b.unhighlight();k.remove(d.id)})()}}),"editing-existing-feature":()=>({id:"editing-existing-feature",setUp(){var d=this;return l._asyncToGenerator(function*(){const g=
a.edits.feature,c=a.viewModel;a.editableItem=c.editableItems.find(f=>f.layer===g.layer);const e=t.createAbortController();k.add({remove:()=>e.abort()},d.id);var h=c.view.whenLayerView(g.layer),p=u.fetchFullFeature(g,c.view,e.signal);h=yield h;const m=yield p;if(!t.isAborted(e)){a.edits.updateGeometry(m.geometry);a.edits.updateAttributes(m.attributes);a.edits.trackChanges();p=m.sourceLayer;var r=u.findLayerInfo(c.layerInfos,p);r=r&&r.fieldConfig;c.attachmentsViewModel.set({graphic:m,mode:"view"});
c.featureFormViewModel.set({feature:m,fieldConfig:r});var n="createInteractiveEditSession"in h?h.createInteractiveEditSession(g):null;h=[c.featureFormViewModel.on("value-change",f=>{a.edits.updateAttributes(c.featureFormViewModel.getValues());m.attributes=a.edits.feature.attributes;n&&n.setAttribute(f.fieldName,f.value)}),c.attachmentsViewModel.watch("mode",f=>{"add"===f&&a.viewModel.activeWorkflow.go("adding-attachment");"edit"===f&&a.viewModel.activeWorkflow.go("editing-attachment")})];n&&(h.push(A.makeHandle(()=>
n.rollback())),k.add(A.makeHandle(()=>n.commit()),b._handleKeys.afterCommit));({supportsGeometryUpdate:p}=p.capabilities.editing);if(p){c.sketchViewModel.allowDeleteKey=!1;const f=u.getVisualVariableAttributes(m),{interactive:E,visual:F}=yield u.setUpGeometryUpdate(m,f,c.sketchViewModel,c.view,({geometry:N,attributes:z})=>{if(B.isSome(f.rotation)){var {field:w}=f.rotation;c.featureFormViewModel.setValue(w,z[w])}B.isSome(f.size)&&({field:w}=f.size,c.featureFormViewModel.setValue(w,z[w]));a.edits.updateAttributes(z);
a.edits.updateGeometry(N)});h.push(E,F);k.add(E,b._handleKeys.beforeCommit);k.add(F,b._handleKeys.afterCommit)}else b.highlight(m);k.add(h,d.id);c.spinnerViewModel.visible=!1}})()},tearDown(){var d=this;return l._asyncToGenerator(function*(){b.unhighlight();k.remove(d.id)})()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",setUp(){return l._asyncToGenerator(function*(){})()},tearDown(){return l._asyncToGenerator(function*(){})()}}),"editing-attachment":()=>({id:"editing-attachment",
parent:"editing-existing-feature",setUp(){return l._asyncToGenerator(function*(){})()},tearDown(){return l._asyncToGenerator(function*(){})()}})})};return v}(M);return x=y=G.__decorate([I.subclass("esri.widgets.Editor.UpdateWorkflow")],x)});