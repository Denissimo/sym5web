// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("require exports ../../chunks/_rollupPluginBabelHelpers ../../Graphic ../../core/has ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../core/watchUtils ../../core/accessorSupport/diffUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../symbols/support/symbolConversion ../../symbols/support/symbolUtils ../../views/3d/layers/graphics/GraphicState ../../views/support/drapedUtils ../../views/support/hitTestSelectUtils".split(" "),
function(U,t,n,aa,va,p,y,D,V,ba,ca,da,ea,fa,ha,E,ia,ja,ka){function W(a){const b=a.sourceLayer;a:switch(b.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":var c=!0;break a;default:c=!1}var d=(a=c&&fa.getVisualVariableValues(b.renderer,a))?a.map(e=>e.variable):[];c=d.filter(e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis));a=c[0];c=1===c.length&&a.field&&!a.valueExpression;var f=d.filter(e=>"size"===e.type);d=f[0];f=1===f.length&&"real-world-size"===
ea.getTransformationType(d)&&d.field&&!d.useSymbolValue&&!d.valueExpression;return{rotation:c?la(a,b):null,size:f?ma(d,b):null}}function la(a,b){const c="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,d=a.field,f=(a=b.fields&&b.fields.filter(g=>g.name===d))&&1===a.length?a[0].type:"double";var e=0,h=0;return{field:d,getDefault:()=>Promise.resolve(0),getValue:g=>{h=e-c*g;return F((h+360)%360,f)},initValue:g=>{e=null!=g?g:h;h=0},isUpdatingInteractively:!1}}function na(a,b){switch(b){case "width":return a[0];
case "depth":return a[1];case "height":return a[2];default:return a[2]||a[1]||a[0]}}function oa(a,b,c){return G.apply(this,arguments)}function G(){G=n._asyncToGenerator(function*(a,b,c){if(p.isNone(b))return 0;({symbol:b}=ha.to3D(b));if(p.isNone(b)||"web-style"===b.type)return 0;b=b.symbolLayers.getItemAt(0);if(!b)return 0;switch(b.type){case "icon":return{computeIconLayerResourceSize:c}=yield new Promise(function(d,f){U(["../../symbols/support/symbolLayerUtils"],d,f)}),b.size||Math.min(x.icon,(yield c(b,
x.icon))[0])||x.icon;case "text":return b.size||x.text;case "line":return b.size||x.line;case "object":{const {computeObjectLayerResourceSize:d}=yield new Promise(function(f,e){U(["../../symbols/support/symbolLayerUtils"],f,e)});a=yield d(b,a.scale/x.viewScaleSizeFactor);return na(a,c)}case "path":case "extrude":return b.size||a.scale/x.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}});return G.apply(this,arguments)}function ma(a,b){const c=a.field,d=a.axis,f=(b=b.fields&&
b.fields.filter(k=>k.name===c))&&1===b.length?b[0].type:"double";var e=0,h=0;const g=da.meterIn[a.valueUnit];let l;l="area"===a.valueRepresentation?k=>(k*g/2)**2*Math.PI:"radius"===a.valueRepresentation||"distance"===a.valueRepresentation?k=>k*g/2:k=>k*g;return{field:c,getDefault:function(){var k=n._asyncToGenerator(function*(m,v){return F(l(yield oa(v,m,d)),f)});return function(m,v){return k.apply(this,arguments)}}(),getValue:(k,m)=>{e||(e=m.pixelSizeAt(m.center));h=e*k;return F(h,f)},initValue:k=>
{e=null!=k?k:h;h=0},isUpdatingInteractively:!1}}function F(a,b){switch(b){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}function z(a){return H.apply(this,arguments)}function H(){H=n._asyncToGenerator(function*(a){const b=yield E.getDisplayedSymbol(a,{useSourceLayer:!0,ignoreGraphicSymbol:!0}),c=ba.diff(a.symbol,b);p.isSome(c)&&(a.symbol=b)});return H.apply(this,arguments)}function pa(a){if("mesh"===a||"multipatch"===a)throw Error("Mesh and Multipatch not supported");
return a}function I(){I=n._asyncToGenerator(function*(a,b,c){yield J(a,b);const d=a.on("create",function(){var f=n._asyncToGenerator(function*(e){if("cancel"===e.state)return J(a,b);"complete"===e.state&&(e=e.graphic,e.sourceLayer||(e.sourceLayer=b.layer),e.attributes||(e.attributes={...b.template.prototype.attributes}),yield z(e),c(e))});return function(e){return f.apply(this,arguments)}}());return{remove:()=>{d.remove();a.cancel()}}});return I.apply(this,arguments)}function J(a,b){return K.apply(this,
arguments)}function K(){K=n._asyncToGenerator(function*(a,b){const c=b.layer;b={...b.template.prototype.attributes};yield qa(a,c,b);b={graphicProperties:{attributes:b,sourceLayer:c},hasZ:c.capabilities.data.supportsZ};a.layer.elevationInfo=c.elevationInfo;a.create(pa(c.geometryType),b)});return K.apply(this,arguments)}function qa(a,b,c){return L.apply(this,arguments)}function L(){L=n._asyncToGenerator(function*(a,b,c){var d;if("3d"===a.view.type){b=new aa({sourceLayer:b,attributes:c});var {rotation:f,
size:e}=W(b),h=yield E.getDisplayedSymbol(b,{useSourceLayer:!0}),g=!1;for(const l of[e,f])p.isNone(l)||null!=c[l.field]||(c[l.field]=yield l.getDefault(h,a.view),g=!0);g&&(h=yield E.getDisplayedSymbol(b,{useSourceLayer:!0}));switch(null==(d=h)?void 0:d.type){case "simple-fill":case "polygon-3d":a.polygonSymbol=h;break;case "simple-line":case "line-3d":a.polylineSymbol=h;break;case "simple-marker":case "point-3d":a.pointSymbol=h}}});return L.apply(this,arguments)}function ra(a,b,c,d){return M.apply(this,
arguments)}function M(){M=n._asyncToGenerator(function*(a,b,c,d){if(0===a.length)return[];const {updatable:f,graphicsByLayer:e}=yield c.async(n._asyncToGenerator(function*(){var {results:h}=yield y.whenOrAbort(ka.hitTestSelectSameDistance(b,c),d);const g=new Map,l=({layer:k})=>{var m=g.get(k);return m?m:(m=[],g.set(k,m),m)};h.forEach(({graphic:k})=>l(k).push(k));h=a.filter(({supports:k,layer:m})=>-1<k.indexOf("update")&&g.has(m));0!==h.length&&c.stopPropagation();return{updatable:h,graphicsByLayer:g}}));
return y.whenOrAbort(y.eachAlways(f.map(function(){var h=n._asyncToGenerator(function*({layer:g}){const {objectIdField:l,displayField:k}=g,m=[l];g.fieldsIndex.has(k)&&m.push(k);const v=e.get(g);if(v.some(u=>m.some(w=>!(w in u.attributes)))){const u=g.createQuery();u.outFields=m;u.returnGeometry=!1;u.objectIds=v.map(w=>w.getObjectId());return g.queryFeatures(u,{signal:d}).then(({features:w})=>w)}return v});return function(g){return h.apply(this,arguments)}}())),d)});return M.apply(this,arguments)}
function sa(a,b,c,d){return N.apply(this,arguments)}function N(){N=n._asyncToGenerator(function*(a,b,c,d){if(0===a.length)return[];const f=yield c.async(n._asyncToGenerator(function*(){var {results:e}=yield y.whenOrAbort(b.hitTest(c),d);if(0===e.length)return[];const h=new Set;e.forEach(({graphic:g})=>h.add(g.layer));e=a.items.filter(({layer:g,supports:l})=>-1<l.indexOf("update")&&h.has(g));0<e.length&&c.stopPropagation();return e}));return y.whenOrAbort(y.eachAlways(f.map(({layer:e})=>{const {objectIdField:h,
displayField:g}=e;var l=[h];e.fieldsIndex.has(g)&&l.push(g);const k=e.createQuery();k.outFields=l;k.returnGeometry=!1;l="renderer"in e?ca.calculateTolerance({renderer:e.renderer,event:c}):0;k.geometry=ja.createQueryGeometry(c.mapPoint,l,b);k.outSpatialReference=b.spatialReference;return e.queryFeatures(k,{signal:d}).then(({features:m})=>m)})),d)});return N.apply(this,arguments)}function O(){O=n._asyncToGenerator(function*(a,b,c,d){switch(b.type){case "3d":return ra(a,b,c,d);case "2d":return sa(a,
b,c,d)}});return O.apply(this,arguments)}function P(){P=n._asyncToGenerator(function*(a,b,c){const d=a.layer,f=d.createQuery();f.objectIds=[a.getAttribute(d.objectIdField)];f.outFields=["*"];f.outSpatialReference=b.spatialReference;f.returnM=d.capabilities.data.supportsM;f.returnZ=d.capabilities.data.supportsZ;return(yield d.queryFeatures(f,{signal:c})).features[0]});return P.apply(this,arguments)}function Q(a,b,c,d){return R.apply(this,arguments)}function R(){R=n._asyncToGenerator(function*(a,b,
c,d){let f=!1;const {rotation:e,size:h}=d;[e,h].forEach(function(){var g=n._asyncToGenerator(function*(l){if(!p.isNone(l)){var k=b.attributes[l.field];p.isSome(k)?l.initValue(k):(k=yield l.getDefault(b.symbol,a.view),l.initValue(k),b.setAttribute(l.field,k),f=!0)}});return function(l){return g.apply(this,arguments)}}());f&&"3d"===a.view.type&&(yield z(b));d={multipleSelectionEnabled:!1};"point"===c.geometryType&&(d.enableRotation=p.isSome(e),d.enableScaling=p.isSome(h));a.layer.elevationInfo=c.elevationInfo;
return a.update(b,d)});return R.apply(this,arguments)}function X(a,b,c,d){return S.apply(this,arguments)}function S(){S=n._asyncToGenerator(function*(a,b,c,d){var f;if(p.isSome(b.geometry)&&"point"===(null==(f=b.geometry)?void 0:f.type)){f=d.rotation;var e=c.toolEventInfo;e=!e||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e;if(p.isSome(f)&&p.isSome(e))if("rotate-stop"===e.type)f.isUpdatingInteractively=!1,f.initValue();else{f.isUpdatingInteractively=!0;const {field:h,getValue:g}=
f;b.attributes[h]=g(e.angle,a)}d=d.size;c=c.toolEventInfo;c=!c||"scale-start"!==c.type&&"scale"!==c.type&&"scale-stop"!==c.type?null:c;if(p.isSome(d)&&p.isSome(c))if("scale-stop"===c.type)d.isUpdatingInteractively=!1,d.initValue();else{d.isUpdatingInteractively=!0;const {field:h,getValue:g}=d;b.attributes[h]=g(c.xScale,a)}"3d"===a.type&&(yield z(b))}});return S.apply(this,arguments)}function T(){T=n._asyncToGenerator(function*(a,b,c,d,f){const e=a.clone();yield z(e);c.layer.add(e);const h=a.sourceLayer,
g=d.whenLayerView(h),l=()=>{const r=a.attributes[a.layer.objectIdField];g.then(q=>q.setVisibility(r,!1),()=>{});return{remove(){g.then(q=>q.setVisibility(r,!0),()=>{})}}};let k=null,m=null;if("3d"===d.type){const r=new ia.GraphicState({graphic:e});k=d.trackGraphicState(r);V.init(r,"displaying",q=>{m=q?l():p.removeMaybe(m)})}else m=l();Q(c,e,h,b);let v=null;g.then(r=>v=r,()=>{});const u=b.size,w=b.rotation,Y=a.watch("attributes",function(){var r=n._asyncToGenerator(function*(q){let A=!1;for(const B in q){const C=
q[B];C!==e.attributes[B]&&(e.setAttribute(B,C),p.isSome(u)&&!u.isUpdatingInteractively&&u.field===B&&u.initValue(C),p.isSome(w)&&!w.isUpdatingInteractively&&w.field===B&&w.initValue(C),p.isNone(v)||v.requiredFields.includes(B))&&(A=!0)}A&&"3d"===d.type&&(yield z(e))});return function(q){return r.apply(this,arguments)}}()),ta=c.on("update",function(){var r=n._asyncToGenerator(function*(q){const A=q.graphics[0];if("complete"===q.state)return Q(c,A,h,b);yield X(d,A,q,b);f(A.clone())});return function(q){return r.apply(this,
arguments)}}()),ua=c.on(["undo","redo"],function(){var r=n._asyncToGenerator(function*(q){f(q.graphics[0].clone())});return function(q){return r.apply(this,arguments)}}());d.map.add(c.layer);const Z=()=>{};return{interactive:{remove(){ua.remove();ta.remove();c.cancel();Y&&Y.remove();this.remove=Z}},visual:{remove(){p.removeMaybe(m);d.whenLayerView(h).then(r=>V.whenFalseOnce(r,"updating")).then(()=>{p.removeMaybe(k);c.layer.remove(e);this.remove=Z})}}}});return T.apply(this,arguments)}const x={icon:D.px2pt(24),
text:D.px2pt(12),line:D.px2pt(1),viewScaleSizeFactor:100};t.avoidFeatureTemplateSelectionWithOnlyOneItem=function(a,b){a.viewModel.refreshCreationTemplates();if("awaiting-feature-creation-info"===b[0].id){var c=a.viewModel.featureTemplatesViewModel.items;1!==c.length?c=null:(c=c[0],c="items"in c?1===c.items.length?c.items[0]:null:c);p.isSome(c)&&(a.creationInfo={layer:c.layer,template:c.template},b.shift())}return b};t.createWorkflowSteps=function(a,b,c){let d=!1;return a.filter(f=>d?!0:d=f===b).map(f=>
c[f]())};t.fetchCandidates=function(a,b,c,d){return O.apply(this,arguments)};t.fetchFullFeature=function(a,b,c){return P.apply(this,arguments)};t.findLayerInfo=function(a,b){return a&&a.find(c=>c.layer===b)};t.getVisualVariableAttributes=W;t.setUpFeatureAdd=function(a,b,c){return I.apply(this,arguments)};t.setUpGeometryUpdate=function(a,b,c,d,f){return T.apply(this,arguments)};t.sizeDefaults=x;t.startCreatingNewFeature=J;t.startUpdatingFeature=Q;t.updateGraphicSymbolWhenRequired=z;t.visualVariableInteractiveUpdate=
X;Object.defineProperty(t,"__esModule",{value:!0})});