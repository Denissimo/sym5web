// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/arrayUtils ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/trackingUtils ../../views/interactive/snapping/FeatureSnappingLayerSource ./BatchCreateWorkflowData ./Workflow ./workflowUtils".split(" "),function(f,A,y,m,w,L,M,N,O,B,C,D,E,F,p){var x;
w=x=function(z){function t(a){a=z.call(this,a)||this;a.type="batch-create";a.createFeatureState="create-new";a.featureFormHandle=null;a.visualVariableAttributes={rotation:null,size:null};a.highlightHandles=new Map;a.preventDefaultActionOnCancel=!1;return a}f._inheritsLoose(t,z);var u=t.prototype;u.updatePendingFeature=function(){var a=f._asyncToGenerator(function*(c){this.preventDefaultActionOnCancel=!0;this.data.viewModel.sketchViewModel.cancel();y.remove(this.lastActiveGraphics,c);return this.startUpdating(c)});
return function(c){return a.apply(this,arguments)}}();t.create=function(a,c,d){a=new x({data:new E.BatchCreateWorkflowData({viewModel:a}),onCommit:function(){var h=f._asyncToGenerator(function*(n){yield d(n.creationInfo.layer,{addFeatures:n.viewModel.sketchViewModel.layer.graphics.toArray()})});return function(n){return h.apply(this,arguments)}}()});a._set("steps",this._createWorkflowSteps(a,c));return a};u.highlight=function(a){const c=this.data.viewModel.view;"3d"===c.type&&this.highlightHandles.set(a,
c.highlight(a))};u.removeHighlight=function(a){m.removeMaybe(this.highlightHandles.get(a));this.highlightHandles.delete(a)};u.startCreating=function(){var a=f._asyncToGenerator(function*(){this.createFeatureState="create-new";return p.startCreatingNewFeature(this.data.viewModel.sketchViewModel,this.data.creationInfo)});return function(){return a.apply(this,arguments)}}();u.startUpdating=function(){var a=f._asyncToGenerator(function*(c){var d;const h=this.data.viewModel,n=h.sketchViewModel,v=this.data.creationInfo.layer;
h.featureFormViewModel.set({feature:c,fieldConfig:null==(d=p.findLayerInfo(h.layerInfos,v))?void 0:d.fieldConfig});m.removeMaybe(this.featureFormHandle);this.featureFormHandle=h.featureFormViewModel.on("value-change",f._asyncToGenerator(function*(){c.attributes=h.featureFormViewModel.getValues();"3d"===n.view.type&&(yield p.updateGraphicSymbolWhenRequired(c))}));this.removeHighlight(c);this.createFeatureState="update-pending";this.visualVariableAttributes=p.getVisualVariableAttributes(c);return p.startUpdatingFeature(n,
c,v,this.visualVariableAttributes)});return function(c){return a.apply(this,arguments)}}();t._createWorkflowSteps=function(a,c="awaiting-feature-creation-info"){const {data:d,handles:h}=a;let n=null,v=!0;c=p.createWorkflowSteps(["awaiting-feature-creation-info","batch-creating-features"],c,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var r=this;return f._asyncToGenerator(function*(){d.creationInfo=null;h.add(d.viewModel.featureTemplatesViewModel.on("select",
({item:q})=>{d.creationInfo={layer:q.layer,template:q.template};d.viewModel.activeWorkflow.next()}),r.id)})()},tearDown(){var r=this;return f._asyncToGenerator(function*(){h.remove(r.id)})()}}),"batch-creating-features":()=>({id:"batch-creating-features",setUp(){var r=this;return f._asyncToGenerator(function*(){const q=d.viewModel.view,g=d.viewModel.sketchViewModel;v=g.updateOnGraphicClick;g.updateOnGraphicClick=!1;a.lastActiveGraphics=[];a.featureFormHandle=m.removeMaybe(a.featureFormHandle);a.visualVariableAttributes=
{rotation:null,size:null};const G=g.on("create",function(){var k=f._asyncToGenerator(function*(b){if("cancel"===b.state){if(a.preventDefaultActionOnCancel){a.preventDefaultActionOnCancel=!1;return}if(1>a.lastActiveGraphics.length)return a.startCreating();b=a.lastActiveGraphics.pop();return a.startUpdating(b)}if("complete"===b.state)return a.startUpdating(b.graphic)});return function(b){return k.apply(this,arguments)}}()),H=g.on("update",function(){var k=f._asyncToGenerator(function*(b){var e=b.graphics[0];
if("complete"===b.state){e!==n&&(a.lastActiveGraphics.push(e),a.highlight(e));n=null;if(b.aborted&&a.preventDefaultActionOnCancel){a.preventDefaultActionOnCancel=!1;return}return a.startCreating()}"start"===b.state&&a.removeHighlight(e);yield p.visualVariableInteractiveUpdate(q,e,b,a.visualVariableAttributes);b=e.attributes;m.isSome(a.visualVariableAttributes.rotation)&&({field:e}=a.visualVariableAttributes.rotation,d.viewModel.featureFormViewModel.setValue(e,b[e]));m.isSome(a.visualVariableAttributes.size)&&
({field:e}=a.visualVariableAttributes.size,d.viewModel.featureFormViewModel.setValue(e,b[e]))});return function(b){return k.apply(this,arguments)}}()),I=g.on("delete",function(){var k=f._asyncToGenerator(function*(b){b=b.graphics[0];y.remove(a.lastActiveGraphics,b);n=b});return function(b){return k.apply(this,arguments)}}());let l=null;const J=C.reactionInit(()=>{var k;const b=g.snappingOptions.featureSources.find(e=>e.layer===d.creationInfo.layer);return{hasFeatureLayerSource:!!b,enabled:null!=(k=
null==b?void 0:b.enabled)?k:!1}},({hasFeatureLayerSource:k,enabled:b})=>{const e=g.snappingOptions.featureSources;k?(m.isNone(l)&&(l=new D({layer:g.layer,enabled:b}),e.add(l)),l.enabled=b):(m.isSome(l)&&e.remove(l),l=m.destroyMaybe(l))}),K=q.on("immediate-click",function(){var k=f._asyncToGenerator(function*(b){b=yield q.hitTest(b,{include:g.layer});0<b.results.length&&(b=b.results[0].graphic,"transform"!==g.activeTool&&"reshape"!==g.activeTool||g.updateGraphics.getItemAt(0)===b||(yield a.updatePendingFeature(b)))});
return function(b){return k.apply(this,arguments)}}());yield a.startCreating();h.add({remove:()=>{m.removeMaybe(a.featureFormHandle);G.remove();H.remove();I.remove();J.remove();m.isSome(l)&&g.snappingOptions.featureSources.remove(l);l=m.destroyMaybe(l);g.cancel();K.remove()}},r.id)})()},tearDown(r){var q=this;return f._asyncToGenerator(function*(){r.cancelled&&d.viewModel.sketchViewModel.layer.removeAll();h.remove(q.id);d.viewModel.sketchViewModel.updateOnGraphicClick=v})()}})});return p.avoidFeatureTemplateSelectionWithOnlyOneItem(d,
c)};f._createClass(t,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}}]);return t}(F);return w=x=A.__decorate([B.subclass("esri.widgets.Editor.BatchCreateWorkflow")],w)});