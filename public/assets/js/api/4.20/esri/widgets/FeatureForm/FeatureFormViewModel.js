// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/ReentrantObjectPool ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/decorators/cast ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../form/FormTemplate ../../support/arcadeOnDemand ./FieldConfig ./FieldGroupConfig ./InputField ./InputFieldGroup ./support/formTemplateUtils ../../intl/locale ../../intl/messages".split(" "),
function(v,d,c,X,H,I,J,B,K,g,Y,L,Z,M,N,O,C,D,P,Q,R,S,T){function U(w){return!!w.fieldConfig}const z=new c({attributes:{}}),V=J.getLogger("esri.widgets.FeatureForm.FeatureFormViewModel");c=function(w){function x(a){a=w.call(this,a)||this;a._arcade=null;a._fieldPool=new B.ReentrantObjectPool(P);a._fieldGroupPool=new B.ReentrantObjectPool(Q);a._featureClone=z.clone();a._initialFeature=z.clone();a._needsArcade=!1;a.messages=null;a.strict=!1;return a}v._inheritsLoose(x,w);var l=x.prototype;l.initialize=
function(){var a=this;const b=function(){var e=v._asyncToGenerator(function*(){return a.messages=yield T.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")});return function(){return e.apply(this,arguments)}}();b();this.handles.add(S.onLocaleChange(b));const h=K.init(this,"fieldConfig",function(){var e=v._asyncToGenerator(function*(f){const p=[];f&&f.forEach(k=>{p.push(k.visibilityExpression);k.fieldConfig?k.fieldConfig.forEach(({requiredExpression:q,visibilityExpression:t})=>{p.push(q,
t)}):p.push(k.requiredExpression)});f=p.filter(k=>!!k);const m=0<f.length;if(m){const k=yield O.loadArcade(),{arcadeUtils:q}=k;f.some(t=>q.hasGeometryOperations(t))&&(yield q.enableGeometryOperations(),h.remove());a._arcade=k;a.notifyChange("inputFields")}a._needsArcade=m});return function(f){return e.apply(this,arguments)}}());this.handles.add(h)};l.destroy=function(){this.layer=this.feature=this.fieldConfig=null;this._fieldPool.destroy();this._fieldGroupPool.destroy()};l.castFieldConfig=function(a){return a?
a.map(b=>b instanceof C||b instanceof D?b:b.fieldConfig?new D(b):new C(b)):null};l.findField=function(a){return this._allInputFields.find(b=>b.name===a)};l.getValue=function(a){var b;const {_featureClone:h,layer:e}=this,f=!(null==e||!e.getField(a));return null!=(b=h.getAttribute(a))?b:f?null:void 0};l.setValue=function(a,b){const {_featureClone:h,strict:e}=this,f=this.findField(a);b=""===b?null:b;if(f&&h.getAttribute(a)!==b){f.value=b;if(this.get("layer.typeIdField")===f.name&&"types"in this.layer){const p=
new Set;this.layer.types.forEach(m=>Object.keys(m.domains).forEach(k=>p.add(k)));p.forEach(m=>{(m=this.findField(m))&&m.notifyChange("domain")})}if(!e||f.valid)h.setAttribute(a,b),this.notifyChange("inputFields"),this._emitChangeEvent(f)}};l.getValues=function(){return{...this._featureClone.attributes}};l.submit=function(){var a=this._allInputFields;const b=a.filter(e=>e.valid).map(({name:e})=>e);a=a.filter(e=>!e.valid).map(({name:e})=>e);const h=this.getValues();this.emit("submit",{valid:b,invalid:a,
values:h})};l._disposeInputOrGroup=function(a){a.inputFields?this._disposeGroup(a):this._disposeInput(a)};l._disposeGroup=function(a){a.inputFields.forEach(b=>this._disposeInput(b));this._fieldGroupPool.release(a)};l._disposeInput=function(a){this._fieldPool.release(a)};l._emitChangeEvent=function({name:a,valid:b,value:h}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:a,value:h,valid:b})};v._createClass(x,[{key:"_allInputFields",get:function(){return this.inputFields.reduce((a,
b)=>b.inputFields?[...a,...b.inputFields]:[...a,b],[])}},{key:"_inputFieldCache",get:function(){const a=this._get("_inputFieldCache")||new Map;a.forEach(b=>this._disposeInputOrGroup(b));a.clear();(this.get("layer.fields")||[]).forEach(b=>a.set(b,this._fieldPool.acquire()));return a}},{key:"_inputFieldGroupCache",get:function(){const a=this._get("_inputFieldGroupCache")||new Map;a.forEach(b=>this._disposeInputOrGroup(b));a.clear();(this.fieldConfig||[]).filter(U).forEach(b=>a.set(b,this._fieldGroupPool.acquire()));
return a}},{key:"description",get:function(){var a;return null==(a=this.formTemplate)?void 0:a.description},set:function(a){void 0===a?this._clearOverride("description"):this._override("description",a)}},{key:"feature",get:function(){return this._get("feature")},set:function(a){this._featureClone=a?a.clone():z.clone();this._initialFeature=this._featureClone.clone();this._set("feature",a)}},{key:"fieldConfig",get:function(){const {formTemplate:a}=this;if(!a)return null;const {config:b,encounteredUnsupportedTypes:h}=
R.fieldConfigsFromFormTemplate(a);0<h.length&&V.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",h);return b},set:function(a){a?this._override("fieldConfig",a):this._clearOverride("fieldConfig")}},{key:"formTemplate",get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(a){void 0===a?this._clearOverride("formTemplate"):this._override("formTemplate",a)}},{key:"inputFields",get:function(){const {_arcade:a,
_inputFieldCache:b,_inputFieldGroupCache:h,_featureClone:e,messages:f,_needsArcade:p,layer:m,state:k}=this,q=e.clone();if("ready"!==k||p&&!a)return[];const t=this.get("layer.fields")||[],E=this.fieldConfig||[];return(0!==E.length?E.map(n=>{if(n.fieldConfig){const u=h.get(n);var r=n.fieldConfig.map(y=>{const A=t.find(W=>W.name===y.name),F=b.get(A);F.set({arcade:a,field:A,config:y,feature:q,group:u,initialFeature:this._initialFeature,layer:m,messages:f,value:this.getValue(A.name)});return F}).filter(y=>
y.visible);u.set({arcade:a,config:n,feature:q,inputFields:r});return u}r=t.find(u=>u.name===n.name);const G=b.get(r);G.set({arcade:a,field:r,config:n,feature:q,group:null,initialFeature:this._initialFeature,layer:m,messages:f,value:this.getValue(r.name)});return G}):t.map(n=>{const r=b.get(n);r.set({arcade:a,config:null,field:n,feature:q,group:null,initialFeature:this._initialFeature,layer:m,messages:f,value:this.getValue(n.name)});return r})).filter(n=>n.visible)}},{key:"layer",get:function(){var a;
return null!=(a=this.feature)&&a.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null},set:function(a){a?this._override("layer",a):this._clearOverride("layer")}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"title",get:function(){var a;return null==(a=this.formTemplate)?void 0:a.title},set:function(a){void 0===a?this._clearOverride("title"):this._override("title",a)}},{key:"valid",get:function(){const a=this._allInputFields;
return 0<a.length&&a.every(({valid:b})=>b)}}]);return x}(I.HandleOwnerMixin(H.EventedAccessor));d.__decorate([g.property({readOnly:!0})],c.prototype,"_allInputFields",null);d.__decorate([g.property({readOnly:!0})],c.prototype,"_inputFieldCache",null);d.__decorate([g.property({readOnly:!0})],c.prototype,"_inputFieldGroupCache",null);d.__decorate([g.property()],c.prototype,"description",null);d.__decorate([g.property()],c.prototype,"feature",null);d.__decorate([g.property()],c.prototype,"fieldConfig",
null);d.__decorate([L.cast("fieldConfig")],c.prototype,"castFieldConfig",null);d.__decorate([g.property({type:N})],c.prototype,"formTemplate",null);d.__decorate([g.property({readOnly:!0,dependsOn:"messages feature fieldConfig layer.fields layer.loaded state".split(" ")})],c.prototype,"inputFields",null);d.__decorate([g.property()],c.prototype,"layer",null);d.__decorate([g.property()],c.prototype,"messages",void 0);d.__decorate([g.property()],c.prototype,"state",null);d.__decorate([g.property()],c.prototype,
"strict",void 0);d.__decorate([g.property()],c.prototype,"title",null);d.__decorate([g.property()],c.prototype,"valid",null);d.__decorate([g.property()],c.prototype,"getValues",null);d.__decorate([g.property()],c.prototype,"submit",null);return c=d.__decorate([M.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],c)});