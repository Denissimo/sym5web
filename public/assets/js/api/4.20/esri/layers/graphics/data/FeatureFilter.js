// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ./spatialQuerySupport ./timeSupport ./utils ../../../rest/support/Query ../../../views/2d/layers/features/FeatureStore2D ../../../views/2d/layers/features/support/whereUtils".split(" "),function(h,m,n,p,q,r,t,u,v,w,x,y){const z=n.getLogger("esri.views.2d.layers.features.controllers.FeatureFilter");return function(){function k(a){this._geometryBounds=
q.create();this._idToVisibility=new Map;this._serviceInfo=a}var c=k.prototype;c.check=function(a){return this._applyFilter(a)};c.clear=function(){const a=this._resetAllHiddenIds();this.update();return{show:a,hide:[]}};c.invalidate=function(){this._idToVisibility.forEach((a,b)=>{this._idToVisibility.set(b,0)})};c.setKnownIds=function(a){for(const b of a)this._idToVisibility.set(b,1)};c.setTrue=function(a){const b=[],d=[],e=new Set(a);this._idToVisibility.forEach((f,g)=>{f=!!(this._idToVisibility.get(g)&
1);const l=e.has(g);!f&&l?b.push(g):f&&!l&&d.push(g);this._idToVisibility.set(g,l?3:0)});return{show:b,hide:d}};c.createQuery=function(){const {geometry:a,spatialRel:b,where:d,timeExtent:e,objectIds:f}=this;return w.fromJSON({geometry:a,spatialRel:b,where:d,timeExtent:e,objectIds:f})};c.update=function(){var a=h._asyncToGenerator(function*(b,d){this._hash=JSON.stringify(b);b=yield v.normalizeQueryLike(b,null,d);yield Promise.all([this._setGeometryFilter(b),this._setIdFilter(b),this._setAttributeFilter(b),
this._setTimeFilter(b)])});return function(b,d){return a.apply(this,arguments)}}();c._setAttributeFilter=function(){var a=h._asyncToGenerator(function*(b){b&&b.where?(this._clause=yield y.createWhereClause(b.where,this._serviceInfo.fieldsIndex),this.where=b.where):this.where=this._clause=null});return function(b){return a.apply(this,arguments)}}();c._setIdFilter=function(a){this._idsToShow=a&&a.objectIds&&new Set(a.objectIds);this._idsToHide=a&&a.hiddenIds&&new Set(a.hiddenIds);this.objectIds=a&&
a.objectIds};c._setGeometryFilter=function(){var a=h._asyncToGenerator(function*(b){if(b&&b.geometry){var d=b.geometry;b=b.spatialRel||"esriSpatialRelIntersects";var e=yield t.getSpatialQueryOperator(b,d,this._serviceInfo.geometryType,this._serviceInfo.hasZ,this._serviceInfo.hasM);r.getBoundsXY(this._geometryBounds,d);this._spatialQueryOperator=e;this.geometry=d;this.spatialRel=b}else this.spatialRel=this.geometry=this._spatialQueryOperator=null});return function(b){return a.apply(this,arguments)}}();
c._setTimeFilter=function(a){this.timeExtent=this._timeOperator=null;a&&a.timeExtent&&(this._serviceInfo.timeInfo?(this.timeExtent=a.timeExtent,this._timeOperator=u.getTimeOperator(this._serviceInfo.timeInfo,a.timeExtent,x.featureAdapter)):(a=new m("feature-layer-view:time-filter-not-available","Unable to apply time filter, as layer doesn't have time metadata.",a.timeExtent),z.error(a)))};c._applyFilter=function(a){return this._filterByGeometry(a)&&this._filterById(a)&&this._filterByTime(a)&&this._filterByExpression(a)};
c._filterByExpression=function(a){return this.where?this._clause(a):!0};c._filterById=function(a){return(!this._idsToHide||!this._idsToHide.size||!this._idsToHide.has(a.getObjectId()))&&(!this._idsToShow||!this._idsToShow.size||this._idsToShow.has(a.getObjectId()))};c._filterByGeometry=function(a){return this.geometry?(a=a.readHydratedGeometry())?this._spatialQueryOperator(a):!1:!0};c._filterByTime=function(a){return p.isSome(this._timeOperator)?this._timeOperator(a):!0};c._resetAllHiddenIds=function(){const a=
[];this._idToVisibility.forEach((b,d)=>{b&1||(this._idToVisibility.set(d,1),a.push(d))});return a};h._createClass(k,[{key:"hash",get:function(){return this._hash}}]);return k}()});