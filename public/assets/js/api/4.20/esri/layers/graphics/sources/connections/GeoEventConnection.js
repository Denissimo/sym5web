// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("require ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ./WebSocketConnection ../../../../rest/query/operations/query ../../../../rest/support/Query ../../../../geometry/support/jsonUtils ../../../../geometry/SpatialReference".split(" "),
function(w,l,x,r,y,p,z,k,A,K,L,M,N,B,C,u,D,E,F){const n=z.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),G={maxQueryDepth:5,maxRecordCountFactor:3};r=function(v){function t(b){return v.call(this,{...G,...b})||this}l._inheritsLoose(t,v);var g=t.prototype;g._open=function(){var b=l._asyncToGenerator(function*(){var a=yield this._fetchServiceDefinition(this._config.source);a.timeInfo.trackIdField||n.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");
a=yield this._fetchWebSocketUrl(a.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices());yield this._buddyServicesQuery;yield this._tryCreateWebSocket(a);const {filter:c,outFields:d}=this._config;this.destroyed||this._setFilter(c,d)});return function(){return b.apply(this,arguments)}}();g._onMessage=function(b){let a;try{a=this._enrich(JSON.parse(b.data)),this._featureZScaler&&this._featureZScaler(a.geometry)}catch(c){n.error(new p("geoevent-connection",
"Failed to parse message",c));return}this.onFeature(a)};g._fetchServiceDefinition=function(){var b=l._asyncToGenerator(function*(a){return this._serviceDefinition=a=(yield y(a.path,{query:{f:"json"},responseType:"json"})).data});return function(a){return b.apply(this,arguments)}}();g._fetchWebSocketUrl=function(){var b=l._asyncToGenerator(function*(a,c){const {urls:d,token:e}=a[0];return`${this._inferWebSocketBaseUrl(d)}/subscribe?outSR=${c.wkid}${e?"\x26token\x3d"+e:""}`});return function(a,c){return b.apply(this,
arguments)}}();g._inferWebSocketBaseUrl=function(b){if(1===b.length)return b[0];for(const a of b)if(-1!==a.indexOf("wss"))return a;n.error(new p("geoevent-connection","Unable to infer WebSocket url",b));return null};g._setFilter=function(){var b=l._asyncToGenerator(function*(a,c){const d=this._websocket;if(!(k.isNone(d)||k.isNone(a)&&k.isNone(c))){a=JSON.stringify({filter:this._serializeFilter(a,c)});var e=!1,h=A.createResolver();d.onmessage=f=>{f=JSON.parse(f.data);f.filter&&(f.error&&(n.error(new p("geoevent-connection",
"Failed to set service filter",f.error)),this._set("errorString",`Could not set service filter - ${f.error}`),h.reject(f.error)),d.onmessage=this._onMessage.bind(this),e=!0,h.resolve())};d.send(a);setTimeout(()=>{e||(this.destroyed||this._websocket!==d||n.error(new p("geoevent-connection","Server timed out when setting filter")),h.reject())},1E4);return h.promise}});return function(a,c){return b.apply(this,arguments)}}();g._serializeFilter=function(b,a){const c={};if(k.isNone(b)&&k.isNone(a))return c;
if(k.isSome(b)&&b.geometry)try{const d=E.fromJSON(b.geometry);if("extent"!==d.type)throw new p(`Expected extent but found type ${d.type}`);c.geometry=JSON.stringify(d.shiftCentralMeridian())}catch(d){n.error(new p("geoevent-connection","Encountered an error when setting connection geometryDefinition",d))}k.isSome(b)&&b.where&&"1 \x3d 1"!==b.where&&(c.where=b.where);k.isSome(a)&&(c.outFields=a.join(","));return c};g._enrich=function(b){if(!this._relatedFeatures)return b;const a=b.attributes[this._serviceDefinition.relatedFeatures.joinField];
if(!this._relatedFeatures.has(a))return n.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",b),b;const {attributes:c,geometry:d}=this._relatedFeatures.get(a);for(const e in c)b.attributes[e]=c[e];d&&(b.geometry=d);b.geometry||b.centroid||n.error(new p("geoevent-connection","Found malformed feature - no geometry found",b));return b};g._queryBuddyServices=function(){var b=l._asyncToGenerator(function*(){try{const {relatedFeatures:a,keepLatestArchive:c}=this._serviceDefinition,
d=this._queryRelatedFeatures(a),e=this._queryArchive(c);yield d;const h=yield e;if(h)for(const f of h.features)this.onFeature(this._enrich(f))}catch(a){n.error(new p("geoevent-connection","Encountered an error when querying buddy services",{error:a}))}});return function(){return b.apply(this,arguments)}}();g._queryRelatedFeatures=function(){var b=l._asyncToGenerator(function*(a){a&&(a=yield this._queryBuddy(a.featuresUrl),this._addRelatedFeatures(a))});return function(a){return b.apply(this,arguments)}}();
g._queryArchive=function(){var b=l._asyncToGenerator(function*(a){if(a)return this._queryBuddy(a.featuresUrl)});return function(a){return b.apply(this,arguments)}}();g._queryBuddy=function(){var b=l._asyncToGenerator(function*(a){const c=new (yield new Promise(function(H,I){w(["../../../FeatureLayer"],function(J){H(Object.freeze({__proto__:null,"default":J}))},I)})).default({url:a});var {capabilities:d}=yield c.load();const e=d.query.supportsMaxRecordCountFactor,h=d.query.supportsPagination;d=d.query.supportsCentroid;
const f=this._config.maxRecordCountFactor;var q=c.capabilities.query.maxRecordCount;q=e?q*f:q;const m=new D;m.outFields=k.unwrapOr(this._config.outFields,["*"]);m.where=k.unwrapOr(k.get(this._config.filter,"where"),"1\x3d1");m.returnGeometry=!0;m.returnExceededLimitFeatures=!0;m.outSpatialReference=F.fromJSON(this._config.spatialReference);d&&(m.returnCentroid=!0);e&&(m.maxRecordCountFactor=f);if(h)return m.num=q,c.destroy(),this._queryPages(a,m);a=yield u.executeQuery(a,m,this._config.sourceSpatialReference);
c.destroy();return a.data});return function(a){return b.apply(this,arguments)}}();g._queryPages=function(){var b=l._asyncToGenerator(function*(a,c,d=[],e=0){c.start=k.isSome(c.num)?e*c.num:null;const {data:h}=yield u.executeQuery(a,c,this._config.sourceSpatialReference);if(h.exceededTransferLimit&&e<this._config.maxQueryDepth)return h.features.forEach(f=>d.push(f)),this._queryPages(a,c,d,e+1);d.forEach(f=>h.features.push(f));return h});return function(a,c){return b.apply(this,arguments)}}();g._addRelatedFeatures=
function(b){const a=new Map;b=b.features;const c=this._serviceDefinition.relatedFeatures.joinField;for(const d of b)a.set(d.attributes[c],d);this._relatedFeatures=a};return t}(C.WebSocketConnection);return r=x.__decorate([B.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],r)});