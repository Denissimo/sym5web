// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/HandleOwner ../../../core/has ../../../core/Loadable ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/workers/workers ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/typeUtils ./support/clientSideDefaults ../../ogc/wfsUtils ../../../rest/support/FeatureSet ../../../geometry/Extent".split(" "),
function(f,g,k,M,x,y,z,A,r,t,B,C,l,N,O,P,D,E,u,n,F,G){f.WFSSource=function(v){function p(){var b=v.apply(this,arguments)||this;b.capabilities=u.createCapabilities(!1,!1);b.type="wfs";b._updateCustomParameters=t.debounce(()=>{var a;const c=b.layer.customParameters;return null==(a=b._connection)?void 0:a.invoke("setCustomParameters",c)});return b}g._inheritsLoose(p,v);var e=p.prototype;e.load=function(b){var a;b=null!=(a=r.isSome(b)&&b.signal)?a:null;this.addResolvingPromise(this._startWorker({signal:b}));
return Promise.resolve(this)};e.destroy=function(){var b;null==(b=this._connection)?void 0:b.close();this._connection=null};e.openPorts=function(){var b=g._asyncToGenerator(function*(){yield this.load();return this._connection.openPorts()});return function(){return b.apply(this,arguments)}}();e.queryFeatures=function(){var b=g._asyncToGenerator(function*(a,c={}){yield this.load(c);a=yield this._connection.invoke("queryFeatures",a?a.toJSON():null,c);return F.fromJSON(a)});return function(a){return b.apply(this,
arguments)}}();e.queryFeaturesJSON=function(){var b=g._asyncToGenerator(function*(a,c={}){yield this.load(c);return this._connection.invoke("queryFeatures",a?a.toJSON():null,c)});return function(a){return b.apply(this,arguments)}}();e.queryFeatureCount=function(){var b=g._asyncToGenerator(function*(a,c={}){yield this.load(c);return this._connection.invoke("queryFeatureCount",a?a.toJSON():null,c)});return function(a){return b.apply(this,arguments)}}();e.queryObjectIds=function(){var b=g._asyncToGenerator(function*(a,
c={}){yield this.load(c);return this._connection.invoke("queryObjectIds",a?a.toJSON():null,c)});return function(a){return b.apply(this,arguments)}}();e.queryExtent=function(){var b=g._asyncToGenerator(function*(a,c={}){yield this.load(c);a=yield this._connection.invoke("queryExtent",a?a.toJSON():null,c);return{count:a.count,extent:G.fromJSON(a.extent)}});return function(a){return b.apply(this,arguments)}}();e.querySnapping=function(){var b=g._asyncToGenerator(function*(a,c={}){yield this.load(c);
return this._connection.invoke("querySnapping",a,c)});return function(a){return b.apply(this,arguments)}}();e.refresh=function(){var b=g._asyncToGenerator(function*(a={}){yield this.load(a);({extent:a}=yield this._connection.invoke("refresh",void 0,a));this.sourceJSON.extent=a;return{extent:a}});return function(){return b.apply(this,arguments)}}();e._createLoadOptions=function(){var b=g._asyncToGenerator(function*(a){const {url:c,customParameters:h,name:d,namespaceUri:m,spatialReference:w,fields:H,
geometryType:I,swapXY:J}=this.layer;if(!c)throw new x("wfs-layer:missing-url","WFSLayer must be created with a url");this.wfsCapabilities=this.wfsCapabilities||(yield n.getCapabilities(c,{customParameters:h,...a}));a="fields geometryType name namespaceUri spatialReference swapXY".split(" ").some(q=>null==this.layer[q])?yield n.getWFSLayerInfo(this.wfsCapabilities,d,m,{spatialReference:w,customParameters:h,signal:null==a?void 0:a.signal}):{...n.prepareWFSLayerFields(H),geometryType:I,name:d,namespaceUri:m,
spatialReference:w,swapXY:J};const K=r.unwrap(n.findFeatureType(this.wfsCapabilities.readFeatureTypes(),a.name,a.namespaceUri)),L=E.featureGeometryTypeKebabDictionary.toJSON(a.geometryType);return{customParameters:h,featureType:K,fields:a.fields.map(q=>q.toJSON()),geometryField:a.geometryField,geometryType:L,getFeatureUrl:this.wfsCapabilities.operations.GetFeature.url,getFeatureOutputFormat:this.wfsCapabilities.operations.GetFeature.outputFormat,objectIdField:a.objectIdField,spatialReference:a.spatialReference.toJSON(),
swapXY:a.swapXY}});return function(a){return b.apply(this,arguments)}}();e._startWorker=function(){var b=g._asyncToGenerator(function*(a){const [c,h]=yield t.eachAlways([this._createLoadOptions(a),C.open("WFSSourceWorker",{...a,strategy:z("feature-layers-workers")?"dedicated":"local"})]);var d=c.error||h.error||null;const m=h.value||null;if(d)throw m&&m.close(),d;d=c.value;this._connection=h.value;({extent:a}=yield this._connection.invoke("load",d,a));this.sourceJSON={extent:a,fields:d.fields,geometryType:d.geometryType,
objectIdField:d.objectIdField,geometryField:d.geometryField,drawingInfo:u.createDrawingInfo(d.geometryType),name:d.featureType.title,wfsInfo:{name:d.featureType.name,featureUrl:d.getFeatureUrl,maxFeatures:3E3,swapXY:d.swapXY,supportedSpatialReferences:d.featureType.supportedSpatialReferences,version:"2.0.0",wfsNamespace:d.featureType.namespaceUri}};this.handles.add(B.init(this.layer,"customParameters",()=>this._updateCustomParameters().catch(()=>{})))});return function(a){return b.apply(this,arguments)}}();
return p}(y.HandleOwnerMixin(A));k.__decorate([l.property()],f.WFSSource.prototype,"capabilities",void 0);k.__decorate([l.property({constructOnly:!0})],f.WFSSource.prototype,"layer",void 0);k.__decorate([l.property()],f.WFSSource.prototype,"sourceJSON",void 0);k.__decorate([l.property()],f.WFSSource.prototype,"type",void 0);k.__decorate([l.property()],f.WFSSource.prototype,"wfsCapabilities",void 0);f.WFSSource=k.__decorate([D.subclass("esri.layers.graphics.sources.WFSSource")],f.WFSSource);f.default=
f.WFSSource;Object.defineProperty(f,"__esModule",{value:!0})});