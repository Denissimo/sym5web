// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../Graphic ../../../core/Collection ../../../core/Error ../../../core/has ../../../core/Loadable ../../../core/Logger ../../../core/maybe ../../../core/Promise ../../../core/workers/workers ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/jsonMap ../../../core/accessorSupport/decorators/shared ../../../core/accessorSupport/decorators/subclass ../../../rest/query/operations/queryZScale ../../../rest/query/operations/zscale ../../../rest/support/FeatureSet ../../../geometry/Extent ../../../geometry/Polygon ../../../geometry/support/typeUtils".split(" "),
function(n,q,r,R,z,D,w,E,F,G,t,H,I,u,J,S,K,L,A,M,N,O,P,B){let Q=0;const x=G.getLogger("esri.layers.graphics.sources.MemorySource");n.MemorySource=function(C){function v(a){a=C.call(this,a)||this;a._idToClientGraphic=null;a.type="memory";return a}q._inheritsLoose(v,C);var e=v.prototype;e.load=function(a){a=t.isSome(a)?a.signal:null;this.addResolvingPromise(this._startWorker(a));return Promise.resolve(this)};e.destroy=function(){var a;null==(a=this._connection)?void 0:a.close();this._connection=null};
e.applyEdits=function(a){return this.load().then(()=>this._applyEdits(a))};e.openPorts=function(){return this.load().then(()=>this._connection.openPorts())};e.queryFeatures=function(){var a=q._asyncToGenerator(function*(b,c={}){yield this.load(c);c=yield this._connection.invoke("queryFeatures",b?b.toJSON():null,c);A.applyFeatureSetZUnitScaling(b,this.layer.spatialReference,c);b=N.fromJSON(c);if(!this._requiresClientGraphicMapping())return b;c=this.layer.objectIdField;for(const d of b.features){const g=
this._idToClientGraphic.get(d.attributes[c]);g&&(d.geometry=g.geometry)}b.geometryType=this.layer.geometryType;return b});return function(b){return a.apply(this,arguments)}}();e.queryFeaturesJSON=function(){var a=q._asyncToGenerator(function*(b,c={}){if(this._requiresClientGraphicMapping())throw new w("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");yield this.load(c);c=yield this._connection.invoke("queryFeatures",b?b.toJSON():null,
c);A.applyFeatureSetZUnitScaling(b,this.layer.spatialReference,c);return c});return function(b){return a.apply(this,arguments)}}();e.queryFeatureCount=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryFeatureCount",a?a.toJSON():null,b))};e.queryObjectIds=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryObjectIds",a?a.toJSON():null,b))};e.queryExtent=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryExtent",a?a.toJSON():
null,b)).then(c=>({count:c.count,extent:O.fromJSON(c.extent)}))};e.querySnapping=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("querySnapping",a,b))};e._applyEdits=function(){var a=q._asyncToGenerator(function*(b){if(!this._connection)throw new w("feature-layer-source:edit-failure","Memory source not loaded");const c=this.layer.objectIdField;let d=null;const g=[],l=[];yield Promise.all([this._prepareClientMapping(b.addFeatures,null),this._prepareClientMapping(b.updateFeatures,
null)]);const m=f=>"objectId"in f&&null!=f.objectId?f.objectId:"attributes"in f&&null!=f.attributes[c]?f.attributes[c]:null;b.addFeatures&&(d=this._prepareAddFeatures(b.addFeatures));if(b.deleteFeatures)for(var k of b.deleteFeatures){const f=m(k);null!=f&&g.push(f)}k=b.updateFeatures&&this._idToClientGraphic?new Map:null;if(b.updateFeatures)for(const f of b.updateFeatures)l.push(this._serializeFeature(f)),k&&(b=m(f),null!=b&&k.set(b,f));M.unapplyEditsZUnitScaling(d?d.features:null,l,this.layer.spatialReference);
const {fullExtent:p,featureEditResults:h}=yield this._connection.invoke("applyEdits",{adds:d?d.features:[],updates:l,deletes:g});this.fullExtent=p;d&&d.finish(h.uidToObjectId);this._updateClientGraphicIds(k,h);return this._createEditsResult(h)});return function(b){return a.apply(this,arguments)}}();e._prepareClientMapping=function(){var a=q._asyncToGenerator(function*(b,c){if("mesh"===this.layerOrSourceGeometryType&&!t.isNone(b)){var d=[];for(const {geometry:g}of b)!t.isSome(g)||"mesh"!==g.type||
g.hasExtent||g.loaded||d.push(g.load({signal:c}));d.length&&(yield Promise.all(d))}});return function(b,c){return a.apply(this,arguments)}}();e._updateClientGraphicIds=function(a,b){if(this._idToClientGraphic){if(a)for(const c of b.updateResults){if(!c.success)continue;const d=a.get(c.objectId);null!=d&&this._addIdToClientGraphic(d)}for(const c of b.deleteResults)c.success&&this._idToClientGraphic.delete(c.objectId)}};e._createEditsResult=function(a){return{addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,
this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}};e._createFeatureEditResult=function(a){const b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new w("feature-layer-source:edit-failure",b.description,
{code:b.code}):null}};e._prepareAddFeatures=function(a){const b=new Map,c=Array(a.length);let d=null;for(let l=0;l<a.length;l++){const m=a[l],k=this._serializeFeature(m);!d&&t.isSome(m.geometry)&&(d=m.geometry.type);c[l]=k;b.set(`${k.uid}`,m)}const g=this;return{features:c,inferredGeometryType:d,finish(l){const m=g.sourceJSON.objectIdField;for(const k in l){const p=l[k],h=b.get(k);h&&(h.attributes||(h.attributes={}),-1===p?delete h.attributes[m]:h.attributes[m]=p,g._addIdToClientGraphic(h))}}}};e._addIdToClientGraphic=
function(a){if(this._idToClientGraphic){var b=this.sourceJSON.objectIdField;b=a.attributes&&a.attributes[b];null!=b&&this._idToClientGraphic.set(b,a)}};e._requiresClientGraphicMapping=function(){return this._geometryTypeRequiresClientGraphicMapping(this.layerOrSourceGeometryType)};e._geometryRequiresClientGraphicMapping=function(a){return this._geometryTypeRequiresClientGraphicMapping(a.type)};e._geometryTypeRequiresClientGraphicMapping=function(a){return"mesh"===a||"multipatch"===a||"extent"===a};
e._serializeFeature=function(a){const {attributes:b}=a;a=this._geometryForSerialization(a);const c=(Q++).toString();return a?{uid:c,geometry:a.toJSON(),attributes:b}:{uid:c,attributes:b}};e._geometryForSerialization=function(a){({geometry:a}=a);return t.isNone(a)?null:this._geometryRequiresClientGraphicMapping(a)?a.extent?P.fromExtent(a.extent):null:a};e._startWorker=function(){var a=q._asyncToGenerator(function*(b){this._connection=yield I.open("MemorySourceWorker",{strategy:E("feature-layers-workers")?
"dedicated":"local",signal:b});const {fields:c,spatialReference:d,objectIdField:g,hasM:l,hasZ:m,timeInfo:k}=this.layer;var p="defaults"===this.layer.originOf("spatialReference");yield this._prepareClientMapping(this.items,b);const h=this._prepareAddFeatures(this.items);this.on("before-changes",y=>{x.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead");y.preventDefault()});p={features:h.features,fields:c&&c.map(y=>y.toJSON()),geometryType:B.typeKebabDictionary.toJSON(this.workerGeometryType),
hasM:"mesh"===this.layerOrSourceGeometryType?!1:l,hasZ:"mesh"===this.layerOrSourceGeometryType?!0:m,objectIdField:g,spatialReference:p?null:d&&d.toJSON(),timeInfo:k?k.toJSON():null};b=yield this._connection.invoke("load",p,{signal:b});for(var f of b.warnings)x.warn(f.message,{layer:this.layer,warning:f});b.featureErrors.length&&x.warn(`Encountered ${b.featureErrors.length} validation errors while loading features`,b.featureErrors);f=b.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(h.inferredGeometryType)&&
(f.geometryType=B.typeKebabDictionary.toJSON(h.inferredGeometryType));this.sourceJSON=f;this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map);h.finish(b.assignedObjectIds)});return function(b){return a.apply(this,arguments)}}();q._createClass(v,[{key:"workerGeometryType",get:function(){var a;const b=null==(a=this.layer)?void 0:a.geometryType;return b?this._geometryTypeRequiresClientGraphicMapping(b)?"polygon":b:null}},{key:"layerOrSourceGeometryType",get:function(){var a,b,c;return null!=
(a=null==(b=this.layer)?void 0:b.geometryType)?a:null==(c=this.sourceJSON)?void 0:c.geometryType}}]);return v}(F.LoadableMixin(H.EsriPromiseMixin(D)));r.__decorate([K.shared({Type:z,ensureType:J.ensureType(z)})],n.MemorySource.prototype,"itemType",void 0);r.__decorate([u.property()],n.MemorySource.prototype,"type",void 0);r.__decorate([u.property({constructOnly:!0})],n.MemorySource.prototype,"layer",void 0);r.__decorate([u.property({readOnly:!0})],n.MemorySource.prototype,"workerGeometryType",null);
r.__decorate([u.property()],n.MemorySource.prototype,"sourceJSON",void 0);n.MemorySource=r.__decorate([L.subclass("esri.layers.graphics.sources.MemorySource")],n.MemorySource);n.default=n.MemorySource;Object.defineProperty(n,"__esModule",{value:!0})});