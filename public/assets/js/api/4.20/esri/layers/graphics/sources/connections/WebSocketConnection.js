// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ./StreamConnection ../../../../rest/query/operations/zscale".split(" "),function(d,n,u,h,A,v,x,y,E,F,G,B,C,D){const g=
A.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");d.ReadyState=void 0;(function(f){f[f.CONNECTING=0]="CONNECTING";f[f.OPEN=1]="OPEN";f[f.CLOSING=2]="CLOSING";f[f.CLOSED=3]="CLOSED"})(d.ReadyState||(d.ReadyState={}));d.WebSocketConnection=function(f){function q(c){var a=f.call(this)||this;a.errorString=null;const {geometryType:b,spatialReference:e,sourceSpatialReference:l}=c;a._config=c;a._featureZScaler=D.getGeometryZScaler(b,l,e);a._open();return a}n._inheritsLoose(q,f);
var k=q.prototype;k._open=function(){var c=n._asyncToGenerator(function*(){yield this._tryCreateWebSocket();this.destroyed||(yield this._handshake())});return function(){return c.apply(this,arguments)}}();k.destroy=function(){v.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close());this._websocket=null};k._tryCreateWebSocket=function(){var c=n._asyncToGenerator(function*(a=this._config.source.path,
b=1E3,e=0){try{this.destroyed||(this._websocket=yield this._createWebSocket(a),this.notifyChange("connectionStatus"))}catch(l){const p=b/1E3;if(this._config.maxReconnectionAttempts&&e>=this._config.maxReconnectionAttempts)g.error(new h("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),this.destroy();else return g.error(new h("websocket-connection",`Failed to connect. Attempting to reconnect in ${p}s`,l)),yield x.after(b),this._tryCreateWebSocket(a,
Math.min(1.5*b,1E3*this._config.maxReconnectionInterval),e+1)}});return function(){return c.apply(this,arguments)}}();k._createWebSocket=function(c){const a=new WebSocket(c);c=new Promise((b,e)=>{a.onopen=()=>b(a);a.onclose=l=>e(l)});c.then(()=>{this.destroyed?(a.onclose=()=>{},a.close()):(a.onclose=b=>this._onClose(b),a.onerror=b=>this._onError(b),a.onmessage=b=>this._onMessage(b))});return c};k._handshake=function(){var c=n._asyncToGenerator(function*(a=1E4){const b=this._websocket;if(!v.isNone(b)){var e=
x.createResolver(),l=b.onmessage,{filter:p,outFields:w,spatialReference:r}=this._config;e.timeout(a);b.onmessage=t=>{var z;let m=null;try{m=JSON.parse(t.data)}catch(H){}m&&"object"===typeof m||(g.error(new h("websocket-connection","Protocol violation. Handshake failed - malformed message",t.data)),e.reject(),this.destroy());(null==(z=m.spatialReference)?void 0:z.wkid)!==(null==r?void 0:r.wkid)&&(g.error(new h("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${r.wkid}`,
t.data)),e.reject(),this.destroy());"json"!==m.format&&(g.error(new h("websocket-connection","Protocol violation. Handshake failed - format is not set",t.data)),e.reject(),this.destroy());p&&m.filter!==p&&g.error(new h("websocket-connection","Tried to set filter, but server doesn't support it"));w&&m.outFields!==w&&g.error(new h("websocket-connection","Tried to set outFields, but server doesn't support it"));b.onmessage=l;e.resolve()};b.send(JSON.stringify({filter:p,outFields:w,format:"json",spatialReference:{wkid:r.wkid}}));
return e.promise}});return function(){return c.apply(this,arguments)}}();k._onMessage=function(c){try{const a=JSON.parse(c.data);if("featureResult"!==a.type)throw new h("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",a);for(const b of a.features)this._featureZScaler&&this._featureZScaler(b.geometry),this.onFeature(b)}catch(a){g.error(new h("websocket-connection","Failed to parse message",a)),this.destroy()}};k._onError=function(c){this._set("errorString",
"Encountered an error over WebSocket connection");g.error("websocket-connection","Encountered an error over WebSocket connection")};k._onClose=function(c){this._websocket=null;this.notifyChange("connectionStatus");1E3!==c.code&&g.error("websocket-connection",`WebSocket closed unexpectedly with error code ${c.code}`);this.destroyed||this._open()};n._createClass(q,[{key:"connectionStatus",get:function(){if(v.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case d.ReadyState.CONNECTING:case d.ReadyState.OPEN:return"connected";
case d.ReadyState.CLOSING:case d.ReadyState.CLOSED:return"disconnected"}}}]);return q}(C);u.__decorate([y.property()],d.WebSocketConnection.prototype,"connectionStatus",null);u.__decorate([y.property()],d.WebSocketConnection.prototype,"errorString",void 0);d.WebSocketConnection=u.__decorate([B.subclass("esri.layers.graphics.sources.connections.WebSocketConnection")],d.WebSocketConnection);Object.defineProperty(d,"__esModule",{value:!0})});