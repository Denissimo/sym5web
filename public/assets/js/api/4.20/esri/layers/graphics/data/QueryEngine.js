// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/MemCache ../../../core/unitUtils ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/normalizeUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./spatialQuerySupport ./timeSupport ./utils ../../support/FieldsIndex ../../support/PromiseQueue ../../../smartMapping/support/utils".split(" "),
function(K,m,w,A,L,R,M,D,N,T,G,S,O,x,B,U,v,C,V,p,W,X,Y){function Z(y){return y.every(l=>"exceedslimit"!==l.statisticType)}const H=new Set,aa=new R.MemCacheStorage(2E6);let ba=0,ea=function(){function y(e){this.capabilities={query:U.queryCapabilities};this.geometryType=e.geometryType;this.hasM=e.hasM;this.hasZ=e.hasZ;this.objectIdField=e.objectIdField;this.spatialReference=e.spatialReference;this.definitionExpression=e.definitionExpression;this.featureStore=e.featureStore;this.aggregateAdapter=e.aggregateAdapter;
this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache());this.timeInfo=e.timeInfo;e.cacheSpatialQueries&&(this._geometryQueryCache=new R.MemCache(ba++ +"$$",aa));this.fieldsIndex=new W(e.fields);e.scheduler&&e.priority&&(this._frameQueue=new X,this._frameTask=e.scheduler.registerTask(e.priority,this))}var l=y.prototype;l.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null);this.clearCache();this._geometryQueryCache&&
this._geometryQueryCache.destroy();this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null);this.fieldsIndex.destroy()};l.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._timeExtent=this._allItems=null};l.executeQuery=function(){var e=m._asyncToGenerator(function*(a={},d){let b=A.clone(a),c;try{b=yield this._schedule(()=>p.normalizeQuery(b,this.definitionExpression,this.spatialReference),d),b=yield this._reschedule(()=>this._checkQuerySupport(b),
d),c=yield this._reschedule(()=>this._executeGeometryQuery(b,d),d),c=yield this._reschedule(()=>c.executeAggregateIdsQuery(b),d),c=yield this._reschedule(()=>c.executeObjectIdsQuery(b),d),c=yield this._reschedule(()=>c.executeTimeQuery(b),d),c=yield this._reschedule(()=>c.executeAttributesQuery(b),d)}catch(g){if(g!==p.QUERY_ENGINE_EMPTY_RESULT)throw g;c=new v([],null,this)}return c.createQueryResponse(b)});return function(){return e.apply(this,arguments)}}();l.executeQueryForCount=function(){var e=
m._asyncToGenerator(function*(a={},d){let b=A.clone(a),c;b.returnGeometry=!1;b.returnCentroid=!1;b.outSR=null;try{b=yield this._schedule(()=>p.normalizeQuery(b,this.definitionExpression,this.spatialReference),d),b=yield this._reschedule(()=>this._checkQuerySupport(b),d),c=yield this._reschedule(()=>this._executeGeometryQuery(b,d),d),c=yield this._reschedule(()=>c.executeAggregateIdsQuery(b),d),c=yield this._reschedule(()=>c.executeObjectIdsQuery(b),d),c=yield this._reschedule(()=>c.executeTimeQuery(b),
d),c=yield this._reschedule(()=>c.executeAttributesQuery(b),d)}catch(g){if(g!==p.QUERY_ENGINE_EMPTY_RESULT)throw g;return 0}return c.createQueryResponseForCount(b)});return function(){return e.apply(this,arguments)}}();l.executeQueryForExtent=function(){var e=m._asyncToGenerator(function*(a={},d){let b=A.clone(a),c;a=b.outSR;try{b=yield this._schedule(()=>p.normalizeQuery(b,this.definitionExpression,this.spatialReference),d);b=yield this._reschedule(()=>this._checkQuerySupport(b),d);b.returnGeometry=
!0;b.returnCentroid=!1;b.outSR=null;c=yield this._reschedule(()=>this._executeGeometryQuery(b,d),d);c=yield this._reschedule(()=>c.executeAggregateIdsQuery(b),d);c=yield this._reschedule(()=>c.executeObjectIdsQuery(b),d);c=yield this._reschedule(()=>c.executeTimeQuery(b),d);c=yield this._reschedule(()=>c.executeAttributesQuery(b),d);const g=c.size;if(!g)return{count:g,extent:null};D.set(u,D.NEGATIVE_INFINITY);this.featureStore.forEachBounds(c.items,h=>D.expandWithAABB(u,h),ca);const k={xmin:u[0],
ymin:u[1],xmax:u[3],ymax:u[4],spatialReference:p.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(u[2])&&isFinite(u[5])&&(k.zmin=u[2],k.zmax=u[5]);const f=B.project(k,c.spatialReference,a);f.spatialReference=p.cleanFromGeometryEngine(a||this.spatialReference);if(0===f.xmax-f.xmin){const h=M.getMetersPerUnitForSR(f.spatialReference);f.xmin-=h;f.xmax+=h}if(0===f.ymax-f.ymin){const h=M.getMetersPerUnitForSR(f.spatialReference);f.ymin-=h;f.ymax+=h}if(this.hasZ&&null!=f.zmin&&null!=
f.zmax&&0===f.zmax-f.zmin){const h=M.getMetersPerUnitForSR(f.spatialReference);f.zmin-=h;f.zmax+=h}return{count:g,extent:f}}catch(g){if(g===p.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw g;}});return function(){return e.apply(this,arguments)}}();l.executeQueryForIds=function(){var e=m._asyncToGenerator(function*(a={},d){return this.executeQueryForIdSet(a,d).then(b=>Array.from(b))});return function(){return e.apply(this,arguments)}}();l.executeQueryForIdSet=function(){var e=m._asyncToGenerator(function*(a=
{},d){let b=A.clone(a),c;b.returnGeometry=!1;b.returnCentroid=!1;b.outSR=null;try{b=yield this._schedule(()=>p.normalizeQuery(b,this.definitionExpression,this.spatialReference),d);b=yield this._reschedule(()=>this._checkQuerySupport(b),d);c=yield this._reschedule(()=>this._executeGeometryQuery(b,d),d);c=yield this._reschedule(()=>c.executeAggregateIdsQuery(b),d);c=yield this._reschedule(()=>c.executeObjectIdsQuery(b),d);c=yield this._reschedule(()=>c.executeTimeQuery(b),d);c=yield this._reschedule(()=>
c.executeAttributesQuery(b),d);const g=c.items,k=new Set;yield this._reschedule(()=>{for(const f of g)k.add(c.featureAdapter.getObjectId(f))},d);return k}catch(g){if(g===p.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw g;}});return function(){return e.apply(this,arguments)}}();l.executeQueryForSnapping=function(){var e=m._asyncToGenerator(function*(a,d){const {point:b,distance:c,types:g}=a;if(0===g)return{candidates:[]};const k=yield this._reschedule(()=>this._checkQuerySupport(a.query),d),f=!O.equals(b.spatialReference,
this.spatialReference);f&&(yield B.checkProjectionSupport(b.spatialReference,this.spatialReference));var h="number"===typeof c?c:c.x,q="number"===typeof c?c:c.y;h={xmin:b.x-h,xmax:b.x+h,ymin:b.y-q,ymax:b.y+q,spatialReference:b.spatialReference};h=f?B.project(h,this.spatialReference):h;if(!h)return{candidates:[]};q=(yield S.normalizeCentralMeridian(G.fromJSON(b),null,{signal:d}))[0];const E=(yield S.normalizeCentralMeridian(G.fromJSON(h),null,{signal:d}))[0];if(L.isNone(q)||L.isNone(E))return{candidates:[]};
let n=new v(this._searchFeatures(this._getQueryBBoxes(E.toJSON())),null,this);n=yield this._reschedule(()=>n.executeObjectIdsQuery(k),d);n=yield this._reschedule(()=>n.executeTimeQuery(k),d);n=yield this._reschedule(()=>n.executeAttributesQuery(k),d);d=q.toJSON();d=f?B.project(d,this.spatialReference):d;return n.createSnappingResponse({...a,point:d,distance:f?Math.max(h.xmax-h.xmin,h.ymax-h.ymin)/2:c},b.spatialReference)});return function(a,d){return e.apply(this,arguments)}}();l.executeQueryForLatestObservations=
function(){var e=m._asyncToGenerator(function*(a={},d){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new w("feature-store:unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:a,timeInfo:this.timeInfo});let b=A.clone(a),c;try{b=yield this._schedule(()=>p.normalizeQuery(b,this.definitionExpression,this.spatialReference),d),b=yield this._reschedule(()=>this._checkQuerySupport(b),d),c=yield this._reschedule(()=>this._executeGeometryQuery(b,d),d),c=yield this._reschedule(()=>c.executeAggregateIdsQuery(b),
d),c=yield this._reschedule(()=>c.executeObjectIdsQuery(b),d),c=yield this._reschedule(()=>c.executeTimeQuery(b),d),c=yield this._reschedule(()=>c.executeAttributesQuery(b),d),c=yield this._reschedule(()=>c.filterLatest(),d)}catch(g){if(g!==p.QUERY_ENGINE_EMPTY_RESULT)throw g;c=new v([],null,this)}return c.createQueryResponse(b)});return function(){return e.apply(this,arguments)}}();l.executeQueryForSummaryStatistics=function(){var e=m._asyncToGenerator(function*(a={},d,b){a=A.clone(a);let c;try{a=
yield this._schedule(()=>p.normalizeQuery(a,this.definitionExpression,this.spatialReference),b),a=yield this._reschedule(()=>this._checkSummaryStatisticsSupport(a,d),b),c=yield this._reschedule(()=>this._executeGeometryQuery(a,b),b),c=yield this._reschedule(()=>c.executeAggregateIdsQuery(a),b),c=yield this._reschedule(()=>c.executeObjectIdsQuery(a),b),c=yield this._reschedule(()=>c.executeTimeQuery(a),b),c=yield this._reschedule(()=>c.executeAttributesQuery(a),b)}catch(g){if(g!==p.QUERY_ENGINE_EMPTY_RESULT)throw g;
c=new v([],null,this)}return c.createSummaryStatisticsResponse(a,d)});return function(){return e.apply(this,arguments)}}();l._schedule=function(){var e=m._asyncToGenerator(function*(a,d){return this._frameQueue?this._frameQueue.push(a,d):a()});return function(a,d){return e.apply(this,arguments)}}();l._reschedule=function(){var e=m._asyncToGenerator(function*(a,d){return this._frameQueue?this._frameQueue.unshift(a,d):a()});return function(a,d){return e.apply(this,arguments)}}();l.runTask=function(e){for(this._budget=
e;!e.done&&this._frameQueue&&this._frameQueue.process();)e.madeProgress();this._budget=null};l._getAll=function(){if(!this._allItems){const e=[];this.featureStore.forEach(a=>e.push(a));this._allItems=new v(e,null,this)}return this._allItems};l._executeGeometryQuery=function(){var e=m._asyncToGenerator(function*(a,d){var b=this;const {geometry:c,outSR:g,spatialRel:k,returnGeometry:f,returnCentroid:h}=a,q=f||h,E=O.isValid(g)&&!O.equals(this.spatialReference,g),n=this._geometryQueryCache?E&&q?JSON.stringify({geometry:c,
spatialRelationship:k,outSpatialReference:g}):JSON.stringify({geometry:c,spatialRelationship:k}):null;if(n){var r=this._geometryQueryCache.get(n);if(!L.isUndefined(r))return r}r=function(){var z=m._asyncToGenerator(function*(t){if(E&&q)return t=yield t.project(g),n&&b._geometryQueryCache.put(n,t,t.size||1),t;n&&b._geometryQueryCache.put(n,t,t.size||1);return t});return function(t){return z.apply(this,arguments)}}();if(!c)return r(this._getAll());const I=this.featureAdapter;if("esriSpatialRelDisjoint"===
k){a=this._searchFeatures(this._getQueryBBoxes(c));if(!a.length)return r(this._getAll());let z,t;const P=new Set;for(var F of a)P.add(I.getObjectId(F));yield this._reschedule(()=>{let Q=0;z=Array(P.size);this.featureStore.forEach(J=>z[Q++]=J);t=P},d);a=yield this._reschedule(m._asyncToGenerator(function*(){const Q=yield C.getSpatialQueryOperator(k,c,b.geometryType,b.hasZ,b.hasM);return new v(yield b._runSpatialFilter(z,J=>!t.has(I.getObjectId(J))||Q(I.getGeometry(J)),d),c,b)}),d);return r(a)}F=this._searchFeatures(this._getQueryBBoxes(c));
if(!F.length)return r=new v([],c,this),n&&this._geometryQueryCache.put(n,r,r.size||1),r;if(this._canExecuteSoloPass(c,a))return r(new v(F,c,this));const da=yield C.getSpatialQueryOperator(k,c,this.geometryType,this.hasZ,this.hasM);a=yield this._runSpatialFilter(F,z=>da(I.getGeometry(z)),d);return r(new v(a,c,this))});return function(a,d){return e.apply(this,arguments)}}();l._runSpatialFilter=function(){var e=m._asyncToGenerator(function*(a,d,b){var c=this;if(!d)return a;if(!this._budget)return a.filter(h=>
d(h));let g=0;const k=[],f=function(){var h=m._asyncToGenerator(function*(){for(;g<a.length;){const q=a[g];d(q)&&k.push(q);c._budget.done&&(yield c._reschedule(()=>f(),b));++g}});return function(){return h.apply(this,arguments)}}();return this._reschedule(()=>f(),b).then(()=>k)});return function(a,d,b){return e.apply(this,arguments)}}();l._canExecuteSoloPass=function(e,a){const {geometryType:d}=this;({spatialRel:a}=a);return C.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===a||"esriGeometryPoint"===
d&&("esriSpatialRelIntersects"===a||"esriSpatialRelContains"===a||"esriSpatialRelWithin"===a))};l._getQueryBBoxes=function(e){if(C.canQueryWithRBush(e)){if(G.isExtent(e))return[N.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(G.isPolygon(e))return e.rings.map(a=>N.fromValues(Math.min(a[0][0],a[2][0]),Math.min(a[0][1],a[2][1]),Math.max(a[0][0],a[2][0]),Math.max(a[0][1],a[2][1])))}return[T.getBoundsXY(N.create(),e)]};l._searchFeatures=function(e){for(const b of e)this.featureStore.forEachInBounds(b,c=>
{H.add(c)});const a=Array(H.size);let d=0;H.forEach(b=>a[d++]=b);H.clear();return a};l._checkSummaryStatisticsSupport=function(){var e=m._asyncToGenerator(function*(a,d){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text||a.outStatistics||a.groupByFieldsForStatistics||a.having||a.orderByFields)throw new w("feature-store:unsupported-query","Unsupported query options",{query:a});return Promise.all([this._checkAttributesQuerySupport(a),this._checkSummaryStatisticsParamsSupport(d),
C.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),B.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)});return function(a,d){return e.apply(this,arguments)}}();l._checkSummaryStatisticsParamsSupport=function(){var e=m._asyncToGenerator(function*(a){const d=yield Y.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression});if(!d.length)throw new w("feature-store:unsupported-query","params should have atleast a field or valueExpression",
{params:a});x.validateFields(this.fieldsIndex,d,"params contains missing fields")});return function(a){return e.apply(this,arguments)}}();l._checkQuerySupport=function(){var e=m._asyncToGenerator(function*(a){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text)throw new w("feature-store:unsupported-query","Unsupported query options",{query:a});return Promise.all([this._checkAttributesQuerySupport(a),this._checkStatisticsQuerySupport(a),C.checkSpatialQuerySupport(a,
this.geometryType,this.spatialReference),B.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)});return function(a){return e.apply(this,arguments)}}();l._checkAttributesQuerySupport=function(e){const {outFields:a,orderByFields:d,returnDistinctValues:b,outStatistics:c}=e,g=c?c.map(k=>k.outStatisticFieldName&&k.outStatisticFieldName.toLowerCase()):[];if(d&&0<d.length){const k=d.map(f=>{const h=f.toLowerCase();return-1<h.indexOf(" asc")?h.split(" asc")[0]:-1<h.indexOf(" desc")?h.split(" desc")[0]:
f}).filter(f=>-1===g.indexOf(f));x.validateFields(this.fieldsIndex,k,"orderByFields contains missing fields")}if(a&&0<a.length)x.validateFields(this.fieldsIndex,a,"outFields contains missing fields");else if(b)throw new w("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});x.validateWhere(this.fieldsIndex,e.where)};l._checkStatisticsQuerySupport=function(){var e=m._asyncToGenerator(function*(a){const {outStatistics:d,groupByFieldsForStatistics:b,having:c}=
a;var g=b&&b.length,k=d&&d.length;if(c){if(!g||!k)throw new w("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a});x.validateHaving(this.fieldsIndex,c,d)}if(k&&Z(d)){k=d.map(f=>f.onStatisticField);x.validateFields(this.fieldsIndex,k,"onStatisticFields contains missing fields");g&&x.validateFields(this.fieldsIndex,b,"groupByFieldsForStatistics contains missing fields");for(const f of d){const {onStatisticField:h,statisticType:q}=
f;if(("percentile_disc"===q||"percentile_cont"===q)&&"statisticParameters"in f){if({statisticParameters:g}=f,!g)throw new w("feature-store:unsupported-query","statisticParamters should be set for percentile type",{definition:f,query:a});}else if("count"!==q&&h&&x.hasInvalidFieldType(h,this.fieldsIndex))throw new w("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:f,query:a});}}});return function(a){return e.apply(this,arguments)}}();m._createClass(y,[{key:"featureAdapter",
get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",get:function(){const e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:p.cleanFromGeometryEngine(this.spatialReference)}:null}},{key:"timeExtent",get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:this._timeExtent=V.getTimeExtent(this.timeInfo,this.featureStore):null}},{key:"running",get:function(){return 0<this._frameQueue.length}}]);return y}();const ca=D.create(),
u=D.create();K.Feature=function(y,l=null,e,a,d){this.attributes=y;this.geometry=e;this.centroid=a;this.filterFlags=d;this.groupId=-1;this.displayId=l};K.default=ea;Object.defineProperty(K,"__esModule",{value:!0})});