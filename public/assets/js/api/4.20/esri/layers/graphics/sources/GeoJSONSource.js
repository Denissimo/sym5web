// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/has ../../../core/Loadable ../../../core/Logger ../../../core/maybe ../../../core/workers/workers ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ./support/clientSideDefaults ../../support/TimeInfo ../../../rest/support/FeatureSet ../../../geometry/Extent ../../../geometry/Polygon ../../../geometry/support/typeUtils".split(" "),
function(e,t,g,K,u,A,B,C,v,D,h,L,M,E,F,G,H,w,I,J){const x=C.getLogger("esri.layers.graphics.sources.GeoJSONSource");e.GeoJSONSource=function(y){function n(){var a=y.apply(this,arguments)||this;a.type="geojson";a.fullExtent=null;a.timeInfo=null;return a}t._inheritsLoose(n,y);var d=n.prototype;d.load=function(a){a=v.isSome(a)?a.signal:null;this.addResolvingPromise(this._startWorker(a));return Promise.resolve(this)};d.destroy=function(){var a;null==(a=this._connection)?void 0:a.close();this._connection=
null};d.applyEdits=function(a){return this.load().then(()=>this._applyEdits(a))};d.openPorts=function(){return this.load().then(()=>this._connection.openPorts())};d.queryFeatures=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryFeatures",a?a.toJSON():null,b)).then(f=>H.fromJSON(f))};d.queryFeaturesJSON=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryFeatures",a?a.toJSON():null,b))};d.queryFeatureCount=function(a,b={}){return this.load(b).then(()=>
this._connection.invoke("queryFeatureCount",a?a.toJSON():null,b))};d.queryObjectIds=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryObjectIds",a?a.toJSON():null,b))};d.queryExtent=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("queryExtent",a?a.toJSON():null,b)).then(f=>({count:f.count,extent:w.fromJSON(f.extent)}))};d.querySnapping=function(a,b={}){return this.load(b).then(()=>this._connection.invoke("querySnapping",a,b))};d._applyEdits=function(a){if(!this._connection)throw new u("geojson-layer-source:edit-failure",
"Memory source not loaded");const b=this.layer.objectIdField,f=[],k=[],l=[];if(a.addFeatures)for(const c of a.addFeatures)f.push(this._serializeFeature(c));if(a.deleteFeatures)for(const c of a.deleteFeatures)"objectId"in c&&null!=c.objectId?k.push(c.objectId):"attributes"in c&&null!=c.attributes[b]&&k.push(c.attributes[b]);if(a.updateFeatures)for(const c of a.updateFeatures)l.push(this._serializeFeature(c));return this._connection.invoke("applyEdits",{adds:f,updates:l,deletes:k}).then(({fullExtent:c,
timeExtent:p,featureEditResults:q})=>{this.fullExtent=c;this.timeInfo&&(c=this.timeInfo.clone(),c.read({timeExtent:p}),this.timeInfo=c);return this._createEditsResult(q)})};d._createEditsResult=function(a){return{addFeatureResults:a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],
updateAttachmentResults:[],deleteAttachmentResults:[]}};d._createFeatureEditResult=function(a){const b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new u("geojson-layer-source:edit-failure",b.description,{code:b.code}):null}};d._serializeFeature=function(a){const {attributes:b}=a;return(a=this._geometryForSerialization(a))?{geometry:a.toJSON(),attributes:b}:{attributes:b}};d._geometryForSerialization=function(a){({geometry:a}=
a);return v.isNone(a)?null:"mesh"===a.type||"extent"===a.type?I.fromExtent(a.extent):a};d._startWorker=function(){var a=t._asyncToGenerator(function*(b){this._connection=yield D.open("GeoJSONSourceWorker",{strategy:A("feature-layers-workers")?"dedicated":"local",signal:b});const {fields:f,spatialReference:k,hasZ:l,geometryType:c,objectIdField:p,url:q,timeInfo:z}=this.layer;var r="defaults"===this.layer.originOf("spatialReference");r={url:q,fields:f&&f.map(m=>m.toJSON()),geometryType:J.typeKebabDictionary.toJSON(c),
hasZ:l,objectIdField:p,timeInfo:z?z.toJSON():null,spatialReference:r?null:k&&k.toJSON()};b=yield this._connection.invoke("load",r,{signal:b});for(const m of b.warnings)x.warn(m.message,{layer:this.layer,warning:m});b.featureErrors.length&&x.warn(`Encountered ${b.featureErrors.length} validation errors while loading features`,b.featureErrors);this.fullExtent=w.fromJSON(b.layerDefinition.extent);this.timeInfo=G.fromJSON(b.layerDefinition.timeInfo);this.sourceJSON=b.layerDefinition;this.capabilities=
F.createCapabilities(b.layerDefinition.hasZ,!0)});return function(b){return a.apply(this,arguments)}}();return n}(B);g.__decorate([h.property()],e.GeoJSONSource.prototype,"capabilities",void 0);g.__decorate([h.property()],e.GeoJSONSource.prototype,"type",void 0);g.__decorate([h.property()],e.GeoJSONSource.prototype,"fullExtent",void 0);g.__decorate([h.property({constructOnly:!0})],e.GeoJSONSource.prototype,"layer",void 0);g.__decorate([h.property()],e.GeoJSONSource.prototype,"sourceJSON",void 0);
g.__decorate([h.property()],e.GeoJSONSource.prototype,"timeInfo",void 0);e.GeoJSONSource=g.__decorate([E.subclass("esri.layers.graphics.sources.GeoJSONSource")],e.GeoJSONSource);e.default=e.GeoJSONSource;Object.defineProperty(e,"__esModule",{value:!0})});