// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../PixelBlock ../RasterInfo ../RasterStorageInfo ./BaseRaster ./pamParser ./xmlUtilities ../rasterFormats/utils ../rasterFunctions/pixelUtils ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(C,D,y,A,G,E,T,U,V,W,K,L,M,N,O,H,r,P,Q,R,S,I){const w=new Map;w.set("Int8","s8");w.set("UInt8","u8");w.set("Int16","s16");w.set("UInt16","u16");w.set("Int32","s32");w.set("UInt32","u32");w.set("Float32","f32");w.set("Float64","f32");w.set("Double64","f32");const B=new Map;B.set("lerc",".lrc");B.set("none",".til");B.set("deflate",".pzp");B.set("jpeg",".jzp");y=function(J){function F(){var b=J.apply(this,arguments)||this;b._files=null;b._storageIndex=null;b.datasetFormat="MRF";return b}C._inheritsLoose(F,
J);var z=F.prototype;z.open=function(){var b=C._asyncToGenerator(function*(a){var c;yield this.init();this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);var d=a?G.unwrap(a.signal):null,e=yield this.request(this.url,{responseType:"xml",signal:d});const {rasterInfo:g,files:q}=this._parseHeader(e.data);if(-1===(null==(c=this.ioConfig.skipExtensions)?void 0:c.indexOf("aux.xml"))&&(a=yield this._fetchAuxiliaryData(a),null!=a)){var k;g.statistics=null!=(k=a.statistics)?k:g.statistics;(g.histograms=
a.histograms)&&!G.isSome(g.statistics)&&(g.statistics=Q.estimateStatisticsFromHistograms(a.histograms))}this._set("rasterInfo",g);this._files=q;d=yield this.request(q.index,{responseType:"array-buffer",signal:d});this._storageIndex=this._parseIndex(d.data);d=0;k=-1;const {blockWidth:t,blockHeight:h,compression:u}=this.rasterInfo.storageInfo;e=this.rasterInfo.storageInfo.pyramidScalingFactor;const {width:l,height:n,bandCount:p}=this.rasterInfo,m=[],f="none"===u?1:p;for(;d<this._storageIndex.length;)k++,
a=Math.ceil(l/t/e**k),c=Math.ceil(n/h/e**k),d+=a*c*f*4,m.push({maxRow:c,maxCol:a,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=m;0<k&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=k);this.updateTileInfo()});return function(a){return b.apply(this,arguments)}}();z.fetchRawTile=function(){var b=C._asyncToGenerator(function*(a,c,d,e={}){const {blockWidth:g,blockHeight:q,blockBoundary:k,compression:t}=this.rasterInfo.storageInfo;var h=
k[a];if(!h||h.maxRow<c||h.maxCol<d||h.minRow>c||h.minCol>d)return null;const {bandCount:u,pixelType:l}=this.rasterInfo,{ranges:n,actualTileWidth:p,actualTileHeight:m}=this._getTileLocation(a,c,d);if(!n||0===n.length)return null;if(0===n[0].from&&0===n[0].to)return a=new Uint8Array(g*q),new L({width:g,height:q,pixels:null,mask:a,validPixelCount:0});({bandIds:d}=this.ioConfig);c="none"===t?1:u;h=[];for(a=a=0;a<c;a++)(!d||-1<d.indexOf[a])&&h.push(this.request(this._files.data,{range:{from:n[a].from,
to:n[a].to},responseType:"array-buffer",signal:e.signal}));e=yield Promise.all(h);a=e.map(f=>f.data.byteLength).reduce((f,v)=>f+v);d=new Uint8Array(a);for(a=h=0;a<c;a++)d.set(new Uint8Array(e[a].data),h),h+=e[a].data.byteLength;e=yield this.decodePixelBlock(d.buffer,{width:g,height:q,format:"lerc"===this.rasterInfo.storageInfo.compression?"lerc":"bip",pixelType:l});d=c=0;if(p!==g||m!==q)if(h=e.mask)for(a=0;a<q;a++)for(d=a*g,c=a<m?p:0;c<g;c++)h[d+c]=0;else for(h=new Uint8Array(g*q),e.mask=h,a=0;a<
m;a++)for(d=a*g,c=0;c<p;c++)h[d+c]=1;return e});return function(a,c,d){return b.apply(this,arguments)}}();z._parseIndex=function(b){if(0<b.byteLength%16)throw"invalid array buffer must be multiples of 16";let a,c,d,e,g;if(P.isPlatformLittleEndian){a=new Uint8Array(b);d=new ArrayBuffer(b.byteLength);c=new Uint8Array(d);for(e=0;e<b.byteLength/4;e++)for(g=0;4>g;g++)c[4*e+g]=a[4*e+3-g];b=new Uint32Array(d)}else b=new Uint32Array(b);return b};z._getTileLocation=function(b,a,c){const {blockWidth:d,blockHeight:e,
pyramidScalingFactor:g,compression:q}=this.rasterInfo.storageInfo,{width:k,height:t,bandCount:h}=this.rasterInfo,u="none"===q?1:h;let l,n;var p,m=0;let f=0;for(p=0;p<b;p++)f=g**p,l=Math.ceil(k/d/f),n=Math.ceil(t/e/f),m+=l*n;f=g**b;l=Math.ceil(k/d/f);n=Math.ceil(t/e/f);m=4*(m+(a*l+c))*u;b=this._storageIndex.subarray(m,m+4*u);m=p=0;const v=[];for(let x=0;x<u;x++)p=b[4*x]*2**32+b[4*x+1],m=p+b[4*x+2]*2**32+b[4*x+3],v.push({from:p,to:m});return{ranges:v,actualTileWidth:c<l-1?d:Math.ceil(k/f)-d*(l-1),actualTileHeight:a<
n-1?e:Math.ceil(t/f)-e*(n-1)}};z._parseHeader=function(b){var a=r.getElement(b,"MRF_META/Raster");if(!a)throw new A("mrf:open","not a valid MRF format");var c=r.getElement(a,"Size"),d=parseInt(c.getAttribute("x"),10),e=parseInt(c.getAttribute("y"),10);const g=parseInt(c.getAttribute("c"),10);c=(r.getElementValue(a,"Compression")||"none").toLowerCase();var q=["none","lerc"];if(!c||-1===q.indexOf(c))throw new A("mrf:open","currently does not support compression "+c);var k=r.getElementValue(a,"DataType")||
"UInt8";q=w.get(k);if(null==q)throw new A("mrf:open","currently does not support pixel type "+k);var t=r.getElement(a,"PageSize");k=parseInt(t.getAttribute("x"),10);t=parseInt(t.getAttribute("y"),10);a=r.getElement(a,"DataValues");let h;a&&(a=a.getAttribute("NoData"),null!=a&&(h=a.trim().split(" ").map(x=>parseFloat(x))));if(r.getElement(b,"MRF_META/CachedSource"))throw new A("mrf:open","currently does not support MRF referencing other data files");var u=r.getElement(b,"MRF_META/GeoTags"),l=r.getElement(u,
"BoundingBox");if(null==l)throw new A("mrf:open","missing node MRF_META/GeoTags/BoundingBox");a=parseFloat(l.getAttribute("minx"));const n=parseFloat(l.getAttribute("miny")),p=parseFloat(l.getAttribute("maxx")),m=parseFloat(l.getAttribute("maxy"));var f=r.getElementValue(u,"Projection")||"";u=r.getElementValue(b,"datafile");l=r.getElementValue(b,"IndexFile");let v;"LOCAL_CS[]"!==f&&(f.toLowerCase().startsWith("epsg:")?(f=Number(f.slice(5)),isNaN(f)||0===f||(v=new R({wkid:f}))):v=H.parseSpatialReference(f));
f=new S(a,n,p,m);f.spatialReference=v;b=r.getElement(b,"MRF_META/Rsets");b=parseInt(b&&b.getAttribute("scale")||"2",10);b=new N({origin:new I({x:f.xmin,y:f.ymax,spatialReference:v}),blockWidth:k,blockHeight:t,pyramidBlockWidth:k,pyramidBlockHeight:t,compression:c,pyramidScalingFactor:b});k=new I({x:(p-a)/d,y:(m-n)/e,spatialReference:v});d=new M({width:d,height:e,extent:f,spatialReference:v,bandCount:g,pixelType:q,pixelSize:k,noDataValue:h,storageInfo:b});e={mrf:this.url,index:l||this.url.replace(".mrf",
".idx"),data:u||this.url.replace(".mrf",B.get(c))};return{rasterInfo:d,files:e}};z._fetchAuxiliaryData=function(){var b=C._asyncToGenerator(function*(a){try{const {data:c}=yield this.request(this.url+".aux.xml",{responseType:"xml",signal:null==a?void 0:a.signal});return H.parsePAMInfo(c)}catch{return null}});return function(a){return b.apply(this,arguments)}}();return F}(O);D.__decorate([E.property()],y.prototype,"_files",void 0);D.__decorate([E.property()],y.prototype,"_storageIndex",void 0);D.__decorate([E.property({type:String,
json:{write:!0}})],y.prototype,"datasetFormat",void 0);return y=D.__decorate([K.subclass("esri.layers.support.rasterIO.MRFRaster")],y)});