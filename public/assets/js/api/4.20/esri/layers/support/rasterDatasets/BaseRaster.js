// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../request ../../../core/Error ../../../core/JSONSupport ../../../core/Logger ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../arcgisLayerUrl ../commonProperties ../RasterStorageInfo ../TileInfo ./RawBlockCache ../rasterFormats/RasterCodec ../rasterFunctions/pixelUtils ../rasterFunctions/rasterProjectionHelper ../../../geometry/Point ../../../geometry/Extent".split(" "),
function(w,z,x,Y,N,Z,aa,y,ba,O,C,ja,ka,la,ca,da,ea,fa,P,A,ha,Q,u,L,R){x=function(S){function I(){var b=S.apply(this,arguments)||this;b.rasterJobHandler=null;b.datasetName=null;b.datasetFormat=null;b.rasterInfo=null;b.ioConfig={sampling:"closest"};return b}w._inheritsLoose(I,S);var n=I.prototype;n.init=function(){var b=w._asyncToGenerator(function*(){const a=u.load();this.addResolvingPromise(a);yield this.when()});return function(){return b.apply(this,arguments)}}();n.normalizeCtorArgs=function(b){b&&
b.ioConfig&&(b={...b,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:P.create(),...b.ioConfig}});return b};n.open=function(){var b=w._asyncToGenerator(function*(a){throw new N("BaseRaster:open-not-implemented","open() is not implemented");});return function(a){return b.apply(this,arguments)}}();n.fetchTile=function(){var b=w._asyncToGenerator(function*(a,c,g,e={}){var d;const {tileInfo:f}=e;a=f.lodAt(a);c=this.getTileExtent({x:a.resolution,y:a.resolution},c,g,f.origin,f.spatialReference,
f.size);null!=(d=e.multidimensionalDefinition)&&d.length&&y.isSome(this.rasterInfo.multidimensionalInfo)&&null==e.sliceId&&(e={...e,sliceId:this.getSliceIndex(e.multidimensionalDefinition)||0});return this.fetchPixels(c,f.size[0],f.size[1],e)});return function(a,c,g){return b.apply(this,arguments)}}();n.identify=function(){var b=w._asyncToGenerator(function*(a,c={}){const {spatialReference:g,extent:e}=this.rasterInfo;var {datumTransformation:d}=c;d=u.projectPoint(a,g,d);if(!e.intersects(d)||y.isSome(this.rasterInfo.transform)&&
(d=this.rasterInfo.transform.inverseTransform(d),!this.rasterInfo.nativeExtent.intersects(d)))return{location:d,value:null};let f=0;if(c.srcResolution)f=u.snapPyramid(c.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel;else if(f=yield this.computeBestPyramidLevelForLocation(a,c),null==f)return{location:d,value:null};a=this.identifyPixelLocation(d,f,null);if(null===a)return{location:d,value:null};const {row:h,col:l,rowOffset:k,colOffset:m}=a;a=A.getRasterId(this.url,c.sliceId);const p=
`${f}/${h}/${l}`;let v=A.getBlock(a,null,p);y.isSome(v)||(v=this.fetchRawTile(f,h,l,c),A.putBlock(a,null,p,v));c=yield v;if(!(c&&c.pixels&&0<c.pixels.length))return{location:d,value:null};const D=k*this.rasterInfo.storageInfo.blockHeight+m;c=!c.mask||c.mask[D]?c.pixels.map(q=>q[D]):null;return{location:d,value:c,pyramidLevel:f}});return function(a){return b.apply(this,arguments)}}();n.fetchPixels=function(){var b=w._asyncToGenerator(function*(a,c,g,e={}){a=u.snapExtent(a);var d=u.getWorldWrapCount(a),
f=this.rasterInfo.spatialReference,h=!a.spatialReference.equals(f),{datumTransformation:l}=e,k=new L({x:(a.xmax-a.xmin)/c,y:(a.ymax-a.ymin)/g,spatialReference:a.spatialReference});const m=e.srcResolution||(h?u.projectResolution(k,f,a,l):k);if(!m)return null;const {pyramidLevel:p,pyramidResolution:v,excessiveReading:D}=u.snapPyramid(m,this.rasterInfo,this.ioConfig.sampling);if(D)return null;var q=this.rasterInfo.storageInfo;f=h?u.projectExtent(a,f,l):a;const B=y.unwrap(this.rasterInfo.transform);B&&
(f=B.inverseTransform(f));if(null==f)return null;var r=Math.ceil((f.xmax-f.xmin)/v.x-.1),t=Math.ceil((f.ymax-f.ymin)/v.y-.1);if(8<r/c||8<t/g||2<=d)return null;r=yield this.fetchRawPixels(p,{x:Math.floor((f.xmin-q.origin.x)/v.x+.1),y:Math.floor((q.origin.y-f.ymax)/v.y+.1)},{width:r,height:t,wrapCount:d},e);if(!r)return null;t=0<p?q.pyramidBlockWidth:q.blockWidth;q=0<p?q.pyramidBlockHeight:q.blockHeight;if(!h&&1===r.pixelBlocks.length&&t===c&&q===g&&m.x===k.x&&m.y===k.y)return{extent:a,srcExtent:f,
pixelBlock:r.pixelBlocks[0]};d=u.getProjectionOffsetGrid(a,r.extent,k,l,B,0<d);h=!e.requestRawData;l={rows:d.spacing[0],cols:d.spacing[1]};k=y.unwrap(this._getRasterTileAlignmentInfo(p,r.extent.xmin));const {pixelBlocks:E,mosaicSize:F,isPartiallyFilled:J}=r;this.rasterJobHandler?c=yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:E,srcMosaicSize:F,destDimension:h?{width:c,height:g}:null,coefs:h?d.coefficients:null,sampleSpacing:h?l:null,interpolation:e.interpolation,alignmentInfo:k},
e):(r=Q.mosaic(E,F,null,null,k),c=h?Q.approximateTransform(r,{width:c,height:g},d.coefficients,l,e.interpolation):r);return e.requestRawData?{srcExtent:f,pixelBlock:c,transformGrid:d,extent:a,isPartiallyFilled:J}:{srcExtent:f,extent:a,pixelBlock:c}});return function(a,c,g){return b.apply(this,arguments)}}();n.fetchRawPixels=function(){var b=w._asyncToGenerator(function*(a,c,g,e){const {origin:d,blockBoundary:f}=this.rasterInfo.storageInfo,{blockWidth:h,blockHeight:l}=this.getBlockWidthHeight(a);let {x:k,
y:m}=c,{width:p,height:v,wrapCount:D}=g;var q=y.unwrap(this._getRasterTileAlignmentInfo(a,0));e.buffer&&(k-=e.buffer.cols,m-=e.buffer.rows,p+=2*e.buffer.cols,v+=2*e.buffer.rows);c=Math.floor(k/h);g=Math.floor(m/l);const B=Math.floor((k+p-1)/h),r=Math.floor((m+v-1)/l);var t=f[a];if(!t)return null;const {minRow:E,minCol:F,maxCol:J,maxRow:T}=t;if(r<E||B<F||g>T||c>J)return null;t=[];let K,U=!1;for(let G=g;G<=r;G++)for(let H=c;H<=B;H++){const M=0===D||null==q||H<q.worldColumnCountFromOrigin?H:H%q.worldColumnCountFromOrigin-
q.originColumnOffset;G>=E&&M>=F&&T>=G&&J>=M?(K=this._fetchRawTile(a,G,M,e),this.ioConfig.allowPartialFill&&(K=new Promise(V=>{K.then(ia=>V(ia)).catch(()=>{U=!0;V(null)})})),t.push(K)):t.push(null)}if(0===t.length)return null;e=yield Promise.all(t);q={height:(r-g+1)*l,width:(B-c+1)*h};({spatialReference:t}=this.rasterInfo);a=this.getPyramidPixelSize(a);const {x:W,y:X}=a;return{extent:new R({xmin:d.x+c*h*W,xmax:d.x+(B+1)*h*W,ymin:d.y-(r+1)*l*X,ymax:d.y-g*l*X,spatialReference:t}),pixelBlocks:e,mosaicSize:q,
isPartiallyFilled:U}});return function(a,c,g,e){return b.apply(this,arguments)}}();n.fetchRawTile=function(){var b=w._asyncToGenerator(function*(a,c,g,e){throw new N("BaseRaster:read-not-implemented","fetchRawTile() is not implemented");});return function(a,c,g,e){return b.apply(this,arguments)}}();n.computeExtent=function(b){return u.projectExtent(this.rasterInfo.extent,b)};n.decodePixelBlock=function(b,a){return!this.rasterJobHandler||a.useCanvas?ha.decode(b,a):this.rasterJobHandler.decode({data:b,
options:a})};n.request=function(){var b=w._asyncToGenerator(function*(a,c,g){var e,d;const {customFetchParameters:f}=this.ioConfig,{range:h,query:l,headers:k}=c;g=null!=(e=null!=(d=g)?d:c.retryCount)?e:this.ioConfig.retryCount;e=h?{Range:`bytes=${h.from}-${h.to}`}:null;try{return yield Y(a,{...c,query:{...l,...f},headers:{...k,...e}})}catch(m){if(0<g)return g--,this.request(a,c,g);throw m;}});return function(a,c,g){return b.apply(this,arguments)}}();n.getSliceIndex=function(b){const {multidimensionalInfo:a}=
this.rasterInfo;if(!y.isSome(a)||null==b||!b.length)return null;let c=0;const g=b[0].variableName;for(let f=0;f<a.variables.length;f++){var e=a.variables[f];const h=e.dimensions;if(e.name!==g){c+=h.map(k=>this._getDimensionValuesCount(k)).reduce((k,m)=>k+m);break}e=h.map(k=>this._getDimensionValuesCount(k));const l=h.length;for(let k=0;k<l;k++){var d=b.filter(m=>m.dimensionName===h[k].name)[0];if(null==d)return null;d=Array.isArray(d.values[0])?d.values[0][0]:d.values[0];d=this._getIndexFromDimensions(d,
h[k]);if(-1===d)return null;e.shift();c=k===l-1?c+d:c+d*e.reduce((m,p)=>m+p)}}return c};n.updateTileInfo=function(){const {storageInfo:b,spatialReference:a,extent:c,pixelSize:g}=this.rasterInfo;if(!b.tileInfo){const d=[];var e=b.maximumPyramidLevel||0;let f=Math.max(g.x,g.y),h=1/.0254*96*f;for(let l=0;l<=e;l++)d.push({level:e-l,resolution:f,scale:h}),f*=2,h*=2;e=new L({x:c.xmin,y:c.ymax,spatialReference:a});b.tileInfo=new P({origin:e,size:[b.blockWidth,b.blockHeight],spatialReference:a,lods:d});b.isVirtualTileInfo=
!0}};n.createRemoteDatasetStorageInfo=function(b,a=512,c=512,g){const {width:e,height:d,nativeExtent:f,pixelSize:h,spatialReference:l}=b,k=new L({x:f.xmin,y:f.ymax,spatialReference:l});null==g&&(g=Math.max(0,Math.round(Math.log(Math.max(e,d))/Math.LN2-8)));const m=this.computeBlockBoundary(f,512,512,{x:f.xmin,y:f.ymax},[h],g);b.storageInfo=new fa({blockWidth:a,blockHeight:c,pyramidBlockWidth:a,pyramidBlockHeight:c,origin:k,firstPyramidLevel:1,maximumPyramidLevel:g,blockBoundary:m})};n.computeBestPyramidLevelForLocation=
function(){var b=w._asyncToGenerator(function*(a,c){return 0});return function(a){return b.apply(this,arguments)}}();n.computeBlockBoundary=function(b,a,c,g,e,d=0,f=2){if(1===e.length&&0<d){e=[...e];let {x:k,y:m}=e[0];for(let p=0;p<d;p++)k*=f,m*=f,e.push({x:k,y:m})}d=[];const {x:h,y:l}=g;for(g=0;g<e.length;g++){const {x:k,y:m}=e[g];d.push({minCol:Math.floor((b.xmin-h+.1*k)/a/k),maxCol:Math.floor((b.xmax-h-.1*k)/a/k),minRow:Math.floor((l-b.ymax+.1*m)/c/m),maxRow:Math.floor((l-b.ymin-.1*m)/c/m)})}return d};
n.getPyramidPixelSize=function(b){const {nativePixelSize:a}=this.rasterInfo,{pyramidResolutions:c,pyramidScalingFactor:g}=this.rasterInfo.storageInfo;if(0===b)return a;if(y.isSome(c)&&c.length)return c[b-1];b=g**b;return{x:a.x*b,y:a.y*b}};n.identifyPixelLocation=function(b,a,c){const {spatialReference:g,nativeExtent:e}=this.rasterInfo,{blockWidth:d,blockHeight:f,maximumPyramidLevel:h,origin:l}=this.rasterInfo.storageInfo;b=u.projectPoint(b,g,c);if(!e.intersects(b)||0>a||a>h)return null;c=this.getPyramidPixelSize(a);
const {x:k,y:m}=c;c=(l.y-b.y)/m/f;const p=(b.x-l.x)/k/d;return{pyramidLevel:a,row:Math.floor(c),col:Math.floor(p),rowOffset:Math.min(f-1,Math.floor((c-Math.floor(c))*f)),colOffset:Math.min(d-1,Math.floor((p-Math.floor(p))*d)),srcLocation:b}};n.getTileExtent=function(b,a,c,g,e,d){const [f,h]=d;c=g.x+c*f*b.x;a=g.y-a*h*b.y;return new R({xmin:c,xmax:c+f*b.x,ymin:a-h*b.y,ymax:a,spatialReference:e})};n.getBlockWidthHeight=function(b){return{blockWidth:0<b?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,
blockHeight:0<b?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}};n.isBlockOutside=function(b,a,c){b=this.rasterInfo.storageInfo.blockBoundary[b];return!b||b.maxRow<a||b.maxCol<c||b.minRow>a||b.minCol>c};n._fetchRawTile=function(b,a,c,g){var e=this.rasterInfo.storageInfo.blockBoundary[b];if(!e)return Promise.resolve(null);const {minRow:d,minCol:f,maxCol:h,maxRow:l}=e;if(a<d||c<f||a>l||c>h)return Promise.resolve(null);const k=A.getRasterId(this.url,g.sliceId),
m=`${b}/${a}/${c}`;e=A.getBlock(k,g.registryId,m);if(!y.isSome(e)){const p=O.createAbortController();e=this.fetchRawTile(b,a,c,{...g,signal:p.signal});A.putBlock(k,g.registryId,m,e,p);e.catch(()=>{A.deleteBlock(k,g.registryId,m)})}if(g.signal)O.onAbort(g,()=>{A.decreaseRefCount(k,g.registryId,m)});return e};n._getIndexFromDimensions=function(b,a){const {extent:c,interval:g,unit:e,values:d}=a;if(null!=d&&d.length)return Array.isArray(d[0])?d.findIndex(k=>k[0]<=b&&k[1]>=b):d.indexOf(b);if(b>c[1])return-1;
const f=c[0];let h=-1;if("ISO8601"===e){var l;switch((null==(l=a.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case "seconds":h=Math.round((b-f)/1E3/g);break;case "minutes":h=Math.round((b-f)/6E4/g);break;case "hours":h=Math.round((b-f)/36E5/g);break;case "days":h=Math.round((b-f)/864E5/g);break;case "years":h=Math.round(((new Date(b)).getUTCFullYear()-(new Date(f)).getUTCFullYear())/g);break;case "decades":h=Math.round(((new Date(b)).getUTCFullYear()-(new Date(f)).getUTCFullYear())/10/g)}return h}return Math.round((b-
f)/g)};n._getDimensionValuesCount=function(b){const {extent:a,interval:c,unit:g,values:e}=b;let d=(null==e?void 0:e.length)||0;if(d)return d;const f=a[0];if(0===d&&"ISO8601"===g){var h;switch((null==(h=b.intervalUnit)?void 0:h.toLowerCase())||"seconds"){case "seconds":d=Math.round((a[1]-a[0])/1E3/c);break;case "minutes":d=Math.round((a[1]-a[0])/6E4/c);break;case "hours":d=Math.round((a[1]-a[0])/36E5/c);break;case "days":d=Math.round((a[1]-a[0])/864E5/c);break;case "years":d=Math.round(((new Date(a[1])).getUTCFullYear()-
(new Date(f)).getUTCFullYear())/c);break;case "decades":d=Math.round(((new Date(a[1])).getUTCFullYear()-(new Date(f)).getUTCFullYear())/10/c)}return d}return Math.round((a[1]-a[0])/c)};n._getRasterTileAlignmentInfo=function(b,a){null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=u.getRasterDatasetAlignmentInfo(this.rasterInfo));return y.isSome(this._rasterTileAlighmentInfo.pyramidsInfo)?{startX:a,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform,
...this._rasterTileAlighmentInfo.pyramidsInfo[b]}:null};w._createClass(I,[{key:"url",set:function(b){this._set("url",da.sanitizeUrl(b,aa.getLogger(this.declaredClass)))}}]);return I}(ba.EsriPromiseMixin(Z.JSONSupport));z.__decorate([C.property()],x.prototype,"_rasterTileAlighmentInfo",void 0);z.__decorate([C.property(ea.url)],x.prototype,"url",null);z.__decorate([C.property({type:String,json:{write:!0}})],x.prototype,"datasetName",void 0);z.__decorate([C.property({type:String,json:{write:!0}})],x.prototype,
"datasetFormat",void 0);z.__decorate([C.property()],x.prototype,"rasterInfo",void 0);z.__decorate([C.property()],x.prototype,"ioConfig",void 0);z.__decorate([C.property()],x.prototype,"sourceJSON",void 0);return x=z.__decorate([ca.subclass("esri.layers.support.rasterDatasets.BaseRaster")],x)});