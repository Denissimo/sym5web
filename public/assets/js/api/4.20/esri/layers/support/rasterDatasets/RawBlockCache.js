// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../geometry ../../../core/maybe ./EphemeralBlockCache ../rasterFunctions/rasterProjectionHelper ../../../geometry/Point".split(" "),function(h,J,E,F,w,G){function H(a,b){if(!e.has(a))return null;a=e.get(a);return null==a[b]?null:a[b]}const e=new Map,m=new F;h.decreaseRefCount=function(a,b,c){if(!e.has(a))return null==b?m.decreaseRefCount(a,c):0;const d=e.get(a);if(null==d[b])return m.decreaseRefCount(a,c);b=d[b].cache;if(b.has(c)){a=b.get(c);a.refCount--;if(0===a.refCount){b.delete(c);
for(b=0;b<d.length;b++)d[b]&&d[b].cache.has(c)&&d[b].cache.delete(c);a.controller&&a.controller.abort()}return a.refCount}return 0};h.deleteBlock=function(a,b,c){if(e.has(a)){var d=e.get(a);null==d[b]?m.deleteBlock(a,c):d[b].cache.delete(c)}else null==b&&m.deleteBlock(a,c)};h.deleteRaster=function(a){e.delete(a)};h.getBlock=function(a,b,c){if(!e.has(a))return null==b?m.getBlock(a,c):null;var d=e.get(a);if(null==d[b]){for(b=0;b<d.length;b++)if(d[b]&&d[b].cache.has(c))return c=d[b].cache.get(c),c.refCount++,
c.block;return m.getBlock(a,c)}a=d[b].cache;if(a.has(c))return c=a.get(c),c.refCount++,c.block;for(let f=0;f<d.length;f++)if(f!==b&&d[f]&&d[f]&&d[f].cache.has(c))return d=d[f].cache.get(c),d.refCount++,a.set(c,d),d.block;return null};h.getRasterId=function(a,b){return null==b?a:`${a}?sliceId=${b}`};h.putBlock=function(a,b,c,d,f=null){if(e.has(a)){var u=e.get(a);if(null==u[b])m.putBlock(a,c,d,f);else{var q={refCount:1,block:d,isResolved:!1,isRejected:!1,controller:f};d.then(()=>q.isResolved=!0).catch(()=>
q.isRejected=!0);u[b].cache.set(c,q)}}else null==b&&m.putBlock(a,c,d,f)};h.register=function(a,b){b={extent:null,rasterInfo:b,cache:new Map};if(e.has(a))return a=e.get(a),a.push(b),a.length-1;e.set(a,[b]);return 0};h.unregister=function(a,b){if(e.has(a)){const c=e.get(a);c[b]=null;c.some(d=>null!=d)||e.delete(a)}};h.update=function(a,b,c,d,f,u,q=null){a=H(a,b);b=a.extent;const {cache:x,rasterInfo:y}=a;if(!b||b.xmin!==c.xmin||b.xmax!==c.xmax||b.ymin!==c.ymin||b.ymax!==c.ymax){b=c.clone().normalize();
var {spatialReference:z,transform:A}=y,B=new Set;for(let n=0;n<b.length;n++){var g=b[n];if(g.xmax-g.xmin<=d||g.ymax-g.ymin<=d)continue;var k=w.projectExtent(g,z,q);E.isSome(A)&&(k=A.inverseTransform(k));var r=new G({x:d,y:d,spatialReference:g.spatialReference});if(null==f&&(f=w.projectResolution(r,z,g,q),!f))return;const {pyramidLevel:p,pyramidResolution:v,excessiveReading:I}=w.snapPyramid(f,y,u||"closest");if(I)return;({storageInfo:g}=y);var {origin:l}=g;r=Math.max(0,Math.floor((k.xmin-l.x)/v.x));
l=Math.max(0,Math.floor((l.y-k.ymax)/v.y));const C=0<p?g.pyramidBlockWidth:g.blockWidth,D=0<p?g.pyramidBlockHeight:g.blockHeight;g=Math.max(0,Math.floor(r/C)-1);var t=Math.max(0,Math.floor(l/D)-1);r=Math.floor((r+Math.ceil((k.xmax-k.xmin)/v.x-.1)-1)/C)+1;k=Math.floor((l+Math.ceil((k.ymax-k.ymin)/v.y-.1)-1)/D)+1;for(l=t;l<=k;l++)for(t=g;t<=r;t++)B.add(`${p}/${l}/${t}`)}x.forEach((n,p)=>{B.has(p)||(n=x.get(p),(null==n||n.isResolved||n.isRejected)&&x.delete(p))});a.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,
ymax:c.ymax}}};Object.defineProperty(h,"__esModule",{value:!0})});