// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../core/maybe ../../geometry/Extent ../../geometry/Point ../../geometry/projectionEllipsoid ../../geometry/SpatialReference ../../geometry/support/WKIDUnitConversion ./TileInfo".split(" "),function(y,I,J,C,D,K,L,A,M){function q(b,a){for(let d=0;d<a.childNodes.length;d++){const e=a.childNodes[d];if(e.nodeType===Node.ELEMENT_NODE&&e.nodeName===b)return e}return null}function v(b,a){const d=[];for(let e=0;e<a.childNodes.length;e++){const c=a.childNodes[e];c.nodeType===
Node.ELEMENT_NODE&&c.nodeName===b&&d.push(c)}return d}function w(b,a){const d=[];for(let e=0;e<a.childNodes.length;e++){const c=a.childNodes[e];c.nodeType===Node.ELEMENT_NODE&&c.nodeName===b&&d.push(c)}return d.map(e=>e.textContent)}function n(b,a){b.split("\x3e").forEach(d=>{a&&(a=q(d,a))});return a&&a.textContent}function x(b,a,d,e){let c;Array.prototype.slice.call(e.childNodes).some(f=>{if(-1<f.nodeName.indexOf(b)){var h=q(a,f);h=h&&h.textContent;if(h===d||d.split(":")&&d.split(":")[1]===h)return c=
f,!0}return!1});return c}function E(b,a){var d;const e=[];var c=null==(d=b.layerMap)?void 0:d.get(a);if(c){d=v("ResourceURL",c);c=v("Dimension",c);if(c.length){var f=n("Identifier",c[0]);var h=w("Default",c[0])||w("Value",c[0])}if(1<c.length){var g=n("Identifier",c[1]);var p=w("Default",c[1])||w("Value",c[1])}b.dimensionMap.set(a,{dimensions:h,dimensions2:p});d.forEach(l=>{let k=l.getAttribute("template");if("tile"===l.getAttribute("resourceType")){if(f&&h.length)if(-1<k.indexOf("{"+f+"}"))k=k.replace("{"+
f+"}","{dimensionValue}");else{var m=k.toLowerCase().indexOf("{"+f.toLowerCase()+"}");-1<m&&(k=k.substring(0,m)+"{dimensionValue}"+k.substring(m+f.length+2))}g&&p.length&&(-1<k.indexOf("{"+g+"}")?k=k.replace("{"+g+"}","{dimensionValue2}"):(m=k.toLowerCase().indexOf("{"+g.toLowerCase()+"}"),-1<m&&(k=k.substring(0,m)+"{dimensionValue2}"+k.substring(m+g.length+2))));e.push({template:k,format:l.getAttribute("format"),resourceType:"tile"})}});return e}}function N(b,a){return v("Style",b).map(d=>{var e=
q("LegendURL",d),c=q("Keywords",d);c=c&&w("Keyword",c);e=e&&e.getAttribute("xlink:href");a&&(e=e&&e.replace(/^http:/i,"https:"));return{abstract:n("Abstract",d),id:n("Identifier",d),isDefault:"true"===d.getAttribute("isDefault"),keywords:c,legendUrl:e,title:n("Title",d)}})}function O(b,a,d){return v("TileMatrixSetLink",a).map(e=>q("TileMatrixSet",e).textContent).map(e=>P(b,e,a,d))}function P(b,a,d,e){d=x("TileMatrixSetLink","TileMatrixSet",a,d);d=w("TileMatrix",d);const c=e.find(l=>{l=(l=q("Identifier",
l))&&l.textContent;return l===a||a.split(":")&&a.split(":")[1]===l?!0:!1});e=Q(c);const f=e.spatialReference,h=f.wkid;var g=q("TileMatrix",c);g=[parseInt(n("TileWidth",g),10),parseInt(n("TileHeight",g),10)];const p=[];d.length?d.forEach((l,k)=>{l=x("TileMatrix","Identifier",l,c);p.push(F(l,h,k,a))}):v("TileMatrix",c).forEach((l,k)=>{p.push(F(l,h,k,a))});b=R(b,c,e,g,p[0]);return{id:a,fullExtent:b.toJSON(),tileInfo:(new M({dpi:96,spatialReference:f,size:g,origin:e,lods:p})).toJSON()}}function Q(b){let a=
n("SupportedCRS",b);a&&(a=a.toLowerCase());let d=parseInt(a.split(":").pop(),10);if(900913===d||3857===d)d=102100;var e=S(a);J.isSome(e)&&(d=e);e=new L({wkid:d});b=q("TileMatrix",b);var c=n("TopLeftCorner",b).split(" ");b=c[0].split("E").map(f=>Number(f));c=c[1].split("E").map(f=>Number(f));b=1<b.length?b[0]*10**b[1]:b[0];c=1<c.length?c[0]*10**c[1]:c[0];return a.includes("epsg")&&G(d)?new D(c,b,e):new D(b,c,e)}function R(b,a,d,e,c){var f=q("BoundingBox",a);if(f){var h=n("LowerCorner",f).split(" ");
var g=n("UpperCorner",f).split(" ")}h&&1<h.length&&g&&1<g.length?(a=parseFloat(h[0]),e=parseFloat(h[1]),h=parseFloat(g[0]),g=parseFloat(g[1])):(a=q("TileMatrix",a),h=parseFloat(n("MatrixWidth",a)),f=parseFloat(n("MatrixHeight",a)),a=d.x,g=d.y,h=a+h*e[0]*c.resolution,e=g-f*e[1]*c.resolution);return"1.0.0"===b&&G(d.spatialReference.wkid)?new C(e,a,g,h,d.spatialReference):new C(a,e,h,g,d.spatialReference)}function G(b){return T.some(([a,d])=>b>=a&&b<=d)}function S(b){return b.includes("crs84")||b.includes("crs:84")?
4326:b.includes("crs83")||b.includes("crs:83")?4269:b.includes("crs27")||b.includes("crs:27")?4267:null}function F(b,a,d,e){const c=n("Identifier",b);b=n("ScaleDenominator",b).split("E").map(f=>Number(f));b=1<b.length?b[0]*10**b[1]:b[0];a=H(a,b,e);return{level:d,levelValue:c,scale:1.058267716535433*b,resolution:a}}function H(b,a,d){b=A.hasOwnProperty(String(b))?A.values[A[b]]:"default028mm"===d?6370997*Math.PI/180:K.getReferenceEllipsoidFromWKID(b).metersPerDegree;return 7*a/25E3/b}const T=[[3819,
3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,4558],[4600,4646],[4657,4765],[4801,4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],[5354,5354],[5360,5360],[5365,5365],[5370,5373],[5381,5381],[5393,
5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3389,3390],[3416,3417],[3833,3841],[3844,
3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]];y.getTileUrlFromResourceUrls=
function(b,a,d,e,c,f,h,g){var {dimensionMap:p}=b;b=E(b,a);const l=p.get(a).dimensions&&p.get(a).dimensions[0];a=p.get(a).dimensions2&&p.get(a).dimensions2[0];p="";if(b&&0<b.length){let k=null;b.some(m=>m.format===e?(k=m,!0):!1);k||(k=b[h%b.length]);p=k.template.replace(/\{Style\}/gi,c).replace(/\{TileMatrixSet\}/gi,d).replace(/\{TileMatrix\}/gi,f).replace(/\{TileRow\}/gi,""+h).replace(/\{TileCol\}/gi,""+g).replace(/\{dimensionValue\}/gi,l).replace(/\{dimensionValue2\}/gi,a)}return p};y.getTileUrlTemplateFromResourceUrls=
function(b,a,d,e){const {dimensionMap:c}=b;b=E(b,a);let f="";if(b&&0<b.length){const h=c.get(a).dimensions&&c.get(a).dimensions[0];a=c.get(a).dimensions2&&c.get(a).dimensions2[0];f=b[0].template;f.indexOf(".xxx")===f.length-4&&(f=f.slice(0,f.length-4));f=f.replace(/\{Style\}/gi,e);f=f.replace(/\{TileMatrixSet\}/gi,d);f=f.replace(/\{TileMatrix\}/gi,"{level}");f=f.replace(/\{TileRow\}/gi,"{row}");f=f.replace(/\{TileCol\}/gi,"{col}");f=f.replace(/\{dimensionValue\}/gi,h);f=f.replace(/\{dimensionValue2\}/gi,
a)}return f};y.parseCapabilities=function(b,a){var d,e;b=b.replace(/ows:/gi,"");var c=(new DOMParser).parseFromString(b,"text/xml").documentElement;const f=new Map;b=new Map;var h=q("Contents",c);if(!h)throw new I("wmtslayer:wmts-capabilities-xml-is-not-valid");var g=q("OperationsMetadata",c);g=null==g?void 0:g.querySelector("[name\x3d'GetTile']");g=(g=null==g?void 0:g.getElementsByTagName("Get"))&&Array.prototype.slice.call(g);const p=null!=(d=-1<(null==a?void 0:null==(e=a.url)?void 0:e.indexOf("https")))?
d:!1;let l=a.serviceMode,k,m=a&&a.url,B;g&&g.length&&g.some(r=>{const t=q("Constraint",r);if(!t||x("AllowedValues","Value",l,t))return m=r.attributes[0].nodeValue,!0;if(!t||x("AllowedValues","Value","RESTful",t)||x("AllowedValues","Value","REST",t))B=r.attributes[0].nodeValue;else if(!t||x("AllowedValues","Value","KVP",t))k=r.attributes[0].nodeValue;return!1});m||(B?(m=B,l="RESTful"):k?(m=k,l="KVP"):m=(a=q("ServiceMetadataURL",c))&&a.getAttribute("xlink:href"));a=m.indexOf("1.0.0/");-1===a&&"RESTful"===
l?m+="/":-1<a&&(m=m.substring(0,a));"KVP"===l&&(m+=-1<a?"":"?");p&&(m=m.replace(/^http:/i,"https:"));const U=n("ServiceIdentification\x3eServiceTypeVersion",c);c=n("ServiceIdentification\x3eAccessConstraints",c);a=v("Layer",h);const V=v("TileMatrixSet",h);h=a.map(r=>{var t=n("Identifier",r);f.set(t,r);{const W=n("Abstract",r),X=w("Format",r);var u=q("WGS84BoundingBox",r);var z=u?n("LowerCorner",u).split(" "):["-180","-90"];u=u?n("UpperCorner",u).split(" "):["180","90"];z={xmin:parseFloat(z[0]),ymin:parseFloat(z[1]),
xmax:parseFloat(u[0]),ymax:parseFloat(u[1]),spatialReference:{wkid:4326}};u=N(r,p);const Y=n("Title",r);r=O(U,r,V);t={id:t,fullExtent:z,description:W,formats:X,styles:u,title:Y,tileMatrixSets:r}}return t});return{copyright:c,layers:h,tileUrl:m,serviceMode:l,layerMap:f,dimensionMap:b}};y.parseResourceInfo=function(b){b.layers.forEach(a=>{a.tileMatrixSets.forEach(d=>{const e=d.tileInfo;96!==e.dpi&&(e.lods.forEach(c=>{c.scale=96*c.scale/e.dpi;c.resolution=H(e.spatialReference.wkid,90.71428571428571*
c.scale/96,d.id)}),e.dpi=96)})});return b};Object.defineProperty(y,"__esModule",{value:!0})});