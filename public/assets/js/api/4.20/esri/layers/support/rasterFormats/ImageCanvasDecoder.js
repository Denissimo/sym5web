// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["../../../core/Error","../../../core/promiseUtils","../../../chunks/Zlib"],function(u,v,z){return function(){function n(b){b&&(this.canvas=b.canvas,this.ctx=b.ctx||b.canvas&&b.canvas.getContext("2d"))}n.prototype.decode=function(b,g,m){if(!b||10>b.byteLength)throw new u("imagecanvasdecoder: decode","required a valid encoded data as input.");let {width:c,height:d,format:k}=g;const {applyJpegMask:w}=g;if(w&&(!c||!d))throw new u("imagecanvasdecoder: decode","image width and height are needed to apply jpeg mask directly to canvas");
return new Promise((x,y)=>{let h=null;"jpg"===k&&w&&(h=n.getMask(b,{width:c,height:d}));const A=new Blob([new Uint8Array(b)],{type:"jpg"==="image/"+k?"jpeg":k}),p=URL.createObjectURL(A),l=new Image;let e;l.src=p;l.onload=()=>{URL.revokeObjectURL(p);if(v.isAborted(m))y(v.createAbortError());else{c=l.width;d=l.height;if(this.canvas){if(this.canvas.width!==c||this.canvas.height!==d)this.canvas.width=c,this.canvas.height=d;this.ctx.clearRect(0,0,c,d)}else this.canvas=document.createElement("canvas"),
this.canvas.width=c,this.canvas.height=d,this.ctx=this.canvas.getContext("2d");this.ctx.drawImage(l,0,0);var f=this.ctx.getImageData(0,0,c,d);e=f.data;var a;if(g.renderOnCanvas){if(h)for(a=0;a<h.length;a++)e[4*a+3]=h[a]?255:0;this.ctx.putImageData(f,0,0);x(null)}else{f=c*d;var q=new Uint8Array(f),r=new Uint8Array(f),t=new Uint8Array(f);if(h)for(a=0;a<f;a++)q[a]=e[4*a],r[a]=e[4*a+1],t[a]=e[4*a+2];else for(h=new Uint8Array(f),a=0;a<f;a++)q[a]=e[4*a],r[a]=e[4*a+1],t[a]=e[4*a+2],h[a]=e[4*a+3];x({width:c,
height:d,pixels:[q,r,t],mask:h,pixelType:"u8"})}}};l.onerror=()=>{URL.revokeObjectURL(p);y("cannot load image")}})};n.getMask=function(b,g){let m=null;try{var c=new Uint8Array(b);b=0;var d=c.length-2;for(b=Math.ceil(c.length/2);b<d&&(255!==c[b]||217!==c[b+1]);b++);b+=2;if(b<c.length-1){const k=(new z.Zlib(c.subarray(b))).getBytes();m=new Uint8Array(g.width*g.height);g=0;for(c=0;c<k.length;c++)for(d=7;0<=d;d--)m[g++]=k[c]>>d&1}}catch(k){}return m};return n}()});