// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../kernel ../../request ../../core/maybe ../../core/promiseUtils ../FeatureLayer ../../portal/Portal ../../portal/PortalItem".split(" "),function(n,e,u,l,g,m,p,v,w){let x=function(){function q(c,a,b,d){this.parsedUrl=c;this.portalItem=a;this.apiKey=b;this.signal=d;this.rootDocument=null;if(c=this.parsedUrl.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i))this.urlParts={root:c[1],layerId:parseInt(c[2],10)}}var f=q.prototype;f.fetch=function(){var c=
e._asyncToGenerator(function*(){var a;if(!this.urlParts)return null;const b=null!=(a=this.portalItem)?a:yield this.portalItemFromServiceItemId();if(g.isNone(b))return this.loadFromUrl();a=yield this.findAndLoadRelatedPortalItem(b);return g.isNone(a)?null:this.loadFeatureLayerFromPortalItem(a)});return function(){return c.apply(this,arguments)}}();f.fetchPortalItem=function(){var c=e._asyncToGenerator(function*(){var a;if(!this.urlParts)return null;const b=null!=(a=this.portalItem)?a:yield this.portalItemFromServiceItemId();
return g.isNone(b)?null:this.findAndLoadRelatedPortalItem(b)});return function(){return c.apply(this,arguments)}}();f.fetchRootDocument=function(){var c=e._asyncToGenerator(function*(){if(g.isSome(this.rootDocument))return this.rootDocument;if(g.isNone(this.urlParts))return this.rootDocument={},{};const a={query:{f:"json",token:this.apiKey},responseType:"json",signal:this.signal},b=`${this.urlParts.root}/SceneServer`;try{this.rootDocument=(yield l(b,a)).data}catch{this.rootDocument={}}return this.rootDocument});
return function(){return c.apply(this,arguments)}}();f.fetchServiceOwningPortalUrl=function(){var c=e._asyncToGenerator(function*(){var a;const b=null==(a=u.id)?void 0:a.findServerInfo(this.parsedUrl.path);if(null!=b&&b.owningSystemUrl)return b.owningSystemUrl;a=this.parsedUrl.path.replace(/(.*\/rest)\/.*/i,"$1")+"/info";try{const d=(yield l(a,{query:{f:"json"},responseType:"json",signal:this.signal})).data.owningSystemUrl;if(d)return d}catch(d){m.throwIfAbortError(d)}return null});return function(){return c.apply(this,
arguments)}}();f.findAndLoadRelatedPortalItem=function(){var c=e._asyncToGenerator(function*(a){try{return(yield a.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:this.signal})).find(b=>"Feature Service"===b.type)||null}catch(b){return m.throwIfAbortError(b),null}});return function(a){return c.apply(this,arguments)}}();f.loadFeatureLayerFromPortalItem=function(){var c=e._asyncToGenerator(function*(a){yield a.load({signal:this.signal});const b=yield this.findMatchingAssociatedSublayerUrl(a.url);
return(new p({url:b,portalItem:a})).load({signal:this.signal})});return function(a){return c.apply(this,arguments)}}();f.loadFromUrl=function(){var c=e._asyncToGenerator(function*(){const a=yield this.findMatchingAssociatedSublayerUrl(`${this.urlParts.root}/FeatureServer`);return(new p({url:a})).load({signal:this.signal})});return function(){return c.apply(this,arguments)}}();f.findMatchingAssociatedSublayerUrl=function(){var c=e._asyncToGenerator(function*(a){a=a.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,
"$1");var b={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal};const d=this.urlParts.layerId;var h=this.fetchRootDocument();b=l(a,b);const [r,t]=yield Promise.all([b,h]);h=t&&t.layers;b=r.data&&r.data.layers;if(!Array.isArray(b))throw Error("expected layers array");if(!Array.isArray(h)){if(d<b.length)return`${a}/${b[d].id}`}else for(let k=0;k<Math.min(h.length,b.length);k++)if(h[k].id===d)return`${a}/${b[k].id}`;throw Error("could not find matching associated sublayer");
});return function(a){return c.apply(this,arguments)}}();f.portalItemFromServiceItemId=function(){var c=e._asyncToGenerator(function*(){var a=(yield this.fetchRootDocument()).serviceItemId;if(!a)return null;a=new w({id:a,apiKey:this.apiKey});const b=yield this.fetchServiceOwningPortalUrl();g.isSome(b)&&(a.portal=new v({url:b}));try{return a.load({signal:this.signal})}catch(d){return m.throwIfAbortError(d),null}});return function(){return c.apply(this,arguments)}}();return q}();n.FetchAssociatedFeatureLayer=
x;Object.defineProperty(n,"__esModule",{value:!0})});