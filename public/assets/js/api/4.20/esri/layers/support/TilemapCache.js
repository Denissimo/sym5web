// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/Accessor ../../core/Error ../../core/Handles ../../core/Logger ../../core/LRUCache ../../core/PooledArray ../../core/promiseUtils ../../core/scheduling ../../core/urlUtils ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/decorators/cast ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ./Tilemap".split(" "),function(f,
x,n,B,C,y,D,E,F,G,r,H,I,J,u,N,K,O,L,v){var p;const M=E.getLogger("esri.layers.support.TilemapCache");f.TilemapCache=p=function(A){function w(a){a=A.call(this,a)||this;a._handles=new D;a._pendingTilemapRequests={};a._availableLevels={};a.levels=5;a.cacheByteSize=2097152;a.request=B;a._prefetchingEnabled=!0;return a}x._inheritsLoose(w,A);var g=w.prototype;g.initialize=function(){this._tilemapCache=new F(this.cacheByteSize);this._handles.add([this.watch(["layer.parsedUrl","layer.tileServers?"],()=>this._initializeTilemapDefinition()),
J.init(this,"layer.tileInfo.lods",a=>this._initializeAvailableLevels(a),!0)]);this._initializeTilemapDefinition()};g.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null)};g.castLevels=function(a){return 2>=a?(M.error("Minimum levels for Tilemap is 3, but got ",a),3):a};g.fetchTilemap=function(a,c,d,b){if(!this._availableLevels[a])return Promise.reject(new y("tilemap-cache:level-unavailable",`Level ${a} is unavailable in the service`));const e=this._tmpTilemapDefinition;if(a=
this._tilemapFromCache(a,c,d,e))return Promise.resolve(a);const m=b&&b.signal;b={...b,signal:null};return new Promise((q,k)=>{r.onAbort(m,()=>k(r.createAbortError()));const h=v.tilemapDefinitionId(e);let l=this._pendingTilemapRequests[h];if(!l){l=v.Tilemap.fromDefinition(e,b).then(z=>{this._tilemapCache.put(h,z,z.byteSize);return z});const t=()=>delete this._pendingTilemapRequests[h];this._pendingTilemapRequests[h]=l;l.then(t,t)}l.then(q,k)})};g.getAvailability=function(a,c,d){return this._availableLevels[a]?
(a=this._tilemapFromCache(a,c,d,this._tmpTilemapDefinition))?a.getAvailability(c,d):"unknown":"unavailable"};g.getAvailabilityUpsample=function(a,c,d,b){b.level=a;b.row=c;b.col=d;a=this.layer.tileInfo;for(a.updateTileInfo(b);;)if(c=this.getAvailability(b.level,b.row,b.col),"unavailable"===c){if(!a.upsampleTile(b))return"unavailable"}else return c};g.fetchAvailability=function(a,c,d,b){return this._availableLevels[a]?this.fetchTilemap(a,c,d,b).catch(e=>e).then(e=>{if(e instanceof v.Tilemap)return e=
e.getAvailability(c,d),"unavailable"===e?Promise.reject(new y("tile-map:tile-unavailable","Tile is not available",{level:a,row:c,col:d})):e;if(r.isAbortError(e))throw e;return"unknown"}):Promise.reject(new y("tilemap-cache:level-unavailable",`Level ${a} is unavailable in the service`))};g.fetchAvailabilityUpsample=function(a,c,d,b,e){b.level=a;b.row=c;b.col=d;const m=this.layer.tileInfo;m.updateTileInfo(b);const q=this.fetchAvailability(a,c,d,e).catch(k=>{if(r.isAbortError(k))throw k;if(m.upsampleTile(b))return this.fetchAvailabilityUpsample(b.level,
b.row,b.col,b);throw k;});this._fetchAvailabilityUpsamplePrefetch(b.id,a,c,d,e,q);return q};g._fetchAvailabilityUpsamplePrefetch=function(){var a=x._asyncToGenerator(function*(c,d,b,e,m,q){if(this._prefetchingEnabled){var k=`prefetch-${c}`;if(!this._handles.has(k)){var h=r.createAbortController();q.then(()=>h.abort(),()=>h.abort());var l=!1;this._handles.add({remove(){l||(l=!0,h.abort())}},k);yield H.waitTicks(10,h.signal).catch(()=>{});l||(l=!0,this._handles.remove(k));if(!r.isAborted(h))for(c={id:c,
level:d,row:b,col:e},m={...m,signal:h.signal},d=this.layer.tileInfo,b=0;p._prefetches.length<p._maxPrefetch&&d.upsampleTile(c);++b){const t=this.fetchAvailability(c.level,c.row,c.col,m);p._prefetches.push(t);e=()=>{p._prefetches.removeUnordered(t)};t.then(e,e)}}}});return function(c,d,b,e,m,q){return a.apply(this,arguments)}}();g._initializeTilemapDefinition=function(){if(this.layer.parsedUrl){var a=this.layer.parsedUrl,c=a.query;this._tilemapCache.clear();this._tmpTilemapDefinition={service:{url:a.path,
query:c?I.objectToQuery(c):null,tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}};g._tilemapFromCache=function(a,c,d,b){b.level=a;b.row=c-c%this.size;b.col=d-d%this.size;a=v.tilemapDefinitionId(b);return this._tilemapCache.get(a)};g._initializeAvailableLevels=function(a){this._availableLevels={};a&&a.forEach(c=>this._availableLevels[c.level]=!0)};x._createClass(w,[{key:"size",get:function(){return 1<<this.levels}},
{key:"test",get:function(){const a=this;return{get prefetchingEnabled(){return a._prefetchingEnabled},set prefetchingEnabled(c){a._prefetchingEnabled=c},hasTilemap(c,d,b){return!!a._tilemapFromCache(c,d,b,a._tmpTilemapDefinition)}}}}]);return w}(C);f.TilemapCache._maxPrefetch=4;f.TilemapCache._prefetches=new G({initialSize:p._maxPrefetch});n.__decorate([u.property({constructOnly:!0,type:Number})],f.TilemapCache.prototype,"levels",void 0);n.__decorate([K.cast("levels")],f.TilemapCache.prototype,"castLevels",
null);n.__decorate([u.property({readOnly:!0,type:Number})],f.TilemapCache.prototype,"size",null);n.__decorate([u.property({constructOnly:!0,type:Number})],f.TilemapCache.prototype,"cacheByteSize",void 0);n.__decorate([u.property({constructOnly:!0})],f.TilemapCache.prototype,"layer",void 0);n.__decorate([u.property({constructOnly:!0})],f.TilemapCache.prototype,"request",void 0);f.TilemapCache=p=n.__decorate([L.subclass("esri.layers.support.TilemapCache")],f.TilemapCache);Object.defineProperty(f,"__esModule",
{value:!0})});