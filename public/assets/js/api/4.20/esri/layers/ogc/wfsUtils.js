// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../geometry ../../request ../../core/Error ../../core/interatorUtils ../../core/maybe ../../core/promiseUtils ../../core/urlUtils ../../geometry/projection ../../geometry/support/spatialReferenceUtils ../../geometry/support/typeUtils ../graphics/sources/geojson/geojson ./dateUtils ./xmlUtils ../support/Field ../../geometry/SpatialReference ../../geometry/Extent".split(" "),function(m,n,ma,u,l,A,v,W,w,L,x,X,Y,Z,p,t,M,aa){function B(){B=n._asyncToGenerator(function*(a,
b){b=yield u(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetCapabilities",VERSION:"2.0.0",...null==b?void 0:b.customParameters},signal:null==b?void 0:b.signal});b=N(b.data);w.isHTTPSProtocol(a)&&(w.hasSameOrigin(a,b.operations.DescribeFeatureType.url,!0)&&(b.operations.DescribeFeatureType.url=w.toHTTPS(b.operations.DescribeFeatureType.url)),w.hasSameOrigin(a,b.operations.GetFeature.url,!0)&&(b.operations.GetFeature.url=w.toHTTPS(b.operations.GetFeature.url)));return b});return B.apply(this,
arguments)}function N(a){a=C(a);ba(a);D(a);const b=a.firstElementChild,c=new Map;return{operations:ca(b),get featureTypes(){return Array.from(O(b,c))},readFeatureTypes:()=>O(b,c)}}function ca(a){let b=!1;const c={GetCapabilities:{url:""},DescribeFeatureType:{url:""},GetFeature:{url:"",outputFormat:null,supportsPagination:!1}};p.visitXML(a,{OperationsMetadata:{Operation:d=>{switch(d.getAttribute("name")){case "GetCapabilities":return{DCP:{HTTP:{Get:e=>{c.GetCapabilities.url=e.getAttribute("xlink:href")}}}};
case "DescribeFeatureType":return{DCP:{HTTP:{Get:e=>{c.DescribeFeatureType.url=e.getAttribute("xlink:href")}}}};case "GetFeature":return{DCP:{HTTP:{Get:e=>{c.GetFeature.url=e.getAttribute("xlink:href")}}},Parameter:e=>{if("outputFormat"===e.getAttribute("name"))return{AllowedValues:{Value:g=>{g=g.textContent;da.has(g.toLowerCase())&&(c.GetFeature.outputFormat=g)}}}}}}},Constraint:d=>{switch(d.getAttribute("name")){case "KVPEncoding":return{DefaultValue:e=>{b="true"===e.textContent.toLowerCase()}};
case "ImplementsResultPaging":return{DefaultValue:e=>{c.GetFeature.supportsPagination="true"===e.textContent.toLowerCase()}}}}}});if(!b)throw new l("wfs-layer:kvp-encoding-not-supported","WFS service doesn't support key/value pair (KVP) encoding");if(v.isNone(c.GetFeature.outputFormat))throw new l("wfs-layer:geojson-not-supported","WFS service doesn't support GeoJSON output format");return c}function O(a,b){return p.iterateXML(a,{FeatureTypeList:{FeatureType:c=>{if(b.has(c))return b.get(c);const d=
{typeName:"undefined:undefined",name:"",title:"",description:"",extent:null,namespacePrefix:"",namespaceUri:"",supportedSpatialReferences:[]},e=new Set([4326]),g=f=>{var h,k;f=parseInt(null==(h=f.textContent.match(n._wrapRegExp(/([0-9]+$)/i,{wkid:1})))?void 0:null==(k=h.groups)?void 0:k.wkid,10);Number.isNaN(f)||e.add(f)};p.visitXML(c,{Name:f=>{const {name:h,prefix:k}=y(f.textContent);d.typeName=`${k}:${h}`;d.name=h;d.namespacePrefix=k;d.namespaceUri=f.lookupNamespaceURI(k)},Abstract:f=>{d.description=
f.textContent},Title:f=>{d.title=f.textContent},WGS84BoundingBox:f=>{d.extent=ea(f)},DefaultSRS:g,DefaultCRS:g,OtherSRS:g,OtherCRS:g});d.title||(d.title=d.name);d.supportedSpatialReferences.push(...e);b.set(c,d);return d}}})}function ea(a){let b,c,d,e;for(const g of a.children)switch(g.localName){case "LowerCorner":[b,c]=g.textContent.split(" ").map(f=>Number.parseFloat(f));break;case "UpperCorner":[d,e]=g.textContent.split(" ").map(f=>Number.parseFloat(f))}return{xmin:b,ymin:c,xmax:d,ymax:e,spatialReference:x.WGS84}}
function P(a,b,c){return A.find(a,d=>c?d.name===b&&d.namespaceUri===c:d.typeName===b||d.name===b)}function E(){E=n._asyncToGenerator(function*(a,b,c,d={}){var e;const {featureType:g,extent:f}=yield Q(a,b,c,d),{fields:h,geometryType:k,swapXY:z,objectIdField:r,geometryField:q}=yield fa(a,g.typeName,d);return{url:a.operations.GetCapabilities.url,name:g.name,namespaceUri:g.namespaceUri,fields:h,geometryField:q,geometryType:k,objectIdField:r,spatialReference:null!=(e=d.spatialReference)?e:M.WGS84,extent:f,
swapXY:z,wfsCapabilities:a,customParameters:d.customParameters}});return E.apply(this,arguments)}function Q(a,b,c){return F.apply(this,arguments)}function F(){F=n._asyncToGenerator(function*(a,b,c,d={}){const {spatialReference:e=M.WGS84}=d;a=a.readFeatureTypes();c=b?P(a,b,c):a.next().value;if(v.isNone(c)){if(b)throw new l("wfs-layer:feature-type-not-found",`The type '${b}' could not be found in the service`);throw new l("wfs-layer:empty-service","The service is empty");}b=new aa({...c.extent,spatialReference:e});
if(!x.equals(e,x.WGS84))try{yield L.initializeProjection(x.WGS84,e,void 0,d),b=L.project(b,x.WGS84)}catch{throw new l("wfs-layer:unsupported-spatial-reference","Projection not supported");}return{extent:b,spatialReference:e,featureType:c}});return F.apply(this,arguments)}function fa(a,b){return G.apply(this,arguments)}function G(){G=n._asyncToGenerator(function*(a,b,c={}){const [d,e]=yield W.eachAlways([R(a.operations.DescribeFeatureType.url,b,c),ha(a,b,c)]);if(d.error||e.error)throw new l("wfs-layer:getWFSLayerTypeInfo-error",
`An error occurred while getting info about the feature type '${b}'`,{error:d.error||e.error});const {fields:g,errors:f}=d.value;a=d.value.geometryType||e.value.geometryType;c=e.value.swapXY;if(v.isNone(a))throw new l("wfs-layer:unknown-geometry-type",`The geometry type could not be determined for type '${b}`,{typeName:b,geometryType:a,fields:g,errors:f});return{...S(g),geometryType:a,swapXY:c}});return G.apply(this,arguments)}function S(a){var b;const c=a.find(e=>"geometry"===e.type);let d=a.find(e=>
"oid"===e.type);a=a.filter(e=>"geometry"!==e.type);d||(d=new t({name:"__esri_wfs_id__",type:"oid",alias:"__esri_wfs_id__"}),a.unshift(d));return{geometryField:null!=(b=null==c?void 0:c.name)?b:null,objectIdField:d.name,fields:a}}function ha(a,b){return H.apply(this,arguments)}function H(){H=n._asyncToGenerator(function*(a,b,c={}){var d;let e,g=!1;const [f,h]=yield Promise.all([T(a.operations.GetFeature.url,b,a.operations.GetFeature.outputFormat,{...c,count:1}),u(a.operations.GetFeature.url,{responseType:"text",
query:U(b,void 0,{...c,count:1}),signal:null==c?void 0:c.signal})]);if(a="FeatureCollection"===f.type&&(null==(d=f.features[0])?void 0:d.geometry)){e=X.featureGeometryTypeKebabDictionary.fromJSON(Y.getGeometryType(a.type));switch(a.type){case "Point":var k=a.coordinates;break;case "LineString":case "MultiPoint":k=a.coordinates[0];break;case "MultiLineString":case "Polygon":k=a.coordinates[0][0];break;case "MultiPolygon":k=a.coordinates[0][0][0]}if(a=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(h.data))d=
k[0].toFixed(3),k=k[1].toFixed(3),b=parseFloat(a[1]).toFixed(3),a=parseFloat(a[2]).toFixed(3),d===a&&k===b&&(g=!0)}return{geometryType:e,swapXY:g}});return H.apply(this,arguments)}function R(a,b,c){return I.apply(this,arguments)}function I(){I=n._asyncToGenerator(function*(a,b,c){a=yield u(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:"2.0.0",TYPENAME:b,...null==c?void 0:c.customParameters},signal:null==c?void 0:c.signal});return V(b,a.data)});return I.apply(this,
arguments)}function V(a,b){const {name:c}=y(a);b=C(b);D(b);const d=A.find(p.iterateXML(b.firstElementChild,{element:e=>({name:e.getAttribute("name"),typeName:y(e.getAttribute("type")).name})}),({name:e})=>e===c);if(v.isSome(d)){const e=A.find(p.iterateXML(b.firstElementChild,{complexType:g=>g}),g=>g.getAttribute("name")===d.typeName);if(v.isSome(e))return ia(e)}throw new l("wfs-layer:feature-type-not-found",`Type '${a}' not found in document`,{document:(new XMLSerializer).serializeToString(b)});}
function ia(a){var b,c;const d=[],e=[];let g;var f=p.iterateXML(a,{complexContent:{extension:{sequence:{element:h=>h}}}});for(const h of f){f=h.getAttribute("name");if(!f)continue;let k,z;h.hasAttribute("type")?k=y(h.getAttribute("type")).name:p.visitXML(h,{simpleType:{restriction:ja=>{k=y(ja.getAttribute("base")).name;return{maxLength:ka=>{z=+ka.getAttribute("value")}}}}});if(!k)continue;const r="true"===h.getAttribute("nillable");let q=!1;switch(k.toLowerCase()){case "integer":case "nonpositiveinteger":case "negativeinteger":case "long":case "int":case "short":case "byte":case "nonnegativeinteger":case "unsignedlong":case "unsignedint":case "unsignedshort":case "unsignedbyte":case "positiveinteger":e.push(new t({name:f,
alias:f,type:"integer",nullable:r}));break;case "float":case "double":case "decimal":e.push(new t({name:f,alias:f,type:"double",nullable:r}));break;case "boolean":case "string":case "gyearmonth":case "gyear":case "gmonthday":case "gday":case "gmonth":case "anyuri":case "qname":case "notation":case "normalizedstring":case "token":case "language":case "idrefs":case "entities":case "nmtoken":case "nmtokens":case "name":case "ncname":case "id":case "idref":case "entity":case "duration":case "time":e.push(new t({name:f,
alias:f,type:"string",nullable:r,length:null!=(b=z)?b:255}));break;case "datetime":case "date":e.push(new t({name:f,alias:f,type:"date",nullable:r,length:null!=(c=z)?c:36}));break;case "pointpropertytype":g="point";q=!0;break;case "multipointpropertytype":g="multipoint";q=!0;break;case "curvepropertytype":case "multicurvepropertytype":case "multilinestringpropertytype":g="polyline";q=!0;break;case "surfacepropertytype":case "multisurfacepropertytype":case "multipolygonpropertytype":g="polygon";q=
!0;break;case "geometrypropertytype":case "multigeometrypropertytype":q=!0;d.push(new l("wfs-layer:unknown-geometry-type",`geometry type '${k}' is not supported`,{type:(new XMLSerializer).serializeToString(a)}));break;default:d.push(new l("wfs-layer:unknown-field-type",`Unknown field type '${k}'`,{type:(new XMLSerializer).serializeToString(a)}))}q&&e.push(new t({name:f,alias:f,type:"geometry",nullable:r}))}for(const h of e)if("integer"===h.type&&!h.nullable&&la.has(h.name.toLowerCase())){h.type="oid";
break}return{geometryType:g,fields:e,errors:d}}function T(a,b,c,d){return J.apply(this,arguments)}function J(){J=n._asyncToGenerator(function*(a,b,c,d){({data:a}=yield u(a,{responseType:"text",query:U(b,c,d),signal:null==d?void 0:d.signal}));a=a.replace(/": +(-?\d+),(\d+)(,)?/g,'": $1.$2$3');try{var e;if(null!=d&&null!=(e=d.dateFields)&&e.length){const g=new Set(d.dateFields);return JSON.parse(a,(f,h)=>g.has(f)?Z.parseDate(h):h)}return JSON.parse(a)}catch(g){throw new l("wfs-layer:malformed-json",
"Error while parsing the\u00a0response",{response:a,error:g});}});return J.apply(this,arguments)}function U(a,b,c){return{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:"2.0.0",TYPENAMES:a,OUTPUTFORMAT:b,SRSNAME:"EPSG:4326",STARTINDEX:null==c?void 0:c.startIndex,COUNT:null==c?void 0:c.count,...null==c?void 0:c.customParameters}}function K(){K=n._asyncToGenerator(function*(a,b,c){a=yield u(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:"2.0.0",TYPENAMES:b,RESULTTYPE:"hits",...null==
c?void 0:c.customParameters},signal:null==c?void 0:c.signal});a=C(a.data);D(a);a=Number.parseFloat(a.firstElementChild.getAttribute("numberMatched"));return Number.isNaN(a)?0:a});return K.apply(this,arguments)}function C(a){return(new DOMParser).parseFromString(a.trim(),"text/xml")}function y(a){const [b,c]=a.split(":");return{prefix:c?b:"",name:null!=c?c:b}}function ba(a){if((a=a.firstElementChild.getAttribute("version"))&&"2.0.0"!==a)throw new l("wfs-layer:unsupported-wfs-version",`Unsupported WFS version ${a}. Supported version: ${"2.0.0"}`);
}function D(a){let b,c;p.visitXML(a.firstElementChild,{Exception:d=>{b=d.getAttribute("exceptionCode");return{ExceptionText:e=>{c=e.textContent}}}});if(b)throw new l(`wfs-layer:${b}`,c);}const da=new Set(["json","application/json","geojson","application/json; subtype\x3dgeojson"]),la=new Set(["objectid","fid"]);m.WFS_OID_FIELD_NAME="__esri_wfs_id__";m.describeFeatureType=R;m.findFeatureType=P;m.getCapabilities=function(a,b){return B.apply(this,arguments)};m.getFeature=T;m.getFeatureCount=function(a,
b,c){return K.apply(this,arguments)};m.getFeatureTypeInfo=Q;m.getWFSLayerInfo=function(a,b,c){return E.apply(this,arguments)};m.parseDescribeFeatureTypeResponse=V;m.parseGetCapabilitiesResponse=N;m.prepareWFSLayerFields=S;Object.defineProperty(m,"__esModule",{value:!0})});