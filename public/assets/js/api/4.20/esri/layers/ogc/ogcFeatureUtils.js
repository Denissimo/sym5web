// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../geometry ../../request ../../core/Error ../../core/Logger ../../core/maybe ../../geometry/support/spatialReferenceUtils ../../geometry/support/webMercatorUtils ../graphics/featureConversionUtils ../graphics/OptimizedFeatureSet ../graphics/sources/geojson/geojson ../graphics/sources/support/clientSideDefaults ../support/FieldsIndex ../support/fieldType ../../rest/support/FeatureSet ../../geometry/SpatialReference".split(" "),function(m,n,
oa,u,p,W,l,O,P,A,X,B,Y,Z,aa,ba,r){function C(){C=n._asyncToGenerator(function*(a,b,c={},f=5){({links:a}=a);a=q(a,"items","application/geo+json")||q(a,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(l.isNone(a))throw new p("ogc-feature-layer:missing-items-page","Missing items url");({data:c}=yield u(a.href,{signal:c.signal,query:{limit:f,...c.customParameters,token:c.apiKey},headers:{accept:"application/geo+json"}}));yield B.validateGeoJSON(c);const e=B.inferLayerProperties(c,
{geometryType:b.geometryType});c=b.fields||e.fields||[];f=null!=b.hasZ?b.hasZ:e.hasZ;a=e.geometryType;const t=b.objectIdField||e.objectIdFieldName||"OBJECTID";b=b.timeInfo;var g=c.find(w=>w.name===t);if(g)g.type="esriFieldTypeOID",g.editable=!1,g.nullable=!1;else{if(!e.objectIdFieldType)throw new p("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");c.unshift({name:t,alias:t,type:"esriFieldTypeOID",editable:!1,nullable:!1})}t!==e.objectIdFieldName&&
(g=c.find(w=>w.name===e.objectIdFieldName))&&(g.type="esriFieldTypeInteger");if(!a)throw new p("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");c===e.fields&&0<e.unknownFields.length&&y.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:e.unknownFields}});for(var d of c){null==d.name&&(d.name=d.alias);null==d.alias&&(d.alias=d.name);
"esriFieldTypeOID"!==d.type&&"esriFieldTypeGlobalID"!==d.type&&(d.editable=null==d.editable?!0:!!d.editable,d.nullable=null==d.nullable?!0:!!d.nullable);if(!d.name)throw new p("ogc-feature-layer:invalid-field-name","field name is missing",{field:d});if(-1===aa.kebabDict.jsonValues.indexOf(d.type))throw new p("ogc-feature-layer:invalid-field-type",`invalid type for field "${d.name}"`,{field:d});}b&&(d=new Z(c),b.startTimeField&&((g=d.get(b.startTimeField))?(b.startTimeField=g.name,g.type="esriFieldTypeDate"):
b.startTimeField=null),b.endTimeField&&((g=d.get(b.endTimeField))?(b.endTimeField=g.name,g.type="esriFieldTypeDate"):b.endTimeField=null),b.trackIdField&&((d=d.get(b.trackIdField))?b.trackIdField=d.name:(b.trackIdField=null,y.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:b}}))),b.startTimeField||b.endTimeField||(y.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:b}}),
b=null));return{drawingInfo:Y.createDrawingInfo(a),geometryType:a,fields:c,hasZ:!!f,objectIdField:t,timeInfo:b}});return C.apply(this,arguments)}function D(){D=n._asyncToGenerator(function*(a,b={}){({links:a}=a);a=q(a,"data","application/json")||q(a,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(l.isNone(a))throw new p("ogc-feature-layer:missing-collections-page","Missing collections url");const {apiKey:c,customParameters:f,signal:e}=b;({data:b}=yield u(a.href,{signal:e,headers:{accept:"application/json"},
query:{...f,token:c}}));return b});return D.apply(this,arguments)}function E(){E=n._asyncToGenerator(function*(a,b={}){({links:a}=a);a=q(a,"conformance","application/json")||q(a,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(l.isNone(a))throw new p("ogc-feature-layer:missing-conformance-page","Missing conformance url");const {apiKey:c,customParameters:f,signal:e}=b;({data:b}=yield u(a.href,{signal:e,headers:{accept:"application/json"},query:{...f,token:c}}));return b});
return E.apply(this,arguments)}function F(){F=n._asyncToGenerator(function*(a,b={}){const {apiKey:c,customParameters:f,signal:e}=b;({data:a}=yield u(a,{signal:e,headers:{accept:"application/json"},query:{...f,token:c}}));return a});return F.apply(this,arguments)}function G(){G=n._asyncToGenerator(function*(a,b={}){a=q(a.links,"service-desc","application/vnd.oai.openapi+json;version\x3d3.0");if(l.isNone(a))return y.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),
null;const {apiKey:c,customParameters:f,signal:e}=b;({data:b}=yield u(a.href,{signal:e,headers:{accept:"application/vnd.oai.openapi+json;version\x3d3.0"},query:{...f,token:c}}));return b});return G.apply(this,arguments)}function Q(a){a=n._wrapRegExp(/^http:\/\/www\.opengis.net\/def\/crs\/(.*)\/(.*)\/(.*)$/i,{authority:1,version:2,code:3}).exec(a);a=null==a?void 0:a.groups;if(!a)return null;const {authority:b,code:c}=a;switch(b.toLowerCase()){case "ogc":switch(c.toLowerCase()){case "crs27":return r.GCS_NAD_1927;
case "crs83":return new r({wkid:4269});case "crs84":case "crs84h":return r.WGS84;default:return null}case "esri":case "epsg":return a=Number.parseInt(c,10),Number.isNaN(a)?null:900913===a?r.WebMercator:new r({wkid:a});default:return null}}function H(){H=n._asyncToGenerator(function*(a,b,c){a=yield R(a,b,c);return ba.fromJSON(a)});return H.apply(this,arguments)}function R(a,b,c){return I.apply(this,arguments)}function I(){I=n._asyncToGenerator(function*(a,b,c){a=yield S(a,b,c);return A.convertToFeatureSet(a)});
return I.apply(this,arguments)}function S(a,b,c){return J.apply(this,arguments)}function J(){J=n._asyncToGenerator(function*(a,b,c){const {capabilities:{query:{maxRecordCount:f}},collection:e,layerDefinition:t,queryParameters:{apiKey:g,customParameters:d},spatialReference:w,supportedCrs:T}=a;({links:a}=e);var v=q(a,"items","application/geo+json")||q(a,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(l.isNone(v))throw new p("ogc-feature-layer:missing-items-page","Missing items url");
const {geometry:ca,num:U,start:K,timeExtent:da,where:ea}=b;if(b.objectIds)throw new p("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");a=r.fromJSON(w);b=l.unwrapOr(b.outSpatialReference,a);a=b.isWGS84?null:V(b,T);var h=fa(ca,T),z=ha(da);const ja=ia(ea);({data:h}=yield u(v.href,{...c,query:{...d,...h,crs:a,datetime:z,query:ja,limit:null!=U?U:null!=K&&void 0!==K?10:f,startindex:K,token:g},headers:{accept:"application/geo+json"}}));c=!1;h.links&&(c=!!h.links.find(ka=>
"next"===ka.rel));!c&&Number.isInteger(h.numberMatched)&&Number.isInteger(h.numberReturned)&&(c=h.numberReturned<h.numberMatched);const {fields:la,globalIdField:ma,hasM:na,hasZ:L,objectIdField:M}=t;v=t.geometryType;h=B.createOptimizedFeatures(h,{geometryType:v,hasZ:L,objectIdField:M});if(!a&&b.isWebMercator)for(var x of h)x.geometry&&(z=A.convertToGeometry(x.geometry,v,L,!1),z.spatialReference=r.WGS84,x.geometry=A.convertFromGeometry(P.project(z,b)));for(var k of h)k.objectId=k.attributes[M];x=a||
!a&&b.isWebMercator?b.toJSON():O.WGS84;k=new X;k.exceededTransferLimit=c;k.features=h;k.fields=la;k.geometryType=v;k.globalIdFieldName=ma;k.hasM=na;k.hasZ=L;k.objectIdFieldName=M;k.spatialReference=x;return k});return J.apply(this,arguments)}function V(a,b){return b.find(c=>{c=Q(c);return O.equals(c,a)})}function N(a){const {xmin:b,ymin:c,xmax:f,ymax:e}=a;return`${b},${c},${f},${e}`}function ha(a){if(l.isNone(a))return null;const {start:b,end:c}=a;return`${l.isSome(b)?b.toISOString():".."}/${l.isSome(c)?
c.toISOString():".."}`}function ia(a){return l.isNone(a)||!a||"1\x3d1"===a?null:a}function fa(a,b){if(!l.isSome(a)||"extent"!==a.type)return null;const {spatialReference:c}=a;return!c||c.isWGS84?{bbox:N(a)}:(b=V(c,b))?{bbox:N(a),"bbox-crs":b}:c.isWebMercator?{bbox:N(P.project(a,r.WGS84))}:null}function q(a,b,c){return a.find(f=>f.rel===b&&f.type===c)||a.find(f=>f.rel===b&&!f.type)}const y=W.getLogger("esri.layers.graphics.sources.ogcfeature");m.getCollectionDefinition=function(a,b){return C.apply(this,
arguments)};m.getServerCollections=function(a){return D.apply(this,arguments)};m.getServerConformance=function(a){return E.apply(this,arguments)};m.getServerLandingPage=function(a){return F.apply(this,arguments)};m.getServerOpenApi=function(a){return G.apply(this,arguments)};m.getSpatialReference=Q;m.queryFeatureSet=function(a,b,c){return H.apply(this,arguments)};m.queryFeatureSetJSON=R;m.queryOptimizedFeatureSet=S;Object.defineProperty(m,"__esModule",{value:!0})});