// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("require exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../kernel ../../request ../../core/asyncUtils ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/urlUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/jsonMap ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../../portal/Portal ../../portal/PortalItem ../../portal/PortalUser".split(" "),
function(z,t,g,h,n,A,B,C,D,u,p,q,r,K,L,M,E,F,G,v,w,H){const I=D.getLogger("esri.layers.mixins.PortalLayer");var x=null,y=null;t.PortalLayer=e=>{e=function(k){function l(){var c=k.apply(this,arguments)||this;c.resourceReferences={portalItem:null,paths:[]};c.userHasEditingPrivileges=!0;return c}g._inheritsLoose(l,k);var f=l.prototype;f.destroy=function(){var c;null==(c=this.portalItem)?void 0:c.destroy();this.portalItem=null};f.readPortalItem=function(c,a,b){if(a.itemId)return new w({id:a.itemId,portal:b&&
b.portal})};f.writePortalItem=function(c,a){c&&c.id&&(a.itemId=c.id)};f.loadFromPortal=function(){var c=g._asyncToGenerator(function*(a,b){if(this.portalItem&&this.portalItem.id)try{const d=yield new Promise(function(m,J){z(["../../portal/support/layersLoader"],m,J)});p.throwIfAborted(b);return yield d.load({instance:this,supportedTypes:a.supportedTypes,validateItem:a.validateItem,supportsData:a.supportsData},b)}catch(d){throw p.isAbortError(d)||I.warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\n  ${d}`),
d;}});return function(a,b){return c.apply(this,arguments)}}();f.finishLoadEditablePortalLayer=function(){var c=g._asyncToGenerator(function*(a){this._set("userHasEditingPrivileges",yield this.fetchUserHasEditingPrivileges(a).catch(b=>{p.throwIfAbortError(b);return!0}))});return function(a){return c.apply(this,arguments)}}();f.fetchUserHasEditingPrivileges=function(){var c=g._asyncToGenerator(function*(a){const b=this.url?null==n.id?void 0:n.id.findCredential(this.url):null;if(!b)return!0;a=x===b?
y:yield this.fetchEditingUser(a);x=b;y=a;return u.isNone(a)||null==a.privileges||a.privileges.includes("features:user:edit")});return function(a){return c.apply(this,arguments)}}();f.fetchEditingUser=function(){var c=g._asyncToGenerator(function*(a){var b,d;const m=null==(b=this.portalItem)?void 0:null==(d=b.portal)?void 0:d.user;if(m)return m;b=n.id.findServerInfo(this.url);if(null==b||!b.owningSystemUrl)return null;b=`${b.owningSystemUrl}/sharing/rest`;if((d=v.getDefault())&&d.loaded&&q.normalize(d.restUrl)===
q.normalize(b))return d.user;b=`${b}/community/self`;a=u.isSome(a)?a.signal:null;a=yield B.result(A(b,{authMode:"no-prompt",query:{f:"json"},signal:a}));return a.ok?H.fromJSON(a.value.data):null});return function(a){return c.apply(this,arguments)}}();f.read=function(c,a){a&&(a.layer=this);k.prototype.read.call(this,c,a)};f.write=function(c,a){const b=a&&a.portal,d=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||v.getDefault());return b&&d&&!q.hasSamePortal(d.restUrl,b.restUrl)?(a.messages&&
a.messages.push(new C("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save the scene, set the layer.portalItem to null or save the scene to the same portal as the item associated with the layer`,{layer:this})),null):k.prototype.write.call(this,c,{...a,layer:this})};g._createClass(l,[{key:"portalItem",set:function(c){c!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",
c))}}]);return l}(e);h.__decorate([r.property({type:w})],e.prototype,"portalItem",null);h.__decorate([E.reader("web-document","portalItem",["itemId"])],e.prototype,"readPortalItem",null);h.__decorate([G.writer("web-document","portalItem",{itemId:{type:String}})],e.prototype,"writePortalItem",null);h.__decorate([r.property()],e.prototype,"resourceReferences",void 0);h.__decorate([r.property({readOnly:!0})],e.prototype,"userHasEditingPrivileges",void 0);return e=h.__decorate([F.subclass("esri.layers.mixins.PortalLayer")],
e)};Object.defineProperty(t,"__esModule",{value:!0})});