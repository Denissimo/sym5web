// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../config ../kernel ../request ../core/Error ../core/Evented ../core/events ../core/global ../core/lang ../core/object ../core/promiseUtils ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/has ../core/Logger ../core/jsonMap ../core/accessorSupport/decorators/subclass ./IdentityForm ./IdentityModal ./OAuthCredential ./OAuthInfo ./ServerInfo".split(" "),function(r,T,B,O,w,I,
y,U,P,V,W,J,G,u,E,Q,ia,ja,ka,da,ea,X,Y,Z,R){const K={},aa=C=>{const F=(new u.Url(C.owningSystemUrl)).host;C=(new u.Url(C.server)).host;const k=/.+\.arcgis\.com$/i;return k.test(F)&&k.test(C)},S=(C,F)=>!!(aa(C)&&F&&F.some(k=>k.test(C.server)));let L=null,M=null;try{L=window.localStorage,M=window.sessionStorage}catch{}Q=function(C){function F(){var a=C.call(this)||this;a._portalConfig=V.esriGeowConfig;a.serverInfos=[];a.oAuthInfos=[];a.credentials=[];a._soReqs=[];a._xoReqs=[];a._portals=[];a.defaultOAuthInfo=
null;a.defaultTokenValidity=60;a.dialog=null;a.formConstructor=ea;a.tokenValidity=null;a.normalizeWebTierAuth=!1;a._appOrigin="null"!==window.origin?window.origin:window.location.origin;a._appUrlObj=u.urlToObject(window.location.href);a._busy=null;a._rejectOnPersistedPageShow=!1;a._oAuthHash=null;a._gwTokenUrl="/sharing/rest/generateToken";a._agsRest="/rest/services";a._agsPortal=/\/sharing(\/|$)/i;a._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i;a._adminSvcs=/\/rest\/admin\/services(\/|$)/i;
a._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,
customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}];a._legacyFed=[];a._regexSDirUrl=/http.+\/rest\/services\/?/gi;a._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|MapServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer)).*/gi;
a._gwUser=/http.+\/users\/([^\/]+)\/?.*/i;a._gwItem=/http.+\/items\/([^\/]+)\/?.*/i;a._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i;a._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i;a._createDefaultOAuthInfo=!0;a._hasTestedIfAppIsOnPortal=!1;a._getOAuthHash();window.addEventListener("pageshow",b=>{a._pageShowHandler(b)});return a}T._inheritsLoose(F,C);var k=F.prototype;k.registerServers=function(a){const b=this.serverInfos;b?(a=a.filter(c=>!this.findServerInfo(c.server)),this.serverInfos=b.concat(a)):
this.serverInfos=a;a.forEach(c=>{c.owningSystemUrl&&this._portals.push(c.owningSystemUrl);c.hasPortal&&this._portals.push(c.server)})};k.registerOAuthInfos=function(a){const b=this.oAuthInfos;if(b){for(const c of a){const d=this.findOAuthInfo(c.portalUrl);d&&b.splice(b.indexOf(d),1)}this.oAuthInfos=b.concat(a)}else this.oAuthInfos=a};k.registerToken=function(a){a={...a};const b=this._sanitizeUrl(a.server),c=this._isServerRsrc(b);let d=this.findServerInfo(b),e=!0,g;d||(d=new R,d.server=this._getServerInstanceRoot(b),
c?d.hasServer=!0:(d.tokenServiceUrl=this._getTokenSvcUrl(b),d.hasPortal=!0),this.registerServers([d]));(g=this._findCredential(b))?(delete a.server,Object.assign(g,a),e=!1):(g=new r.Credential({userId:a.userId,server:d.server,token:a.token,expires:a.expires,ssl:a.ssl,scope:c?"server":"portal"}),g.resources=[b],this.credentials.push(g));g.emitTokenChange(!1);e||g.refreshServerTokens()};k.toJSON=function(){return W.fixJson({serverInfos:this.serverInfos.map(a=>a.toJSON()),oAuthInfos:this.oAuthInfos.map(a=>
a.toJSON()),credentials:this.credentials.map(a=>a.toJSON())})};k.initialize=function(a){if(a){"string"===typeof a&&(a=JSON.parse(a));var b=a.serverInfos,c=a.oAuthInfos;a=a.credentials;if(b){const d=[];b.forEach(e=>{e.server&&e.tokenServiceUrl&&d.push(e.declaredClass?e:new R(e))});d.length&&this.registerServers(d)}if(c){const d=[];c.forEach(e=>{e.appId&&d.push(e.declaredClass?e:new Z(e))});d.length&&this.registerOAuthInfos(d)}a&&a.forEach(d=>{d.server&&d.token&&d.expires&&d.expires>Date.now()&&(d=
d.declaredClass?d:new r.Credential(d),d.emitTokenChange(),this.credentials.push(d))})}};k.findServerInfo=function(a){let b;a=this._sanitizeUrl(a);for(const c of this.serverInfos)if(this._hasSameServerInstance(c.server,a)){b=c;break}return b};k.findOAuthInfo=function(a){let b;a=this._sanitizeUrl(a);for(const c of this.oAuthInfos)if(this._hasSameServerInstance(c.portalUrl,a)){b=c;break}return b};k.findCredential=function(a,b){let c;a=this._sanitizeUrl(a);const d=this._isServerRsrc(a)?"server":"portal";
if(b)for(const e of this.credentials){if(this._hasSameServerInstance(e.server,a)&&b===e.userId&&e.scope===d){c=e;break}}else for(const e of this.credentials)if(this._hasSameServerInstance(e.server,a)&&-1!==this._getIdenticalSvcIdx(a,e)&&e.scope===d){c=e;break}return c};k.getCredential=function(a,b){let c=!0;if(b){var d=!!b.token;var e=b.error;c=!1!==b.prompt}b={...b};a=this._sanitizeUrl(a);const g=G.createAbortController(),l=G.createResolver();if(b.signal)G.onAbort(b.signal,()=>{g.abort()});G.onAbort(g,
()=>{l.reject(new y("identity-manager:user-aborted","ABORTED"))});if(G.isAborted(g))return l.promise;b.signal=g.signal;const n=this._isAdminResource(a);if((d=d?this.findCredential(a):null)&&e&&e.details&&498===e.details.httpStatus)d.destroy();else if(d)return a=new y("identity-manager:not-authorized","You are currently signed in as: '"+d.userId+"'. You do not have access to this resource: "+a,{error:e}),l.reject(a),l.promise;if(e=this._findCredential(a,b))return l.resolve(e),l.promise;let f=this.findServerInfo(a);
if(f)!f.hasServer&&this._isServerRsrc(a)&&(f._restInfoPms=this._getTokenSvcUrl(a),f.hasServer=!0);else{e=this._getTokenSvcUrl(a);if(!e)return a=new y("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),l.reject(a),l.promise;f=new R;f.server=this._getServerInstanceRoot(a);"string"===typeof e?(f.tokenServiceUrl=e,f.hasPortal=!0):(f._restInfoPms=e,f.hasServer=!0);this.registerServers([f])}f.hasPortal&&void 0===f._selfReq&&(c||u.hasSameOrigin(f.tokenServiceUrl,
this._appOrigin)||this._gwDomains.some(h=>h.tokenServiceUrl===f.tokenServiceUrl))&&(f._selfReq={owningTenant:b&&b.owningTenant,selfDfd:this._getPortalSelf(f.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),a)});return this._enqueue(a,f,b,l,n)};k.getResourceName=function(a){return this._isRESTService(a)?a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(a)&&a.replace(this._gwUser,"$1")||this._gwItem.test(a)&&a.replace(this._gwItem,"$1")||
this._gwGroup.test(a)&&a.replace(this._gwGroup,"$1")||""};k.generateToken=function(a,b,c){const d=this._rePortalTokenSvc.test(a.tokenServiceUrl),e=new u.Url(this._appOrigin);var g=a.shortLivedTokenValidity;let l,n,f,h,q,m,x;b&&(x=this.tokenValidity||g||this.defaultTokenValidity,x>g&&0<g&&(x=g));c&&(l=c.isAdmin,n=c.serverUrl,f=c.token,q=c.signal,m=c.ssl,a.customParameters=c.customParameters);l?g=a.adminTokenServiceUrl:(g=a.tokenServiceUrl,h=new u.Url(g.toLowerCase()),a.webTierAuth&&null!=c&&c.serverUrl&&
!m&&"http"===e.scheme&&(u.hasSameOrigin(e.uri,g,!0)||"https"===h.scheme&&e.host===h.host&&"7080"===e.port&&"7443"===h.port)&&(g=g.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));c={query:{request:"getToken",username:null==b?void 0:b.username,password:null==b?void 0:b.password,serverUrl:n,token:f,expiration:x,referer:l||d?this._appOrigin:null,client:l?"referer":null,f:"json",...a.customParameters},method:"post",authMode:"anonymous",useProxy:this._useProxy(a,c),signal:q,...null==c?void 0:c.ioArgs};
d||(c.withCredentials=!1);return I(g,c).then(v=>{v=v.data;if(!v||!v.token)return new y("identity-manager:authentication-failed","Unable to generate token");const p=a.server;K[p]||(K[p]={});b&&(K[p][b.username]=b.password);v.validity=x;return v})};k.isBusy=function(){return!!this._busy};k.checkSignInStatus=function(a){return this.checkAppAccess(a,"").then(b=>b.credential)};k.checkAppAccess=function(a,b,c){let d=!1;return this.getCredential(a,{prompt:!1}).then(e=>{let g;const l={f:"json"};if("portal"===
e.scope)if(b&&(this._doPortalSignIn(a)||c&&c.force))g=e.server+"/sharing/rest/oauth2/validateAppAccess",l.client_id=b;else if(e.token)g=e.server+"/sharing/rest";else return{credential:e};else if(e.token)g=e.server+"/rest/services";else return{credential:e};e.token&&(l.token=e.token);return I(g,{query:l,authMode:"anonymous"}).then(n=>{if(!1===n.data.valid)throw new y("identity-manager:not-authorized",`You are currently signed in as: '${e.userId}'.`,n.data);d=!!n.data.viewOnlyUserTypeApp;return{credential:e}}).catch(n=>
{if("identity-manager:not-authorized"===n.name)throw n;n=n.details&&n.details.httpStatus;if(498===n)throw e.destroy(),new y("identity-manager:not-authenticated","User is not signed in.");if(400===n)throw new y("identity-manager:invalid-request");return{credential:e}})}).then(e=>({credential:e.credential,viewOnly:d}))};k.setOAuthResponseHash=function(a){var b;const c=this._oAuthDfd;this._oAuthDfd=null;if(c&&a)if(clearInterval(this._oAuthIntervalId),null==(b=this._oAuthOnHashHandle)?void 0:b.remove(),
"#"===a.charAt(0)&&(a=a.substring(1)),a=u.queryToObject(a),a.error)b="access_denied"===a.error,a=new y(b?"identity-manager:user-aborted":"identity-manager:authentication-failed",b?"ABORTED":"OAuth: "+a.error+" - "+a.error_description),c.reject(a);else{b=c.oinfo_;const d=b._oAuthCred,e=new r.Credential({userId:a.username,server:c.sinfo_.server,token:a.access_token,expires:Date.now()+1E3*Number(a.expires_in),ssl:"true"===a.ssl,_oAuthCred:d});b.userId=e.userId;d.storage=a.persist?L:M;d.token=e.token;
d.expires=e.expires;d.userId=e.userId;d.ssl=e.ssl;d.save();c.resolve(e)}};k.setOAuthRedirectionHandler=function(a){this._oAuthRedirectFunc=a};k.setProtocolErrorHandler=function(a){this._protocolFunc=a};k.signIn=function(a,b,c={}){const d=G.createResolver(),e=()=>{var q,m,x,v,p;null==(q=n)?void 0:q.remove();null==(m=f)?void 0:m.remove();null==(x=h)?void 0:x.remove();null==(v=l)?void 0:v.destroy();null==(p=this.dialog)?void 0:p.destroy();this.dialog=l=n=f=h=null},g=()=>{e();this._oAuthDfd=null;d.reject(new y("identity-manager:user-aborted",
"ABORTED"))};if(c.signal)G.onAbort(c.signal,()=>{g()});let l=new this.formConstructor;l.resource=this.getResourceName(a);l.server=b.server;this.dialog=new X;this.dialog.content=l;this.dialog.open=!0;this.emit("dialog-create");let n=l.on("cancel",g),f=this.dialog.watch("open",g),h=l.on("submit",q=>{this.generateToken(b,q,{isAdmin:c.isAdmin,signal:c.signal}).then(m=>{e();m=new r.Credential({userId:q.username,server:b.server,token:m.token,expires:null!=m.expires?Number(m.expires):null,ssl:!!m.ssl,isAdmin:c.isAdmin,
validity:m.validity});d.resolve(m)}).catch(m=>{l.error=m;l.signingIn=!1})});return d.promise};k.oAuthSignIn=function(a,b,c,d){const e=this._oAuthDfd=G.createResolver();if(null!=d&&d.signal)G.onAbort(d.signal,()=>{const m=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;m&&!m.closed?m.close():this.dialog&&l()});e.resUrl_=a;e.sinfo_=b;e.oinfo_=c;d=!d||!1!==d.oAuthPopupConfirmation;if(!c.popup||!d)return this._doOAuthSignIn(a,b,c),e.promise;const g=new this.formConstructor;g.oAuthPrompt=!0;g.server=b.server;
this.dialog=new X;this.dialog.content=g;this.dialog.open=!0;this.emit("dialog-create");const l=()=>{q();this._oAuthDfd=null;e.reject(new y("identity-manager:user-aborted","ABORTED"))},n=g.on("cancel",l),f=this.dialog.watch("open",l),h=g.on("submit",()=>{q();this._doOAuthSignIn(a,b,c)}),q=()=>{n.remove();f.remove();h.remove();g.destroy();this.dialog.destroy();this.dialog=null};return e.promise};k.destroyCredentials=function(){this.credentials&&this.credentials.slice().forEach(a=>{a.destroy()});this.emit("credentials-destroy")};
k.enablePostMessageAuth=function(a="https://www.arcgis.com/sharing/rest"){this._postMessageAuthHandle&&this._postMessageAuthHandle.remove();this._postMessageAuthHandle=P.on(window,"message",b=>{var c;if((b.origin===this._appOrigin||b.origin.endsWith(".arcgis.com"))&&"arcgis:auth:requestCredential"===(null==(c=b.data)?void 0:c.type)){const d=b.source;this.getCredential(a).then(e=>{d.postMessage({type:"arcgis:auth:credential",credential:{expires:e.expires,server:e.server,ssl:e.ssl,token:e.token,userId:e.userId}},
b.origin)}).catch(e=>{d.postMessage({type:"arcgis:auth:error",error:{name:e.name,message:e.message}},b.origin)})}})};k.disablePostMessageAuth=function(){this._postMessageAuthHandle&&(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)};k._getOAuthHash=function(){var a=window.location.hash;if(a){"#"===a.charAt(0)&&(a=a.substring(1));a=u.queryToObject(a);let b=!1;if(a.access_token&&a.expires_in&&a.state&&a.hasOwnProperty("username"))try{a.state=JSON.parse(a.state),"object"===typeof a.state&&
a.state.portalUrl&&(this._oAuthHash=a,b=!0)}catch{}else a.error&&a.error_description&&(console.log("IdentityManager OAuth Error: ",a.error," - ",a.error_description),"access_denied"===a.error&&(b=!0));b&&(window.location.hash="object"===typeof a.state&&a.state.hash||"")}};k._pageShowHandler=function(a){a.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow&&(a=new y("identity-manager:user-aborted","ABORTED"),this._errbackFunc(a))};k._findCredential=function(a,b){let c=-1,d,e,g;const l=b&&b.token;
b=b&&b.resource;const n=this._isServerRsrc(a)?"server":"portal",f=this.credentials.filter(h=>this._hasSameServerInstance(h.server,a)&&h.scope===n);a=b||a;if(f.length)if(1===f.length)if(b=f[0],e=(d=(g=this.findServerInfo(b.server))&&g.owningSystemUrl)&&this.findCredential(d,b.userId),c=this._getIdenticalSvcIdx(a,b),l)-1!==c&&(b.resources.splice(c,1),this._removeResource(a,e));else return-1===c&&b.resources.push(a),this._addResource(a,e),b;else{let h,q;f.some(m=>{q=this._getIdenticalSvcIdx(a,m);return-1!==
q?(h=m,e=(d=(g=this.findServerInfo(h.server))&&g.owningSystemUrl)&&this.findCredential(d,h.userId),c=q,!0):!1});if(l)h&&(h.resources.splice(c,1),this._removeResource(a,e));else if(h)return this._addResource(a,e),h}};k._findOAuthInfo=function(a){let b=this.findOAuthInfo(a);if(!b)for(const c of this.oAuthInfos)if(this._isIdProvider(c.portalUrl,a)){b=c;break}return b};k._addResource=function(a,b){b&&-1===this._getIdenticalSvcIdx(a,b)&&b.resources.push(a)};k._removeResource=function(a,b){let c=-1;b&&
(c=this._getIdenticalSvcIdx(a,b),-1<c&&b.resources.splice(c,1))};k._useProxy=function(a,b){return b&&b.isAdmin&&!u.hasSameOrigin(a.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(a.tokenServiceUrl)&&"10.1"===String(a.currentVersion)&&!u.hasSameOrigin(a.tokenServiceUrl,this._appOrigin)};k._getOrigin=function(a){a=new u.Url(a);return a.scheme+"://"+a.host+(null!=a.port?":"+a.port:"")};k._getServerInstanceRoot=function(a){const b=a.toLowerCase();let c=b.indexOf(this._agsRest);-1===c&&this._isAdminResource(a)&&
(c=this._agsAdmin.test(a)?a.replace(this._agsAdmin,"$1").length:a.search(this._adminSvcs));-1===c&&(c=b.indexOf("/sharing"));-1===c&&"/"===b.substr(-1)&&(c=b.length-1);return-1<c?a.substring(0,c):a};k._hasSameServerInstance=function(a,b){"/"===a.substr(-1)&&(a=a.slice(0,-1));a=a.toLowerCase();b=this._getServerInstanceRoot(b).toLowerCase();a=this._normalizeAGOLorgDomain(a);b=this._normalizeAGOLorgDomain(b);a=a.substr(a.indexOf(":"));b=b.substr(b.indexOf(":"));return a===b};k._normalizeAGOLorgDomain=
function(a){const b=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,c=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,d=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;b.test(a)?a=a.replace(b,"https://www.arcgis.com"):c.test(a)?a=a.replace(c,"https://devext.arcgis.com"):d.test(a)&&(a=a.replace(d,"https://qaext.arcgis.com"));return a};k._sanitizeUrl=function(a){const b=(O.request.proxyUrl||"").toLowerCase(),c=b?a.toLowerCase().indexOf(b+"?"):-1;-1!==c&&(a=a.substring(c+b.length+
1));a=u.normalize(a);return u.urlToObject(a).path};k._isRESTService=function(a){return-1<a.indexOf(this._agsRest)};k._isAdminResource=function(a){return this._agsAdmin.test(a)||this._adminSvcs.test(a)};k._isServerRsrc=function(a){return this._isRESTService(a)||this._isAdminResource(a)};k._isIdenticalService=function(a,b){if(this._isRESTService(a)&&this._isRESTService(b)){a=this._getSuffix(a).toLowerCase();b=this._getSuffix(b).toLowerCase();var c=a===b;c||(c=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi,
c=a.replace(c,"$1")===b.replace(c,"$1"))}else this._isAdminResource(a)&&this._isAdminResource(b)?c=!0:this._isServerRsrc(a)||this._isServerRsrc(b)||!this._isPortalDomain(a)||(c=!0);return c};k._isPortalDomain=function(a){const b=new u.Url(a.toLowerCase());a=this._portalConfig;let c=this._gwDomains.some(d=>d.regex.test(b.uri));!c&&a&&(c=this._hasSameServerInstance(this._getServerInstanceRoot(a.restBaseUrl),b.uri));c||O.portalUrl&&(c=u.hasSameOrigin(b,O.portalUrl,!0));c||(c=this._portals.some(d=>this._hasSameServerInstance(d,
b.uri)));return c=c||this._agsPortal.test(b.path)};k._isIdProvider=function(a,b){let c=-1,d=-1;this._gwDomains.forEach((g,l)=>{-1===c&&g.regex.test(a)&&(c=l);-1===d&&g.regex.test(b)&&(d=l)});let e=!1;if(-1<c&&-1<d)if(0===c||4===c){if(0===d||4===d)e=!0}else if(1===c){if(1===d||2===d)e=!0}else 2===c?2===d&&(e=!0):3===c&&3===d&&(e=!0);if(!e){const g=this.findServerInfo(b),l=g&&g.owningSystemUrl;l&&aa(g)&&this._isPortalDomain(l)&&this._isIdProvider(a,l)&&(e=!0)}return e};k._getIdenticalSvcIdx=function(a,
b){let c=-1;for(let d=0;d<b.resources.length;d++)if(this._isIdenticalService(a,b.resources[d])){c=d;break}return c};k._getSuffix=function(a){return a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")};k._getTokenSvcUrl=function(a){if(this._isRESTService(a)||this._isAdminResource(a)){var b=this._getServerInstanceRoot(a);var c=b+"/admin/generateToken";a=b+"/rest/info";b=I(a,{query:{f:"json"}}).then(d=>d.data);return{adminUrl:c,promise:b}}if(this._isPortalDomain(a)){let d="";this._gwDomains.some(e=>
{e.regex.test(a)&&(d=e.tokenServiceUrl);return!!d});d||this._portals.some(e=>{this._hasSameServerInstance(e,a)&&(d=e+this._gwTokenUrl);return!!d});d||(c=a.toLowerCase().indexOf("/sharing"),-1!==c&&(d=a.substring(0,c)+this._gwTokenUrl));d||(d=this._getOrigin(a)+this._gwTokenUrl);d&&(c=(new u.Url(a)).port,/^http:\/\//i.test(a)&&"7080"===c&&(d=d.replace(/:7080/i,":7443")),d=d.replace(/http:/i,"https:"));return d}if(-1!==a.toLowerCase().indexOf("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"};
k._exchangeToken=function(a,b,c){return I(`${a}/sharing/rest/oauth2/exchangeToken`,{authMode:"anonymous",method:"post",query:{f:"json",client_id:b,token:c}}).then(d=>d.data.token)};k._getPlatformSelf=function(a,b){return I(`${a}/sharing/rest/oauth2/platformSelf`,{authMode:"anonymous",headers:{"X-Esri-Auth-Client-Id":b,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},method:"post",query:{f:"json"},withCredentials:!0}).then(c=>c.data)};k._getPortalSelf=function(a,b){let c;this._gwDomains.some(d=>
{d.regex.test(a)&&(c=d.customBaseUrl);return!!c});if(c)return Promise.resolve({allSSL:!0,currentVersion:"4.4",customBaseUrl:c,portalMode:"multitenant",supportsOAuth:!0});this._appOrigin.startsWith("https:")?a=a.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(b)&&(a=a.replace(/^https:/i,"http:").replace(/:7443/i,":7080"));return I(a,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then(d=>d.data)};k._doPortalSignIn=function(a){const b=this._portalConfig,c=window.location.href,
d=this.findServerInfo(a);return(b||this._isPortalDomain(c))&&(d?d.hasPortal||d.owningSystemUrl&&this._isPortalDomain(d.owningSystemUrl):this._isPortalDomain(a))&&(this._isIdProvider(c,a)||b&&(this._hasSameServerInstance(this._getServerInstanceRoot(b.restBaseUrl),a)||this._isIdProvider(b.restBaseUrl,a))||u.hasSameOrigin(c,a,!0))?!0:!1};k._checkProtocol=function(a,b,c,d){let e=!0;d=d?b.adminTokenServiceUrl:b.tokenServiceUrl;d.trim().toLowerCase().startsWith("https:")&&!this._appOrigin.startsWith("https:")&&
u.getProxyRule(d)&&(e=this._protocolFunc?!!this._protocolFunc({resourceUrl:a,serverInfo:b}):!1,e||(a=new y("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection."),c(a)));return e};k._enqueue=function(a,b,c,d,e,g){d||(d=G.createResolver());d.resUrl_=a;d.sinfo_=b;d.options_=c;d.admin_=e;d.refresh_=g;this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(a),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),
this._soReqs.push(d)):this._xoReqs.push(d):this._doSignIn(d);return d.promise};k._doSignIn=function(a){this._busy=a;this._rejectOnPersistedPageShow=!1;const b=f=>{var h=a.options_&&a.options_.resource;const q=a.resUrl_,m=a.refresh_;let x=!1;-1===this.credentials.indexOf(f)&&(m&&-1!==this.credentials.indexOf(m)?(m.userId=f.userId,m.token=f.token,m.expires=f.expires,m.validity=f.validity,m.ssl=f.ssl,m.creationTime=f.creationTime,x=!0,f=m):this.credentials.push(f));f.resources||(f.resources=[]);f.resources.push(h||
q);f.scope=this._isServerRsrc(q)?"server":"portal";f.emitTokenChange();h=this._soReqs;const v={};this._soReqs=[];h.forEach(p=>{if(!this._isIdenticalService(q,p.resUrl_)){const z=this._getSuffix(p.resUrl_);v[z]||(v[z]=!0,f.resources.push(p.resUrl_))}});a.resolve(f);h.forEach(p=>{this._hasSameServerInstance(this._getServerInstanceRoot(q),p.resUrl_)?p.resolve(f):this._soReqs.push(p)});this._busy=a.resUrl_=a.sinfo_=a.refresh_=null;x||this.emit("credential-create",{credential:f});this._soReqs.length?this._doSignIn(this._soReqs.shift()):
this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},c=f=>{a.reject(f);this._busy=a.resUrl_=a.sinfo_=a.refresh_=null;this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},d=(f,h,q,m)=>{var x,v;const p=a.sinfo_,z=!a.options_||!1!==a.options_.prompt,H=p.hasPortal&&this._findOAuthInfo(a.resUrl_);let A,N;if(f)b(new r.Credential({userId:f,server:p.server,token:q||null,expires:null!=m?Number(m):null,ssl:!!h}));else if(window!==window.parent&&
null!=(x=this._appUrlObj.query)&&x["arcgis-auth-origin"]&&null!=(v=this._appUrlObj.query)&&v["arcgis-auth-portal"]&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query["arcgis-auth-portal"]),a.resUrl_)){var ba;window.parent.postMessage({type:"arcgis:auth:requestCredential"},this._appUrlObj.query["arcgis-auth-origin"]);const t=P.on(window,"message",D=>{D.source===window.parent&&D.data&&("arcgis:auth:credential"===D.data.type?(t.remove(),b(new r.Credential(D.data.credential))):
"arcgis:auth:error"===D.data.type&&(t.remove(),c(y.fromJSON(D.data.error))))});G.onAbort(null==(ba=a.options_)?void 0:ba.signal,()=>{t.remove()})}else if(H){let t=H._oAuthCred;t||(f=new Y(H,L),h=new Y(H,M),f.isValid()&&h.isValid()?f.expires>h.expires?(t=f,h.destroy()):(t=h,f.destroy()):t=f.isValid()?f:h,H._oAuthCred=t);if(t.isValid())A=new r.Credential({userId:t.userId,server:p.server,token:t.token,expires:t.expires,ssl:t.ssl,_oAuthCred:t}),H.appId!==t.appId&&this._doPortalSignIn(a.resUrl_)?a._pendingDfd=
this._exchangeToken(A.server,H.appId,A.token).then(D=>{A.token=D;t.token=D;t.save();b(A)}).catch(()=>{b(A)}):b(A);else if(this._oAuthHash&&this._hasSameServerInstance(H.portalUrl,this._oAuthHash.state.portalUrl))f=this._oAuthHash,A=new r.Credential({userId:f.username,server:p.server,token:f.access_token,expires:Date.now()+1E3*Number(f.expires_in),ssl:"true"===f.ssl,oAuthState:f.state,_oAuthCred:t}),H.userId=A.userId,t.storage=f.persist?L:M,t.token=A.token,t.expires=A.expires,t.userId=A.userId,t.ssl=
A.ssl,t.save(),this._oAuthHash=null,b(A);else{const D=()=>{z?a._pendingDfd=this.oAuthSignIn(a.resUrl_,p,H,a.options_).then(b,c):(N=new y("identity-manager:not-authenticated","User is not signed in."),c(N))};this._doPortalSignIn(a.resUrl_)?a._pendingDfd=this._getPlatformSelf(p.server,H.appId).then(({portalUrl:ca,token:fa,username:ha})=>{!ca||u.hasSameOrigin(ca,this._appOrigin,!0)?(A=new r.Credential({server:p.server,userId:ha,token:fa}),b(A)):D()}).catch(D):D()}}else z?this._checkProtocol(a.resUrl_,
p,c,a.admin_)&&(f=a.options_,a.admin_&&(f=f||{},f.isAdmin=!0),a._pendingDfd=this.signIn(a.resUrl_,p,f).then(b,c)):(N=new y("identity-manager:not-authenticated","User is not signed in."),c(N))},e=()=>{const f=a.sinfo_;var h=f.owningSystemUrl;const q=a.options_;let m,x,v,p;q&&(m=q.token,x=q.error,v=q.prompt);p=this._findCredential(h,{token:m,resource:a.resUrl_});if(!p)for(const z of this.credentials)if(this._isIdProvider(h,z.server)){p=z;break}p?(h=this.findCredential(a.resUrl_,p.userId))?b(h):S(f,
this._legacyFed)?(h=p.toJSON(),h.server=f.server,h.resources=null,b(new r.Credential(h))):(a._pendingDfd=this.generateToken(this.findServerInfo(p.server),null,{serverUrl:a.resUrl_,token:p.token,signal:a.options_.signal,ssl:p.ssl})).then(z=>{b(new r.Credential({userId:p.userId,server:f.server,token:z.token,expires:null!=z.expires?Number(z.expires):null,ssl:!!z.ssl,isAdmin:a.admin_,validity:z.validity}))},c):(this._busy=null,m&&(a.options_.token=null),(a._pendingDfd=this.getCredential(h.replace(/\/?$/,
"/sharing"),{resource:a.resUrl_,owningTenant:f.owningTenant,signal:a.options_.signal,token:m,error:x,prompt:v})).then(()=>{this._enqueue(a.resUrl_,a.sinfo_,a.options_,a,a.admin_)},z=>{c(z)}))};this._errbackFunc=c;const g=a.sinfo_.owningSystemUrl,l=this._isServerRsrc(a.resUrl_),n=a.sinfo_._restInfoPms;n?n.promise.then(f=>{const h=a.sinfo_;h._restInfoPms&&(h.adminTokenServiceUrl=h._restInfoPms.adminUrl,h._restInfoPms=null,h.tokenServiceUrl=J.getDeepValue("authInfo.tokenServicesUrl",f)||J.getDeepValue("authInfo.tokenServiceUrl",
f)||J.getDeepValue("tokenServiceUrl",f),h.shortLivedTokenValidity=J.getDeepValue("authInfo.shortLivedTokenValidity",f),h.currentVersion=f.currentVersion,h.owningTenant=f.owningTenant,(f=h.owningSystemUrl=f.owningSystemUrl)&&this._portals.push(f));l&&h.owningSystemUrl?e():d()},()=>{a.sinfo_._restInfoPms=null;const f=new y("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");c(f)}):l&&g?e():a.sinfo_._selfReq?a.sinfo_._selfReq.selfDfd.then(f=>{const h=
{};let q,m,x,v;f&&(q=f.user&&f.user.username,h.username=q,h.allSSL=f.allSSL,m=f.supportsOAuth,x=f.currentVersion,"multitenant"===f.portalMode&&(v=f.customBaseUrl));a.sinfo_.webTierAuth=!!q;return q&&this.normalizeWebTierAuth?this.generateToken(a.sinfo_,null,{ssl:h.allSSL}).catch(()=>null).then(p=>{h.portalToken=p&&p.token;h.tokenExpiration=p&&p.expires;return h}):!q&&m&&4.4<=parseFloat(x)&&!this._findOAuthInfo(a.resUrl_)?this._generateOAuthInfo({portalUrl:a.sinfo_.server,customBaseUrl:v,owningTenant:a.sinfo_._selfReq.owningTenant}).catch(()=>
null).then(()=>h):h}).catch(()=>null).then(f=>{a.sinfo_._selfReq=null;f?d(f.username,f.allSSL,f.portalToken,f.tokenExpiration):d()}):d()};k._generateOAuthInfo=function(a){let b,c=a.portalUrl;const d=a.customBaseUrl,e=a.owningTenant;if(a=!this.defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal){b=window.location.href;let g=b.indexOf("?");-1<g&&(b=b.slice(0,g));g=b.search(/\/(apps|home)\//);b=-1<g?b.slice(0,g):null}a&&b?(this._hasTestedIfAppIsOnPortal=!0,a=I(b+"/sharing/rest",
{query:{f:"json"}}).then(()=>{this.defaultOAuthInfo=new Z({appId:"arcgisonline",popupCallbackUrl:b+"/home/oauth-callback.html"})})):a=Promise.resolve();return a.then(()=>{if(this.defaultOAuthInfo)return c=c.replace(/^http:/i,"https:"),I(c+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:e,client_id:this.defaultOAuthInfo.appId,redirect_uri:u.makeAbsolute(this.defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then(g=>{if(g.data.valid){const l=this.defaultOAuthInfo.clone();l.portalUrl=g.data.urlKey&&
d?"https://"+g.data.urlKey.toLowerCase()+"."+d:c;l.popup=window!==window.top||!(u.hasSameOrigin(c,this._appOrigin)||this._gwDomains.some(n=>n.regex.test(c)&&n.regex.test(this._appOrigin)));this.oAuthInfos.push(l)}})})};k._doOAuthSignIn=function(a,b,c){var d={portalUrl:c.portalUrl};!c.popup&&c.preserveUrlHash&&window.location.hash&&(d.hash=window.location.hash);d={client_id:c.appId,response_type:"token",state:JSON.stringify(d),expiration:c.expiration,locale:c.locale,redirect_uri:c.popup?u.makeAbsolute(c.popupCallbackUrl):
window.location.href.replace(/#.*$/,"")};c.forceLogin&&(d.force_login=!0);c.forceUserId&&c.userId&&(d.prepopulatedusername=c.userId);!c.popup&&this._doPortalSignIn(a)&&(d.redirectToUserOrgUrl=!0);const e=c.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",g=e+"?"+u.objectToQuery(d);if(c.popup){const l=window.open(g,"esriJSAPIOAuth",c.popupWindowFeatures);l?(l.focus(),this._oAuthDfd.oAuthWin_=l,this._oAuthIntervalId=setInterval(()=>{if(l.closed){clearInterval(this._oAuthIntervalId);
this._oAuthOnHashHandle.remove();const n=this._oAuthDfd;if(n){const f=new y("identity-manager:user-aborted","ABORTED");n.reject(f)}}},500),this._oAuthOnHashHandle=P.on(V,"arcgis:auth:hash",n=>{this.setOAuthResponseHash(n.detail)})):(a=new y("identity-manager:popup-blocked","ABORTED"),this._oAuthDfd.reject(a))}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:d,authorizeUrl:e,resourceUrl:a,serverInfo:b,oAuthInfo:c}):window.location.href=g};return F}(U);
Q.prototype.declaredClass="esri.identity.IdentityManagerBase";r.Credential=function(C){function F(a){var b=C.call(this,a)||this;b._oAuthCred=null;b.tokenRefreshBuffer=2;a&&a._oAuthCred&&(b._oAuthCred=a._oAuthCred);return b}T._inheritsLoose(F,C);var k=F.prototype;k.initialize=function(){this.resources=this.resources||[];null==this.creationTime&&(this.creationTime=Date.now())};k.refreshToken=function(){const a=w.id.findServerInfo(this.server),b=a&&a.owningSystemUrl,c=!!b&&"server"===this.scope,d=c&&
S(a,w.id._legacyFed);var e=a.webTierAuth;const g=e&&w.id.normalizeWebTierAuth;var l=K[this.server];l=l&&l[this.userId];let n=this.resources&&this.resources[0],f=c&&w.id.findServerInfo(b),h={username:this.userId,password:l},q;if(!e||g)if(c&&!f&&w.id.serverInfos.some(m=>{w.id._isIdProvider(b,m.server)&&(f=m);return!!f}),e=f&&w.id.findCredential(f.server,this.userId),!c||e)if(d)e.refreshToken();else{if(c)q={serverUrl:n,token:e&&e.token,ssl:e&&e.ssl};else if(g)h=null,q={ssl:this.ssl};else if(l)this.isAdmin&&
(q={isAdmin:!0});else{let m;n&&(n=w.id._sanitizeUrl(n),this._enqueued=1,m=w.id._enqueue(n,a,null,null,this.isAdmin,this),m.then(()=>{this._enqueued=0;this.refreshServerTokens()}).catch(()=>{this._enqueued=0}));return m}return w.id.generateToken(c?f:a,c?null:h,q).then(m=>{this.token=m.token;this.expires=null!=m.expires?Number(m.expires):null;this.creationTime=Date.now();this.validity=m.validity;this.emitTokenChange();this.refreshServerTokens()}).catch(()=>{})}};k.refreshServerTokens=function(){"portal"===
this.scope&&w.id.credentials.forEach(a=>{const b=w.id.findServerInfo(a.server),c=b&&b.owningSystemUrl;a!==this&&a.userId===this.userId&&c&&"server"===a.scope&&(w.id._hasSameServerInstance(this.server,c)||w.id._isIdProvider(c,this.server))&&(S(b,w.id._legacyFed)?(a.token=this.token,a.expires=this.expires,a.creationTime=this.creationTime,a.validity=this.validity,a.emitTokenChange()):a.refreshToken())})};k.emitTokenChange=function(a){clearTimeout(this._refreshTimer);var b=this.server&&w.id.findServerInfo(this.server);
const c=(b=b&&b.owningSystemUrl)&&w.id.findServerInfo(b);!1===a||b&&"portal"!==this.scope&&(!c||!c.webTierAuth||w.id.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer();this.emit("token-change")};k.destroy=function(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null;this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);const a=w.id.credentials.indexOf(this);-1<a&&w.id.credentials.splice(a,1);this.emitTokenChange();
this.emit("destroy")};k.toJSON=function(){const a=W.fixJson({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),b=this.resources;b&&0<b.length&&(a.resources=b.slice());return a};k._startRefreshTimer=function(){clearTimeout(this._refreshTimer);const a=6E4*this.tokenRefreshBuffer,b=2**31-1;let c=(this.validity?this.creationTime+6E4*this.validity:this.expires)-Date.now();
0>c?c=0:c>b&&(c=b);this._refreshTimer=setTimeout(this.refreshToken.bind(this),c>a?c-a:c)};return F}(U.EventedAccessor);B.__decorate([E.property()],r.Credential.prototype,"creationTime",void 0);B.__decorate([E.property()],r.Credential.prototype,"expires",void 0);B.__decorate([E.property()],r.Credential.prototype,"isAdmin",void 0);B.__decorate([E.property()],r.Credential.prototype,"oAuthState",void 0);B.__decorate([E.property()],r.Credential.prototype,"resources",void 0);B.__decorate([E.property()],
r.Credential.prototype,"scope",void 0);B.__decorate([E.property()],r.Credential.prototype,"server",void 0);B.__decorate([E.property()],r.Credential.prototype,"ssl",void 0);B.__decorate([E.property()],r.Credential.prototype,"token",void 0);B.__decorate([E.property()],r.Credential.prototype,"tokenRefreshBuffer",void 0);B.__decorate([E.property()],r.Credential.prototype,"userId",void 0);B.__decorate([E.property()],r.Credential.prototype,"validity",void 0);r.Credential=B.__decorate([da.subclass("esri.identity.Credential")],
r.Credential);r.IdentityManagerBase=Q;Object.defineProperty(r,"__esModule",{value:!0})});