// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../core/Error ../../layers/support/lazyLayerLoader ../Portal ./jsonContext ../../renderers/support/styleUtils ../../support/requestPresets".split(" "),function(l,m,v,n,B,C,D,w){function q(){q=m._asyncToGenerator(function*(a,c){var b=a.instance.portalItem;if(!b||!b.id)return Promise.resolve();yield b.load(c);b=a.instance.portalItem;if(-1===a.supportedTypes.indexOf(b.type))throw new v("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",
{type:b.type,expectedType:a.supportedTypes.join(", ")});return E(a,c)});return q.apply(this,arguments)}function E(a,c){return r.apply(this,arguments)}function r(){r=m._asyncToGenerator(function*(a,c){const b=a.instance,g=b.portalItem,{url:f,title:d}=g,e=C.createForItem(g);if("group"===b.type)return b.read({title:d},e),F(b,a);f&&b.read({url:f},e);(a=yield x(a,c))&&b.read(a,e);b.resourceReferences={portalItem:g,paths:e.readResourcePaths};b.read({title:d},e);return D.loadStyleRenderer(b,e)});return r.apply(this,
arguments)}function F(a,c){let b;const g=a.portalItem.type;switch(g){case "Feature Service":b=n.layerLookupMap.FeatureLayer;break;case "Stream Service":b=n.layerLookupMap.StreamLayer;break;case "Scene Service":b=n.layerLookupMap.SceneLayer;break;case "Feature Collection":b=n.layerLookupMap.FeatureLayer;break;default:throw new v("portal:unsupported-item-type-as-group",`The item type '${g}' is not supported as a 'IGroupLayer'`);}let f;return b().then(d=>{f=d;return x(c)}).then(function(){var d=m._asyncToGenerator(function*(e){return"Feature Service"===
g?(e=yield y(e,a.portalItem.url),t(a,f,e)):0<p(e)?t(a,f,e):G(a,f)});return function(e){return d.apply(this,arguments)}}())}function G(a,c){return a.portalItem.url?w.requestArcGISServiceJSON(a.portalItem.url).then(b=>{function g(e){return{id:e.id,name:e.name}}var f,d;b&&t(a,c,{layers:null==(f=b.layers)?void 0:f.map(g),tables:null==(d=b.tables)?void 0:d.map(g)})}):Promise.resolve()}function t(a,c,b){let g=b.layers||[];const f=b.tables||[];"Feature Collection"===a.portalItem.type&&(g.forEach(d=>{var e;
"Table"===(null==d?void 0:null==(e=d.layerDefinition)?void 0:e.type)&&f.push(d)}),g=g.filter(d=>{var e;return"Table"!==(null==d?void 0:null==(e=d.layerDefinition)?void 0:e.type)}));g.reverse().forEach(d=>{d=z(a,c,b,d);a.add(d)});f.reverse().forEach(d=>{d=z(a,c,b,d);a.tables.add(d)})}function z(a,c,b,g){c=new c({portalItem:a.portalItem.clone(),layerId:g.id,sublayerTitleMode:"service-name"});"Feature Collection"===a.portalItem.type&&(a={origin:"portal-item",portal:a.portalItem.portal||B.getDefault()},
c.read(g,a),b=b.showLegend,null!=b&&c.read({showLegend:b},a));return c}function x(a,c){if(!1===a.supportsData)return Promise.resolve(void 0);const b=a.instance;return b.portalItem.fetchData("json",c).catch(()=>null).then(function(){var g=m._asyncToGenerator(function*(f){var d="stream"===b.type?!1:"layerId"in b;if(d){d=!0;if(f&&0<p(f)){null==b.layerId&&(b.layerId=A(f));a:{var e=b.layerId;var k=f.layers;if(k)for(var h=0;h<k.length;h++)if(k[h].id===e){e=k[h];break a}if(k=f.tables)for(h=0;h<k.length;h++)if(k[h].id===
e){e=k[h];break a}e=null}e&&(1===p(f)&&(d=!1),null!=f.showLegend&&(e.showLegend=f.showLegend))}d&&"service-name"!==b.sublayerTitleMode&&(b.sublayerTitleMode="item-title-and-service-name");return e}return f});return function(f){return g.apply(this,arguments)}}())}function y(a,c){return u.apply(this,arguments)}function u(){u=m._asyncToGenerator(function*(a,c){var b,g;if(null==(null==(b=a)?void 0:b.layers)||null==(null==(g=a)?void 0:g.tables))c=yield w.requestArcGISServiceJSON(c),a=a||{},a.layers=a.layers||
(null==c?void 0:c.layers),a.tables=a.tables||(null==c?void 0:c.tables);return a});return u.apply(this,arguments)}function A(a){const c=a.layers;return c&&c.length?c[0].id:(a=a.tables)&&a.length?a[0].id:null}function p(a){var c,b,g,f;const d=null!=(c=null==a?void 0:null==(b=a.layers)?void 0:b.length)?c:0;a=null!=(g=null==a?void 0:null==(f=a.tables)?void 0:f.length)?g:0;return d+a}l.getFirstLayerOrTableId=A;l.getNumLayersAndTables=p;l.load=function(a,c){return q.apply(this,arguments)};l.preprocessFSItemData=
y;Object.defineProperty(l,"__esModule",{value:!0})});