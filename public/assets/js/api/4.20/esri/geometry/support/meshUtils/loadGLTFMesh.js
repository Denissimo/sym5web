// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../Color ../../../request ../../../core/maybe ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../MeshComponent ../MeshMaterialMetallicRoughness ../MeshTexture ../MeshVertexAttributes ../buffer/BufferView ../../../chunks/vec32 ../../../chunks/vec42 ../buffer/utils ./georeference ../../../views/3d/glTF/DefaultLoadingContext ../../../views/3d/glTF/loader ../../../views/3d/glTF/internal/indexUtils ../../../views/3d/webgl-engine/lib/geometryDataUtils ../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../../chunks/vec33 ../../../chunks/vec43 ../../../chunks/vec22".split(" "),
function(B,C,D,J,d,E,F,K,L,M,N,O,P,n,u,x,t,Q,R,S,y,T,U,G,v,H){function z(){z=C._asyncToGenerator(function*(a,b,f){var l=new R.DefaultLoadingContext(V(f));b=(yield S.load(l,b,f,!0)).model;l=b.lods.shift();const k=new Map,p=new Map;b.textures.forEach((w,A)=>k.set(A,new O({data:w.data,wrap:W(w.parameters.wrap)})));b.materials.forEach((w,A)=>p.set(A,X(w,k)));b=Y(l);for(var m of l.parts)Z(b,m,p);const {position:q,normal:g,tangent:e,color:c,texCoord0:h}=b.vertexAttributes;m={position:q.typedBuffer,normal:d.isSome(g)?
g.typedBuffer:null,tangent:d.isSome(e)?e.typedBuffer:null,uv:d.isSome(h)?h.typedBuffer:null,color:d.isSome(c)?c.typedBuffer:null};f=Q.georeferenceByTransform(m,a,f);return{transform:f.transform,components:b.components,spatialReference:a.spatialReference,vertexAttributes:new P["default"]({position:f.vertexAttributes.position,normal:f.vertexAttributes.normal,tangent:f.vertexAttributes.tangent,color:m.color,uv:m.uv})}});return z.apply(this,arguments)}function V(a){return null!=a&&a.resolveFile?{busy:!1,
request:function(){var b=C._asyncToGenerator(function*(f,l,k){f=a.resolveFile(f);return(yield J(f,{responseType:"image"===l?"image":"binary"===l?"array-buffer":"json",signal:d.isSome(k)?k.signal:null})).data});return function(f,l,k){return b.apply(this,arguments)}}()}:null}function Y(a){let b=0;var f=!1,l=!1,k=!1,p=!1;for(const {attributes:{position:m,normal:q,color:g,tangent:e,texCoord0:c}}of a.parts)b+=m.count,q&&(k=!0),g&&(f=!0),e&&(l=!0),c&&(p=!0);return{writeIndex:0,vertexAttributes:{position:t.createBuffer(n.BufferViewVec3f64,
b),normal:k?t.createBuffer(n.BufferViewVec3f,b):null,tangent:l?t.createBuffer(n.BufferViewVec4f,b):null,color:f?t.createBuffer(n.BufferViewVec4u8,b):null,texCoord0:p?t.createBuffer(n.BufferViewVec2f,b):null},components:[]}}function X(a,b){const f=new D(aa(a.color,a.opacity)),l=a.emissiveFactor?new D(ba(a.emissiveFactor)):null;var k=d.unwrap(d.applySome(a.textureColor,e=>b.get(e))),p=d.unwrap(d.applySome(a.textureNormal,e=>b.get(e))),m=d.unwrap(d.applySome(a.textureEmissive,e=>b.get(e))),q=d.unwrap(d.applySome(a.textureOcclusion,
e=>b.get(e)));a:{switch(a.alphaMode){case "OPAQUE":var g="opaque";break a;case "MASK":g="mask";break a;case "BLEND":g="blend";break a}g=void 0}return new N({color:f,colorTexture:k,normalTexture:p,emissiveColor:l,emissiveTexture:m,occlusionTexture:q,alphaMode:g,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,metallic:a.metallicFactor,roughness:a.roughnessFactor,metallicRoughnessTexture:d.unwrap(d.applySome(a.textureMetallicRoughness,e=>b.get(e)))})}function Z(a,b,f){const {position:l,normal:k,
tangent:p,color:m,texCoord0:q}=a.vertexAttributes,g=a.writeIndex,e=b.attributes.position.count;u.transformMat4(l.slice(g,e),b.attributes.position,b.transform);if(d.isSome(b.attributes.normal)&&d.isSome(k)){var c=E.normalFromMat4(F.create(),b.transform);u.transformMat3(k.slice(g,e),b.attributes.normal,c)}else d.isSome(k)&&G.fill(k,0,0,1,{dstIndex:g,count:e});d.isSome(b.attributes.tangent)&&d.isSome(p)?(c=E.normalFromMat4(F.create(),b.transform),x.transformMat3(p.slice(g,e),b.attributes.tangent,c)):
d.isSome(p)&&v.fill(p,0,0,1,1,{dstIndex:g,count:e});d.isSome(b.attributes.texCoord0)&&d.isSome(q)?H.normalizeIntegerBuffer(q.slice(g,e),b.attributes.texCoord0):d.isSome(q)&&H.fill(q,0,0,{dstIndex:g,count:e});if(d.isSome(b.attributes.color)&&d.isSome(m)){c=b.attributes.color;var h=m.slice(g,e);4===c.elementCount?c instanceof n.BufferViewVec4f?x.scale(h,c,255):c instanceof n.BufferViewVec4u8?v.copy(h,c):c instanceof n.BufferViewVec4u16&&x.shiftRight(h,c,8):(v.fill(h,255,255,255,255),h=n.BufferViewVec3u8.fromTypedArray(h.typedBuffer,
h.typedBufferStride),c instanceof n.BufferViewVec3f?u.scale(h,c,255):c instanceof n.BufferViewVec3u8?G.copy(h,c):c instanceof n.BufferViewVec3u16&&u.shiftRight(h,c,8))}else d.isSome(m)&&v.fill(m.slice(g,e),255,255,255,255);a:{c=b.indices||e;switch(b.primitiveType){case 4:c=y.trianglesToTriangles(c,T.generateIndexArray);break a;case 5:c=y.triangleStripToTriangles(c);break a;case 6:c=y.triangleFanToTriangles(c);break a}c=void 0}if(g)for(h=0;h<c.length;h++)c[h]+=g;a.components.push(new M({faces:c,material:f.get(b.material).clone(),
trustSourceNormals:!0}));a.writeIndex+=e}function W(a){return{horizontal:I(a.s),vertical:I(a.t)}}function I(a){switch(a){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function r(a){return 255*a**(1/U.COLOR_GAMMA)}function aa(a,b){return L.fromValues(r(a[0]),r(a[1]),r(a[2]),b)}function ba(a){return K.fromValues(r(a[0]),r(a[1]),r(a[2]))}B.loadGLTFMesh=function(a,b,f){return z.apply(this,arguments)};Object.defineProperty(B,"__esModule",{value:!0})});