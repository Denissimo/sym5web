// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/maybe ../../../chunks/vec3 ../../../chunks/vec3f64 ../MeshComponent ../MeshTransform ../MeshVertexAttributes ./georeference".split(" "),function(A,D,m,B,E,F,G,H,C){function I(a){let b=null,d=!0;const c=E.create();let n=0,h=!1;for(const f of a)if(!m.isSome(b)||!m.isNone(f.transform)&&f.transform.equals(b)||(d=!1),m.isSome(f.transform)){if(m.isSome(b)&&b.geographic!==f.transform.geographic)return z.error("merge()","Inconsistent geographic mode for provided geometries transform. Some are geographic while others are not, unable to merge geometries."),
null;m.isNone(b)&&(b=f.transform);f.transform.geographic&&(h=!0);n++;B.add(c,c,f.transform.origin)}if(m.isNone(b))return{transform:null,rebake:!1};if(d)return{transform:b.clone(),rebake:!1};a=B.scale(c,c,1/n);return{transform:new G({origin:a,geographic:h}),rebake:!0}}function w(a,b,d,c,n){if(b){var h=b.position;if(h)if(b=b[a],d=d[a],m.isNone(b)){b=c[a];var f=p[a];if(m.isSome(d)){for(var g=0;g<h.length;g+=3)for(let q=0;q<f;q++)d[b++]=n;c[a]=b}}else if(m.isSome(d)&&m.isSome(b)){n=0;h=c[a];f=b.length;
for(g=0;g<f;g++)d[h++]=b[n++];c[a]+=b.length}}}const z=D.getLogger("esri.geometry.support.triangleMeshMerge"),p={position:3,normal:3,tangent:4,uv:2,color:4};A.merge=function(a,b){var d,c;if(0===a.length)return z.error("merge()","Must specify one more more geometries to merge"),null;const n=a[0].spatialReference;for(var h of a){if(!h.spatialReference.equals(n))return z.error("merge()","Geometries must all be in the same spatial reference"),null;if(!h.loaded)return z.error("merge()","Geometries must all be loaded before merging"),
null}h=I(a);if(m.isNone(h))return null;var f=0,g=0,q=0,x=0,l=0,e=d=!1;var r=c=!1;for(u of a){var k=u.vertexAttributes;if(k&&k.position&&(k.uv&&(d=!0),k.normal&&(e=!0),k.tangent&&(r=!0),k.color&&(c=!0),e&&d&&c&&r))break}var u=e;for(t of a)(e=t.vertexAttributes)&&e.position&&(f+=e.position.length,d&&(g+=e.position.length/p.position*p.uv),u&&(q+=e.position.length/p.position*p.normal),c&&(x+=e.position.length/p.position*p.color),r&&(l+=e.position.length/p.position*p.tangent));var t=new H["default"]({position:new Float64Array(f),
uv:g?new Float32Array(g):null,normal:q?new Float32Array(q):null,tangent:l?new Float32Array(l):null,color:x?new Uint8Array(x):null});f=[];g={position:0,uv:0,normal:0,tangent:0,color:0};q=new Map;x=new Map;for(const v of a){a=v;l=h;l.rebake?(r=C.georeferenceApplyTransform(a.vertexAttributes,a.transform,a.spatialReference),a=m.isSome(l.transform)?C.ungeoreference(r,l.transform.getOriginPoint(a.spatialReference),{geographic:l.transform.geographic}):r):a=a.vertexAttributes;u=a;if(b&&b.reuseMaterials&&
v.components)for(const y of v.components)y.material&&q.set(y.material,y.material);a=v;l=g;c=q;d=x;r=f;if(a.components)for(const y of a.components){e=y.cloneWithDeduplication(c,d);for(k=0;k<e.faces.length;k++)e.faces[k]+=l.position/3;k=e;0<l.normal&&!a.vertexAttributes.normal&&"source"===k.shading&&(k.shading="flat");r.push(e)}else if(a.vertexAttributes&&a.vertexAttributes.position){c=a.vertexAttributes.position.length/3;d=new Uint32Array(c);for(e=0;e<c;e++)d[e]=e+l.position;c=d=new F({faces:d});0<
l.normal&&!a.vertexAttributes.normal&&"source"===c.shading&&(c.shading="flat");r.push(d)}w("position",u,t,g,0);w("normal",u,t,g,0);w("tangent",u,t,g,0);w("uv",v.vertexAttributes,t,g,0);w("color",v.vertexAttributes,t,g,255)}return{vertexAttributes:t,components:f,transform:h.transform,spatialReference:n}};Object.defineProperty(A,"__esModule",{value:!0})});