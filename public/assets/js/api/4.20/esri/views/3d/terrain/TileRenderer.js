// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/mathUtils ../../../core/maybe ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec4f64 ../../../layers/support/layerUtils ../../webgl/BufferObject ../../webgl/FramebufferObject ../../webgl/Program ../../webgl/ProgramCache ../../webgl/Renderbuffer ../../webgl/RenderingContext ../../webgl/ShaderCompiler ../../webgl/Texture ../../webgl/VertexArrayObject ../../2d/engine/vectorTiles/VectorTileRendererHelper3D ../support/StreamDataLoader ./BlendLayersTechnique ./RasterColorizerTechnique ./terrainUtils ./TileTexture ./support/FBOPool ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/Util".split(" "),
function(D,I,J,m,E,F,K,L,G,R,S,T,U,V,W,t,X,M,N,z,H,w,v,O,P,x,Q){function A(q,h,a){a.layerIndex=h;const b=q.layerInfo[1][h];return b.data?(E.set(a.offset,0,0),a.tile=q,a.scale=1,a.sourceLod=q.lij,a.sourceLayerInfo=b,a):(q=b.upsampleInfo)?(h=q.tile.layerInfo[1][h],a.tile=q.tile,E.copy(a.offset,q.offset),a.scale=q.scale,a.sourceLod=q.tile.lij,a.sourceLayerInfo=h,a):null}G=function(){function q(a,b,c){this._rctx=a;this.tileSize=b;this._backgroundIsGrid=!1;this._blackTex=this._backgroundColor=this._backgroundTexture=
null;this._vectorTileHelper=new M.VectorTileRendererHelper3D;this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy;this._vaoQuad=x.createQuadVAO(this._rctx,P.Pos2Tex);a=new z.BlendLayersTechniqueConfiguration;a.mode=2;this._blendLayersTechnique=c.acquire(z.BlendLayersTechnique,a);a.mode=1;this._applyOpacityTechnique=c.acquire(z.BlendLayersTechnique,a);this._techniqueRep=c;this._blackTex=new v(x.createColorTexture(this._rctx,[0,0,0,1]));this._fboPool=new O.FBOPool(this._rctx)}var h=q.prototype;
h.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null);this._vaoQuad=m.disposeMaybe(this._vaoQuad);this._backgroundTexture=m.releaseMaybe(this._backgroundTexture);this._blackTex=m.releaseMaybe(this._blackTex);this._blendLayersTechnique=m.disposeMaybe(this._blendLayersTechnique);this._applyOpacityTechnique=m.disposeMaybe(this._applyOpacityTechnique);this._vectorTileHelper=m.disposeMaybe(this._vectorTileHelper)};h.updateTileTexture=function(a){var b=a.layerInfo[1];for(var c of b)c.pendingUpdates&=
-65;if(a.renderData){var d=a.surface,f=d.baseOpacity,g=0;c=0;for(var e=this.tileSize,k=!1,n=d.view.pixelRatio,r=b.length,l=0;l<b.length&&!k;l++){const u=d.layerViewByIndex(l,1),p=u.fullOpacity;B[l]=p;L.isBaseLayer(u.layer)&&r>=b.length&&(r=l);if(0===p)continue;++c;const y=A(a,l,C);y&&(w.isVectorTileLayerView(u)?e=Math.max(e,this.tileSize*n):1===f&&1===p&&(u.isOpaque||this._dataToTexture(y)&&m.isSome(y.sourceLayerInfo.data)&&y.sourceLayerInfo.data.descriptor.isOpaque)&&(k=!0),++g)}this._cleanupFBOPool(n,
b.length);f=e;e=J.nextHighestPowerOfTwo(f);b=e*e;d=f*f;b===d?e=f:(f=e/2,e=b-d<d-f*f?e:f);b=e/this.tileSize;--l;if(0===g){g=0;if(a.surface.view.layerViewManager.updating||0<c)g=5E3;this._backgroundTexture&&m.isNone(a.renderData.textureReference)&&(g=0);this._useBackgroundTexture(a,g)}else 1===g&&(k||this._backgroundIsGrid||m.isSome(this._backgroundColor))&&this._useLayerTexture(a,l,r,B[l])||this._composeMapLayers(a,l,r,k,B,e,b)}};h.setBackground=function(a,b){m.releaseMaybe(this._backgroundTexture);
this._backgroundIsGrid=b;a instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(a),this._backgroundColor=null):(this._backgroundTexture=new v(x.createColorTexture(this._rctx,a)),this._backgroundColor=K.fromValues(a[0]||0,a[1]||0,a[2]||0,a[3]||0))};h._buildTexture=function(a,b=9987){if(m.isNone(a))return null;const c={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:b,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0};b=this._rctx;let d;if("number"===
typeof a)c.width=c.height=a,d=new v(new t(b,c));else if(a instanceof N.ImageWithType)c.isOpaque=a.isOpaque,d=new v(new t(b,c,a.image)),a.release();else try{d=new v(new t(b,c,a))}catch(f){d=new v(x.createEmptyTexture(b)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}a=b.bindTexture(d.texture,t.TEXTURE_UNIT_FOR_UPDATES);d.generateMipmap();b.bindTexture(a,t.TEXTURE_UNIT_FOR_UPDATES);return d};h._drawQuad=function(a){this._rctx.bindVAO(this._vaoQuad);
a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(5,0,Q.vertexCount(this._vaoQuad,"geometry"))};h._drawRasterData=function(a,b,c,d,f=1){if(!m.isNone(b)){var g=this._rctx,e=a.program;g.setPipelineState(a.pipeline);g.useProgram(e);e.bindTexture(b,"tex");e.setUniform1f("scale",c);e.setUniform2f("offset",d[0],d[1]);e.setUniform1f("opacity",f);this._drawQuad(e)}};h.hasNearestInterpolation=function(a){a=a.sourceLayerInfo.data;return m.isNone(a)||!a.source?!1:"nearest"===a.interpolation};
h._drawImageryTileData=function(a,b=1){const c=a.sourceLayerInfo.data;if(!m.isNone(c)&&c.source){a.tile.surface.layerViewByIndex(a.layerIndex,1).ensureSymbolizerParameters(c);var d=this._getRasterColorizerTechnique(c.symbolizerParameters.type,!!c.symbolizerParameters.colormap),f=this._rctx,g=d.program;f.setPipelineState(d.pipeline);f.useProgram(g);if(c.bind(f)){c.opacity=b;c.scale=a.scale;c.offset=a.offset;var {names:e,textures:k}=c.getTextures();e.forEach((n,r)=>g.bindTexture(k[r],n));d.bindPass(c.getUniforms());
this._drawQuad(g);f.bindVAO()}}};h._getRasterColorizerTechnique=function(a,b){a=["stretch","lut","hillshade"].indexOf(a);this._rasterColorizerConfig||(this._rasterColorizerConfig=new H.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float"));this._rasterColorizerConfig.colorizerType=a;this._rasterColorizerConfig.applyColormap=b;return this._rasterColorizerTechnique=this._techniqueRep.releaseAndAcquire(H.RasterColorizerTechnique,
this._rasterColorizerConfig,this._rasterColorizerTechnique)};h._drawVectorData=function(a,b,c,d,f,g,e){const k=b.sourceLayerInfo.data;if(m.isNone(k))return e;const n=this._rctx,r=b.tile.surface.layerViewByIndex(b.layerIndex,1);let l;n.setPipelineState(a.pipeline);1>d?(l=this._fboPool.acquire(f),n.bindFramebuffer(l),n.setClearColor(1,1,1,0),n.clearSafe(16640)):e&&n.clearSafe(256);this._vectorTileHelper.render(n,b.sourceLod,k,r.painter,r.layer.styleRepository,r.schemaHelper,Math.round(1/b.scale),b.offset,
this.tileSize,c);return m.isSome(l)?(n.bindFramebuffer(g),this._drawRasterData(a,l.colorTexture,1,[0,0],d),this._fboPool.release(l),e):!0};h._useBackgroundTexture=function(a,b){a.renderData.opacity=a.surface.baseOpacity;a.renderData.compositeBackgroundInShader=!1;a.renderData.layerOpacity=1;a.renderData.baseOpacity=1;a.renderData.setTextureReference(this._backgroundTexture,0,0,1,b)};h._useLayerTexture=function(a,b,c,d){c=b<c;a.renderData.opacity=c?1:a.surface.baseOpacity;a.renderData.compositeBackgroundInShader=
!0;a.renderData.layerOpacity=d;a.renderData.baseOpacity=c?a.surface.baseOpacity:1;b=A(a,b,C);return this._dataToTexture(b)?(d=b.offset,a.renderData.setTextureReference(b.sourceLayerInfo.data,d[0],d[1],b.scale),!0):!1};h._composeMapLayers=function(a,b,c,d,f,g,e){const k=this._rctx,n=this._fboPool.acquire(g);k.bindFramebuffer(n);k.setViewport(0,0,g,g);k.setClearColor(0,0,0,0);k.setClearDepth(1);k.clearSafe(16640);let r=!1;!d&&m.isSome(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,
this._backgroundTexture.texture,1,F.ZEROS);d=a.surface.baseOpacity;let l=!1,u=9987;for(;0<=b;b--){const p=A(a,b,C);p&&(b<c&&1>d&&!l&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,F.ZEROS,d),l=!0),0!==f[b]&&(w.isVectorTileRenderInfo(p)?r=this._drawVectorData(this._blendLayersTechnique,p,e,f[b],g,n,r):w.isImageryTileRenderInfo(p)?(this._drawImageryTileData(p,f[b]),this.hasNearestInterpolation(p)&&(u=9728)):this._dataToTexture(p)&&m.isSome(p.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,
p.sourceLayerInfo.data.texture,p.scale,p.offset,f[b])))}c=a.renderData.ensureTexture(g,()=>this._buildTexture(g,u));f=k.bindTexture(c.texture,t.TEXTURE_UNIT_FOR_UPDATES);e=c.descriptor;k.gl.copyTexImage2D(k.gl.TEXTURE_2D,0,e.pixelFormat,0,0,e.width,e.height,0);c.generateMipmap();k.bindTexture(f,t.TEXTURE_UNIT_FOR_UPDATES);k.bindFramebuffer(null);this._fboPool.release(n);a.renderData.opacity=l?1:d;a.renderData.compositeBackgroundInShader=!1;a.renderData.layerOpacity=1;a.renderData.baseOpacity=1;a.renderData.setTextureReference(c,
0,0,1)};h._dataToTexture=function(a){w.isRasterTileRenderInfo(a)&&this._rasterDataToTexture(a);return w.isTextureTileRenderInfo(a)};h._rasterDataToTexture=function(a){const b=a.sourceLayerInfo;b.data=this._buildTexture(b.data);a.tile.setMemoryDirty()};h._cleanupFBOPool=function(a,b){if(a!==this._lastPixelRatio||b!==this._lastNumLayers)this._fboPool.clear(),this._lastPixelRatio=a,this._lastNumLayers=b};I._createClass(q,[{key:"backgroundIsGrid",get:function(){return this._backgroundIsGrid}},{key:"backgroundColor",
get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]);return q}();const B=[],C={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};D.TileRenderer=G;Object.defineProperty(D,"__esModule",{value:!0})});