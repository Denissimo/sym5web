// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/maybe ../../../../core/PooledArray ../../../../core/screenUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/ray ../../../../geometry/support/vectorStacks ../../support/geometryUtils/ray ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/intersectorUtils".split(" "),function(C,m,J,w,q,K,E,n,F,x,G){function H(k,g,a){for(const b of k)g&&!g(b)||a.push(b);return a}function I(k){z||(z=new x.Intersector(k));z.viewingMode=k;return z}
let L=function(){function k(a,b,c){this.viewingMode=a;this.layerProvider=b;this.view=c;this.externalIntersectionHandlers=new J;this.tolerance=x.Intersector.DEFAULT_TOLERANCE;this.tmpRay=E.create();this.validateHUDIntersector=new x.Intersector(this.viewingMode);this.validateHUDIntersector.options.hud=!1}var g=k.prototype;g.intersectScreen=function(a,b){return this.intersectRay(this.getPickRay(a,this.tmpRay),I(this.viewingMode),b)};g.intersectScreenFreePointFallback=function(a,b){return this.intersectRayFreePointFallback(this.getPickRay(a,
this.tmpRay),b)};g.intersectRayFreePointFallback=function(a,b){return this.intersectRay(a,I(this.viewingMode),b)||this.intersectRayFreePointLocal(a,b)};g.intersectRay=function(a,b,c,d){b.options.selectionMode=!1;b.options.store=0;this.computeIntersection(a,b,d);return b.results.min?b.results.min.getIntersectionPoint(c):!1};g.getCenterRayWithSubpixelOffset=function(a,b,c=.5,d=.5){a.getRenderCenter(v,c,d);v[0]+=.0466;v[1]-=.0123;return F.fromRenderAtEye(a,v,b)};g.intersectIntersectorScreen=function(a,
b,c){this.computeIntersection(this.getPickRay(a,this.tmpRay),b,c)};g.intersectToolIntersectorScreen=function(a,b,c){a=this.getPickRay(a,this.tmpRay);this.intersectToolIntersectorRay(a,b,c)};g.intersectToolIntersectorRay=function(a,b,c){b.options.selectionMode=!0;this.computeIntersection(a,b,c);const d=b.results.min;this.view.basemapTerrain&&this.view.basemapTerrain.opaque||d.hasIntersectionPoint&&"TerrainRenderer"!==d.intersector||(b.options.selectionMode=!1,this.computeIntersection(a,b,c))};g.setTolerance=
function(a=x.Intersector.DEFAULT_TOLERANCE){this.tolerance=a};g.addIntersectionHandler=function(a){this.externalIntersectionHandlers.push(a);this.externalIntersectionHandlers.sort((b,c)=>"Terrain"===b.type?1:"Terrain"===c.type?-1:0)};g.removeIntersectionHandler=function(a){this.externalIntersectionHandlers.removeUnordered(a);this.externalIntersectionHandlers.sort((b,c)=>"Terrain"===b.type?1:"Terrain"===c.type?-1:0)};g.getPickRay=function(a,b=E.create()){return F.fromScreen(this.view.state.camera,
a,b)};g.intersectRayFreePointLocal=function(a,b){if(2!==this.viewingMode||m.isNone(a))return!1;var c=this.view.dataExtent,d=Math.max(c.xmax-c.xmin,c.ymax-c.ymin,8*Math.max(c.xmax-c.xmin,c.ymax-c.ymin));if(0===d)return q.add(b,a.origin,q.normalize(n.sv3d.get(),a.direction)),!0;var e=this.view.state.camera;const l=Math.max(0,c.xmin-e.eye[0],e.eye[0]-c.xmax);c=Math.max(0,c.ymin-e.eye[1],e.eye[1]-c.ymax);e=d/Math.max(1,Math.max(0,Math.log(d/(Math.abs(e.relativeElevation)+Number.MIN_VALUE)))**2);e=Math.max(e,
Math.min(Math.sqrt(l*l+c*c),d));d=q.scale(n.sv3d.get(),a.direction,e/q.length(a.direction));q.add(b,a.origin,d);return!0};g.intersectElevationFromScreen=function(a,b,c=0,d=null){return this.intersectElevation(this.getPickRay(a,this.tmpRay),b,c,d)};g.intersectElevation=function(a,b,c=0,d=null){if(m.isNone(a))return null;var e=m.isSome(b)?b.mode:"absolute-height",l=m.isSome(b)?m.unwrapOr(b.offset,0):0,t="on-the-ground"!==e?l+c:0;b=t/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===e)return this.view.renderCoordsHelper.intersectInfiniteManifold(a,
t,A)?(c=this.view.computeMapPointFromVec3d(A),c.z-=l,c):null;l=this.view.state.camera;const r=w.castRenderScreenPointArray3(n.sv3d.get());l.projectToRenderScreen(a.origin,r);t=this.prepareFilters(null,y);const u=this.view.slicePlane,B=m.isSome(u)?G.sliceFilterPredicate(u):null,f=new x.Intersector(this.viewingMode);f.options.store=0;f.options.verticalOffset=b;b=a.origin;a=q.add(n.sv3d.get(),b,a.direction);f.reset(b,a);f.point=r;f.camera=l;f.filterPredicate=null;const p=m.isSome(d)?"type"in d&&"graphics"===
d.type?h=>h.metadata.layerUid!==d.uid:h=>h.metadata.graphicUid!==d.uid:null;switch(e){case "relative-to-scene":f.intersect(t.layers,r,l,this.tolerance,null,h=>(m.isNone(p)||p(h))&&h.metadata&&h.metadata.isElevationSource);this.externalIntersectionHandlers.forAll(h=>{"I3S"!==h.type&&"Terrain"!==h.type||h.intersect(f,h.slicePlane?B:null,f.rayBeginPoint,f.rayEndPoint,r)});break;case "on-the-ground":case "relative-to-ground":this.externalIntersectionHandlers.forAll(h=>{h.isGround&&h.intersect(f,h.slicePlane?
B:null,f.rayBeginPoint,f.rayEndPoint,r)})}return f.results.min.getIntersectionPoint(A)?(e=this.view.computeMapPointFromVec3d(A),e.z=c,e):null};g.computeIntersection=function(a,b,c){if(!m.isNone(a)){var d=this.view.state.camera,e=w.castRenderScreenPointArray3(n.sv3d.get());d.projectToRenderScreen(a.origin,e);var l=this.prepareFilters(c,y);b.options.selectOpaqueTerrainOnly=!c||!("include"in c||"exclude"in c);var t=a.origin,r=q.add(n.sv3d.get(),a.origin,a.direction);b.reset(t,r);b.intersect(l.layers,
e,d,this.tolerance);a=this.view.slicePlane;var u=m.isSome(a)?G.sliceFilterPredicate(a):null;b.intersect(l.sliceableLayers,e,d,this.tolerance,u);var B=c&&(c.requiresGroundFeedback||c.enableDraped);this.externalIntersectionHandlers.forAll(f=>{b.options.isFiltered=!l.filterLayerUid(f.intersectionHandlerId);(f.isGround&&B||!b.options.isFiltered)&&f.intersect(b,f.slicePlane?u:null,t,r,e)});a=n.sv3d.get();if(c&&c.enableDraped&&b.results.ground.getIntersectionPoint(a)){c=this.view.basemapTerrain.overlayManager.renderer;
const f=this.view.renderCoordsHelper.spatialReference,p=n.sv3d.get();this.view.renderCoordsHelper.fromRenderCoords(a,p,this.view.spatialReference);p[2]=m.unwrapOr(this.view.elevationProvider.getElevation(a[0],a[1],a[2],f,"ground"),0);c.intersect(b,p,l.filterRenderGeometry)}b.sortResults();a=b.results.hud;if(a.hasIntersectionPoint){const f=w.castRenderScreenPointArray3(n.sv3d.get()),p=n.sv3d.get(),h=n.sv3d.get();this.unprojectHUDResultRay(a.center,f,p,h);c=q.distance(a.center,p)/q.distance(p,h)*.99;
this.validateHUDIntersector.reset(p,h);this.validateHUDIntersector.intersect(l.layers,f,d,this.tolerance);this.validateHUDIntersector.intersect(l.sliceableLayers,f,d,this.tolerance,u);this.externalIntersectionHandlers.forAll(D=>{l.filterLayerUid(D.intersectionHandlerId)&&D.intersect(this.validateHUDIntersector,D.slicePlane?u:null,p,h,f)});d=this.validateHUDIntersector.results.min;if(null==d.dist||c<=d.dist)b.results.min.copyFrom(a),b.results.all.splice(0,0,a)}}};g.prepareFilters=function(a,b){const c=
[],d=[];this.layerProvider.forEachLayer(e=>{e.isPickable&&(e.isSliceable?d:c).push(e)});b.include=a&&a.include;b.exclude=a&&a.exclude;b.layers.length=0;b.sliceableLayers.length=0;H(c,b.filterLayer,b.layers);H(d,b.filterLayer,b.sliceableLayers);return b};g.unprojectHUDResultRay=function(a,b,c,d){const e=this.view.state.camera;e.projectToRenderScreen(a,b);a=w.castRenderScreenPointArray3(n.sv3d.get());a[0]=b[0];a[1]=b[1];a[2]=0;e.unprojectFromRenderScreen(a,c);a[2]=1;e.unprojectFromRenderScreen(a,d)};
return k}(),z;const y={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer(k){return y.filterLayerUid(k.apiLayerUid)},filterLayerUid(k){const {include:g,exclude:a}=y;return m.isNone(k)?null==g&&null==a:(null==g||g.has(k))&&(null==a||!a.has(k))},filterRenderGeometry(k){return y.filterLayerUid(k.layerUid)}},A=K.create(),v=w.createRenderScreenPointArray();C.SceneIntersectionHelper=L;C.isIntersectionHandler=function(k){return"object"===typeof k&&"intersect"in k};Object.defineProperty(C,
"__esModule",{value:!0})});