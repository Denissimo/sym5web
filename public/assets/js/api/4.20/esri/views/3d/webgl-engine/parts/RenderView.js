// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/scheduling ../../../../core/time ../../../../core/watchUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../support/animationUtils ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueRepository ../lib/AutoDisposable ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/GLMaterialRep ../lib/MagnifierHelper ../lib/Renderer ../lib/TextureRepository ../lib/WebGLDriverTest ../materials/StippleTextureRepository ../materials/internal/WaterTextureRepository ./requireUtils ./ScreenshotManager ../../../webgl/context-util ../../../webgl/RenderingContext".split(" "),
function(e,p,g,u,v,w,x,r,y,z,A,m,S,T,B,C,D,E,h,F,G,H,I,J,K,t,L,M,N,O,P,Q){const R=x.getLogger("esri.views.3d.webgl-engine.parts.View");e.RenderView=function(q){function n(a){var b=q.call(this,{})||this;b.events=new v;b.waterTextureRepository=new M.WaterTextureRepository;b._magnifierHelper=new I.MagnifierHelper;b._componentObjectCollection=null;b._needsUpdate=!0;b._needsRender=!0;b._idleSuspend=!0;b._needsWaterReflectionUpdate=!1;b._logicUpdateLast=0;b._container=a.container;b._initializeContext(a.options);
A.init(b.waterTextureRepository,"loadingState",()=>b.setNeedsRender());b._magnifierHelper.events.on("request-render",()=>b.setNeedsRender());b._stippleTextureRepository=new L.StippleTextureRepository(b._rctx);b._shaderTechniqueRepository=new E.ShaderTechniqueRepository({rctx:b._rctx,viewingMode:a.viewingMode,stippleTextureRepository:b._stippleTextureRepository,waterTextureRepository:b.waterTextureRepository});b._textureRepository=new K.TextureRepository(a,b._shaderTechniqueRepository,b._rctx);b._textureRepository.events.on("changed",
c=>b.setNeedsRender(c));b._materialRepository=new H(b._textureRepository,b._shaderTechniqueRepository,()=>b.setNeedsRender());b._compositingHelper=new F(b._rctx,b._shaderTechniqueRepository);b._renderer=new J(b._materialRepository,b._textureRepository,b._shaderTechniqueRepository,b._rctx,b._compositingHelper,b._magnifierHelper,(c=1)=>b.setNeedsRender(c),(c,f)=>a.schedule(c,f),a);b._screenshotManager=new O.ScreenshotManager(b._rctx,(c,f,k)=>b._renderer.render(c,f,f,k),()=>b.setNeedsRender(),a.options.screenshot.renderOverlay,
c=>b.events.emit("force-camera-for-screenshot",c));b._registerFrameTask(a);return b}p._inheritsLoose(n,q);var d=n.prototype;d.normalizeCtorArgs=function(){return{}};d.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this._shaderTechniqueRepository.dispose();this._shaderTechniqueRepository=null;t.clearTestWebGLDriver(this._rctx);q.prototype.dispose.call(this);this._rctx=this._tmpDepthBuffer=
null};d.setNeedsRender=function(a=1){1===a?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0};d.evaluateUpdating=function(){return this.needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating};d.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};d.updateLightSources=function(a,b,c){this._renderer.updateLightSources(a,b,c);
this.setNeedsRender()};d.setRenderParameters=function(a){void 0!==a.idleSuspend&&this._idleSuspend!==!!a.idleSuspend&&(this._idleSuspend=!!a.idleSuspend,this.setNeedsRender());this._renderer.setRenderParameters(a)};d.has=function(a){switch(a){case 0:return!!this._rctx.capabilities.compressedTextureETC;case 1:return!!this._rctx.capabilities.compressedTextureS3TC;case 2:return!!this._rctx.capabilities.shaderTextureLOD;case 3:return this._renderer.hasShadowsEnabled;default:return!1}};d.modify=function(a){this._renderer.modify(a);
a.clear()};d.takeScreenshot=function(a){return this._screenshotManager.takeScreenshot(a)};d.readAccumulatedShadow=function(a){return this._renderer.readAccumulatedShadow(a[0],a[1])};d.getMinimalDepthForArea=function(a,b,c,f,k=f){a=c.constrainWindowSize(a,b,f*c.pixelRatio,k*c.pixelRatio);b=this._ensureDepthBuffer(a);this._renderer.readDepthPixels(c,a[0],a[1],a[2],a[3],b);f=Number.MAX_VALUE;for(k=0;k<a[2]*a[3];k++){const l=G.textureToDepth(4*k,b,c.nearFar);f>l&&l!==c.nearFar[0]&&l!==c.nearFar[1]&&(f=
l)}return f===Number.MAX_VALUE?void 0:f};d._ensureDepthBuffer=function(a){a=4*a[2]*a[3];if(r.isNone(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<a)this._tmpDepthBuffer=new Uint8Array(a);return this._tmpDepthBuffer};d.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()};d.hotReloadShaders=function(){var a=p._asyncToGenerator(function*(){N.removeLoadedShaderModules();yield this._shaderTechniqueRepository.hotReload();this.setNeedsRender()});return function(){return a.apply(this,
arguments)}}();d._registerFrameTask=function(a){const b=a.state,c={viewCamera:b.camera,frameHasDecorations:!1};let f=!1;this._frameTask=y.addFrameTask({preRender:k=>{f=this.evaluateUpdating();a.processSyncLayers();var l=z.Milliseconds(k.time-this._logicUpdateLast);l>C.DESIRED_ANIMATION_MS&&(l={camera:b.camera,dt:l},this._logicUpdateLast=k.time,this._renderer.updateLogic(l)&&this.setNeedsRender(0))},render:()=>{if((this.needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||
this._needsWaterReflectionUpdate)&&0<b.camera.fullWidth&&0<b.camera.fullHeight){const k=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsWaterReflectionUpdate=this._needsUpdate=this._needsRender=!1;this._renderer.render(null,b.camera,b.contentCamera,!1);k&&this._renderer.hasWaterReflection&&(this.setNeedsRender(0),this._needsWaterReflectionUpdate=!0)}},postRender:()=>{f===this.updating&&f===this.evaluateUpdating()||this.notifyChange("updating")},update:()=>{c.viewCamera=
b.camera;c.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled;this._textureRepository.update();this._screenshotManager.update(c)}})};d._initializeContext=function(a){this._canvas=a.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const b=P.createContextOrErrorHTML(this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==a.stencil?!0:a.stencil,
powerPreference:"high-performance"},a.renderContext);this._rctx=new Q["default"](b,{disabledExtensions:a.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.debugWebGLExtensions||{},maxAnisotropy:8});t.testWebGLDriver(this._rctx);this._loadShaderOnlyExtensions(this._rctx);!a.alpha&&this._rctx.contextAttributes.alpha&&R.error("WebGL context has alpha channel even though no alpha channel was requested");!this._rctx.contextAttributes.alpha&&11<=w("safari")&&(this._container.style.backgroundColor="black");
this._container.appendChild(this._canvas)};d._loadShaderOnlyExtensions=function(a){a=a.capabilities;a.enable("standardDerivatives");a.enable("shaderTextureLOD");a.enable("textureFloat")};p._createClass(n,[{key:"performanceInfo",get:function(){const a=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==a.getUsedTextureMemory?a.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==a.getUsedRenderbufferMemory?a.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==
a.getUsedVBOMemory?a.getUsedVBOMemory():void 0}}},{key:"needsUpdate",get:function(){return this._needsUpdate}},{key:"updating",get:function(){return this.evaluateUpdating()}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(a){this._magnifierHelper.magnifier=a}},{key:"renderingContext",get:function(){return this._rctx}},
{key:"canvas",get:function(){return this._canvas}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"componentObjectCollection",get:function(){r.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new D.ComponentObjectCollection(this._renderer.renderPassManager));return this._componentObjectCollection},set:function(a){this._componentObjectCollection=a}}]);return n}(h.AutoDisposableMixin(u));
g.__decorate([m.property({type:Boolean,readOnly:!0})],e.RenderView.prototype,"updating",null);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_rctx",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_container",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_canvas",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_stippleTextureRepository",void 0);g.__decorate([h.autoDispose(),m.property()],e.RenderView.prototype,"waterTextureRepository",void 0);
g.__decorate([h.autoDispose(),m.property()],e.RenderView.prototype,"_magnifierHelper",void 0);g.__decorate([h.autoDispose(),m.property()],e.RenderView.prototype,"_textureRepository",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_compositingHelper",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_renderer",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_screenshotManager",void 0);g.__decorate([h.autoDispose()],e.RenderView.prototype,"componentObjectCollection",
null);g.__decorate([h.autoDispose()],e.RenderView.prototype,"_componentObjectCollection",void 0);e.RenderView=g.__decorate([B.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);Object.defineProperty(e,"__esModule",{value:!0})});