// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Evented ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ./TextureTechnique ./Util ../../../support/Scheduler ../../../webgl/Texture".split(" "),function(l,p,x,m,h,q,r,y,z,t){const u=m.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");m=function(){function f(a,b,c){this._stage=a;this._rctx=c;this._idToRefCountedTexture=new Map;this._loadingCount=0;this._frameUpdates=new Map;this._fallbackTextureData=
new Uint8Array(256);this._fallbackTextureTransparentData=new Uint8Array(256);this.events=new x;this._textureTechnique=b.acquire(r.TextureTechnique,new r.TextureTechniqueConfiguration);for(b=0;b<this._fallbackTextureData.length;++b)this._fallbackTextureData[b]=255,this._fallbackTextureTransparentData[b]=0!==(b+1)%4?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:this._rctx.parameters.maxMaxAnisotropy};this._frameTask=a.resourceController.scheduler.registerTask(z.TaskPriority.TEXTURE_UNLOAD)}
var d=f.prototype;d.dispose=function(){this._frameTask.remove();h.isSome(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null);h.isSome(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null);this._stage.forEachOfType(4,a=>a.unload())};d.acquire=function(a,b=!1,c){a=this._getOrCreateRef(a,b,c);a.ref();return a};d.update=function(){let a=!1;this._frameUpdates.forEach(b=>{const c=b.texture.frameUpdate(this._rctx,
this._textureTechnique,b.previousToken);0<=c&&c!==b.previousToken&&(b.previousToken=c,a=!0)});a&&this.events.emit("changed",0)};d._getOrCreateRef=function(a,b,c){const e=this._idToRefCountedTexture.get(a);return e?e:this._createNewRef(a,b,c)};d._createNewRef=function(a,b,c){const e=this._stage.getObject(a);y.assert(void 0!==e);const A=e.events.on("unloaded",()=>{A.remove();this._onTextureUnloaded(a)}),g=new v;this._idToRefCountedTexture.set(a,g);const n=e.load(this._rctx,this._textureTechnique);this._loadingCount++;
const w=k=>{this._loadingCount--;this._updateGLTexture(g,k);c&&c(g);e.requiresFrameUpdates&&this._frameUpdates.set(a,{texture:e,previousToken:-1});return g},B=k=>{this._loadingCount--;q.isAbortError(k)||u.error(k)};q.isPromiseLike(n)?(this._updateGLTexture(g,b?this.fallbackTextureTransparent:this.fallbackTexture),n.then(w,B)):w(n);return g};d._updateGLTexture=function(a,b){a.glTexture=b;this.events.emit("changed",1)};d.release=function(a){const b=this._idToRefCountedTexture.get(a);if(b&&(b.unref(),
b.isUnreferenced)){const c=this._stage.getObject(a);this._frameTask.schedule(()=>{b.isUnreferenced&&c.unload()})}};d.getTexture=function(a){return this._stage.getObject(a)};d._onTextureUnloaded=function(a){this._idToRefCountedTexture.delete(a);this._frameUpdates.delete(a)};p._createClass(f,[{key:"updating",get:function(){return 0<this.loadingCount||this._frameTask.updating}},{key:"loadingCount",get:function(){return this._loadingCount}},{key:"fallbackTexture",get:function(){h.isNone(this._fallbackTexture)&&
(this._fallbackTexture=new t(this._rctx,this._fallbackTextureDesc,this._fallbackTextureData));return this._fallbackTexture}},{key:"fallbackTextureTransparent",get:function(){h.isNone(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new t(this._rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData));return this._fallbackTextureTransparent}}]);return f}();let v=function(){function f(){this._refCount=0;this.glTexture=null}var d=f.prototype;d.ref=function(){++this._refCount};
d.unref=function(){0===this._refCount?u.error("Cannot dereference texture that has no references!"):--this._refCount};p._createClass(f,[{key:"isUnreferenced",get:function(){return 0===this._refCount}}]);return f}();l.RefCountedTexture=v;l.TextureRepository=m;Object.defineProperty(l,"__esModule",{value:!0})});