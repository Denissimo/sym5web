// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/vec4 ../../../../chunks/vec4f32 ../../../../chunks/vec4f64 ../../support/debugFlags ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ./glUtil3D ../shaders/HighlightTechnique ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),function(w,p,x,r,y,v,z,A,B,n,C,t,q,D){return function(){function u(a,g){this._techniqueRep=a;
this._rctx=g;this.viewportToRestore=y.create();this.defaultOptions={color:r.fromValues(1,0,1,1),haloColor:r.fromValues(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:r.fromValues(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075};this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}var m=u.prototype;m.assertResources=function(){if(!this.quadVAO){this.quadVAO=
B.createQuadVAO(this._rctx);var a={colorTarget:0,depthStencilTarget:0,width:0,height:0},g={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new t(this._rctx,a,g);this.blur1Fbo=new t(this._rctx,a,g);a=new n.HighlightCompositionTechniqueConfiguration;a.highlightStage=0;a.gridOptimization=!1;this.blurTechnique=this._techniqueRep.acquire(n.HighlightCompositionTechnique,a);a.highlightStage=0;a.gridOptimization=!0;this.blurGridTechnique=this._techniqueRep.acquire(n.HighlightCompositionTechnique,
a);a.highlightStage=1;a.gridOptimization=!1;this.applyTechnique=this._techniqueRep.acquire(n.HighlightCompositionTechnique,a);a.highlightStage=1;a.gridOptimization=!0;this.applyGridTechnique=this._techniqueRep.acquire(n.HighlightCompositionTechnique,a);a.highlightStage=2;a.gridOptimization=!1;this.downsampleTechnique=this._techniqueRep.acquire(n.HighlightCompositionTechnique,a)}};m.dispose=function(){if(this._grid.coverageMipmap)for(let a=1;a<this._grid.coverageMipmap.length;a++)this._grid.coverageMipmap[a].dispose();
this._grid.vao&&this._grid.vao.dispose(!0);this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null);this.blur0Fbo=p.disposeMaybe(this.blur0Fbo);this.blur1Fbo=p.disposeMaybe(this.blur1Fbo)};m.setDefaultOptions=function(a){this.defaultOptions=a};m.render=function(a,g,l){var b=a.pixelRatio;const e=v.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,c=this._rctx;this.assertResources();x.copy(this.viewportToRestore,a.fullViewport);var d=Math.ceil(a.fullWidth/b);b=Math.ceil(a.fullHeight/b);this.blur0Fbo.resize(d,
b);this.blur1Fbo.resize(d,b);c.bindVAO(this.quadVAO);a=null;const f=e?this.blurGridTechnique:this.blurTechnique;f.bindPipelineState(c);c.useProgram(f.program);e?(this._gridUpdateResources(g,32),this._gridComputeMipmap(),a=this._grid.vao,f.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):a=this.quadVAO;c.bindVAO(a);c.bindFramebuffer(this.blur0Fbo);c.setViewport(0,0,d,b);c.setClearColor(0,0,0,0);c.clear(16384);f.program.bindTexture(g.colorTexture,"tex");
f.program.setUniform2f("blurSize",1/d,0);c.drawArrays(f.primitiveType,0,q.vertexCount(a,"geometry"));c.bindFramebuffer(this.blur1Fbo);c.clear(16384);f.program.bindTexture(this.blur0Fbo.colorTexture,"tex");f.program.setUniform2f("blurSize",0,1/b);c.drawArrays(f.primitiveType,0,q.vertexCount(a,"geometry"));d=e?this.applyGridTechnique:this.applyTechnique;c.bindFramebuffer(l);d.bindPipelineState(c);c.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]);
c.useProgram(d.program);d.program.bindTexture(this.blur1Fbo.colorTexture,"tex");d.program.bindTexture(g.colorTexture,"origin");e&&d.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex");d.bindApplyPass(this.defaultOptions);c.drawArrays(d.primitiveType,0,q.vertexCount(a,"geometry"));c.bindVAO(null)};m._gridUpdateResources=function(a,g){const l=this._rctx,b=this._grid;var e=!1;null===b.coverageMipmap&&(b.coverageMipmap=[a],e=!0);if(b.viewportWidth!==a.width||
b.viewportHeight!==a.height)e=!0,b.viewportWidth=a.width,b.viewportHeight=a.height;b.coverageMipmap[0]=a;b.cellPixelSize!==g&&(b.cellPixelSize=g,e=!0);if(e){for(g=1;g<b.coverageMipmap.length;g++)b.coverageMipmap[g].dispose();b.mipmapLevels=Math.ceil(Math.log(b.cellPixelSize)*Math.LOG2E);b.coverageMipmap.length=b.mipmapLevels+1;for(g=0;g<b.mipmapLevels;g++)e=b.coverageMipmap[g],b.coverageMipmap[g+1]=new t(l,{colorTarget:0,depthStencilTarget:0,width:Math.ceil(e.width/2),height:Math.ceil(e.height/2)},
{target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(e.width/2),height:Math.ceil(e.height/2)})}e=Math.ceil(a.height/b.cellPixelSize);var c=Math.ceil(a.width/b.cellPixelSize);if(!b.vao||b.verticalCellCount!==e||b.horizontalCellCount!==c){b.verticalCellCount=e;b.horizontalCellCount=c;a=e+1;g=c+1;e=1/e;c=1/c;const d=new Float32Array(24*a*g);let f=0;for(let h=0;h<a;h++)for(let k=0;k<g;k++)d[f+0]=(k-.5)*c*2-1,d[f+1]=(h-.5)*e*2-1,d[f+2]=k*c,d[f+3]=h*e,d[f+4]=(k+
.5)*c*2-1,d[f+5]=(h-.5)*e*2-1,d[f+6]=k*c,d[f+7]=h*e,d[f+8]=(k-.5)*c*2-1,d[f+9]=(h+.5)*e*2-1,d[f+10]=k*c,d[f+11]=h*e,d[f+12]=(k-.5)*c*2-1,d[f+13]=(h+.5)*e*2-1,d[f+14]=k*c,d[f+15]=h*e,d[f+16]=(k+.5)*c*2-1,d[f+17]=(h-.5)*e*2-1,d[f+18]=k*c,d[f+19]=h*e,d[f+20]=(k+.5)*c*2-1,d[f+21]=(h+.5)*e*2-1,d[f+22]=k*c,d[f+23]=h*e,f+=24;b.vao&&b.vao.dispose(!0);b.vao=new D(l,z.Default3D,{geometry:A.Pos2Tex},{geometry:C.createVertex(l,35044,d)})}};m._gridComputeMipmap=function(){const a=this._rctx,g=this._grid,l=this.downsampleTechnique.program;
this.downsampleTechnique.bindPipelineState(a);a.bindVAO(this.quadVAO);a.useProgram(l);for(let b=0;b<g.mipmapLevels;b++){a.bindFramebuffer(g.coverageMipmap[b+1]);l.bindTexture(g.coverageMipmap[b].colorTexture,"tex");const e=g.coverageMipmap[b+1].width,c=g.coverageMipmap[b+1].height;l.setUniform2f("invFramebufferDim",1/e,1/c);a.setViewport(0,0,e,c);a.drawArrays(5,0,q.vertexCount(this.quadVAO,"geometry"))}};m.getGpuMemoryUsage=function(){let a=(p.isSome(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+
(p.isSome(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const g of this._grid.coverageMipmap)a+=g.gpuMemoryUsage;return a};w._createClass(u,[{key:"profilingCallback",get:function(){return v.HIGHLIGHTS_PROFILE_TO_CONSOLE?a=>console.log(a):null}},{key:"test",get:function(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}]);return u}()});