// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../support/buffer/glUtil ../../lib/ResizableFloat32Array ../../lib/Util ../WaterGLMaterial ./Instance ./utils ../../statistics/RendererPerformanceInfo ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(H,E,t,A,B,I,J,y,K,v,C,F,L,M,N){function O(x,p,b,a){const d=new Map,
e=p.vertexBufferLayout.stride/4,h=(f,k)=>{var c=f.origin;if(!t.isNone(c)){var g=x.get(c.id),l=d.get(c.id);null==l&&(l={optimalCount:null==g?0:g.optimalCount,sparseCount:null==g?0:g.buffer.size,toAdd:[],toRemove:[],origin:c.vec3},d.set(c.id,l));c=p.elementCount(f.data)*e;k?(l.optimalCount+=c,l.sparseCount+=c,l.toAdd.push(f)):(l.optimalCount-=c,l.toRemove.push(f))}};for(const f of b)h(f,!0);for(const f of a)h(f,!1);return d}let R=function(){function x(b,a,d){this.type="MergedRenderer";this._dataByOrigin=
new Map;this._hasOccludees=this._hasHighlights=!1;this._rctx=b;this._material=d;this._materialRep=a;this._glMaterials=C.acquireMaterials(this._material,this._materialRep);this._bufferWriter=d.createBufferWriter()}var p=x.prototype;p.dispose=function(){C.releaseMaterials(this._material,this._materialRep);this._dataByOrigin&&(this._dataByOrigin.forEach(b=>{b.vao.dispose(!0);b.vao=null}),this._dataByOrigin.clear(),this._dataByOrigin=null);this._glMaterials&&(this._glMaterials.forEach(b=>{b&&b.dispose()}),
this._glMaterials.clear(),this._glMaterials=null)};p.modify=function(b){this.updateGeometries(b.updates);this.addAndRemoveGeometries(b.adds,b.removes);this.updateRenderCommands()};p.addAndRemoveGeometries=function(b,a){const d=this._bufferWriter,e=d.vertexBufferLayout,h=e.stride/4,f=this._dataByOrigin,k=O(f,d,b,a);k.forEach((c,g)=>{k.delete(g);var l=c.optimalCount;const q=c.sparseCount;let m=f.get(g);if(null==m)y.assert(0<l),m=this.createData(e,l,c.origin),f.set(g,m);else if(0===l){m.vao.dispose(!0);
m.vao=null;f.delete(g);return}const n=l<c.sparseCount/2;g=P;const u=m.buffer.size,r=m.buffer.array;l=m.buffer.resize(n?l:q,!1);n||l?this.removeAndRebuild(m,c.toRemove,h,r,g):0<c.toRemove.length?(this.removeByErasing(m,c.toRemove,h,g),0<c.toAdd.length&&(g.end=u)):(g.begin=u,g.end=u);l=Q;y.setMatrixTranslation3(l,-c.origin[0],-c.origin[1],-c.origin[2]);this.append(m,c.toAdd,h,l,g);c=m.vao.vertexBuffers.geometry;if(c.byteSize!==m.buffer.array.buffer.byteLength)c.setData(m.buffer.array);else{const {begin:z,
end:G}=g;z<G&&(g=4*z,c.setSubData(m.buffer.array,g,g,4*G))}m.drawCommandsDirty=!0})};p.updateGeometries=function(b){const a=this._bufferWriter,d=a.vertexBufferLayout.stride/4;for(const f of b){var e=f.updateType;b=f.renderGeometry;const k=this._dataByOrigin.get(b.origin.id),c=k&&k.instances.get(b.id);if(!c)break;e&1&&(c.isVisible=b.instanceParameters.visible);if(e&9){var h=b.instanceParameters.visible;c.hasHighlights=!!b.instanceParameters.highlights&&h}e&16&&(c.hasOccludees=!!b.instanceParameters.occludees);
e&6&&(e=k.buffer.array,h=k.vao,C.calculateTransformRelativeToOrigin(b,D,w),a.write({transformation:D,invTranspTransformation:w},b.data,a.vertexBufferLayout.createView(e.buffer),c.from),y.assert(c.from+a.elementCount(b.data)===c.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(e,c.from*d*4,c.from*d*4,c.to*d*4));k.drawCommandsDirty=!0}};p.updateRenderCommands=function(){this._hasOccludees=this._hasHighlights=!1;this._dataByOrigin.forEach(a=>{a.hasHiddenInstances=!1;a.hasHighlights=
!1;a.hasOccludees=!1;E.someMap(a.instances,d=>{d.isVisible?(d.hasHighlights&&(this._hasHighlights=!0,a.hasHighlights=!0),d.hasOccludees&&(this._hasOccludees=!0,a.hasOccludees=!0)):a.hasHiddenInstances=!0;return a.hasHiddenInstances&&a.hasHighlights&&a.hasOccludees})});const b=a=>{a.drawCommandsDefault=null;a.drawCommandsHighlight=null;a.drawCommandsOccludees=null;a.drawCommandsShadowHighlightRest=null;a.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0};if(0!==a.instances.size)if(a.hasOccludees||
a.hasHighlights||a.hasHiddenInstances){var d=v.sortInstancesAccordingToRange([...a.instances.values()]);a.drawCommandsDefault=[];a.drawCommandsHighlight=[];a.drawCommandsOccludees=[];a.drawCommandsShadowHighlightRest=[];for(const e of d)e.isVisible&&(e.hasOccludees?v.addOrMerge(a.drawCommandsOccludees,e):v.addOrMerge(a.drawCommandsDefault,e),e.hasHighlights?v.addOrMerge(a.drawCommandsHighlight,e):v.addOrMerge(a.drawCommandsShadowHighlightRest,e));d=e=>{let h=0;for(const f of e)h+=f.count;return h/
3};a.stats={default:d(a.drawCommandsDefault),highlight:d(a.drawCommandsHighlight),occludees:d(a.drawCommandsOccludees),shadowHighlightRest:d(a.drawCommandsShadowHighlightRest)}}else d=4*a.buffer.size/M.getStride(a.vao.layout.geometry),a.drawCommandsDefault=[{first:0,count:d}],a.stats={default:d,highlight:0,occludees:0,shadowHighlightRest:0}};this._dataByOrigin.forEach(a=>{a.drawCommandsDirty&&(b(a),a.drawCommandsDirty=!1)})};p.updateLogic=function(b){return this._material.update(b)};p.render=function(b,
a,d,e){const h=this._rctx,f=this._glMaterials.get(a),k=5===a||7===a,c=6===a,g=!(k||c);3===a&&null===b&&(b=22);if(!f||2!==f.ensureResources(h)||null!=b&&!f.beginSlot(b)||k&&!this._hasHighlights)return!1;f.ensureParameters(d);const l=f.getPipelineState(b,!1);h.setPipelineState(l);const q=f.technique;h.useProgram(q.program);f.bind(d);let m=!1;this._dataByOrigin.forEach(n=>{if(!(t.isNone(n.drawCommandsDefault)&&t.isNone(n.drawCommandsHighlight)&&t.isNone(n.drawCommandsOccludees)&&t.isNone(n.drawCommandsShadowHighlightRest)||
k&&!n.hasHighlights)){d.origin=n.origin;q.bindDraw(d,{},{});q.ensureAttributeLocations(n.vao);h.bindVAO(n.vao);var u=q.primitiveType,r=k?n.drawCommandsHighlight:c&&(n.hasOccludees||n.hasHighlights||n.hasHiddenInstances)?n.drawCommandsShadowHighlightRest:n.drawCommandsDefault;t.isSome(r)&&(this.renderCommands(h,u,r),F.addToRenderStats(r.length,k?n.stats.highlight:c&&(n.hasOccludees||n.hasHighlights||n.hasHiddenInstances)?n.stats.shadowHighlightRest:n.stats.default,e),m=!0);if(g&&(r=n.drawCommandsOccludees,
t.isSome(r))){const z=f.getPipelineState(b,!0);h.setPipelineState(z);this.renderCommands(h,u,r);h.setPipelineState(l);F.addToRenderStats(r.length,n.stats.occludees,e);m=!0}}});return m};p.renderCommands=function(b,a,d){for(let e=0;e<d.length;e++)b.drawArrays(a,d[e].first,d[e].count)};p.createData=function(b,a,d){return{instances:new Map,vao:new N(this._rctx,this._material.vertexAttributeLocations,{geometry:I.glLayout(b)},{geometry:L.createVertex(this._rctx,35044)}),buffer:new J.ResizableFloat32Array(a),
optimalCount:0,origin:d,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}};p.removeAndRebuild=function(b,a,d,e,h){for(const q of a){a=q.id;const m=b.instances.get(a);b.optimalCount-=(m.to-m.from)*d;b.instances.delete(a)}let f=0;const k=b.buffer.array;h.begin=0;h.end=0;let c=-1,g=-1,l=0;b.instances.forEach(q=>
{const m=q.from*d,n=q.to*d,u=n-m;c!==g&&g!==m?(k.set(e.subarray(c,g),l),l+=g-c,c=m):-1===c&&(c=m);g=n;q.from=f/d;f+=u;q.to=f/d});c!==g&&k.set(e.subarray(c,g),l);h.end=f};p.removeByErasing=function(b,a,d,e){e.begin=Infinity;e.end=-Infinity;let h=-1,f=-1;for(const c of a){a=c.id;var k=b.instances.get(a);const g=k.from*d;k=k.to*d;h!==f&&f!==g?(b.buffer.erase(h,f),h=g):-1===h&&(h=g);f=k;b.instances.delete(a);b.optimalCount-=k-g;g<e.begin&&(e.begin=g);k>e.end&&(e.end=k)}h!==f&&b.buffer.erase(h,f)};p.append=
function(b,a,d,e,h){const f=this._bufferWriter;for(const c of a){var k=t.isSome(c.transformation)?A.multiply(D,e,c.transformation):e;A.invert(w,k);A.transpose(w,w);a=h.end;f.write({transformation:k,invTranspTransformation:w},c.data,f.vertexBufferLayout.createView(b.buffer.array.buffer),h.end/d);k=f.elementCount(c.data)*d;const g=a+k;y.assert(null==b.instances.get(c.id));const l=c.instanceParameters.visible;a=new v.Instance(a/d,g/d,l,!!c.instanceParameters.highlights&&l,!!c.instanceParameters.occludees);
b.instances.set(c.id,a);b.optimalCount+=k;h.end+=k}};H._createClass(x,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&E.someMap(this._glMaterials,b=>b instanceof K.WaterGLMaterial)}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"test",get:function(){return{material:this._material,
glMaterials:this._glMaterials}}}]);return x}();const P={begin:0,end:0},Q=B.create(),D=B.create(),w=B.create();return R});