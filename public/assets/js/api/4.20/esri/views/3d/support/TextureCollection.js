// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../core/promiseUtils ../../../core/urlUtils ../webgl-engine/lib/Texture ../webgl-engine/lib/WebGLDriverTest ../../support/Scheduler".split(" "),function(m,p,q,l,u,v,w,r){let t=function(){function n(a,b,c,d){this._streamDataRequester=a;this._stage=b;this._textureOptions=c;this._textureRequests=new Map;this._frameTask=q.isSome(d)?d.registerTask(r.TaskPriority.TEXTURE_UNLOAD):r.ImmediateTask}var e=n.prototype;e.destroy=
function(){this._frameTask.remove();this._textureRequests.forEach(a=>this.releaseTextureRequest(a));this._textureRequests.clear()};e.fromUrl=function(){var a=p._asyncToGenerator(function*(b,c,d){l.throwIfAborted(d);const x=q.isSome(d)&&d.signal,h=this.makeUid(b,c);let g=this._textureRequests.get(h);if(!g){d=l.createAbortController();const k=this._streamDataRequester.request(b,"image",{uid:h,signal:d.signal});g={referenceCount:0,texture:null,textureAsync:null,abortController:d};this._textureRequests.set(h,
g);g.textureAsync=k.then(f=>{f=this.createTexture(b,f,c);g.texture=f;g.abortController=null;this.addToStage(f);return{uid:h,texture:f}},f=>{g.abortController=null;throw f;})}g.referenceCount++;return(new Promise((k,f)=>{l.onAbort(x,()=>{f(l.createAbortError())});g.textureAsync.then(k,f)})).catch(k=>{this.release(h);throw k;})});return function(b,c,d){return a.apply(this,arguments)}}();e.fromData=function(a,b){a=this.makeUid(a);let c=this._textureRequests.get(a);c||(c={referenceCount:0,texture:b(),
textureAsync:null,abortController:null},this.addToStage(c.texture),this._textureRequests.set(a,c));c.referenceCount++;return{uid:a,texture:c.texture}};e.release=function(a){if(this._textureRequests){var b=this._textureRequests.get(a);b?(1>b.referenceCount&&console.warn("TextureCollection: reference count is \x3c 1 for "+a),b.referenceCount--,1>b.referenceCount&&this._frameTask.schedule(()=>this.releaseNow(a))):console.warn(`TextureCollection: texture doesn't exist: '${a}'`)}};e.releaseNow=function(a){if(this._textureRequests){var b=
this._textureRequests.get(a);!b||0<b.referenceCount||(this.releaseTextureRequest(b),this._textureRequests.delete(a))}};e.releaseTextureRequest=function(a){a.texture?this.removeFromStage(a.texture):a.abortController&&(a.abortController.abort(),a.abortController=null)};e.createTexture=function(a,b,c){const d={...this._textureOptions,powerOfTwoResizeMode:2};if(u.isSVG(a)){if(c||0===b.width&&0===b.height)a=b.width?b.height/b.width:1,c=c||64,1<a?(b.width=Math.round(c/a),b.height=c):(b.width=c,b.height=
Math.round(c*a));this._stage.renderView&&w.testWebGLDriver(this._stage.renderView.renderingContext).svgAlwaysPremultipliesAlpha&&(d.preMultiplyAlpha=!1)}d.width=b.width;d.height=b.height;return new v.Texture(b,d)};e.addToStage=function(a){this._stage.add(a)};e.removeFromStage=function(a){this._stage.remove(a)};e.makeUid=function(a,b){return null!=b?`${a}.${b}px`:a};p._createClass(n,[{key:"test",get:function(){return{textureRequests:this._textureRequests}}}]);return n}();m.TextureCollection=t;m.default=
t;Object.defineProperty(m,"__esModule",{value:!0})});