// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../Color ../../../../../core/Collection ../../../../../core/Handles ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/Logger ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/trackingUtils ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/Point ../../../../../geometry/support/lineSegment ./LineOfSightRayIntersector ./LineOfSightToolConfiguration ./lineOfSightToolUtils ../../graphics/LineOfSight/LineOfSightAnalysis ../../graphics/LineOfSight/LineOfSightController ../../graphics/LineOfSight/LineOfSightView ../../visualElements/LaserlineVisualElement ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../support/Scheduler ../../../../../widgets/LineOfSight/LineOfSightTarget".split(" "),
function(h,x,m,E,A,B,v,f,y,n,U,V,W,X,K,l,u,w,L,F,M,N,C,G,O,P,Q,H,R,q,D){A=A.ofType(D);h.LineOfSightTool=function(I){function z(a){var b=I.call(this,a)||this;b._showTracker=!0;b._someManipulatorsFocused=!1;b._tasks=q.ImmediateTask;b._laserlineVisualElement=null;b._grabbedManipulator=null;b._handles=new B;b._manipulatorHandles=new B;b._analysisHandles=new B;b.lineOfSightView=new P.LineOfSightView({model:a.model,view:a.view});b.lineOfSightController=new O.LineOfSightController({model:a.model,view:a.view});
return b}x._inheritsLoose(z,I);var e=z.prototype;e.initialize=function(){var a;const b=l.reactionInit(()=>this.state,g=>{switch(g){case "created":this.complete();break;default:this.finishToolCreation()}});this._intersector=new M.LineOfSightRayIntersector({view:this.view});const c=this._handles,d=null==(a=this.view.resourceController)?void 0:a.scheduler;d&&(this._tasks=d.registerTask(q.TaskPriority.LINE_OF_SIGHT_TOOL));this._observerManipulator=this._createObserverManipulator();c.add([b,l.reaction(()=>
({...this.configuration.observer}),()=>this._updateObserverManipulatorStyle()),this._createLineOfSightTracker(),l.reactionInit(()=>this.model.observer,g=>this._onObserverChange(g)),l.reactionInit(()=>({...this.configuration.laserLine}),()=>this._createVisualElements()),this._connectAnalyses()]);f.applySome(this.view.pointsOfInterest,g=>c.add(this._connectObserverToContentChange(g)));this.continue()};e.destroy=function(){this.detach();this.manipulators.remove(this._observerManipulator);this.lineOfSightView.destroy();
this.lineOfSightController.destroy();this._handles=f.destroyMaybe(this._handles);this._analysisHandles=f.destroyMaybe(this._analysisHandles);this._manipulatorHandles=f.destroyMaybe(this._manipulatorHandles);this._removeVisualElements();this._intersector=null;this._set("model",null)};e.continue=function(){this.view.activeTool=this;this._showTracker=!0;this._manipulatorFocusChanged()};e.stop=function(){this._showTracker=!1;this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE);this._manipulatorFocusChanged()};
e.onInputEvent=function(a){switch(a.type){case "immediate-double-click":this._doubleClickHandler(a);break;case "key-down":this._keyDownHandler(a);break;case "pointer-move":this._pointerMoveHandler(a)}};e.onInputEventAfter=function(a){switch(a.type){case "immediate-click":this._clickHandler(a)}};e.onShow=function(){this.model.visible=!0};e.onHide=function(){this.model.visible=!1};e._setPriority=function(a){this._tasks.priority=a;this.lineOfSightController.priority=a};e._createLineOfSightTracker=function(){const a=
new D({location:new L}),b=new G.LineOfSightAnalysis({target:a}),c=this._createTargetManipulator(b);c.available=!1;c.interactive=!1;const d=this.lineOfSightView.createLineOfSightVisualization(),g={analysis:b,interpolationInfo:{originalIntersection:w.create(),originalObserver:w.create(),originalTarget:w.create()}};let k=null;const p=l.reactionInit(()=>this._shouldRenderTracker,r=>{k=f.removeMaybe(k);d.visibleLineVisualElement.attached=r;d.occludedLineVisualElement.attached=r;(d.undefinedLineVisualElement.attached=
r)&&(k=v.handlesGroup([l.reaction(()=>({...this.configuration.target}),()=>this._updateTargetManipularStyle(c)),l.reactionInit(()=>this._observerEngineLocation,t=>this._onObserverEngineLocationChange(c,t)),l.reactionInit(()=>this.lineOfSightController.getLineOfSightComputationDependencies(b),()=>this.lineOfSightController.computeAnalysis(g,!0)),l.reactionInit(()=>this.lineOfSightView.getLineOfSightVisualizationDependencies(b),()=>this.lineOfSightView.updateLineOfSightVisualization(b,d)),l.reactionInit(()=>
this._getLineOfSightManipulatorStateDependencies(b),()=>this._updateManipulatorState(c)),l.reaction(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:t})=>this._onCameraChange(c,t)),l.reaction(()=>f.mapOr(this.view.map,1,t=>t.ground.opacity),(t,S)=>this._onGroundOpacityChange(c,t,S)),l.reactionInit(()=>this.view.slicePlane,()=>this._onSlicePlaneChange(c)),l.reaction(()=>b.target.location,t=>this._onTargetLocationChange(c,t))]))});this._trackerManipulator=c;return v.makeHandle(()=>
{p.remove();k=f.removeMaybe(k);this.lineOfSightView.destroyLineOfSightVisualization(d);this._removeManipulator(c)})};e._removeManipulator=function(a){this.manipulators.remove(a);this._manipulatorHandles.remove(a);a.metadata=null};e._createManipulator=function(a,b,c){const d=C.createSphereManipulator(this.view,a);d.metadata=c;this._manipulatorHandles.add([b(d),d.events.on("focus-changed",()=>this._manipulatorFocusChanged()),d.events.on("grab-changed",g=>this._manipulatorGrabChanged(d,g)),d.events.on("immediate-click",
g=>g.stopPropagation())],d);this.manipulators.add(d);this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE);return d};e._createTargetManipulator=function(a,b,c){const d=this.configuration;a=this._createManipulator({size:d.target.size,customColor1:d.target.visibleColor,customColor2:d.target.occludedColor,customColor3:d.target.undefinedColor},g=>this._createTargetManipulatorDragPipeline(g),{analysis:a,intersection:c});this._setTargetManipulatorLocation(a,b);return a};e._createObserverManipulator=
function(){const a=this.configuration;return this._createManipulator({size:a.observer.size,color:a.observer.color,visible:!0},b=>this._createObserverManipulatorDragPipeline(b),null)};e._updateTargetManipularStyle=function(a){const b=this.configuration.target;a.renderObjects=C.createSphereManipulatorRenderObjects({size:b.size,customColor1:b.visibleColor,customColor2:b.occludedColor,customColor3:b.undefinedColor})};e._updateObserverManipulatorStyle=function(){const a=this._observerManipulator,b=this.configuration.observer;
a.renderObjects=C.createSphereManipulatorRenderObjects({size:b.size,color:b.color,visible:a.available})};e._manipulatorFocusChanged=function(){this._someManipulatorsFocused=this.manipulators.some(a=>a.manipulator.focused);this._updateLaserLineRenderer()};e._screenToIntersection=function(){return a=>{const b=this._intersector.getScreenPointIntersection(a.screenEnd);return f.isNone(b)?null:{...a,intersection:b}}};e._createTargetManipulatorDragPipeline=function(a){return H.createManipulatorDragEventPipeline(a,
(b,c,d)=>{c.next(this._screenToIntersection()).next(this._updateAnalysisDragStep(a)).next(()=>this._updateLaserLineRenderer());d.next(this._cancelAnalysisDragStep(a)).next(()=>this._updateLaserLineRenderer())})};e._createObserverManipulatorDragPipeline=function(a){return H.createManipulatorDragEventPipeline(a,(b,c,d)=>{c.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer());d.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})};
e._updateObserverDragStep=function(){return a=>{this.model.observer=a.intersection.point;this._observerManipulator.metadata=a.intersection;return a}};e._cancelObserverDragStep=function(){const a=f.isSome(this.model.observer)?this.model.observer.clone():null,b=this._observerManipulator.metadata;return c=>{this.model.observer=a;this._observerManipulator.metadata=b;return c}};e._updateAnalysisDragStep=function(a){return b=>{a.metadata.analysis.target.location=b.intersection.point;a.metadata.intersection=
b.intersection;return b}};e._cancelAnalysisDragStep=function(a){const {metadata:b}=a,{analysis:c,intersection:d}=b,g=f.mapOr(c.target.location,null,k=>k.clone());return k=>{c.target.location=g;a.metadata.intersection=d;return k}};e._manipulatorGrabChanged=function(a,b){switch(b.action){case "start":this._grabbedManipulator=a;break;case "end":this._grabbedManipulator===a&&(this._grabbedManipulator=null)}this._manipulatorFocusChanged()};e._updateManipulatorState=function(a){const {isValid:b,isTargetVisible:c}=
a.metadata.analysis.computationResult;a.state=b?c?16:32:64};e._getLineOfSightManipulatorStateDependencies=function(a){const {isValid:b,isTargetVisible:c}=a.computationResult;return{isValid:b,isTargetVisible:c}};e._setTargetManipulatorLocation=function(a,b){f.isNone(b)||(a.location=b,this._onTargetManipulatorLocationChange(a))};e._updateLaserLineRenderer=function(){if(!f.isNone(this._laserlineVisualElement)){var a=this._laserlineVisualElement,b=f.isSome(this._grabbedManipulator)?this._grabbedManipulator:
this._shouldRenderTracker&&this.model.observer?this._trackerManipulator:null;this.configuration.laserLine.enabled&&f.isSome(b)?(a.heightManifoldTarget=b.renderLocation,a.lineVerticalPlaneSegment=b!==this._observerManipulator?F.fromPoints(this._observerManipulator.renderLocation,b.renderLocation,T):null):(a.heightManifoldTarget=null,a.lineVerticalPlaneSegment=null)}};e._createVisualElements=function(){const a=this.configuration.laserLine;this._removeVisualElements();this._laserlineVisualElement=new Q.LaserlineVisualElement({view:this.view,
attached:!0,style:{glowColor:E.toUnitRGB(a.glowColor),glowWidth:a.glowWidth,innerColor:E.toUnitRGB(a.innerColor),innerWidth:a.innerWidth,globalAlpha:a.globalAlpha}});this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)};e._removeVisualElements=function(){f.isSome(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)};e._onObserverChange=function(a){f.isNone(a)?this._observerManipulator.available=!1:(this._observerManipulator.metadata=
null,this._observerManipulator.available=!0,this._observerManipulator.location=a,this._setTargetManipulatorLocation(this._trackerManipulator,a),this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE))};e._onTargetLocationChange=function(a,b){a.metadata.intersection=null;this._setTargetManipulatorLocation(a,b);this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)};e._onGroundOpacityChange=function(a,b,c){1!==b&&1!==c||b===c||(this._onTargetManipulatorLocationChange(a),this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE))};
e._onCameraChange=function(a,b){const {analysis:c}=a.metadata;if(!c.inputPoints.isValid||b)this._onTargetManipulatorLocationChange(a),this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)};e._onSlicePlaneChange=function(a){this._onTargetManipulatorLocationChange(a);this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)};e._onObserverEngineLocationChange=function(a,b){const {analysis:c}=a.metadata,{inputPoints:d}=c,{observer:g}=d;u.copy(g,b);this._adjustInputPoints(d,this._observerManipulator.metadata,
a.metadata.intersection);c.updateInputPoints()};e._onTargetManipulatorLocationChange=function(a){const b=this.view.renderCoordsHelper;if(!f.isNone(b)){var {metadata:c}=a,{analysis:d,intersection:g}=c;({inputPoints:c}=d);var {target:k}=c;b.toRenderCoords(a.location,k);this._adjustInputPoints(c,this._observerManipulator.metadata,g);d.updateInputPoints()}};e._onAnalysesCollectionChange=function(a){a.added.forEach(b=>this._connectAnalysis(b));a.removed.forEach(b=>this._disconnectAnalysis(b))};e._addPointFromClickEvent=
function(a){a=this._intersector.getScreenPointIntersection(a);if(!f.isNone(a)&&!f.isNone(a.point))if(this.model.observer){const b=new D({location:a.point}),c=new G.LineOfSightAnalysis({target:b});this._connectAnalysis(c,a);this._analyses.add(c);this.model.targets.add(b)}else this.model.observer=a.point,this._observerManipulator.metadata=a};e._clickHandler=function(a){this._showTracker&&(this._addPointFromClickEvent({x:a.x,y:a.y}),a.stopPropagation())};e._doubleClickHandler=function(a){this._showTracker&&
(this.stop(),a.stopPropagation())};e._keyDownHandler=function(a){this._showTracker&&"Escape"===a.key&&(this.stop(),a.stopPropagation())};e._pointerMoveHandler=function(a){this._showTracker&&(a=this._intersector.getScreenPointIntersection({x:a.x,y:a.y}),f.isSome(a)&&(this._setTargetManipulatorLocation(this._trackerManipulator,a.point),this._updateLaserLineRenderer(),this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)))};e._refineObserverManipulatorPosition=function(){const a=this._observerManipulator;
var b=a.metadata;1>this._analyses.length||f.isNone(b)||(b=this._intersector.updateFromIntersectionResult(b),f.isNone(b)||(a.location=b,b=w.create(),this.view.renderCoordsHelper.toRenderCoords(a.location,b),this._observerEngineLocation=b))};e._refineTargetManipulatorPosition=function(a){var {intersection:b}=a.metadata;f.isNone(b)||(b=this._intersector.updateFromIntersectionResult(b),this._setTargetManipulatorLocation(a,b))};e._adjustInputPoints=function(a,b,c){const d=J,{observer:g,target:k,observerAdjusted:p,
targetAdjusted:r}=a;f.isSome(b)?u.copy(d,b.normal):u.subtract(d,k,g);a=this._screenPixelSize;u.normalize(d,d);u.scale(d,d,Math.min(a,1));u.add(p,g,d);f.isSome(c)?u.copy(d,c.normal):u.subtract(d,g,k);c=this.view.state.camera.computeScreenPixelSizeAt(k);u.normalize(d,d);u.scale(d,d,Math.min(c,1));u.add(r,k,d)};e._connectAnalyses=function(){let a=null;return v.handlesGroup([l.reactionInit(()=>this._analyses,b=>{a=f.removeMaybe(a);a=b.on("change",c=>this._onAnalysesCollectionChange(c));this._onAnalysesCollectionChange({target:b,
added:b.items,removed:[],moved:[]})}),v.makeHandle(()=>a=f.removeMaybe(a))])};e._connectAnalysis=function(a,b){const c=this._analysisHandles;if(!c.has(a)){var {target:d}=a,g=this._createTargetManipulator(a,d.location,b),k=[l.reactionInit(()=>this._getLineOfSightManipulatorStateDependencies(a),()=>this._updateManipulatorState(g)),l.reactionInit(()=>this._observerEngineLocation,p=>this._onObserverEngineLocationChange(g,p)),l.reaction(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),
({isDirty:p})=>this._onCameraChange(g,p)),l.reaction(()=>f.mapOr(this.view.map,1,p=>p.ground.opacity),(p,r)=>this._onGroundOpacityChange(g,p,r)),l.reactionInit(()=>this.view.slicePlane,()=>this._onSlicePlaneChange(g)),l.reaction(()=>a.target.location,p=>this._onTargetLocationChange(g,p)),l.reaction(()=>({...this.configuration.target}),()=>this._updateTargetManipularStyle(g)),v.makeHandle(()=>{this._removeManipulator(g)})];f.applySome(this.view.pointsOfInterest,p=>k.push(this._connectTargetToContentChange(g,
p)));c.add(k,a);this._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE)}};e._disconnectAnalysis=function(a){this._analysisHandles.remove(a)};e._connectObserverToContentChange=function(a){var b=this;let c=f.none;const d=()=>{c=f.abortMaybe(c);f.isNone(this._observerManipulator.metadata)||(c=y.createTask(function(){var p=x._asyncToGenerator(function*(r){b._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE);yield y.ignoreAbortErrors(b._tasks.schedule(()=>b._refineObserverManipulatorPosition(),
r))});return function(r){return p.apply(this,arguments)}}()))},g=a.contentGeometryUpdates.events.on("request-update",d),k=this.view.elevationProvider.on("elevation-change",d);return v.makeHandle(()=>{c=f.abortMaybe(c);g.remove();k.remove()})};e._connectTargetToContentChange=function(a,b){var c=this;let d=f.none;const g=()=>{d=f.abortMaybe(d);d=y.createTask(function(){var r=x._asyncToGenerator(function*(t){c._setPriority(q.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE);yield y.ignoreAbortErrors(c._tasks.schedule(()=>
{c._refineTargetManipulatorPosition(a);c._onTargetManipulatorLocationChange(a)},t))});return function(t){return r.apply(this,arguments)}}())},k=b.contentGeometryUpdates.events.on("request-update",g),p=this.view.elevationProvider.on("elevation-change",g);return v.makeHandle(()=>{d=f.abortMaybe(d);k.remove();p.remove()})};x._createClass(z,[{key:"state",get:function(){return this._showTracker?"creating":f.isSome(this.model.observer)?"created":"ready"}},{key:"cursor",get:function(){return this._someManipulatorsFocused?
null:this._showTracker?"crosshair":null}},{key:"isSupported",get:function(){var a;return"3d"===(null==(a=this.view)?void 0:a.type)}},{key:"updating",get:function(){return f.mapOr(this._tasks,!1,a=>a.updating)||f.mapOr(this.lineOfSightController,!1,a=>a.updating)}},{key:"configuration",get:function(){return this._viewData.configuration},set:function(a){this._viewData.configuration=a}},{key:"_viewData",get:function(){return this.model.viewData}},{key:"_screenPixelSize",get:function(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}},
{key:"_analyses",get:function(){return this._viewData.analyses}},{key:"_observerEngineLocation",get:function(){return this._viewData.observerEngineLocation},set:function(a){this._viewData.observerEngineLocation=a}},{key:"_shouldRenderTracker",get:function(){return this._showTracker&&f.isSome(this.model.observer)&&!this._someManipulatorsFocused}},{key:"_isCameraDirty",get:function(){var a=this.model.observer;const {view:b}=this,{renderCoordsHelper:c}=b;if(f.isNone(a)||f.isNone(c))return!1;const d=
J;c.toRenderCoords(a,d);a=b.state.camera.computeScreenPixelSizeAt(d);return.1<Math.abs((a-this._screenPixelSize)/this._screenPixelSize)}}]);return z}(R.InteractiveToolBase);m.__decorate([n.property({constructOnly:!0})],h.LineOfSightTool.prototype,"view",void 0);m.__decorate([n.property({constructOnly:!0})],h.LineOfSightTool.prototype,"model",void 0);m.__decorate([n.property({constructOnly:!0})],h.LineOfSightTool.prototype,"lineOfSightView",void 0);m.__decorate([n.property({constructOnly:!0})],h.LineOfSightTool.prototype,
"lineOfSightController",void 0);m.__decorate([n.property({readOnly:!0})],h.LineOfSightTool.prototype,"state",null);m.__decorate([n.property({readOnly:!0})],h.LineOfSightTool.prototype,"cursor",null);m.__decorate([n.property({readOnly:!0})],h.LineOfSightTool.prototype,"isSupported",null);m.__decorate([n.property({readOnly:!0})],h.LineOfSightTool.prototype,"updating",null);m.__decorate([n.property({type:N.LineOfSightToolConfiguration})],h.LineOfSightTool.prototype,"configuration",null);m.__decorate([n.property()],
h.LineOfSightTool.prototype,"_viewData",null);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_screenPixelSize",null);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_showTracker",void 0);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_analyses",null);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_observerEngineLocation",null);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_shouldRenderTracker",null);m.__decorate([n.property()],h.LineOfSightTool.prototype,
"_someManipulatorsFocused",void 0);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_isCameraDirty",null);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_tasks",void 0);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_laserlineVisualElement",void 0);m.__decorate([n.property()],h.LineOfSightTool.prototype,"_grabbedManipulator",void 0);h.LineOfSightTool=m.__decorate([K.subclass("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],h.LineOfSightTool);const J=
w.create(),T=F.create();h.LineOfSightTargetCollection=A;Object.defineProperty(h,"__esModule",{value:!0})});