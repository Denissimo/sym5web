// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/promiseUtils ../../../../chunks/vec4f64 ../lib/AutoDisposable ../../../support/screenshotUtils ../../../webgl/FramebufferObject".split(" "),function(p,r,t,u,v,m,l,w){m=function(q){function n(c,a,b,d=null,f,k=!0){var e=q.call(this)||this;e._rctx=c;e._renderScene=a;e._requestRenderScene=b;e._renderOverlay=d;e.forceCameraHook=f;e.supersample=k;e._screenshotQueue=[];return e}r._inheritsLoose(n,q);var h=
n.prototype;h.dispose=function(){this._rctx=null};h.takeScreenshot=function(c){this._requestRenderScene();const a=u.createResolver();this._screenshotQueue.push({settings:c,resolver:a});return a.promise};h.update=function(c){if(0!==this._screenshotQueue.length){for(const b of this._screenshotQueue){if(this.isDisposed){b.resolver.reject();continue}var a={...b.settings,pixelRatio:b.settings.pixelRatio*c.viewCamera.pixelRatio};const d=this._ensureScreenshotEncodeCanvas(),f=this._renderScreenshot(c,a);
a=l.encodeResult(f,a,d,{flipY:!0,premultipliedAlpha:!0});b.resolver(a)}this._screenshotQueue=[]}};h._renderScreenshotOverlay=function(c,a,b){if(t.isNone(this._renderOverlay))return a;c.width=a.width;c.height=a.height;const d=c.getContext("2d"),f=b.pixelRatio;d.save();d.translate(0,a.height);d.scale(1,-1);b.region&&d.translate(-b.region.x,-b.region.y);d.scale(f,f);a=this._renderOverlay(c,a);d.restore();return a};h._readbackScreenshot=function(c){return c.resample?this._readbackScreenshotResampled(c):
this._readbackScreenshotImmediate(c)};h._readbackScreenshotResampled=function(c){const {framebufferWidth:a,framebufferHeight:b,region:d,resample:f}=c,k=this._ensureScreenshotEncodeCanvas();let e=l.createEmptyImageData(a,b,k);this._rctx.gl.readPixels(0,0,a,b,6408,5121,new Uint8Array(e.data.buffer));e=this._renderScreenshotOverlay(k,e,{...c,region:null});c=l.createEmptyImageData(d.width,d.height,k);return l.resampleHermite(e,c,!0,f.region.x,b-(f.region.y+f.region.height),f.region.width,f.region.height)};
h._readbackScreenshotImmediate=function(c){const {framebufferHeight:a,region:b}=c,d=this._ensureScreenshotEncodeCanvas(),f=l.createEmptyImageData(b.width,b.height,d);this._rctx.gl.readPixels(b.x,a-(b.y+b.height),b.width,b.height,6408,5121,new Uint8Array(f.data.buffer));return this._renderScreenshotOverlay(d,f,c)};h._renderScreenshot=function(c,a){var b=null;const d=c.viewCamera,{framebufferWidth:f,framebufferHeight:k}=a;var e=!1;c=a.disableDecorations&&c.frameHasDecorations;var g=a.ignorePadding&&
d.pixelRatio!==a.pixelRatio;if(c=f!==d.fullWidth||k!==d.fullHeight||c||g){g=d.clone();if(a.ignorePadding){b=v.clone(g.padding);for(e=0;4>e;e++)b[e]=Math.round(b[e]/g.pixelRatio*a.pixelRatio);g.padding=b}g.fullWidth=f;g.fullHeight=k;g.pixelRatio=a.pixelRatio;b=d.fovX-g.fovX;e=d.fovY-g.fovY;0>b&&b<e?g.fovX=d.fovX:0>e&&e<b&&(g.fovY=d.fovY);this.forceCameraHook(g);e=!0;b=new w(this._rctx,{width:g.fullWidth,height:g.fullHeight,colorTarget:0,depthStencilTarget:3});this._renderScene(b,g,a.disableDecorations)}a=
this._readbackScreenshot(a);if(c&&!this._rctx.contextAttributes.alpha)for(c=3;c<a.data.length;c+=4)a.data[c]=255;b&&b.dispose();this._rctx.bindFramebuffer(null);e&&this.forceCameraHook(d);return a};h._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};return n}(m.AutoDisposable);p.ScreenshotManager=m;Object.defineProperty(p,"__esModule",{value:!0})});