// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/accessorSupport/trackingUtils ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Program ../../../webgl/ProgramCache ../../../webgl/Renderbuffer ../../../webgl/RenderingContext ../../../webgl/ShaderCompiler ../../../webgl/Texture ../../../webgl/VertexArrayObject ./Camera ./depthRange ./glUtil3D ./ShadowAccumulationRenderer ./ShadowMap ./Util ../../../../chunks/ShadowAccumulation.glsl ../shaders/ShadowAccumulationTechnique ../../../support/Scheduler ../../../webgl/Util".split(" "),
function(n,w,x,y,z,h,A,p,B,C,q,D,E,l,F,N,O,P,Q,R,S,T,r,t,G,m,H,I,J,u,K,L){l=function(){function k(a,b,d,e,f,g){this._rctx=a;this._stage=d;this._prepareForShadowMapPass=e;this._renderToShadowMap=f;this._requestRender=g;this._sampleCount=this._progress=0;this._cachedCamera=new r;this._contentCamera=new r;this._enabled=!1;this._cachedLightDirections=[];this._depthRange=t.ZERO;this._previewing=!1;this._handles=new y;this._cameraForcedForScreenshot=!1;this._shadowMap=new H(a,d.viewingMode);this._shadowMap.enabled=
!0;this._vao=G.createQuadVAO(a);e={rctx:a,viewingMode:d.viewingMode};f=new u.ShadowAccumulationTechniqueConfiguration;f.pass=0;this._accumulationTechnique=new u.ShadowAccumulationTechnique(e,f);this._fbo=new F(a,{colorTarget:0,depthStencilTarget:0,width:0,height:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0});this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:B.create(),projInfo:E.create(),
zScale:C.create()};this._accumulationRenderer=new m.ShadowAccumulationRenderer(b,a,this,g);this._handles.add(this._stage.resourceController.scheduler.registerTask(K.TaskPriority.SHADOW_ACCUMULATOR,this));this._handles.add(A.reactionInit(()=>d.renderView,v=>{this._handles.remove(k.renderViewHandleKey);h.isNone(v)||this._handles.add(v.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),k.renderViewHandleKey)}))}var c=k.prototype;c.runTask=function(a){for(this._prepareForShadowMapPass(this._cachedCamera,
this._contentCamera);!a.done&&!this._isDoneAccumulating;)this._accumulateShadow(),a.madeProgress();this._requestRender()};c.accumulateFixedSamples=function(){if(this.isAccumulating&&this._canAccumulate){(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();var a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(k.previewSamples,this._sampleCount-this._progress);for(let b=0;b<a;++b)this._accumulateShadow();this._cameraForcedForScreenshot=!1}};c.render=function(){this._accumulationRenderer.render()};
c.dispose=function(){this._stop();this._handles.destroy();this._accumulationRenderer=h.disposeMaybe(this._accumulationRenderer);this._shadowMap=h.disposeMaybe(this._shadowMap);this._fbo=h.disposeMaybe(this._fbo);this._vao=h.disposeMaybe(this._vao);this._accumulationTechnique=h.disposeMaybe(this._accumulationTechnique);this._sampleCount=this._cachedLightDirections.length=0};c.setOptions=function(a){void 0!==a.enabled&&this._setEnabled(a.enabled);void 0!==a.previewing&&this.setPreviewing(a.previewing);
void 0!==a.lightDirections&&this.setLightDirections(a.lightDirections);this._accumulationRenderer.setOptions(a)};c.setPreviewing=function(a){this._previewing!==a&&(this._previewing=a,this._requestRenderIfEnabled())};c.setLightDirections=function(a){this._lightDirections=a};c.setAccumulationDependencies=function(a,b,d,e){this._accumulationParams.linearDepthTexture=a;this._depthRange=b;this._updateCamera(d);this._contentCamera=e};c.readAccumulatedShadow=function(a,b){if(!this._isActive||1>this._progress||
0>a||a>this._fbo.width||0>b||b>this._fbo.height)return 0;const d=M;this._fbo.readPixels(a,b,1,1,6408,5121,d);return d[0]/this._progress};c._start=function(){this._progress=0;this._enabled=!0};c._stop=function(){this._enabled=!1};c._invalidate=function(){this._progress=0;this._requestRenderIfEnabled()};c._clear=function(){this._rctx.bindFramebuffer(this._fbo);this._rctx.setClearColor(0,0,0,0);this._rctx.clearSafe(16384);this._progress=0};c._accumulateShadow=function(){this._renderToShadowMap(this._shadowMap,
this._lightDirections[this._progress],this._cachedCamera,this._depthRange);this._rctx.bindFramebuffer(this._fbo);this._rctx.useProgram(this._accumulationTechnique.program);this._accumulationTechnique.bindPipelineState(this._rctx);this._accumulationTechnique.bindPass(this._accumulationParams);this._rctx.bindVAO(this._vao);this._rctx.drawArrays(this._accumulationTechnique.primitiveType,0,L.vertexCount(this._vao,"geometry"));this._progress++};c._updateCamera=function(a){if(!a.equals(this._cachedCamera)){var {fullWidth:b,
fullHeight:d,projectionMatrix:e,viewMatrix:f,center:g}=a;this._cachedCamera.copyFrom(a);this._fbo.resize(b,d);I.inverseProjectionInfo(e,b,d,this._projInfo,this._zScale);p.translate(this._inverseView,f,g);p.invert(this._inverseView,this._inverseView);this._opacityFromElevation=1-z.smoothstep(m.shadowAccumulationDisableElevationMin,m.shadowAccumulationDisableElevationMax,a.relativeElevation)}};c._setEnabled=function(a){a!==this._enabled&&(a?this._start():this._stop())};c._requestRenderIfEnabled=function(){this._enabled&&
this._requestRender()};w._createClass(k,[{key:"computedSamples",get:function(){return this._progress}},{key:"accumulationTexture",get:function(){return this._fbo.colorTexture}},{key:"running",get:function(){return this._isRefining&&this._canAccumulate}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},
{key:"_isActive",get:function(){return this._enabled&&0<this._sampleCount}},{key:"_canAccumulate",get:function(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==t.ZERO&&this._opacityFromElevation>m.shadowAccumulationDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(a){const b=this._cachedLightDirections;if(!x.equals(b,
a,q.equals)){var d=a.length;b.length=d;this._sampleCount=Math.min(J.shadowAccumulationMaxSamples,d);for(let e=0;e<d;++e){const f=a[e],g=b[e]||D.create();q.copy(g,f);b[e]=g}this._invalidate()}}},{key:"_projInfo",get:function(){return this._accumulationParams.projInfo}},{key:"_zScale",get:function(){return this._accumulationParams.zScale}},{key:"_inverseView",get:function(){return this._accumulationParams.inverseView}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},
set:function(a){this._accumulationRenderer.opacityFromElevation=a}}]);return k}();l.previewSamples=6;l.renderViewHandleKey="renderView";const M=new Uint8Array(4);n.ShadowAccumulator=l;Object.defineProperty(n,"__esModule",{value:!0})});