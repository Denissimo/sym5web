// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/maybe ../../../../chunks/earcut ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec32 ../../../../renderers/support/renderingInfoUtils ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./polygonUtils ../support/edgeUtils ../../support/debugFlags ../../support/ElevationProvider ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(V,ba,ra,J,sa,ta,ua,ca,N,B,D,va,R,da,ea,wa,W,xa,ya,S,fa,ha,za,Aa,Ba,Ca,Da,ia){function Ea(f,l,e,a,c,b,d,q,k,u,r,t,h,w){let p=0;var x=2*a.count;{var g=a.index,n=a.count,y=e.length/3,m=k;B.copy(z,h);const v=0<t?1:-1;g*=3;let A=m;h=3*A;let E=m+n;m=3*E;for(let F=0;F<n;++F)w&&(z[0]=f[g+0],z[1]=f[g+1],z[2]=f[g+2],B.normalize(z,z)),c[h+0]=f[g+0],c[h+1]=f[g+1],c[h+2]=f[g+2],b[h+0]=l[g+0],b[h+1]=l[g+1],b[h+2]=l[g+2],d[h+0]=-v*z[0],d[h+1]=-v*z[1],d[h+2]=-v*z[2],q[A]=0,c[m+0]=f[g+0]+t*z[0],c[m+1]=f[g+
1]+t*z[1],c[m+2]=f[g+2]+t*z[2],b[m+0]=l[g+0],b[m+1]=l[g+1],b[m+2]=l[g+2],d[m+0]=v*z[0],d[m+1]=v*z[1],d[m+2]=v*z[2],q[E]=t,h+=3,m+=3,g+=3,A+=1,E+=1;h=g=0;m=3*x;f=0>t?ja:ka;l=0>t?ka:ja;for(w=0;w<y;++w)r[h+0]=e[g+f[0]],r[h+1]=e[g+f[1]],r[h+2]=e[g+f[2]],u[m+0]=e[g+l[0]]+n,u[m+1]=e[g+l[1]]+n,u[m+2]=e[g+l[2]]+n,h+=3,m+=3,g+=3}k+=2*a.count;x=0;la(c,b,q,d,p,a.pathLengths[0],a.count,k,u,x,t);k+=4*a.pathLengths[0];x+=2*a.pathLengths[0];p+=a.pathLengths[0];for(e=1;e<a.pathLengths.length;++e)la(c,b,q,d,p,a.pathLengths[e],
a.count,k,u,x,t),k+=4*a.pathLengths[e],x+=2*a.pathLengths[e],p+=a.pathLengths[e]}function T(f,l,e,a,c,b,d){a[b]=a[d];d*=3;b*=3;f[b+0]=f[d+0];f[b+1]=f[d+1];f[b+2]=f[d+2];l[b+0]=l[d+0];l[b+1]=l[d+1];l[b+2]=l[d+2];e[b+0]=c[0];e[b+1]=c[1];e[b+2]=c[2]}function la(f,l,e,a,c,b,d,q,k,u,r){let t=c,h=c+1,w=c+d,p=c+d+1,x=q,g=q+1,n=q+2*b;q=q+2*b+1;0>r&&(t=c+d+1,p=c);u*=3;for(let F=0;F<b;++F){F===b-1&&(0<r?(h=c,p=c+d):(h=c,t=c+d));var y=f,m=t,v=h,A=w,E=O;m*=3;v*=3;A*=3;B.set(X,y[m++],y[m++],y[m++]);B.set(ma,y[v++],
y[v++],y[v++]);B.set(na,y[A++],y[A++],y[A++]);B.subtract(oa,ma,X);B.subtract(pa,na,X);B.cross(E,pa,oa);B.normalize(E,E);T(f,l,a,e,O,x,t);T(f,l,a,e,O,g,h);T(f,l,a,e,O,n,w);T(f,l,a,e,O,q,p);k[u++]=x;k[u++]=n;k[u++]=q;k[u++]=x;k[u++]=q;k[u++]=g;t++;h++;w++;p++;x+=2;g+=2;n+=2;q+=2}}function Fa(f,l,e,a){f=f.stageObject;const c=f.geometryRecords,b=c.length,d="absolute-height"!==l.mode;let q=0;const k=f.transformation,u=ca.invert(N.create(),k);for(let h=0;h<b;h+=2){const w=c[h].geometry,p=w.getMutableAttribute("position").data,
x=w.vertexAttributes.get("size").data;var r=w.vertexAttributes.get("mapPos").data;r=new Ba.SamplePosition(r);const g=p.length/3;let n=0,y=!1,m=0;const v=e.spatialReference;for(let A=0;A<g;A++){M[0]=p[n];M[1]=p[n+1];M[2]=p[n+2];var t=W.evaluateElevationAlignmentAtPoint(r,e,l,a,d?qa:null);d&&(m+=qa.sampledElevation);Aa.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(B.set(C,r.array[r.offset+0],r.array[r.offset+1],t+x[n/3]),a.toRenderCoords(C,v,C)):(B.set(C,p[n+0],p[n+1],p[n+2]),B.transformMat4(C,C,k),
a.setAltitude(C,t+x[n/3]));B.transformMat4(C,C,u);p[n]=C[0];p[n+1]=C[1];p[n+2]=C[2];t=.01/a.unitInMeters;if(Math.abs(M[0]-p[n])>=t||Math.abs(M[1]-p[n+1])>=t||Math.abs(M[2]-p[n+2])>=t)y=!0;r.offset+=3;n+=3}y&&(w.invalidateBoundingInfo(),f.geometryVertexAttrsUpdated(h),c[h+1].geometry.invalidateBoundingInfo(),f.geometryVertexAttrsUpdated(h+1));q+=m/g}return q/b}const Ga=["polygon","extent"];S=function(f){function l(a,c,b,d){a=f.call(this,a,c,b,d)||this;a.ensureDrapedStatus(!1);return a}ba._inheritsLoose(l,
f);var e=l.prototype;e.doLoad=function(){var a=ba._asyncToGenerator(function*(){if(!this._drivenProperties.size){var c=fa.validateSymbolLayerSize(this._getSymbolSize());if(c)throw new ra("graphics3dextrudesymbollayer:invalid-size",c);}c=J.get(this.symbolLayer,"material","color");var b=this._getCombinedOpacityAndColor(c);c=D.fromArray(b);b=b[3];const d=1>b||this.needsDrivenTransparentPass;c={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:c,ambient:c,opacity:b,transparent:d,
cullFace:d?0:2,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new ia.DefaultMaterial(c);this._bottomMaterial=new ia.DefaultMaterial({...c,cullFace:2});this._context.stage.add(this._material);this._context.stage.add(this._bottomMaterial)});return function(){return a.apply(this,arguments)}}();e.destroy=function(){f.prototype.destroy.call(this);this._material&&(this._context.stage.remove(this._material),
this._context.stage.remove(this._bottomMaterial))};e.createGraphics3DGraphic=function(a){const c=a.graphic;if(!this._validateGeometry(c.geometry,Ga,this.symbolLayer.type))return null;const b=this._getVertexOpacityAndColor(a.renderingInfo,255),d=this.setGraphicElevationContext(c,new xa.ElevationContext);return this._createAs3DShape(c,a.renderingInfo,b,d,c.uid)};e.layerOpacityChanged=function(a,c){var b=J.get(this.symbolLayer,"material","color");b=this._getCombinedOpacity(b);const d=1>b||this.needsDrivenTransparentPass;
this._material.setParameterValues({opacity:b,transparent:d});this._bottomMaterial.setParameterValues({opacity:b,transparent:d});const q=this._getLayerOpacity();a.forEach(k=>{k=c(k);J.isSome(k)&&k.layerOpacityChanged(q,this._context.isAsync)});return!0};e.layerElevationInfoChanged=function(a,c){return this.updateGraphics3DGraphicElevationInfo(a,c,W.needsElevationUpdates3D)};e.slicePlaneEnabledChanged=function(a,c){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});
this._bottomMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});a.forEach(b=>{b=c(b);J.isSome(b)&&b.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0};e.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._bottomMaterial.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};e.pixelRatioChanged=
function(){return!0};e._getExtrusionSize=function(a){if(a.size&&this._drivenProperties.size){var c;a=null!=(c=wa.getDriverAxisSizeValue(a.size,2))?c:0}else a=this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};e._getSymbolSize=function(){var a;return null!=(a=this.symbolLayer.size)?a:1};e._createAs3DShape=function(a,c,b,d,q){var k=ha.geometryAsPolygon(a.geometry);if(J.isNone(k))return null;a=ha.geometryToRenderInfo(k,this._context.elevationProvider,this._context.renderCoordsHelper,
d);this._logGeometryCreationWarnings(a,k.rings,"rings","ExtrudeSymbol3DLayer");if(0===k.rings.length||!k.rings.some(P=>0<P.length))return null;var u=fa.computeCentroid(k);if(J.isNone(u))return null;var r=[];const t=[],h=[],w=R.create(),p=N.create(),x=D.create(),g=1===this._context.renderCoordsHelper.viewingMode;g||this._context.renderCoordsHelper.worldUpAtPosition(null,x);va.computeLinearTransformation(k.spatialReference,[u.x,u.y,0],p,this._context.renderCoordsHelper.spatialReference);k=N.create();
ca.invert(k,p);u=ua.create();ta.normalFromMat4(u,k);const {polygons:n,mapPosition:y,position:m}=a;var v=m.length/3;const A=new Float64Array(18*v),E=new Float64Array(18*v),F=new Float64Array(18*v);v=new Float64Array(6*v);let K=0;for(let P=0;P<n.length;++P){var L=n[P];const Y=L.count;if(this._context.clippingExtent&&(R.empty(w),R.expandWithBuffer(w,L.mapPosition),!R.intersectsClippingArea(w,this._context.clippingExtent)))continue;const U=sa.earcut(L.mapPosition,L.holeIndices,3);if(0===U.length)continue;
const Z=new Uint32Array(6*Y+U.length);var Q=new Uint32Array(U.length),I=6*Y,G=3*A.BYTES_PER_ELEMENT;G=new da.BufferViewVec3f64(A.buffer,K*G,G,(K+I)*G);var H=3*E.BYTES_PER_ELEMENT;H=new da.BufferViewVec3f64(E.buffer,K*H,H,(K+I)*H);const aa=new Float64Array(F.buffer,3*K*F.BYTES_PER_ELEMENT,3*I);I=new Float64Array(v.buffer,1*K*v.BYTES_PER_ELEMENT,1*I);const Ha=this._getExtrusionSize(c);Ea(m,y,U,L,G.typedBuffer,aa,H.typedBuffer,I,0,Z,Q,Ha,x,g);ea.transformMat4(G,G,k);ea.transformMat3(H,H,u);K+=6*Y;L=
this._createExtrudeGeometry(Z,Z.length-Q.length,{positions:G.typedBuffer,elevation:aa,normals:H.typedBuffer,heights:I},b);r.push(L);t.push(this._material);h.push(N.IDENTITY);Q=this._createExtrudeGeometry(Q,0,{positions:G.typedBuffer,elevation:aa,normals:H.typedBuffer,heights:I},b);r.push(Q);t.push(this._bottomMaterial);h.push(N.IDENTITY)}if(0===r.length)return null;c=new Da.Object3D({geometries:r,materials:t,transformations:h,metadata:{layerUid:this._context.layer.uid,graphicUid:q,isElevationSource:!0}});
c.transformation=p;b=za.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()});b=J.isSome(b)?{baseMaterial:this._material,edgeMaterials:[b],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null;r=new ya.Graphics3DObject3DGraphicLayer(this,c,r,null,null,Fa,d,b);r.alignedSampledElevation=a.sampledElevation;r.needsElevationUpdates=W.needsElevationUpdates3D(d.mode);return r};e._createExtrudeGeometry=function(a,c,b,d){var q=new Uint32Array(a.length);d=[["position",
{size:3,data:b.positions,exclusive:!0}],["normal",{size:3,data:b.normals,exclusive:!0}],["color",{size:4,data:d,exclusive:!0}],["size",{size:1,data:b.heights,exclusive:!0}]];q=[["position",a],["normal",a],["color",q]];b.elevation&&(d.push(["mapPos",{size:3,data:b.elevation}]),q.push(["mapPos",a]));return new Ca.Geometry(d,q,0,c)};return l}(S.Graphics3DSymbolLayer);const O=D.create(),X=D.create(),ma=D.create(),na=D.create(),oa=D.create(),pa=D.create(),M=D.create(),C=D.create(),z=D.create(),ka=[0,2,
1],ja=[0,1,2],qa={verticalDistanceToGround:0,sampledElevation:0};V.Graphics3DExtrudeSymbolLayer=S;V.default=S;Object.defineProperty(V,"__esModule",{value:!0})});