// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/scheduling ../../../../core/watchUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../../../rest/support/QuantizationParameters ../../../../rest/support/Query ./featureReference ./FeatureTile ../../terrain/tileUtils ../../../support/Scheduler".split(" "),
function(p,v,q,N,O,P,Q,k,x,R,S,t,Z,aa,ba,T,y,w,U,F,G,H,V,I){function C(n){return"dummy-tile-full-extent"===n.id}function W(n){let l=0;for(const e of n)e.features&&0<e.features.length&&e.alive&&(l=Math.max(l,e.descriptor.lij[0]));return l}function X(n){n.setFeatures([],0,null);n.featuresMissing=!1;return 4}function J(n){return k.isNone(n)?new Set:new Set(n.map(l=>l.name))}function K(n,l){if(k.isNone(n)||k.isNone(l))return J(l);const e=new Set;for(const {name:a}of l)n.has(a)&&e.add(a);return e}const D=
P.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");p.FeatureTileFetcher3D=function(n){function l(a){a=n.call(this,a)||this;a._useTileCount=!1;a.updating=!1;a.updatingTotal=0;a.updatingRemaining=0;a.expectedFeatureDiff=0;a.maximumNumberOfFeaturesExceeded=!1;a.maximumNumberOfFeaturesExceededThrottle=1E3;a._fullRatio=1;a._farRatio=1;a.changes={updates:{adds:[],removes:[]},adds:[],removes:[]};a.handles=new O;a._frameTask=I.ImmediateTask;a._dirty=!1;a.featureTiles=new Map;a.displayingFeatureReferences=
new Map;a.numDisplayingFeatureReferences=0;a.suspended=!0;a.pendingEdits=null;return a}v._inheritsLoose(l,n);var e=l.prototype;e.initialize=function(){this.handles.add(S.on(this,"tileDescriptors","change",()=>this.setDirty(),()=>this.setDirty()));this.objectIdField=this.context.objectIdField;this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?G.MultiFeatureReference:G.SingleFeatureReference;const a=this.context.scheduler;k.isSome(a)&&(this._frameTask=a.registerTask(I.TaskPriority.FEATURE_TILE_FETCHER,
this));this.setDirty()};e.destroy=function(){this._frameTask.remove();this.handles=k.destroyMaybe(this.handles);this.featureTiles.forEach(a=>{this.cancelFetchTile(a);this.removeTile(a)});this.featureTiles.clear();this.displayingFeatureReferences.clear();this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)};e.restart=function(){this.featureTiles.forEach(a=>{this.cancelFetchTile(a);this.clearTile(a);this.resetFetchTile(a)});k.isSome(this.context.memoryCache)&&this.context.memoryCache.clear();
this.setDirty()};e.refetch=function(){this.featureTiles.forEach(a=>{this.cancelFetchTile(a);this.resetFetchTile(a)});k.isSome(this.context.memoryCache)&&this.context.memoryCache.clear();this.setDirty()};e.suspend=function(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())};e.resume=function(){this.suspended&&(this.suspended=!1,this.unpause())};e.pause=function(){this.paused&&(this.featureTiles.forEach(a=>this.cancelFetchTile(a)),this.updated())};e.unpause=function(){this.paused||(this.setDirty(),
this.updated())};e.applyEdits=function(a){this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:x.createAbortController()},this.pause());const b=this.pendingEdits;b.count++;const c=b.edits.then(()=>a.result.catch(d=>{if(x.isAbortError(d))throw d;return null}).then(d=>{if(!d)return d;this.applyEditsDeleteFeatures(d.deletedFeatures);return this.applyEditsAddUpdateFeatures(d.addedFeatures,d.updatedFeatures,b.controller.signal).then(()=>d)}).then(d=>{0===--b.count&&(this.pendingEdits===
b&&(this.pendingEdits=null),k.isSome(this.context.memoryCache)&&this.context.memoryCache.clear(),this.unpause(),this.updated());return d}));b.edits=c;this.updated();return c};e.applyEditsDeleteFeatures=function(a){if(0!==a.length){var b=this.context.globalIdField,c=b&&this.availableFields.has(b),d=new Set,f=this.objectIdField;a.forEach(({objectId:g,globalId:h})=>{(!g||0>g)&&b?(c||D.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${b} to be included the layer's outFields for updates to be reflected in the view`),
(g=this.features.find(m=>m.attributes&&m.attributes[b]===h))&&d.add(w.getObjectId(g,f))):d.add(g)});this.featureTiles.forEach(g=>{if(g.features){var h=g.features.filter(m=>!d.has(w.getObjectId(m,this.objectIdField)));h.length!==g.features.length&&(g.setFeatures(h,0,g.availableFields),this.invalidateCounts())}})}};e.applyEditsAddUpdateFeatures=function(){var a=v._asyncToGenerator(function*(b,c,d){const f=[],g=new Set;b.forEach(m=>f.push(m.objectId));c.forEach(m=>{f.push(m.objectId);g.add(m.objectId)});
if(0!==f.length){var h=[];this.featureTiles.forEach(m=>{(m=this.applyEditsAddUpdateTile(m,f,g,d))&&h.push(m)});yield x.eachAlways(h)}});return function(b,c,d){return a.apply(this,arguments)}}();e.applyEditsAddUpdateTile=function(){var a=v._asyncToGenerator(function*(b,c,d,f){if(b.features){var g=this.createQuery(b);g.resultType=void 0;g.cacheHint=!1;g.objectIds=c;c=yield this.queryFeatures(g,f);f=null;0<d.size&&(g=b.features.filter(h=>!d.has(w.getObjectId(h,this.objectIdField))),g.length!==b.features.length&&
(f=g));if(0<c.features.length){f||(f=b.features.slice());for(const h of c.features)f.push(h)}f&&(b.hasPreciseFeatureCount&&(b.numFeatures=Math.max(b.numFeatures,f.length)),b.setFeatures(f,0,K(b.availableFields,c.fields)),this.invalidateCounts())}});return function(b,c,d,f){return a.apply(this,arguments)}}();e.queryFeatures=function(a,b){return this.context.query.queryFeaturesDehydrated(a,{signal:b,timeout:6E5})};e.setDirty=function(){this._dirty=!0;this.updated()};e.runTask=function(a){this._frameTask.processQueue(a);
if(this._dirty&&this.constructed){this._dirty=!1;var b=this.getListOfTiles();this.markTilesNotAlive(b);if(a.run(()=>this.addTiles(b,a))&&a.run(()=>this.filterExtentTiles(b,a))&&a.run(()=>this.removeTiles(b,a))&&!a.done){var c=this.sortTiles(b);a.run(()=>this.displayTiles(c,a))&&a.run(()=>this.fetchTiles(c,a))&&a.run(()=>this.updateMemoryEstimates(c,a))||this.setDirty();this.updated();this.updating||this.updateMaximumNumberOfFeaturesExceeded()}else this.setDirty()}};e.markTilesNotAlive=function(a){for(const b of a)b.alive=
!1};e.addTiles=function(a,b){if(this.suspended)return!1;this.tileDescriptors.forEach(c=>{const d=this.featureTiles.get(c.id);d?d.alive=!0:b.done||(a.push(this.addTile(c)),b.madeProgress())});return b.hasProgressed};e.filterExtentTiles=function(a,b){for(const c of a){if(b.done)break;c.alive&&(c.filtered=!c.intersects(this.filterExtent),c.filtered&&(this.clearTile(c),b.madeProgress()))}return b.hasProgressed};e.removeTiles=function(a,b){for(let c=a.length-1;0<=c&&!b.done;c--){const d=a[c];d.alive||
(this.removeTile(d),c!==a.length-1&&(a[c]=a[a.length-1]),a.pop(),b.madeProgress())}return b.hasProgressed};e.sortTiles=function(a){a.sort((b,c)=>b.descriptor.loadPriority-c.descriptor.loadPriority);return a};e.displayTiles=function(a,b){const c=this.updateRatio(a),d=f=>{const g=1>this._fullRatio?c(f)*this._farRatio:1;f.reduceFeatures(g,this.memoryFactor,this.objectIdField)&&this.setDirty();return this.showTile(f)};for(const f of a)if(!b.run(()=>d(f))){this.setDirty();break}return b.hasProgressed};
e.fetchTiles=function(a,b){if(this.paused)return!1;var c=!1;for(const f of a)if(f.needsFetching){var d=k.isSome(this.context.memoryCache)?this.context.memoryCache.pop(f.id):null;if(k.isSome(d))f.cache=d,this.setDirty(),this.scheduleUpdated(),b.madeProgress();else if(this.needsNumFeatures(f)&&(c=x.createAbortController(),d=this.fetchTileCount(f,c.signal),this._handleRequest(f,d,c,()=>f.numFeatures=H.FAILED_FEATURE_COUNT),c=!0,b.madeProgress()),b.done)return!0}if(c)return b.hasProgressed;for(const f of a)if(f.needsFetching&&
(a=x.createAbortController(),c=this.fetchTile(f,a.signal),this._handleRequest(f,c,a,g=>{f.setFeatures([],0,null);this.invalidateCounts();f.featuresMissing=!1;this.context.logFetchError(D,g)}),b.madeProgress(),b.done))return!0;return b.hasProgressed};e.updateMemoryEstimates=function(a,b){a.some(c=>b.run(()=>c.updateMemoryEstimates())?!1:(this.setDirty(),!0));return b.hasProgressed};e.reclip=function(a,b){if(this.constructed){var c=[];this.featureTiles.forEach(d=>{k.isNone(d.displayingFeatures)||0===
d.displayingFeatures.length||(d.intersectionIncludingBorrowed(b,L),d.intersectionIncludingBorrowed(a,M),y.equals(L,M)||c.push(d))});this.refreshDisplayingFeatures(c);this.updated()}};e.refreshDisplayingFeatures=function(a){const b=new Set,c=this.changes.updates;for(const d of a)if(!k.isNone(d.displayingFeatures))for(const f of d.displayingFeatures)a=w.getObjectId(f,this.objectIdField),b.has(a)||(b.add(a),{feature:a}=this.displayingFeatureReferences.get(a),c.removes.push(a),c.adds.push(a));this.applyChanges()};
e.updated=function(){let a=0;this.paused||this.featureTiles.forEach(c=>c.isFetching?++a:0);var b=this._dirty||0<a||!!this.pendingEdits;this._set("updating",b);if(b){let c=0,d=0,f=0,g=0,h=0;const m=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach(r=>{++d;if(r.isFetching&&r.hasPreciseFeatureCount){const z=this.maximumFeaturesForTile(r)*(1-r.emptyFeatureRatio),A=k.isSome(r.displayingFeatures)?r.displayingFeatures.length*m:0;h+=z-A}r.needsFetching?++g:
0<r.numFeatures&&(++f,c+=r.numFeatures)});g+=a;let u=b=0;c?(u=c,b=Math.min(g*c/f,c)):(u=d,b=g);h=Math.min(this.maximumNumberOfFeatures-this.features.length,h);this._set("updatingTotal",u);this._set("updatingRemaining",b);this._set("expectedFeatureDiff",h)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()};e.updateMaximumNumberOfFeaturesExceeded=function(){const a=Q.someMap(this.featureTiles,b=>b.perTileMaximumNumberOfFeaturesExceeded);
this._set("maximumNumberOfFeaturesExceeded",a)};e.updateRatio=function(a){const b=W(a),c=g=>1/(1<<Math.max(0,b-g.descriptor.lij[0]));let d=0,f=0;for(const g of a)a=g.numFeatures,d+=a,f+=a*c(g);this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/d);this._farRatio=this.maximumNumberOfFeatures/f;this.scheduleUpdated();return c};e.maximumFeaturesUpdated=function(a,b){a!==b&&(b>a&&this.featureTiles.forEach(c=>{if(c.featuresMissing){var d=this.maximumFeaturesForTile(c);c.features&&(c.features.length>=
d||5===c.fetchStatus)||(this.cancelFetchTile(c),this.resetFetchTile(c))}}),this.setDirty())};e.addTile=function(a){a=new H.FeatureTile(a);this.featureTiles.set(a.id,a);this.resetFetchTile(a);this.referenceDisplayingFeaturesFromRelatedTiles(a);return a};e.referenceDisplayingFeaturesFromRelatedTiles=function(a){const b=a.descriptor.resolution;this.featureTiles.forEach(c=>{if(!(k.isNone(c.displayingFeatures)||a===c||a.descriptor.lij&&c.descriptor.lij&&!V.tilesAreRelated(a.descriptor.lij,c.descriptor.lij))){k.isNone(a.displayingFeatures)&&
(a.displayingFeatures=[]);a.descriptor.extent&&c.descriptor.extent&&(k.isNone(a.extentIncludingBorrowedFeatures)&&(a.extentIncludingBorrowedFeatures=y.clone(a.descriptor.extent)),y.expand(a.extentIncludingBorrowedFeatures,c.descriptor.extent,a.extentIncludingBorrowedFeatures));for(const d of c.displayingFeatures)a.displayingFeatures.push(d),c=this.displayingFeatureReferences.get(w.getObjectId(d,this.objectIdField)),c.ref(c.feature,b),this.numDisplayingFeatureReferences++}});a.featureLimit=k.isSome(a.displayingFeatures)?
a.displayingFeatures.length:0};e.removeTile=function(a){this.clearTile(a);this.featureTiles.delete(a.id)};e.resetFetchTile=function(a){a.filtered=!a.intersects(this.filterExtent);a.filtered?a.needsFetching&&(a.fetchStatus=4):a.fetchStatus=0};e.cancelFetchTile=function(a){const b=a.requestController;k.isSome(b)&&(a.requestController=null,a.resetFetching(),b.abort())};e.fetchTileCount=function(){var a=v._asyncToGenerator(function*(b,c){b.numFeatures=yield this.fetchCount(b,c);this.updateRatio(this.getListOfTiles());
return 3===b.fetchStatus?1:0});return function(b,c){return a.apply(this,arguments)}}();e.fetchTile=function(){var a=v._asyncToGenerator(function*(b,c){var d=this.maximumFeaturesForTile(b);if(0>=d)return X(b);const f=this.getMaxRecordCount(b);var g=Math.ceil(d/f);if(C(b)||!this.context.capabilities.supportsMaxRecordCountFactor||b.numFeatures<=d&&g>F.MAX_MAX_RECORD_COUNT_FACTOR)return this.fetchPagedTile(b,c);g=this.createQuery(b);g.maxRecordCountFactor=Math.ceil(d/f);b.isRefetching&&b.features&&0<
b.features.length&&(g.maxRecordCountFactor=Math.max(Math.ceil(b.features.length/(1-b.emptyFeatureRatio)/f)+1,g.maxRecordCountFactor));const {features:h,exceededTransferLimit:m,fields:u}=yield this.queryFeatures(g,c);d=m?g.maxRecordCountFactor>=F.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5;yield this._frameTask.schedule(()=>{b.featuresMissing=h.length<b.numFeatures||m;const r=this._removeEmptyFeatures(h);b.setFeatures(h,r,J(u))},c);this.invalidateCounts();return d});return function(b,c){return a.apply(this,
arguments)}}();e.fetchCount=function(){var a=v._asyncToGenerator(function*(b,c){return this.context.query.queryFeatureCount(this.createFeatureCountQuery(b),{signal:c})});return function(b,c){return a.apply(this,arguments)}}();e.fetchPagedTile=function(){var a=v._asyncToGenerator(function*(b,c){let d=0,f=0,g,h=0,m=this.maximumFeaturesForTile(b)-h;const u=this.getMaxRecordCount(b);let r=null;for(;;){const z=this.createQuery(b),A=this.setPagingParameters(z,d,m,u),{features:B,exceededTransferLimit:E,
fields:Y}=yield this.queryFeatures(z,c);yield this._frameTask.schedule(()=>{A&&(d+=k.unwrap(z.num));h+=B.length;f+=this._removeEmptyFeatures(B);b.featuresMissing=d<b.numFeatures||E;g=g?g.concat(B):B;r=K(r,Y);b.setFeatures(g,f,r)},c);this.invalidateCounts();this.setDirty();m=this.maximumFeaturesForTile(b)-h;if(!A||!E||0>=m)return E?4:5}});return function(b,c){return a.apply(this,arguments)}}();e.createFeatureCountQuery=function(a){a=this.createQuery(a);this.context.capabilities.supportsCacheHint&&
(a.resultType=void 0,a.cacheHint=!0);return a};e.createQuery=function(a){const b=this.context.createQuery(),c=a.descriptor.extent;c&&(b.geometry=y.toExtent(c,this.context.tilingScheme.spatialReference));this.setResolutionParams(b,a);this.useTileQuery(a)?b.resultType="tile":this.context.capabilities.supportsCacheHint&&(b.cacheHint=!0);return b};e.setPagingParameters=function(a,b,c,d){if(!this.context.capabilities.supportsPagination)return!1;a.start=b;0<c&&this.context.capabilities.supportsMaxRecordCountFactor?
(a.maxRecordCountFactor=Math.ceil(c/d),a.num=Math.min(a.maxRecordCountFactor*d,c)):a.num=Math.min(d);return!0};e.getEffectiveTileResolution=function(a){if(null==a.descriptor.resolution)return null;const b=1===this.context.viewingMode?this.context.tilingScheme.resolutionAtLevel(3):Infinity;return Math.min(a.descriptor.resolution,b)/this.lodFactor};e.setResolutionParams=function(a,b){this.supportsResolution&&(b=this.getEffectiveTileResolution(b),null!=b&&(this.context.capabilities.supportsQuantization?
a.quantizationParameters=new U({mode:"view",originPosition:"upper-left",tolerance:b,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(a.maxAllowableOffset=b)))};e._removeEmptyFeatures=function(a){const b=a.length;for(let c=0;c<a.length;)w.hasVertices(a[c].geometry)?++c:(a[c]=a[a.length-1],--a.length);return b-a.length};e.needsNumFeatures=function(a){return this.useTileCount&&a.needsFeatureCount&&!C(a)};e.getMaxRecordCount=function(a){const {tileMaxRecordCount:b,maxRecordCount:c}=
this.context;return this.useTileQuery(a)&&k.isSome(b)&&0<b&&this.context.capabilities.supportsResultType?b:k.isSome(c)&&0<c?c:2E3};e.useTileQuery=function(a){return C(a)&&this.context.capabilities.supportsCacheHint?!1:this.context.capabilities.supportsResultType};e._handleRequest=function(a,b,c,d){a.fetchStatus=a.needsRefetching?3:2;a.requestController=c;let f=!1;b.then(g=>{a.requestController=null;a.fetchStatus=g}).catch(g=>{a.requestController===c&&(a.requestController=null,a.fetchStatus=4);x.isAbortError(g)?
f=!0:d(g)}).then(()=>{f||this.setDirty();this.scheduleUpdated()})};e.scheduleUpdated=function(){this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(R.schedule(()=>{this.handles.remove("scheduleUpdated");this.updated()}),"scheduleUpdated")};e.showTile=function(a){if(k.isSome(a.displayingFeatures)&&!a.needsDisplayUpdate)return!1;var b=a.features;if(0===a.featureLimit||!b)return b=k.isSome(a.displayingFeatures)&&0<a.displayingFeatures.length,this.hideTileFeatures(a),a.displayingFeatures=
[],b;const c=a.descriptor.resolution,d=this.changes.updates,f=this.changes.adds,g=Math.min(a.featureLimit,b.length);a.featureLimit=g;for(let m=0;m<g;++m){var h=b[m];const u=w.getObjectId(h,this.objectIdField),r=this.displayingFeatureReferences.get(u);r?(h=r.ref(h,c),h.oldVersion!==h.newVersion&&(d.removes.push(h.oldVersion),d.adds.push(h.newVersion))):(this.displayingFeatureReferences.set(u,new this.FeatureReferenceClass(h,c)),f.push(h));this.numDisplayingFeatureReferences++}this.hideTileFeatures(a);
this.applyChanges();a.displayingFeatures=b.slice(0,g);return!0};e.hideTile=function(a){this.cancelFetchTile(a);this.hideTileFeatures(a)};e.hideTileFeatures=function(a){if(!k.isNone(a.displayingFeatures)){var b=this.changes.updates,c=this.changes.removes;for(const f of a.displayingFeatures){const g=w.getObjectId(f,this.objectIdField);var d=this.displayingFeatureReferences.get(g);d&&((d=d.unref(a.descriptor.resolution),this.numDisplayingFeatureReferences--,d)?d.oldVersion!==d.newVersion&&(null==d.newVersion?
(this.displayingFeatureReferences.delete(g),c.push(d.oldVersion)):(b.adds.push(d.newVersion),b.removes.push(d.oldVersion))):console.error("Hiding unreferenced feature"))}this.applyChanges();a.displayingFeatures=null}};e.applyChanges=function(){var a=this.changes.updates;0<a.removes.length&&(this.features.removeMany(a.removes),a.removes.length=0);0<a.adds.length&&(this.features.addMany(a.adds),a.adds.length=0);a=this.changes.adds;const b=this.changes.removes,c=Math.min(a.length,b.length);let d=0;for(;d<
c;){const f=Math.min(d+200,c);this.features.addMany(a.slice(d,f));this.features.removeMany(b.slice(d,f));d=f}a.length>c&&this.features.addMany(0===d?a:a.slice(d));b.length>c&&this.features.removeMany(0===d?b:b.slice(d));a.length=0;b.length=0};e.clearTile=function(a){this.hideTile(a);a.features&&k.isSome(this.context.memoryCache)&&this.context.memoryCache.put(a.id,a.cache,16+a.estimatedSize);a.setFeatures(null,0,null);this.invalidateCounts()};e.invalidateCounts=function(){this.notifyChange("totalVertices");
this.notifyChange("totalFeatures");this.notifyChange("memoryForUnusedFeatures")};e.getListOfTiles=function(){return Array.from(this.featureTiles.values())};e.maximumFeaturesForTile=function(a){const b=a.hasPreciseFeatureCount?a.numFeatures:Infinity;return Math.min(Math.ceil((a.hasPreciseFeatureCount?b:this.maximumNumberOfFeatures)*(1>this._fullRatio?this._farRatio:1)/(1-a.emptyFeatureRatio)),b)};v._createClass(l,[{key:"maximumNumberOfFeatures",set:function(a){a=a||Infinity;const b=this._get("maximumNumberOfFeatures");
a===b||1>a||(this._set("maximumNumberOfFeatures",a),this.maximumFeaturesUpdated(b,a))}},{key:"memoryFactor",set:function(a){this.memoryFactor!==a&&(this._set("memoryFactor",a),this.setDirty())}},{key:"lodFactor",set:function(a){this.lodFactor!==a&&(this._set("lodFactor",a),this.supportsResolution&&this.refetch())}},{key:"useTileCount",get:function(){return this._useTileCount&&k.isSome(this.context.query.queryFeatureCount)},set:function(a){this._useTileCount=a;this.notifyChange("useTileCount")}},{key:"memoryForUnusedFeatures",
get:function(){let a=0;this.featureTiles.forEach(b=>a+=b.estimatedUnusedSize);return a}},{key:"totalVertices",get:function(){let a=0;this.featureTiles.forEach(b=>a+=b.numVertices);return a}},{key:"totalFeatures",get:function(){let a=0;this.featureTiles.forEach(b=>a+=b.numFeatures);return a}},{key:"filterExtent",set:function(a){if(a&&this.context.tilingScheme&&!a.spatialReference.equals(this.context.tilingScheme.spatialReference))D.error("#filterExtent\x3d","extent needs to be in the same spatial reference as the tiling scheme");
else{var b=this._get("filterExtent");b===a||b&&a&&b.equals(a)||(a=a?a.clone():null,this._set("filterExtent",a),this.reclip(a,b))}}},{key:"paused",get:function(){return this.suspended||!!this.pendingEdits}},{key:"availableFields",get:function(){let a=null;this.featureTiles.forEach(b=>{k.isNone(b.displayingFeatures)||0===b.displayingFeatures.length||(k.isNone(a)?a=new Set(b.availableFields):a.forEach(c=>{b.availableFields.has(c)||k.unwrap(a).delete(c)}))});return k.isSome(a)?a:new Set}},{key:"running",
get:function(){return this.updating}},{key:"supportsResolution",get:function(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}},{key:"storedFeatures",get:function(){return this.getListOfTiles().reduce((a,b)=>a+(b.features?b.features.length:0),0)}},{key:"test",get:function(){return{process:a=>this.runTask(a),getFeatureTileById:a=>this.featureTiles.get(a),forEachFeatureTile:a=>this.featureTiles.forEach(a)}}}]);return l}(N);q.__decorate([t.property({constructOnly:!0})],
p.FeatureTileFetcher3D.prototype,"features",void 0);q.__decorate([t.property()],p.FeatureTileFetcher3D.prototype,"tileDescriptors",void 0);q.__decorate([t.property({value:Infinity})],p.FeatureTileFetcher3D.prototype,"maximumNumberOfFeatures",null);q.__decorate([t.property({value:1})],p.FeatureTileFetcher3D.prototype,"memoryFactor",null);q.__decorate([t.property({value:1})],p.FeatureTileFetcher3D.prototype,"lodFactor",null);q.__decorate([t.property()],p.FeatureTileFetcher3D.prototype,"useTileCount",
null);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"updating",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"updatingTotal",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"updatingRemaining",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"expectedFeatureDiff",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"memoryForUnusedFeatures",
null);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"maximumNumberOfFeaturesExceeded",void 0);q.__decorate([t.property({constructOnly:!0})],p.FeatureTileFetcher3D.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"totalVertices",null);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"totalFeatures",null);q.__decorate([t.property()],p.FeatureTileFetcher3D.prototype,
"filterExtent",null);q.__decorate([t.property({constructOnly:!0})],p.FeatureTileFetcher3D.prototype,"context",void 0);p.FeatureTileFetcher3D=q.__decorate([T.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],p.FeatureTileFetcher3D);const L=y.create(),M=y.create();q=p.FeatureTileFetcher3D;p.contextCapabilitiesFromLayer=function(n){const l=n.capabilities.query;a:switch(n.geometryType){case "polyline":n=!0;break a;case "polygon":n=n.capabilities&&n.capabilities.query&&n.capabilities.query.supportsQuantization;
break a;default:n=!1}return{supportsMultipleResolutions:n,supportsPagination:!(!l||!l.supportsPagination),supportsResultType:!(!l||!l.supportsResultType),supportsCacheHint:!(!l||!l.supportsCacheHint),supportsQuantization:!(!l||!l.supportsQuantization),supportsQuantizationEditMode:!(!l||!l.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!l||!l.supportsMaxRecordCountFactor),supportsFormatPBF:!(!l||!l.supportsFormatPBF)}};p.default=q;Object.defineProperty(p,"__esModule",{value:!0})});