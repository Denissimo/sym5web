// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../layers/graphics/hydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../layers/support/layerUtils ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./Graphics3DGraphicCreationContext ./graphicSymbolUtils ./labelPlacement ../../support/debugFlags ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas ../../webgl-engine/lib/WebGLLayer ../../../support/Scheduler".split(" "),
function(q,x,y,I,D,J,K,L,r,t,z,aa,ba,ca,M,N,O,B,P,Q,R,S,T,U,E,V,W,X,Y,Z){const F=K.getLogger("esri.views.3d.layers.graphics.Labeler");q.Labeler=function(G){function A(){var b=G.apply(this,arguments)||this;b._dirty=!1;b._labels=new Map;b._labelsToAdd=new Map;b._labelsToRemove=new Map;b._labelingContexts=[];return b}x._inheritsLoose(A,G);var f=A.prototype;f.setup=function(){this.dispose();this._handles=new J;this._handles.add([this.view.watch("state.camera",()=>this.setDirty()),this.view.watch("pixelRatio",
()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(Z.TaskPriority.LABELER,this)]);this._textTextureAtlas=new X["default"]({view:this.view});this._hudMaterialCollection=new E.MaterialCollection(this.view._stage);this._calloutMaterialCollection=new E.MaterialCollection(this.view._stage)};f.dispose=function(){this._handles=r.destroyMaybe(this._handles);this._textTextureAtlas=r.disposeMaybe(this._textTextureAtlas);this._hudMaterialCollection=r.disposeMaybe(this._hudMaterialCollection);
this._calloutMaterialCollection=r.disposeMaybe(this._calloutMaterialCollection);this._labelingContexts.length=0;this._labels.clear();this._labelsToAdd.clear();this._labelsToRemove.clear()};f._activateLabelingContext=function(b){b.labels.forEach((a,c)=>{this._labels.set(c,a);a.graphics3DGraphic.setVisibilityFlag(0,!0,1)});b.active=!0};f._deactivateLabelingContext=function(b){b.labels.forEach((a,c)=>{a.graphics3DGraphic.setVisibilityFlag(0,!1,1);this.setLabelGraphicVisibility(a.graphics3DGraphic,!1);
this._labels.delete(c)});b.active=!1};f._addLabelTextureToAtlas=function(b){for(const a of b.graphics3DGraphic.labelGraphics){if(!a._labelClass)continue;const c=b.textRenderers[a._labelIndex];c&&this._textTextureAtlas.addTextTexture(c,a.stageObject)}b.rendered=!0};f._removeLabelTextureFromAtlas=function(b){for(const a of b.graphics3DGraphic.labelGraphics){if(!a._labelClass)continue;const c=b.textRenderers[a._labelIndex];c&&this._textTextureAtlas.removeTextTexture(c,a.stageObject)}b.rendered=!1};f.runTask=
function(b){this._updateLabels(b);!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(b)};f._updateLabels=function(b){if(this._dirty){this._dirty=!1;for(const a of this._labelingContexts)if(a.active&&B.areLabelsVisible(a.layer)){if(!a.labelClassContexts||!a.labelClassContexts.length){if(null===a.labelClassContexts){this._deactivateLabelingContext(a);continue}this._createLabelClassContext(a);if(a.labelClassPromise&&a.labelClassAbortController){this._dirty=!0;continue}if(!a.labelClassContexts||
!a.labelClassContexts.length)continue}L.someMap(a.labelsToInitialize,(c,d)=>{this._ensureGraphics3DResources(c)&&(this._labels.set(d,c),this.deconflictor.setDirty(),b.madeProgress());if(c.visible&&c.hasTextTextureResources||!c.visible&&c.hasGraphics3DResources)a.labelsToInitialize.delete(d),b.madeProgress();return b.done})&&(this._dirty=!0)}this._labelsToRemove.forEach(a=>this._removeLabelTextureFromAtlas(a));this._labelsToAdd.forEach(a=>this._addLabelTextureToAtlas(a));this._labelsToRemove.clear();
this._labelsToAdd.clear();this._dirty||this.notifyChange("updating")}};f._createLabelClassContextAsync=function(){var b=x._asyncToGenerator(function*(a){var c=this;const d=a.labelClassAbortController.signal;yield a.layer.when();t.throwIfAborted(d);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();const e=a.graphics3DCore;var k=e.layer;if((k=k.labelingInfo&&k.labelingInfo.filter(n=>!!n.symbol))&&0!==k.length){var g=Array(k.length),h=!1;yield D.forEach(k,function(){var n=x._asyncToGenerator(function*(l,
u){var m=l.symbol;const p=S.getGraphics3DSymbol(e.getOrCreateGraphics3DSymbol(m));if(r.isNone(p))F.error("Failed to create Graphics3DSymbol for label");else{yield p.load();t.throwIfAborted(d);var w=null;P.isCalloutSupport(m)&&m.hasVisibleCallout()&&(w=Q.make(m,e.symbolCreationContext),yield w.load(),t.throwIfAborted(d));m=yield D.result(O.createLabelFunction(l,a.layer.fieldsIndex,c.view.spatialReference));t.throwIfAborted(d);!0===m.ok?g[u]={labelClass:l,labelFunction:m.value,graphics3DSymbol:p,graphics3DCalloutSymbolLayer:w,
calloutSymbolLayerIndex:0,textRenderParameters:c._createTextRenderParameters(p.symbol)}:(F.error(`Label expression failed to evaluate: ${m.error}`),h=!0)}});return function(l,u){return n.apply(this,arguments)}}());t.throwIfAborted(d);h||(a.labelClassContexts=g)}});return function(a){return b.apply(this,arguments)}}();f._createLabelClassContext=function(){var b=x._asyncToGenerator(function*(a){a.labelClassPromise||(a.labelClassPromise=this._createLabelClassContextAsync(a).catch(c=>{if(t.isAbortError(c))throw c;
a.labelClassContexts=null}).then(()=>{a.labelClassAbortController=null;this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating"));return a.labelClassPromise});return function(a){return b.apply(this,arguments)}}();f._createTextRenderParameters=function(b){return(b=b.symbolLayers.getItemAt(0))&&"text"===b.type?W.TextRenderParameters.fromSymbol(b,this.view.pixelRatio):null};f._destroyLabelClassContext=function(b){for(var a of b.labelClassContexts)--a.graphics3DSymbol.referenced,a.graphics3DSymbol=
null;a=b.labelClassAbortController;b.labelClassAbortController=t.createAbortController();a&&a.abort();b.labelClassContexts=[];b.labelClassPromise=null;this.notifyChange("updating")};f._createTextSymbolGraphic=function(b,a,c,d,e){b={text:b.text,centerOffset:c.centerOffset,translation:c.translation,elevationOffset:c.elevationOffset,screenOffset:c.screenOffset,anchor:c.anchor,centerOffsetUnits:c.centerOffsetUnits,verticalOffset:c.verticalOffset,debugDrawBorder:U.LABELS_SHOW_BORDER,displayWidth:b.displayWidth,
displayHeight:b.displayHeight};v.graphic=a;v.renderingInfo=null;v.layer=d;return e.createLabel(v,b,this._hudMaterialCollection,this._textTextureAtlas)};f._createLineCalloutGraphic=function(b,a,c,d,e){a={symbol:a,translation:d.translation,elevationOffset:d.elevationOffset,screenOffset:d.screenOffset,centerOffset:d.centerOffset,centerOffsetUnits:d.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};v.graphic=b;v.renderingInfo=a;v.layer=e;return c.createGraphics3DGraphic(v)};f._ensureGraphics3DResources=
function(b){if(b.hasGraphics3DResources)return!1;const a=b.graphics3DGraphic;if(a.destroyed)return!1;this._ensureTextTextureResources(b);const c=b.labelingContext,d=c.labelClassContexts;if(!d||0===d.length||!c.emptySymbolLabelSupported&&0===a._graphics.length)return!1;var e=!1,k=a.graphic;const g=c.layer;var h=B.areLabelsVisible(c.layer);const n=this.view._stage;for(let u=0;u<d.length;u++){const m=b.textRenderers[u];if(!m)continue;const p=d[u];var l=p.graphics3DSymbol;let w=null;l.symbol&&"label-3d"===
l.symbol.type&&(w=l.symbol);const C=l.symbolLayers[0];if(!C)continue;const H=p.labelClass;l=T.get({graphics3DGraphic:a,labelSymbol:w,labelClass:H,disablePlacement:c.disablePlacement});if(!r.isNone(l)){C.setElevationInfoOverride(c.elevationInfoOverride);e=this._createTextSymbolGraphic(m,k,l,g,C);if(!e)return!1;e._labelClass=H;e._labelIndex=u;a.addLabelGraphic(e,n,c.stageLayer);a.setVisibilityFlag(0,h,1);a.clearVisibilityFlag(1,1);a.setVisibilityFlag(3,!1,1);e=!0;(h=p.graphics3DCalloutSymbolLayer)&&
l.hasLabelVerticalOffset&&(h.setElevationInfoOverride(c.elevationInfoOverride),k=this._createLineCalloutGraphic(k,w,h,l,g))&&(p.calloutSymbolLayerIndex=a.labelGraphics.length,a.addLabelGraphic(k,n,c.stageLayer));break}}c.scaleVisibility&&e&&c.scaleVisibility.updateGraphicLabelScaleVisibility(a);return b.hasGraphics3DResources=!0};f._destroyGraphics3DResources=function(b){const a=b.labelingContext.labelClassContexts;for(const c of b.graphics3DGraphic.labelGraphics){if(null==c._labelClass)continue;
const d=a[c._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=d)d.onRemoveGraphic(c)}b.graphics3DGraphic.clearLabelGraphics();b.hasGraphics3DResources=!1};f._ensureTextTextureResources=function(b){if(!b.hasTextTextureResources){var a=b.labelingContext,c=a.labelClassContexts;if(c&&0!==c.length){var d=b.graphics3DGraphic.graphic;for(let e=0;e<c.length;e++){const k=c[e];b.textRenderers[e]=null;if(!k.textRenderParameters)continue;const g=k.labelFunction;let h;if("arcade"===g.type)try{const n=g.needsHydrationToEvaluate()?
N.hydrateGraphic(d,a.layer):d;h=g.evaluate(n)}catch(n){h=null}else h=g.evaluate(d);r.isNone(h)||""===h||/^\s+$/.test(h)||(b.textRenderers[e]=new V.TextRenderer(h,k.textRenderParameters))}b.hasTextTextureResources=!0}}};f._destroyTextTextureResources=function(b){b.textRenderers=[];b.hasTextTextureResources=!1};f._addGraphic=function(b,a){const c={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:b,graphics3DGraphic:a,textRenderers:[]};a=a.graphic.uid;b.labels.set(a,
c);b.labelsToInitialize.set(a,c);this.setDirty();this.deconflictor.setDirty()};f._removeGraphic=function(b,a){a=a.graphic.uid;const c=b.labels.get(a);c&&(this._destroyGraphic(c,a),b.labels.delete(a),b.labelsToInitialize.delete(a),this.setDirty(),this.deconflictor.setDirty())};f._destroyGraphic=function(b,a){this._labels.has(a)&&(this._labels.delete(a),this._labelsToAdd.delete(a),this._labelsToRemove.delete(a));b.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(b),this._destroyTextTextureResources(b));
b.hasGraphics3DResources&&this._destroyGraphics3DResources(b)};f._labelingInfoChange=function(){var b=x._asyncToGenerator(function*(a,c){if(c)for(const d of c){if(c=a.labels.get(d))this._removeGraphic(a,c.graphics3DGraphic),this._addGraphic(a,c.graphics3DGraphic)}else return this._visibilityInfoChange(a),this._resetLabels(a),this._createLabelClassContext(a)});return function(a,c){return b.apply(this,arguments)}}();f._globalPropertyChanged=function(b,a){for(const c of a.labelClassContexts){const d=
new Map;a.labels.forEach(e=>{e=e.graphics3DGraphic;d.set(e.graphic.uid,e)});r.unwrap(c.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(b,d,e=>e.labelGraphics[0]);c.graphics3DCalloutSymbolLayer&&c.graphics3DCalloutSymbolLayer.globalPropertyChanged(b,d,e=>e.labelGraphics[c.calloutSymbolLayerIndex])}};f._visibilityInfoChange=function(b){const a=b.layer.labelsVisible;a&&!b.active&&this._activateLabelingContext(b);!a&&b.active&&this._deactivateLabelingContext(b);this.setDirty()};f._resetAllLabels=
function(){for(const b of this._labelingContexts)this._resetLabels(b)};f._resetLabels=function(b){b.labels.forEach((a,c)=>{this._destroyGraphic(a,c);a.visible=!1;a.rendered=!1;b.labelsToInitialize.set(c,a)});this._destroyLabelClassContext(b);this.setDirty();this.deconflictor.setDirty()};f._findLabelingContext=function(b){for(const a of this._labelingContexts)if(a.graphics3DCore===b)return a;return null};f.addGraphicsOwner=function(b,a,c){const d=c&&c.emptySymbolLabelSupported||!1,e=c&&c.elevationInfoOverride||
null;c=c&&c.disablePlacement||null;if(!this._findLabelingContext(b)){var k=b.layer,g={graphics3DCore:b,layer:k,scaleVisibility:a,emptySymbolLabelSupported:d,elevationInfoOverride:e,disablePlacement:c,active:k.labelsVisible,labelClassPromise:null,labelClassAbortController:t.createAbortController(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new Y.WebGLLayer({isPickable:!0},k.uid)};this.view._stage.add(g.stageLayer);this._labelingContexts.push(g);this.setDirty();return{addGraphic:h=>
this._addGraphic(g,h),removeGraphic:h=>this._removeGraphic(g,h),featureReductionChange:()=>{},layerLabelsEnabled:()=>B.areLabelsVisible(g.layer),labelingInfoChange:h=>this._labelingInfoChange(g,h),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",g),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",g),visibilityInfoChange:()=>this._visibilityInfoChange(g),reset:()=>this._resetLabels(g),clear:()=>{}}}};f.removeGraphicsOwner=function(b){const a=this._findLabelingContext(b);
a&&(b=this._labelingContexts.indexOf(a),this._labelingContexts.splice(b,1),a.labels.forEach(c=>this._removeGraphic(a,c.graphics3DGraphic)),this.view._stage.remove(a.stageLayer),a.stageLayer=null,this.setDirty())};f.setLabelGraphicVisibility=function(b,a){b=b.graphic.uid;const c=this._labels.get(b);c&&c.visible!==a&&(a&&!c.rendered?(this._labelsToAdd.set(b,c),this._labelsToRemove.delete(b),c.hasTextTextureResources||c.labelingContext.labelsToInitialize.set(b,c)):!a&&c.rendered&&(this._labelsToRemove.set(b,
c),this._labelsToAdd.delete(b)),c.visible=a,this.setDirty())};f.setDirty=function(){!this._dirty&&0<this._labelingContexts.length&&(this._dirty=!0,this.notifyChange("updating"))};x._createClass(A,[{key:"running",get:function(){var b;return this.view.ready?this._dirty||(null==(b=this._textTextureAtlas)?void 0:b.updating)||this.deconflictor.running:!1}},{key:"updating",get:function(){var b;return this._dirty||(null==(b=this._textTextureAtlas)?void 0:b.updating)||this.deconflictor.updating||this._labelingContexts.some(a=>
a.labelClassPromise&&!!a.labelClassAbortController)}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;const b=0<this._labelingContexts.length?this._labelingContexts.reduce((a,c)=>a+(c.labelClassPromise&&c.labelClassAbortController?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*b+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>
this._resetAllLabels()}}}]);return A}(I);y.__decorate([z.property({constructOnly:!0})],q.Labeler.prototype,"view",void 0);y.__decorate([z.property({constructOnly:!0})],q.Labeler.prototype,"deconflictor",void 0);y.__decorate([z.property()],q.Labeler.prototype,"_textTextureAtlas",void 0);y.__decorate([z.property({type:Boolean,readOnly:!0})],q.Labeler.prototype,"updating",null);q.Labeler=y.__decorate([M.subclass("esri.views.3d.layers.graphics.Labeler")],q.Labeler);const v=new R(null,null,null);Object.defineProperty(q,
"__esModule",{value:!0})});