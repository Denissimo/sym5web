// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../geometry ../../../../../core/Accessor ../../../../../core/Handles ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/Logger ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/trackingUtils ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/support/ray ./LineOfSightAnalysis ../../../webgl-engine/lib/Intersector ../../../webgl-engine/lib/intersectorUtilsConversions ../../../../support/Scheduler ../../../../../geometry/Point".split(" "),
function(h,D,m,S,L,G,v,k,H,q,T,U,V,W,M,r,d,x,I,N,O,P,y,Q){h.LineOfSightController=function(J){function A(a){a=J.call(this,a)||this;a._tasks=y.ImmediateTask;a._handles=new G;a._analysisHandles=new G;return a}D._inheritsLoose(A,J);var e=A.prototype;e.initialize=function(){var a;const b=null==(a=this.view.resourceController)?void 0:a.scheduler;b&&(this._tasks=b.registerTask(y.TaskPriority.LINE_OF_SIGHT_TOOL));this._handles.add([r.reactionInit(()=>this.model.observer,c=>this._onObserverChange(c)),this._connectAnalyses(),
this._connectTargets()]);this._intersector=new O.Intersector(this.view.state.viewingMode);this._intersector.options.hud=!1;this._intersector.options.store=0};e.destroy=function(){this._handles.destroy();this._analysisHandles.destroy();this._analyses.removeAll()};e.getLineOfSightComputationDependencies=function(a){({inputPoints:a}=a);return{inputPoints:a}};e.computeAnalysis=function(a,b=!1){const {analysis:c}=a,{inputPoints:f,computationResult:g}=c,{observerAdjusted:l,targetAdjusted:n}=f,{start:p,
end:t}=g;d.copy(p,l);d.copy(t,n);b||this._canComputeAnalysis(c)?this._computeAnalysisIntersection(a):this._interpolateAnalysisIntersection(a);c.updateComputationResults()};e._adjustStartEndPositions=function(a){var b=this._screenPixelSize;const c=this.view;({inputPoints:a}=a);const {observer:f,target:g,observerAdjusted:l,targetAdjusted:n}=a;a=E;d.subtract(a,g,f);d.normalize(a,a);d.scale(a,a,Math.min(b,1));d.add(l,f,a);d.subtract(a,f,g);b=c.state.camera.computeScreenPixelSizeAt(g);d.normalize(a,a);
d.scale(a,a,Math.min(b,1));d.add(n,g,a)};e._computeAnalysisIntersection=function({analysis:a,interpolationInfo:b}){const {view:c}=this,{sceneIntersectionHelper:f,renderCoordsHelper:g}=c;if(!k.isNone(f)){var l=this._intersector,{computationResult:n,inputPoints:p}=a,{observer:t,target:u}=p,{start:w,end:F}=n,B=I.fromPoints(w,F,R);f.intersectToolIntersectorRay(B,l);var C=n.intersection,K=E;B=l.results.min?l.results.min.getIntersectionPoint(C):!1;var z=!0;B&&(d.copy(b.originalIntersection,C),d.copy(b.originalObserver,
w),d.copy(b.originalTarget,F),g.fromRenderCoords(C,K,c.spatialReference),b=1-d.dist(F,u)/d.dist(w,u),z=d.dist(t,C)>=b*d.dist(t,u));b=new Q(K,c.spatialReference);a.target.intersectedLocation=z?null:b;a.target.intersectedGraphic=z?null:P.toGraphic(l.results.min,c);a.target.visible=B?z:!1;n.isValid=p.isValid=!0;n.isTargetVisible=z}};e._interpolateAnalysisIntersection=function({analysis:a,interpolationInfo:b}){const {computationResult:c,inputPoints:f,target:g}=a,{start:l,end:n,intersection:p}=c,{originalIntersection:t,
originalObserver:u,originalTarget:w}=b;d.copy(p,t);f.isValid?(a=E,b=d.dist(u,t)/d.dist(u,w),d.sub(a,l,u),d.scale(a,a,1-b),d.add(p,p,a),d.sub(a,n,w),d.scale(a,a,b),d.add(p,p,a),c.isValid=!0):(g.intersectedLocation=null,g.intersectedGraphic=null,g.visible=void 0,c.isValid=!1,c.isTargetVisible=!1)};e._canComputeAnalysis=function(a){var b=this.view.frustum;if(k.isNone(this.model.observer)||k.isNone(a.target.location)||k.isNone(b))return!1;const {observerAdjusted:c,targetAdjusted:f}=a.inputPoints;a=b.intersectsPoint(c);
b=b.intersectsPoint(f);return a&&b};e._onObserverChange=function(a){if(k.isNone(a))this.model.targets.removeAll();else{var b=x.create();this.view.renderCoordsHelper.toRenderCoords(a,b);this._observerEngineLocation=b;this.priority=y.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE}};e._onObserverChangeForAnalysis=function(a){a.inputPoints.isValid=!1};e._onObserverEngineForAnalysis=function(a,b){const {inputPoints:c}=a;d.copy(c.observer,b);this._adjustStartEndPositions(a);a.updateInputPoints();this.priority=
y.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE};e._onTargetLocationChange=function(a,b){const {inputPoints:c}=a;c.isValid=!1;this.view.renderCoordsHelper.toRenderCoords(b,c.target);this._adjustStartEndPositions(a);a.updateInputPoints();this.priority=y.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE};e._connectAnalysisToTarget=function(a){return r.reactionInit(()=>({analysis:a,targetLocation:a.target.location}),({analysis:b,targetLocation:c})=>{k.isSome(c)&&this._onTargetLocationChange(b,c)})};e._connectAnalysisToObserver=
function(a){return r.reactionInit(()=>({analysis:a,observer:this.model.observer}),({analysis:b})=>{this._onObserverChangeForAnalysis(b)})};e._connectAnalysisToObserverEngine=function(a){return r.reactionInit(()=>({analysis:a,observer:this._observerEngineLocation}),({analysis:b,observer:c})=>{this._onObserverEngineForAnalysis(b,c)})};e._connectAnalysisForCompute=function(a){var b=this;let c=k.none;const f={analysis:a,interpolationInfo:{originalIntersection:x.create(),originalObserver:x.create(),originalTarget:x.create()}};
return v.handlesGroup([r.reactionInit(()=>this.getLineOfSightComputationDependencies(a),()=>{c=k.abortMaybe(c);c=H.createTask(function(){var g=D._asyncToGenerator(function*(l){yield H.ignoreAbortErrors(b._tasks.schedule(()=>b.computeAnalysis(f),l))});return function(l){return g.apply(this,arguments)}}())}),v.makeHandle(()=>c=k.abortMaybe(c))])};e._connectAnalysis=function(a){const b=this._analysisHandles;b.has(a)||b.add([this._connectAnalysisToTarget(a),this._connectAnalysisToObserver(a),this._connectAnalysisToObserverEngine(a),
this._connectAnalysisForCompute(a)])};e._disconnectAnalysis=function(a){this._analysisHandles.remove(a)};e._onAnalysesCollectionChange=function(a){a.added.forEach(b=>this._connectAnalysis(b));a.removed.forEach(b=>this._disconnectAnalysis(b))};e._onTargetsChange=function(a){this._analyses.removeAll();0<a.items.length&&this._onTargetCollectionChange({target:a,added:a.items,removed:[],moved:[]})};e._onTargetCollectionChange=function(a){const b=this._analyses;a.added.forEach(c=>{b.some(f=>f.target===
c)||b.add(new N.LineOfSightAnalysis({target:c}))});a.removed.forEach(c=>{const f=b.find(g=>g.target===c);b.remove(f)})};e._connectAnalyses=function(){let a=null;return v.handlesGroup([r.reactionInit(()=>this._analyses,b=>{a=k.removeMaybe(a);a=b.on("change",c=>this._onAnalysesCollectionChange(c));this._onAnalysesCollectionChange({target:b,added:b.items,removed:[],moved:[]})}),v.makeHandle(()=>a=k.removeMaybe(a))])};e._connectTargets=function(){let a=null;return v.handlesGroup([r.reactionInit(()=>this.model.targets,
b=>{a=k.removeMaybe(a);a=b.on("change",c=>this._onTargetCollectionChange(c));this._onTargetsChange(b)}),v.makeHandle(()=>a=k.removeMaybe(a))])};D._createClass(A,[{key:"updating",get:function(){return this._tasks.updating}},{key:"priority",get:function(){return this._tasks.priority},set:function(a){this._tasks.priority=a}},{key:"_viewData",get:function(){return this.model.viewData}},{key:"_analyses",get:function(){return this._viewData.analyses}},{key:"_observerEngineLocation",get:function(){return this._viewData.observerEngineLocation},
set:function(a){this._viewData.observerEngineLocation=a}},{key:"_screenPixelSize",get:function(){return this.view.state.camera.computeScreenPixelSizeAt(this._observerEngineLocation)}}]);return A}(L);m.__decorate([q.property()],h.LineOfSightController.prototype,"model",void 0);m.__decorate([q.property()],h.LineOfSightController.prototype,"view",void 0);m.__decorate([q.property()],h.LineOfSightController.prototype,"updating",null);m.__decorate([q.property()],h.LineOfSightController.prototype,"priority",
null);m.__decorate([q.property()],h.LineOfSightController.prototype,"_viewData",null);m.__decorate([q.property()],h.LineOfSightController.prototype,"_analyses",null);m.__decorate([q.property()],h.LineOfSightController.prototype,"_observerEngineLocation",null);m.__decorate([q.property()],h.LineOfSightController.prototype,"_screenPixelSize",null);m.__decorate([q.property()],h.LineOfSightController.prototype,"_tasks",void 0);h.LineOfSightController=m.__decorate([M.subclass("esri.views.3d.interactive.graphics.LineOfSight.LineOfSightController")],
h.LineOfSightController);const E=x.create(),R=I.create();Object.defineProperty(h,"__esModule",{value:!0})});