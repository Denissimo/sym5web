// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Error ../../../core/maybe ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../layers/graphics/hydratedFeatures ../../../layers/graphics/controllers/FeatureTileController3D ./FeatureLikeLayerView3D ./LayerView3D ./support/FeatureTileFetcher3DLayerViewContext ../support/EventedSet ../support/updatingProperties ../../layers/FeatureLayerView ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),
function(k,g,u,q,r,h,e,H,I,J,v,w,x,y,z,A,B,C,D,E,F){e=function(n){function p(a){a=n.call(this,a)||this;a._controllerTotal=0;a._graphicsCoreTotal=0;a.suspendResumeExtentMode="data";return a}k._inheritsLoose(p,n);var d=p.prototype;d.initialize=function(){this.updatingHandles.add(this,"view.floors",()=>this.graphics3d.filterVisibility.filterChanged())};d.destroy=function(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)};d.fetchPopupFeatures=function(){var a=k._asyncToGenerator(function*(b,
c){return(b=this.validateFetchPopupFeatures(c))?Promise.reject(b):this.fetchClientPopupFeatures(c)});return function(b,c){return a.apply(this,arguments)}}();d.setVisibility=function(a,b){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(a,b)};d.createQuery=function(){return n.prototype.createQuery.call(this)};d.queryFeatures=function(a,b){const c=()=>n.prototype.queryFeatures.call(this,a,b);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(a),c):c()};
d.beforeSetController=function(a){a.maximumNumberOfFeatures=this.maximumNumberOfFeatures};d.createController=function(){this.fetcherContext=new A.FeatureTileFetcher3DLayerViewContext({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const a=new x.FeatureTileController3D({layerView:this,context:this.fetcherContext,graphics:new B.EventedSet,extent:this.clippingExtent});this.updatingHandles.add(a,"serviceDataExtent",b=>{this.graphics3d&&(this.graphics3d.dataExtent=b)},2);this.handles.add(r.init(this,
"suspended",b=>{b?a.suspend():a.resume()},!0));this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",()=>this.updateDisplayFeatureLimit(a),2);this.handles.add([this.view.resourceController.memoryController.events.on("quality-changed",()=>this.updateDisplayFeatureLimit()),r.whenFalse(this,"updating",()=>{this._graphicsCoreTotal=this._controllerTotal=0;this.notifyChange("updatingProgressValue")})]);return a};d.doRefresh=function(){var a=k._asyncToGenerator(function*(){!this.suspended&&
this.controller&&this.controller.refetch()});return function(){return a.apply(this,arguments)}}();d.getUsedMemory=function(){const a=this.graphics3d&&this.graphics3d.graphicsCore;return(a?a.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)};d.getUnloadedMemory=function(){const a=this.graphics3d&&this.graphics3d.graphicsCore;return(a?a.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*a.usedMemoryPerGraphic:0)};d.ignoresMemoryFactor=function(){return this.controller&&
this.controller.hasMaximumNumberOfFeaturesOverride};d.updateDisplayFeatureLimit=function(a=this.controller){if(a&&this.graphics3d&&this.graphics3d.graphicsCore){var b=this.graphics3d.graphicsCore.displayFeatureLimit,c=this.view.resourceController.memoryController.memoryFactor;a.displayFeatureLimit=1===c?b:{...b,maximumNumberOfFeatures:Math.ceil(b.maximumNumberOfFeatures*c),maximumTotalNumberOfFeatures:Math.ceil(b.maximumTotalNumberOfFeatures*c),minimumTotalNumberOfFeatures:Math.ceil(b.minimumTotalNumberOfFeatures*
c)}}};d._queryFeaturesMesh=function(){var a=k._asyncToGenerator(function*(b,c){yield this._validateQueryFeaturesMesh(b);c=yield c();if(b&&b.outStatistics)return c;b=this.layer.objectIdField;const l=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,f=[];for(const m of c.features)if(m.geometry){const t=l.get(m.attributes[b]);t&&(m.geometry=w.hydrateGeometry(t.graphic.geometry),f.push(m))}else f.push(m);c.features=f;return c});return function(b,c){return a.apply(this,arguments)}}();d._validateQueryFeaturesMesh=
function(){var a=k._asyncToGenerator(function*(b){if(b){var c=f=>{throw new u("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${f}'`);},l=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const f of l)null!=b[f]&&c(f);"returnM"in b&&b.returnM&&c("returnM");"returnCentroid"in b&&b.returnCentroid&&c("returnCentroid");q.isSome(b.outSpatialReference)&&!b.outSpatialReference.equals(this.view.spatialReference)&&c("outSpatialReference")}});
return function(b){return a.apply(this,arguments)}}();k._createClass(p,[{key:"maximumNumberOfFeatures",get:function(){var a,b;return null!=(a=null==(b=this.controller)?void 0:b.maximumNumberOfFeatures)?a:this._get("maximumNumberOfFeatures")},set:function(a){this._set("maximumNumberOfFeatures",a);this.controller&&(this.controller.maximumNumberOfFeatures=a)}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return this.controller?!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded):
!1}},{key:"updatingProgressValue",get:function(){var a,b,c;let l=0;if(null!=(a=this.controller)&&a.updating){a=this.controller.updatingRemaining;const f=Math.max(this.controller.updatingTotal,this._controllerTotal);0<f&&(l=(f-a)/f,this._controllerTotal=f)}a=0;null!=(b=this.graphics3d)&&null!=(c=b.graphicsCore)&&c.updating&&(b=this.graphics3d.graphicsCore.updatingRemaining,c=Math.max(b,this._graphicsCoreTotal),0<c&&(a=(c-b)/c,this._graphicsCoreTotal=c));return.5*(l+a)}},{key:"updatePolicy",get:function(){if(!this.controller)return 0;
switch(this.controller.mode){case "snapshot":{const a=G[this.layer.geometryType];return null==a||this.controller.serviceDataCount>a?0:1}case "tiles":return 0}}},{key:"hasZ",get:function(){const a=this.layer,b=a.capabilities&&a.capabilities.data;return b&&b.supportsZ?"returnZ"in a&&null!=a.returnZ?a.returnZ:b.supportsZ:!1}},{key:"hasM",get:function(){const a=this.layer,b=a.capabilities&&a.capabilities.data;return b&&b.supportsM?"returnM"in a&&null!=a.returnM?a.returnM:!1:!1}},{key:"performanceInfo",
get:function(){var a=this.controller&&this.controller.displayFeatureLimit;a=q.isSome(a)&&a.averageSymbolComplexity;a=q.isSome(a)?`f:${a.primitivesPerFeature},v:${a.primitivesPerCoordinate}`:"n/a";a={...this._getResourceInfo(),storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?this.controller.mode:"n/a",symbolComplexity:a,nodes:this.controller?this.controller.tileDescriptors.length:0};if(this.controller&&a.displayedNumberOfFeatures){const b=this.controller.debug;
a.storedFeatures=b.storedFeatures;a.totalVertices=b.totalVertices}return a}},{key:"test",get:function(){return{updatePolicy:this.updatePolicy,controller:this.controller}}}]);return p}(F.RefreshableLayerView(y.FeatureLikeLayerView3D(D.FeatureLayerView(z.LayerView3D(E)))));g.__decorate([h.property()],e.prototype,"layer",void 0);g.__decorate([h.property()],e.prototype,"controller",void 0);g.__decorate([h.property()],e.prototype,"maximumNumberOfFeatures",null);g.__decorate([h.property()],e.prototype,
"maximumNumberOfFeaturesExceeded",null);g.__decorate([h.property(C.updatingProgress)],e.prototype,"updatingProgress",void 0);g.__decorate([h.property({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining"]})],e.prototype,"updatingProgressValue",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"updatePolicy",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"hasZ",null);g.__decorate([h.property({readOnly:!0})],
e.prototype,"hasM",null);g.__decorate([h.property()],e.prototype,"suspendResumeExtentMode",void 0);e=g.__decorate([v.subclass("esri.views.3d.layers.FeatureLayerViewBase3D")],e);const G={point:5E3,polygon:500,polyline:1E3};return e});