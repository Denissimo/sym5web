// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("require ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../support/requestImageUtils ./glUtil3D ./SSAOTechnique ./Util ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),function(w,x,b,y,z,A,v,B,C,q,D,r,E,t){let H=function(){function u(a,g,k){this._techniqueRep=a;this._rctx=g;this._requestRender=k;this._enabled=!1;this._ssaoTechniqueConfig=
new q.SSAOTechniqueConfiguration;this.quadVAO=null;this._BLUR_F=2;this._attenuation=.5;this._radius=3;this._samples=16;this._viewportToRestore=v.create()}var n=u.prototype;n.dispose=function(){this.quadVAO=b.disposeMaybe(this.quadVAO)};n.computeSSAO=function(a,g,k){if(!(!this.enabled||b.isNone(this._noiseTexture)||b.isNone(this._ssaoFBO)||b.isNone(this._blur0FBO)||b.isNone(this._blur1FBO))){var e=this._rctx,l=a.fullViewport,d=l[2],h=l[3];l=d/this._BLUR_F;var p=h/this._BLUR_F;this._ssaoFBO.resize(d,
h);this._blur0FBO.resize(l,p);this._blur1FBO.resize(l,p);l=1*d;p=1*h;A.copy(this._viewportToRestore,a.fullViewport);e.bindFramebuffer(this._ssaoFBO);e.setViewport(0,0,d,h);var c=this._ssaoTechnique.program;e.useProgram(c);e.setPipelineState(this._ssaoTechnique.pipeline);c.setUniform2f("rnmScale",d/this._noiseTexture.descriptor.width,h/this._noiseTexture.descriptor.height);c.setUniform3fv("pSphere",8>=this._samples?this._data.random8:16>=this._samples?this._data.random16:32>=this._samples?this._data.random32:
this._data.random64);d=this._data.minDiscrepancy;c.setUniform1f("numSpiralTurns",this._samples<d.length?d[this._samples]:5779);d=F;h=G;D.inverseProjectionInfo(a.projectionMatrix,a.fullWidth,a.fullHeight,d,h);c.setUniform4fv("projInfo",d);c.setUniform2fv("zScale",h);c.setUniform2f("nearFar",a.near,a.far);d=1/a.computeRenderPixelSizeAtDist(1);c.setUniform1f("projScale",1*d);c.setUniform2f("screenDimensions",l,p);h=z.distance(a.eye,a.center);var m=20*a.computeRenderPixelSizeAtDist(h);m=Math.max(.1,m);
c.setUniform1f("radius",m);c.setUniform1f("intensity",4*this._attenuation/m**6);c.bindTexture(this._noiseTexture,"rnm");c.bindTexture(k,"normalMap");c.bindTexture(g,"depthMap");b.isNone(this.quadVAO)&&(this.quadVAO=C.createQuadVAO(this._rctx));c=this.quadVAO;e.bindVAO(c);e.drawArrays(5,0,t.vertexCount(c,"geometry"));m=(q.FILTER_RADIUS+1)/2;m=1/(2*m*m);var f=this._blurTechnique.program;e.useProgram(f);f.bindTexture(this._ssaoFBO.colorTexture,"tex");f.bindTexture(k,"normalMap");f.bindTexture(g,"depthMap");
e.setViewport(0,0,l/this._BLUR_F,p/this._BLUR_F);e.bindFramebuffer(this._blur0FBO);f.setUniform2f("screenDimensions",l,p);f.setUniform2f("blurSize",0,1*this._BLUR_F/p);f.setUniform1i("radius",q.FILTER_RADIUS);f.setUniform1f("g_BlurFalloff",m);f.setUniform2f("nearFar",a.near,a.far);5E4<h&&(d=Math.max(0,d-(h-5E4)));f.setUniform1f("projScale",d);f.setUniform2f("zScale",1,0);e.drawArrays(5,0,t.vertexCount(c,"geometry"));f.setUniform2f("blurSize",1*this._BLUR_F/l,0);e.bindFramebuffer(this._blur1FBO);f.bindTexture(this._blur0FBO.colorTexture,
"tex");e.drawArrays(5,0,t.vertexCount(c,"geometry"));e.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}};n.bind=function(a){this.enabled&&b.isSome(this._blur1FBO)&&b.isSome(this._ssaoFBO)?(a.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),a.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):a.setUniform4f("viewportPixelSz",-1,-1,-1,-1)};n._selectPrograms=
function(){this._ssaoTechniqueConfig.samples=8>=this._samples?0:16>=this._samples?1:32>=this._samples?2:3;this._ssaoTechniqueConfig.output=0;this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(q.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique);this._ssaoTechniqueConfig.output=1;this._blurTechnique=this._techniqueRep.releaseAndAcquire(q.SSAOTechnique,this._ssaoTechniqueConfig,this._blurTechnique)};n._enable=function(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&
this._initialize()}))};n._loadResources=function(a){this._data?a():(new Promise(function(g,k){w(["./SSAOHelperData"],g,k)})).then(g=>{this._data=g;a()})};n._initialize=function(){const a={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},g={colorTarget:0,depthStencilTarget:0};B.requestImage(this._data.noiseTexture).then(k=>{this._enabled&&(this._ssaoFBO=new r(this._rctx,g,a),this._blur0FBO=new r(this._rctx,g,a),this._blur1FBO=new r(this._rctx,g,a),this._noiseTexture=
new E(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:k.width,height:k.height},k),this._requestRender())});this._selectPrograms()};n._disable=function(){this._enabled=!1;this._noiseTexture=b.disposeMaybe(this._noiseTexture);this._blur1FBO=b.disposeMaybe(this._blur1FBO);this._blur0FBO=b.disposeMaybe(this._blur0FBO);this._ssaoFBO=b.disposeMaybe(this._ssaoFBO)};x._createClass(u,[{key:"enabled",get:function(){return this._enabled},set:function(a){a?this._enable():this._disable()}},
{key:"attenuation",get:function(){return this._attenuation},set:function(a){this._attenuation=a}},{key:"radius",get:function(){return this._radius},set:function(a){this._radius=a}},{key:"samples",get:function(){return this._samples},set:function(a){this._samples=a;this._enabled&&this._selectPrograms()}},{key:"ready",get:function(){return this.enabled&&b.isSome(this._noiseTexture)&&b.isSome(this._ssaoFBO)&&b.isSome(this._blur0FBO)&&b.isSome(this._blur1FBO)}},{key:"gpuMemoryUsage",get:function(){return(b.isSome(this._blur0FBO)?
this._blur0FBO.gpuMemoryUsage:0)+(b.isSome(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(b.isSome(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]);return u}();const G=y.create(),F=v.create();return H});