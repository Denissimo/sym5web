// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/Handles ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/boundedPlane ../../../../../layers/Layer ../../../../../layers/buildingSublayers/BuildingComponentSublayer ../../analysisTools/slice/sliceToolUtils ../../../../../widgets/Slice/SlicePlane".split(" "),
function(e,q,k,x,y,z,c,t,n,F,G,H,A,B,u,C,p,D){function E(l,m){h.has(l)||h.set(l,{all:[],activeController:null});h.get(l).all.push(m)}const v=z.getLogger("esri.views.3d.interactive.graphics.Slice.SliceController");e.SliceController=function(l){function m(a){a=l.call(this,a)||this;a._handles=new y;a._internalChange=!1;a._currentSlicePlane=null;a.state="pending";return a}q._inheritsLoose(m,l);var f=m.prototype;f.initialize=function(){this._handles.add(this.layerView.layerViewData.excludedLayers.on("before-add",
a=>{const b=a.item;null!=b&&(b instanceof u||b instanceof C)?b instanceof u&&p.isAlwaysDrapedLayer(b)?(v.error("excludedLayers",`Layer '${b.title}, id:${b.id}' of type '${b.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),a.preventDefault()):this.layerView.layerViewData.excludedLayers.includes(b)&&a.preventDefault():(v.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),a.preventDefault())}));this._handles.add(t.whenOnce(this.view,
"ready",()=>this._initialize(),!0))};f._initialize=function(){switch(this.state){case "destroyed":return;case "ready":throw Error("state error");}E(this.view,this);this._handles.add([this.layerView.layerViewData.watch("plane",()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane();this._updateLayerViews()},!0),this.layerView.layerViewData.watch("excludeGroundSurface",()=>this._updateLayerViews(),!0),this.layerView.layerViewData.excludedLayers.on("change",()=>this._updateLayerViews()),
this.layerView.watch(["active","visible"],()=>{this._updateActiveController();this._updateViewSlicePlane()},!0),this.view.allLayerViews.on("change",()=>this._updateLayerViews())]);this._handles.add([this.analysis.watch("plane",()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},!0)],"analysis");this._set("state","ready");this._updateActiveController();this._updateBoundedPlaneFromSlicePlane();this._updateViewSlicePlane()};f.destroy=function(){switch(this.state){case "destroyed":case "pending":return}this.layerView.active=
!1;{var a=this.view;if(!h.has(a))throw Error("view expected in global slice register");const b=h.get(a),d=b.all.lastIndexOf(this);if(-1===d)throw Error("controller expected in global slice register");b.all.splice(d,1);0===b.all.length&&h.delete(a)}this._handles.destroy();this.view.slicePlane=null;this.set("view",null);this._set("state","destroyed")};f.whenReady=function(){var a=q._asyncToGenerator(function*(){yield t.whenOnce(this,"ready");return this});return function(){return a.apply(this,arguments)}}();
f._updateBoundedPlaneFromSlicePlane=function(){const a=this.analysis.plane;var b=this._currentSlicePlane;if(!(c.isNone(b)&&c.isNone(a)||c.isSome(b)&&c.isSome(a)&&a.equals(b))){var d=b=null;c.isSome(a)&&(b=p.shapeToPlane(a,this.view.renderCoordsHelper,B.create()),c.isSome(b)?d={heading:a.heading,tilt:a.tilt,position:a.position,width:a.width,height:a.height}:console.warn("Failed slice plane conversion."));this._currentSlicePlane=d;c.isSome(b)&&!this.analysis.tiltEnabled&&p.forceHorizontalOrVertical(b,
this.view.renderCoordsHelper,b);this._internalChange=!0;this.layerView.layerViewData.plane=b;this._internalChange=!1}};f._updateSlicePlaneFromBoundedPlane=function(){const a=this.layerView.layerViewData.plane,b=p.planeToShape(a,this.view.renderCoordsHelper,this.view.spatialReference,new D);let d=null;c.isSome(b)&&(d={heading:b.heading,tilt:b.tilt,position:b.position,width:b.width,height:b.height});this._currentSlicePlane=d;c.isSome(a)&&(this.analysis.tiltEnabled||p.forceHorizontalOrVertical(a,this.view.renderCoordsHelper,
a));this._internalChange=!0;this.analysis.plane=b;this._internalChange=!1;this._updateViewSlicePlane()};f._updateActiveController=function(){if(!r){var a=h.get(this.view);this.layerView.active?(c.isSome(a.activeController)&&a.activeController!==this?(r=!0,r=a.activeController.layerView.active=!1):c.isSome(a.activeController),this._updateLayerViews(),a.activeController=this):c.isSome(a.activeController)&&a.activeController!==this||!c.isSome(a.activeController)||a.activeController!==this||(a.activeController=
null,this._updateLayerViews())}};f._updateViewSlicePlane=function(){if("ready"===this.state){{var a=this.view;const b=h.get(a).activeController;c.isSome(b)&&c.isSome(b.layerView.layerViewData.plane)&&b.layerView.visible?a.slicePlane=b.layerView.layerViewData.plane:a.slicePlane=null}}};f._updateLayerViews=function(){const a=c.isSome(this.layerView.layerViewData.plane)&&this.layerView.visible&&this.layerView.active,b=[],d=g=>{"layers"in g?g.layers.forEach(d):b.push(g)};this.layerView.layerViewData.excludedLayers.forEach(d);
this.view.allLayerViews.forEach(g=>{"slicePlaneEnabled"in g&&(g.slicePlaneEnabled=a&&0>b.indexOf(g.layer));"sublayerViews"in g&&g.sublayerViews.forEach(w=>{w.slicePlaneEnabled=a&&0>b.indexOf(w.sublayer)})});null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=a&&!this.layerView.layerViewData.excludeGroundSurface)};q._createClass(m,[{key:"ready",get:function(){return"ready"===this.state}}]);return m}(x);k.__decorate([n.property({readOnly:!0})],e.SliceController.prototype,"state",
void 0);k.__decorate([n.property()],e.SliceController.prototype,"view",void 0);k.__decorate([n.property()],e.SliceController.prototype,"analysis",void 0);k.__decorate([n.property()],e.SliceController.prototype,"layerView",void 0);k.__decorate([n.property()],e.SliceController.prototype,"ready",null);e.SliceController=k.__decorate([A.subclass("esri.views.3d.interactive.graphics.Slice.SliceController")],e.SliceController);const h=new Map;let r=!1;Object.defineProperty(e,"__esModule",{value:!0})});