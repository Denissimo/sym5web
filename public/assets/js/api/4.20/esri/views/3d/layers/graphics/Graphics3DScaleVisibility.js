// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/maybe ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/Logger ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../support/layerViewUtils ../../../support/Scheduler".split(" "),function(q,k,e,u,l,n,x,y,z,A,v,r,w){e=function(t){function m(){var a=
t.apply(this,arguments)||this;a._scaleRangeActive=!1;a.layerScaleRangeVisibilityQuery=!1;a.handles=new u;a.layerView=null;a.layer=null;a.queryGraphicUIDsInExtent=null;a.extent=null;a.graphicsCore=null;a.basemapTerrain=null;a.layerScaleEnabled=!0;a.suspended=!1;a.updating=!0;return a}q._inheritsLoose(m,t);var c=m.prototype;c.setup=function(a,b,d,p,g){this.layerView=a;this.layer=b;this.queryGraphicUIDsInExtent=d;this.graphicsCore=p;this.basemapTerrain=g;this.updateScaleRangeActive();this.handles.add(this.layerView.view.resourceController.scheduler.registerTask(w.TaskPriority.SCALE_VISIBILITY,
this))};c.destroy=function(){this.handles.destroy();this.graphicsCore=this.queryGraphicUIDsInExtent=this.extent=this.layerView=this.handles=null};c._setDirty=function(){this.updating||this._set("updating",!0)};c.setExtent=function(a){this.extent=a;this._setDirty()};c.scaleRangeActive=function(){return this._scaleRangeActive};c.updateScaleRangeActive=function(){var a=this.layer;let b=this.layerScaleEnabled&&(0<a.minScale||0<a.maxScale);a.labelingInfo&&!b&&(b=a.labelingInfo.some(d=>d&&(0<d.minScale||
0<d.maxScale)));a=this._scaleRangeActive!==b;(this._scaleRangeActive=b)&&!this.handles.has("terrain-events")&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",d=>this.scaleUpdateHandler(d)),"terrain-events"),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),"terrain-events")):!b&&this.handles.has("terrain-events")&&this.handles.remove("terrain-events");return a};c.runTask=function(){const a=this.layerView.view.basemapTerrain;
this.extent&&a&&a.ready&&this._scaleRangeActive&&this.layerScaleEnabled?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,a.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,b=>this.finishUpdate(b))):this.finishUpdate(!0)};c.finishUpdate=function(a){this.layerScaleRangeVisibilityQuery=!1;this._set("suspended",!a);this._set("updating",!1)};c.visibleAtLayerScale=function(a){return!this.layerScaleEnabled||r.scaleBoundsPredicate(a,this.layer.minScale||
0,this.layer.maxScale||0)};c.visibleAtLabelScale=function(a,b){return r.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||0)};c.graphicScale=function(a){let b;l.isSome(a.centroid)?b=a.centroid:l.isSome(a.graphic.geometry)&&"point"===a.graphic.geometry.type&&(b=a.graphic.geometry);return b?this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(b):1:null};c.graphicVisible=function(a){if(!this.layerScaleEnabled)return!0;a=this.graphicScale(a);return this.visibleAtLayerScale(a)};
c.updateVisibility=function(a){if(this._scaleRangeActive){const b=this.graphicVisible(a);return a.setVisibilityFlag(1,b,0)}return!1};c.updateGraphicLabelScaleVisibility=function(a){if(!this._scaleRangeActive||!a.labelGraphics||0===a.labelGraphics.length)return!1;const b=this.graphicScale(a);if(a=this.updateLabelScaleVisibility(a,b))this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty();return a};c.updateLabelScaleVisibility=function(a,b){if(!a.labelGraphics||0===a.labelGraphics.length)return!1;
const d=a.labelGraphics[0]._labelClass;return d&&null!=d.minScale&&null!=d.maxScale&&(b=this.visibleAtLabelScale(b,d),a.setVisibilityFlag(1,b,1))?!0:!1};c.scaleUpdateHandler=function(a){this._setDirty();if(!this.layerView.suspended){var b=a.extent,d=a.scale,p=this.visibleAtLayerScale(d),g=!1;this.queryGraphicUIDsInExtent(b,a.spatialReference,f=>{f=this.graphicsCore.getGraphics3DGraphicById(f);if(!l.isNone(f)){var h=f.centroid;l.isSome(h)&&(b[0]>h.x||b[1]>h.y||b[2]<h.x||b[3]<h.y)||(f.setVisibilityFlag(1,
p,0)&&(g=!0),this.updateLabelScaleVisibility(f,d)&&(g=!0))}});g&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())}};c.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(a=>a.clearVisibilityFlag(1)):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility();this._setDirty()};q._createClass(m,[{key:"running",get:function(){return!(!this.layerView.view.basemapTerrain||
!this.updating)}}]);return m}(e);k.__decorate([n.property({constructOnly:!0})],e.prototype,"layerScaleEnabled",void 0);k.__decorate([n.property({readOnly:!0})],e.prototype,"suspended",void 0);k.__decorate([n.property({readOnly:!0})],e.prototype,"updating",void 0);return e=k.__decorate([v.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],e)});