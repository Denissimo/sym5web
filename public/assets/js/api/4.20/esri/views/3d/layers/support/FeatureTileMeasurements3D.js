// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/screenUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/plane ../../../../geometry/support/triangle ./FeatureTileVisibility3D ../../webgl-engine/lib/Camera".split(" "),function(t,k,x,l,d,y,z,D,E){let C=function(){function A(a){this.camera=new E;this.focusOnMap=[0,0];this.screenRect=d.create();this.tileSize=a.tileSize;this.renderCoordsHelper=a.renderCoordsHelper;this.tilingScheme=a.tilingScheme;
this.visibility=new D.FeatureTileVisibility3D(a.renderCoordsHelper)}var e=A.prototype;e.begin=function(a,c,b){this.camera.copyFrom(a);this.surfaceElevation=b;this.focusOnMap[0]=c.x;this.focusOnMap[1]=c.y;d.fromValues(0,0,a.fullWidth,a.fullHeight,this.screenRect);this.visibility.begin(this.camera,b)};e.end=function(){this.visibility.end()};e.updateTile=function(a){a.measures.visibility=this.visibility.calculate(a);a.measures.distance=d.distance(a.extent,this.focusOnMap);0!==a.measures.visibility&&
this.updateScreenMeasure(a)};e.updateScreenMeasure=function(a){const c=a.measures.screenRect;d.empty(c);let b=0;const f=a.lij[0]+2,m=a.lij[1]<<2,F=a.lij[2]<<2;var u=this.tileSizeWithBias(a);u*=u;for(let v=0;4>v;v++)for(let w=0;4>w;w++)if(b+=this.computeScreenArea(a,f,m+v,F+w,c),b>u){a.measures.shouldSplit=!0;return}a.measures.shouldSplit=!1};e.tileSizeWithBias=function(a){return 1===a.measures.visibility?5*this.tileSize:this.tileSize};e.computeScreenArea=function(a,c,b,f,m){this.projectToScreen(c,
b,f,1===a.measures.visibility,g);d.empty(r);for(a=0;4>a;a++)d.expandPointInPlace(r,g[a]);d.expand(m,r);d.intersection(r,this.screenRect,G);return z.areaPoints2d(g[0],g[1],g[2])+z.areaPoints2d(g[0],g[2],g[3])};e.projectToScreen=function(a,c,b,f,m){this.tilingScheme.ensureMaxLod(a);this.tilingScheme.getExtent(a,c,b,n);this.toRenderCoords(n,0,3,h[0]);this.toRenderCoords(n,2,3,h[1]);this.toRenderCoords(n,2,1,h[2]);this.toRenderCoords(n,0,1,h[3]);f&&(this.projectToPlane(h,this.camera.frustum[4]),this.projectToPlane(h,
this.camera.frustum[3]),this.projectToPlane(h,this.camera.frustum[2]));for(a=0;4>a;a++)this.camera.projectToRenderScreen(h[a],B),this.camera.renderToScreen(B,m[a])};e.projectToPlane=function(a,c){for(var b=0;4>b;b++)p[b]=y.signedDistance(c,a[b]);b=Math.max(p[0],p[1],p[2],p[3]);if(0<b)for(c=x.scale(q,y.normal(c),-b),b=0;4>b;b++)x.add(a[b],a[b],c)};e.toRenderCoords=function(a,c,b,f){q[0]=a[c];q[1]=a[b];q[2]=this.surfaceElevation;this.renderCoordsHelper.toRenderCoords(q,this.tilingScheme.spatialReference,
f);return f};return A}();const r=d.create(),G=d.create(),g=[k.createScreenPointArray(),k.createScreenPointArray(),k.createScreenPointArray(),k.createScreenPointArray()],n=d.create(),q=l.create(),h=[l.create(),l.create(),l.create(),l.create()],p=[0,0,0,0],B=k.createRenderScreenPointArray3();t.FeatureTileMeasurements3D=C;t.default=C;Object.defineProperty(t,"__esModule",{value:!0})});