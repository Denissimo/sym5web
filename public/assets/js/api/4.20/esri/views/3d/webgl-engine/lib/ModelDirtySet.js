// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/MapUtils ../../../../core/maybe ../../../../core/uid ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/Logger ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ./GeometryRecord ./Util".split(" "),function(v,t,n,w,x,B,y,E,F,G,H,C,z,u){n=function(A){function r(a){a=
A.call(this,a)||this;a._residentGeomRecords=new Map;a._dirtyGeomRecords=new Map;a.dirty=!1;return a}v._inheritsLoose(r,A);var d=r.prototype;d.commit=function(a){this.dirty=!1;this._dirtyGeomRecords.forEach((b,c)=>this.commitLayer(c,a))};d.commitLayer=function(a,b){const c=this._dirtyGeomRecords.get(a);c&&(c.forEach((e,g)=>{const h=this._ensureGeomRecord(a,g);e.forEach((f,m)=>{var k=f[0],l=f[1],p=f[2];f=!1;if(l&2){var q=h.get(m);if(q){q=q[1];if(p&4){const D=this.model.getObject(g);this.model.updateRenderGeometryTransformation(D,
k,q)&&(f=!0)}f||b.updates.push({renderGeometry:q,updateType:p})}else u.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(l&4||f)(p=h.get(m))?(b.removes.push(p[1]),h.delete(m),p[0].disposed&&z.GeometryRecord.pool.release(p[0])):4===l&&u.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove");if(l&1||f)l=this.model.getObject(g),l=this.model.getRenderGeometry(l,k),k=[k,l],b.adds.push(l),h.set(m,k)});0===h.size&&this._residentGeomRecords.get(a).delete(g)}),
0===this._residentGeomRecords.get(a).size&&this._residentGeomRecords.delete(a),this._dirtyGeomRecords.delete(a))};d.getResidentRenderGeometries=function(a,b){(a=this._residentGeomRecords.get(a))&&a.forEach(c=>c.forEach(e=>b.push(e[1])))};d._objectStateChanged=function(a,b){for(const c of b.geometryRecords)this._updateOrCreateDirtyRecord(b,c,null,2,0,0,2,5,a)};d.visibilityChanged=function(a){this._objectStateChanged(1,a)};d.highlightChanged=function(a){this._objectStateChanged(8,a)};d.occlusionChanged=
function(a){this._objectStateChanged(16,a)};d.vertexAttrsUpdated=function(a){this._updateOrCreateDirtyRecord(a.object,a.record,null,2,0,0,2,5,2)};d.layerAdded=function(a){a.objects.forAll(b=>this._layerObjectAdded(a,b))};d.layerRemoved=function(a){a.objects.forAll(b=>this._layerObjectRemoved(a,b))};d.layerObjectAdded=function(a){this._layerObjectAdded(a.layer,a.object)};d._layerObjectAdded=function(a,b){a=a.id;const c=b.geometryRecords;for(let e=0;e<c.length;e++)this._objectGeometryAdded(b,c[e],a)};
d.layerObjectRemoved=function(a){this._layerObjectRemoved(a.layer,a.object)};d.layerObjectsAdded=function(a){for(const b of a.objects)this._layerObjectAdded(a.layer,b)};d.layerObjectsRemoved=function(a){for(const b of a.objects)this._layerObjectRemoved(a.layer,b)};d._layerObjectRemoved=function(a,b){a=a.id;const c=b.geometryRecords;for(let e=0;e<c.length;e++)this._objectGeometryRemoved(b,c[e],a)};d.shaderTransformationChanged=function(a){(a=this._residentGeomRecords.get(a.id))&&a.forEach((b,c)=>{(c=
this.model.getObject(c))&&c.hasVolativeTransformation()&&b.forEach(e=>{e[1].shaderTransformationChanged()})})};d.objectTransformation=function(a){const b=this._getParentLayerId(a);this._ensureGeomRecord(b,a.id).forEach(c=>{this._updateOrCreateDirtyRecord(a,c[0],b,2,0,0,2,5,4)})};d.objectGeometryAdded=function(a){this._objectGeometryAdded(a.object,a.record)};d._objectGeometryAdded=function(a,b,c=null){this._updateOrCreateDirtyRecord(a,b,c,1,4,0,0,0)};d.objectGeometryRemoved=function(a){this._objectGeometryRemoved(a.object,
a.record)};d._objectGeometryRemoved=function(a,b,c=null){this._updateOrCreateDirtyRecord(a,b,c,4,1,2,0,0)};d._updateOrCreateDirtyRecord=function(a,b,c,e,g,h,f,m,k){c=x.unwrapOr(c,this._getParentLayerId(a));const l=b.id;a=this._ensureDirtyRecord(c,a.id);(c=a.get(l))?(b=c[1],b&g?(a.delete(l),c[0].disposed&&z.GeometryRecord.pool.release(c[0])):b&h?(c[1]=e,c[2]=k):b&f?c[2]|=k:b&m||u.assert(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")):a.set(l,[b,e,k]);this.dirty=this._hasDirtyGeometryRecords};
d._ensureGeomRecord=function(a,b){let c=this._residentGeomRecords.get(a);c||(c=new Map,this._residentGeomRecords.set(a,c));a=c.get(b);a||(a=new Map,c.set(b,a));return a};d._ensureDirtyRecord=function(a,b){let c=this._dirtyGeomRecords.get(a);c||(c=new Map,this._dirtyGeomRecords.set(a,c));a=c.get(b);a||(a=new Map,c.set(b,a));return a};d._getParentLayerId=function(a){return x.isSome(a.parentLayer)?a.parentLayer.id:B.NullUID};d.formatDebugInfo=function(){const a=["ADD","UPD",void 0,"REM"];let b="";this._dirtyGeomRecords.forEach((c,
e)=>{c.forEach((g,h)=>{0<b.length&&(b+="\n");b+=e+"."+h;const f=[];g.forEach(m=>{const k=m[1];f[k]||(f[k]=[]);f[k].push(m[0].geometry.id)});for(g=0;g<f.length;g++)if(f[g])for(b+=" "+a[g-1]+": ",h=0;h<f[g].length;h++)b+=f[g][h]+", "})});return b};v._createClass(r,[{key:"_hasDirtyGeometryRecords",get:function(){return w.someMap(this._dirtyGeomRecords,a=>w.someMap(a,b=>b&&0<b.size))}},{key:"test",get:function(){const a=this;return{get residentLayerCount(){return a._residentGeomRecords.size},get residentObjectCount(){return Array.from(a._residentGeomRecords.values()).reduce((b,
c)=>b+c.size,0)}}}}]);return r}(n);t.__decorate([y.property({constructOnly:!0})],n.prototype,"model",void 0);t.__decorate([y.property()],n.prototype,"dirty",void 0);return n=t.__decorate([C.subclass("esri.views.3d.webgl-engine.lib.ModelDirtySet")],n)});