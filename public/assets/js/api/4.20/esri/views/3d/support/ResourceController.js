// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/maybe ../../../core/scheduling ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ./index ./MemoryController ./StreamDataLoader ../../support/Scheduler".split(" "),function(e,n,d,v,w,k,x,y,
f,D,E,F,G,t,u,z,A,p){e.ResourceControllerMain=function(h){function b(){var l=h.apply(this,arguments)||this;l.updating=!1;return l}n._inheritsLoose(b,h);return b}(v);d.__decorate([f.property({readOnly:!0})],e.ResourceControllerMain.prototype,"updating",void 0);e.ResourceControllerMain=d.__decorate([t.subclass("esri.views.3d.support.ResourceController")],e.ResourceControllerMain);var q;(function(h){let b=function(l){function m(){var a=l.apply(this,arguments)||this;a._scheduler=null;a._memoryController=
null;a._streamDataLoader=null;a._cameraChangeTime=0;a._handles=new w;a._frameTask=null;a._scheduleTask=p.ImmediateTask;return a}n._inheritsLoose(m,l);var g=m.prototype;g.initialize=function(){this._cameraChangeTime=this.now();this._scheduler=p.newScheduler(this.now);this._memoryController=z.newMemoryController(this.view);this._streamDataLoader=new A["default"];this._streamDataLoader.setup(u.maxDownloadSlots,u.downloadSlotsPerClient,this._scheduler);this._handles.add([this.view.watch("state.camera",
(a,c)=>this._cameraChangedHandler(a,c),!0),this.view.watch("stationary",()=>this._stationaryChangedHandler()),this._memoryController.events.on("updating-changed",()=>this.notifyChange("updating"))]);this._frameTask=x.addFrameTask({update:a=>this.frame(a)});this._scheduleTask=this._scheduler.registerTask(p.TaskPriority.RESOURCE_CONTROLLER)};g.destroy=function(){this._handles=k.destroyMaybe(this._handles);this._scheduleTask.remove();this._frameTask=k.removeMaybe(this._frameTask);this._streamDataLoader=
k.destroyMaybe(this._streamDataLoader);this._memoryController=k.destroyMaybe(this._memoryController);this._scheduler=k.destroyMaybe(this._scheduler)};g.schedule=function(a,c,r){return this._scheduleTask.schedule(a,c,r)};g.createStreamDataRequester=function(a){const c=this._streamDataLoader;return{request(r,B,C){return c.request(r,B,a,C)},get busy(){return!c.hasDownloadSlots(a)}}};g.frame=function(a){if(!this.view.suspended){if(this.view.stateManager&&(this.view.stateManager.step(y.SecondsFromMilliseconds(a.deltaTime)),
!this._scheduler))return;this._scheduler.state=this.state;this._scheduler.updateBudget(a)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update()}};g._cameraChangedHandler=function(a,c){a&&c&&a.almostEquals(c)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)};g._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()};n._createClass(m,[{key:"updating",get:function(){var a,c;return!!(null!=
(a=this._memoryController)&&a.updating||null!=(c=this._streamDataLoader)&&c.updating)}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"state",get:function(){const a=this.view;return a.animation?0:a.interacting||300>=this._scheduler.now-this._cameraChangeTime?1:2}},{key:"test",get:function(){return{getQueueStats:a=>this._streamDataLoader.test.loadQueue.getStatsForType(a),state:this.state}}}]);return m}(e.ResourceControllerMain);
d.__decorate([f.property({constructOnly:!0})],b.prototype,"view",void 0);d.__decorate([f.property({constructOnly:!0})],b.prototype,"now",void 0);d.__decorate([f.property()],b.prototype,"_scheduler",void 0);d.__decorate([f.property()],b.prototype,"_memoryController",void 0);d.__decorate([f.property()],b.prototype,"_streamDataLoader",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"updating",null);b=d.__decorate([t.subclass("esri.views.3d.support.ResourceController")],b);h.ResourceController=
b})(q||(q={}));e.newResourceController=function(h,b=()=>performance.now()){return new q.ResourceController({view:h,now:b})};Object.defineProperty(e,"__esModule",{value:!0})});