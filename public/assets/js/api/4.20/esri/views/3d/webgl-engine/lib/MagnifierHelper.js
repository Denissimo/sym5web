// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/Logger ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../support/requestImageUtils ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Program ../../../webgl/ProgramCache ../../../webgl/Renderbuffer ../../../webgl/RenderingContext ../../../webgl/ShaderCompiler ../../../webgl/Texture ../../../webgl/VertexArrayObject ./DefaultVertexBufferLayouts ./glUtil3D ./Program ./WebGLDriverTest ../shaders/Magnifier.glsl ../../../magnifier/resources ../../../webgl/renderState".split(" "),
function(n,u,r,D,E,F,A,c,G,v,H,w,P,Q,R,S,I,B,T,U,V,W,X,Y,Z,x,aa,J,K,L,M,N,O,y){n.MagnifierHelper=function(C){function t(){var a=C.apply(this,arguments)||this;a._handles=new F;a._magnifier=null;a._imageSources=null;a._imageLoadTask=null;a._resources=null;a.events=new E;a.attributeLocations=new Map([["position",0]]);a.tmpScreenPoint=v.createScreenPointArray();a.tmpRenderPoint=v.createRenderScreenPointArray();return a}u._inheritsLoose(t,C);var l=t.prototype;l.dispose=function(){this._magnifier=null;
this._handles.destroy();c.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null);this.disposeResources()};l.render=function(a,b){const d=this._validMagnifier;if(!c.isNone(d)){var f=b.camera.pixelRatio,m=Math.ceil(f*d.size);this.updateResources(a,m);if(!c.isNone(this._resources)){var e=this._resources.program;a.useProgram(e);var h=this._resources.textures,g=Math.ceil(1/this.factor*m);h.input.resize(g,g);var k=b.camera.fullWidth,z=b.camera.fullHeight;v.screenPointObjectToArray(d.position,
this.tmpScreenPoint);b=b.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint);var p=.5*g,q=.5*g;b[0]=A.clamp(b[0],p,k-p-1);b[1]=A.clamp(b[1],q,z-q-1);p=Math.floor(b[0]-p);q=Math.floor(b[1]-q);e.bindTexture(h.input,"textureInput");a.gl.copyTexImage2D(h.input.descriptor.target,0,h.input.descriptor.pixelFormat,p,q,g,g,0);g=-1+(b[0]+d.offset.x*f)/k*2;f=-1+(b[1]-d.offset.y*f)/z*2;k=m/k*2;m=m/z*2;a.bindVAO(this._resources.vao);e.bindTexture(h.overlay,"textureOverlay");e.bindTexture(h.mask,"textureMask");
e.setUniform4f("drawPosition",g,f,k,m);e.setUniform1i("maskEnabled",d.maskEnabled?1:0);e.setUniform1i("overlayEnabled",d.overlayEnabled?1:0);a.setPipelineState(this._resources.pipelineState);a.drawArrays(5,0,4)}}};l.updateResourceLoading=function(){var a=this;const b=this._validMagnifier;if(!c.isNone(b)){var d=b.maskUrl,f=b.overlayUrl;!c.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===d&&this._imageLoadTask.overlayUrl===f||(this._imageLoadTask.task.abort(),this._imageSources=this._imageLoadTask=
null);c.isSome(this._imageSources)||c.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:d,overlayUrl:f,task:G.createTask(function(){var m=u._asyncToGenerator(function*(e){const h=c.isNone(d)||c.isNone(f)?O.loadMagnifierResources(e):null,g=c.isSome(d)?B.requestImage(d,{signal:e}):h.then(k=>k.mask);e=c.isSome(f)?B.requestImage(f,{signal:e}):h.then(k=>k.overlay);a._imageSources={mask:yield g,overlay:yield e};a.disposeResources();a.events.emit("request-render")});return function(e){return m.apply(this,
arguments)}}())},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}};l.updateResources=function(a,b){this.enabled?c.isSome(this._resources)?this._resources.textures.size!==b&&(a=this.createTextureResources(a,b),c.isNone(a)?this.disposeResources():(this.disposeTextureResources(this._resources.textures),this._resources.textures=a)):(b=this.createTextureResources(a,b),c.isNone(b)||(this._resources={textures:b,program:this.createProgram(a),vao:K.createQuadVAO(a,
J.Pos2,this.attributeLocations,0,1),pipelineState:y.makePipelineState({blending:y.simpleBlendingParams(1,771),depthTest:null,depthWrite:null,colorWrite:y.defaultColorWriteParams})})):this.disposeResources()};l.disposeResources=function(){c.isNone(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)};l.disposeTextureResources=function(a){a.mask.dispose();a.overlay.dispose();a.input.dispose()};
l.createTextureResources=function(a,b){if(c.isNone(this._imageSources))return null;this._imageSources.overlay.width=b;this._imageSources.overlay.height=b;this._imageSources.mask.width=b;this._imageSources.mask.height=b;const d=new x(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:H.isSVG(this._imageSources.overlay.src)&&M.testWebGLDriver(a).svgAlwaysPremultipliesAlpha?!1:!0},this._imageSources.overlay),f=new x(a,{target:3553,
pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new x(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:f,overlay:d,size:b}};l.createProgram=function(a){const b=N.build();return new L.Program(a,b,this.attributeLocations)};u._createClass(t,[{key:"updating",get:function(){return c.isNone(this._imageSources)&&c.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},
{key:"magnifier",get:function(){return this._magnifier},set:function(a){a!==this._magnifier&&(this._handles.removeAll(),this._magnifier=a,a=()=>{this.updateResourceLoading();this.events.emit("request-render")},c.isSome(this._magnifier)&&this._handles.add(this._magnifier.watch("version",a)),a())}},{key:"enabled",get:function(){return c.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return c.isSome(this._magnifier)&&this._magnifier.visible&&c.isSome(this._magnifier.position)&&
0<this._magnifier.size?this._magnifier:null}},{key:"factor",get:function(){return c.isSome(this._magnifier)?this._magnifier.factor||1:1}}]);return t}(D);r.__decorate([w.property()],n.MagnifierHelper.prototype,"_imageSources",void 0);r.__decorate([w.property()],n.MagnifierHelper.prototype,"_imageLoadTask",void 0);r.__decorate([w.property({readOnly:!0})],n.MagnifierHelper.prototype,"updating",null);n.MagnifierHelper=r.__decorate([I.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],n.MagnifierHelper);
Object.defineProperty(n,"__esModule",{value:!0})});