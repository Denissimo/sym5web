// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/PooledArray ../../../../chunks/mat4 ../../../../chunks/mat4f32 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f32 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/plane ../../../../geometry/support/ray ./PointHighlights ../../support/orientedBoundingBox ../../webgl-engine/core/shaderLibrary/Slice.glsl ../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/intersectorUtils ../../webgl-engine/shaders/PointRendererTechnique ../../../webgl/BufferObject ../../../webgl/VertexArrayObject".split(" "),
function(L,Z,y,aa,Q,ba,ca,p,da,I,ea,q,fa,ha,ia,M,ja,ka,la,ma,V,W,na){function J(k,g,a,c,b){if(a.drawScreenSpace)return a.fixedSize*g*c;b=(b?256:64)*g*c;return a.drawFixedSize?Math.min(a.fixedSize/2,b):0<a.screenMinSize?Math.min(Math.max(a.screenMinSize*g*c,k/2),b):Math.min(k/2,b)}function X(k){return y.isSome(k.component)?k.component:-1}function oa(k,g){if(y.isNone(k))return k;k=k.filter(a=>a.id!==g);return 0===k.length?null:k}const pa={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,
normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};L.PointRenderer=function(){function k(a){this._params=a;this.type="Point";this.isGround=!1;this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null};this._highlights=new ia.PointHighlights({forEachNode:c=>this.forEachNode(c),addHighlight:(c,b,d)=>this.addHighlight(c,b,d),removeHighlight:(c,b)=>this.removeHighlight(c,b)});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=
1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=q.create(q.POSITIVE_INFINITY);this._techniqueConfig=new V.PointRendererTechniqueConfiguration;this.tempMatrix4=ba.create();this.tempVec3=da.create();this.nodes=new aa}var g=k.prototype;g.initializeRenderContext=function(a){this._context=a;this._techniqueRep=this._context.shaderTechniqueRep;a.requestRender()};g.uninitializeRenderContext=function(){};g.intersect=function(a,c,b,d){const n=
I.create(),f=I.create(),u=I.create(),B=I.create(),v=fa.create(),C=a.camera.perScreenPixelRatio/2,l=a.camera.near,h=this._getSizeParams();p.subtract(f,d,b);const N=1/p.length(f);p.scale(f,f,N);p.negate(u,f);ea.set(v,f[0],f[1],f[2],-p.dot(f,b));let R=function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""};const z=new R,A=new R,Y=[],O=q.create(),P=q.create(this._clipBox);q.offset(P,-b[0],-b[1],-b[2],P);this.nodes.forAll(e=>{const m=e.splatSize*this._scaleFactor;var t=
M.minimumDistancePlane(e.obb,v),r=M.maximumDistancePlane(e.obb,v);t-=h.drawScreenSpace?0:J(m,t+l,h,C,e.isLeaf);r-=h.drawScreenSpace?0:J(m,r+l,h,C,e.isLeaf);t=null!=z.dist&&null!=A.dist&&z.dist<t*N&&A.dist>r*N;if(!(0>r||t)&&(r=J(m,r+l,h,C,e.isLeaf),M.intersectLine(e.obb,b,f,r))){r*=r;M.toAaBoundingBox(e.obb,O);q.offset(O,-b[0],-b[1],-b[2],O);t=!q.contains(P,O);p.subtract(B,e.origin,b);var qa=e.coordinates.length/3;for(let D=0;D<qa;D++){n[0]=B[0]+e.coordinates[3*D];n[1]=B[1]+e.coordinates[3*D+1];n[2]=
B[2]+e.coordinates[3*D+2];if(t&&!q.containsPoint(P,n))continue;var w=p.dot(n,f),K=p.squaredLength(n)-w*w;if(K>r)continue;var F=w+l;const S=h.drawScreenSpace?0:J(m,F,h,C,e.isLeaf);if(0>w-S)continue;F-=S;F=J(m,F,h,C,e.isLeaf);if(K>F*F)continue;const G=(w-S)*N;w=E=>{var T=D,H=E.point;null==H&&(H=I.create());H[0]=e.origin[0]+e.coordinates[3*T];H[1]=e.origin[1]+e.coordinates[3*T+1];H[2]=e.origin[2]+e.coordinates[3*T+2];E.point=H;E.dist=G;E.normal=u;E.node=e;E.pointId=D;E.layerUid=this.layerUid};(null==
z.dist||G<z.dist)&&(null==c||c(b,d,G))&&w(z);0!==a.options.store&&(null==A.dist||G>A.dist)&&(null==c||c(b,d,G))&&w(A);2!==a.options.store||null!=c&&!c(b,d,G)||(K=new R,w(K),Y.push(K))}}});const ra=e=>{const {layerUid:m,node:t,pointId:r}=e;return{type:"external",point:e.point,metadata:{layerUid:m,createGraphic:()=>this._params.createGraphic(t,r,e.point)}}},U=(e,m)=>{const t=ra(m);e.set(t,`${m.layerUid}/${m.node.id}/${m.pointId}`,m.dist,m.normal,ca.IDENTITY,void 0);e.intersector="PointRenderer"};if(null!=
z.dist){var x=a.results.min;(null==x.dist||z.dist<x.dist)&&U(x,z)}null!=A.dist&&0!==a.options.store&&(x=a.results.max,(null==x.dist||A.dist>x.dist)&&U(x,A));if(2===a.options.store){x=ha.fromPoints(b,d);for(const e of Y){const m=new ma.IntersectorResult(x);U(m,e);a.results.all.push(m)}}};g.render=function(a){if(0!==a.pass&&2!==a.pass&&5!==a.pass)return!1;const c=2===a.pass,b=a.rctx;this.nodes.forAll(l=>{null==l.vao&&this._initNode(a,l)});const d=this._getSizeParams(),n=this.selectTechnique(a,d),f=
n.program;if(null==f||0===this.nodes.length)return!0;const u=this._clipBox,B=!q.equals(u,q.POSITIVE_INFINITY,(l,h)=>l===h);B||(p.set(this.tempVec3,-Infinity,-Infinity,-Infinity),f.setUniform3fv("uClipMin",this.tempVec3),p.set(this.tempVec3,Infinity,Infinity,Infinity),f.setUniform3fv("uClipMax",this.tempVec3));b.useProgram(f);n.bindPipelineState(b);f.setUniformMatrix4fv("uProjectionMatrix",a.camera.projectionMatrix);c&&f.setUniform2f("nearFar",a.camera.near,a.camera.far);a.isHighlightPass&&(this._bindParameters.inverseViewport[0]=
1/a.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/a.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=a.highlightDepthTexture,ka.bindOutputHighlight(f,this._bindParameters));const v=a.camera.pixelRatio;d.drawFixedSize&&f.setUniform2f("uPointScale",d.fixedSize*v,a.camera.fullHeight);const C=this._slicePlaneEnabled?a.sliceHelper&&a.sliceHelper.plane:null;this.nodes.forAll(l=>{if(0!==l.coordinates.length&&(!a.isHighlightPass||l.highlights)){f.setUniform2f("uScreenMinMaxSize",
d.screenMinSize*v,(l.isLeaf?256:64)*v);d.drawFixedSize||f.setUniform2f("uPointScale",l.splatSize*this._scaleFactor*v,a.camera.fullHeight/v);var h=l.origin;B&&(p.set(this.tempVec3,u[0]-h[0],u[1]-h[1],u[2]-h[2]),f.setUniform3fv("uClipMin",this.tempVec3),p.set(this.tempVec3,u[3]-h[0],u[4]-h[1],u[5]-h[2]),f.setUniform3fv("uClipMax",this.tempVec3));Q.identity(this.tempMatrix4);Q.translate(this.tempMatrix4,this.tempMatrix4,h);Q.multiply(this.tempMatrix4,a.camera.viewMatrix,this.tempMatrix4);f.setUniformMatrix4fv("uModelViewMatrix",
this.tempMatrix4);ja.bindSliceUniforms(f,n.configuration,C,h);b.bindVAO(l.vao);a.isHighlightPass?this._renderHighlightFragments(b,l):b.drawArrays(0,0,l.coordinates.length/3)}});return!0};g._renderHighlightFragments=function(a,c){var b=c.highlights;if(!y.isNone(b)){c=y.unwrap(b[0].component);var d=c+1;for(let n=1;n<b.length;n++){const f=y.unwrap(b[n].component);f!==d&&(d-=c,0<d&&a.drawArrays(0,c,d),c=f);d=f+1}b=d-c;0<b&&a.drawArrays(0,c,b)}};g.addNode=function(a){this.nodes.push(a);this._highlights.nodeAdded(a);
this._requestRender()};g.removeNode=function(a){let c=null;this.nodes.filterInPlace(b=>b.id===a?(c=b,b.vao=y.disposeMaybe(b.vao),this._highlights.nodeRemoved(b),!1):!0);this._requestRender();return c};g.forEachNode=function(a){this.nodes.forAll(a)};g.removeAll=function(){this.nodes.forAll(a=>a.vao=y.disposeMaybe(a.vao));this._highlights.removeAll();this.nodes.clear();this._requestRender()};g.highlight=function(a){return this._highlights.add(a)};g.addHighlight=function(a,c,b){var d=a.highlights;y.isNone(d)&&
(d=[]);c={component:c,id:b};d.push(c);c=X(c);for(b=d.length-1;0<b&&c<X(d[b-1]);)[d[b-1],d[b]]=[d[b],d[b-1]],--b;a.highlights=d;this._requestRender()};g.removeHighlight=function(a,c){a.highlights=oa(a.highlights,c);this._requestRender()};g._initNode=function(a,c){a=a.rctx;c.vao=new na(a,la.Default3D,pa,{positions:W.createVertex(a,35044,c.coordinates),colors:W.createVertex(a,35044,c.rgb)})};g._requestRender=function(){this._context&&this._context.requestRender()};g._getSizeParams=function(){const a=
this._useFixedSizes,c=a&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:c,drawFixedSize:a,fixedSize:c?this._sizePx:this._size,screenMinSize:a?0:this._minSizePx}};g.selectTechnique=function(a,c){this._techniqueConfig.drawScreenSize=c.drawScreenSpace;this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled;this._techniqueConfig.sceneHasOcludees=a.hasOccludees;this._techniqueConfig.output=2===a.pass?1:5===a.pass?4:0;return this._techniqueRep.releaseAndAcquire(V.PointRendererTechnique,this._techniqueConfig,
this._technique)};Z._createClass(k,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())}},{key:"scaleFactor",get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(a){this._minSizePx!==
a&&(this._minSizePx=a,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())}},{key:"size",get:function(){return this._size},set:function(a){this._size!==a&&(this._size=a,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())}},{key:"clippingBox",
set:function(a){q.set(this._clipBox,a||q.POSITIVE_INFINITY)}},{key:"slicePlane",get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender())}},{key:"intersectionHandlerId",get:function(){return this.layerUid}}]);return k}();(function(k){k.isInstanceOfNode=function(g){return g.hasOwnProperty("splatSize")}})(L.PointRenderer||(L.PointRenderer={}));Object.defineProperty(L,"__esModule",{value:!0})});