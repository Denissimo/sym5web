// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../assets ../../../core/Accessor ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/mat4f64 ./StarsTechnique ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/DefaultVertexAttributeLocations ../../support/WatchUpdatingTracking ../../webgl/BufferObject ../../webgl/VertexArrayObject".split(" "),
function(h,v,m,C,D,y,E,g,z,p,S,T,U,F,q,w,G,H,I,J,K,L,M){const N=E.getLogger("esri.views.3d.environment.Stars");h.Stars=function(A){function r(a){a=A.call(this,a)||this;a.slot=14;a._loadDataTask=null;a._numPoints=0;a._modelMatrix=w.create();a._updatingTracking=new K.WatchUpdatingTracking;a._requestRender=()=>{};return a}v._inheritsLoose(r,A);var d=r.prototype;d.initialize=function(){this._loadDataTask=this._createLoadDataTask()};d.destroy=function(){this._loadDataTask=g.abortMaybe(this._loadDataTask);
this._updatingTracking.destroy();this._numPoints=0;this._technique=g.disposeMaybe(this._technique);this._vao=g.disposeMaybe(this._vao);this._requestRender=null};d.initializeRenderContext=function(a){this._requestRender=a.requestRender};d.uninitializeRenderContext=function(){this.destroy()};d.render=function(a){if(a.slot!==this.slot||0!==a.pass)return!1;this._ensureResources(a);if(g.isNone(this._technique)||g.isNone(this._vao))return!0;const c=a.rctx,b=this._technique.program;c.useProgram(b);this._technique.bindPass({camera:a.camera,
modelMatrix:this._modelMatrix});this._technique.bindPipelineState(c);c.bindVAO(this._vao);b.assertCompatibleVertexAttributeLocations(this._vao);c.drawArrays(0,0,this._numPoints);return!0};d._ensureResources=function(a){if(!g.isSome(this._technique)&&!g.isNone(l)){this._technique=new G.StarsTechnique({rctx:a.rctx,viewingMode:this.view.state.viewingMode},null);this._numPoints=l.byteLength/9;var c=new Float32Array(l,0,2*this._numPoints),b=new Uint8Array(l,8*this._numPoints,this._numPoints);this._vao=
this._createVertexArrayObject(a.rctx,c,b,this._numPoints);this._updatingTracking.add(this.view,"environment.lighting.date",f=>this._update(f),2)}};d._computeDayDuration=function(a){const c=new Date(a.getFullYear(),0,1,11,58,56),b=new Date(a.getFullYear()+1,0,1,11,58,55);return(+a-+c)/(+b-+c)};d._update=function(a){if(a){var c=a.getHours()/12,b=a.getMinutes()/60*(2/24),f=a.getSeconds()/60*(2/1440);c=(c+b+f-.9972222)%2;a=2*this._computeDayDuration(a);b=this._modelMatrix;q.copy(b,O);q.rotateZ(b,b,-a*
Math.PI);q.multiply(b,P,b);q.rotateZ(b,b,-c*Math.PI);this._requestRender()}};d._hexToRGB=function(a){return[parseInt(a.substring(0,2),16),parseInt(a.substring(2,4),16),parseInt(a.substring(4,6),16)]};d._unpackUint8Attributes=function(a){return 192<=a?[2.9,a-192]:160<=a?[2.5,a-160]:128<=a?[2,a-128]:96<=a?[1.5,a-96]:64<=a?[1,a-64]:32<=a?[.7,a-32]:[.4,a]};d._createVertexArrayObject=function(a,c,b,f){const t=B.createBuffer(f),x=t.position,u=t.color,Q=t.size;for(let e=0;e<f;e++){var n=c[2*e],k=c[2*e+1];
x.set(e,0,-Math.cos(n)*Math.sin(k));x.set(e,1,-Math.sin(n)*Math.sin(k));x.set(e,2,-Math.cos(k));n=this._unpackUint8Attributes(b[e]);k=this._hexToRGB(R[n[1]]);u.set(e,0,255*k[0]);u.set(e,1,255*k[1]);u.set(e,2,255*k[2]);u.set(e,3,255);Q.set(e,n[0])}return new M(a,J.Default3D,{geometry:H.glLayout(B)},{geometry:L.createVertex(a,35044,t.buffer)})};d._createLoadDataTask=function(){var a=this;if(g.isSome(l))return null;const c=z.createTask(function(){var b=v._asyncToGenerator(function*(f){({data:f}=yield C.fetchAsset("esri/views/3d/environment/resources/stars.wsv",
{responseType:"array-buffer",signal:f}));a._verifyStarData(f);l=f});return function(f){return b.apply(this,arguments)}}());c.promise.catch(b=>{z.isAbortError(b)||N.error(b)}).then(()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"))});return c};d._verifyStarData=function(a){if(!a)throw new y("stars:no-data-received","Failed to create stars because star catalogue is missing");a=a.byteLength/9;if(0!==a%1||5E4<a||5E3>a)throw new y("stars:invalid-data","Failed to create stars because star catalogue data is invalid");
};v._createClass(r,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return g.isSome(this._loadDataTask)&&!this._loadDataTask.finished}},{key:"canRender",get:function(){return!this.loading}}]);return r}(D);m.__decorate([p.property({constructOnly:!0})],h.Stars.prototype,"view",void 0);m.__decorate([p.property({readOnly:!0})],h.Stars.prototype,"updating",null);m.__decorate([p.property()],h.Stars.prototype,"_loadDataTask",void 0);m.__decorate([p.property()],
h.Stars.prototype,"_updatingTracking",void 0);h.Stars=m.__decorate([F.subclass("esri.views.3d.environment.Stars")],h.Stars);const R="9bb2ff;9eb5ff;aabfff;bbccff;ccd8ff ;dae2ff;e4e9ff;eeefff;f8f6ff;fff9fb;fff5ef;fff1e5;ffeddb;ffe9d2;ffe6ca;ffe3c3;ffe0bb;ffddb4;ffdaad;ffd6a5;ffd29c;ffcc8f;ffc178;ffa94b;ff7b00".split(";"),P=w.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),O=w.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,
0,.39778850739794974,.9174771405229186,0,0,0,0,1),B=I.newLayout().vec3f("position").vec4u8("color").f32("size");let l=null;Object.defineProperty(h,"__esModule",{value:!0})});