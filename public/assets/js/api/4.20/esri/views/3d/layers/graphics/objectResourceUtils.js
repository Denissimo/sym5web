// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/devEnvironmentUtils ../../../../core/maybe ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec32 ../../../../chunks/vec42 ../../../../geometry/support/buffer/utils ../../glTF/DefaultLoadingContext ../../glTF/loader ../../glTF/internal/indexUtils ./wosrLoader ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../../../chunks/vec22 ../../../../chunks/vec43 ../../../../chunks/vec33".split(" "),
function(G,S,T,f,O,U,V,W,w,J,K,p,H,L,B,X,Y,M,P,Z,D,aa,C,ba,Q,ca){function N(){N=S._asyncToGenerator(function*(c,d){var m=R(T.adjustStaticAGOUrl(c));if("wosr"===m.fileType)return c=yield d.cache?d.cache.loadWOSR(m.url,d):P.load(m.url,d),m=P.processLoadResult(c,d),{lods:[m],referenceBoundingBox:m.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:c.remove};c=yield d.cache?d.cache.loadGLTF(m.url,d,d.usePBR):Y.load(new X.DefaultLoadingContext(d.streamDataRequester),m.url,d,d.usePBR);var u=f.get(c.model.meta,
"ESRI_proxyEllipsoid");if(c.meta.isEsriSymbolResource&&f.isSome(u)&&-1!==c.meta.uri.indexOf("/RealisticTrees/"))a:for(var n=0;n<c.model.lods.length;++n){var x=c.model.lods[n];c.customMeta.esriTreeRendering=!0;for(var q of x.parts){x=q.attributes.normal;if(f.isNone(x))break a;const h=q.attributes.position,z=h.count,E=J.create(),l=J.create(),a=J.create(),r=B.createBuffer(p.BufferViewVec4u8,z),b=B.createBuffer(p.BufferViewVec3f,z),y=V.invert(W.create(),q.transform);for(let e=0;e<z;e++){h.getVec(e,l);
x.getVec(e,E);w.transformMat4(l,l,q.transform);w.subtract(a,l,u.center);w.divide(a,a,u.radius);const g=a[2];var v=w.length(a);v=Math.min(.45+.55*v*v,1);w.divide(a,a,u.radius);w.transformMat4(a,a,y);w.normalize(a,a);n+1!==c.model.lods.length&&1<c.model.lods.length&&(-1<g?w.lerp(a,a,E,.2):w.lerp(a,a,E,Math.min(-4*g-3.8,1)));b.setVec(e,a);r.set(e,0,255*v);r.set(e,1,255*v);r.set(e,2,255*v);r.set(e,3,255)}q.attributes.normal=b;q.attributes.color=r}}q=c.meta.isEsriSymbolResource?{usePBR:d.usePBR,isSchematic:!1,
treeRendering:c.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:d.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]};d={...d.materialParamsMixin,treeRendering:c.customMeta.esriTreeRendering};if(null!=m.specifiedLodIndex)return u=I(c,q,d,m.specifiedLodIndex),n=u[0].boundingBox,0!==m.specifiedLodIndex&&(n=I(c,q,d,0)[0].boundingBox),{lods:u,referenceBoundingBox:n,isEsriSymbolResource:c.meta.isEsriSymbolResource,isWosr:!1,remove:c.remove};m=I(c,q,d);return{lods:m,referenceBoundingBox:m[0].boundingBox,
isEsriSymbolResource:c.meta.isEsriSymbolResource,isWosr:!1,remove:c.remove}});return N.apply(this,arguments)}function R(c){const d=c.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return d?{fileType:"gltf",url:d[1],specifiedLodIndex:null!=d[4]?Number(d[4]):null}:c.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:c,specifiedLodIndex:null}:{fileType:"unknown",url:c,specifiedLodIndex:null}}function I(c,d,m,u){const n=c.model,x=U.create(),q=[],v=new Map,h=new Map;n.lods.forEach((z,E)=>{if(void 0===u||
E===u){var l={name:z.name,stageResources:{textures:[],materials:[],geometries:[]},lodThreshold:f.isSome(z.lodThreshold)?z.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:K.empty()};q.push(l);z.parts.forEach(a=>{var r=a.material+(a.attributes.normal?"_normal":"")+(a.attributes.color?"_color":"")+(a.attributes.texCoord0?"_texCoord0":"")+(a.attributes.tangent?"_tangent":"");const b=n.materials.get(a.material),y=f.isSome(a.attributes.texCoord0);var e=f.isSome(a.attributes.normal);
if(!v.has(r)){if(y){if(f.isSome(b.textureColor)&&!h.has(b.textureColor)){var g=n.textures.get(b.textureColor);h.set(b.textureColor,new D.Texture(g.data,{...g.parameters,preMultiplyAlpha:!0}))}f.isSome(b.textureNormal)&&!h.has(b.textureNormal)&&(g=n.textures.get(b.textureNormal),h.set(b.textureNormal,new D.Texture(g.data,{...g.parameters,preMultiplyAlpha:!0})));f.isSome(b.textureOcclusion)&&!h.has(b.textureOcclusion)&&(g=n.textures.get(b.textureOcclusion),h.set(b.textureOcclusion,new D.Texture(g.data,
{...g.parameters,preMultiplyAlpha:!0})));f.isSome(b.textureEmissive)&&!h.has(b.textureEmissive)&&(g=n.textures.get(b.textureEmissive),h.set(b.textureEmissive,new D.Texture(g.data,{...g.parameters,preMultiplyAlpha:!0})));f.isSome(b.textureMetallicRoughness)&&!h.has(b.textureMetallicRoughness)&&(g=n.textures.get(b.textureMetallicRoughness),h.set(b.textureMetallicRoughness,new D.Texture(g.data,{...g.parameters,preMultiplyAlpha:!0})))}g=b.color[0]**(1/C.COLOR_GAMMA);var t=b.color[1]**(1/C.COLOR_GAMMA),
A=b.color[2]**(1/C.COLOR_GAMMA),k=b.emissiveFactor[0]**(1/C.COLOR_GAMMA),F=b.emissiveFactor[1]**(1/C.COLOR_GAMMA);const da=b.emissiveFactor[2]**(1/C.COLOR_GAMMA);v.set(r,new aa.DefaultMaterial({...d,transparent:"BLEND"===b.alphaMode,textureAlphaMode:ea(b.alphaMode),textureAlphaCutoff:b.alphaCutoff,diffuse:[g,t,A],ambient:[g,t,A],opacity:b.opacity,doubleSided:b.doubleSided,doubleSidedType:"winding-order",cullFace:b.doubleSided?0:2,vertexColors:!!a.attributes.color,vertexTangents:!!a.attributes.tangent,
normals:e?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:f.isSome(b.textureColor)&&y?h.get(b.textureColor).id:void 0,colorMixMode:b.colorMixMode,normalTextureId:f.isSome(b.textureNormal)&&y?h.get(b.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:f.isSome(b.textureOcclusion)&&y?h.get(b.textureOcclusion).id:void 0,emissiveTextureId:f.isSome(b.textureEmissive)&&y?h.get(b.textureEmissive).id:void 0,metallicRoughnessTextureId:f.isSome(b.textureMetallicRoughness)&&
y?h.get(b.textureMetallicRoughness).id:void 0,emissiveFactor:[k,F,da],mrrFactors:[b.metallicFactor,b.roughnessFactor,d.mrrFactors[2]],isSchematic:!1,...m}))}a:{e=a.indices||a.attributes.position.count;switch(a.primitiveType){case 4:e=M.trianglesToTriangles(e);break a;case 5:e=M.triangleStripToTriangles(e);break a;case 6:e=M.triangleFanToTriangles(e);break a}e=void 0}g=e;e=a.attributes.position.count;t=B.createBuffer(p.BufferViewVec3f,e);H.transformMat4(t,a.attributes.position,a.transform);t=[["position",
{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]];A=[["position",g]];f.isSome(a.attributes.normal)&&(k=B.createBuffer(p.BufferViewVec3f,e),O.normalFromMat4(x,a.transform),H.transformMat3(k,a.attributes.normal,x),t.push(["normal",{data:k.typedBuffer,size:k.elementCount,exclusive:!0}]),A.push(["normal",g]));f.isSome(a.attributes.tangent)&&(k=B.createBuffer(p.BufferViewVec4f,e),O.normalFromMat4(x,a.transform),L.transformMat3(k,a.attributes.tangent,x),t.push(["tangent",{data:k.typedBuffer,size:k.elementCount,
exclusive:!0}]),A.push(["tangent",g]));f.isSome(a.attributes.texCoord0)&&(k=B.createBuffer(p.BufferViewVec2f,e),ba.normalizeIntegerBuffer(k,a.attributes.texCoord0),t.push(["uv0",{data:k.typedBuffer,size:k.elementCount,exclusive:!0}]),A.push(["uv0",g]));f.isSome(a.attributes.color)&&(k=B.createBuffer(p.BufferViewVec4u8,e),4===a.attributes.color.elementCount?a.attributes.color instanceof p.BufferViewVec4f?L.scale(k,a.attributes.color,255):a.attributes.color instanceof p.BufferViewVec4u8?Q.copy(k,a.attributes.color):
a.attributes.color instanceof p.BufferViewVec4u16&&L.scale(k,a.attributes.color,1/256):(Q.fill(k,255,255,255,255),F=new p.BufferViewVec3u8(k.buffer,0,4),a.attributes.color instanceof p.BufferViewVec3f?H.scale(F,a.attributes.color,255):a.attributes.color instanceof p.BufferViewVec3u8?ca.copy(F,a.attributes.color):a.attributes.color instanceof p.BufferViewVec3u16&&H.scale(F,a.attributes.color,1/256)),t.push(["color",{data:k.typedBuffer,size:k.elementCount,exclusive:!0}]),A.push(["color",g]));a=new Z.Geometry(t,
A);l.stageResources.geometries.push(a);l.stageResources.materials.push(v.get(r));y&&(f.isSome(b.textureColor)&&l.stageResources.textures.push(h.get(b.textureColor)),f.isSome(b.textureNormal)&&l.stageResources.textures.push(h.get(b.textureNormal)),f.isSome(b.textureOcclusion)&&l.stageResources.textures.push(h.get(b.textureOcclusion)),f.isSome(b.textureEmissive)&&l.stageResources.textures.push(h.get(b.textureEmissive)),f.isSome(b.textureMetallicRoughness)&&l.stageResources.textures.push(h.get(b.textureMetallicRoughness)));
l.numberOfVertices+=e;r=a.boundingInfo;f.isSome(r)&&(K.expandWithVec3(l.boundingBox,r.getBBMin()),K.expandWithVec3(l.boundingBox,r.getBBMax()))})}});return q}function ea(c){switch(c){case "BLEND":return 0;case "MASK":return 2;case "OPAQUE":return 1;default:return 0}}G.fetch=function(c,d){return N.apply(this,arguments)};G.gltfToEngineResources=I;G.parseUrl=R;Object.defineProperty(G,"__esModule",{value:!0})});