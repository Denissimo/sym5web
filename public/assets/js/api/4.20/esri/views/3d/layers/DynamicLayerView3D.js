// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/asyncUtils ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/aaBoundingRect ./LayerView3D ./support/overlayImageUtils ./support/projectExtentUtils ../support/debugFlags ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/materials/ImageMaterial ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),
function(m,r,C,n,v,p,E,t,R,S,T,F,D,l,G,w,H,I,J,K,L,M,N){const x=n.getLogger("esri.views.3d.layers.DynamicLayerView3D");n=function(y){function z(){var a=y.apply(this,arguments)||this;a.drapeSourceType=0;a.updatePolicy=1;a.fullExtentInLocalViewSpatialReference=null;a.maximumDataResolution=null;a._images=[];a._extents=[];a._overlayExtents=[];a.updateWhenStationary=!0;return a}m._inheritsLoose(z,y);var g=z.prototype;g.initialize=function(){this.addResolvingPromise(H.toViewIfLocal(this).then(a=>this._set("fullExtentInLocalViewSpatialReference",
a)));this.updatingHandles.add(this,"suspended",()=>this._suspendedChangeHandler());this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{}));this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,"scaleRangeId",()=>this.notifyChange("suspended"));"local"===this.view.viewingMode&&this.updatingHandles.add(this.view.basemapTerrain,"extent",()=>this._overlayExtents.forEach((a,b)=>this._updateImageExtent(b)))};
g.destroy=function(){this.clear()};g.setDrapingExtent=function(a,b){this._overlayExtents[a.index]={extent:l.create(a.extent),spatialReference:b,resolution:a.resolution,renderLocalOrigin:a.renderLocalOrigin,pixelRatio:a.pixelRatio};this._updateImageExtent(a.index)};g._updateImageExtent=function(a){const b=this._overlayExtents[a],c=this._clippedExtent(b.extent,O),d=w.computeImageExportSize(b.extent,c,b.resolution);let e=b.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in
this.layer){var h=this.layer.imageMaxWidth,f=this.layer.imageMaxHeight;if(d.width>h){const k=h/d.width;d.height=Math.floor(d.height*k);d.width=h;e*=k}d.height>f&&(h=f/d.height,d.width=Math.floor(d.width*h),d.height=f,e*=h)}f=this._extents[a];f&&l.equals(f.extent,c)&&!this._imageSizeDiffers(c,f.imageSize,d)||(this._extents[a]={extent:l.create(c),spatialReference:b.spatialReference,imageSize:d,pixelRatio:e},this.suspended||this._fetch(a).catch(k=>{p.isAbortError(k)||x.error(k)}))};g.clear=function(){for(let a=
0;a<this._images.length;a++)this._clearImage(a)};g.doRefresh=function(){var a=m._asyncToGenerator(function*(b){if(!this.suspended){var c=[];for(let d=0;d<this._extents.length;d++)this._extents[d]&&c.push(this._fetch(d,b));yield p.eachAlways(c)}});return function(b){return a.apply(this,arguments)}}();g.canResume=function(){if(!y.prototype.canResume.call(this))return!1;if(this._isScaleRangeLayer()){const {minScale:a,maxScale:b}=this.layer;if(0<a||0<b){const c=this.view.scale;if(c<b||0<a&&c>a)return!1}}return!0};
g.isUpdating=function(){return this._images.some(a=>!!a.loadingPromise)};g.processResult=function(){var a=m._asyncToGenerator(function*(b,c,d){if(c instanceof HTMLImageElement||c instanceof HTMLCanvasElement)b.image=c});return function(b,c,d){return a.apply(this,arguments)}}();g.findExtentInfoAt=function(a){for(const b of this._extents){const c=b.extent;if((new D(c[0],c[1],c[2],c[3],b.spatialReference)).contains(a))return b}return null};g.getFetchOptions=function(){};g.redraw=function(){var a=m._asyncToGenerator(function*(b,
c){var d=this;yield C.forEach(this._images,function(){var e=m._asyncToGenerator(function*(h,f){h&&(yield b(h,c),yield d._createStageObjects(f,h.image))});return function(h,f){return e.apply(this,arguments)}}())});return function(b,c){return a.apply(this,arguments)}}();g._imageSizeDiffers=function(a,b,c){if(!this.maximumDataResolution||I.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;const d=l.width(a)/this.maximumDataResolution.x;a=l.height(a)/this.maximumDataResolution.y;a=Math.abs(a/b.height-a/c.height);
return 1.5<Math.abs(d/b.width-d/c.width)||1.5<a};g._fetch=function(){var a=m._asyncToGenerator(function*(b,c){var d=this;if(!this.suspended){var e=this._extents[b],h=e.extent;this._images[b]||(this._images[b]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:l.create(h)});var f=this._images[b];f.loadingAbortController&&(f.loadingAbortController.abort(),f.loadingAbortController=null);var k=new D(h[0],h[1],h[2],h[3],
e.spatialReference);if(0===k.width||0===k.height)this._clearImage(b);else{var A=p.createAbortController();f.loadingAbortController=A;p.onAbort(c,()=>A.abort());var B=A.signal,u=this._waitFetchReady(B).then(()=>{const q={requestAsImageElement:!0,pixelRatio:this._overlayExtents[b].pixelRatio,...this.getFetchOptions(),signal:B},{height:P,width:Q}=e.imageSize;q.timestamp=this.refreshTimestamp;return this.layer.fetchImage(k,Q,P,q)}).then(q=>{if(p.isAborted(B))throw x.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),
p.createAbortError();return this.processResult(f,q)}).then(()=>l.set(f.renderExtent,h));f.loadingPromise=u;p.always(u,()=>{u===f.loadingPromise&&(f.loadingPromise=null,f.loadingAbortController=null)});c=u.then(m._asyncToGenerator(function*(){yield d._createStageObjects(b,f.image);d.notifyChange("updating")})).catch(q=>{q&&!p.isAbortError(q)&&x.error(q);this.notifyChange("updating");throw q;});this.notifyChange("updating");yield c}}});return function(b,c){return a.apply(this,arguments)}}();g._clearImage=
function(a){if(a=this._images[a]){v.isSome(a.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([a.renderGeometry],this,2),a.renderGeometry=null);const b=this.view._stage;b.remove(a.texture);a.texture=null;b.remove(a.material);a.material=null;a.loadingAbortController&&(a.loadingAbortController.abort(),a.loadingAbortController=null);a.loadingPromise=null;a.image=null;a.pixelData=null}};g._createStageObjects=function(){var a=m._asyncToGenerator(function*(b,c){const d=
this.view._stage,e=this._images[b],h=this.view.basemapTerrain.overlayManager.renderer,f=()=>{d.remove(e.texture);e.texture=null;v.isSome(e.renderGeometry)&&(h.removeGeometries([e.renderGeometry],this,2),e.renderGeometry=null)};if(c){c=new K.Texture(c,{width:c.width,height:c.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});yield C.result(this._images[0===b?1:0].loadingPromise);if(0===b)var k=w.createGeometryForExtent(e.renderExtent);else{k=this._images[0].renderExtent;if(!k){f();return}k=w.createOuterImageGeometry(k,
e.renderExtent)}f();d.add(c);e.texture=c;v.isNone(e.material)?(e.material=new L.ImageMaterial({transparent:!0,textureId:c.id}),d.add(e.material)):e.material.setParameterValues({textureId:c.id});e.renderGeometry=new J.RenderGeometry(k,e.material);e.renderGeometry.origin=this._overlayExtents[b].renderLocalOrigin;h.addGeometries([e.renderGeometry],this,2)}else f(),d.remove(e.material),e.material=null});return function(b,c){return a.apply(this,arguments)}}();g._isScaleRangeLayer=function(){return"minScale"in
this.layer&&"maxScale"in this.layer};g._isScaleRangeActive=function(){return this._isScaleRangeLayer()?0<this.layer.minScale||0<this.layer.maxScale:!1};g._clippedExtent=function(a,b){if("local"!==this.view.viewingMode)return l.set(b,a);const c=this.view.basemapTerrain,d=c.extent;return c.ready&&d?l.intersection(a,d,b):l.set(b,a)};g._suspendedChangeHandler=function(){this.suspended?this.clear():this.refresh()};g._waitFetchReady=function(){var a=m._asyncToGenerator(function*(b){yield E.whenOnce(this.view,
"stationary",b);p.throwIfAborted(b)});return function(b){return a.apply(this,arguments)}}();return z}(N.RefreshableLayerView(G.LayerView3D(M)));r.__decorate([t.property()],n.prototype,"layer",void 0);r.__decorate([t.property()],n.prototype,"suspended",void 0);r.__decorate([t.property({readOnly:!0})],n.prototype,"fullExtentInLocalViewSpatialReference",void 0);r.__decorate([t.property()],n.prototype,"updating",void 0);n=r.__decorate([F.subclass("esri.views.3d.layers.DynamicLayerView3D")],n);const O=
l.create();return n});