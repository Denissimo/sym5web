// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/typedArrayUtil ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../core/shaderLibrary/attributes/VertexPosition.glsl ../../core/util/TwoVectorPosition ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ./bufferLayouts ./edgeBufferWriters ./EdgeRenderer ./EdgeWorkerHandle ./strokes ./util ../TextureBackedBuffer/BufferManager ../../../../support/WatchUpdatingTracking ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject".split(" "),
function(w,v,z,Q,R,S,K,r,T,U,A,ma,na,oa,V,H,L,W,M,E,I,X,Y,Z,aa,ba,ca,da,ea,B,N,C,fa,ha,t,ia,ja,J,O){function ka(D){let y=null,n=null;for(let a=0;a<D.geometries.length;a++){var b;const c=D.geometryRecords[a];if(c.material.supportsEdges){if(!y)y=c.transformation;else if(!R.equals(y,c.transformation))return!1;if(!n&&r.isSome(c.origin))n=c;else if(r.isSome(null==(b=n)?void 0:b.origin)&&r.isSome(c.origin)&&n.origin.id!==c.origin.id)return!1}}return!0}const la=S.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");
w.EdgeView=function(D){function y(b){var a=D.call(this,b)||this;a.updatingHandles=new ja.WatchUpdatingTracking;a.perObjectData=new Map;a.renderers=new Map;a.numberOfRenderedEdges=0;a.gpuMemoryUsage=0;a.workerAbort=T.createAbortController();a.tmpModelPosition=I.create();a.tmpCameraPosition=I.create();a.localOrigins=new da.LocalOriginManager(new ba.GridLocalOriginFactory(b.renderSR));return a}v._inheritsLoose(y,D);var n=y.prototype;n.initialize=function(){this.worker=new fa(this.schedule);this.componentColorManager=
new ia.BufferManager(this.rctx,2);const b=B.VertexLayout.createBuffer(4);for(let a=0;4>a;a++)b.sideness.set(a,0,0===a||3===a?0:1),b.sideness.set(a,1,0===a||1===a?0:1);this.verticesBufferObject=J.createVertex(this.rctx,35044,b.buffer)};n.destroy=function(){this.destroyed||(this.perObjectData.forEach(b=>this._discardObjectEntry(b)),this.perObjectData.clear(),this.strokesTexture=r.disposeMaybe(this.strokesTexture),this.componentColorManager=r.destroyMaybe(this.componentColorManager),this.workerAbort.abort(),
this.worker.destroy(),this.verticesBufferObject=r.disposeMaybe(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())};n.shouldRender=function(){return 0<this.renderers.size};n.addComponentObject=function(){var b=v._asyncToGenerator(function*(a,c,d,e,m,g,f,l){if(!this.hasObject(a)){var k;d=new P(new Promise(h=>k=h),d);this.perObjectData.set(a,d);yield this.updatingHandles.addPromise(this.addComponentGeometry(c,d,e,m,g,f,l));this.setNeedsRender();k()}});return function(a,
c,d,e,m,g,f,l){return b.apply(this,arguments)}}();n.addOrUpdateObject3D=function(){var b=v._asyncToGenerator(function*(a,c,d,e){if(this.destroyed)la.warn("Attempt to add an object to a destroyed instance");else{var m=this.perObjectData.get(a),g,f=new P(new Promise(k=>g=k));this.perObjectData.set(a,f);var l=[];if(d.mergeGeometries&&1<a.geometries.length&&ka(a))l.push(this.addObjectMergedGeometries(a,f,c,d,e));else for(let k=0;k<a.geometries.length;k++){const h=a.geometryRecords[k];h.material.supportsEdges&&
l.push(this.addGeometry(a,f,a.geometries[k],h,c[0],d,e))}yield this.updatingHandles.addPromise(Promise.all(l));this._discardObjectEntry(m);this.setNeedsRender();g()}});return function(a,c,d,e){return b.apply(this,arguments)}}();n._discardObjectEntry=function(b){b&&(b.renderables.length&&(b.renderables.forEach(a=>this.removeRenderable(a)),this.setNeedsRender()),b.loaded=null)};n.hasObject=function(b){return this.perObjectData.has(b)};n.updateAllComponentOpacities=function(){var b=v._asyncToGenerator(function*(a,
c){const d=c instanceof Array?e=>c[e]:()=>c;(yield this.updatingHandles.addPromise(this.getObjectEntry(a))).renderables.forEach(e=>{const m=e.components.meta.length;for(let g=0;g<m;g++){const f=d(g),l=e.components.meta[g],k=l.index;l.material.opacity=f;e.components.buffer.textureBuffer.setDataElement(k,1,3,255*f)}this.updateTransparency(e)});this.setNeedsRender()});return function(a,c){return b.apply(this,arguments)}}();n.updateAllComponentMaterials=function(){var b=v._asyncToGenerator(function*(a,
c,d,e){const m=a instanceof ea.Object3D,g=!!d.slicePlaneEnabled,f=t.determineRendererType(c),l=C.EdgeRenderer.getKey(f,g,m);(yield this.updatingHandles.addPromise(this.getObjectEntry(a))).renderables.forEach(k=>{if(l!==k.rendererKey){var h=this.renderers.get(k.rendererKey);const p=this.acquireRenderer(f,g,m);h.removeRenderable(k);h.refCount.decrement();k.rendererKey=l;p.addRenderable(k)}for(h=0;h<c.length;h++)k.components.meta[h].material=c[h];e&&this.updateComponentBuffer(k.components);this.updateTransparency(k)});
this.setNeedsRender()});return function(a,c,d,e){return b.apply(this,arguments)}}();n.updateObjectVisibility=function(){var b=v._asyncToGenerator(function*(a,c){(yield this.updatingHandles.addPromise(this.getObjectEntry(a))).renderables.forEach(d=>d.visible=c);this.setNeedsRender()});return function(a,c){return b.apply(this,arguments)}}();n.removeObject=function(b){const a=this.perObjectData.get(b);a&&(this.perObjectData.delete(b),this._discardObjectEntry(a))};n.getObjectEntry=function(){var b=v._asyncToGenerator(function*(a){a=
this.perObjectData.get(a);if(!a)throw"no object";yield a.loaded;return a});return function(a){return b.apply(this,arguments)}}();n.removeAll=function(){this.perObjectData.forEach((b,a)=>this.removeObject(a))};n.render=function(b,a){if(!r.isNone(this.componentColorManager)){this.localOrigins.updateViewMatrices(b.camera.viewMatrix);var c=b.camera.viewInverseTransposeMatrix,d=I.create(),e=new aa.TwoVectorPosition,m=new Z.VertexPosition.ViewProjectionTransform,g=L.create();E.set(d,c[3],c[7],c[11]);e.set(d);
E.copy(m.worldFromView_TH,e.high);E.copy(m.worldFromView_TL,e.low);H.fromMat4(m.viewFromCameraRelative_RS,b.camera.viewMatrix);W.copy(m.projFromView,b.camera.projectionMatrix);c=L.create();H.transpose(c,m.viewFromCameraRelative_RS);H.invert(g,c);var f=0,l=0;this.renderers.forEach(h=>{0===h.refCount.value?(this.renderers.delete(h.key),h.dispose()):h.forEachRenderable(p=>{f+=p.statistics.averageEdgeLength;l++},a)});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();
if(0!==l){c=40*f/l;d=t.estimateLengthAtDistance(b.camera.fullViewport[3],b.camera.fovY,1,3.5*b.camera.pixelRatio);var k={distanceFalloffFactor:c,minimumEdgeLength:d,transparency:a,viewProjectionTransform:m,transformNormal_ViewFromGlobal:g};this.updateObjectCameraDistances(b);this.numberOfRenderedEdges=0;this.renderers.forEach(h=>{this.renderRegularEdges(h,b,k);this.renderSilhouetteEdges(h,b,k)})}}};n.updateTransparency=function(b){const a=t.determineEdgeTransparency(b.components.meta),c=t.determineObjectTransparency(b.components.meta);
if(a!==b.edgeTransparency||c!==b.objectTransparency)b.edgeTransparency=a,b.objectTransparency=c,this.renderers.get(b.rendererKey).setRenderablesDirty()};n.computeModelTransformWithLocalOrigin=function(b,a,c){b.getCombinedStaticTransformation(a,c);r.isSome(a.origin)?this.localOrigins.register(a.origin):(b=E.set(this.tmpModelPosition,c[12],c[13],c[14]),a.origin=this.localOrigins.acquire(b));ca.applyToModelMatrix(a.origin.vec3,c);return a.origin};n.updateComponentBuffer=function(b){const {meta:a,buffer:c}=
b;for(b=0;b<a.length;b++){var d=a[b].material;const e=a[b].index,m=K.clamp(Math.round(d.size*C.LINE_WIDTH_FRACTION_FACTOR),0,255),g=K.clamp(d.extensionLength,-C.EXTENSION_LENGTH_OFFSET,255-C.EXTENSION_LENGTH_OFFSET)+C.EXTENSION_LENGTH_OFFSET,f="solid"===d.type?0:1,l=255*d.opacity;d=d.color;c.textureBuffer.setData(e,0,255*d[0],255*d[1],255*d[2],255*d[3]);c.textureBuffer.setData(e,1,m,g,f,l)}};n.createComponentBuffers=function(b){if(r.isNone(this.componentColorManager))return null;const a=[],c=this.componentColorManager.getBuffer(b.length);
for(let d=0;d<b.length;d++){const e=b[d],m=c.acquireIndex();a.push({index:m,material:e})}b={meta:a,buffer:c};this.updateComponentBuffer(b);return b};n.extractEdges=function(b,a,c,d,e,m=e.length){return this.worker.process({data:a,indices:e,indicesLength:m,writerSettings:b,skipDeduplicate:c},this.workerAbort.signal,d)};n.createEdgeResources=function(b){const a={};if(r.isNone(this.verticesBufferObject))return a;if(0<b.regular.lodInfo.lengths.length){var c=new O(this.rctx,B.EdgeShaderAttributeLocations,
{vertices:B.glVertexLayout,instances:N.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:J.createVertex(this.rctx,35044,b.regular.instancesData.buffer)});a.regular={vao:c,lod:b.regular.lodInfo}}0<b.silhouette.lodInfo.lengths.length&&(c=new O(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:N.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:J.createVertex(this.rctx,35044,b.silhouette.instancesData.buffer)}),
a.silhouette={vao:c,lod:b.silhouette.lodInfo});return a};n.addGeometry=function(){var b=v._asyncToGenerator(function*(a,c,d,e,m,g,f){const l=d.vertexAttributes.get("position"),k=d.indices.get("position"),h=M.create();a=this.computeModelTransformWithLocalOrigin(a,e,h);return this.addPositionData(c,{position:l,indices:k,modelTransform:h,origin:a},d.edgeIndicesLength,m,g,f)});return function(a,c,d,e,m,g,f){return b.apply(this,arguments)}}();n.addPositionData=function(){var b=v._asyncToGenerator(function*(a,
c,d,e,m,g=!1){if(null!=a.loaded){var f=this.createComponentBuffers([e]);if(!(r.isNone(f)||0>=d)){e=this.acquireRenderer(e.type,!!m.slicePlaneEnabled);var {modelTransform:l,origin:k}=c;m=c.indices;c=c.position;var h=c.data.length/c.size,p=B.EdgeInputBufferLayout.createBuffer(h);for(let x=0;x<h;x++)p.position.set(x,0,c.data[x*c.size]),p.position.set(x,1,c.data[x*c.size+1]),p.position.set(x,2,c.data[x*c.size+2]);t.fillComponenBufferIndices(f.meta,[0,p.componentIndex.count],p.componentIndex);g=yield this.updatingHandles.addPromise(this.extractEdges(e.writerSettings,
p,!1,g,m,d));if(null!=a.loaded){var {regular:u,silhouette:q}=this.createEdgeResources(g);d=(u?u.vao.size:0)+(q?q.vao.size:0);f={regular:u,silhouette:q,transform:{modelMatrix:l,origin:k},statistics:{gpuMemoryUsage:d,averageEdgeLength:g.averageEdgeLength},components:f,visible:!0,edgeTransparency:t.determineEdgeTransparency(f.meta),objectTransparency:t.determineObjectTransparency(f.meta),distanceToCamera:0,rendererKey:e.key};a.renderables.push(f);e.addRenderable(f);this.gpuMemoryUsage+=d}}}});return function(a,
c,d,e,m){return b.apply(this,arguments)}}();n.addComponentGeometry=function(){var b=v._asyncToGenerator(function*(a,c,d,e,m,g,f){if(null!=c.loaded){var l=this.createComponentBuffers(g);if(!r.isNone(l)&&(g=t.determineRendererType(g),f=this.acquireRenderer(g,f.slicePlaneEnabled||!1,!1),g=B.EdgeInputBufferLayout.createBuffer(d.count),Y.copy(g.position,d),t.fillComponenBufferIndices(l.meta,m,g.componentIndex,e),e=yield this.updatingHandles.addPromise(this.extractEdges(f.writerSettings,g,!0,!1,e)),null!=
c.loaded)){var {regular:k,silhouette:h}=this.createEdgeResources(e);d=(k?k.vao.size:0)+(h?h.vao.size:0);a={regular:k,silhouette:h,transform:a,statistics:{gpuMemoryUsage:d,averageEdgeLength:e.averageEdgeLength},components:l,visible:!0,edgeTransparency:t.determineEdgeTransparency(l.meta),objectTransparency:t.determineObjectTransparency(l.meta),distanceToCamera:0,rendererKey:f.key};c.renderables.push(a);f.addRenderable(a);this.gpuMemoryUsage+=d}}});return function(a,c,d,e,m,g,f){return b.apply(this,
arguments)}}();n.addObjectMergedGeometries=function(){var b=v._asyncToGenerator(function*(a,c,d,e,m){var g=new Map,f=0,l=null,k=null;for(var h=0;h<a.geometries.length;h++){var p=a.geometries[h],u=a.geometryRecords[h];u.material.supportsEdges&&(!k&&u.origin&&(k=u),u=p.indices.get("position"),f+=p.edgeIndicesLength,null==l||l===Uint16Array)&&(l=U.isUint16Array(u)?Uint16Array:Uint32Array)}f=f?new l(f):null;l=[];h=0;for(p=0;p<a.geometries.length;p++){u=a.geometries[p];if(!a.geometryRecords[p].material.supportsEdges)continue;
var q=u.vertexAttributes.get("position");const x=u.indices.get("position");let G=g.get(q.data);if(null==G){G=l.length/3;for(let F=0;F<q.data.length;F+=q.size)l.push(q.data[F+0]),l.push(q.data[F+1]),l.push(q.data[F+2]);g.set(q.data,G)}if(x)for(q=0;q<u.edgeIndicesLength;q++)f[h++]=G+x[q]}k=k||a.geometryRecords[0];g=M.create();k=this.computeModelTransformWithLocalOrigin(a,k,g);for(h=0;h<a.geometryRecords.length;h++)a.geometryRecords[h].origin=k;yield this.updatingHandles.addPromise(this.addPositionData(c,
{position:{data:l,size:3},indices:f,modelTransform:g,origin:k},f.length,d[0],e,m))});return function(a,c,d,e,m){return b.apply(this,arguments)}}();n.acquireRenderer=function(b,a,c=!0){const d=C.EdgeRenderer.getKey(b,a,c);let e=this.renderers.get(d);r.isNone(this.strokesTexture)&&(this.strokesTexture=ha.generateStrokesTexture(this.rctx));e||(e=new C.EdgeRenderer(this.rctx,this.techniqueRepository,{type:b,slicePlaneEnabled:a,strokesTexture:this.strokesTexture,legacy:c}),this.renderers.set(d,e));e.refCount.increment();
return e};n.removeRenderable=function(b){b.regular&&(b.regular.vao.vertexBuffers.instances.dispose(),b.regular.vao.dispose(!1),b.regular.vao=null);b.silhouette&&(b.silhouette.vao.vertexBuffers.instances.dispose(),b.silhouette.vao.dispose(!1),b.silhouette.vao=null);const a=this.renderers.get(b.rendererKey);if(a){a.removeRenderable(b);a.refCount.decrement();"origin"in b.transform&&this.localOrigins.release(b.transform.origin);this.gpuMemoryUsage-=b.statistics.gpuMemoryUsage;for(const c of b.components.meta)b.components.buffer.releaseIndex(c.index)}};
n.updateObjectCameraDistances=function(b){b=b.camera.viewInverseTransposeMatrix;E.set(this.tmpCameraPosition,b[3],b[7],b[11]);this.perObjectData.forEach((a,c)=>{c=r.isSome(a.center)?a.center:X.getCenter(c.boundingVolumeWorldSpace.bounds);const d=E.distance(c,this.tmpCameraPosition);a.renderables.forEach(e=>e.distanceToCamera=d)})};n.renderRegularEdges=function(b,a,c){b.bindRegularEdges(a,c);b.forEachRenderable(d=>{if(d.visible&&d.regular){var e=t.computeEdgeCount(d.regular.lod.lengths,d.distanceToCamera,
c);"origin"in d.transform&&(a.localViewMatrixForEdges=this.localOrigins.getViewMatrix(d.transform.origin));b.renderRegularEdges(d,a,e);this.numberOfRenderedEdges+=e}},c.transparency)};n.renderSilhouetteEdges=function(b,a,c){b.bindSilhouetteEdges(a,c);b.forEachRenderable(d=>{if(d.visible&&d.silhouette){var e=t.computeEdgeCount(d.silhouette.lod.lengths,d.distanceToCamera,c);"origin"in d.transform&&(a.localViewMatrixForEdges=this.localOrigins.getViewMatrix(d.transform.origin));b.renderSilhouetteEdges(d,
a,e);this.numberOfRenderedEdges+=e}},c.transparency)};v._createClass(y,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"usedMemory",get:function(){return this.gpuMemoryUsage}},{key:"numberOfRenderedPrimitives",get:function(){return this.numberOfRenderedEdges}}]);return y}(Q);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,"rctx",void 0);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,"renderSR",void 0);z.__decorate([A.property({constructOnly:!0})],
w.EdgeView.prototype,"techniqueRepository",void 0);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,"setNeedsRender",void 0);z.__decorate([A.property({constructOnly:!0})],w.EdgeView.prototype,"schedule",void 0);z.__decorate([A.property({readOnly:!0})],w.EdgeView.prototype,"updatingHandles",void 0);z.__decorate([A.property({readOnly:!0})],w.EdgeView.prototype,"updating",null);w.EdgeView=z.__decorate([V.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],w.EdgeView);
let P=function(D,y=null){this.center=y;this.renderables=[];this.loaded=D;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0)})};Object.defineProperty(w,"__esModule",{value:!0})});