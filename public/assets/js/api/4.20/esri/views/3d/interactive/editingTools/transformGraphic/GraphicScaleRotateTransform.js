// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../core/watchUtils ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/support/plane ../../../../../geometry/support/ray ../../../../../geometry/support/vectorStacks ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../dragEventPipeline3D ../manipulations/config ../../../support/mathUtils ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/materials/ColorMaterial ../../../../interactive/dragEventPipeline".split(" "),
function(L,R,S,T,D,y,U,V,W,x,X,t,E,F,G,m,Y,Z,aa,ba,c,ca,I,da,ea){function fa(d,g){var a=t.subtract(m.sv3d.get(),g.renderStart,d.origin);d=t.subtract(m.sv3d.get(),g.renderEnd,d.origin);a=t.length(a);d=t.length(d);return 0===a?0:d/a}function ha(d,g,a,b){const {renderStart:h,renderEnd:n}=d;var u=H(h,b,m.sv3d.get());d=H(n,b,m.sv3d.get());if(t.squaredDistance(u,d)<c.DRAG_THRESHOLD_PX*c.DRAG_THRESHOLD_PX)return null;const k=t.subtract(m.sv3d.get(),h,a);g=t.cross(m.sv3d.get(),k,F.normal(g));g=t.add(m.sv3d.get(),
h,g);a=H(a,b,m.sv3d.get());b=H(g,b,m.sv3d.get());g=t.subtract(m.sv3d.get(),b,u);b=t.subtract(m.sv3d.get(),u,a);u=G.wrap(u,g);b=G.wrap(a,b);return G.distance2(u,d)<G.distance2(b,d)?"rotate":"scale"}function H(d,g,a){g.projectToScreen(d,J);return t.set(a,J[0],J[1],0)}function M(d,g){let a=null,b=1;const h=()=>b;return{start:()=>{b=d.getScale();a=d.getScale;d.getScale=h;g()},update:n=>{b+=((b+1)/2-b)*Math.min(n*c.RING_RESET_ANIMATION_SPEED_FACTOR,1);g();return.01>Math.abs(b-1)?1:0},destroy:()=>{d.getScale=
a;g()}}}function ia(d,g){let a=0,b=null;const h=()=>!1;return{start:()=>{b=d.getFocused;d.getFocused=h;a=0;g()},update:n=>{a+=n;return!b()||a>c.RING_INDICATOR_DELAY_MS?1:0},destroy:()=>{d.getFocused=b;g()}}}var e;(function(d){d.ScaleIn=32;d.ScaleOut=64;d.RotateLeft=128;d.RotateRight=256;d.Unlocked=1024;d.DelayedFocused=2048;d.TouchInput=32768})(e||(e={}));let ja=function(){function d(a){this.mode=null;this._handles=new T;this._activeAnimation=this._scaleRotateDragData=null;this.events=new S;this.getFocused=
()=>this.ringManipulator.focused;this.getScale=()=>y.isSome(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1;this.tool=a.tool;this.mode=a.mode;this.adapter=a.adapter;this.createManipulator();this.updateDragState();this.updateManipulatorTransform()}var g=d.prototype;g.destroy=function(){y.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null);this._handles.removeAll();this.tool.manipulators.remove(this.ringManipulator);
this.ringManipulator=null};g.startAnimation=function(a){this.cancelActiveAnimation();a.start();const b=U.addFrameTask({update:({deltaTime:h})=>{a.update(h)&&this.cancelActiveAnimation()}});this._activeAnimation={...a,frameTask:b}};g.cancelActiveAnimation=function(){y.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)};g.forEachManipulator=function(a){a(this.ringManipulator,4)};g.createManipulator=function(){this.ringManipulator=
this.createRingManipulator();this.tool.manipulators.add(this.ringManipulator);const a=this.tool.graphicState.graphic,b=ea.createManipulatorDragEventPipeline(this.ringManipulator,(h,n,u)=>{this._scaleRotateDragData=null;this.adapter.restart();const k={mode:"none",origin:E.clone(h.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=k;this.updateDragState();const A=m.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(h.renderLocation,A);
n.next(ba.screenToRenderPlane(this.tool.view,F.fromPositionAndNormal(h.renderLocation,A,F.create()))).next(p=>{var l=F.normal(p.plane);l=aa.calculateInputRotationTransform(p.renderStart,p.renderEnd,k.origin,l);var f=ca.cyclicalPI.shortestSignedDiff(k.angle,l);k.angleDir=D.clamp(k.angleDir+f,-c.ROTATE_INDICATOR_DIRECTION_BUFFER,c.ROTATE_INDICATOR_DIRECTION_BUFFER);k.angle=l;f=fa(k,p);k.scaleDir=D.clamp(k.scaleDir+(f-this.adapter.scale),-c.SCALE_INDICATOR_DIRECTION_BUFFER,c.SCALE_INDICATOR_DIRECTION_BUFFER);
this.onScaleChanged();if("none"===k.mode){const q=this.mode||ha(p,p.plane,k.origin,this.tool.view.state.camera);if(y.isSome(q)){switch(q){case "rotate":this.tool.emit("graphic-rotate-start",{graphic:a,angle:0});this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case "scale":this.tool.emit("graphic-scale-start",{graphic:a,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}k.mode=q}}switch(k.mode){case "rotate":this.adapter.angle=k.initialAngle+
l;break;case "scale":this.adapter.scale=f,this.onScaleChanged()}this.updateDragState();this.updateManipulatorTransform();switch(p.action){case "start":case "update":switch(k.mode){case "rotate":this.tool.emit("graphic-rotate",{graphic:a,angle:D.rad2deg(k.angle)});break;case "scale":this.tool.emit("graphic-scale",{graphic:a,xScale:f,yScale:f})}break;case "end":switch(k.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:D.rad2deg(k.angle)});break;case "scale":this.tool.emit("graphic-scale-stop",
{graphic:a,xScale:f,yScale:f})}}"end"===p.action&&(this.startAnimation(M(this,()=>this.onScaleChanged())),this._scaleRotateDragData=null,this.updateDragState())});u.next(()=>{this.adapter.cancel();if(y.isSome(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:0});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:1,yScale:1})}this.startAnimation(M(this,()=>this.onScaleChanged()));this._scaleRotateDragData=
null;this.updateDragState()}})});this._handles.add(b);this._handles.add([this.ringManipulator.events.on("focus-changed",h=>{"focus"===h.action?this.startAnimation(ia(this,()=>this.updateDelayedFocusedState())):this.updateDelayedFocusedState()}),this.ringManipulator.events.on("immediate-click",h=>{h.stopPropagation()}),W.init(this.tool.graphicState,"displaying",h=>this.ringManipulator.available=h)])};g.onScaleChanged=function(){this.events.emit("scale-changed");this.updateManipulatorTransform()};g.updateDelayedFocusedState=
function(){this.ringManipulator.updateStateEnabled(e.DelayedFocused,this.getFocused())};g.updateDragState=function(){this.ringManipulator.updateStateEnabled(e.Unlocked,!(y.isSome(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode));if(y.isSome(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case "rotate":this.ringManipulator.updateStateEnabled(e.ScaleIn|e.ScaleOut,!1);this.ringManipulator.updateStateEnabled(e.RotateLeft,0>this._scaleRotateDragData.angleDir);this.ringManipulator.updateStateEnabled(e.RotateRight,
0<=this._scaleRotateDragData.angleDir);break;case "scale":this.ringManipulator.updateStateEnabled(e.RotateLeft|e.RotateRight,!1),this.ringManipulator.updateStateEnabled(e.ScaleIn,0>this._scaleRotateDragData.scaleDir),this.ringManipulator.updateStateEnabled(e.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this.ringManipulator.updateStateEnabled(e.ScaleIn|e.ScaleOut|e.RotateLeft|e.RotateRight,!1)};g.updateManipulatorTransform=function(){const a=x.identity(m.sm4d.get());x.rotate(a,a,this.adapter.angle,
E.fromValues(0,0,1));var b=this.getScale();b=x.fromScaling(m.sm4d.get(),t.set(m.sv3d.get(),b,b,b));const h=x.identity(m.sm4d.get());x.multiply(h,b,a);this.ringManipulator.modelTransform=h};g.createRingManipulator=function(){var a=(B,z,N)=>{const O=[],P=Math.ceil(c.GEOMETRY_SEGMENTS*(z-B)/(2*Math.PI));for(let K=0;K<P+1;K++){const Q=B+K*(z-B)/P;O.push(E.fromValues(N*Math.cos(Q),N*Math.sin(Q),0))}return O},b=(B,z)=>I.createPathExtrusionGeometry([[-z/2,0],[z/2,0],[z/2,c.RING_HEIGHT/2],[-z/2,c.RING_HEIGHT/
2]],B,[],[],!1),h=a(0,2*Math.PI,c.RING_RADIUS),n=b(h,c.RING_THICKNESS),u=[],k=[];const A=[];for(var p=0;2>p;p++){var l=p*Math.PI-Math.PI/4,f=Math.PI/2-c.ROTATE_INDICATOR_ARC_LENGTH,q=l+f;l=l+Math.PI/2-f;f=a(q,l,c.INNER_INDICATOR_RADIUS);var v=b(f,c.INDICATOR_THICKNESS);A.push(f);A.push(a(q,l,c.OUTER_INDICATOR_RADIUS-c.RING_THICKNESS/2));u.push(v);k.push(v);for(v=0;2>v;v++){var C=0===v,r=X.create();if(C){x.scale(r,r,[1,-1,1]);x.rotate(r,r,-q,[0,0,1]);var w=Math.round(c.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*
(f.length-1));r[12]=f[w][0];r[13]=f[w][1];r[14]=f[w][2]}else x.rotate(r,r,l,[0,0,1]),w=Math.round((1-c.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(f.length-1)),r[12]=f[w][0],r[13]=f[w][1],r[14]=f[w][2];w=I.createExtrudedTriangle(c.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,c.ROTATE_INDICATOR_ARROW_TIP_RADIUS,c.RING_HEIGHT);I.transformInPlace(w,r);(C?u:k).push(w)}}p=[];for(q=0;2>q;q++)l=q*Math.PI-Math.PI/4,f=Math.PI/2-c.SCALE_INDICATOR_ARC_LENGTH,l=a(l+f,l+Math.PI/2-f,c.OUTER_INDICATOR_RADIUS),p.push(b(l,
c.INDICATOR_THICKNESS));q=a(0,2*Math.PI,c.RING_RADIUS+c.SCALE_INDICATOR_OFFSET1);l=a(0,2*Math.PI,c.RING_RADIUS+c.SCALE_INDICATOR_OFFSET2);q=b(q,c.INDICATOR_THICKNESS);l=b(l,c.INDICATOR_THICKNESS);f=a(0,2*Math.PI,c.RING_RADIUS-c.SCALE_INDICATOR_OFFSET1);v=a(0,2*Math.PI,c.RING_RADIUS-c.SCALE_INDICATOR_OFFSET2);a=b(f,c.INDICATOR_THICKNESS);b=b(v,c.INDICATOR_THICKNESS);f=this.createMaterial();v=this.createMaterial(.66);r=this.createMaterial(.5);C=this.createMaterial(.33);n=[{geometry:n,material:f,stateMask:e.DelayedFocused},
{geometry:n,material:r,stateMask:0}];this.mode&&"scale"!==this.mode||(n=n.concat([{geometry:p,material:f,stateMask:e.DelayedFocused|e.Unlocked},{geometry:q,material:v,stateMask:e.DelayedFocused|e.ScaleIn},{geometry:l,material:C,stateMask:e.DelayedFocused|e.ScaleIn},{geometry:a,material:v,stateMask:e.DelayedFocused|e.ScaleOut},{geometry:b,material:C,stateMask:e.DelayedFocused|e.ScaleOut}]));this.mode&&"rotate"!==this.mode||(n=n.concat([{geometry:k,material:f,stateMask:e.DelayedFocused|e.Unlocked},
{geometry:u,material:f,stateMask:e.DelayedFocused|e.RotateLeft},{geometry:k,material:f,stateMask:e.DelayedFocused|e.RotateRight}]));h=[h,...A];return new Z.Manipulator3D({view:this.tool.view,renderObjects:n,autoScaleRenderObjects:!1,worldOriented:!0,radius:c.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:Y.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:h,direction:E.fromValues(0,0,1)}})};g.createMaterial=function(a=1){const b=
[...c.HANDLE_COLOR,a];return new da.ColorMaterial({color:b,transparent:1!==a,cullFace:2,renderOccluded:2})};R._createClass(d,[{key:"angle",get:function(){return this.adapter.angle}},{key:"scale",get:function(){return this.adapter.scale}},{key:"location",set:function(a){this.ringManipulator.location=a}},{key:"elevationAlignedLocation",set:function(a){this.ringManipulator.elevationAlignedLocation=a}},{key:"grabbing",get:function(){return this.ringManipulator.grabbing}},{key:"interactive",set:function(a){this.ringManipulator.interactive=
a}},{key:"test",get:function(){return{ringManipulator:this.ringManipulator}}}]);return d}();const J=V.createScreenPointArray();L.GraphicScaleRotateTransform=ja;Object.defineProperty(L,"__esModule",{value:!0})});