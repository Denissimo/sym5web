// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../core/Evented ../../../core/Handles ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../geometry/projection ../../../geometry/support/spatialReferenceUtils ./EnvironmentRenderer ../support/earthUtils ../support/sunUtils ../webgl-engine/lighting/Lightsources ../../../webscene/background/ColorBackground".split(" "),
function(f,p,k,C,D,E,g,w,q,l,N,O,P,Q,F,h,m,x,r,G,H,y,t,u,I){const z=m.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258);f.SceneViewEnvironmentManager=function(A){function n(...a){a=A.call(this,...a)||this;a._referencePointUpdateDelay=200;a._referencePointUpdateInterval=3E3;a._referencePointUpdateDistThreshold=1E6;a._referencePosUpdateQuery=null;a._referencePosMapCoordsRequested=null;a._viewHandles=new E;a._preserveAbsoluteDateTime=!1;a._trackingEnabled=!1;a._referencePosResetPreserveAbsoluteTime=
!1;a.referencePosUpdateTimer=null;a._referencePosMapCoords=null;a._mainLight=new u.MainLight;a._ambientLight=new u.AmbientLight;a._moonLight=new u.FillLight;a._renderer=null;a._referencePosWGS84Comparable=null;a._resetReferencePosition();return a}p._inheritsLoose(n,A);var d=n.prototype;d.destroy=function(){this.disconnectView();this._viewHandles.destroy()};d.connectView=function(a){this._renderer||(this._view=a,this._renderer=new H({view:a}),this._viewHandles.add([a.watch("environment.lighting.date",
c=>this._lightingDateHandler(c),!0),a.watch("stationary",()=>this._interactingStationaryHandler()),a.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],()=>this._updateRenderParamsHandler(),!0),a.watch("spatialReference",()=>this._resetReferencePosition(!0),!0),q.init(a,"viewingMode",()=>this._resetReferencePosition(!0),!0),q.init(a,"environment.lighting.cameraTrackingEnabled",
c=>this._updateCameraTracking(c),!0),q.init(a,"state.camera",()=>this._cameraHandler(null),!0),this.watch("disableQueries",()=>this._cameraHandler(null))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))};d.disconnectView=function(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._view=this._renderer=null)};d._updateCameraTracking=function(a){if(this._trackingEnabled=a)this._cameraHandler();
else if(a=this._view.environment.lighting)a.positionTimezoneInfo.autoUpdated=!1};d._lightingDateHandler=function(a){if(a){var c=this._view.environment.lighting;if(!c.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;if(!r.canProjectToWGS84ComparableLonLat(this._view.spatialReference)){var b=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(b)){this._requestReferencePositionUpdate(b);return}}this._preupdateTracking(a);g.isSome(this._referencePosWGS84Comparable)&&
(b=y.positionToTimezoneInfo(this._referencePosWGS84Comparable,B),g.isSome(b)&&(c.autoUpdate(null,b),this._trackingEnabled&&(c.positionTimezoneInfo.autoUpdated=!0)))}this._updateLightParams(a)}};d._preupdateTracking=function(a){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(a)};d._cameraHandler=function(a=null){if(this._view.ready){var c=this._view.camera;c&&(this._cameraHandlerClientSide(c,a)||this._cameraHandlerServerSide(c))}};d._cameraHandlerClientSide=
function(a,c){const b=G.isEarth(this._view.spatialReference);if(b&&!r.canProjectToWGS84ComparableLonLat(this._view.spatialReference))return!1;a=a.position;g.isNone(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=m.create());b?r.projectPointToWGS84ComparableLonLat(a,this._referencePosWGS84Comparable):h.set(this._referencePosWGS84Comparable,a.longitude,a.latitude,a.z);this.notifyChange("referencePositionWGS84Comparable");this._autoUpdateTimezone(this._referencePosWGS84Comparable,
c)||this._updateLightParams(c);return!0};d._cameraHandlerServerSide=function(a){a=a.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(a))&&this._requestReferencePositionUpdate(a,!0);this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=a.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())};d._interactingStationaryHandler=function(){this._view.stationary&&this._executePendingReferencePositionUpdate()};
d._updateLightParams=function(a){var c=this._view.environment.lighting;a=a||c.date;c=this._view._stage;let b;g.isSome(this._referencePosWGS84Comparable)?(b=t.computeColorAndIntensity(a,this._referencePosWGS84Comparable),t.computeDirection(a,this._referencePosWGS84Comparable,this._view.viewingMode,b.diffuse.directionToLightSource)):b={diffuse:{color:[1,1,1],intensity:.55,directionToLightSource:z},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0};h.scale(this._mainLight.intensity,
b.diffuse.color,b.diffuse.intensity*Math.PI);h.copy(this._mainLight.direction,b.diffuse.directionToLightSource);h.scale(this._ambientLight.intensity,b.ambient.color,b.ambient.intensity);h.lerp(this._moonLight.intensity,J,K,b.globalFactor);h.scale(this._moonLight.intensity,this._moonLight.intensity,(1-.5*b.globalFactor)*(1-.4*b.noonFactor*(1-b.globalFactor)));h.copy(this._moonLight.direction,b.diffuse.directionToLightSource);c.renderView.updateLightSources([this._mainLight,this._ambientLight,this._moonLight],
1-b.noonFactor,b.globalFactor);this._updateRenderParamsHandler()};d._autoUpdateTimezone=function(a,c=null){if(!this._view.environment.lighting.cameraTrackingEnabled||g.isNone(a))return!1;const b=L;b.setTime((c||this._view.environment.lighting.date).getTime());a=y.positionToTimezoneInfo(a,B);if(g.isNone(a))return!1;var e=this._view.environment.lighting.positionTimezoneInfo;if(!e.autoUpdated)e=a;else if(e.hours===a.hours&&e.minutes===a.minutes&&e.seconds===a.seconds)return!1;const v=b.getUTCHours()-
(a.hours-e.hours),M=b.getUTCMinutes()-(a.minutes-e.minutes);e=b.getUTCSeconds()-(a.seconds-e.seconds);b.setUTCHours(v);b.setUTCMinutes(M);b.setUTCSeconds(e);return c?!1:this._view.environment.lighting.autoUpdate(b,a)};d._updateRenderParamsHandler=function(){const a=this._view._stage;if(a){var c=g.mapOr(this._referencePosWGS84Comparable,!0,e=>t.computeShadowsEnabled(e,this._view.viewingMode)),b=this._view.environment.background;b=b instanceof I?{type:"color",color:x.fromArray(C.toUnitRGBA(b.color))}:
{type:"color",color:x.fromValues(0,0,0,1)};a.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&c,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:b})}};d._resetReferencePosition=function(a=!1){this._cancelReferencePosUpdates();this._referencePosWGS84Comparable=this._referencePosResetPreserveAbsoluteTime=this._referencePosMapCoordsRequested=this._referencePosMapCoords=
null;this.notifyChange("updating");a&&this._cameraHandler(null)};d._requestReferencePositionUpdate=function(a,c=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(a):this._referencePosMapCoordsRequested=a.clone(),this._referencePosResetPreserveAbsoluteTime=!!c,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){const b=this._referencePosUpdateQuery=w.after(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===
b)return this._doReferencePositionUpdateQuery(()=>this._referencePosUpdateQuery!==b)}).catch(v=>{"mapcoordshelper:missing-geometry-service"===v.name&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===b&&(this._referencePosUpdateQuery=null,this.referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),e=this.referencePosUpdateTimer=w.after(this._referencePointUpdateInterval).then(()=>{this.referencePosUpdateTimer===e&&(this.referencePosUpdateTimer=
null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}};d._doReferencePositionUpdateQuery=function(){var a=p._asyncToGenerator(function*(c){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1);this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone();this._referencePosMapCoordsRequested=this._referencePosResetPreserveAbsoluteTime=
null;const b=yield this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);c()||isNaN(b[0])||isNaN(b[1])||(c=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=b[0],this._referencePosWGS84Comparable[1]=b[1],this._referencePosWGS84Comparable[2]=c):this._referencePosWGS84Comparable=[b[0],b[1],c],this._referencePosChanged())});return function(c){return a.apply(this,arguments)}}();d._executePendingReferencePositionUpdate=
function(){const a=this._referencePosMapCoordsRequested;a&&this._requestReferencePositionUpdate(a,this._referencePosResetPreserveAbsoluteTime)};d._referencePosChanged=function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams();this.notifyChange("referencePositionWGS84Comparable")};d._exceedsReferencePosDistThreshold=function(a){return this._referencePosMapCoords?(a=this._referencePosMapCoords.distance(a),
this._view.mapCoordsHelper&&(a*=this._view.mapCoordsHelper.unitInMeters),a>this._referencePointUpdateDistThreshold):!0};d._cancelReferencePosUpdates=function(){const a=!!this._referencePosUpdateQuery;this.referencePosUpdateTimer=this._referencePosUpdateQuery=null;return a};p._createClass(n,[{key:"updating",get:function(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}},{key:"referencePositionWGS84Comparable",
get:function(){return this._referencePosWGS84Comparable}},{key:"test",get:function(){const a=this;return{renderer:this._renderer,set referencePointUpdateInterval(c){a._referencePointUpdateInterval=c},set referencePointUpdateDistThreshold(c){a._referencePointUpdateDistThreshold=c},set referencePosUpdateTimer(c){a.referencePosUpdateTimer=c},set referencePointUpdateDelay(c){a._referencePointUpdateDelay=c}}}}]);return n}(D.EventedAccessor);f.SceneViewEnvironmentManager.FIXED_LIGHT_DIRECTION=z;k.__decorate([l.property({type:Boolean,
readOnly:!0})],f.SceneViewEnvironmentManager.prototype,"updating",null);k.__decorate([l.property()],f.SceneViewEnvironmentManager.prototype,"disableQueries",void 0);k.__decorate([l.property()],f.SceneViewEnvironmentManager.prototype,"referencePositionWGS84Comparable",null);k.__decorate([l.property()],f.SceneViewEnvironmentManager.prototype,"_renderer",void 0);k.__decorate([l.property()],f.SceneViewEnvironmentManager.prototype,"_referencePosWGS84Comparable",void 0);f.SceneViewEnvironmentManager=k.__decorate([F.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],
f.SceneViewEnvironmentManager);const L=new Date,B={hours:0,minutes:0,seconds:0},J=m.fromValues(.22,.22,.33),K=m.fromValues(.22,.22,.22);f.default=f.SceneViewEnvironmentManager;Object.defineProperty(f,"__esModule",{value:!0})});