// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/compilerUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/Logger ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projectionEllipsoid ../../../../geometry/support/ray ../../../../chunks/sphere ../../../../geometry/support/vectorStacks ../../camera/constraintUtils ../Constraints ./InteractiveController ../utils/navigationUtils ../utils/viewUtils ../../support/cameraUtils ../../support/cameraUtilsInternal ../../webgl-engine/lib/Camera ../../../navigation/gamepadAndKeyboardUtils".split(" "),
function(t,N,B,O,q,P,E,aa,ba,ca,da,Q,p,G,e,H,I,J,K,m,w,y,R,x,L,S,T,M,u){t.GamepadKeyboardController=function(C){function D(a){a=C.call(this,a)||this;a.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0};a.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0];a.tmpCamera=new M;a.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new M,interactionFactor:0,interactionDirection:null,tiltMode:1};return a}N._inheritsLoose(D,C);var g=D.prototype;g.handleEventGamepad=function(a){const b=
u.extractTransformation(a,this.view.navigation.gamepad,this.transformation);("end"===a.action||u.isZeroTransformation(b))&&this.finishController()};g.activateDirection=function(a){this.keysButtonState[a]=1;u.extractTransformationKeyboard(this.keysButtonState,this.transformation)};g.deactivateDirection=function(a){this.keysButtonState[a]=0;a=u.extractTransformationKeyboard(this.keysButtonState,this.transformation);u.isZeroTransformation(a)&&this.finishController()};g.onControllerStart=function(a){this.filteredSurfaceElevation=
this.view.pointsOfInterest.cameraOnSurface.location.z;this.headingStart=this.view.camera.heading;C.prototype.onControllerStart.call(this,a)};g.updateFilteredSurfaceElevation=function(a){this.filteredSurfaceElevation+=(this.view.pointsOfInterest.cameraOnSurface.location.z-this.filteredSurfaceElevation)*a};g.stepController=function(a,b){this.updateStartHeading();this.updateFilteredSurfaceElevation(a);this.currentCamera.copyViewFrom(b);this.updateCameraCenter();this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera);
this.calculateControlTransformation(a,this.currentCamera,v);this.applyDisabledMovementTypes(v);this.applyPan(v.pan);this.applyRotate(v.rotate);this.applyZoom(v.zoom);this.applyAscend(v.ascend);this.constraintOptions.interactionType=0;this.constraintOptions.selection=8;w.applyAll(this.view,this.currentCamera,this.constraintOptions);C.prototype.stepController.call(this,a,b)};g.updateStartHeading=function(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)};g.applyRotate=
function(a){if(a.enabled){var b=this.currentCamera;e.subtract(n,b.center,b.eye);e.transformMat4(n,n,a.matrix);b.center=e.add(n,n,b.eye);b.up=e.transformMat4(n,b.up,a.matrix);this.constraintOptions.interactionType=3;this.constraintOptions.selection=7;w.applyAll(this.view,b,this.constraintOptions)}};g.applyPan=function(a,b=this.currentCamera){a.enabled&&(b.eye=e.transformMat4(n,b.eye,a.matrix),b.center=e.transformMat4(n,b.center,a.matrix),this.view.state.isGlobal&&(b.up=e.transformMat4(n,b.up,a.matrix)),
this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,w.applyAll(this.view,b,this.constraintOptions))};g.applyZoom=function(a){if(a){var b=this.currentCamera.viewForward;this.currentCamera.eye=e.add(n,this.currentCamera.eye,e.scale(m.sv3d.get(),b,a));e.copy(z,b);e.negate(z,z);this.constraintOptions.interactionDirection=z;this.constraintOptions.interactionType=1;this.constraintOptions.selection=7;w.applyAll(this.view,this.currentCamera,this.constraintOptions);this.constraintOptions.interactionDirection=
null}};g.applyAscend=function(a){if(a){var b=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,m.sv3d.get());this.constraintOptions.interactionDirection=e.copy(z,b);this.view.state.isGlobal?(b=e.length(this.currentCamera.eye),a=(b+a)/b,this.currentCamera.eye=e.scale(n,this.currentCamera.eye,a),this.currentCamera.center=e.scale(n,this.currentCamera.center,a)):(a=e.scale(m.sv3d.get(),b,a),this.currentCamera.eye=e.add(n,this.currentCamera.eye,a),this.currentCamera.center=e.add(n,
this.currentCamera.center,a));this.updateCameraCenter();this.constraintOptions.interactionType=5;this.constraintOptions.selection=8;w.applyAll(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter();this.constraintOptions.selection=7;w.applyAll(this.view,this.currentCamera,this.constraintOptions);this.constraintOptions.interactionDirection=null}};g.calculateControlTransformation=function(a,b,c){c.zoom=0;c.ascend=0;c.pan.enabled=!1;p.identity(c.pan.matrix);c.rotate.enabled=
!1;p.identity(c.rotate.matrix);a=this.computeVelocities(a);this.view.state.isLocal?this.calculateControlTransformationLocal(a,b,c):this.calculateControlTransformationGlobal(a,b,c)};g.updateCameraCenter=function(){this.currentCamera.center=this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(this.currentCamera.ray,this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n)};g.calculateControlTransformationLocal=function(a,b,c){const {viewRight:f,viewForward:l}=b,d=this.transformation;
var k=this.view.navigation.gamepad,h=e.set(m.sv3d.get(),l[0],l[1],0);e.normalize(h,h);var r=d.translation[0]*a.pan;0!==r&&(r=e.scale(m.sv3d.get(),f,r),p.translate(c.pan.matrix,c.pan.matrix,r),c.pan.enabled=!0);switch(k.mode){case "pan":k=-d.translation[1]*a.pan;0!==k&&(h=e.scale(m.sv3d.get(),h,k),p.translate(c.pan.matrix,c.pan.matrix,h),c.pan.enabled=!0);c.zoom=d.zoom*a.zoom;break;case "zoom":c.zoom=(-d.translation[1]+d.zoom)*a.zoom;break;default:O.neverReached(k.mode)}c.ascend=d.translation[2]*a.ascend;
h=-d.heading*a.rotate;0!==h&&(p.rotate(c.rotate.matrix,c.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(b.eye,m.sv3d.get())),c.rotate.enabled=!0);a=d.tilt*a.rotate;b=L.viewAngle(this.view.renderCoordsHelper,b.center,b.eye);if(b=q.clamp(b+a,y.TiltDefault.min,y.TiltDefault.max)-b)p.rotate(c.rotate.matrix,c.rotate.matrix,b,f),c.rotate.enabled=!0};g.calculateControlTransformationGlobal=function(a,b,c){const {eye:f,viewRight:l}=b,d=this.transformation;var k=this.view.navigation.gamepad,
h=e.cross(m.sv3d.get(),l,f);e.normalize(h,h);e.negate(h,h);x.panMotionToRotationMatrix(this.startCamera,b,d,a,this.view.camera.heading,this.headingStart,this.view.camera.tilt,c,k);this.tmpCamera.copyFrom(this.currentCamera);this.applyPan(v.pan,this.tmpCamera);k=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;c.ascend=d.translation[2]*a.ascend;h=-d.heading*a.rotate;0!==h&&(p.rotate(c.rotate.matrix,c.rotate.matrix,h,this.tmpCamera.eye),c.rotate.enabled=!0);b=this.clampTiltDeltaGlobalToValidRange(d.tilt*
a.rotate,b.ray,k);0!==b&&(p.rotate(c.rotate.matrix,c.rotate.matrix,b,this.tmpCamera.viewRight),c.rotate.enabled=!0);c.zoom+=d.zoom*a.zoom};g.clampTiltDeltaGlobalToValidRange=function(a,b,c){const f=I.getReferenceEllipsoid(this.view.spatialReference),l=x.onSurfaceTiltToEyeTiltGlobal(y.TiltDefault.min,b.origin,c,f);var d=0;let k=0;d=m.sv3d.get();this.view.renderCoordsHelper.intersectManifold(b,c,d)?(d=L.viewAngle(this.view.renderCoordsHelper,d,b.origin),d=x.onSurfaceTiltToEyeTiltGlobal(d,b.origin,c,
f),k=x.onSurfaceTiltToEyeTiltGlobal(y.TiltDefault.max,b.origin,c,f)):(K.closestPointOnSilhouette(K.fromRadius(c+f.radius),b,d),d=q.acosClamped(-e.dot(b.direction,e.normalize(d,d))),d=x.offSurfaceTiltToEyeTiltGlobal(d,b.origin,c,f),k=x.offSurfaceTiltToEyeTiltGlobal(y.TiltDefault.max,b.origin,c,f));return q.clamp(d+a,l,k)-d};g.getPointAbsoluteSurfaceElevation=function(a,b,c){const {renderCoordsHelper:f}=this.view,l=f.getAltitude(a);b+=Math.abs(l-b);f.setAltitude(c,b,a);return b};g.clampedDistanceToSurface=
function(a,b){const {renderCoordsHelper:c}=this.view,{camera:f}=this.view.state;var {direction:l}=S.headingTiltToDirectionUp(this.view,b,0,80,U);l=c.intersectManifoldClosestSilhouette(J.wrap(b,l),a,m.sv3d.get());l=e.distance(b,l);a=c.intersectManifoldClosestSilhouette(J.wrap(b,e.direction(m.sv3d.get(),b,f.center)),a,m.sv3d.get());b=e.distance(b,a);return Math.min(l,b)};g.computeHeadingRotateRadius=function(a){const {renderCoordsHelper:b,state:c}=this.view,{camera:f,isGlobal:l}=c;var d=b.intersectManifoldClosestSilhouette(f.ray,
this.filteredSurfaceElevation,m.sv3d.get());if(l){const k=e.subtract(m.sv3d.get(),a,d);d=e.length(k);e.scale(k,k,1/d);a=e.normalize(m.sv3d.get(),a);a=q.acosClamped(e.dot(a,k));return d*Math.sin(Math.min(V,a))}a=e.copy(m.sv3d.get(),a);b.setAltitude(a,this.filteredSurfaceElevation);return e.distance(d,a)};g.minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:5};g.computeVelocities=function(a){var b=this.filteredSurfaceElevation,c=b+I.getReferenceEllipsoid(this.view.spatialReference).radius;
const {camera:f,isGlobal:l}=this.view.state;var d=m.sv3d.get();const k=this.getPointAbsoluteSurfaceElevation(f.eye,b,d);var h=this.clampedDistanceToSurface(b,d);const r=f.width/2,F=.75*f.width,W=.75*f.width;var A=h*Math.tan(.5*f.fovX)/r;c=A/c;d=A/this.computeHeadingRotateRadius(d);A=(l?c:A)*F*a;b=k-b;b=Math.max(this.minimumAscendVelocity()*a,2**(F*a/r)*b-b);h=2**(F*a/r)*h-h;a*=q.clamp(d*W,X,Y);return{pan:A,ascend:b,zoom:h,rotate:a}};g.applyDisabledMovementTypes=function(a){!P.isSome(this.disableMovements)||
void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(a.zoom=this.disableMovements.zoom?0:a.zoom,a.ascend=this.disableMovements.ascend?0:a.ascend,a.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&p.identity(a.pan.matrix),a.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&p.identity(a.rotate.matrix))};D.activatesFor=function(a,b){a=u.extractTransformation(b,a.navigation.gamepad,Z);return!("end"===b.action||u.isZeroTransformation(a))};
return D}(R.InteractiveController);B.__decorate([E.property({constructOnly:!0})],t.GamepadKeyboardController.prototype,"view",void 0);B.__decorate([E.property({constructOnly:!0})],t.GamepadKeyboardController.prototype,"gamepadDevice",void 0);B.__decorate([E.property({constructOnly:!0})],t.GamepadKeyboardController.prototype,"disableMovements",void 0);t.GamepadKeyboardController=B.__decorate([Q.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],t.GamepadKeyboardController);const Z=
{translation:[0,0,0],heading:0,tilt:0,zoom:0},V=q.deg2rad(80),X=q.deg2rad(30),Y=q.deg2rad(80),v={zoom:0,ascend:0,pan:{enabled:!1,matrix:G.create()},rotate:{enabled:!1,matrix:G.create()}},n=H.create(),z=H.create(),U=T.createDirectionUp();Object.defineProperty(t,"__esModule",{value:!0})});