// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../../core/Handles ../../../../../core/maybe ../../../../../layers/graphics/hydratedFeatures ../../editingTools/dragEventPipeline3D ./AreaMeasurement3DView ../../../../interactive/dragEventPipeline ../../../../support/screenUtils".split(" "),function(u,h,l,v,w,x,m){return function(){function n(a,c,f){this._manipulators=f;this._handles=new u;this._tempPickRequest=new w.PickRequest;this.model=a;this.view=c;this._setupManipulators()}var d=n.prototype;d.destroy=function(){this._handles.destroy();
this._handles=null};d.handleInputEvent=function(a){switch(a.type){case "immediate-double-click":this._handleImmediateDoubleClick(a);break;case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a);break;case "drag":this._handleDrag(a);break;case "key-down":this._handleKeyDown(a)}};d._setupManipulators=function(){let a=0;const c=b=>e=>{"start"===e.action&&(a++,this.view.lastDraggedVertex=h.unwrap(this.view.manipulatorToVertex(b)),"measured"===this.model.state&&
(this.model.state="editing"));return e},f=()=>b=>"end"===b.action?(a--,0===a&&"editing"===this.model.state&&(this.model.state="measured"),null):b,t=(b,e)=>{this._handles.add([x.createManipulatorDragEventPipeline(e,(g,y,z)=>{const p=v.hideManipulatorWhileDragging(g),k=h.unwrap(this.view.manipulatorToVertex(g));y.next(c(g)).next(p).next(f()).next(this.view.screenToMap3D()).next(q=>{g.location=q.mapEnd;this.view.path.setVertexPosition(k,l.clonePoint(q.mapEnd))});const r=l.clonePoint(this.view.path.getVertexPositionAsPoint(k));
z.next(p).next(()=>{this.view.path.setVertexPosition(k,r);g.location=r})})],`manipulator-${b}`)},A=b=>{this._handles.remove(`manipulator-${b}`)};this._manipulators.forEach(({id:b,manipulator:e})=>{t(b,e)});this._handles.add([this._manipulators.on("after-add",({item:{id:b,manipulator:e}})=>{t(b,e)}),this._manipulators.on("after-remove",({item:{id:b}})=>{A(b)})])};d._handleImmediateDoubleClick=function(a){if("mouse"!==a.pointerType||0===a.button)"drawing"===this.model.state&&this.view.finishMeasurement(),
a.stopPropagation()};d._handleDrag=function(a){"editing"===this.model.state&&a.stopPropagation()};d._handleImmediateClick=function(a){if("mouse"!==a.pointerType||0===a.button){var c=m.createScreenPointFromEvent(a);if(this.model.active)switch(this.model.state){case "initial":if(this._addVertexAt(c)){this.view.cursorPoint=null;this.model.state="drawing";a.stopPropagation();return}break;case "drawing":{const f=this.view.vertexHandleAt(c,a.pointerType);if(h.isNone(f)){if(this._addVertexAt(c)){this.view.cursorPoint=
null;a.stopPropagation();return}}else 0===f.index&&(this.view.finishMeasurement(),a.stopPropagation())}}"mouse"===a.pointerType&&this._hoverAt(c)}};d._handlePointerMove=function(a){"mouse"===a.pointerType&&(a=m.createScreenPointFromEvent(a),this._hoverAt(a))};d._handleKeyDown=function(a){"Enter"===a.key&&"drawing"===this.model.state&&(this.view.finishMeasurement(),a.stopPropagation())};d._hoverAt=function(a){this.view.requiresCursorPoint?(a=this._pick(a),a.mapPoint&&(this.view.cursorPoint=a.mapPoint)):
this.view.cursorPoint=null};d._addVertexAt=function(a){a=this._pick(a);return a.mapPoint?(this.view.path.add(a.mapPoint),!0):!1};d._pick=function(a){const c=this._tempPickRequest;c.screenPoint=a;return this.view.pick(c)};return n}()});