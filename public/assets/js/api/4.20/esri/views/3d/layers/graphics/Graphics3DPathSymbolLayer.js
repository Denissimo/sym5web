// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/mathUtils ../../../../core/maybe ../../../../chunks/mat2 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f32 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ../support/FastSymbolUpdates ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/PathGeometry ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial".split(" "),
function(B,N,Z,E,C,aa,O,ba,n,P,Q,R,F,I,G,ca,da,H,S,T,ea,U,k,fa,ha){function V(f,x,l){switch(x){case "world":for(const a of f.vertices)n.add(y,a.pos,f.offset),l.worldUpAtPosition(y,v),a.setFrameFromUpVector(v),a.computeRotationAxisAndAngleFromUpVector();break;case "path":n.add(y,f.vertices[0].pos,f.offset);l.worldUpAtPosition(y,v);k.computeMinimumRotationTangentFrame(f,v);for(const a of f.vertices)f=E.sign(n.dot(a.frame.right,a.vRight)),n.cross(a.rotationFrame.up,a.vRight,a.vLeft),n.scale(a.rotationFrame.up,
a.rotationFrame.up,f),n.normalize(a.rotationFrame.up,a.rotationFrame.up),x=n.dot(a.rotationFrame.up,a.frame.up),l=n.dot(a.rotationFrame.up,a.frame.right),n.scale(y,a.frame.up,-l),n.scale(W,a.frame.right,x),n.add(y,y,W),n.normalize(a.rotationFrame.right,y),k.vertexSpaceToProfileSpace(a.rotationRight,a.frame,a.rotationFrame.right),n.negate(y,a.vLeft),a.rotationAngle=-f*(Math.PI-E.acosClamped(n.dot(y,a.vRight))),0<Math.abs(a.rotationAngle)&&(f=E.reciprocalClamped(Math.cos(.5*a.rotationAngle)),aa.set(a.miterStretch,
1+(f-1)*a.rotationRight[0]*a.rotationRight[0],(f-1)*a.rotationRight[0]*a.rotationRight[1],(f-1)*a.rotationRight[0]*a.rotationRight[1],1+(f-1)*a.rotationRight[1]*a.rotationRight[1])),a.maxStretchDistance=Math.abs(Math.min(a.vLeftLength,a.vRightLength)*E.reciprocalClamped(Math.cos(.5*(Math.PI-a.rotationAngle))))}}function X(f,x,l){switch(f){case "symbol-value":return l;case "proportional":return x;default:return f}}function ia(f,x,l,a){f=f.stageObject;const b=f.geometryRecords,h=b.length;var g=0;a.spatialReference;
for(let w=0;w<h;w++){const r=b[w].geometry;if(!U.isPathGeometry(r))continue;const z=r.path,m=z.builder.path;r.geometrySR;{var c=m;var d=x,A=l,t=a;let e=0;for(const p of c.vertices){const q=G.evaluateElevationAlignmentAtPoint(p.posES,A,d,t,Y);e+=Y.sampledElevation;n.add(v,p.pos,c.offset);t.setAltitude(v,q);n.subtract(p.pos,v,c.offset)}c.updatePathVertexInformation();c=e/c.vertices.length}g+=c;"world"!==r.upVectorAlignment&&V(m,r.upVectorAlignment,a);z.onPathChanged();r.invalidateBoundingInfo();f.geometryVertexAttrsUpdated(w)}return g/
h}const ja=["polyline"];I=function(f){function x(a,b,h,g){a=f.call(this,a,b,h,g)||this;a._intrinsicSize=ba.fromValues(1,1);a.upVectorAlignment="path";a.stencilWidth=.1;a.ensureDrapedStatus(!1);return a}N._inheritsLoose(x,f);var l=x.prototype;l.doLoad=function(){var a=N._asyncToGenerator(function*(){const b=C.isSome(this.symbolLayer.width)?this.symbolLayer.width:C.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,h=C.isSome(this.symbolLayer.height)?this.symbolLayer.height:
b;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[b,1,h],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?T.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};var g=this.symbolLayer.anchor||"center";
this.upVectorAlignment="path";"heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");var c=this.symbolLayer.profile||"circle";switch(c){default:this._profile=k.Profile.circle(10);break;case "quad":this._profile=k.Profile.rect()}var d=[0,0];"center"!==g&&(d={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[g],this._profile.translate(d[0],d[1]));switch(this.symbolLayer.join||"simple"){case "round":this._extruder=new k.MiterExtruder(0,3);break;case "bevel":this._extruder=
new k.MiterExtruder(0,1);break;case "miter":this._extruder=new k.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new k.SimpleExtruder}g=this.symbolLayer.cap||"butt";switch(g){case "none":this._startCap=new k.NoCapBuilder;this._endCap=new k.NoCapBuilder;break;default:this._startCap=new k.TriangulationCapBuilder(this._profile,0);this._endCap=new k.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new k.TriangulationCapBuilder(this._profile,-.5);this._endCap=new k.TriangulationCapBuilder(this._profile,
.5,!0);break;case "round":c="quad"===c?!0:!1,this._startCap=new k.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:c,subdivisions:3}),this._endCap=new k.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:c,subdivisions:3})}c=C.get(this.symbolLayer,"material","color");d=this._getCombinedOpacityAndColor(c);c=Q.fromArray(d);d=d[3];const A=1>d||this.needsDrivenTransparentPass;g={diffuse:c,ambient:c,opacity:d,transparent:A,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,
castShadows:this.symbolLayer.castShadows,cullFace:A||"none"===g?0:2,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(O.set(this._intrinsicSize,b,h),!S.isValidSize(this._intrinsicSize[0])||!S.isValidSize(this._intrinsicSize[1])))throw new Z("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||O.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);
this._fastUpdates.enabled?(Object.assign(g,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new ha.PathMaterial(g)):(g.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new fa.DefaultMaterial(g));this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._context.stage.add(this._material)});return function(){return a.apply(this,arguments)}}();l.destroy=
function(){f.prototype.destroy.call(this);this._context.stage.remove(this._material);this._material=null};l.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,ja,this.symbolLayer.type))return null;const h=this.setGraphicElevationContext(b,new ca.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,h,b.uid)};l.layerOpacityChanged=function(){var a=C.get(this.symbolLayer,"material","color");a=this._getCombinedOpacity(a);this._material.setParameterValues({opacity:a,
transparent:1>a||this.needsDrivenTransparentPass});return!0};l.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,G.needsElevationUpdates3D)};l.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};l.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};l.pixelRatioChanged=function(){return!0};
l.applyRendererDiff=function(a,b){for(const h in a.diff)switch(h){case "visualVariables":if(T.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};l.getVertexData=function(a){let b=0;const h=a.paths,g=[],c=a.spatialReference,d=this._context.elevationProvider.spatialReference,A=this._context.renderCoordsHelper.spatialReference;for(var t of h)b+=t.length;t=new Float64Array(3*
b);const w=new Float64Array(3*b),r=new Float64Array(3*b);let z=0;for(const m of h){g.push({index:z,numVertices:m.length});for(const e of m)t[z++]=e[0],t[z++]=e[1],t[z++]=a.hasZ?e[2]:0}a=!0;c.equals(d)?this._copyVertices(t,0,w,0,b):a=R.projectBuffer(t,c,0,w,d,0,b);d.equals(A)?this._copyVertices(w,0,r,0,b):R.projectBuffer(w,d,0,r,A,0,b);return{pathVertexDataInfos:g,vertexDataGS:t,vertexDataES:w,vertexDataRS:r,projectionSuccess:a,terrainElevation:0}};l._copyVertices=function(a,b,h,g,c){b*=3;g*=3;for(let d=
0;d<c;++d)h[g++]=a[b++],h[g++]=a[b++],h[g++]=a[b++]};l._createAs3DShape=function(a,b,h,g){var c=a.geometry,d=[];const A=[],t=[],w=c.spatialReference,r=F.create(),z=this._context.renderCoordsHelper,m=this.getVertexData(c);if(!m.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0<m.pathVertexDataInfos.length){for(c=0;c<m.pathVertexDataInfos.length;++c){var e=m.pathVertexDataInfos[c],p=e.index;e=
e.numVertices;if(2>e)continue;if(C.isSome(this._context.clippingExtent)&&(F.empty(r),F.expandWithBuffer(r,m.vertexDataES,3*p,e),!F.intersectsClippingArea(r,this._context.clippingExtent)))continue;var q=[];for(var u=p;u<p+3*e;){const J=u++,K=u++,L=u++,D=new k.PathVertex;n.set(D.posGS,m.vertexDataGS[J],m.vertexDataGS[K],m.vertexDataGS[L]);n.set(D.posES,m.vertexDataES[J],m.vertexDataES[K],m.vertexDataES[L]);const ka=G.evaluateElevationAlignmentAtPoint(D.posES,this._context.elevationProvider,h,z,null);
n.set(v,m.vertexDataRS[J],m.vertexDataRS[K],m.vertexDataRS[L]);z.setAltitude(v,ka);n.set(D.pos,v[0],v[1],v[2]);q.push(D)}p=new k.Path(q);V(p,this.upVectorAlignment,this._context.renderCoordsHelper);p=new k.Builder(p,this._profile,this._extruder,this._startCap,this._endCap);e=null;this._fastUpdates.enabled?(u=this._fastUpdates.visualVariables,e=u.size?H.getAttributeValue(u.size.field,a):0,q=u.color?H.getAttributeValue(u.color.field,a):0,u=u.opacity?H.getAttributeValue(u.opacity.field,a):0,e=new k.FastUpdatePathGeometry(p,
e,q,u)):(e=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(e[0]*=X(b.size[0],"symbol-value"===b.size[2]?this.symbolLayer.height||0:b.size[2],this.symbolLayer.width||0),e[1]*=X(b.size[2],"symbol-value"===b.size[0]?this.symbolLayer.width||0:b.size[0],this.symbolLayer.height||0)),q=null,this._drivenProperties.color&&(q=b.color),this._drivenProperties.opacity&&null!=b.opacity&&(q=q?[q[0],q[1],q[2],b.opacity]:[1,1,1,b.opacity]),p=new k.StaticPathGeometry(p),p.bake(e),q&&p.bakeVertexColors(q),
e=p);const {vertexAttributes:M,indices:la}=e.createGeometryData();p=new U.PathGeometry(M,la,e,w,this.upVectorAlignment,this.stencilWidth);d.push(p);A.push(this._material);t.push(e.xform)}if(0<d.length)return a=new ea.Object3D({geometries:d,materials:A,transformations:t,metadata:{layerUid:this._context.layer.uid,graphicUid:g}}),d=new da.Graphics3DObject3DGraphicLayer(this,a,d,null,null,ia,h),d.alignedSampledElevation=m.terrainElevation,d.needsElevationUpdates=G.needsElevationUpdates3D(h.mode),d}else 0!==
c.paths.length&&c.paths.some(M=>0<M.length)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null};return x}(H.Graphics3DSymbolLayer);const v=Q.create(),y=P.create(),W=P.create(),Y={verticalDistanceToGround:0,sampledElevation:0};B.Graphics3DPathSymbolLayer=I;B.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;B.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3;B.NUM_ROUND_JOIN_SUBDIVISIONS=3;B.default=I;Object.defineProperty(B,"__esModule",{value:!0})});