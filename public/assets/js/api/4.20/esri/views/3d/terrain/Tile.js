// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/mathUtils ../../../core/maybe ../../../core/ObjectPool ../../../core/promiseUtils ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4 ../../../chunks/vec4f64 ../../../geometry/projectionEllipsoid ../../../geometry/support/aaBoundingRect ../../../chunks/sphere ../../2d/engine/vectorTiles/VectorTile ../support/StreamDataLoader ./ElevationBounds ./ElevationTileAgent ./MapTileAgent ./RasterTile ./TerrainConst ./terrainUtils ./TileAgent ./TilePerLayerInfo ./TileTexture ./tileUtils ../../webgl/Util".split(" "),
function(B,T,U,v,K,V,C,W,g,t,X,D,Y,E,Z,L,M,N,O,P,Q,q,y,n,F,R,r,G){function A(p){p.dispose();p instanceof O?H.release(p):p instanceof P&&I.release(p)}const J=t.create(),w=t.create(),l=t.create(),u=D.create();D=function(){function p(a){this._numSubdivisionAtLevel=a;this.lij=[0,0,0];this._children=[null,null,null,null];this._dirty=!0;this._previouslyRendered=!1;this.extent=E.create();this._elevationBounds=W.create();this.layerInfo=[[],[]];this.extentInRadians=E.create();this.centerAtSeaLevel=t.create();
this._center=[t.create(),Z.create(),t.create()];this.up=t.unitZ();this._intersectsClippingArea=this._isWithinClippingArea=!0;this._maxTesselation=0;this._usedMemory=-1;this._curvatureHeight=this._edgeLen2=this._edgeLen=this.renderOrder=this._screenDepth=this._mapDataRefCount=this._mapTileMemory=0}p.prune=function(){I.prune(0);H.prune(0);F.TilePerLayerInfo.prune()};var e=p.prototype;e.init=function(a,b,c){this.lij[0]=a[0];this.lij[1]=a[1];this.lij[2]=a[2];this.ellipsoid=Y.getReferenceEllipsoid(c.tilingScheme.spatialReference);
c.tilingScheme.getExtent(a[0],a[1],a[2],this.extent);c.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians);this._intersectsClippingArea=this._isWithinClippingArea=!0;this._clippingArea=null;this._mapDataRefCount=0;c.upsampleMapCache.pop(r.tile2str(this));this._edgeLen2=this._edgeLen=0;this._center[1][3]=0;this.vlevel=a?a[0]:0;b&&b.elevationBounds?C.copy(this._elevationBounds,b.elevationBounds):C.set(this._elevationBounds,0,0);this._pendingUpdates=0;this.renderData=null;this._screenDepth=
0;this._previouslyRendered=this._visible=!1;this._parent=b;this.unsetChildren();this._surface=c;this.updateVisibility();for(const d of q.LayerClasses){a=c.numLayers(d);b=this.layerInfo[d];for(const f of b)f.release();b.length=a;for(let f=0;f<a;f++)b[f]=F.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool),0===d&&this.findElevationBoundsForLayer(f,-1)}this.computeElevationBounds();this._maxTesselation=Math.min(c.tilingScheme.pixelSize,q.MAX_PATCH_TESSELATION)};e.release=function(){y.weakAssert(!this.renderData,
"tile.renderData was not unloaded");this._surface.upsampleMapCache.pop(r.tile2str(this));for(const a of q.LayerClasses){for(const b of this.layerInfo[a])b.release();this.layerInfo[a].length=0}this._surface=this._parent=null;this._usedMemory=-1};e.refMapData=function(){++this._mapDataRefCount;this.isCached||this._surface.upsampleMapCache.pop(r.tile2str(this))};e.unrefMapData=function(){--this._mapDataRefCount;if(this.isCached){const a=this.cachedMemory;0<a&&(this._surface.upsampleMapCache.put(r.tile2str(this),
this,a),this.setMemoryDirty())}};e.setMemoryDirty=function(){this._usedMemory=-1};e._updateMemoryUsed=function(){this._mapTileMemory=this._usedMemory=0;const a=this.cpuImageMemorySize;for(const {data:b}of this.layerInfo[1])b instanceof R?this._mapTileMemory+=G.getGpuMemoryUsage(b.texture):b instanceof HTMLImageElement||b instanceof M.ImageWithType?this._mapTileMemory+=a:b instanceof Q&&(this._mapTileMemory+=b.memoryUsage);for(const b of this.layerInfo[0])this._usedMemory+=b.data?a:0;this.renderData&&
(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=G.getGpuMemoryUsage(this.renderData.textureDescriptor));this.isCached&&this._surface.upsampleMapCache.updateSize(r.tile2str(this),this,this.cachedMemory)};e.getUsedMemoryForLayer=function(a,b){b=this.layerInfo[a][b];if(!b||!b.data)return 0;if(1===a&&!this.isCached){a=b.data;if(a instanceof R)return G.getGpuMemoryUsage(a.texture);if(a instanceof HTMLImageElement||a instanceof M.ImageWithType)return this.cpuImageMemorySize;
if(a instanceof L.VectorTile||a instanceof Q)return a.memoryUsage}else if(0===a)return this.cpuImageMemorySize;return 0};e.updateScreenDepth=function(a){g.copy(u,this._center[1]);u[3]=1;X.transformMat4(u,u,a);this._screenDepth=0>u[2]?0:u[2]/u[3]};e.shouldSplit=function(a,b,c){if(v.isSome(a.frustum)&&!this._isVisible(a.frustum))return 0;const d=this.level;g.subtract(J,this._center[1],b);var f=g.squaredLength(J);let m=1;g.subtract(w,this._center[0],b);var h=g.squaredLength(w);h<f&&(f=h,m=0);g.subtract(w,
this._center[2],b);h=g.squaredLength(w);h<f&&(f=h,m=2);if(this._edgeLen2>f&&d<a.maxLod)return 2;f=Math.sqrt(f);const k=this._edgeLen/(a.fovX*f*2);h=()=>{const S=d+Math.ceil(-U.log2(a.relativeWidthLimit/k));return S!==this.vlevel?(this.vlevel=S,4):1};if(1===c&&1===this._surface.snapLevel-d)return d>=a.maxLod?h():2;const x=g.dot(this.up,J);c=this._elevationBounds[1]-this._elevationBounds[0];const z=c/this.edgeLen;return a.aboveGround&&0<x&&.001>z&&0<x/f-Math.sin(this._curvatureHeight/(this.edgeLen*
Math.SQRT1_2)*Math.PI)-z?0:k<a.relativeWidthLimit?this.vlevel!==this.level?(this.vlevel=this.level,4):0:d>=a.maxLod?h():6<d&&(g.subtract(w,this._center[m],b),g.scale(l,this.up,x),g.subtract(l,l,w),h=g.squaredLength(l),h>this.radius*this.radius&&(g.scale(l,l,this.radius/Math.sqrt(h)),g.add(l,l,this._center[m]),g.subtract(l,b,l),Math.min(1,(Math.abs(g.dot(l,this.up))+.5*c+this._curvatureHeight)/g.length(l))*(this._edgeLen/(a.fovY*f*2))<.1/a.angledSplitBias*a.relativeHeightLimit))?0:2};e.setChildren=
function(a,b,c,d){y.weakAssert(!!(a&&b&&c&&d),"Null child passed");this._children[0]=a;this._children[1]=b;this._children[2]=c;this._children[3]=d};e.unsetChildren=function(){this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null};e.load=function(a){this.refMapData();for(const b of q.LayerClasses)this._createOrUpdateAgents(0,b);a.loadTile(this)};e.unload=function(a){a.unloadTile(this);for(const b of q.LayerClasses){a=this.layerInfo[b];for(const c of a)c.loadingAgent&&
c.loadingAgent!==n.TILE_AGENT_DONE&&(A(c.loadingAgent),c.loadingAgent=null),c.pendingUpdates=0}this.resetPendingUpdate(32);this.resetPendingUpdate(64);this.unrefMapData()};e.unloadMapData=function(){const a=this.layerInfo[1];for(const b of a)b.loadingAgent&&b.loadingAgent!==n.TILE_AGENT_DONE&&(A(b.loadingAgent),b.loadingAgent=null),b.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture();this.setMemoryDirty()};e.updateClippingStatus=function(a){if(E.equals(a,this._clippingArea))return!1;
var b=this._intersectsClippingArea;const c=this._isWithinClippingArea;v.isSome(a)?(this._intersectsClippingArea=this.intersectsExtent(a),this._isWithinClippingArea=this._isWithinExtent(a)):this._isWithinClippingArea=this._intersectsClippingArea=!0;this._clippingArea=a;this.updateVisibility();a=c&&this._isWithinClippingArea;b=!c&&!b&&!this._isWithinClippingArea&&!this._intersectsClippingArea;!this.renderData||a||b||this.setPendingUpdate(32);return!0};e.updateVisibility=function(){this._dirty=!0;this._surface.setTileTreeDirty()};
e.getLayerInfo=function(a,b){return this.layerInfo[b][a]};e.hasLayerData=function(a,b){a=this.layerInfo[b][a];return!(!a||!a.data||a.dataInvalidated)};e.isSuspended=function(a){return this.hasPendingUpdate(2)?!0:0===a?!1:!this.loadable};e.hasPendingUpdate=function(a){return(this._pendingUpdates&a)===a};e.setPendingUpdate=function(a){this._pendingUpdates|=a;2===a||8===a?this._surface.setTileTreeDirty():this._surface.requestUpdate()};e.resetPendingUpdate=function(a){return this.hasPendingUpdate(a)?
(this._pendingUpdates&=~a,!0):!1};e.requestLayerData=function(a,b,c){const d=this.layerInfo[b][a];if(d.waitingAgents.has(c))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),!0;d.waitingAgents.push(c);if(d.data&&!d.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),c.dataArrived(this),!0;if(d.requestPromise)return!0;
v.abortMaybe(d.requestAbort);d.requestAbort=V.createAbortController();const f=this._surface.requestTileData(this,a,b,d.requestAbort);if(!f)return d.requestAbort=null,!1;a=()=>{d.requestPromise===f&&(d.requestPromise=null,d.requestAbort=null)};d.requestPromise=f;f.then(a,a);return!0};e.hasLij=function(a){return this.lij[0]===a[0]&&this.lij[1]===a[1]&&this.lij[2]===a[2]};e.findByLij=function(a){return this.hasLij(a)?this:this.isLeaf?null:(a=this._children[0].findByLij(a)||this._children[1].findByLij(a)||
this._children[2].findByLij(a)||this._children[3].findByLij(a))?a:null};e.distanceToSquared=function(a){return g.squaredLength(g.subtract(l,this._center[1],a))};e.containsPoint=function(a){const b=this.extent;return a[0]>=b[0]&&a[1]>=b[1]&&a[0]<=b[2]&&a[1]<=b[3]};e.unrequestLayerData=function(a,b,c){a=this.layerInfo[b][a];b=a.waitingAgents;c=null!=b.removeUnordered(c);y.weakAssert(c,"agent has not requested this piece of map data");1>b.length&&(a.abortRequest(),this._updateMemoryUsed())};e.dataArrived=
function(a,b,c){a=this.layerInfo[b][a];a.data=c;a.dataInvalidated=!1;a.waitingAgents.forAll(d=>d.dataArrived(this));a.waitingAgents.clear();this._updateMemoryUsed()};e.dataMissing=function(a,b,c){c.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${b}/${a} error ${c}`);a=this.layerInfo[b][a];a.dataMissing=!0;a.waitingAgents.forAll(d=>d.dataMissing());a.waitingAgents.clear();this._updateMemoryUsed()};e.updateRenderData=function(a){switch(a){case 1:return this.updateTexture();case 0:return this.updateGeometry()}};
e.updateTexture=function(){this.renderData&&this.setPendingUpdate(64)};e.updateGeometry=function(){this.setPendingUpdate(32);for(const a of this.layerInfo[0])a.pendingUpdates|=32};e.invalidateLayerData=function(a,b){this.layerInfo[b][a].invalidateSourceData();this.restartAgents(b)};e.computeElevationBounds=function(){C.set(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const a=this.layerInfo[0];let b=!0;for(const c of a)v.isSome(c.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],
c.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],c.elevationBounds.max),c.elevationBounds.hasNoDataValues||(b=!1));b&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0));this.updateRadiusAndCenter();this._surface.setTileTreeDirty()};e._updateCenter=function(){g.scale(l,this.up,.5*(this._elevationBounds[0]+this._elevationBounds[1]));g.add(this._center[1],this.centerAtSeaLevel,l);g.scale(l,this.up,
this._elevationBounds[0]);g.add(this._center[0],this.centerAtSeaLevel,l);g.scale(l,this.up,this._elevationBounds[1]);g.add(this._center[2],this.centerAtSeaLevel,l)};e.findElevationBoundsForLayer=function(a,b){const c=this.layerInfo[0][a];if(!(v.isSome(c.elevationBounds)&&c.elevationBounds.level>=b)&&(b=this._surface.layerViewByIndex(a,0),b=y.getLayerWithExtentRange(b),r.fallsWithinLayer(this,b,!1))){b=aa;var d=!1;if(c.data)a=c.data,b.min=a.bounds[0],b.max=a.bounds[1],b.hasNoDataValues=a.hasNoDataValues,
b.level=this.lij[0],d=!0;else{let f=0,m,h;for(let k=this._parent;k&&(!h||f<q.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&!(f=this.vlevel-k.level,m=h||m,h=k.layerInfo[0][a].data,!h&&m&&f>=q.ELEVATION_DESIRED_RESOLUTION_LEVEL);k=k.parent);if(h=h||m)h.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],b),Infinity!==b.min&&(b.level=h.level,d=!0)}d&&(v.isNone(c.elevationBounds)&&(c.elevationBounds=new N.ElevationBounds),c.elevationBounds.copyFrom(b))}};e.modifyLayers=function(a,b,c){c=this.layerInfo[c];for(var d of c)d.loadingAgent&&
d.loadingAgent!==n.TILE_AGENT_DONE&&(A(d.loadingAgent),d.loadingAgent=null),d.waitingAgents.clear();for(d=0;d<c.length;++d)void 0===a[d]&&c[d].release();a=Array(...c);d=b.length;c.length=d;for(let f=0;f<d;f++){const m=b[f];c[f]=-1<m?a[m]:F.TilePerLayerInfo.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()};e.restartAgents=function(a){this.renderData&&(this._createOrUpdateAgents(0,a),this.updateRenderData(a))};e.updateAgents=function(a){if(this.renderData){const b=this.layerInfo[a];
for(const c of b)c.loadingAgent===n.TILE_AGENT_DONE&&(c.loadingAgent=null);this._createOrUpdateAgents(0,a)}};e.updateAgentSuspension=function(){for(const a of q.LayerClasses){const b=this.isSuspended(a);for(const c of this.layerInfo[a])c.loadingAgent&&c.loadingAgent!==n.TILE_AGENT_DONE&&(c.loadingAgent.setSuspension(b),c.loadingAgent===n.TILE_AGENT_DONE&&this.updateRenderData(a))}};e.removeLayerAgent=function(a,b){a=this.layerInfo[b][a];a.loadingAgent&&a.loadingAgent!==n.TILE_AGENT_DONE&&a.loadingAgent.dispose();
a.loadingAgent=null};e.agentDone=function(a,b){const c=this.layerInfo[b][a];c.loadingAgent=n.TILE_AGENT_DONE;c.data||c.upsampleInfo||this._createOrUpdateAgents(a+1,b)};e._createOrUpdateAgents=function(a,b){const c=this.isSuspended(b),d=this.layerInfo[b];for(;a<d.length;++a){const k=d[a];var f=!1;const x=this._surface.layerViewByIndex(a,b);var m=y.getLayerWithExtentRange(x);if(k.loadingAgent)r.fallsWithinLayer(this,m,!1)?(k.loadingAgent!==n.TILE_AGENT_DONE&&k.loadingAgent.setSuspension(c),k.loadingAgent!==
n.TILE_AGENT_DONE&&(f=k.loadingAgent.update())):k.dispose();else if(r.fallsWithinLayer(this,m,!1)){{f=a;m=b;var h=c;const z=0===m?H.acquire():I.acquire();z.init(this,f,m,h);f=z}k.loadingAgent=f;(f=k.loadingAgent.startLoading())?k.loadingAgent===n.TILE_AGENT_DONE&&this.setPendingUpdate(32):(A(k.loadingAgent),k.loadingAgent=n.TILE_AGENT_DONE)}k.loadingAgent===n.TILE_AGENT_DONE&&this.updateRenderData(b);if(f&&x.isOpaque)break}};e._isWithinExtent=function(a){const b=this.extent;return b[0]>=a[0]&&a[2]>=
b[2]&&b[1]>=a[1]&&a[3]>=b[3]};e.intersectsExtent=function(a){const b=this.extent;return b[2]>=a[0]&&a[2]>=b[0]&&b[3]>=a[1]&&a[3]>=b[1]};T._createClass(p,[{key:"usedMemory",get:function(){-1===this._usedMemory&&this._updateMemoryUsed();return this._usedMemory+(this.isCached?0:this.mapTileMemory)}},{key:"cachedMemory",get:function(){return this.isCached?this.mapTileMemory:0}},{key:"mapTileMemory",get:function(){-1===this._usedMemory&&this._updateMemoryUsed();let a=this._mapTileMemory;for(const {data:b}of this.layerInfo[1])b instanceof
L.VectorTile&&(a+=b.memoryUsage);return a}},{key:"isCached",get:function(){return!this.shouldLoad&&0>=this._mapDataRefCount}},{key:"maxTesselation",get:function(){return this._maxTesselation}},{key:"numSubdivisionsAtLevel",get:function(){return this._numSubdivisionAtLevel}},{key:"isWithinClippingArea",get:function(){return this._isWithinClippingArea}},{key:"intersectsClippingArea",get:function(){return this._intersectsClippingArea}},{key:"clippingArea",get:function(){return this._clippingArea}},{key:"parent",
get:function(){return this._parent}},{key:"children",get:function(){return this._children}},{key:"surface",get:function(){return this._surface}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"level",get:function(){return this.lij[0]}},{key:"edgeLen",get:function(){return this._edgeLen}},{key:"radius",get:function(){return this._center[1][3]}},{key:"screenDepth",get:function(){return this._screenDepth}},{key:"visible",get:function(){if(this._dirty){this._dirty=!1;const a=
this._isVisible(this.surface.frustum);a!==this._visible&&(this._visible=a,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender());this.updateAgentSuspension()}return this._visible}},{key:"loadable",get:function(){return this.visible||this._surface.view.state.fixedContentCamera}},{key:"rendered",get:function(){const a=!!this.renderData;a!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=a,this._surface.renderer.setNeedsRender());
return a}},{key:"shouldLoad",get:function(){if(!this.loadable)return!1;if(1===this._surface.lodSnapping){const a=this.level-this._surface.snapLevel;if(0===a)return!0;if(1===a)return!1}return this.isLeaf}},{key:"cpuImageMemorySize",get:function(){const a=this._surface.tilingScheme.pixelSize;return a*a*4}},{key:"updating",get:function(){if(this.hasPendingUpdates)return!0;for(const a of q.LayerClasses){const b=this.layerInfo[a];for(const c of b)if(c.loadingAgent&&c.loadingAgent!==n.TILE_AGENT_DONE&&
c.loadingAgent.updating)return!0}return!1}},{key:"hasPendingUpdates",get:function(){return 0!==this._pendingUpdates}},{key:"isLeaf",get:function(){return null==this._children[0]}},{key:"test",get:function(){return{cachedMemory:this.cachedMemory}}}]);return p}();const I=new K(P),H=new K(O),aa=new N.ElevationBounds;B.SplitLimits=function(){this.angledSplitBias=this.maxLod=this.relativeHeightLimit=this.relativeWidthLimit=this.fovY=this.fovX=0;this.aboveGround=!0};B.default=D;Object.defineProperty(B,
"__esModule",{value:!0})});