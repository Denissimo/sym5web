// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/Evented ../../../../../core/HandleOwner ../../../../../core/Handles ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/Logger ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/Polyline ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../../../../symbols/support/utils ../../Manipulator3D ../../manipulatorUtils ../../SnappingDragPipelineStep ../../SnappingVisualizer3D ../dragEventPipeline3D ../manipulatorUtils ../settings ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ./edgeOffsetUtils ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../../../webgl-engine/lib/GeometryUtil ../../../../interactive/dragEventPipeline ../../../../interactive/editGeometry/EditGeometryHelper ../../../../interactive/snapping/SnappingContext".split(" "),
function(t,N,z,ma,X,Y,Z,A,f,O,E,na,oa,pa,aa,ba,w,P,ca,Q,F,R,J,q,S,T,K,L,h,da,ea,M,fa,ha,x,U,ia,y,u,ja,V){function B(v){return"vertex"===v.handle.type}t.ReshapeOperation=function(v){function G(a){a=v.call(this,a)||this;a._vertexManipulatorMaterial=q.createManipulatorMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.vertex.color),h.settings.reshapeManipulators.vertex.renderOccluded);a._vertexManipulatorOutlineMaterial=q.createManipulatorOutlineMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.vertex.outlineColor),
h.settings.reshapeManipulators.vertex.renderOccluded);a._vertexManipulatorHoverOutlineMaterial=q.createManipulatorOutlineMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.vertex.hoverOutlineColor),h.settings.reshapeManipulators.vertex.renderOccluded);a._edgeManipulatorMaterial=q.createManipulatorMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.edge.color),h.settings.reshapeManipulators.edge.renderOccluded);a._edgeManipulatorOutlineMaterial=q.createManipulatorOutlineMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.edge.outlineColor),
h.settings.reshapeManipulators.edge.renderOccluded);a._edgeOffsetManipulatorMaterial=q.createManipulatorMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.edgeOffset.color),h.settings.reshapeManipulators.edgeOffset.renderOccluded,!1);a._edgeOffsetManipulatorHoverMaterial=q.createManipulatorMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.edgeOffset.hoverColor),h.settings.reshapeManipulators.edgeOffset.renderOccluded,!1);a._selectedManipulatorMaterial=q.createManipulatorMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.selected.color),
h.settings.reshapeManipulators.selected.renderOccluded);a._selectedManipulatorOutlineMaterial=q.createManipulatorOutlineMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.selected.outlineColor),h.settings.reshapeManipulators.selected.renderOccluded);a._selectedManipulatorHoverOutlineMaterial=q.createManipulatorOutlineMaterial(h.settings.colorToVec4(h.settings.reshapeManipulators.selected.hoverOutlineColor),h.settings.reshapeManipulators.selected.renderOccluded);a._selectedIndex=0;a._vertexManipulatorGeometry=
null;a._vertexManipulatorOutlineGeometry=null;a._edgeManipulatorGeometry=null;a._edgeManipulatorOutlineGeometry=null;a._edgeOffsetManipulatorGeometryInside=null;a._edgeOffsetManipulatorGeometryOutside=null;a._manipulatorHandles=new Z;a._manipulatorInfos=[];a._editGeometryHelper=null;a._graphicMoveManipulation=null;a._moveManipulation=null;a._numGrabbing=0;a._numDragging=0;a._reshapeEventState=0;a._outlineVisualElement=null;a.tool=null;a.outputGeometry=null;a._snappingPipeline=new S.SnappingPipeline;
a._snappingPipelineHandle=new S.SnappingPipeline;a._vertexLaserLineVisualElement=null;return a}N._inheritsLoose(G,v);var k=G.prototype;k.initialize=function(){const a=new ia.GraphicState({graphic:this.graphic});this._graphicState=a;this.handles.add([a.watch("displaying",b=>{for(const c of this._manipulatorInfos)c.manipulator.available=b}),this.view.trackGraphicState(a)])};k.destroy=function(){this._clear()};k.removeSelectedVertices=function(){const a=this._manipulatorInfos.filter(b=>b.manipulator.selected&&
"vertex"===b.handle.type);this._removeVertices(a)};k.manipulatorSelectionChanged=function(){this.emit("manipulators-changed")};k._clear=function(){this._removeManipulators();this._resetGrabbingDragging();this._editGeometryHelper=f.destroyMaybe(this._editGeometryHelper)};k._removeManipulators=function(){this._moveManipulation=f.destroyMaybe(this._moveManipulation);this._graphicMoveManipulation=f.destroyMaybe(this._graphicMoveManipulation);this._manipulatorHandles.removeAll();this.manipulators.removeAll();
this._manipulatorInfos=[]};k._resetGrabbingDragging=function(){this._numDragging=this._numGrabbing=0};k._createManipulators=function(){if(!f.isNone(this._editGeometryHelper)){var a=F.getGraphicEffectiveElevationInfo(this.graphic);for(const b of this._editGeometryHelper.editGeometry.components){for(const c of b.vertices)this._createVertexOrEdgeManipulator(c,a);for(const c of b.edges)this._createVertexOrEdgeManipulator(c,a)}this._createGraphicMoveManipulators(a)}};k.redo=function(){if(f.isNone(this._editGeometryHelper))return null;
const a=this._editGeometryHelper.redo();f.isSome(a)&&(this.outputGeometry=this._editGeometryHelper.geometry,this._recreateManipulators());return a};k.undo=function(){if(f.isNone(this._editGeometryHelper))return null;this.emit("undo");const a=this._editGeometryHelper.undo();f.isSome(a)&&(this.outputGeometry=this._editGeometryHelper.geometry,this._recreateManipulators());return a};k._recreateManipulators=function(){this._removeManipulators();this._resetGrabbingDragging();this._createManipulators()};
k._recreateEditGeometryAndManipulators=function(a=this.inputGeometry){this._clear();f.isNone(a)||(f.destroyMaybe(this._editGeometryHelper),this._editGeometryHelper=ja.EditGeometryHelper.fromGeometry(a,this.view.viewingMode),this._createManipulators())};k._perGraphicManipulatorDragAction=function(a,b){if("end"!==b.action){var c=0,d=[],g=this._manipulatorInfos.some(e=>"vertex"===e.handle.type&&e.manipulator.selected);a=1===a&&g;for(const e of this._manipulatorInfos)B(e)&&(e.manipulator.grabbing||a&&
!e.manipulator.selected||d.push(e),c++);0!==d.length&&(this._moveVertices(d,b),d.length===c?(this._updateEventState(1),this.destroyed||this.emit("move",{type:"move",dx:b.screenDeltaX,dy:b.screenDeltaY,mover:this.graphic})):(this._updateEventState(2),this.destroyed||this.emit("reshape",{type:"reshape",mover:this.graphic})))}};k.isMultiVertexSelection=function(){let a=0;for(const b of this._manipulatorInfos)B(b)&&b.manipulator.selected&&a++;return 1<a};k._perVertexManipulatorDragAction=function(a){this._updateEventState(2);
if(!this.destroyed){var {mapDeltaX:b,mapDeltaY:c,mapDeltaZ:d}=a;if(b||c||d){var g=[];for(const e of this._manipulatorInfos)B(e)&&(e.manipulator.selected&&!e.manipulator.grabbing||e===a.info)&&g.push(e);this._moveVertices(g,a,1);this.emit("reshape",{type:"reshape",mover:this.graphic})}}};k._updateEventState=function(a){if(a===this._reshapeEventState)return!1;switch(a){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",
dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;
case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const b=this._reshapeEventState!==a;this._reshapeEventState=a;return b};k._createGraphicMoveManipulators=function(a){this._graphicMoveManipulation=new ha.MoveXYGraphicManipulation({tool:this.tool,view:this.view,graphicState:this._graphicState});if(this.enableMoveGraphic){let c=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((d,
g,e)=>{g.next(m=>this._trackNumDragging(m)).next(m=>{"start"===m.action&&(c=f.unwrap(this._editGeometryHelper).createUndoGroup());return m}).next(m=>{this._perGraphicManipulatorDragAction(0,m);"end"===m.action&&(c=f.removeMaybe(c))});e.next(this._cancelDragOperation(()=>c=f.removeMaybe(c)))}))}else this._graphicMoveManipulation.forEachManipulator(c=>{c.grabbable=!1;c.cursor=null});this._graphicMoveManipulation.forEachManipulator(c=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(c,!1),
c.events.on("immediate-click",d=>{this._manipulatorInfos.some(g=>g.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...d,graphic:this.graphic});d.stopPropagation()})]));this._moveManipulation=new M.MoveManipulation({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&L.canMoveZ(this.graphic),snapToScene:!1,radius:M.MoveManipulation.radiusForSymbol(this.graphic.symbol)});this._moveManipulation.forEachManipulator(c=>{this.handles.add([this._watchAndUpdateGrabState(c,
!1),c.events.on("immediate-click",d=>{this._moveManipulation.zManipulation.hasManipulator(c)||this._manipulatorInfos.some(g=>g.manipulator.selected)||this.emit("immediate-click",{...d,graphic:this.graphic});d.stopPropagation()})])});this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};var b=f.unwrap(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline((c,d,g,e,m)=>{c=g.next(l=>this._trackNumDragging(l)).next(l=>{const p=this._manipulatorInfos.filter(n=>
B(n)&&n.manipulator.selected);return 1===l.manipulatorType&&1===p.length?{...l,info:p[0],snapOrigin:p[0].handle.pos}:{...l,info:null}}).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:l=>!!l.info,cancel:e,snappingManager:this.tool.snappingManager,snappingContext:new V.SnappingContext({geometry:f.unwrap(this._editGeometryHelper),elevationInfo:a,pointer:m,excludeFeature:this.graphic,visualizer:new T.SnappingVisualizer3D}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(u.addMapDelta()).next(l=>
{this._perGraphicManipulatorDragAction(1,l);return l});e.next(this._cancelDragOperation());return c},a,b,this.graphic),O.init(this._graphicState,"displaying",()=>{this._updateMoveManipulationPosition()}),this._graphicState.on("changed",()=>this._updateMoveManipulationPosition()),O.init(this._graphicState,"isDraped",()=>{this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),"align-move-manipulation"):this.handles.remove("align-move-manipulation")})]);
this._updateMoveManipulationPosition();b=da.createVisualElements({view:this.view,graphic:this.graphic,forEachManipulator:c=>{if(!this.destroyed){f.isSome(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(c);for(const d of this._manipulatorInfos)c(d.manipulator,1);this._moveManipulation.forEachManipulator(c)}},onManipulatorsChanged:c=>this.on("manipulators-changed",c)});f.isSome(b)&&(this._outlineVisualElement=b.visualElement instanceof U.OutlineVisualElement?b.visualElement:
null);f.isSome(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()}),this._graphicState.watch("isDraped",()=>this._updateMoveManipulationPosition())]);this._manipulatorHandles.add(b)};k._createEdgeOffsetManipulator=function(a,b=F.getGraphicEffectiveElevationInfo(this.graphic)){const c=h.settings.reshapeManipulators.edgeOffset;var d=c.size/2,g=d+c.collisionPadding;
if(f.isNone(this._edgeOffsetManipulatorGeometryInside)||f.isNone(this._edgeOffsetManipulatorGeometryOutside)){d/=g;const n=d*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=y.createExtrudedTriangle(n,d/2,d/2,c.height,c.offset);this._edgeOffsetManipulatorGeometryOutside=y.createExtrudedTriangle(-n,d/2,d/2,c.height,-c.offset)}const e=new J.Manipulator3D({view:this.view,renderObjects:[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},
{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2}],elevationInfo:"on-the-ground"!==b.mode||R.isVolumetricSymbol(this.graphic.symbol)?{mode:"absolute-height",offset:0}:b,worldOriented:!1,focusMultiplier:1,touchMultiplier:1,
radius:g,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:P.fromValues(0,0,1)},collisionPriority:1}),m=new J.Manipulator3D({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:"default"});m.grabbable=!1;const l={manipulator:e,handle:a,locationUpdateHandle:null,type:"edge",selectedIndex:0,visibilityManipulator:m,elevationInfo:b,visibilityHandle:null},
p=()=>{f.removeMaybe(l.visibilityHandle);if(!e.focused&&!m.focused||(()=>x.screenEdgeLengthSquared(this._getManipulatorInfoFromHandle(l.handle.left).manipulator.renderLocation,this._getManipulatorInfoFromHandle(l.handle.right).manipulator.renderLocation,this.view.state.camera)<c.minSquaredEdgeLength)())e.grabbable=!1,l.visibilityHandle=A.handlesGroup([e.disableDisplay(),{remove:()=>{e.grabbable=!0}}])};this._manipulatorHandles.add([e.events.on("focus-changed",()=>p()),m.events.on("focus-changed",
()=>p()),{remove:()=>{f.removeMaybe(l.visibilityHandle);this.manipulators.remove(l.visibilityManipulator)}}],e);p();this._updateEdgeOffsetManipulator(l);a=this._getManipulatorInfoFromHandle(l.handle.left).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l));g=this._getManipulatorInfoFromHandle(l.handle.right).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l));l.locationUpdateHandle=A.handlesGroup([a,g]);this._manipulatorHandles.add(l.locationUpdateHandle,
e);this._manipulatorHandles.add(this._watchAndUpdateGrabState(e,!0),e);a=u.createManipulatorDragEventPipeline(e,(n,H,ka)=>{this._clearSelection();const {step:la,cleanup:W}=this._initializeEdgeOffset(l,b);H.next(C=>this._trackNumDragging(C)).next(u.dragAtLocation(this.view,n.elevationAlignedLocation)).next(la).next(K.screenToRenderPlaneFromEvent(this.view)).next(K.convertToMapCoordinates(this.view,f.unwrap(this._editGeometryHelper).editGeometry.coordinateHelper.spatialReference)).next(u.addMapDelta()).next(this._applyEdgeOffsetStep(l)).next(C=>
{"end"===C.action&&W()});ka.next(C=>{W();return C}).next(this._cancelDragOperation())});this._manipulatorHandles.add(a,e);this._manipulatorHandles.add([e.events.on("immediate-click",n=>{n.shiftKey||this._clearSelection();n.stopPropagation()}),m.events.on("immediate-click",n=>this.emit("immediate-click",{...n,graphic:this.graphic}))],e);this._manipulatorInfos.push(l);this.manipulators.add(e);this.manipulators.add(m);this.emit("manipulators-changed");return l};k._updateEdgeOffsetManipulator=function(a){this._updateManipulatorPosition(a);
var b=f.unwrap(this._editGeometryHelper).editGeometry.coordinateHelper,c=x.createEdgeOffsetIntersectionPlane(this.view,a.manipulator.elevationAlignedLocation,x.createEdgeOffsetOperation(b,a.handle,f.unwrap(a.manipulator.elevationInfo)));b=this._getManipulatorInfoFromHandle(a.handle.left).manipulator.renderLocation;const d=this._getManipulatorInfoFromHandle(a.handle.right).manipulator.renderLocation;c=f.isSome(c)?x.edgeOffsetRotationMatrix(c,b,d):ba.IDENTITY;a.manipulator.modelTransform=c;a.visibilityManipulator.elevationAlignedLocation=
a.manipulator.elevationAlignedLocation;a.visibilityManipulator.modelTransform=c;b=w.length(w.subtract(I,b,d))/2;a.visibilityManipulator.collisionType={type:"line",paths:[[[-b,0,0],[b,0,0]]]}};k._initializeEdgeOffset=function(a,b){var c=f.unwrap(this._editGeometryHelper);const d=x.createEdgeOffsetOperation(c.editGeometry.coordinateHelper,a.handle,b);b=c.createUndoGroup();const g=x.createEdgeOffsetIntersectionPlane(this.view,a.manipulator.elevationAlignedLocation,d);d.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(a.handle.left.left),
1);d.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(a.handle.right.right),0);const e=()=>new ca({paths:[[a.handle.left.pos,a.handle.right.pos]],spatialReference:f.unwrap(this._editGeometryHelper).editGeometry.coordinateHelper.spatialReference}),m=new U.OutlineVisualElement({view:this.view,isDraped:this._graphicState.isDraped,geometry:e(),elevationInfo:a.elevationInfo,width:h.settings.visualElements.lineGraphics.outline.width,color:h.settings.colorToVec4(h.colors.main),
attached:!0});let l;const p=()=>{this._cleanEdgeOffsetCollapsedEdges(a);l=f.removeMaybe(l)};c=this.on("undo",p);l=A.handlesGroup([A.destroyHandle(m),this._graphicState.watch("isDraped",n=>m.isDraped=n),this._graphicState.on("changed",()=>m.geometry=e()),b,c]);return{step:n=>f.isNone(d)||f.isNone(g)?(p(),null):{...n,operation:d,plane:g},cleanup:p}};k._applyEdgeOffsetStep=function(a){return b=>{if(this.destroyed||f.isNone(b.operation))return b;this._updateEventState(2);const {mapDeltaX:c,mapDeltaY:d,
mapDeltaZ:g}=b;if(c||d||g)this._offsetEdge(a,b),this.emit("reshape",{type:"reshape",mover:this.graphic});return b}};k._cleanEdgeOffsetCollapsedEdges=function(a){var b,c;const d=null==(b=a.handle.left.left)?void 0:b.left;b=a.handle.left;const g=null==(c=a.handle.right.right)?void 0:c.right;a=a.handle.right;c=f.unwrap(this._editGeometryHelper).editGeometry.coordinateHelper;const e=[];d&&1E-6>c.distance(d.pos,b.pos)&&e.push(this._getManipulatorInfoFromHandle(b));(1E-6>c.distance(b.pos,a.pos)||g&&1E-6>
c.distance(g.pos,a.pos))&&e.push(this._getManipulatorInfoFromHandle(a));e.length&&this._removeVertices(e)};k._computeVertexManipulatorSizeAndOutline=function(a){const b=a.size/2,c=b+a.collisionPadding;return{size:b/c,outlineSize:(b+a.outlineSize)/c}};k._createVertexOrEdgeManipulator=function(a,b=F.getGraphicEffectiveElevationInfo(this.graphic)){if("edge"===a.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(a,b);if(!this.enableMidpoints)return null}if(f.isNone(this._vertexManipulatorGeometry)||
f.isNone(this._vertexManipulatorOutlineGeometry)){const {size:g,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(h.settings.reshapeManipulators.vertex);this._vertexManipulatorGeometry=y.createSphereGeometry(g,16,16);this._vertexManipulatorOutlineGeometry=y.createSphereGeometry(e,16,16)}if(f.isNone(this._edgeManipulatorGeometry)||f.isNone(this._edgeManipulatorOutlineGeometry)){const {size:g,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(h.settings.reshapeManipulators.edge);
this._edgeManipulatorGeometry=y.createSphereGeometry(g,16,16);this._edgeManipulatorOutlineGeometry=y.createSphereGeometry(e,16,16)}var c=f.isSome(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:r.Vertex|4},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:r.Vertex|5},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,
stateMask:r.Vertex|6},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}];this.enableMidpoints&&c.push(...[{geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:r.Edge|6},{geometry:this._edgeManipulatorOutlineGeometry,
material:this._vertexManipulatorHoverOutlineMaterial,stateMask:r.Edge|6},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:r.Edge|5},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:r.Edge|5}]);c=new J.Manipulator3D({view:this.view,renderObjects:c,elevationInfo:b,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(c,
a,b);const d="edge"===a.type?{manipulator:c,handle:a,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:c,handle:a,type:"vertex",selectedIndex:0};this._manipulatorInfos.push(d);this.manipulators.add(c);this._updateManipulatorPosition(d);if("edge"===d.type){a=this._getManipulatorInfoFromHandle(d.handle.left).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(d));const g=this._getManipulatorInfoFromHandle(d.handle.right).manipulator.events.on("location-update",
()=>this._updateManipulatorPosition(d));d.locationUpdateHandle=A.handlesGroup([a,g]);this._manipulatorHandles.add(d.locationUpdateHandle,c)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(c,!0),c);a=u.createManipulatorDragEventPipeline(c,(g,e,m,l)=>{let p=null;e.next(n=>this._trackNumDragging(n)).next(n=>{"start"===n.action&&(p=f.unwrap(this._editGeometryHelper).createUndoGroup());if("edge"===d.handle.type){const H=this._splitEdgeManipulator(d);return{...n,info:H,snapOrigin:H.handle.pos}}return{...n,
info:d,snapOrigin:d.handle.pos}}).next(u.dragAtLocation(this.view,g.elevationAlignedLocation)).next(K.screenToMapXYForGraphicAtLocation(this.view,this.graphic,g.elevationAlignedLocation,g.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this.isMultiVertexSelection(),cancel:m,snappingManager:this.tool.snappingManager,snappingContext:new V.SnappingContext({geometry:f.unwrap(this._editGeometryHelper),elevationInfo:b,pointer:l,excludeFeature:this.graphic,
visualizer:new T.SnappingVisualizer3D}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(u.addMapDelta()).next(n=>{this._perVertexManipulatorDragAction(n);"end"===n.action&&(p=f.removeMaybe(p))});m.next(this._cancelDragOperation(()=>p=f.removeMaybe(p)))});this._manipulatorHandles.add(a,c);this._manipulatorHandles.add([c.events.on("immediate-click",g=>this._manipulatorClickCallback(g,d)),c.events.on("select-changed",()=>{d.selectedIndex=++this._selectedIndex;this._updateMoveManipulationPosition()})],
c);this.emit("manipulators-changed");return d};k._trackNumDragging=function(a){switch(a.action){case "start":this._numDragging++;break;case "end":this._numDragging--}return a};k._cancelDragOperation=function(a){return()=>{this._numDragging--;this.undo();this.outputGeometry=f.isSome(this._editGeometryHelper)?this._editGeometryHelper.geometry:null;f.isSome(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping();switch(this._reshapeEventState){case 1:this.emit("move",{type:"move",dx:0,dy:0,
mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}a&&a();this.destroyed||this._updateEventState(0)}};k._setTypeSpecificManipulatorSettings=function(a,b,c){switch(b.type){case "vertex":a.state=r.Vertex;a.selectable=!0;a.cursor="move";a.collisionPriority=2;a.radius=h.settings.reshapeManipulators.vertex.size/2+h.settings.reshapeManipulators.vertex.collisionPadding;a.elevationInfo=c;a.interactive=f.isSome(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;
break;case "edge":a.state=r.Edge,a.selectable=!1,a.cursor="copy",a.collisionPriority=-1,a.radius=h.settings.reshapeManipulators.edge.size/2+h.settings.reshapeManipulators.edge.collisionPadding,a.elevationInfo="on-the-ground"!==c.mode||R.isVolumetricSymbol(this.graphic.symbol)?{mode:"absolute-height",offset:0}:c}};k._watchAndUpdateGrabState=function(a,b){return a.events.on("grab-changed",c=>{if("start"===c.action)b&&this._updateSelection(a),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),
this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing})};k._clearSelection=function(){for(const a of this._manipulatorInfos)a.manipulator.grabbing||(a.manipulator.selected=!1)};k._updateSelection=function(a){a.grabbing&&!a.selected&&a.selectable&&(this._clearSelection(),a.selected=!0,this.emit("manipulators-changed"))};k._removeManipulator=function(a){a&&(this._manipulatorHandles.remove(a.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(a),1),this.manipulators.remove(a.manipulator),
this.emit("manipulators-changed"))};k._getManipulatorInfoFromHandle=function(a){if(a)for(const b of this._manipulatorInfos)if(a===b.handle)return b;return null};k._updateManipulatorPosition=function(a){if(a){var b=f.unwrap(this._editGeometryHelper);if("vertex"===a.handle.type)a.manipulator.location=b.editGeometry.coordinateHelper.toPoint(a.handle.pos,D),a.manipulator.grabbing&&f.isSome(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=
a.manipulator.renderLocation);else if("edge"===a.handle.type){var c=this._getManipulatorInfoFromHandle(a.handle.left).manipulator,d=this._getManipulatorInfoFromHandle(a.handle.right).manipulator;f.isSome(a.manipulator.elevationInfo)&&"on-the-ground"===a.manipulator.elevationInfo.mode?(c=c.location,d=d.location,a.manipulator.location=Q.makeDehydratedPoint(c.x+.5*(d.x-c.x),c.y+.5*(d.y-c.y),c.hasZ&&d.hasZ?0:void 0,b.geometry.spatialReference)):(w.lerp(I,c.renderLocation,d.renderLocation,.5),a.manipulator.renderLocation=
I)}}};k._splitEdgeManipulator=function(a,b=.5){var c=f.unwrap(this._editGeometryHelper);b=f.unwrap(c.splitEdge(a.handle,b).createdVertex);a.locationUpdateHandle.remove();a.locationUpdateHandle=void 0;var d=F.getGraphicEffectiveElevationInfo(this.graphic);let g;this.enableEdgeOffset?(this._removeManipulator(a),g=this._createVertexOrEdgeManipulator(b)):(g=a,g.handle=b,g.type="vertex",this._setTypeSpecificManipulatorSettings(a.manipulator,a.handle,d));b.left&&this._createVertexOrEdgeManipulator(b.left);
b.right&&this._createVertexOrEdgeManipulator(b.right);this.outputGeometry=c.geometry;this._updateManipulatorPosition(g);this._updateSelection(a.manipulator);a=this._updateEventState(2);d=c.editGeometry.coordinateHelper.toArray(g.handle.pos);c=c.editGeometry.components.indexOf(b.component);this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:d,componentIndex:c,vertexIndex:f.unwrap(b.index)}],added:d});a&&this._updateEventState(0);return g};k._updateMoveManipulationPosition=function(){const a=
w.set(I,0,0,0);let b=0,c=!1;var d=null;let g=null;for(var e of this._manipulatorInfos)if(B(e))if(e.manipulator.selected)if(b++,w.add(a,a,e.manipulator.renderLocation),f.isNone(d)||e.selectedIndex>d.selectedIndex)g=d,d=e;else{if(f.isNone(g)||e.selectedIndex>g.selectedIndex)g=e}else c=!0;0!==b?(e=this._graphicState.displaying,this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZVertex&&L.canMoveZ(this.graphic),
this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==b):(e=this._graphicState.displaying&&this.enableMoveGraphic,this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZShape&&L.canMoveZ(this.graphic));if(0!==b){e=0;if(f.isSome(d)){const m=d.handle.pos,l=f.isSome(g)?g.handle.pos:d.handle.left&&d.handle.left.left?
d.handle.left.left.pos:null;d=!f.isSome(g)&&d.handle.right&&d.handle.right.right?d.handle.right.right.pos:null;l&&d?this._moveManipulation.xyAxisManipulation.available=!1:l?e=Math.atan2(m[1]-l[1],m[0]-l[0])+Math.PI/2:d&&(e=Math.atan2(d[1]-m[1],d[0]-m[0])+Math.PI/2)}this._moveManipulation.angle=e;this._moveManipulation.radius=ea.DISC_RADIUS_SMALL}else this._moveManipulation.angleDeferred=()=>fa.shapeOrientation(f.unwrap(this.graphic.geometry)),this._moveManipulation.radius=M.MoveManipulation.radiusForSymbol(this.graphic.symbol);
0!==b&&c?(w.scale(a,a,1/b),D.spatialReference=f.unwrap(this._editGeometryHelper).geometry.spatialReference,D.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(a,D),this._moveManipulation.elevationAlignedLocation=D):f.isSome(this._outlineVisualElement)&&!this._graphicState.isDraped&&f.isSome(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:q.placeAtGraphic(this.view,this._moveManipulation,this.graphic)};k._removeVertices=
function(a){var b=[];const c=f.unwrap(this._editGeometryHelper);for(var d of a)"vertex"===d.handle.type&&c.canRemoveVertex()&&(b.push(d.handle),this._removeManipulator(d),this._removeManipulator(this._getManipulatorInfoFromHandle(d.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(d.handle.right)),(a=f.unwrap(c.removeVertices([d.handle]).removedVertices[0].createdEdge))&&this._createVertexOrEdgeManipulator(a));if(0<b.length&&(b=b.map(g=>{const e=c.editGeometry.components.indexOf(g.component);
return{coordinates:c.editGeometry.coordinateHelper.toArray(g.pos),componentIndex:e,vertexIndex:f.unwrap(g.index)}}),this.outputGeometry=c.geometry,d=this._updateEventState(2),!this.destroyed&&(this.emit("vertex-remove",{type:"vertex-remove",removed:b.map(g=>g.coordinates),vertices:b}),!this.destroyed))){if(d&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}};k._moveVertices=function(a,b,c="start"===b.action?0:1){const d=f.unwrap(this._editGeometryHelper);d.moveVertices(a.map(g=>
g.handle),b.mapDeltaX,b.mapDeltaY,b.mapDeltaZ,c);this.outputGeometry=d.geometry;for(const g of a)this._updateManipulatorPosition(g)};k._offsetEdge=function(a,b){if(!f.isNone(b.operation)){var c=f.unwrap(this._editGeometryHelper),d=b.operation.clone();d.distance=b.operation.signedDistanceToPoint(b.mapEnd);c.updateVertices([a.handle.left,a.handle.right],d);this.outputGeometry=c.geometry;this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(a.handle.left));this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(a.handle.right))}};
k._manipulatorClickCallback=function(a,b){a.shiftKey||this._clearSelection();"vertex"===b.handle.type&&(b.manipulator.selected=!b.manipulator.selected);"vertex"===b.handle.type&&2===a.button&&this._removeVertices([b]);"edge"===b.handle.type&&0===a.button&&this._splitEdgeManipulator(b);a.stopPropagation()};N._createClass(G,[{key:"inputGeometry",get:function(){return f.isSome(this._editGeometryHelper)?this._editGeometryHelper.geometry:null},set:function(a){this._recreateEditGeometryAndManipulators(a)}},
{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"manipulators",get:function(){return this.tool.manipulators}},{key:"view",get:function(){return this.tool.view}},{key:"graphic",get:function(){return this.tool.graphic}},{key:"enableZShape",get:function(){return this.tool.enableZShape}},{key:"enableZVertex",get:function(){return this.tool.enableZVertex}},{key:"enableMoveGraphic",get:function(){return this.tool.enableMoveGraphic}},{key:"enableMidpoints",get:function(){return this.tool.enableMidpoints}},
{key:"enableEdgeOffset",get:function(){return this.tool.enableEdgeOffset}},{key:"canRedo",get:function(){return f.isSome(this._editGeometryHelper)&&this._editGeometryHelper.canRedo}},{key:"canUndo",get:function(){return f.isSome(this._editGeometryHelper)&&this._editGeometryHelper.canUndo}}]);return G}(X.EventedMixin(Y.HandleOwner));z.__decorate([E.property({constructOnly:!0})],t.ReshapeOperation.prototype,"tool",void 0);z.__decorate([E.property()],t.ReshapeOperation.prototype,"inputGeometry",null);
z.__decorate([E.property()],t.ReshapeOperation.prototype,"outputGeometry",void 0);z.__decorate([E.property({readOnly:!0})],t.ReshapeOperation.prototype,"updating",null);t.ReshapeOperation=z.__decorate([aa.subclass("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],t.ReshapeOperation);const D=Q.makeDehydratedPoint(0,0,null,null),I=P.create();var r;(function(v){v.Vertex=16;v.Edge=32})(r||(r={}));Object.defineProperty(t,"__esModule",{value:!0})});