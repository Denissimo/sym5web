// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../camera/constraintUtils ../camera/intersectionUtils ./NearFarHeuristic ./SurfaceCollisionConstraint".split(" "),
function(d,n,e,p,q,g,r,t,h,z,A,B,C,u,v,w,x,y){d.ConstraintsManager=function(k){function f(a){var b=k.call(this,a)||this;b._handles=new q;b.nearFarHeuristic=x.createNearFarHeuristic(a.view.state.viewingMode,a.view.basemapTerrain,a.view.renderCoordsHelper.spatialReference);return b}n._inheritsLoose(f,k);var c=f.prototype;c.initialize=function(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],()=>this._clipDistanceNearFarChanged()),this.view.watch("constraints.clipDistance.mode",
()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",a=>this._updateCameraNearFar(a.camera)),this.view.watch("dataExtent",()=>this._updateNearFar(),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],()=>this._updateAltitude(),!0),this.view.watch("constraints.tilt.max",()=>this._updateTiltMax(),!0),this.view.watch("constraints.tilt.mode",()=>this._updateTilt(),!0),this.view.watch("state.camera",()=>this._updateTiltAutoMax(),!0),this.view.watch(["map.ground.navigationConstraint.type",
"constraints.collision.enabled"],()=>this._updateCollision(),!0)]);this.view.state.isLocal&&this._handles.add(t.init(this.view,"dataExtent",a=>this._updateLocalSurfaceDistance(a)));this._updateNearFar();2!==this.view.state.viewingMode&&this._updateAltitude();this._updateTilt();this._updateCollision();this._set("surfaceCollisionConstraint",new y["default"]({view:this.view}))};c.destroy=function(){this._handles=r.destroyMaybe(this._handles);this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),
this._set("surfaceCollisionConstraint",null))};c._clipDistanceNearFarChanged=function(){const a=this.view.constraints&&this.view.constraints.clipDistance;a&&"auto"!==a.mode&&this.view.state.updateCamera(b=>{this._updateCameraNearFarManual(b,a);return!0})};c._updateNearFar=function(){this.view.state.updateCamera(a=>{this._updateCameraNearFar(a);return!0})};c._updateCameraNearFar=function(a){const b=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(b?b.mode:"auto")?this._updateCameraNearFarManual(a,
b):this._updateCameraNearFarAuto(a,b)};c._updateCameraNearFarAuto=function(a,b){this.nearFarHeuristic.compute(a.eye,a.center,this.view.dataExtent,w.surfaceElevationBelowRenderLocation(this.view,a.eye),a);b&&b.autoUpdate(a.near,a.far)};c._updateCameraNearFarManual=function(a,b){b&&(a.near=b.near,a.far=b.far)};c._updateCollision=function(){var a,b,l;const m=null==(a=this.view.map)?void 0:null==(b=a.ground)?void 0:null==(l=b.navigationConstraint)?void 0:l.type;a=m?"stay-above"===m:!0;b=this.view.state.constraints.collision;
a!==b.enabled&&((b.enabled=a)&&this._reapplyConstraints(8),(a=this.view.constraints&&this.view.constraints.tilt)&&"auto"!==a.mode||this._updateTiltAuto())};c._updateAltitude=function(){const a=this.view.constraints&&this.view.constraints.altitude;this.view.state.constraints.altitude=a&&2!==this.view.state.viewingMode?{min:a.min,max:a.max}:null;this._reapplyConstraints()};c._updateTiltMax=function(){const a=this.view.constraints&&this.view.constraints.tilt;a&&"auto"!==a.mode&&(this._updateTiltManual(a),
this._reapplyConstraints())};c._updateTilt=function(){const a=this.view.constraints&&this.view.constraints.tilt;"manual"===(a?a.mode:"auto")?this._updateTiltManual(a):this._updateTiltAuto();this._reapplyConstraints()};c._updateTiltManual=function(a){const b=this.view.state.constraints;b.tilt=b.createConstantMaxTilt(g.deg2rad(a.max))};c._updateTiltAuto=function(){const a=this.view.state.constraints;a.tilt=a.createDefaultTilt();this._updateTiltAutoMax()};c._updateTiltAutoMax=function(){const a=this.view.constraints&&
this.view.constraints.tilt;if(a&&"auto"===a.mode){var b=this.view.state.constraints;b.tilt&&(b=b.tilt(this.view.state.camera.distance).max,a.autoUpdate(g.rad2deg(b)))}};c._updateLocalSurfaceDistance=function(a){var b=Math.max(a.width,a.height);0>=b||(a.hasZ&&(b=Math.max(b,a.zmax-a.zmin)),a=this.view.state,b=3*b/Math.atan(a.camera.fov/2),b!==a.constraints.distance&&(a.constraints.distance=b))};c._reapplyConstraints=function(a=15){this.view.state.updateCamera(b=>v.applyAll(this.view,b,{selection:a,
interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0}))};return f}(p);e.__decorate([h.property({constructOnly:!0})],d.ConstraintsManager.prototype,"view",void 0);e.__decorate([h.property({readOnly:!0})],d.ConstraintsManager.prototype,"surfaceCollisionConstraint",void 0);d.ConstraintsManager=e.__decorate([u.subclass("esri.views.3d.state.ConstraintsManager")],d.ConstraintsManager);d.default=d.ConstraintsManager;Object.defineProperty(d,"__esModule",
{value:!0})});