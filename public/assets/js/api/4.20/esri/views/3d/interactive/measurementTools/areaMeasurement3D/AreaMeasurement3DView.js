// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../chunks/vec3f64 ../../manipulatorUtils ../../editingTools/dragEventPipeline3D ../support/viewUtils ../../visualElements/LaserlineVisualElement ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Intersector ../../../../interactive/ManipulatorCollection".split(" "),function(m,q,d,r,n,p,t,l,u,v,w,x){const y={laserLineGlowColor:[1,.5,
0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:1,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,handleRadiusHovered:10,handleRadiusMouse:10,handleRadiusTouch:25,pathLineColor:[1,.5,0,1],pathLineWidth:3,intersectingLineColor:[1,.2,0,1],perimeterLineColor:[1,.5,0,1],perimeterLineWidth:2,projectionLineColor:[1,.5,0,1],projectionLineWidth:2,projectionLineStippleSize:5,areaColor1:[1,.5,0,.5],areaColor2:[1,
1,1,.5],fillColor:[1,.5,0,.5],lineSubdivisions:64,labelDistance:25};let k=function(){function e(a){var c,f,g,h;this.vertexManipulators=[];this._analysisView=this._layerView=null;this._state="pending";this._mode="auto";this._lastDraggedVertex=this._cursorPoint=null;this._visible=!1;this._listenerHandles=this._cursorManipulator=this._laserLine=null;this._tempHandlePosition=n.create();this._model=a.model;this._unit=null!=(c=a.unit)?c:"metric";this._manipulators=null!=(f=a.manipulators)?f:new x.ManipulatorCollection;
this._view=this._model.sceneView;this._mode=null!=(g=a.mode)?g:"auto";this._cursorPoint=null!=(h=a.cursorPoint)?h:null;this._style=l.copyParameter(y,a.style);this._intersector=new w.Intersector(this._view.state.viewingMode);this._intersector.options.store=0;this._creationPromise=this._view.whenLayerView(this._model.analysis).then(z=>this._initialize(z))}var b=e.prototype;b._initialize=function(a){switch(this._state){case "destroyed":return}this._layerView=a;this._analysisView=a.analysisView;this._layerViewData=
a.layerViewData;a=p.createSphereManipulator(this._view,this._style.handleColor,this._style.handleOpacity);a.available=!1;a.radius=this._style.handleRadius;a.interactive=!1;this._manipulators.add(a);this._cursorManipulator=a;this._laserLine=new u.LaserlineVisualElement({view:this._view,attached:!0,style:{glowColor:this._style.laserLineGlowColor,glowWidth:this._style.laserLineGlowWidth,glowFalloff:this._style.laserLineGlowFalloff,innerColor:this._style.laserLineInnerColor,innerWidth:this._style.laserLineInnerWidth,
globalAlpha:this._style.laserLineGlobalAlpha}});this._analysisView.mode=this._mode;this._layerView.unit=this._unit;this._layerViewData.cursorPoint=this._cursorPoint;this._visible&&this._updateVisibility(this._visible);this._state="ready"};b.destroy=function(){switch(this._state){case "pending":this._state="destroyed";return;case "ready":break;default:return}this.hide();this._laserLine.destroy();this._laserLine=null;this._state="destroyed"};b.when=function(){return this._creationPromise};b.whenMessages=
function(){var a=m._asyncToGenerator(function*(){return this._creationPromise.then(()=>this.analysisView.whenMessages())});return function(){return a.apply(this,arguments)}}();b.show=function(){this._setVisiblity(!0)};b.hide=function(){this._setVisiblity(!1)};b._setVisiblity=function(a){switch(this._state){case "ready":this._visible!==a&&this._updateVisibility(a);break;case "pending":this._visible=a}};b._updateVisibility=function(a){a?(this._visible=!0,this._model.analysis.visible=!0,this._laserLine.visible=
!0,this._initializeListeners(),this._updateAll(this._analysisView.viewData)):(this._visible=!1,this._model.analysis.visible=!1,this._laserLine.visible=!1,this._destroyListeners(),this.vertexManipulators.forEach(c=>{this._removeVertexManipulator(c.manipulator)}),this.vertexManipulators=[],this._view.cursor=null)};b.vertexHandleAt=function(a,c){a=this._manipulators.intersect(a,c);return d.isSome(a)?a.manipulator.metadata:null};b.manipulatorToVertex=function(a){return a.metadata};b.pick=function(a){var c=
this._view.spatialReference;a=r.screenPointObjectToArray(a.screenPoint);this._view.sceneIntersectionHelper.intersectToolIntersectorScreen(a,this._intersector);a=this._intersector.results.min;const f=n.create();if(!a.getIntersectionPoint(f))return new e.PickResult;c=this._view.renderCoordsHelper.fromRenderCoords(f,c);return d.isNone(c)?new e.PickResult:new e.PickResult("TerrainRenderer"===a.intersector?"surface":"feature",f,c)};b.overlappingHandles=function(a,c){return l.pointToPointScreenDistance(a,
c,this._view)<=this._style.handleRadius};b.screenToMap3D=function(){return t.screenToMap3D(this._view)};b.finishMeasurement=function(){switch(this._state){case "ready":{const a=this._layerViewData.path;3>a.numVertices?(a.clear(),this.cursorPoint=null,this._model.state="initial"):(a.close(),this.cursorPoint=null,this._model.state="measured")}}};b._updateAll=function(a){this._visible&&(this._updateVertexManipulators(a),this._updateLaserLine())};b._createVertexManipulator=function(){const a=p.createSphereManipulator(this._view,
this._style.handleColor,this._style.handleOpacity);a.radius=this._style.handleRadius;return{id:this._manipulators.add(a),manipulator:a}};b._removeVertexManipulator=function(a){this._manipulators.remove(a)};b._updateVertexManipulators=function(a){const c=this._layerViewData.path.vertices,f=this.vertexManipulators;l.resizeArray(f,c.length,()=>this._createVertexManipulator(),g=>this._removeVertexManipulator(g.manipulator));f.forEach((g,h)=>{g.manipulator.metadata=c[h];g.manipulator.renderLocation=a.positionsRenderCoords[h]});
"drawing"===this._model.state&&d.isSome(this.cursorPoint)?(this._cursorManipulator.available=!0,this._cursorManipulator.location=this.cursorPoint):this._cursorManipulator.available=!1};b._getFocusPoint=function(){const a=this.lastDraggedVertex;switch(this._model.state){case "drawing":return d.isSome(this.cursorPoint)?this.cursorPoint:d.isSome(a)?this._layerViewData.path.getVertexPositionAsPoint(a):d.unwrap(this._layerViewData.path.lastPoint);case "editing":return d.isSome(a)?this._layerViewData.path.getVertexPositionAsPoint(a):
null;default:return this.cursorPoint}};b._updateLaserLine=function(){var a=this._model,c=this._style.laserLineEnabled&&"measured"!==a.state&&a.active;a=this._getFocusPoint();c&&d.isSome(a)?(c=this._tempHandlePosition,this._view.renderCoordsHelper.toRenderCoords(a,c),this._laserLine.heightManifoldTarget=c):this._laserLine.heightManifoldTarget=null};b._initializeListeners=function(){this._listenerHandles=new q;this._listenerHandles.add([this._model.watch("state",()=>this._updateLaserLine()),this._analysisView.watch("viewData",
()=>this._updateAll(this._analysisView.viewData),!0),this._layerViewData.watch(["lastDraggedVertex","cursorPoint"],()=>this._updateLaserLine()),this._model.watch(["active"],()=>this._updateAll(this._analysisView.viewData))])};b._destroyListeners=function(){this._listenerHandles.destroy();this._listenerHandles=null};m._createClass(e,[{key:"state",get:function(){return this._state}},{key:"analysisView",get:function(){return this._analysisView}},{key:"layerView",get:function(){return this._layerView}},
{key:"validMeasurement",get:function(){return"ready"!==this.state?!1:this._layerViewData.validMeasurement}},{key:"path",get:function(){return"ready"!==this.state?null:this._layerViewData.path}},{key:"unit",set:function(a){this._unit=a;"ready"===this.state&&(this.layerView.unit=a)}},{key:"requiresCursorPoint",get:function(){return("initial"===this._model.state||"drawing"===this._model.state)&&this._model.active}},{key:"visible",get:function(){return this._visible},set:function(a){a?this.show():this.hide()}},
{key:"mode",get:function(){return this._mode},set:function(a){switch(this._state){case "pending":this._mode=a;break;case "ready":this._mode=a,this._analysisView.mode=a}}},{key:"cursorPoint",get:function(){return this._cursorPoint},set:function(a){switch(this._state){case "pending":this._cursorPoint=a;break;case "ready":this._cursorPoint=a,this._layerViewData.cursorPoint=a}}},{key:"lastDraggedVertex",get:function(){return this._lastDraggedVertex},set:function(a){switch(this._state){case "pending":this._lastDraggedVertex=
a;break;case "ready":this._lastDraggedVertex=a,this._layerViewData.lastDraggedVertex=a}}},{key:"testData",get:function(){const a=this._laserLine.testData;return{labels:this._analysisView.testData.labels,laserLineRenderer:d.isSome(a)?{heightManifoldEnabled:a.heightManifoldEnabled,heightManifoldTarget:a.heightManifoldTarget,pointDistanceEnabled:a.pointDistanceEnabled,pointDistanceOrigin:a.pointDistanceOrigin,pointDistanceTarget:a.pointDistanceTarget,lineVerticalPlaneEnabled:a.lineVerticalPlaneEnabled}:
{heightManifoldEnabled:!1,heightManifoldTarget:null,pointDistanceEnabled:!1,pointDistanceOrigin:null,pointDistanceTarget:null,lineVerticalPlaneEnabled:!1}}}}]);return e}();k._handleGeometry=v.createSphereGeometry(1,32,32);(function(e){e.PickRequest=function(){};e.PickResult=function(b=null,a=null,c=null){this.type=b;this.scenePoint=a;this.mapPoint=c}})(k||(k={}));return k});