// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/maybe ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ./elevationAlignmentUtils ./graphicUtils ../../support/debugFlags ../../support/ElevationProvider".split(" "),function(A,K,L,F,G,B,D,C,M,w,N){const O=F.create(),f=B.create(),k=B.create(),t=B.create(),l=F.create(),H=B.create(),p={verticalDistanceToGround:0,sampledElevation:0};A.perLodInstanceElevationAligner=function(e,b,g,d){const m=
e.graphics3DSymbolLayer.lodRenderer;if(K.isNone(m))return 0;const h=b.centerPointInElevationSR;let n=0,r=0;const x="absolute-height"!==b.mode;n=C.evaluateElevationAlignmentAtPoint(h,g,b,d,x?p:null);x&&(r=p.sampledElevation);b=m.instanceData;e=e.instanceIndex;b.getGlobalTransform(e,l);g=G.set(H,l[12],l[13],l[14]);w.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(f[0]=h.x,f[1]=h.y,f[2]=n,D.computeLinearTransformation(h.spatialReference,f,l,d.spatialReference)&&b.setGlobalTransform(e,l)):d.setAltitudeOfTransformation(n,
l);d=.01/d.unitInMeters;(w.TESTS_DISABLE_UPDATE_THRESHOLDS||Math.abs(l[12]-g[0])>=d||Math.abs(l[13]-g[1])>=d||Math.abs(l[14]-g[2])>=d)&&b.setGlobalTransform(e,l);return r};A.perObjectElevationAligner=function(e,b,g,d){e=e.stageObject;const m=b.centerPointInElevationSR;let h=0,n=0;if(e.metadata.usesVerticalDistanceToGround)h=C.evaluateElevationAlignmentAtPoint(m,g,b,d,p),M.updateVertexAttributeAuxpos1w(e,p.verticalDistanceToGround),n=p.sampledElevation;else{const r="absolute-height"!==b.mode;h=C.evaluateElevationAlignmentAtPoint(m,
g,b,d,r?p:null);r&&(n=p.sampledElevation)}b=L.copy(O,e.transformation);g=G.set(H,b[12],b[13],b[14]);w.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(f[0]=m.x,f[1]=m.y,f[2]=h,D.computeLinearTransformation(m.spatialReference,f,b,d.spatialReference)&&(e.transformation=b)):d.setAltitudeOfTransformation(h,b);d=.01/d.unitInMeters;if(Math.abs(b[12]-g[0])>=d||Math.abs(b[13]-g[1])>=d||Math.abs(b[14]-g[2])>=d)e.transformation=b;return n};A.perVertexElevationAligner=function(e,b,g,d){e=e.stageObject;const m=
g.spatialReference,h=e.geometryRecords,n=h.length,r="absolute-height"!==b.mode;let x=0;for(let y=0;y<n;y++){var u=h[y].geometry,a=h[y].getShaderTransformation();k[0]=a[12];k[1]=a[13];k[2]=a[14];u.invalidateBoundingInfo();var z=u.getMutableAttribute("position");a=z.data;var q=u.vertexAttributes.get("mapPos").data;u=z.size;z=a.length/u;q=new N.SamplePosition(q,m);let c=0,E=!1,I=0;for(let J=0;J<z;J++){t[0]=a[c];t[1]=a[c+1];t[2]=a[c+2];var v=C.evaluateElevationAlignmentAtPoint(q,g,b,d,r?p:null);r&&(I+=
p.sampledElevation);w.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(a[c]=q.array[q.offset],a[c+1]=q.array[q.offset+1],a[c+2]=v,D.projectBuffer(a,m,c,a,d.spatialReference,c,1),a[c]-=k[0],a[c+1]-=k[1],a[c+2]-=k[2]):(f[0]=a[c]+k[0],f[1]=a[c+1]+k[1],f[2]=a[c+2]+k[2],d.setAltitude(f,v),a[c]=f[0]-k[0],a[c+1]=f[1]-k[1],a[c+2]=f[2]-k[2]);if(w.TESTS_DISABLE_UPDATE_THRESHOLDS)E=!0;else if(v=.01/d.unitInMeters,Math.abs(t[0]-a[c])>=v||Math.abs(t[1]-a[c+1])>=v||Math.abs(t[2]-a[c+2])>=v)E=!0;c+=u;q.offset+=3}x+=
I/z;E&&e.geometryVertexAttrsUpdated(y)}return x/n};Object.defineProperty(A,"__esModule",{value:!0})});