// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/lang","../../../../core/maybe","../support/attributeUtils"],function(x,B,y,z){function C(a,d){const b=d.edits.updateFeatures;if(!b||0===b.length)return new A;const k=D(d),g=new A;d=new Map;for(let c=0;c<a.attributeStorageInfo.length;c++)d.set(a.attributeStorageInfo[c].name,c);const q=a.fieldsIndex,l=a.objectIdField,t=b.filter(c=>{c=z.attributeLookup(q,c.attributes,l);return k.has(c)});a.forEachNode((c,e)=>{const u=new Set(e);for(const m of t){const n=z.attributeLookup(q,
m.attributes,l);if(!u.has(n))continue;const v=e.indexOf(n);for(const w in m.attributes){var p=a.fieldsIndex.normalizeFieldName(w);var f=g;var h=c.index,r=f.get(h);r?f=r:(r=new E,f.set(h,r),f=r);(h=f.get(p))?p=h:(h=[],f.set(p,h),p=h);p.push({featureIndex:v,featureId:n,value:m.attributes[w]})}}});return g}function D(a){const d=new Set;if(!a.updatedFeatures)return d;for(const b of a.updatedFeatures)null!=b.objectId&&null==b.error&&d.add(b.objectId);return d}const F={setAttribute(){},rollback(){},commit(){}},
E=Map,A=Map;x.createInteractiveEditSession=function(a,d){const b=d.attributes[a.objectIdField];var k=a.sessions.get(b);if(k)return k;const g=B.clone(d.attributes),q=new Set;if(null==b)return F;const l=a.attributeOverrides.createInteractiveEditSession(b),t=new Map;let c=0;k={setAttribute(e,u){if(0===c){var p=a.fieldsIndex.get(e);if(!y.isNone(p)){var f=a.attributeStorageInfo.findIndex(m=>m.name===p.name);if(!(0>f)){l.set(f,u);var h=a.attributeStorageInfo[f],r=!1;q.add(e);a.forEachNode((m,n)=>{var v=
t.get(m);null==v?(n=n.indexOf(b),t.set(m,n)):n=v;if(-1!==n&&(v=a.getAttributeData(m.index))){const w=v[h.name];w&&(w[n]=u,a.setAttributeData(m.index,v,d),r=!0)}});r&&a.clearMemCache()}}}},rollback(){if(0===c){for(const e of q)this.setAttribute(e,g[e]);l.rollback();c=1;a.sessions.delete(b)}},commit(){0===c&&(l.commit(),c=2,a.sessions.delete(b))}};a.sessions.set(b,k);return k};x.processAttributeEdits=function(a,d){d=C(a,d);if(0!==d.size){var b=new Map;for(let g=0;g<a.attributeStorageInfo.length;g++)b.set(a.attributeStorageInfo[g].name,
g);var k=!1;d.forEach((g,q)=>{const l=a.getAttributeData(q);let t=!1;g.forEach((c,e)=>{const u=y.isSome(l)?l[e]:null;e=b.get(e);for(const {featureIndex:p,value:f,featureId:h}of c)u&&(u[p]=f,k=t=!0),a.attributeOverrides.updateValue(h,e,f)});t&&a.setAttributeData(q,l,null)});k&&a.clearMemCache()}};Object.defineProperty(x,"__esModule",{value:!0})});