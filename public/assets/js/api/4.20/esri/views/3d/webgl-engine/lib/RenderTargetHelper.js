// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["exports","../../../webgl/FramebufferObject","../../../webgl/Renderbuffer","../../../webgl/Texture","../../../webgl/Util"],function(k,h,n,l,p){const q={dataType:5121,internalFormat:6408},r={};let t=function(){function m(a){this.rctx=a;this._activeTargets=new Set;this._depthTextures=new Map;this._depthBuffers=new Map;this._colorTextures=new Map;this._framebuffers=new Map;this._nextId=1;this.depthTextureSupported=a.capabilities.depthTexture}var e=m.prototype;e.dispose=function(){this._depthBuffers.forEach(a=>
a.dispose());this._depthBuffers.clear();this._depthTextures.forEach(a=>a.dispose());this._depthTextures.clear();this._colorTextures.forEach(a=>a.dispose());this._colorTextures.clear();this._framebuffers.forEach(a=>a.dispose());this._framebuffers.clear()};e.disposeTargetResource=function(a){a=a.id;this._activeTargets.has(a)&&(this._activeTargets.delete(a),this.disposeWithFramebuffers(this._depthTextures,a),this.disposeWithFramebuffers(this._depthBuffers,a),this.disposeWithFramebuffers(this._colorTextures,
a))};e.disposeWithFramebuffers=function(a,c){const b=a.get(c);b&&(this._framebuffers.forEach((f,d)=>{if(f.colorAttachment===b||f.depthStencilAttachment===b)f.detachAll(),f.dispose(),this._framebuffers.delete(d)}),b.dispose(),a.delete(c))};e.getDepthTexture=function(a,c){if(this.depthTextureSupported){var b=this._depthTextures.get(a.id);!b||b.descriptor.width===c.width&&b.descriptor.height===c.height||(b.dispose(),b=void 0);b||(b=new l(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,
wrapMode:33071,width:c.width,height:c.height}),this._depthTextures.set(a.id,b),this._activeTargets.add(a.id));return b}};e.getAllocatedDepthTexture=function(a){return this._depthTextures.get(a.id)};e.getDepthBuffer=function(a,c){if(!this.depthTextureSupported){var b=this._depthBuffers.get(a.id);b?b.descriptor.width===c.width&&b.descriptor.height===c.height||b.resize(c.width,c.height):(b=new n(this.rctx,{internalFormat:34041,...c}),this._depthBuffers.set(a.id,b),this._activeTargets.add(a.id));return b}};
e.getColorTexture=function(a,c){let b=this._colorTextures.get(a.id);!b||b.descriptor.width===c.width&&b.descriptor.height===c.height||(b.dispose(),b=void 0);b||(b=new l(this.rctx,{target:3553,pixelFormat:6408,internalFormat:a.internalFormat,dataType:a.dataType,samplingMode:null!=a.samplingMode?a.samplingMode:9729,wrapMode:33071,width:c.width,height:c.height}),this._colorTextures.set(a.id,b),this._activeTargets.add(a.id));return b};e.getAllocatedColorTexture=function(a){return this._colorTextures.get(a.id)};
e.registerDepthTarget=function(a={}){return{id:this._nextId++,...r,...a}};e.registerColorTarget=function(a={}){return{id:this._nextId++,...q,...a}};e.getFramebuffer=function(a,c,b){const f=this.getKey(c,b);let d=this._framebuffers.get(f);c=this.getColorTexture(c,a);if(this.depthTextureSupported){var g=b?this.getDepthTexture(b,a):void 0;if(!d)return d=b?new h(this.rctx,{colorTarget:0,depthStencilTarget:4},c,g):new h(this.rctx,{colorTarget:0,depthStencilTarget:0},c),this._framebuffers.set(f,d),d;if(d.width!==
a.width||d.height!==a.height||d.colorTexture!==c||d.depthStencilTexture!==g)d.detachAll(),d.resize(a.width,a.height),d.attachColorTexture(c),d.attachDepthStencilTexture(g);return d}g=b?this.getDepthBuffer(b,a):void 0;if(!d)return d=new h(this.rctx,{colorTarget:0,depthStencilTarget:b?3:0},c,g),this._framebuffers.set(f,d),d;if(d.width!==a.width||d.height!==a.height||d.colorTexture!==c)d.detachAll(),d.resize(a.width,a.height),d.attachColorTexture(c),d.attachDepthStencilBuffer(g);return d};e.getKey=function(a,
c){return`${a.id}_${c?c.id:"X"}_${a.name}${c?"_"+c.name:""}`};e.getGpuMemoryUsage=function(){let a=0;const c=new Set,b=f=>{c.has(f)||(c.add(f),a+=p.getGpuMemoryUsage(f))};this._depthTextures.forEach(b);this._colorTextures.forEach(b);this._depthBuffers.forEach(b);return a};return m}();k.RenderTargetHelper=t;Object.defineProperty(k,"__esModule",{value:!0})});