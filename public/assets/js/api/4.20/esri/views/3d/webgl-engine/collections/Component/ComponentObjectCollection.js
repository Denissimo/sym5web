// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/maybe ../../../../../chunks/mat3 ../../../../../chunks/mat3f32 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4 ../../../../../chunks/vec4f32 ../../../layers/support/symbolColorUtils ../../../support/orientedBoundingBox ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ./ComponentData ./ComponentObject ./interface ./IntersectionGeometry ./Renderable ./RenderGeometry ./RenderSubmitSystem ./SourceGeometry ./Material/ComponentMaterial ./Material/ComponentTechnique ../../core/util/BucketedObjectStore ../../core/util/TwoVectorPosition ../../lib/ComponentUtils ../../lib/Util ../../lib/TextureBackedBuffer/BufferManager ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject".split(" "),
function(D,K,A,n,u,E,q,F,L,M,N,O,G,P,Q,R,r,S,T,U,V,W,x,X,Y,Z,H,aa,ba,B,ca){const I=A.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");A=function(){function C(a){this._renderManager=a;this._objects=new Y.BucketedObjectStore;this._renderSubmit=new V.RenderSubmitSystem(this);this._renderManager.register(this._renderSubmit);this._componentBufferManager=new ba.BufferManager(a.rctx)}var f=C.prototype;f.dispose=function(){aa.assert(0===this._objects.count,"ObjectCollection should be empty upon disposal");
this._componentBufferManager.destroy()};f.createObject=function(a){const b=new R;b.toMapSpace=a.toMapSpace.slice();b.transform=a.transform;b.obb=O.clone(a.obb);b.components=new Q(this._componentBufferManager,a.geometry.componentOffsets);b.renderable=this._createRenderable(a,b.components);b.intersectionGeometry=new S(a.geometry.positionData,b.components);this._objects.add(a.visible?r.VISIBLE_BIT:0,b);return b};f.destroyObject=function(a){this._objects.remove(a);a.dispose();this._notifyDirty()};f.setObjectVisibility=
function(a,b){b!==a.visible&&(this._objects.updateKey(a,b?a.bucketKey|r.VISIBLE_BIT:a.bucketKey&~r.VISIBLE_BIT),this._notifyDirty())};f.preSubmit=function(a){const b=a.camera.eye;this._objects.forEach((c,d)=>{d&r.VISIBLE_BIT&&c.forEach(h=>{const e=q.squaredDistance(b,h.obb.center);h.renderable.meta.cameraDepthSquared=e})})};f.getMaterial=function(a){return a.renderable.material};f.updateMaterial=function(a,b){a=a.renderable.material;b(a);a.dirty&&this._notifyDirty()};f.setAllComponentVisibilities=
function(a,b){a.components.visibility.reset(b);a.components.visibilityDirty();this._notifyDirty()};f.forEachVisibleComponent=function(a,b){return a.components.visibility.forEachComponent(b)};f.getComponentCount=function(a){const b=a.components.visibility.componentCount();return{visible:b,invisible:a.components.count-b}};f.setComponentData=function(a,b){const c=a.renderable.material;if(r.isVaryingComponentParameters(b)){a=a.components;var d=a.materialDataBuffer;const h=a.materialDataIndices,e={castShadows:!0,
pickable:!0,externalColor:M.create(),externalColorMixMode:1};d=d.textureBuffer;const g=new Uint8Array(4),v=new Uint32Array(g.buffer);let l=0,k=0,m=0,p=!1,w=0;for(let t=0;t<a.count;t++)b(t,e),l+=+(1>e.externalColor[3]),k+=+(3===e.externalColorMixMode&&1===e.externalColor[3]),m+=+e.castShadows,N.encodeSymbolColor(e.externalColor,e.externalColorMixMode,g),g[2]=g[2]&254|+e.castShadows,d.setData(h[t],0,g[0],g[1],g[2],g[3]),p=p||0<t&&w!==v[0],w=v[0],e.pickable!==H.getVisibility(a.pickability,t)&&(a.pickability=
H.updateVisibilityWithCount(a.pickability,a.count,t,e.pickable));p?(c.componentParameters=new x.ComponentParametersVarying,c.componentParameters.castShadows=m===a.count?0:0===m?2:1,c.componentParameters.transparent=l===a.count?0:0===l?2:1,c.componentParameters.opaqueOverride=k===a.count?0:0===k?2:1,c.componentParameters.texture=d,d.updateTexture()):(c.componentParameters=new x.ComponentParametersUniform,c.componentParameters.castShadows=e.castShadows?0:2,c.componentParameters.externalColor=e.externalColor,
c.componentParameters.externalColorMixMode=e.externalColorMixMode)}else c.componentParameters=new x.ComponentParametersUniform,c.componentParameters.castShadows=b.castShadows?0:2,c.componentParameters.externalColor=b.externalColor,c.componentParameters.externalColorMixMode=b.externalColorMixMode;this._notifyDirty()};f.getComponentAabb=function(a,b,c){return a.intersectionGeometry.getComponentAabb(b,c)};f.getComponentObb=function(a){return a.obb};f.getObjectTransform=function(a){return a.transform};
f.getComponentPositions=function(a,b,c){return a.intersectionGeometry.getComponentPositions(b,c)};f.intersect=function(a,b,c,d,h,e){n.isSome(h)&&(h.localOrigin=a.transform.position);const g=u.invert(J,a.transform.rotationScale);q.sub(y,b,a.transform.position);q.sub(z,c,a.transform.position);q.transformMat3(y,y,g);q.transformMat3(z,z,g);b=u.transpose(J,g);return a.intersectionGeometry.intersect(y,z,d,b,h,e)};f.addEdges=function(a,b,c,d){const {indices:h,positions:e}=a.intersectionGeometry;return b.addComponentObject(a,
a.transform,a.obb.center,e,h,a.components.offsets,c,d)};f.addComponentHighlight=function(a,b){a=a.components;n.isNone(a.highlightCounts)&&(a.highlightCounts=new Uint32Array(a.count+1));0===a.highlightCounts[b]++&&(a.highlightsDirty(),this._notifyDirty());a.highlightCounts[a.count]++};f.removeComponentHighlight=function(a,b){a=a.components;if(n.isNone(a.highlightCounts))I.warn("Removing non-existing highlight.");else{var c=a.highlightCounts[b],d=a.highlightCounts[a.count];0===c?I.warn("Removing non-existing highlight."):
1<c?(a.highlightCounts[b]=c-1,a.highlightCounts[a.count]=d-1):(a.highlightCounts[b]=0,a.highlightsDirty(),this._notifyDirty(),1===d?a.highlightCounts=null:a.highlightCounts[a.count]=d-1)}};f.clearHighlights=function(a){a=a.components;n.isSome(a.highlightCounts)&&(a.highlightCounts=null,a.highlightsDirty(),this._notifyDirty())};f.getObjectGPUMemoryUsage=function(a){return a.renderable.meta.gpuMemoryEstimate};f._createRenderable=function(a,b){const c=this._renderManager.rctx;var d=a.geometry,h=d.vertices.layoutParameters,
e=B.createVertex(c,35044,d.vertices.data);const g=n.applySome(d.indices,p=>B.createIndex(c,35044,p));var v=G.glLayout(W.createVertexBufferLayout(h)),l=new Uint16Array(d.vertices.count);for(var k=0;k<b.count;k++){var m=b.offsets[k];const p=b.offsets[k+1],w=b.materialDataIndices[k];if(n.isSome(d.indices))for(;m<p;m++)l[d.indices[m]]=w;else for(;m<p;m++)l[m]=w}d=B.createVertex(c,35044,l.buffer);l=new Z.TwoVectorPosition(a.transform.position);k=E.clone(a.transform.rotationScale);u.invert(k,k);u.transpose(k,
k);b=new X.ComponentDrawParameters;q.copy(b.worldFromModel_TL,l.low);q.copy(b.worldFromModel_TH,l.high);u.copy(b.worldFromModel_RS,a.transform.rotationScale);u.copy(b.transformNormal_GlobalFromModel,k);L.copy(b.toMapSpace,a.toMapSpace);a=new x.ComponentMaterial;v=new ca(c,a.attributeLocations,{data:v,componentIndices:da},{data:e,componentIndices:d},n.unwrap(g));h=new U.RenderGeometry(v,4,h,n.isSome(g));e={cameraDepthSquared:.5,gpuMemoryEstimate:e.byteSize+d.byteSize+(n.isSome(g)?g.byteSize:0)};return new T.Renderable(a,
b,h,e)};f._notifyDirty=function(){this._renderManager.notifyDirty()};K._createClass(C,[{key:"visibleObjects",get:function(){return this._objects.getBucket(r.VISIBLE_BIT)}},{key:"performanceInfo",get:function(){const a=this._objects.getPerformanceInfo(r.VISIBLE_BIT);return{shown:a.added,hidden:a.removed}}}]);return C}();const da=G.glLayout(P.newLayout().u16("componentIndex")),J=E.create(),y=F.create(),z=F.create();D.ComponentObjectCollection=A;Object.defineProperty(D,"__esModule",{value:!0})});