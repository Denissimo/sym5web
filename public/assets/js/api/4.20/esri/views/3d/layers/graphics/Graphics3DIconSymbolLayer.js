// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../symbols ../../../../core/asyncUtils ../../../../core/has ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../support/arcadeOnDemand ../../../../symbols/support/IconSymbol3DLayerResource ../../../../symbols/support/utils ../../../2d/arcade/callExpressionWithFeature ./constants ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./pointUtils ./sdfPrimitives ../support/FastSymbolUpdates ../../terrain/OverlayRenderer ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial ../../../../symbols/CIMSymbol".split(" "),
function(M,A,w,N,u,O,P,B,n,C,v,G,Q,D,r,R,H,S,T,U,V,W,X,Y,Z,p,aa,ba,ca,da,x,E,t,y,ea,I,fa,J,K,ha){function F(q){return n.isSome(q)?"cross"===q||"x"===q:!1}const ia=Q.create(),L=r.fromValues(0,0,1),ja=[.25,.25,.75,.75];u=function(q){function z(a,b,c,d){a=q.call(this,a,b,c,d)||this;a._cimLayers=null;a._cimSymbolMaterials=new Map;a._cimSymbolTextures=new Map;a._cimMaterialParametersInfo=null;a._cimRequiredFields=null;a._cimScaleFactorOrFunction=null;a._size=null;a._symbolTextureRatio=1;a._outlineSize=
0;a._texture=null;a._releaseTexture=null;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0};return a}w._inheritsLoose(z,q);var f=z.prototype;f.getCachedSize=function(){return{size:this._getIconSize()}};f.doLoad=function(){var a=w._asyncToGenerator(function*(b){this._validateOrThrow();const c=this._prepareMaterialParameters();var d=this._getPrimitive();if(n.isSome(d))this._prepareResourcesPrimitive(c,d);else{d=W.getIconHref(this.symbol,this.symbolLayer);const e=G.dataComponents(d);
e&&"application/json"===e.mediaType?yield this._prepareResourcesCIM(c,JSON.parse(e.data),b):yield this._prepareResourcesHref(c,d,b)}});return function(b){return a.apply(this,arguments)}}();f._validateOrThrow=function(){if(!this._drivenProperties.size){var a=x.validateSymbolLayerSize(this._getIconSize());if(a)throw new B("graphics3diconsymbollayer:invalid-size",a);}};f._getIconSize=function(){var a=this.symbolLayer;a=Math.round(null!=a.size?v.pt2px(a.size):16);return this._drivenProperties.size?Math.max(a,
64):a};f._generateTextureCIM=function(a){const b=this._getGraphicHash(a);let c=""===b?null:this._cimSymbolTextures.get(b);c||(a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,a,"esriGeometryPoint",{scaleFactor:this._cimScaleFactorOrFunction},null,null),this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",a.anchorPosition),c=new J.Texture(a.imageData,{width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:2}),this._cimSymbolTextures.set(b,
c),this._context.stage.add(c));return c};f._computeSize=function(a,b){a=a.width/a.height;return 1<a?[b,Math.round(b/a)]:[Math.round(b*a),b]};f._prepareMaterialParameters=function(){const a={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},b=this.symbol;if(b&&"point-3d"===b.type&&b.hasVisibleVerticalOffset()){const {screenLength:c,minWorldLength:d,maxWorldLength:e}=b.verticalOffset;a.verticalOffset={screenLength:v.pt2px(c),minWorldLength:d||0,maxWorldLength:null!=
e?e:Infinity}}this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);a.occlusionTest=!0;a.slicePlaneEnabled=this._context.slicePlaneEnabled;return a};f._prepareResourcesPrimitive=function(a,b){var c=this._getOutlineSize();if(F(b)&&0===c)throw Error("Nothing to render");this._outlineSize=c;a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;const d=this._context.sharedResources.textures.fromData(b,
()=>{switch(b){case "circle":var e=t.createCircle(128,64);break;case "square":e=t.createSquare(128,64);break;case "kite":e=t.createKite(128,64);break;case "cross":e=t.createCross(128,64);break;case "x":e=t.createX(128,64);break;case "triangle":e=t.createTriangle(128,64)}return e=new J.Texture(e,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})});this._texture=d.texture;this._releaseTexture=()=>this._context.sharedResources.textures.release(d.uid);a.textureIsSignedDistanceField=
!0;a.distanceFieldBoundingBox=ja;a.textureId=this._texture.id;c=this._getIconSize();this._size=[c,c];this._symbolTextureRatio=2;this._createMaterialAndAddToStage(a,this._context.stage)};f._prepareResourcesHref=function(){var a=w._asyncToGenerator(function*(b,c,d){if(!P("esri-canvas-svg-support")&&G.isSVG(c))throw new B("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize();b.color=this._getFillColor();
b.outlineColor=this._getOutlineColor();b.outlineSize=this._outlineSize;b.textureIsSignedDistanceField=!1;const e=this._getIconSize();d=yield O.result(this._context.sharedResources.textures.fromUrl(c,e*this._context.layerView.view.pixelRatio,{signal:d}));if(!1===d.ok)throw C.throwIfAbortError(d.error),new B("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${c})`);const {uid:g,texture:h}=d.value;this._releaseTexture=()=>this._context.sharedResources.textures.release(g);
this._size=this._computeSize(h.params,e);b.textureId=h.id;this._createMaterialAndAddToStage(b,this._context.stage)});return function(b,c,d){return a.apply(this,arguments)}}();f._prepareResourcesCIM=function(){var a=w._asyncToGenerator(function*(b,c,d){c=new ha({data:c});if(!this._context.sharedResources.cimSymbolRasterizer){var e=(yield new Promise(function(k,l){M(["../../../../symbols/cim/CIMSymbolRasterizer"],k,l)})).CIMSymbolRasterizer;C.throwIfAborted(d);this._context.sharedResources.cimSymbolRasterizer||
(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0))}e=this._context.layer.fields?this._context.layer.fields.map(k=>k.toJSON()):null;this._cimLayers=yield this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(c,e,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:d});let g;if(this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression)if(c=
this._context.renderer,isNaN(c.scaleExpression)){const k=yield U.createRendererExpression(c.scaleExpression,this._context.layer.spatialReference,e);g=(l,ka,la)=>{l=X(k,l,{$view:la},"esriGeometryPoint",ka);return null!==l?l:1}}else var h=Number(c.scaleExpression);this._cimScaleFactorOrFunction=h||g||1;h=this._context.renderer?yield this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];C.throwIfAborted(d);const m=this._context.layer.fieldsIndex;this._cimRequiredFields=h.map(k=>
m.get(k).name);this._cimMaterialParametersInfo=b;this._cimMaterialParametersInfo.color=this._getFillColor();this._cimMaterialParametersInfo.outlineColor=[0,0,0,0];this._cimMaterialParametersInfo.outlineSize=0;this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1});return function(b,c,d){return a.apply(this,arguments)}}();f._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||V.defaultPrimitive};
f._getOutlineSize=function(){var a=0;a=this.symbolLayer;if(n.isSome(a.outline)&&null!=a.outline.size)return Math.max(v.pt2px(a.outline.size),0);a=this._getPrimitive();a=F(a)?1.5:0;return Math.max(a,0)};f._getOutlineColor=function(){const a=this._getLayerOpacity(),b=n.get(this.symbolLayer,"outline","color");if(n.isSome(b)){const c=N.toUnitRGB(b);return[c[0],c[1],c[2],b.a*a]}return[0,0,0,0]};f._getFillColor=function(){if(F(this._getPrimitive()))return Y.TRANSPARENT_UNIT;const a=n.isNone(this._getPrimitive()),
b=n.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(b,{hasIntrinsicColor:a})};f._getAnchorPos=function(a,b){return"relative"===a?D.fromValues((b.x||0)+.5,-(b.y||0)+.5):a in x.namedAnchorToHUDMaterialAnchorPos?x.namedAnchorToHUDMaterialAnchorPos[a]:x.namedAnchorToHUDMaterialAnchorPos.center};f._createMaterialAndAddToStage=function(a,b){this._fastUpdates=this._cimLayers?{enabled:!1}:y.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());
this._fastUpdates.enabled&&Object.assign(a,this._fastUpdates.materialParameters);if(this._cimLayers){let c=this._cimSymbolMaterials.get(a.textureId);c||(c=new K.HUDMaterial(a),this._cimSymbolMaterials.set(a.textureId,c),b.add(c));return c}this._material=new K.HUDMaterial(a);b.add(this._material);return this._material};f._setDrapingDependentMaterialParameters=function(){this.draped&&(this._forEachMaterial(a=>{a.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,
shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())};f.destroy=function(){q.prototype.destroy.call(this);this._forEachMaterial(a=>this._context.stage.remove(a));this._material=null;this._cimSymbolMaterials.clear();this._cimSymbolTextures.forEach(a=>this._context.stage.remove(a));this._cimSymbolTextures.clear();this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)};f._getScaleFactor=function(a,b){if(this._drivenProperties.size&&a.size){for(let c=0;3>c;c++){const d=
a.size[c];d&&"symbol-value"!==d&&"proportional"!==d&&(a.size[c]=v.pt2px(d))}if("symbol-value"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/b;if(isFinite(+a.size[2]))return+a.size[2]/b}return 1};f.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry))return null;let c;if(this._cimLayers){if(!this._cimLayers.length)return null;var d=this._generateTextureCIM(b);c=this._createMaterialAndAddToStage({textureId:d.id,...this._cimMaterialParametersInfo},
this._context.stage);var e=[d.params.width,d.params.height]}else e=this._size,c=n.unwrap(this._material);d=E.placePointOnGeometry(b.geometry);if(n.isNone(d))return this.logger.warn(`unsupported geometry type for icon symbol: ${b.geometry.type}`),null;var g=a.renderingInfo;const h=this._getVertexOpacityAndColor(g);let m=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(m=this._getScaleFactor(g,e[0]>e[1]?e[0]:e[1]));m*=this._symbolTextureRatio;e=[e[0]*m,e[1]*m];g=this.setGraphicElevationContext(b,
new aa.ElevationContext);this.ensureDrapedStatus("on-the-ground"===g.mode)&&this._setDrapingDependentMaterialParameters();return this.draped?this._createAsOverlay(b,d,c,h,e,a.layer.uid):this._createAs3DShape(b,d,c,h,e,g,b.uid)};f.layerOpacityChanged=function(){const a=this._getFillColor(),b=this._getOutlineColor();this._forEachMaterial(c=>{c.setParameterValues({color:a});c.setParameterValues({outlineColor:b})});return!0};f.layerElevationInfoChanged=function(a,b,c){const d=this._elevationContext.mode;
c=p.elevationModeChangeUpdateType(z.elevationModeChangeTypes,c,d);if(c!==p.SymbolUpdateType.UPDATE)return c;const e=p.needsElevationUpdates2D(d)||"absolute-height"===d;return this.updateGraphics3DGraphicElevationInfo(a,b,()=>e)};f.slicePlaneEnabledChanged=function(){this.draped||this._forEachMaterial(a=>{a.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})});return!0};f.physicalBasedRenderingChanged=function(){return!0};f.pixelRatioChanged=function(){return this._getPrimitive()?
!0:!1};f.applyRendererDiff=function(a,b){for(const c in a.diff)switch(c){case "visualVariables":if(y.updateFastSymbolUpdatesState(this._fastUpdates,b,this._fastVisualVariableConvertOptions()))n.isSome(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};f._defaultElevationInfoNoZ=function(){return ma};f._createAs3DShape=function(a,b,c,d,e,g,h){const m=this.getFastUpdateAttrValues(a);a=m?l=>y.evaluateModelTransform(this._fastUpdates.materialParameters,
m,l):null;d=[I.createPointGeometry(L,null,d,e,na,null,m)];h=E.createStageObjectForHUD(this._context,b,d,[c],null,null,g,this._context.layer.uid,h,a);if(null===h)return null;const k=new ca.Graphics3DObject3DGraphicLayer(this,h.object,d,null,null,Z.perObjectElevationAligner,g);k.alignedSampledElevation=h.sampledElevation;k.needsElevationUpdates=p.needsElevationUpdates2D(g.mode)||"absolute-height"===g.mode;k.getScreenSize=this._createScreenSizeGetter(e,a);k.calculateRelativeScreenBounds=l=>c.calculateRelativeScreenBounds(k.getScreenSize(),
1,l);E.extendPointGraphicElevationContext(k,b,this._context.elevationProvider);return k};f._createAsOverlay=function(a,b,c,d,e,g){c.renderPriority=this._renderPriority;const h=H.create();S.projectPointToVector(b,h,this._context.overlaySR);h[2]=ea.DRAPED_Z;b=this._context.clippingExtent;if(n.isSome(b)&&!T.containsPoint(b,h))return null;const m=this.getFastUpdateAttrValues(a);b=m?l=>y.evaluateModelTransform(this._fastUpdates.materialParameters,m,l):null;d=I.createPointGeometry(L,h,d,e,null,null,m);
a=new fa.RenderGeometry(d,c,g,a.uid);h[3]=0;R.copy(a.boundingSphere,h);a.calculateShaderTransformation=b;const k=new ba(this,[a],null);k.getScreenSize=this._createScreenSizeGetter(e,b);k.calculateRelativeScreenBounds=l=>c.calculateRelativeScreenBounds(k.getScreenSize(),1,l);return k};f._createScreenSizeGetter=function(a,b){const c=this._outlineSize+2;if(this._fastUpdates.enabled){const d=a[0]/this._symbolTextureRatio,e=a[1]/this._symbolTextureRatio;return(g=D.create())=>{const h=b(ia);g[0]=h[0]*d+
c;g[1]=h[5]*e+c;return g}}{const d=a[0]/this._symbolTextureRatio+c,e=a[1]/this._symbolTextureRatio+c;return(g=D.create())=>{g[0]=d;g[1]=e;return g}}};f._fastVisualVariableConvertOptions=function(){var a=this._size[0]>this._size[1]?this._size[0]:this._size[1];const b=r.fromValues(a,a,a),c=v.px2pt(1);a*=c;a=r.fromValues(a,a,a);return{modelSize:b,symbolSize:a,unitInMeters:c,transformation:{anchor:r.ZEROS,scale:r.ONES,rotation:r.ZEROS}}};f._getGraphicHash=function(a){let b="";for(const c of this._cimRequiredFields)b+=
c+a.attributes[c];return b};f._forEachMaterial=function(a){n.isSome(this._material)&&a(this._material);this._cimSymbolMaterials.forEach(a)};return z}(da.Graphics3DSymbolLayer);u.PRIMITIVE_SIZE=[64,64];u.elevationModeChangeTypes={definedChanged:p.SymbolUpdateType.UPDATE,staysOnTheGround:p.SymbolUpdateType.NONE,onTheGroundChanged:p.SymbolUpdateType.RECREATE};const ma={mode:"relative-to-ground",offset:0},na=H.fromValues(0,0,0,1);A.Graphics3DIconSymbolLayer=u;A.default=u;Object.defineProperty(A,"__esModule",
{value:!0})});