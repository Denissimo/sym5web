// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/has ../../../core/mathUtils ../../../core/maybe ../../../core/scheduling ../../../core/time ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec2 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4 ../../../chunks/vec4f64 ../../../geometry/projection ../../../geometry/projectionEllipsoid ../../../geometry/support/aaBoundingRect ../../../geometry/support/ray ../../../chunks/sphere ../../../geometry/support/vector ../../../geometry/support/webMercatorUtils ../state/utils/viewUtils ../support/animationUtils ../support/debugFlags ../support/debugUtils ../support/mathUtils ./Overlay ./OverlayRenderer ../webgl-engine/lib/Intersector ../webgl-engine/lib/localOrigin ../webgl-engine/parts/requireUtils ../../support/Scheduler".split(" "),
function(l,C,n,P,Q,R,A,p,S,T,G,q,ma,na,oa,U,V,y,H,D,I,J,K,k,L,M,W,X,Y,Z,E,aa,F,ba,ca,da,ea,fa,ha){function ia(u,r){const f=E.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1E-5*Math.max(u[2]-u[0],u[3]-u[1],r[2]-r[0],r[3]-r[1]);for(let a=0;4>a;a++)if(Math.abs(r[a]-u[a])>f)return!0;return!1}const ja=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let v;l.OverlayManager=function(u){function r(a){a=u.call(this,a)||this;a._handles=
new Q;a._spatialReference=null;a._renderSR=null;a._overlaySREqualsRenderSR=!0;a._drapeSources=new Map;a._drapeTargets=new Set;a._renderedAltitude=0;a._displayOpacity=0;a._displayOpacityTime=-1;a._placementDirty=!1;a._drawTexturesDirty=!1;a._drawTexturesAnimateDirty=!1;a._layerViewsDirty=!0;a._hasUnusedRenderTargets=!1;a._longitudeCyclical=null;a._latestOriginId=0;a._maxResolution=R("esri-mobile")?2048:4096;a._animationTimeLast=0;return a}C._inheritsLoose(r,u);var f=r.prototype;f.initialize=function(){const a=
this.view,b=a.state.isGlobal&&p.isSome(this._spatialReference)?G.getMetersPerUnitForSR(this._spatialReference):1;this.renderer=new ca.OverlayRenderer({view:a,globalUnitScale:b,spatialReference:this._spatialReference});this.renderer.onHasHighlightsChanged=()=>{this._setDrawTexturesDirty();this.notifyChange("hasHighlights")};this.renderer.onRendersOccludedChanged=()=>{this._setDrawTexturesDirty();this.notifyChange("rendersOccluded")};this.renderer.onContentChanged=()=>this._setDrawTexturesDirty();this.renderer.onHasWaterChanged=
c=>{var e;return null==(e=a._stage)?void 0:e.renderView.setRenderParameters({hasOverlayWater:c})};this.groundIntersector=new da.Intersector(this.view.state.viewingMode);this.groundIntersector.options.backfacesTerrain=!0;this.groundIntersector.options.invisibleTerrain=!0;this.groundIntersector.options.hud=!1;this._handles.add([a.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],()=>this.setOverlayPlacementDirty()),this.surface.on("elevation-change",
()=>this.setOverlayPlacementDirty()),a.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0),a.on("resize",()=>this.setOverlayPlacementDirty()),S.addFrameTask({preRender:c=>{this.renderer.processSyncLayers();this._updateLayerViews();this.renderer.hasOverlays&&(this._dispatchRendererUpdate(c),this._drawOverlayTextures(this.renderer.overlays));this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),a.resourceController.scheduler.registerTask(ha.TaskPriority.OVERLAY_MANAGER,
this),a._stage.renderView.events.on("force-camera-for-screenshot",c=>{this._updateOverlays(c);this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays)})]);this._updateLayerViews()};f.destroy=function(){this._drapeSources.forEach((a,b)=>this.unregisterDrapeSource(b));this._drapeTargets.forEach(a=>this._unregisterDrapeTarget(a));this.renderer.dispose();this._handles&&(this._handles.destroy(),this._handles=null);p.isSome(v)&&(v.remove(),v=null)};f.setSpatialReference=function(a){this._spatialReference=
a;this.renderer.spatialReference=a;this._longitudeCyclical=null;const b=this.view.renderSpatialReference;p.isSome(a)&&p.isSome(b)?(this._renderSR=b,this._overlaySREqualsRenderSR=a.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=a.isWebMercator?new F.Cyclical(-2.0037508342787E7,2.0037508342787E7):new F.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.globalUnitScale=this._isSpherical&&p.isSome(this._spatialReference)?G.getMetersPerUnitForSR(this._spatialReference):
1)):this.renderer.disposeOverlays()};f.getGpuMemoryUsage=function(){return this.renderer.gpuMemoryUsage};f._updateLayerViews=function(){if(this._layerViewsDirty){var a=new Set;for(const b of this.view.allLayerViews.items)a.add(b.uid),"drapeSourceType"in b&&!this._drapeSources.has(b)&&this._registerDrapeSource(b,0),"drapeTargetType"in b&&!this._drapeTargets.has(b)&&this._registerDrapeTarget(b);this._drapeSources.forEach((b,c)=>{0!==b||a.has(c.uid)||this.unregisterDrapeSource(c)});this._drapeTargets.forEach(b=>
{a.has(b.uid)||this._unregisterDrapeTarget(b)});this.renderer.updateLayerOrder();this._setDrawTexturesDirty();this._layerViewsDirty=!1}};f.registerDrapeSource=function(a){this._registerDrapeSource(a,1)};f._registerDrapeSource=function(a,b){this._drapeSources.set(a,b);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);this.renderer.overlays.forEach(c=>{this._updateDrapeSource(a,c)});this._setOverlayContentDirty();this.notifyChange("running")};f._updateDrapeSource=function(a,b){p.isSome(a.setDrapingExtent)&&
p.isSome(this._spatialReference)&&a.setDrapingExtent(b,this._spatialReference)};f.unregisterDrapeSource=function(a){this._drapeSources.has(a)&&(this._drapeSources.delete(a),this.renderer.ensureDrapeSources(this._drapeSources),this._setOverlayContentDirty(),this.notifyChange("running"))};f._registerDrapeTarget=function(a){this._drapeTargets.add(a);this._updateDrapeTarget(a);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)};f._updateDrapeTarget=function(a){this.renderer.overlays.forEach(b=>
a.setDrapingTextures(b))};f._unregisterDrapeTarget=function(a){this._drapeTargets.delete(a);this.renderer.ensureDrapeTargets(this._drapeTargets)};f._setOverlayContentDirty=function(){this.setOverlayPlacementDirty();this._setDrawTexturesDirty()};f.setOverlayPlacementDirty=function(){this._placementDirty=!0};f.runTask=function(){this._updateOverlays(this.view.state.camera)};f._updateOverlays=function(a){if(this._spatialReference){this._updateLayerViews();var b=ba.computeOverlayResolution(a.fullWidth,
a.fullHeight,this._maxResolution);this._computeOverlayExtents(a,b,z);var c=k.width(z.inner)/k.width(z.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);a=this._updateOverlay(0,z.inner,b,1);b=this._updateOverlay(1,z.outer,b,c);if(a||b)this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty();this._placementDirty=!1;this.surface.updateOverlayOpacity()}};f._updateOverlay=function(a,b,c,e){if(0===this.renderer.overlays.length)return!1;const d=this.renderer.overlays[a];
if(!ia(b,d.extent)&&c===d.resolution&&d.pixelRatio===e)return!1;k.set(d.extent,b);d.resolution=c;d.pixelRatio=e;a=k.center(d.extent);d.renderLocalOrigin=ea.fromValues(a[0],a[1],0,`OV_${this._latestOriginId++}`);this._drapeSources.forEach((g,h)=>this._updateDrapeSource(h,d));return!0};f.computeOpacity=function(a){if(!this.renderer.hasOverlays)return this._displayOpacity=0,this._displayOpacityTime=-1,1;if(3.5*a<this._renderedAltitude)this._displayOpacity=Math.sqrt(A.clamp((a-this._renderedAltitude/
10)/(this._renderedAltitude/3.5-this._renderedAltitude/10),0,1)),this._displayOpacityTime=performance.now();else if(1!==this._displayOpacity){a=performance.now();this._displayOpacityTime=0<this._displayOpacityTime?this._displayOpacityTime:a;a-=this._displayOpacityTime;const b=this.surface.textureFadeDuration;if(a<b)return this._displayOpacity+a/b*(1-this._displayOpacity);this._displayOpacity=1;this._displayOpacityTime=-1}return this._displayOpacity};f.setTileParameters=function(a){const b=a.renderData.overlay;
if(0<this.renderer.overlays.length){const c=this.renderer.overlays[0],e=this.renderer.overlays[1];a=k.intersection(a.extent,a.surface.extent,N);this._rectInsideRect(a,c.extent)||this._rectanglesOverlap(a,c.extent)||this._rectanglesOverlap(a,e.extent)?(this._setTileOverlayData(a,0,b),this._setTileOverlayData(a,1,b)):(this._clearTileOverlayData(0,b),this._clearTileOverlayData(1,b))}else this._clearTileOverlayData(0,b),this._clearTileOverlayData(1,b)};f.overlayPixelSizeInMapUnits=function(a){if(0===
this.renderer.overlays.length)return 0;const b=this.renderer.overlays[0],c=this.renderer.overlays[1];a=this._pointIsInExtent(a,b.extent)?b:c;return(a.extent[2]-a.extent[0])/a.resolution};f._setTileOverlayData=function(a,b,c){if(0!==this.renderer.overlays.length){var e=this.renderer.overlays[b].extent;c.setScale(b,(a[2]-a[0])/(e[2]-e[0]),(a[3]-a[1])/(e[3]-e[1]));var d=a[0];if(this._longitudeCyclical){d=this._longitudeCyclical.minimalMonotonic(e[0],d);const g=this._longitudeCyclical.minimalMonotonic(e[0],
a[2]);d>g&&(d=g-(a[2]-a[0]))}c.setOffset(b,(d-e[0])/(e[2]-e[0]),(a[1]-e[1])/(e[3]-e[1]))}};f._clearTileOverlayData=function(a,b){b.setScale(a,-1,-1);b.setOffset(a,-1,-1)};f.reloadShaders=function(){var a=C._asyncToGenerator(function*(){fa.removeLoadedShaderModules();yield this.renderer.reloadShaders();this.runTask()});return function(){return a.apply(this,arguments)}}();f.stopAnimationsAtTime=function(a){this.renderer.stopAnimationsAtTime(a);this._drawTexturesAnimateDirty=!0};f._dispatchRendererUpdate=
function(a){const b=T.Milliseconds(a.time-this._animationTimeLast);b<Z.DESIRED_DRAPED_ANIMATION_MS||(this._animationTimeLast=a.time,this.renderer.updateLogic({dt:b,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0))};f._setDrawTexturesDirty=function(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()};f._intersectGroundFromView=function(a,b,c,e){c=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(a,ka,b,c);if(p.isNone(c))return!1;
b=c.origin;c=y.add(B,c.origin,c.direction);this.groundIntersector.reset(b,c);this.groundIntersector.intersect([],null,a);this.view.basemapTerrain.intersect(this.groundIntersector,null,b,c);return this.groundIntersector.results.min.getIntersectionPoint(e)};f._findHorizonBasedPointOfInterest=function(a,b){var c=.5;c=this.view.renderCoordsHelper.getAltitude(a.eye);const e=this.view.pointsOfInterest.centerOnSurfaceFrequent;var d=A.clamp(e.estimatedSurfaceAltitude,a.aboveGround?-Infinity:c+1E-5,a.aboveGround?
c-1E-5:Infinity);c=a.aboveGround;if("global"===this.view.viewingMode){var g=B;M.closestPointOnSilhouette(M.fromRadius(K.getReferenceEllipsoid(this.view.spatialReference).radius+d),L.wrap(a.eye,a.viewForward),g);y.subtract(g,g,a.eye);d=F.cyclicalPI.normalize(W.angleAroundAxis(a.viewForward,g,a.viewRight))/a.fovY+.5;g=0>=d||1<=d?.5:.55;c=c?g*d:d+g*(1-d)}else d=I.fromValues(0,Math.tan(.5*Math.PI-Math.acos(-a.viewForward[2])),1,0),d=D.transformMat4(d,d,a.projectionMatrix)[1],d=A.clamp(.5+.5*d,0,1),c=
1===d||0===d?.5:c?.55*d:1-.55*(1-d);return this._intersectGroundFromView(a,.5,c,b)?y.sqrDist(b,a.eye)<e.distance*e.distance:!1};f._computeOverlayExtents=function(a,b,c){var e=this.surface.extent,d=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;const g=H.create();this._findHorizonBasedPointOfInterest(a,g)||y.copy(g,d);this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(a.eye);var h=y.distance(a.eye,g);d=Y.viewAngle(this.view.renderCoordsHelper,d,a.eye);d=Math.PI/2-Math.abs(d-
Math.PI/2);E.OVERLAY_SHOW_CENTER?(p.isNone(v)&&(v=new aa.GraphicsHandle(this.view.graphics,"red")),v.showPoint(g,this._renderSR)):p.isSome(v)&&v.remove();this._overlaySREqualsRenderSR||J.projectVectorToVector(g,this._renderSR,g,this._spatialReference);h=b*a.perRenderPixelRatio*h/2;var m=!1;let w=Infinity;this._isSpherical&&p.isSome(this._spatialReference)&&(this._spatialReference.isWebMercator?(h/=Math.cos(X.y2lat(g[1])),w=this.surface.extent[3]):(m=!0,h/=K.getReferenceEllipsoid(this._spatialReference).metersPerDegree,
w=90),h>=w&&(h=w,g[1]=0,this._spatialReference.isWebMercator&&(g[0]=0)));let x=1;m&&(x=1/Math.max(.2,Math.cos(Math.abs(A.deg2rad(g[1])))),180<h*x&&(x=180/h));m=Math.log(2)/12;h=Math.exp(Math.round(Math.log(h)/m)*m);m=h*x;const O=.5*b/(32*m);b=.5*b/(32*h);g[0]=Math.round(g[0]*O)/O;g[1]=Math.round(g[1]*b)/b;b=c.inner;b[0]=g[0]-m;b[1]=g[1]-h;b[2]=g[0]+m;b[3]=g[1]+h;this._isSpherical&&this._shiftExtentToFitBounds(b,Infinity,w);c=c.outer;k.set(c,b);6*m>e[2]-e[0]?k.set(c,e):d<=.25*Math.PI?(c[0]-=m,c[1]-=
h,c[2]+=m,c[3]+=h):(J.projectVectorToVector(a.eye,this._renderSR,B,this._spatialReference),V.subtract(t,g,B),a=-Math.atan2(t[1],t[0])+.125*Math.PI,0>a&&(a+=2*Math.PI),D.scale(t,ja[Math.floor(a/(.25*Math.PI))],2*h),t[0]*=x,t[2]*=x,D.add(c,c,t));this._isSpherical&&(c[0]=this._longitudeCyclical.clamp(c[0]),c[2]=this._longitudeCyclical.clamp(c[2]),c[1]=Math.max(c[1],-w),c[3]=Math.min(c[3],w));!this._isSpherical&&e&&(a=k.intersection(b,e,N),e=k.intersection(c,e,la),k.contains(a,e)&&(c[2]=c[0],c[3]=c[1]))};
f._drawOverlayTextures=function(a){if(0!==a.length&&(this._drawTexturesDirty||this._drawTexturesAnimateDirty)){var b=this._drawOverlay(a[0]);a=this._drawOverlay(a[1]);0!==b&&0!==a||this.surface.updateTileOverlayParams();this._collectUnusedRenderTargetMemory();this._drapeTargets.forEach(c=>this._updateDrapeTarget(c));this._drawTexturesAnimateDirty=!1;this._drawTexturesDirty?(this._drawTexturesDirty=!1,this.surface.requestRender(),this.surface.requestUpdate()):this.surface.requestRender(0)}};f._drawOverlay=
function(a){this._longitudeCyclical?a.setupGeometryViewsCyclical(this._longitudeCyclical):a.setupGeometryViewsDirect();return a.draw(this.renderer,this.view.state.camera.pixelRatio)};f._collectUnusedRenderTargetMemory=function(){this._hasUnusedRenderTargets=!1;if(this.renderer.hasOverlays){const a=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(a)}};f._rectanglesOverlap=function(a,b){return this._longitudeCyclical?(this._longitudeCyclical.contains(b[0],
b[2],a[0])||this._longitudeCyclical.contains(b[0],b[2],a[2])||this._longitudeCyclical.contains(a[0],a[2],b[0]))&&!(a[1]>b[3]||a[3]<b[1]):k.intersects(a,b)};f._rectInsideRect=function(a,b){return this._longitudeCyclical?this._longitudeCyclical.contains(b[0],b[2],a[0])&&this._longitudeCyclical.contains(b[0],b[2],a[2])&&a[1]>b[1]&&a[3]<b[3]:k.contains(b,a)};f._pointIsInExtent=function(a,b){if(this._longitudeCyclical)return this._longitudeCyclical.contains(b[0],b[2],a.x)&&a.y>=b[1]&&a.y<=b[3];const c=
a.x;a=a.y;return c>b[0]&&c<b[2]&&a>b[1]&&a<b[3]};f._shiftExtentToFitBounds=function(a,b,c){let e=0,d=0;a[0]<-b?e=a[0]+b:a[2]>b&&(e=b-a[2]);a[1]<-c?d=a[1]+c:a[3]>c&&(d=c-a[3]);k.offset(a,e,d)};C._createClass(r,[{key:"running",get:function(){return(this._placementDirty||this._layerViewsDirty)&&(0<this._drapeSources.size||0<this.view.graphics.length||E.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}},{key:"_isSpherical",get:function(){return this.view.state.isGlobal}},
{key:"view",get:function(){return this.surface.view}},{key:"updating",get:function(){return this.running||this.renderer.updating}},{key:"hasHighlights",get:function(){return this.renderer.hasHighlights}},{key:"rendersOccluded",get:function(){return this.renderer.rendersOccluded}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},{key:"test",get:function(){return{renderer:this.renderer,update:()=>this.runTask()}}}]);return r}(P);n.__decorate([q.property()],l.OverlayManager.prototype,
"_spatialReference",void 0);n.__decorate([q.property({readOnly:!0})],l.OverlayManager.prototype,"running",null);n.__decorate([q.property()],l.OverlayManager.prototype,"_placementDirty",void 0);n.__decorate([q.property()],l.OverlayManager.prototype,"_layerViewsDirty",void 0);n.__decorate([q.property()],l.OverlayManager.prototype,"renderer",void 0);n.__decorate([q.property({constructOnly:!0})],l.OverlayManager.prototype,"surface",void 0);n.__decorate([q.property({readOnly:!0,aliasOf:"surface.suspended"})],
l.OverlayManager.prototype,"suspended",void 0);n.__decorate([q.property({readOnly:!0})],l.OverlayManager.prototype,"updating",null);n.__decorate([q.property({type:Boolean})],l.OverlayManager.prototype,"hasHighlights",null);n.__decorate([q.property({type:Boolean})],l.OverlayManager.prototype,"rendersOccluded",null);l.OverlayManager=n.__decorate([U.subclass("esri.views.3d.terrain.OverlayManager")],l.OverlayManager);const t=I.create(),B=H.create(),z={inner:k.create(),outer:k.create()},N=k.create(),la=
k.create(),ka=L.create();Object.defineProperty(l,"__esModule",{value:!0})});