// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../2d/engine/vectorTiles/SchemaHelper ../../2d/engine/vectorTiles/TileHandler3D ../../2d/engine/vectorTiles/VTLPainter3D ../../2d/engine/vectorTiles/style/StyleRepository ./LayerView3D ./TiledLayerView3D ../terrain/terrainUtils ../../layers/LayerView".split(" "),
function(r,e,t,u,G,f,c,U,V,W,H,I,w,x,y,J,K,L,M){c=function(z){function l(a){a=z.call(this,a)||this;a.type="vector-tile-3d";return a}r._inheritsLoose(l,z);var v=l.prototype;v.initialize=function(){var a=this._getTileInfoSupportError(L.test.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,this.layer.fullExtent);if(a)this.addResolvingPromise(Promise.reject(a));else{var {basemapTerrain:g,spatialReference:m,pixelRatio:h}=this.view;a=G.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>
{var b=g.tilingScheme,d=b.pixelSize;this.schemaHelper=new I(d,m.isGeographic);d=256===d?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;if(b=this._getTileInfoCompatibilityError(d,b))throw b;this._set("tileInfo",d)});this._tileHandlerController=u.createAbortController();var k=this.view.resourceController;this._memCache=k.memoryController.getMemCache(this.layer.uid,b=>b.release());var {style:N,spriteUrl:O,glyphsUrl:P}=this.layer.currentStyleInfo,
n=new y(N,{spriteUrl:O,glyphsUrl:P}),A=g.mapTileRequester;this._tileHandler=new w(this.layer,n,h,this._memCache,A);var B=this._tileHandlerController.signal,C=b=>k.schedule(b);n=this._tileHandler.start({signal:B,schedule:C});var D=this._tileHandler.spriteMosaic;D.then(b=>{!u.isAborted(B)&&this._tileHandler&&(this.painter=new x(b,this._tileHandler.glyphMosaic))});n.then(()=>this._tileHandlerController=null);var F=()=>{this._tileHandlerController&&this._tileHandlerController.abort();this._tileHandlerController=
u.createAbortController();this._memCache.clear();const {style:b,spriteUrl:d,glyphsUrl:Q}=this.layer.currentStyleInfo;var p=new y(b,{spriteUrl:d,glyphsUrl:Q});const q=new w(this.layer,p,h,this._memCache,A);p=q.start({signal:this._tileHandlerController.signal,schedule:C});const R=q.spriteMosaic;p.then(()=>this._tileHandlerController=null);this.updatingHandles.addPromise(Promise.all([p,R]).then(([,S])=>{const T=this._tileHandler,E=this.painter;this.painter=new x(S,q.glyphMosaic);this._tileHandler=q;
this.emit("data-changed");T.destroy();E&&E.dispose()}))};this.updatingHandles.add(this,"layer.currentStyleInfo",F);this.updatingHandles.add(this,"view.pixelRatio",F);a=Promise.all([a,n,D]);this.addResolvingPromise(a)}};v.destroy=function(){this.painter=t.disposeMaybe(this.painter);this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null);t.destroyMaybe(this._tileHandler);this._memCache=t.destroyMaybe(this._memCache);this._tileHandler=null};v.fetchTile=function(){var a=
r._asyncToGenerator(function*(g,m,h,k){return this._tileHandler.getVectorTile(g,m,h,k)});return function(g,m,h,k){return a.apply(this,arguments)}}();r._createClass(l,[{key:"dataLevelRange",get:function(){var a=this.tileInfo.lods;a=this.levelRangeFromScaleRange(a[0].scale,a[a.length-1].scale);1===a.minLevel&&256===this.tileInfo.size[0]&&(a.minLevel=0);return a}}]);return l}(K.TiledLayerView3D(J.LayerView3D(M)));e.__decorate([f.property({aliasOf:"layer.fullExtent"})],c.prototype,"fullExtent",void 0);
e.__decorate([f.property()],c.prototype,"layer",void 0);e.__decorate([f.property()],c.prototype,"tileInfo",void 0);e.__decorate([f.property()],c.prototype,"dataLevelRange",null);e.__decorate([f.property()],c.prototype,"updatingProgressValue",void 0);return c=e.__decorate([H.subclass("esri.views.3d.layers.VectorTileLayerView3D")],c)});