// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../webgl-engine/core/material/RenderTexture ../../webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl ../../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl ../../webgl-engine/core/shaderLibrary/util/EllipsoidMode ../../webgl-engine/lib/Texture".split(" "),function(l,B,u,q,r,w,x,C,m){function y(b){return b.sort((a,c)=>a.encoding-c.encoding)}function t(b,a,c){if(q.isNone(b)||
0===c)return null;for(let e=0;e<b.length;e++){const d=b[e];if(q.isSome(d)&&0!==(d.usage&c))return a[e].id}return null}function D(b){switch(b){case 1:return m.Texture.KTX2_ENCODING;case 2:return m.Texture.BASIS_ENCODING;case 4:return m.Texture.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}const E={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},z={[m.Texture.KTX2_ENCODING]:2,[m.Texture.BASIS_ENCODING]:2,[m.Texture.DDS_ENCODING]:4,"image/png":8,
"image/jpg":16,"image/jpeg":16,"image/ktx":32},F={s:33071,t:33071},G={s:10497,t:10497};l.configureMaterial=function(b,a,c,e,d,g){const f=g.rendererTextureUsage;var h=a.metallicRoughness.baseColorFactor;const v=u.clamp(a.metallicRoughness.baseColorFactor[3],0,1);b.baseColor=[h[0],h[1],h[2],v];b.hasParametersFromSource=!!a.hasParametersFromSource;b.usePBR=g.usePBR;b.mrrFactors=[a.metallicRoughness.metallicFactor,a.metallicRoughness.roughnessFactor,a.hasParametersFromSource?.2:.5];b.emissiveFactor=a.emissiveFactor;
b.isIntegratedMesh=g.isIntegratedMesh;b.alphaCutoff="mask"===a.alphaMode?a.alphaCutoff:x.defaultMaskAlphaCutoff;b.alphaDiscardMode="opaque"===a.alphaMode?1:"mask"===a.alphaMode?2:3;if(h=t(e,c,33&f))b.baseColorTexture=new r.RenderTexture(d,h);if(h=t(e,c,2&f))b.metallicRoughnessTexture=new r.RenderTexture(d,h);if(h=t(e,c,16&f))b.emissionTexture=new r.RenderTexture(d,h);if(h=t(e,c,8&f))b.occlusionTexture=new r.RenderTexture(d,h);if(c=t(e,c,4&f))b.normalTexture=new r.RenderTexture(d,c);b.commonMaterialParameters.slicePlaneEnabled=
g.slicePlaneEnabled;b.commonMaterialParameters.doubleSided=a.doubleSided;b.commonMaterialParameters.cullFace=a.cullFace;b.ellipsoidMode=C.getEllipsoidMode(g.viewSpatialReference)};l.createTexture=function(b,a,c,e){if(q.isNone(b)||null==b.data)return null;const d=b.data;var g=!(d instanceof HTMLImageElement)||u.isPowerOfTwo(d.width)&&u.isPowerOfTwo(d.height),f=e.renderingContext.parameters.maxMaxAnisotropy;e=c&&!e.has(2)?1:f;g=g&&!b.downsampled&&1<e;c=c||!a.wrapTextures?F:G;f=D(b.encoding);return new m.Texture(d,
{mipmap:g,maxAnisotropy:e,encoding:f,wrap:c,components:b.usage&1?"opaque"===a.alphaMode?3:4:3,noUnpackFlip:!0})};l.getMaterialAndTextures=function(b,a){const c=new Map,e=(k,p)=>{if(q.isNone(k))return-1;if(c.has(k.id))return k=c.get(k.id),k.usage|=p,k.id;const n=c.size;c.set(k.id,{id:n,usage:p});return n};var d=a.pbrMetallicRoughness;const g=d&&d.baseColorFactor,f=a.emissiveFactor,h=null==a.normalTexture&&null==a.emissiveTexture&&null==a.occlusionTexture&&(d?null==d.metallicRoughnessTexture&&1===d.roughnessFactor&&
(1===d.metallicFactor||0===d.metallicFactor):!0),v=h?w.PBRSchematicMRRValues[0]:d?d.metallicFactor:1,H=h?w.PBRSchematicMRRValues[1]:d?d.roughnessFactor:1;d={baseColorFactor:g?[g[0],g[1],g[2],g[3]]:[1,1,1,1],baseColorTextureId:e(d&&d.baseColorTexture,"mask"===a.alphaMode?33:1),metallicRoughnessTextureId:e(d&&d.metallicRoughnessTexture,2),metallicFactor:v,roughnessFactor:H};a={alphaMode:a.alphaMode,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,cullFace:"none"===a.cullFace?0:"back"===a.cullFace?
2:"front"===a.cullFace?1:void 0,normalTextureId:e(a.normalTexture,4),emissiveTextureId:e(a.emissiveTexture,16),occlusionTextureId:e(a.occlusionTexture,8),emissiveFactor:f?[f[0],f[1],f[2]]:[0,0,0],metallicRoughness:d,wrapTextures:!1,hasParametersFromSource:h};const A=[];c.forEach(({usage:k},p)=>{var n=q.isSome(b)&&b[p]&&b[p].formats;n=n?y(n.map(({name:I,format:J})=>({name:I,encoding:E[J]}))):[];A.push({id:p,usage:k,encodings:n})});return{material:a,textures:A}};l.getMaterialAndTexturesFromShared=function(b){var a=
b&&b.materialDefinitions?Object.keys(b.materialDefinitions)[0]:null,c=b&&b.textureDefinitions?Object.keys(b.textureDefinitions)[0]:null;a=a&&b.materialDefinitions[a];c=c&&b.textureDefinitions[c];b={alphaMode:"opaque",alphaCutoff:x.defaultMaskAlphaCutoff,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},
wrapTextures:!1,hasParametersFromSource:!0};if(null!=a){a=a.params;a.diffuse&&(b.metallicRoughness.baseColorFactor=[a.diffuse[0],a.diffuse[1],a.diffuse[2],1]);null!=a.doubleSided&&(b.doubleSided=a.doubleSided,b.cullFace=a.doubleSided?0:2);if("none"===a.cullFace||"front"===a.cullFace||"back"===a.cullFace)b.cullFace="none"===a.cullFace?0:"back"===a.cullFace?2:1;a.transparency&&(b.metallicRoughness.baseColorFactor[3]=u.clamp(1-a.transparency,0,1));if(a.useVertexColorAlpha||1>b.metallicRoughness.baseColorFactor[3])b.alphaMode=
"blend"}a=[];if(null!=c){!c.wrap||"repeat"!==c.wrap[0]&&"repeat"!==c.wrap[1]||(b.wrapTextures=!0);let e=1;"rgba"===c.channels&&(b.alphaMode="blend",e|=32);const d=c.images[c.images.length-1],g=f=>f&&f.split("/").pop();c=Array.isArray(c.encoding)?y(c.encoding.map((f,h)=>({name:g(d.href[h]),encoding:z[f]||0}))):[{name:g(d.href),encoding:z[c.encoding]||0}];a.push({id:0,usage:e,encodings:c});b.metallicRoughness.baseColorTextureId=0}return{material:b,textures:a}};l.getSupportedEncodings=function(b){const a=
b.has(1);b=b.has(0);const c=B("disable-feature:i3s-basis")?0:3;return 24|(a?c|4:0)|(b?c:0)};l.selectEncoding=function(b,a){return b.find(c=>0!==(c.encoding&a))};Object.defineProperty(l,"__esModule",{value:!0})});