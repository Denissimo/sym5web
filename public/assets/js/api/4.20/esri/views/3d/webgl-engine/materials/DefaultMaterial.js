// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/mat3f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../support/buffer/InterleavedLayout ../core/shaderLibrary/util/AlphaDiscard.glsl ../lib/GLMaterialTexture ../lib/Material ../lib/OrderIndependentTransparency ../lib/verticalOffsetUtils ./internal/bufferWriterUtils ./internal/MaterialUtil ../shaders/DefaultMaterialTechnique ../shaders/RealisticTreeTechnique".split(" "),function(t,u,E,f,l,v,F,G,w,H,I,J,x,y,K){let S=
function(g){function e(a){var b=g.call(this,a,L)||this;b.supportsEdges=!0;b.techniqueConfig=new y.DefaultMaterialTechniqueConfiguration;b.vertexBufferLayout=e.getVertexBufferLayout(b.params);b.instanceBufferLayout=a.instanced?e.getInstanceBufferLayout(b.params):null;return b}u._inheritsLoose(e,g);var c=e.prototype;c.isVisibleInPass=function(a){return 4===a||6===a||7===a?this.params.castShadows:!0};c.isVisible=function(){var a=this.params;if(!g.prototype.isVisible.call(this)||0===a.layerOpacity)return!1;
var b=a.instanced;const d=a.vertexColors,h=a.symbolColors;b=!!b&&-1<b.indexOf("color");const m=a.vvColorEnabled,k="replace"===a.colorMixMode,n=0<a.opacity;a=a.externalColor&&0<a.externalColor[3];return d&&(b||m||h)?k?!0:n:d?k?a:n:b||m||h?k?!0:n:k?a:n};c.getTechniqueConfig=function(a,b){this.techniqueConfig.output=a;this.techniqueConfig.hasNormalTexture=!!this.params.normalTextureId;this.techniqueConfig.hasColorTexture=!!this.params.textureId;this.techniqueConfig.vertexTangents=this.params.vertexTangents;
this.techniqueConfig.instanced=!!this.params.instanced;this.techniqueConfig.instancedDoublePrecision=this.params.instancedDoublePrecision;this.techniqueConfig.vvSize=this.params.vvSizeEnabled;this.techniqueConfig.verticalOffset=null!==this.params.verticalOffset;this.techniqueConfig.screenSizePerspective=null!==this.params.screenSizePerspective;this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.sliceHighlightDisabled=this.params.sliceHighlightDisabled;this.techniqueConfig.alphaDiscardMode=
this.params.textureAlphaMode;this.techniqueConfig.normalsTypeDerivate="screenDerivative"===this.params.normals?!0:!1;this.techniqueConfig.transparent=this.params.transparent;this.techniqueConfig.writeDepth=this.params.writeDepth;this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees;this.techniqueConfig.cullFace=this.params.slicePlaneEnabled?0:this.params.cullFace;this.techniqueConfig.multipassTerrainEnabled=b?b.multipassTerrainEnabled:!1;this.techniqueConfig.cullAboveGround=b?b.cullAboveGround:
!1;if(0===a||7===a)this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.symbolColors=this.params.symbolColors,this.techniqueConfig.doubleSidedMode=this.params.treeRendering?2:this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.instancedColor=!!this.params.instanced&&-1<this.params.instanced.indexOf("color"),this.techniqueConfig.receiveShadows=this.params.receiveShadows&&
this.params.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=b&&b.ssaoEnabled?this.params.receiveSSAO:!1,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.params.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.params.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.params.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.params.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=
!!this.params.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.params.transparent||!this.params.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.params.usePBR&&this.params.isSchematic,this.techniqueConfig.transparencyPassType=b?b.transparencyPassType:3,this.techniqueConfig.enableOffset=b?b.camera.relativeElevation<H.OITPolygonOffsetLimit:!0;return this.techniqueConfig};c.intersect=function(a,b,d,h,m,k,n){if(null!==this.params.verticalOffset){const z=h.camera;f.set(q,
d[12],d[13],d[14]);d=null;switch(h.viewingMode){case 1:d=f.normalize(A,q);break;case 2:d=f.copy(A,M)}let B=0;if(null!==this.params.verticalOffset){var p=f.subtract(N,q,z.eye);const C=f.length(p);p=f.scale(p,p,1/C);let D=null;this.params.screenSizePerspective&&(D=f.dot(d,p));B+=x.verticalOffsetAtDistance(z,C,this.params.verticalOffset,D,this.params.screenSizePerspective)}f.scale(d,d,B);f.transformMat3(r,d,h.transform.inverseRotation);m=f.subtract(O,m,r);k=f.subtract(P,k,r)}x.intersectTriangleGeometry(a,
b,h,m,k,I.getVerticalOffsetObject3D(h.verticalOffset),n)};c.getGLMaterial=function(a){if(0===a.output||7===a.output||1===a.output||2===a.output||3===a.output||4===a.output)return new Q(a)};c.createBufferWriter=function(){return new R(this.vertexBufferLayout,this.instanceBufferLayout)};e.getVertexBufferLayout=function(a){const b=a.textureId||a.normalTextureId||a.metallicRoughnessTextureId||a.emissiveTextureId||a.occlusionTextureId,d=v.newLayout().vec3f("position").vec3f("normal");a.vertexTangents&&
d.vec4f("tangent");b&&d.vec2f("uv0");a.vertexColors&&d.vec4u8("color");a.symbolColors&&d.vec4u8("symbolColor");return d};e.getInstanceBufferLayout=function(a){let b=v.newLayout();b=a.instancedDoublePrecision?b.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):b.mat4f("model").mat4f("modelNormal");a.instanced&&-1<a.instanced.indexOf("color")&&(b=b.vec4f("instanceColor"));a.instanced&&-1<a.instanced.indexOf("featureAttribute")&&(b=b.vec4f("instanceFeatureAttribute"));
return b};return e}(w.Material),Q=function(g){function e(a){a=g.call(this,{...a,...a.material.params})||this;a.updateParameters();return a}u._inheritsLoose(e,g);var c=e.prototype;c.updateParameters=function(a){const b=this._material.params;this.updateTexture(b.textureId);this._technique=this._techniqueRep.releaseAndAcquire(b.treeRendering?K.RealisticTreeTechnique:y.DefaultMaterialTechnique,this._material.getTechniqueConfig(this._output,a),this._technique)};c.selectPipelines=function(){};c._updateShadowState=
function(a){a.shadowMappingEnabled!==this._material.params.shadowMappingEnabled&&this._material.setParameterValues({shadowMappingEnabled:a.shadowMappingEnabled})};c._updateOccludeeState=function(a){a.hasOccludees!==this._material.params.sceneHasOcludees&&this._material.setParameterValues({sceneHasOcludees:a.hasOccludees})};c.ensureParameters=function(a){if(0===this._output||7===this._output)this._updateShadowState(a),this._updateOccludeeState(a);this.updateParameters(a)};c.bind=function(a){this._technique.bindPass(this._material.params,
a);this.bindTextures(this._technique.program)};c.beginSlot=function(a){return a===(this._material.params.transparent?this._material.params.writeDepth?5:8:3)};c.getPipelineState=function(a,b){return this._technique.getPipelineState(b)};return e}(G);const L={textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,
.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:2,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,
100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:E.create(),transparent:!1,writeDepth:!0,textureAlphaMode:0,textureAlphaCutoff:F.defaultMaskAlphaCutoff,textureAlphaPremultiplied:!1,sceneHasOcludees:!1,...w.materialParametersDefaults};let R=function(){function g(c,a){this.vertexBufferLayout=c;this.instanceBufferLayout=
a}var e=g.prototype;e.allocate=function(c){return this.vertexBufferLayout.createBuffer(c)};e.elementCount=function(c){return c.indices.get("position").length};e.write=function(c,a,b,d){J.writeDefaultAttributes(a,this.vertexBufferLayout,c.transformation,c.invTranspTransformation,b,d)};return g}();const O=l.create(),P=l.create(),M=l.fromValues(0,0,1),A=l.create(),r=l.create(),q=l.create(),N=l.create();t.DefaultMaterial=S;Object.defineProperty(t,"__esModule",{value:!0})});