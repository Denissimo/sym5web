// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../geometry/projection ../../../geometry/support/spatialReferenceUtils ../../../layers/support/layerUtils ./terrainUtils ./TilingScheme".split(" "),function(b,q,d,r,
t,f,w,x,y,z,u,m,n,v,k,h){b.SurfaceTilingSchemeLogic=function(p){function l(a){a=p.call(this,a)||this;a._handles=new t;return a}q._inheritsLoose(l,p);var g=l.prototype;g.initialize=function(){this._handles.add(this.layers.on("change",()=>this._update()));this._handles.add(this.extentHelper.watch("layerViewsExtent",()=>this._setAdHocTilingScheme()));this._update();this.tilingSchemeLocked||this._setAdHocTilingScheme()};g.destroy=function(){this._handles.destroy();this._waitTask=this._handles=null};g._update=
function(){this._waitTask=null;if(!this.tilingSchemeLocked){this._set("tilingSchemeDone",!1);var a;this.layers.some(e=>!v.isTiledLayer(e)||e.isRejected()?!1:!e.isFulfilled()||k.getTiledLayerInfo(e,this.viewSpatialReference,this.viewingMode).tileInfo?(a=e,!k.isVectorTileLayer(e)&&!k.isProjectableRasterLayer(e)):!1);if(a)if(a.isResolved()){var {tileInfo:c}=k.getTiledLayerInfo(a,this.viewSpatialReference,this.viewingMode);c=new h(c);this._set("tilingSchemeDone",!0);this._lockTilingScheme(c)}else this._updateWhen(a);
else this._set("tilingSchemeDone",!0)}};g._updateWhen=function(a){const c=a.when().catch(e=>e).then(()=>{c!==this._waitTask||this.destroyed||this._update()});this._waitTask=c};g._lockTilingScheme=function(a){if(1===this.viewingMode){const c=a.levels.length-1;a.spatialReference.isWebMercator?a=h.makeWebMercatorAuxiliarySphere(c):m.canProjectToWGS84ComparableLonLat(a.spatialReference)&&(a=h.makeGCSWithTileSize(a.spatialReference,a.pixelSize,c))}this.tilingSchemeLocked=!0;this.tilingScheme=a;this.extentHelper.tilingScheme=
this.tilingScheme;this._updateTiledLayerExtent();this._handles.removeAll();this._handles.add(this.extentHelper.watch("tiledLayersExtent",()=>this._updateTiledLayerExtent()))};g._updateTiledLayerExtent=function(){this.extent=this.extentHelper.tiledLayersExtent};g._setAdHocTilingScheme=function(){if(1===this.viewingMode){var a=this.extentHelper.spatialReference;const c=m.canProjectToWGS84ComparableLonLat(a)||n.isMars(a)||n.isMoon(a);a.isWebMercator?this.tilingScheme=h.WebMercatorAuxiliarySphere:c&&
(this.tilingScheme=h.makeGCSWithTileSize(a,256));this.extent=this.extentHelper.layerViewsExtent}else if(a=this.extentHelper.layerViewsExtent)this.tilingScheme=h.fromExtent(a,this.extentHelper.spatialReference),this.extent=a};return l}(r);d.__decorate([f.property()],b.SurfaceTilingSchemeLogic.prototype,"tilingScheme",void 0);d.__decorate([f.property()],b.SurfaceTilingSchemeLogic.prototype,"extent",void 0);d.__decorate([f.property({value:!1})],b.SurfaceTilingSchemeLogic.prototype,"tilingSchemeLocked",
void 0);d.__decorate([f.property({readOnly:!0,value:!1})],b.SurfaceTilingSchemeLogic.prototype,"tilingSchemeDone",void 0);d.__decorate([f.property({constructOnly:!0})],b.SurfaceTilingSchemeLogic.prototype,"viewSpatialReference",void 0);d.__decorate([f.property({constructOnly:!0})],b.SurfaceTilingSchemeLogic.prototype,"layers",void 0);d.__decorate([f.property({constructOnly:!0})],b.SurfaceTilingSchemeLogic.prototype,"extentHelper",void 0);d.__decorate([f.property({constructOnly:!0})],b.SurfaceTilingSchemeLogic.prototype,
"viewingMode",void 0);b.SurfaceTilingSchemeLogic=d.__decorate([u.subclass("esri.views.3d.terrain.SurfaceTilingSchemeLogic")],b.SurfaceTilingSchemeLogic);Object.defineProperty(b,"__esModule",{value:!0})});