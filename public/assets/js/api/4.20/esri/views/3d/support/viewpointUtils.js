// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../Camera ../../../geometry ../../../Graphic ../../../Viewpoint ../../../core/asyncUtils ../../../core/has ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/frustum ../../../geometry/support/webMercatorUtils ../camera/intersectionUtils ./cameraUtils ./ElevationProvider ./mathUtils ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Geometry ../../../geometry/Point".split(" "),
function(y,u,ea,Da,pa,K,fa,Ea,L,n,qa,ha,ra,sa,m,D,v,q,ia,ta,x,A,h,ja,ka,M,ua,va,E){function N(a){return 360-ka.cyclicalDeg.normalize(a)}function B(a){return ka.cyclicalDeg.normalize(360-a)}function F(a){n.isSome(a)&&a.resolver&&a.resolver.reject();return null}function la(a,b,c,d=null){if(!b)return F(d);var e=a.spatialReference||M.WGS84;if(n.isSome(b.camera)){a=b.get("camera.position.spatialReference");if(!x.canProject(a,e))return F(d);b=b.camera.clone();a.equals(e)||(b.position=x.project(b.position,
e));a=b;n.isSome(d)&&d.resolver&&d.resolver.resolve(a);return a}if(n.isNone(b.targetGeometry))return F(d);var f=b.get("targetGeometry.spatialReference");if(f&&!x.canProject(f,e))return F(d);e=h.internalToExternal(a,a.state.camera);f=1;null!=b.rotation&&(e.heading=N(b.rotation),f=0);null!=c&&(e.tilt=c);if("point"===b.targetGeometry.type){const g=b.targetGeometry;c=b.targetGeometry.clone();b=null!=b.scale?h.scaleToDistance(a,b.scale,g.latitude):a.state.camera.distance;return h.fromCenterDistance(a,
c,b,e,f,d)}return h.fromExtent(a,b.targetGeometry.extent,e.heading,e.tilt,f,d)}function O(){O=u._asyncToGenerator(function*(a,b,c){if(b&&a.spatialReference){var d={target:null};if("declaredClass"in b||Array.isArray(b))d.target=b;else{for(var e in b)d[e]=b[e];b.center&&!d.target&&(d.target=b.center)}b=d}else b=null;if(!b)throw new L("viewpointutils-create:no-target","Missing target for creating viewpoint");d=new ea({fov:a.camera.fov});e=new K({camera:d});if(b.target instanceof K)return a=yield wa(a,
b.target,b,c,e),w(a);if(b.target instanceof ea)return w(ma(a,b.target,e));var f=null!=b.scale||null!=b.zoom;if(b.target instanceof ua){var g=b.target.xmin===b.target.xmax||b.target.ymin===b.target.ymax;return f||g?w(yield P(a,b,b.target.center,d,c,e)):w(yield xa(a,b,b.target,d,c,e))}g={boundingBox:q.empty(),hasZ:!1,screenSpaceObjects:[]};var l=f?h.scaleToResolution(a,Q(a,b)):void 0;yield na(a,b.target,l,g);if(isFinite(g.boundingBox[0])){q.center(g.boundingBox,k);p.x=k[0];p.y=k[1];p.z=k[2];p.spatialReference=
a.spatialReference;isFinite(p.z)&&g.hasZ?l=q.isPoint(g.boundingBox):(p.z=void 0,l=ia.isPoint(q.toRect(g.boundingBox,ya)));if(f||l)return w(yield P(a,b,p,d,c,e));f=g.screenSpaceObjects;if(f.length){l=Number.NEGATIVE_INFINITY;for(let t=0;t<f.length;t++){const r=f[t].screenSpaceBoundingRect;l=Math.max(l,Math.abs(r[0]),Math.abs(r[1]),Math.abs(r[2]),Math.abs(r[3]))}f=.66-l/Math.min(a.width,a.height)*2}else f=.66;return w(yield za(a,b,p,g.boundingBox,f,d,c,e))}return b.position?(c=A.cameraOnContentAlongViewDirection(a),
m.copy(G,c.viewForward),h.directionToHeadingTilt(a,c.eye,G,c.up,R),d.position=new E(b.position),d.heading=null!=b.heading?b.heading:R.heading,d.tilt=null!=b.tilt?b.tilt:R.tilt,a=S(a,null,d,e),w(a)):w(yield Aa(a,b,d,c,e))});return O.apply(this,arguments)}function Q(a,b){return null==b.scale&&null!=b.zoom?h.zoomToScale(a,b.zoom):b.scale}function T(a,b){let c=!1;null!=b.heading?(a.heading=b.heading,c=!0):null!=b.rotation&&(a.heading=N(b.rotation),c=!0);null!=b.tilt&&(a.tilt=b.tilt,c=!0);null!=b.fov&&
(a.fov=b.fov);return c}function S(a,b,c,d){const e=a.spatialReference||M.WGS84;b=n.isSome(b)?b:h.externalToInternal(a,c);if(n.isNone(b))return d;d.targetGeometry=v.projectVectorToPoint(b.center,a.renderSpatialReference,e);d.scale=h.computeScale(a,b);d.rotation=B(c.heading);d.camera=c;return d}function H(a,b,c){if(b){if(!x.canProject(b.spatialReference,a.spatialReference))throw new L("viewpointutils:incompatible-spatialreference",`Spatial reference (${b.spatialReference?b.spatialReference.wkid:"unknown"}) is incompatible with the view (${a.spatialReference.wkid})`,
{geometry:b});var d=[];if(!b.hasZ&&a.basemapTerrain){switch(b.type){case "point":var e=b;break;case "multipoint":case "polyline":e=b.extent.center;break;case "mesh":e=b.origin;break;case "extent":e=b.center;break;case "polygon":e=b.centroid}e&&x.canProject(e,a.basemapTerrain.spatialReference)?k[2]=n.unwrapOr(ja.getElevationAtPoint(a.elevationProvider,e),0):k[2]=0}(0,Ba[b.type])(b,g=>{d.push(g[0],g[1],g[2])},k);var f=d.length/3;if(0!==f&&(e=Array(d.length),v.projectBuffer(d,b.spatialReference,0,e,
a.spatialReference,0,f)))for(b.hasZ&&(c.hasZ=!0),a=0;a<e.length;a+=3)b.hasZ?(k[0]=e[a+0],k[1]=e[a+1],k[2]=e[a+2]):(k[0]=e[a+0],k[1]=e[a+1]),q.expandWithVec3(c.boundingBox,k)}}function Ca(a,b,c,d){return U.apply(this,arguments)}function U(){U=u._asyncToGenerator(function*(a,b,c,d){const e=yield fa.result(a.whenViewForGraphic(b));if(!1!==e.ok&&!n.isNone(e.value)&&"whenGraphicBounds"in e.value)if(c=yield fa.result(e.value.whenGraphicBounds(b,{minDemResolution:c})),!1===c.ok)H(a,b.geometry,d);else{var {screenSpaceObjects:f,
boundingBox:g}=c.value;q.expandWithAABB(d.boundingBox,g);f&&f.forEach(l=>{d.screenSpaceObjects.push(l)});isFinite(g[2])&&(d.hasZ=!0)}else H(a,b.geometry,d)});return U.apply(this,arguments)}function na(a,b,c,d){return V.apply(this,arguments)}function V(){V=u._asyncToGenerator(function*(a,b,c,d){if(Array.isArray(b)&&2===b.length){const e=b[0],f=b[1];if("number"===typeof e&&"number"===typeof f){p.x=e;p.y=f;p.z=void 0;p.spatialReference=a.spatialReference.isGeographic?a.spatialReference:M.WGS84;H(a,p,
d);return}}b&&"function"===typeof b.map?yield qa.eachAlways(b.map(e=>na(a,e,c,d))):b instanceof va?H(a,b,d):b instanceof pa&&(yield Ca(a,b,c,d))});return V.apply(this,arguments)}function wa(a,b,c,d,e){return W.apply(this,arguments)}function W(){W=u._asyncToGenerator(function*(a,b,c,d,e){if(n.isSome(b.camera))return ma(a,b.camera,e);e.scale=b.scale;e.rotation=b.rotation;e.targetGeometry=n.isSome(b.targetGeometry)?b.targetGeometry.clone():null;e.camera=null;null!=c.heading?e.rotation=B(c.heading):null!=
c.rotation&&(e.rotation=c.rotation);b=Q(a,c);null!=b&&(e.scale=b);d=new h.AsyncContext(d);la(a,e,c.tilt,d);e.camera=yield d.resolver.promise;return e});return W.apply(this,arguments)}function ma(a,b,c){const d=a.spatialReference,e=b.position.spatialReference;if(!x.canProject(e,d))return null;b=b.clone();b.fov=a.camera.fov;e.equals(d)||(b.position=x.project(b.position,d));return S(a,null,b,c)}function P(a,b,c,d,e,f){return X.apply(this,arguments)}function X(){X=u._asyncToGenerator(function*(a,b,c,
d,e,f){if(n.isNone(c))throw new L("createfromcenter","invalid point");f.targetGeometry=c.clone();const g=A.cameraOnContentAlongViewDirection(a);if(b.position)return c=f.targetGeometry,e=a.renderSpatialReference,v.projectPointToVector(b.position,I,e),v.projectPointToVector(c,Y,e),f.targetGeometry=new E(c),d.position=new E(b.position),m.subtract(G,Y,I),h.directionToHeadingTilt(a,I,G,g.up,d),f.scale=h.distanceToScale(a,m.distance(I,Y),f.targetGeometry.latitude),f.rotation=B(d.heading),f.camera=d,f;if(b.zoomFactor){var l=
g.distance/b.zoomFactor;const t=m.scale(k,g.viewForward,-l);g.eye=m.add(k,g.center,t);f.scale=h.distanceToScale(a,l,c.latitude)}h.internalToExternal(a,g,d);l=T(d,b)?0:1;b.zoomFactor||(f.scale=Q(a,b),null==f.scale&&(v.projectPointToVector(c,k,a.renderSpatialReference),ta.intersectsPoint(g.frustum,k)?f.scale=h.distanceToScale(a,m.distance(g.eye,k),c.latitude):f.scale=h.computeScale(a,g)),b=new h.AsyncContext(e),h.fromCenterScale(a,f.targetGeometry,f.scale,d,l,b),f.camera=yield b.resolver.promise);return f});
return X.apply(this,arguments)}function Aa(a,b,c,d,e){return Z.apply(this,arguments)}function Z(){Z=u._asyncToGenerator(function*(a,b,c,d,e){var f=A.cameraOnContentAlongViewDirection(a);f=v.projectVectorToPoint(f.center,a.renderSpatialReference,a.spatialReference);return P(a,b,f,c,d,e)});return Z.apply(this,arguments)}function xa(a,b,c,d,e,f){return aa.apply(this,arguments)}function aa(){aa=u._asyncToGenerator(function*(a,b,c,d,e,f){f.targetGeometry=c.clone();const g=A.cameraOnContentAlongViewDirection(a);
h.internalToExternal(a,g,d);b=T(d,b)?0:1;e=new h.AsyncContext(e);h.fromExtent(a,c,d.heading,d.tilt,b,e);f.camera=yield e.resolver.promise;return f});return aa.apply(this,arguments)}function za(a,b,c,d,e,f,g,l){return ba.apply(this,arguments)}function ba(){ba=u._asyncToGenerator(function*(a,b,c,d,e,f,g,l){l.targetGeometry=c.clone();const t=A.cameraOnContentAlongViewDirection(a);var r=0;c.hasZ?r=c.z:a.basemapTerrain&&(r=n.unwrap(ja.getElevationAtPoint(a.elevationProvider,c)));m.set(k,c.x,c.y,r);v.computeLinearTransformation(a.spatialReference,
k,oa,a.renderSpatialReference);ha.fromMat4(J,oa);ha.transpose(J,J);q.empty(C);c=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(var z=0;z<c.length;z++){const ca=c[z];let da=d[ca[2]];isFinite(da)||(da=r);m.set(k,d[ca[0]],d[ca[1]],da);v.projectVectorToVector(k,a.spatialReference,k,a.renderSpatialReference);q.expandWithVec3(C,m.transformMat3(k,k,J))}d=q.width(C);r=q.height(C);c=q.depth(C);z=1/Math.tan(t.fovY/2);e=Math.max(.5*Math.sqrt(d*d+c*c)*Math.max(z,1/Math.tan(t.fovX/2))+.5*
r,.5*r*z+.5*Math.max(d,c))/e;h.internalToExternal(a,t,f);b=T(f,b)?0:1;l.scale=h.distanceToScale(a,e,l.targetGeometry.latitude);g=new h.AsyncContext(g);h.fromCenterScale(a,l.targetGeometry,l.scale,f,b,g);l.camera=yield g.resolver.promise;return l});return ba.apply(this,arguments)}function w(a){a&&n.isSome(a.camera)&&(a.rotation=B(a.camera.heading));return a}const k=D.create(),oa=sa.create(),J=ra.create(),C=q.create(),ya=ia.create(),G=D.create(),I=D.create(),Y=D.create(),R={heading:0,tilt:0},p=new E,
Ba={point(a,b,c){c[0]=a.x;c[1]=a.y;a.hasZ&&(c[2]=a.z);b(c)},polygon(a,b,c){const d=a.hasZ;for(let e=0;e<a.rings.length;e++){const f=a.rings[e];for(let g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],d&&(c[2]=f[g][2]),b(c)}},polyline(a,b,c){const d=a.hasZ;for(let e=0;e<a.paths.length;e++){const f=a.paths[e];for(let g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],d&&(c[2]=f[g][2]),b(c)}},multipoint(a,b,c){const d=a.points;a=a.hasZ;for(let e=0;e<d.length;e++)c[0]=d[e][0],c[1]=d[e][1],a&&(c[2]=d[e][2]),b(c)},
extent(a,b,c){a.hasZ?(b(m.set(c,a.xmin,a.ymin,a.zmin)),b(m.set(c,a.xmax,a.ymin,a.zmin)),b(m.set(c,a.xmin,a.ymax,a.zmin)),b(m.set(c,a.xmax,a.ymax,a.zmin)),b(m.set(c,a.xmin,a.ymin,a.zmax)),b(m.set(c,a.xmax,a.ymin,a.zmax)),b(m.set(c,a.xmin,a.ymax,a.zmax)),b(m.set(c,a.xmax,a.ymax,a.zmax))):(b(m.set(c,a.xmin,a.ymin,c[2])),b(m.set(c,a.xmax,a.ymin,c[2])),b(m.set(c,a.xmin,a.ymax,c[2])),b(m.set(c,a.xmax,a.ymax,c[2])))},mesh(a,b,c){if(a=a.vertexAttributes&&a.vertexAttributes.position)for(let d=0;d<a.length;d+=
3)b(m.set(c,a[d+0],a[d+1],a[d+2]))}};y.create=function(a,b,c){return O.apply(this,arguments)};y.fromCamera=function(a,b,c=null){n.isNone(c)&&(c=new K);return S(a,null,b.clone(),c)};y.headingToRotation=B;y.rotationToHeading=N;y.toCamera=la;Object.defineProperty(y,"__esModule",{value:!0})});