// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Logger ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../../../geometry/support/buffer/BufferView ../lib/geometryDataUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./internal/bufferWriterUtils ./internal/DefaultBufferWriter ./internal/MaterialUtil ./renderers/utils ../shaders/NativeLineTechnique".split(" "),
function(L,M,D,E,A,S,k,r,w,e,T,U,V,N,W,X,F,Y,Z,O){const aa=D.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");D=function(v){function q(a){a=v.call(this,a,ba)||this;a.techniqueConfig=new O.NativeLineTechniqueConfiguration;return a}M._inheritsLoose(q,v);var b=q.prototype;b.getTechniqueConfig=function(a){this.techniqueConfig.output=a;this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.vertexColors=this.params.vertexColors;this.techniqueConfig.transparent=
1>this.params.color[3]||1>this.params.width;a=E.isSome(this.params.stipplePattern);this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleOffColorEnabled=a&&E.isSome(this.params.stippleOffColor);this.techniqueConfig.stippleIntegerRepeatsEnabled=a&&this.params.stippleIntegerRepeats;this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees;return this.techniqueConfig};b.getPassParameters=function(){return this.params};b.intersect=function(a,c,d,l,B,g,h,f,p){p?Y.intersectDrapedRenderLineGeometry(a,
l,g,1,h):this.intersectLineGeometry(a,c,d,l,h)};b.intersectLineGeometry=function(a,c,d,l,B){if(l.options.selectionMode&&!Z.isInstanceHidden(c))if(W.isTranslationMatrix(d)){c=a.vertexAttributes.get("position").data;var g=l.camera,h=ca;S.copy(h,l.point);k.set(C[0],h[0]-2,h[1]+2,0);k.set(C[1],h[0]+2,h[1]+2,0);k.set(C[2],h[0]+2,h[1]-2,0);k.set(C[3],h[0]-2,h[1]-2,0);for(a=0;4>a;a++)if(!g.unprojectFromRenderScreen(C[a],u[a]))return;e.fromPoints(g.eye,u[0],u[1],G);e.fromPoints(g.eye,u[1],u[2],H);e.fromPoints(g.eye,
u[2],u[3],I);e.fromPoints(g.eye,u[3],u[0],J);a=Number.MAX_VALUE;for(let p=0;p<c.length-5;p+=3)if(m[0]=c[p]+d[12],m[1]=c[p+1]+d[13],m[2]=c[p+2]+d[14],n[0]=c[p+3]+d[12],n[1]=c[p+4]+d[13],n[2]=c[p+5]+d[14],!(0>e.signedDistance(G,m)&&0>e.signedDistance(G,n)||0>e.signedDistance(H,m)&&0>e.signedDistance(H,n)||0>e.signedDistance(I,m)&&0>e.signedDistance(I,n)||0>e.signedDistance(J,m)&&0>e.signedDistance(J,n))){g.projectToRenderScreen(m,x);g.projectToRenderScreen(n,y);if(0>x[2]&&0<y[2]){k.subtract(t,m,n);
var f=g.frustum;f=-e.signedDistance(f[4],m)/k.dot(t,e.normal(f[4]));k.scale(t,t,f);k.add(m,m,t);g.projectToRenderScreen(m,x)}else if(0<x[2]&&0>y[2])k.subtract(t,n,m),f=g.frustum,f=-e.signedDistance(f[4],n)/k.dot(t,e.normal(f[4])),k.scale(t,t,f),k.add(n,n,t),g.projectToRenderScreen(n,y);else if(0>x[2]&&0>y[2])continue;x[2]=0;y[2]=0;f=w.distance2(w.fromPoints(x,y,P),h);f<a&&(a=f,k.copy(Q,m),k.copy(R,n))}d=l.rayBeginPoint;l=l.rayEndPoint;4>a&&(a=Number.MAX_VALUE,w.closestLineSegmentPoint(w.fromPoints(Q,
R,P),w.fromPoints(d,l,da),z)&&(k.subtract(z,z,d),a=k.length(z),k.scale(z,z,1/a),a/=k.distance(d,l)),B(a,z))}else aa.error("intersection assumes a translation-only matrix")};b.computeAttachmentOrigin=function(a,c){a=a.vertexAttributes;if(!a)return!1;a=a.get("position");return U.computeAttachmentOriginLines(a,null,!1,c)};b.createBufferWriter=function(){const a=this.params.vertexColors?F.PositionColorLayout:F.PositionLayout;return E.isNone(this.params.stipplePattern)?new F.DefaultBufferWriter(a):new ea(a.clone().vec3f("auxpos1"))};
b.getGLMaterial=function(a){return 0===a.output||4===a.output?new fa(a):void 0};return q}(N.Material);let fa=function(v){function q(a){a=v.call(this,a)||this;a.updateParameters();return a}M._inheritsLoose(q,v);var b=q.prototype;b.updateParameters=function(){this._technique=this._techniqueRep.releaseAndAcquire(O.NativeLineTechnique,this._material.getTechniqueConfig(this._output),this._technique)};b.beginSlot=function(a){return 3===a};b._updateOccludeeState=function(a){a.hasOccludees!==this._material.params.sceneHasOcludees&&
(this._material.setParameterValues({sceneHasOcludees:a.hasOccludees}),this.updateParameters())};b.ensureParameters=function(a){0===this._output&&this._updateOccludeeState(a)};b.bind=function(a){this._technique.bindPass(this._material.getPassParameters(),a)};b.getPipelineState=function(a,c){return this._technique.getPipelineState(c)};return q}(V),ea=function(){function v(b){this.vertexBufferLayout=b}var q=v.prototype;q.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};q.elementCount=
function(b){return b.indices.get("position").length};q.write=function(b,a,c,d){X.writeDefaultAttributes(a,this.vertexBufferLayout,b.transformation,b.invTranspTransformation,c,d);this.writeAuxpos1(b,a,c,d)};q.writeAuxpos1=function(b,a,c,d){var l=c.getField("auxpos1",T.BufferViewVec3f);c=a.indices.get("position");a=a.vertexAttributes.get("position").data;b=b.transformation;const B=l.typedBufferStride;l=l.typedBuffer;d*=B;for(let p=0;p<c.length;p+=2){var g=3*c[p],h=a[g],f=a[g+1];const K=a[g+2];g=b[0]*
h+b[4]*f+b[8]*K+b[12];const ha=b[1]*h+b[5]*f+b[9]*K+b[13];h=b[2]*h+b[6]*f+b[10]*K+b[14];for(f=0;2>f;++f)l[d]=g,l[d+1]=ha,l[d+2]=h,d+=B}};return v}();const ba={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1,...N.materialParametersDefaults},m=r.create(),n=r.create(),t=r.create(),z=r.create(),x=A.createRenderScreenPointArray3(),y=A.createRenderScreenPointArray3(),Q=r.create(),R=r.create(),P=w.create(),
da=w.create(),ca=r.create(),C=[A.createRenderScreenPointArray3(),A.createRenderScreenPointArray3(),A.createRenderScreenPointArray3(),A.createRenderScreenPointArray3()],u=[r.create(),r.create(),r.create(),r.create()],G=e.create(),H=e.create(),I=e.create(),J=e.create();L.NativeLineMaterial=D;Object.defineProperty(L,"__esModule",{value:!0})});