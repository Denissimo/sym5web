// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../core/mathUtils ../../../core/maybe ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4 ../../../chunks/vec4f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/buffer/BufferPool ../support/buffer/InterleavedLayout ./ElevationData ./TerrainConst ../webgl-engine/materials/internal/MaterialUtil".split(" "),function(N,ha,O,S,X,Y,ia,T,ja,ka,Z,L,la){function aa(a,c,k,g){const D=0<(k&2),E=c+(g?1024:0)+(D?2048:0);var n=U.get(E);if(!n){{n=c-1;const u=
c-1,I=c*c;var b=2*n+2*u;let C=n*u*6,F=6*b,A=6*(2*n+u-1);g&&(C*=2,F*=2,A*=2);b=65536<I+b?new Uint32Array(C+F):new Uint16Array(C+F);let v=0,e=0,d=C,h,l;let z=0;for(let m=0;m<=u;m++){D&&(z=0===m?A:m===u?-A:0);d+=z;for(let q=0;q<=n;q++){var f=V(q,m,n,u);if(-1<f){var p=0===m&&q!==n?1:q===n&&m!==u?n+1:m===u&&0!==q?-1:0===q&&0!==m?-(n+1):0;0!==p&&(h=v,l=I+f,f=I+(0===q&&1===m?0:f+1),p=v+p,g?(b[d+0]=h,b[d+1]=l,b[d+2]=l,b[d+3]=f,b[d+4]=f,b[d+5]=h,b[d+6]=f,b[d+7]=p,b[d+8]=p,b[d+9]=h,b[d+10]=h,b[d+11]=f,d+=12):
(b[d+0]=h,b[d+1]=l,b[d+2]=f,b[d+3]=f,b[d+4]=p,b[d+5]=h,d+=6))}++v;q<n&&m<u&&(h=m*(n+1)+q,l=h+1,f=l+(n+1),p=f-1,g?(b[e+0]=h,b[e+1]=l,b[e+2]=l,b[e+3]=f,b[e+4]=f,b[e+5]=h,b[e+6]=f,b[e+7]=p,b[e+8]=p,b[e+9]=h,b[e+10]=h,b[e+11]=f,e+=12):(b[e+0]=h,b[e+1]=l,b[e+2]=f,b[e+3]=f,b[e+4]=p,b[e+5]=h,e+=6))}d-=z}n=new ma(b,C,F)}U.set(E,n)}a.indices=n.values;a.numSurfaceIndices=n.numSurfaceIndices;a.numSkirtIndices=n.numSkirtIndices;a.numWithoutSkirtIndices=a.numSurfaceIndices+(k?6*(c-1)*(g?2:1):0)}function W(a,c,
k,g){a<g[0]&&(g[0]=a);a>g[3]&&(g[3]=a);c<g[1]&&(g[1]=c);c>g[4]&&(g[4]=c);k<g[2]&&(g[2]=k);k>g[5]&&(g[5]=k)}function ba(a,c){const k=c>a?1:0;return 2+4*k+(1-2*k)*(a+c)}function V(a,c,k,g){return 0===c?a:a===k?k+c:c===g?k+g+(k-a):0===a&&0<c?2*k+g+(g-c):-1}const na=ka.newLayout().vec3f("position").vec2f("uv0"),R=new ja.BufferPool(a=>na.createBuffer(a),a=>a.count);let ma=function(a,c,k){this.values=a;this.numSurfaceIndices=c;this.numSkirtIndices=k};const U=new Map,ca=Array(L.MAX_PATCH_TESSELATION+1),
da=Array(L.MAX_PATCH_TESSELATION+1),ea=Array(L.MAX_PATCH_TESSELATION+1),fa=Array(L.MAX_PATCH_TESSELATION+1),H=X.create(),oa=X.create();N.PatchGeometry=function(){this.vertexAttributes=this.indices=null;this.boundingBox=T.empty();this.skirtLength=this.numVertsPerRow=this.numWithoutSkirtIndices=this.numSkirtIndices=this.numSurfaceIndices=0;this.uvOffsetAndScale=ia.create()};N.clearCaches=function(){R.clear();U.clear()};N.createPlanarGlobePatch=function(a,c,k,g){const D=c[0],E=c[1],n=c[2]-D,b=c[3]-E,
f=a.clippingArea,p=O.isSome(f)?Math.max(0,(f[0]-c[0])/n):0,u=O.isSome(f)?Math.max(0,(f[1]-c[1])/b):0,I=O.isSome(f)?Math.min(1,(f[2]-c[0])/n):1;c=O.isSome(f)?Math.min(1,(f[3]-c[1])/b):1;const C=I>p?1/(I-p):1,F=c>u?1/(c-u):1,A=-p*C,v=-u*F,e=.1*n,d=a.numVertsPerRow-1,h=a.numVertsPerRow-1,l=a.numVertsPerRow*a.numVertsPerRow,z=R.acquire(l+(2*d+2*h)),m=z.position.typedBuffer,q=z.uv0.typedBuffer,r=g.geometryInfo.boundingBox;T.empty(r);let y=0;for(let G=0;G<=h;G++){var t=G/h;let B=v+t*F;t=E+t*b;O.isSome(f)&&
(t<f[1]?(t=f[1],B=0):t>f[3]&&(t=f[3],B=1));for(let M=0;M<=d;M++){var w=M/d;let K=A+w*C;w=D+w*n;O.isSome(f)&&(w<f[0]?(w=f[0],K=0):w>f[2]&&(w=f[2],K=1));var J=a.samplerData?Z.ElevationData.sample(w,t,a.samplerData)||0:0;w-=k[0];const P=t-k[1];J-=k[2];W(w,P,J,r);var x=L.GEOMETRY_VERTEX_STRIDE*y;m[x+0]=w;m[x+1]=P;m[x+2]=J;q[x+0]=K;q[x+1]=B;x=V(M,G,d,d);-1<x&&(x=L.GEOMETRY_VERTEX_STRIDE*(l+x),m[x+0]=w,m[x+1]=P,m[x+2]=J,q[x+0]=ba(K,B),q[x+1]=e);++y}}g.geometryInfo.numVertsPerRow=a.numVertsPerRow;g.geometryInfo.vertexAttributes=
z;g.geometryInfo.skirtLength=e;Y.set(g.geometryInfo.uvOffsetAndScale,p,u,I-p,c-u);aa(g.geometryInfo,a.numVertsPerRow,0,a.wireframe)};N.createSphericalGlobePatch=function(a,c,k,g,D,E,n,b){var f=D[0];const p=D[1];var u=D[2];D=D[3];const I=.1*n.radius*(D-p),C=a.numVertsPerRow-1,F=a.numVertsPerRow-1,A=a.numVertsPerRow*a.numVertsPerRow,v=R.acquire(A+(2*C+2*F)),e=v.position.typedBuffer,d=v.uv0.typedBuffer,h=g.geometryInfo.boundingBox;T.empty(h);var l=c[2]-c[0];const z=c[3]-c[1];var m=u-f;u=k[0];const q=
k[1];k=k[2];for(var r=0;r<=C;r++){var y=r/C,t=f+y*m;ca[r]=Math.sin(t);da[r]=Math.cos(t);ea[r]=y;fa[r]=c[0]+y*l}f=E&&!!(b&1);l=E&&!!(b&2);m=0;for(r=0;r<=F;r++){y=r/F;var w=ha.lerp(p,D,y);t=Math.cos(w);const M=Math.sin(w);E?(w=n.halfSemiMajorAxis*Math.log((1+M)/(1-M)),y=(w-c[1])/z):w=180*w/Math.PI;for(let K=0;K<=C;K++){const P=ea[K];var J=ca[K],x=da[K],G=n.radius;a.samplerData&&(G+=Z.ElevationData.sample(fa[K],w,a.samplerData)||0);x=x*t*G-u;J=J*t*G-q;G=M*G-k;W(x,J,G,h);var B=L.GEOMETRY_VERTEX_STRIDE*
m;e[B+0]=x;e[B+1]=J;e[B+2]=G;d[B+0]=P;d[B+1]=y;B=V(K,r,C,F);if(-1<B){B=L.GEOMETRY_VERTEX_STRIDE*(A+B);const Q=f&&0===r?-1:l&&r===F?1:0;x=0===Q?x:-u;J=0===Q?J:-q;G=0===Q?G:n.radius*Q-k;e[B+0]=x;e[B+1]=J;e[B+2]=G;d[B+0]=0===Q?ba(P,y):P;d[B+1]=0===Q?I:y;0!==Q&&W(x,J,G,h)}++m}}g.geometryInfo.numVertsPerRow=a.numVertsPerRow;g.geometryInfo.vertexAttributes=v;g.geometryInfo.skirtLength=I;Y.set(g.geometryInfo.uvOffsetAndScale,0,0,1,1);aa(g.geometryInfo,a.numVertsPerRow,E?b:0,a.wireframe)};N.intersectSkirts=
function(a,c,k,g,D,E,n,b,f){const p=E.position;E=E.uv0;const u=a[0],I=a[1];a=a[2];const C=c[0]-u,F=c[1]-I;c=c[2]-a;k*=3;for(g*=3;k<g;k+=3){var A=D[k],v=D[k+1],e=D[k+2],d=p.get(A,0),h=p.get(A,1),l=p.get(A,2),z=p.get(v,0),m=p.get(v,1),q=p.get(v,2),r=p.get(e,0),y=p.get(e,1),t=p.get(e,2);2<=E.get(A,0)&&(S.set(H,d,h,l),n(H),d+=H[0],h+=H[1],l+=H[2]);2<=E.get(v,0)&&(S.set(H,z,m,q),n(H),z+=H[0],m+=H[1],q+=H[2]);2<=E.get(e,0)&&(S.set(H,r,y,t),n(H),r+=H[0],y+=H[1],t+=H[2]);O.isSome(b)&&([d,h,l]=b.applyToVertex(d,
h,l),[z,m,q]=b.applyToVertex(z,m,q),[r,y,t]=b.applyToVertex(r,y,t));A=z-d;m-=h;q-=l;r-=d;y-=h;t-=l;e=F*t-y*c;z=c*r-t*C;const w=C*y-r*F;v=A*e+m*z+q*w;if(!(Math.abs(v)<=Number.EPSILON)){d=u-d;h=I-h;l=a-l;e=d*e+h*z+l*w;if(0<v){if(0>e||e>v)continue}else if(0<e||e<v)continue;z=h*q-m*l;l=l*A-q*d;h=d*m-A*h;d=C*z+F*l+c*h;if(0<v){if(0>d||e+d>v)continue}else if(0<d||e+d<v)continue;l=(r*z+y*l+t*h)/v;0<=l&&(A=la.computeNormal(A,m,q,r,y,t,oa),f(l,A))}}};N.releaseGeometry=function(a){R.release(a.vertexAttributes);
a.vertexAttributes=null;a.indices=null};Object.defineProperty(N,"__esModule",{value:!0})});