// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/Collection ../../../core/handleUtils ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../layers/buildingSublayers/BuildingGroupSublayer ./BuildingComponentSublayerView3D ./BuildingSublayerView3D ./LayerView3D ./i3s/BuildingFilterUtil ./i3s/I3SUtil ../support/updatingProperties ../../layers/BuildingSceneLayerView".split(" "),
function(n,k,q,g,r,w,x,p,t,u,l,I,J,K,y,L,z,A,B,C,D,E,F){const G=x.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D"),H=A.BuildingSublayerView3DMixin(g);g=function(v){function m(){var a=v.apply(this,arguments)||this;a.type="building-scene-3d";a.sublayerViews=new r;a._abortController=t.createAbortController();a._loadingComponents=0;return a}n._inheritsLoose(m,v);var e=m.prototype;e.isUpdating=function(){return 0<this._loadingComponents||this.sublayerViews&&this.sublayerViews.some(a=>a.updating)};
e.initialize=function(){D.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode);this.initializeSubLayerViews(this.layer.sublayers,this)};e.destroy=function(){this.sublayerViews&&(this.sublayerViews.forEach(a=>a.destroy()),this.sublayerViews=null);this._abortController.abort();this._abortController=null};e.initializeSubLayerViews=function(a,b){const c=this,d=this.view;a.forEach(f=>{if(!f.isEmpty)if("building-group"===f.type){const h=new H({sublayer:f,view:d,
parent:b});this.initializeSubLayerViews(f.sublayers,h)}else"mesh"===f.geometryType&&(this._loadingComponents++,f.load({signal:this._abortController.signal}).then(()=>{const h=new z({sublayer:f,layerView:c,view:d,parent:b});this.sublayerViews.push(h);this.handles.add([u.init(h,"updating",()=>this.notifyChange("updating"),!0),u.init(h,"updatingProgress",()=>this.notifyChange("updatingProgressValue"),!0)])}).catch(h=>{t.isAbortError(h)||G.error(`Error while creating view for sublayer ${f.id}\nLayer: ${this.layer.url}\n`,
h)}).then(()=>{this._loadingComponents--;this.notifyChange("updating");this.notifyChange("updatingProgressValue")}))})};e.getGraphicFromIntersectorMetadata=function(a){for(const b of this.sublayerViews.items)if(b.sublayer.uid===a.sublayerUid)return b.getGraphicFromIntersectorMetadata(a);return null};e.fetchPopupFeatures=function(){var a=n._asyncToGenerator(function*(b,c){if(p.isSome(c)&&c.clientGraphics&&0!==c.clientGraphics.length){var d=this._findComponent(c.clientGraphics[0].sourceLayer);if(!p.isNone(d))return d.fetchPopupFeatures(b,
c)}});return function(b,c){return a.apply(this,arguments)}}();e.whenGraphicBounds=function(a){const b=this._findComponent(a.sourceLayer);return p.isNone(b)?Promise.reject():b.whenGraphicBounds(a)};e._findComponent=function(a){return this.sublayerViews.find(b=>a===b.sublayer)};e.highlight=function(a){a instanceof q?a=[a]:a instanceof r&&(a=a.toArray());const b=[];if(Array.isArray(a)&&0<a.length&&a[0]instanceof q){const c=new Map;for(const d of a)a=c.get(d.sourceLayer),null==a&&(a=[],c.set(d.sourceLayer,
a)),a.push(d);this.sublayerViews.forEach(d=>{const f=c.get(d.sublayer);f&&b.push(d.highlight(f))})}return w.handlesGroup(b)};e.getUsedMemory=function(){return this.sublayerViews.reduce((a,b)=>a+b.getUsedMemory(),0)};e.getUnloadedMemory=function(){return this.sublayerViews.reduce((a,b)=>a+b.getUnloadedMemory(),0)};e.ignoresMemoryFactor=function(){return!1};n._createClass(m,[{key:"filterExpression",get:function(){const a=this.layer.activeFilterId;var b=null!=a?this.layer.filters.find(c=>c.id===a):null;
return(b=null!=b?b.filterBlocks.find(c=>"solid"===c.filterMode.type):null)?b.filterExpression:null}},{key:"filterExpressions",get:function(){const a=this.layer.activeFilterId,b=null!=a?this.layer.filters.find(c=>c.id===a):null;return b&&b.filterBlocks?b.filterBlocks.toArray().map(c=>[c.filterExpression,C.parseFilterMode(c)]):[]}},{key:"updatingProgressValue",get:function(){const a=this.sublayerViews,b=this._loadingComponents+(a?a.length:0);return a.reduce((c,d)=>c+d.updatingProgress,0)/b}}]);return m}(B.LayerView3D(F));
k.__decorate([l.property()],g.prototype,"sublayerViews",void 0);k.__decorate([l.property({readOnly:!0})],g.prototype,"filterExpression",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"filterExpressions",null);k.__decorate([l.property(E.updatingProgress)],g.prototype,"updatingProgress",void 0);k.__decorate([l.property({readOnly:!0,dependsOn:[]})],g.prototype,"updatingProgressValue",null);return g=k.__decorate([y.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],g)});