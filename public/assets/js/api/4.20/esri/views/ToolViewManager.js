// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Accessor ../core/Collection ../core/HandleOwner ../core/Logger ../core/maybe ../core/promiseUtils ../core/watchUtils ../core/accessorSupport/decorators/property ../core/has ../core/accessorSupport/ensureType ../core/jsonMap ../core/accessorSupport/decorators/subclass ./input/InputManager ./input/ViewEvents ./interactive/interactiveToolUtils ./interactive/ToolViewManagerManipulatorState".split(" "),function(p,l,u,z,g,A,h,m,v,n,
G,H,I,B,C,D,k,E){const w=A.getLogger("esri.views.ToolViewManager");g=function(x){function q(a){var b=x.call(this,a)||this;b._creatingTool=null;b._manipulatorState=new E;b.tools=k.newToolCollection();b.cursor=null;b._forEachTool=c=>{if(!h.isSome(b._creatingTool)||!c(b._creatingTool))for(const d of b.tools.items)if(c(d))break};return b}p._inheritsLoose(q,x);var e=q.prototype;e.initialize=function(){this.handles.add([this.view.on(D.eventTypes,a=>{this._handleInputEvent(a)},C.ViewEventPriorities.TOOL),
this.tools.on("before-add",a=>{const b=a.item;null==b||this.tools.includes(b)?a.preventDefault():null==b.created||b.created||(w.error("tools","Tool can not be added to view before it has been created"),a.preventDefault())}),this.tools.on("before-remove",({item:a})=>{this._manipulatorState.clearPointers(a,this._forEachTool)}),this.tools.on("change",()=>{this._refreshToolWatchers()})])};e.destroy=function(){this._forEachTool(a=>a.destroy())};e.createTool=function(){var a=p._asyncToGenerator(function*(b,
c,d){var t=this;const {abortHandle:y,tool:f}=yield this.updatingHandles.addPromise(p._asyncToGenerator(function*(){yield t.view.whenReady();m.throwIfAborted(d,"Tool creation was interrupted by another tool being created");const F=m.onAbort(d,()=>t.activeTool=null);var r=k.evaluateToolConstructorArguments(c);r=new b({...r,view:t.view});yield r.whenCreationStarted();m.throwIfAborted(d,"Tool creation was interrupted by another tool being created");return{abortHandle:F,tool:r}})());this._rejectCreatingTool("Tool creation was interrupted by another tool being created");
this._creatingTool=f;f.attach();this._refreshToolWatchers();k.setActive(f,!0);yield f.when();h.isSome(y)&&y.remove();this._creatingTool=null;m.throwIfAborted(d,"Tool creation was interrupted by another tool being created");this.tools.add(f);f instanceof u&&null!=f.completed&&v.whenOnce(f,"completed").then(()=>{k.setActive(f,!1)});return f});return function(b,c,d){return a.apply(this,arguments)}}();e.attach=function(){this._forEachTool(a=>a.attach());"3d"===this.view.type?this.handles.add([this.view.state.watch("camera",
()=>{this.forEachManipulator(a=>{if(null!=a.onViewChange)a.onViewChange()})}),this.view.elevationProvider.on("elevation-change",a=>{this.forEachManipulator(b=>{if(null!=b.onElevationChange)b.onElevationChange(a)})})],"manipulators"):this.handles.add(this.view.watch("extent",()=>{this.forEachManipulator(a=>{if(null!=a.onViewChange)a.onViewChange()})}))};e.detach=function(){this.activeTool=null;this._forEachTool(a=>{a.detach();a.destroy()});this.tools.removeAll();this.handles.remove("manipulators")};
e.forEachManipulator=function(a){this._forEachTool(b=>{b.manipulators&&b.manipulators.forEach(({manipulator:c})=>a(c,b))})};e._handleInputEvent=function(a){let b=!1;const c={...a,stopPropagation:()=>{b=!0;a.stopPropagation()}};h.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(c):this._forEachTool(d=>{!b&&!1!==d.visible&&d.handleInputEvent&&d.handleInputEvent(c)});!b&&"key-down"===a.type&&"Escape"===a.key&&this.activeTool&&(a.stopPropagation(),this.activeTool=
null);this._manipulatorState.handleInputEvent(c,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:d=>{this.activeTool=d},creatingTool:this._creatingTool,view:this.view});!b&&h.isSome(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(c);this._manipulatorState.handleHoverEvent(c,this._forEachTool);this._updateCursor()};e._refreshToolWatchers=function(){this.handles.remove("tools");this._forEachTool(a=>{if(a instanceof u){const b=v.watch(a,
["cursor","visible","editable"],()=>{k.areToolManipulatorsEditable(a)||this._manipulatorState.clearPointers(a,this._forEachTool);this._updateCursor()});this.handles.add(b,"tools")}a.manipulators&&this.handles.add(a.manipulators.on("change",b=>{b.removed.forEach(({id:c})=>{this._manipulatorState.clearPointers(a,this._forEachTool,!0,c)});this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()}),"tools")});this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);
this._updateCursor()};e._updateCursor=function(){let a=null;this._forEachTool(b=>null!=b.cursor&&!1!==b.visible?(a=b.cursor,!0):!1);a||(a=this._manipulatorState.cursor);this._get("cursor")!==a&&this._set("cursor",a)};e._rejectCreatingTool=function(a){const b=this._creatingTool;h.isNone(b)||(this._manipulatorState.clearPointers(b,this._forEachTool),b.rejectCreation&&b.rejectCreation(m.createAbortError(a)),k.setActive(b,!1),"destroyed"!==b.toolState&&b.destroy(),this._creatingTool=null,this._refreshToolWatchers())};
e._removeIncompleteTools=function(a){this.tools.filter(b=>(h.isNone(a)||b!==a)&&null!=b.completed&&!b.completed).forEach(b=>{this.tools.remove(b)})};p._createClass(q,[{key:"activeTool",set:function(a){h.isSome(a)&&!this.view.ready?w.error("#activeTool\x3d","cannot set active tool while view is not ready"):(k.swap(this,a,b=>{this._set("activeTool",b);this._removeIncompleteTools(a);this._forEachTool(c=>{var d=h.isNone(this.activeTool)||c===this.activeTool;c.setEditableFlag&&c.setEditableFlag(1,d);d=
k.areToolManipulatorsEditable(c);!h.isNone(this.activeTool)&&d||this._manipulatorState.clearPointers(c,this._forEachTool,!d)});this._updateCursor()}),this._creatingTool!==a&&this._rejectCreatingTool())}},{key:"updating",get:function(){return this.updatingHandles.updating||this.tools.some(a=>a.updating)}}]);return q}(g.HandleOwner);l.__decorate([n.property({constructOnly:!0,nonNullable:!0})],g.prototype,"view",void 0);l.__decorate([n.property({value:null})],g.prototype,"activeTool",null);l.__decorate([n.property({readOnly:!0,
type:z})],g.prototype,"tools",void 0);l.__decorate([n.property({readOnly:!0})],g.prototype,"cursor",void 0);l.__decorate([n.property({readOnly:!0})],g.prototype,"updating",null);return g=l.__decorate([B.subclass("esri.views.ToolViewManager")],g)});