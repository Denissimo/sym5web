// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../core/MapUtils ../../core/mathUtils ../../core/maybe ../../core/screenUtils ./interactiveToolUtils ../support/screenUtils".split(" "),function(y,z,u,g,A,v,m){const q={manipulator:null,tool:null};return function(){function r(){this._pointerLocations=new Map;this._hoveredManipulators=new Map;this._grabbedManipulators=new Map;this._draggedManipulators=new Map;this._stopDrag=!1;this._cursor=this._revertToActiveTool=null}var k=r.prototype;k.handleInputEvent=
function(a,d){var e=()=>a.stopPropagation();switch(a.type){case "pointer-move":"mouse"===a.pointerType&&this._pointerLocations.set(a.pointerId,{x:a.x,y:a.y,pointerType:a.pointerType});break;case "drag":0<this._grabbedManipulators.size&&(this._stopDrag=!0);this._stopDrag&&(a.stopPropagation(),"end"===a.action&&(this._stopDrag=!1));break;case "pointer-down":if("mouse"===a.pointerType&&0!==a.button)break;e=m.createScreenPointFromEvent(a);var c=this._intersect(e,a.pointerType,d.forEachTool);if(g.isNone(c))break;
var f=this._findToolAndManipulatorByKey(c,d.forEachTool,q),b=g.applySome(f,l=>l.manipulator);f=g.applySome(f,l=>l.tool);!(g.isSome(b)&&g.isSome(f)&&b.interactive)||b.grabbable&&b.grabbableForEvent(a)||!b.grabbing||b.dragging||this._ungrabManipulatorBeforeDragging(b,f,a);g.isSome(b)&&b.interactive&&b.grabbable&&b.grabbableForEvent(a)&&!b.grabbing&&(this._grabbedManipulators.set(a.pointerId,{key:c,start:e}),1===this._grabbedManipulators.size&&(this._revertToActiveTool=d.activeTool,d.setActiveTool(c.tool)),
b.grabbing=!0,b.events.emit("grab-changed",{action:"start",screenPoint:e}),a.stopPropagation());break;case "pointer-up":this._handlePointerEnd(a,d);break;case "pointer-drag":if("mouse"===a.pointerType&&0!==a.button)break;var h=this._grabbedManipulators.get(a.pointerId);e=this._draggedManipulators.get(a.pointerId);c=g.applySome(h||e,({key:l})=>l);b=this._findManipulatorByKey(c,d.forEachTool);if(g.isNone(b))break;f=m.createScreenPointFromEvent(a);f.x=u.clamp(f.x,0,d.view.width);f.y=u.clamp(f.y,0,d.view.height);
h=g.unwrap(h||e).start;switch(a.action){case "start":case "update":if("update"===a.action||1===this._grabbedManipulators.size)b.dragging=!0,e?b.events.emit("drag",{action:"update",start:h,screenPoint:f}):b.events.emit("drag",{action:"start",start:h,screenPoint:f,pointerType:a.pointerType}),this._draggedManipulators.set(a.pointerId,{key:g.unwrap(c),start:h});break;case "end":b.dragging=!1,e&&b.events.emit("drag",{action:"end",start:h,screenPoint:f}),this._draggedManipulators.delete(a.pointerId),this._handlePointerEnd(a,
d)}a.stopPropagation();break;case "immediate-click":{c=m.createScreenPointFromEvent(a);b=this._intersect(c,a.pointerType,d.forEachTool);const l=this._findToolAndManipulatorByKey(b,d.forEachTool,q);a.native.shiftKey||d.forEachTool(n=>{if((!g.isSome(l)||l.tool!==n||!n.selectionManagementDisabled)&&n.manipulators){let w=!1;n.manipulators.forEach(({manipulator:x})=>{x.selected&&(x.selected=!1,w=!0)});w&&n.manipulatorSelectionChanged&&n.manipulatorSelectionChanged()}});if(g.isNone(l))break;const {manipulator:p,
tool:t}=l;if(!p.interactive)break;p.selectable&&!t.selectionManagementDisabled&&(p.selected=!p.selected,t.manipulatorSelectionChanged&&t.manipulatorSelectionChanged());p.events.emit("immediate-click",{screenPoint:c,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:e});break}case "click":e=m.createScreenPointFromEvent(a);c=this._intersect(e,a.pointerType,d.forEachTool);c=this._findManipulatorByKey(c,d.forEachTool);if(g.isNone(c)||!c.interactive)break;c.events.emit(a.type,
{screenPoint:e,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey});a.stopPropagation();break;case "double-click":c=m.createScreenPointFromEvent(a);b=this._intersect(c,a.pointerType,d.forEachTool);b=this._findManipulatorByKey(b,d.forEachTool);if(g.isNone(b)||!b.interactive)break;b.events.emit("double-click",{screenPoint:c,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:e});break;case "immediate-double-click":c=m.createScreenPointFromEvent(a),
b=this._intersect(c,a.pointerType,d.forEachTool),b=this._findManipulatorByKey(b,d.forEachTool),!g.isNone(b)&&b.interactive&&b.events.emit("immediate-double-click",{screenPoint:c,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:e})}this._updateCursor(d.forEachTool)};k._ungrabManipulatorBeforeDragging=function(a,d,e){a.grabbing=!1;a.events.emit("grab-changed",{action:"end",screenPoint:m.createScreenPointFromEvent(e)});this._grabbedManipulators.forEach(({key:c},f)=>
{c.tool===d&&d.manipulators.findById(c.manipulatorId)===a&&this._grabbedManipulators.delete(f)})};k._handlePointerEnd=function(a,d){var e=g.applySome(this._grabbedManipulators.get(a.pointerId),({key:f})=>f);const c=this._findManipulatorByKey(e,d.forEachTool);g.isSome(c)&&!c.dragging&&(e=g.isSome(d.creatingTool)&&d.creatingTool===g.unwrap(e).tool,1!==this._grabbedManipulators.size||0!==this._draggedManipulators.size||e||(d.setActiveTool(this._revertToActiveTool),this._revertToActiveTool=null),c.grabbing&&
(c.grabbing=!1,c.events.emit("grab-changed",{action:"end",screenPoint:m.createScreenPointFromEvent(a)})),this._grabbedManipulators.delete(a.pointerId))};k._cursorFromMap=function(a,d){let e=null;z.someMap(a,({key:c})=>{c=this._findManipulatorByKey(c,d);return g.isSome(c)&&c.interactive&&"cursor"in c&&c.cursor?(e=c.cursor,!0):!1});return e};k._updateCursor=function(a){this._cursor=0<this._grabbedManipulators.size?this._cursorFromMap(this._grabbedManipulators,a)||"grabbing":0<this._hoveredManipulators.size?
this._cursorFromMap(this._hoveredManipulators,a)||"pointer":null};k.clearPointers=function(a,d,e=!0,c){const f=b=>b.tool===a&&(g.isNone(c)||b.manipulatorId===c);this._grabbedManipulators.forEach(({key:b},h)=>{f(b)&&(this._grabbedManipulators.delete(h),b=this._findManipulatorByKey(b,d),g.isSome(b)&&(b.grabbing=!1,b.events.emit("grab-changed",{action:"end",screenPoint:null})))});this._draggedManipulators.forEach(({key:b},h)=>{f(b)&&(this._draggedManipulators.delete(h),b=this._findManipulatorByKey(b,
d),g.isSome(b)&&(b.dragging=!1,b.events.emit("drag",{action:"cancel"})))});e&&this._hoveredManipulators.forEach(({key:b},h)=>{f(b)&&(this._hoveredManipulators.delete(h),b=this._findManipulatorByKey(b,d),g.isSome(b)&&(b.hovering=!1))});this._updateCursor(d)};k._intersect=function(a,d,e){let c=null;e(f=>{if(null==f.manipulators||!v.areToolManipulatorsEditable(f))return!1;const b=f.manipulators.intersect(a,d);if(g.isNone(b))return!1;c={manipulatorId:b.id,tool:f};return!0});return c};k.updateHoveredStateFromKnownPointers=
function(a){this._pointerLocations.forEach((d,e)=>{this._updateHoveredStateForPointerAtScreenPosition(A.createScreenPoint(d.x,d.y),e,d.pointerType,a)})};k.handleHoverEvent=function(a,d){"pointer-up"!==a.type&&"immediate-click"!==a.type&&"pointer-move"!==a.type||"mouse"!==a.pointerType||this._updateHoveredStateForPointerAtScreenPosition(m.createScreenPointFromEvent(a),a.pointerId,a.pointerType,d)};k._updateHoveredStateForPointerAtScreenPosition=function(a,d,e,c){a=this._intersect(a,e,c);e=this._findManipulatorByKey(a,
c);var f=g.applySome(this._hoveredManipulators.get(d),({key:b})=>b);f=this._findManipulatorByKey(f,c);g.isSome(e)&&!e.interactive&&(e=null);f!==e&&(g.isSome(f)&&(f.hovering=!1),g.isSome(e)?(e.hovering=!0,this._hoveredManipulators.set(d,{key:g.unwrap(a)})):this._hoveredManipulators.delete(d),this._updateCursor(c))};k._findManipulatorByKey=function(a,d){return this._findToolAndManipulatorByKey(a,d,q)?q.manipulator:null};k._findToolAndManipulatorByKey=function(a,d,e){if(g.isNone(a))return null;e.tool=
null;e.manipulator=null;d(c=>{if(c!==a.tool||null==c.manipulators||!v.areToolManipulatorsEditable(c))return!1;const f=c.manipulators.findById(a.manipulatorId);return g.isSome(f)?(e.manipulator=f,e.tool=c,!0):!1});return e.manipulator?e:null};y._createClass(r,[{key:"cursor",get:function(){return this._cursor}}]);return r}()});