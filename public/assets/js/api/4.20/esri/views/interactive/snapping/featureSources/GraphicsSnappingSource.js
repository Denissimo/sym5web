// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/HandleOwner ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/Logger ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/Point ../../../../geometry/Polygon ../../../../geometry/projection ../../../../geometry/support/normalizeUtilsSync ../../../../geometry/support/typeUtils ../../../../layers/graphics/featureConversionUtils ../../../../layers/graphics/OptimizedFeature ../../../../layers/graphics/data/FeatureStore ../../../../layers/graphics/data/QueryEngine ../snappingUtils ./queryEngineUtils".split(" "),
function(h,n,l,w,x,y,f,t,m,L,M,N,O,z,A,B,q,C,D,E,F,G,H,I,J){h.GraphicsSnappingSource=function(u){function p(a){a=u.call(this,a)||this;a.availability=1;a.sources={multipoint:null,point:null,polygon:null,polyline:null};a.loadedWkids=new Set;a.loadedWkts=new Set;a.pendingAdds=[];return a}n._inheritsLoose(p,u);var c=p.prototype;c.destroy=function(){const a=this.pendingAdds;this.pendingAdds.length=0;for(const b of a)b.task.abort();this.mapSources(b=>this.destroySource(b))};c.initialize=function(){this.handles.add([this.layer.on("graphic-update",
a=>this.onGraphicUpdate(a)),this.updatingHandles.addOnCollectionChange(this.layer.graphics,a=>this.onGraphicsChanged(a))]);this.addMany(this.layer.graphics.toArray())};c.fetchCandidates=function(){var a=n._asyncToGenerator(function*(b,d){const e=(yield t.eachAlwaysValues(this.mapSources(k=>k.queryEngine.executeQueryForSnapping({point:b.coordinateHelper.toPoint(b.point,new A).toJSON(),distance:b.distance,types:b.types,query:f.isSome(b.filter)?b.filter.createQuery().toJSON():{where:"1\x3d1"}},d).then(({candidates:g})=>
g)))).flat().map(k=>J.convertSnappingCandidate(k,b.coordinateHelper));I.sortCandidatesInPlace(b.point,e);return e});return function(b,d){return a.apply(this,arguments)}}();c.refresh=function(){};c.onGraphicUpdate=function(a){switch(a.property){case "geometry":case "visible":this.remove(a.graphic),this.addMany([a.graphic])}};c.onGraphicsChanged=function(a){for(const b of a.removed)this.remove(b);this.addMany(a.added)};c.addMany=function(a){const b=[],d=new Map;for(const e of a)f.isNone(e.geometry)||
(this.needsInitializeProjection(e.geometry.spatialReference)?(b.push(e.geometry.spatialReference),d.set(e.uid,e)):this.add(e));this.createPendingAdd(b,d)};c.createPendingAdd=function(a,b){var d=this;if(a.length){var e=t.createTask(function(){var K=n._asyncToGenerator(function*(v){yield q.initializeProjection(a.map(r=>({source:r,dest:d.spatialReference})),{signal:v});d.markLoadedSpatialReferences(a);for(const [,r]of b)d.add(r)});return function(v){return K.apply(this,arguments)}}());this.updatingHandles.addPromise(e.promise);
var k={task:e,graphics:b},g=()=>x.removeUnordered(this.pendingAdds,k);e.promise.then(g,g);this.pendingAdds.push(k)}};c.markLoadedSpatialReferences=function(a){for(const b of a)null!=b.wkid&&this.loadedWkids.add(b.wkid),null!=b.wkt&&this.loadedWkts.add(b.wkt)};c.add=function(a){if(!f.isNone(a.geometry)&&a.visible){var b=a.geometry;if("mesh"!==b.type){"extent"===b.type&&(b=B.fromExtent(b));var d=this.ensureSource(b.type);f.isNone(d)||(a=this.createOptimizedFeature(a.uid,b),f.isSome(a)&&d.featureStore.add(a))}}};
c.needsInitializeProjection=function(a){return null!=a.wkid&&this.loadedWkids.has(a.wkid)||null!=a.wkt&&this.loadedWkts.has(a.wkt)?!1:!q.canProjectWithoutEngine(a,this.spatialReference)};c.createOptimizedFeature=function(a,b){return(b=q.project(C.normalizeCentralMeridianSync(b),this.spatialReference))?new F(E.convertFromGeometry(b,!1,!1),{["OBJECTID"]:a},null,a):null};c.ensureSource=function(a){var b=this.sources[a];if(f.isSome(b))return b;b=this.createSource(a);return this.sources[a]=b};c.createSource=
function(a){var b=D.featureGeometryTypeKebabDictionary.toJSON(a);const d=new G({geometryType:b,hasZ:!1,hasM:!1});b=new H["default"]({featureStore:d,fields:[{name:"OBJECTID",type:"esriFieldTypeOID",alias:"OBJECTID"}],geometryType:b,hasM:!1,hasZ:!1,objectIdField:"OBJECTID",spatialReference:this.spatialReference,scheduler:f.isSome(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:null});return{featureStore:d,queryEngine:b,type:a}};c.remove=function(a){this.mapSources(b=>this.removeFromSource(b,
a));for(const b of this.pendingAdds)b.graphics.delete(a.uid),0===b.graphics.size&&b.task.abort()};c.removeFromSource=function(a,b){a.featureStore.has(b.uid)&&a.featureStore.removeById(b.uid)};c.destroySource=function(a){a.queryEngine.destroy();this.sources[a.type]=null};c.mapSources=function(a){const {point:b,polygon:d,polyline:e,multipoint:k}=this.sources,g=[];f.isSome(b)&&g.push(a(b));f.isSome(d)&&g.push(a(d));f.isSome(e)&&g.push(a(e));f.isSome(k)&&g.push(a(k));return g};n._createClass(p,[{key:"updating",
get:function(){return this.updatingHandles.updating}},{key:"layer",get:function(){return this.layerSource.layer}}]);return p}(y.HandleOwnerMixin(w));l.__decorate([m.property({constructOnly:!0})],h.GraphicsSnappingSource.prototype,"spatialReference",void 0);l.__decorate([m.property({constructOnly:!0})],h.GraphicsSnappingSource.prototype,"layerSource",void 0);l.__decorate([m.property({constructOnly:!0})],h.GraphicsSnappingSource.prototype,"view",void 0);l.__decorate([m.property({readOnly:!0})],h.GraphicsSnappingSource.prototype,
"updating",null);l.__decorate([m.property({readOnly:!0})],h.GraphicsSnappingSource.prototype,"availability",void 0);h.GraphicsSnappingSource=l.__decorate([z.subclass("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],h.GraphicsSnappingSource);Object.defineProperty(h,"__esModule",{value:!0})});