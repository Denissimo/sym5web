// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/arrayUtils ../../../../../core/AsyncSequence ../../../../../core/HandleOwner ../../../../../core/handleUtils ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../geometry/Extent ../../../../../geometry/support/aaBoundingRect ../../../../../layers/graphics/featureConversionUtils ../../../../../rest/query/operations/pbfOptimizedFeatureSet ../../../../../rest/query/operations/query ../../../../../rest/support/Query ./PendingFeatureTile".split(" "),
function(g,n,k,B,C,D,E,F,m,v,l,N,O,P,G,H,I,z,J,w,x,K){const L=F.getLogger("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher");g.FeatureServiceTiledFetcher=function(A){function u(a){a=A.call(this,a)||this;a.tilesOfInterest=[];a.availability=0;a.pendingTiles=new Map;a.pendingEdits=new C.AsyncSequence;a.pendingEditsAbortController=v.createAbortController();return a}n._inheritsLoose(u,A);var d=u.prototype;d.initialize=function(){this.initializeFetchExtent();
this.updatingHandles.add(this,"configuration",()=>this.refresh());this.updatingHandles.add(this,"tilesOfInterest",(a,b)=>{B.equals(a,b,({id:c},{id:e})=>c===e)||this.process()},1)};d.destroy=function(){this.pendingTiles.forEach(a=>this.deletePendingTile(a));this.pendingTiles.clear();this.store.destroy();this.tilesOfInterest.length=0;this.pendingEditsAbortController.abort();this.pendingEditsAbortController=null};d.refresh=function(){this.store.refresh();this.pendingTiles.forEach(a=>this.deletePendingTile(a));
this.process()};d.applyEdits=function(a){var b=this;this.pendingEdits.push(a,function(){var c=n._asyncToGenerator(function*(e){if(0!==e.addedFeatures.length||0!==e.updatedFeatures.length||0!==e.deletedFeatures.length){for(const [,f]of b.pendingTiles)f.reset();e={...e,deletedFeatures:e.deletedFeatures.map(({objectId:f,globalId:h})=>f&&-1!==f?f:b.lookupObjectIdByGlobalId(h))};yield b.updatingHandles.addPromise(b.store.processEdits(e,(f,h)=>b.queryFeaturesById(f,h),b.pendingEditsAbortController.signal));
b.processPendingTiles()}});return function(e){return c.apply(this,arguments)}}())};d.initializeFetchExtent=function(){var a=this;if(this.capabilities.query.supportsExtent){var b=v.createTask(function(){var c=n._asyncToGenerator(function*(e){try{var f;const h=yield w.executeQueryForExtent(a.url,new x({where:"1\x3d1",outSpatialReference:a.spatialReference,cacheHint:a.capabilities.query.supportsCacheHint?!0:void 0}),{query:a.configuration.customParameters,signal:e});a.store.extent=H.fromJSON(null==(f=
h.data)?void 0:f.extent)}catch(h){v.throwIfAbortError(h),L.warn("Failed to fetch data extent",h)}});return function(e){return c.apply(this,arguments)}}());this.updatingHandles.addPromise(b.promise.then(()=>this.process()));this.handles.add(E.makeHandle(()=>b.abort()))}};d.process=function(){this.markTilesNotAlive();this.createPendingTiles();this.deletePendingTiles();this.processPendingTiles()};d.markTilesNotAlive=function(){for(const [,a]of this.pendingTiles)a.alive=!1};d.createPendingTiles=function(){var a=
this.collectMissingTilesInfo();this.setAvailability(m.isNone(a)?1:a.coveredArea/a.fullArea);if(!m.isNone(a))for(const {data:b,resolution:c}of a.missingTiles)(a=this.pendingTiles.get(b.id))?(a.resolution=c,a.alive=!0):this.createPendingTile(b,c)};d.collectMissingTilesInfo=function(){let a=null;for(let b=this.tilesOfInterest.length-1;0<=b;b--){const c=this.store.process(this.tilesOfInterest[b],(e,f)=>this.verifyTileComplexity(e,f));m.isNone(a)?a=c:a.prepend(c)}return a};d.deletePendingTiles=function(){for(const [,
a]of this.pendingTiles)a.alive||this.deletePendingTile(a)};d.processPendingTiles=function(){const a={fetchCount:(b,c)=>this.fetchCount(b,c),fetchFeatures:(b,c,e)=>this.fetchFeatures(b,c,e),finish:(b,c)=>this.finishPendingTile(b,c),resume:()=>this.processPendingTiles()};if(this.ensureFetchAllCounts(a))for(const [,b]of this.pendingTiles)this.verifyTileComplexity(this.store.getFeatureCount(b.data),b.resolution)&&this.updatingHandles.addPromise(b.process(a))};d.verifyTileComplexity=function(a,b){return this.verifyVertexComplexity(a)&&
this.verifyFeatureDensity(a,b)};d.verifyVertexComplexity=function(a){return 1E6>a*this.minimumVerticesPerFeature};d.verifyFeatureDensity=function(a,b){if(m.isNone(this.tileInfo))return!1;b*=this.tileSize;return 1>25/(b*b)*a};d.ensureFetchAllCounts=function(a){let b=!0;for(const [,c]of this.pendingTiles)2>c.state.type&&this.updatingHandles.addPromise(c.process(a)),1>=c.state.type&&(b=!1);return b};d.finishPendingTile=function(a,b){this.store.add(a.data,b);this.deletePendingTile(a);this.updateAvailability()};
d.updateAvailability=function(){const a=this.collectMissingTilesInfo();this.setAvailability(m.isNone(a)?1:a.coveredArea/a.fullArea)};d.setAvailability=function(a){this._set("availability",a)};d.createPendingTile=function(a,b){b=new K.PendingFeatureTile(a,b);this.pendingTiles.set(a.id,b);return b};d.deletePendingTile=function(a){a.reset();this.pendingTiles.delete(a.data.id)};d.fetchCount=function(){var a=n._asyncToGenerator(function*(b,c){return this.store.fetchCount(b.data,this.url,this.createCountQuery(b),
{query:this.customParameters,timeout:6E5,signal:c})});return function(b,c){return a.apply(this,arguments)}}();d.fetchFeatures=function(){var a=n._asyncToGenerator(function*(b,c,e){let f=0,h,r=0,t=c;for(;;){const p=this.createFeaturesQuery(b),q=this.setPagingParameters(p,f,t),{features:y,exceededTransferLimit:M}=yield this.queryFeatures(p,e);q&&(f+=m.unwrap(p.num));r+=y.length;h=h?h.concat(y):y;t=c-r;if(!q||!M||0>=t)return h}});return function(b,c,e){return a.apply(this,arguments)}}();d.filterProperties=
function(a){return m.isNone(a)?{where:"1\x3d1",gdbVersion:void 0,timeExtent:void 0}:{where:a.where||"1\x3d1",timeExtent:a.timeExtent,gdbVersion:a.gdbVersion}};d.lookupObjectIdByGlobalId=function(a){const b=this.globalIdField,c=this.objectIdField;if(m.isNone(b))throw Error("Expected globalIdField to be defined");let e=null;this.store.featureStore.forEach(f=>{if(a===f.attributes[b]){var h;e=null!=(h=f.objectId)?h:f.attributes[c]}});if(m.isNone(e))throw Error(`Expected to find a feature with globalId ${a}`);
return e};d.queryFeaturesById=function(a,b){const c=this.createFeaturesQuery(null);c.objectIds=a;return this.queryFeatures(c,b)};d.queryFeatures=function(a,b){return this.capabilities.query.supportsFormatPBF?this.queryFeaturesPBF(a,b):this.queryFeaturesJSON(a,b)};d.queryFeaturesPBF=function(){var a=n._asyncToGenerator(function*(b,c){const {sourceSpatialReference:e}=this;({data:b}=yield w.executeQueryPBF(this.url,b,new J.OptimizedFeatureSetParserContext({sourceSpatialReference:e}),{query:this.configuration.customParameters,
timeout:6E5,signal:c}));return z.unquantizeOptimizedFeatureSet(b)});return function(b,c){return a.apply(this,arguments)}}();d.queryFeaturesJSON=function(){var a=n._asyncToGenerator(function*(b,c){const {sourceSpatialReference:e}=this;({data:b}=yield w.executeQuery(this.url,b,e,{query:this.configuration.customParameters,timeout:6E5,signal:c}));return z.convertFromFeatureSet(b,this.objectIdField)});return function(b,c){return a.apply(this,arguments)}}();d.createCountQuery=function(a){a=this.createBaseQuery(a);
this.capabilities.query.supportsCacheHint&&(a.cacheHint=!0);return a};d.createFeaturesQuery=function(a){const b=this.createBaseQuery(a);b.outFields=this.globalIdField?[this.globalIdField,this.objectIdField]:[this.objectIdField];b.returnGeometry=!0;m.isSome(a)&&(this.capabilities.query.supportsResultType?b.resultType="tile":this.capabilities.query.supportsCacheHint&&(b.cacheHint=!0));return b};d.createBaseQuery=function(a){a=new x({returnZ:!1,returnM:!1,geometry:m.isSome(this.tileInfo)&&m.isSome(a)?
I.toExtent(a.data.extent,this.tileInfo.spatialReference):void 0});const b=this.configuration.filter;m.isSome(b)&&(a.where=b.where,a.gdbVersion=b.gdbVersion,a.timeExtent=b.timeExtent);a.outSpatialReference=this.spatialReference;return a};d.setPagingParameters=function(a,b,c){if(!this.capabilities.query.supportsPagination)return!1;const {supportsMaxRecordCountFactor:e,supportsCacheHint:f,tileMaxRecordCount:h,maxRecordCount:r,supportsResultType:t}=this.capabilities.query,p=e?x.MAX_MAX_RECORD_COUNT_FACTOR:
1,q=p*((t||f)&&h?h:r?r:2E3);a.start=b;e?(a.maxRecordCountFactor=Math.min(p,Math.ceil(c/q)),a.num=Math.min(c,a.maxRecordCountFactor*q)):a.num=Math.min(c,q);return!0};n._createClass(u,[{key:"minimumVerticesPerFeature",get:function(){var a;switch(null==(a=this.store)?void 0:a.featureStore.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":return 1;case "esriGeometryPolygon":return 4;case "esriGeometryPolyline":return 2}}},{key:"filter",set:function(a){const b=this._get("filter");a=
this.filterProperties(a);JSON.stringify(b)!==JSON.stringify(a)&&this._set("filter",a)}},{key:"customParameters",set:function(a){const b=this._get("customParameters");JSON.stringify(b)!==JSON.stringify(a)&&this._set("customParameters",a)}},{key:"configuration",get:function(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}},{key:"tileInfo",set:function(a){const b=this._get("tileInfo");b===a||m.isSome(a)&&m.isSome(b)&&JSON.stringify(a)===
JSON.stringify(b)||(this._set("tileInfo",a),this.store.tileInfo=a)}},{key:"tileSize",set:function(a){this._get("tileSize")!==a&&this._set("tileSize",a)}},{key:"updating",get:function(){return this.updatingHandles.updating||this.pendingEdits.updating}},{key:"debugInfo",get:function(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this.pendingTiles.values()).map(a=>a.debugInfo),storedTiles:this.store.debugInfo}}}]);return u}(D.HandleOwner);
k.__decorate([l.property({constructOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"url",void 0);k.__decorate([l.property({constructOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"objectIdField",void 0);k.__decorate([l.property({constructOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"globalIdField",void 0);k.__decorate([l.property({constructOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"capabilities",void 0);k.__decorate([l.property({constructOnly:!0})],g.FeatureServiceTiledFetcher.prototype,
"sourceSpatialReference",void 0);k.__decorate([l.property({constructOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"spatialReference",void 0);k.__decorate([l.property({constructOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"store",void 0);k.__decorate([l.property({readOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"minimumVerticesPerFeature",null);k.__decorate([l.property()],g.FeatureServiceTiledFetcher.prototype,"filter",null);k.__decorate([l.property()],g.FeatureServiceTiledFetcher.prototype,
"customParameters",null);k.__decorate([l.property({readOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"configuration",null);k.__decorate([l.property()],g.FeatureServiceTiledFetcher.prototype,"tileInfo",null);k.__decorate([l.property()],g.FeatureServiceTiledFetcher.prototype,"tileSize",null);k.__decorate([l.property()],g.FeatureServiceTiledFetcher.prototype,"tilesOfInterest",void 0);k.__decorate([l.property({readOnly:!0})],g.FeatureServiceTiledFetcher.prototype,"updating",null);k.__decorate([l.property({readOnly:!0})],
g.FeatureServiceTiledFetcher.prototype,"availability",void 0);g.FeatureServiceTiledFetcher=k.__decorate([G.subclass("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher")],g.FeatureServiceTiledFetcher);Object.defineProperty(g,"__esModule",{value:!0})});