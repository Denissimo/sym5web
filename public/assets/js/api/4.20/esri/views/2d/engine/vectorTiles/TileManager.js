// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/LRUCache","../../../../core/maybe","../../tiling/TileCoverage","../../tiling/TileKey"],function(u,w,l,x,r){const y=(m,f)=>m+1/(1<<2*f);let A=function(){function m(a,b){this._tiles=new Map;this._tileCache=new w(40,c=>c.dispose());this._viewSize=[0,0];this._visibleTiles=new Map;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this._container=b}var f=m.prototype;f.destroy=function(){for(const [,a]of this._tiles)a.dispose();
this._tiles=null;this._tileCache.clear();this._tileCache=null};f.update=function(a){this._updateCacheSize(a);const b=this.tileInfoView;a=b.getTileCoverage(a.state,0,"smallest");const {spans:c,lodInfo:g}=a,{level:e}=g,d=new Set,n=new Set;for(const {row:h,colFrom:k,colTo:z}of c)for(let p=k;p<=z;p++){const t=r.getId(e,h,g.normalizeCol(p),g.getWorldForColumn(p)),v=this._getOrAcquireTile(t);d.add(t);v.processed()?this._addToContainer(v):n.add(new r(t))}for(const [h,k]of this._tiles)k.isCoverage=d.has(h);
for(var q of n)this._findPlaceholdersForMissingTiles(q,d);q=!1;for(const [h,k]of this._tiles)k.neededForCoverage=d.has(h),k.neededForCoverage||k.isHoldingForFade&&b.intersects(a,k.key)&&d.add(h),k.isFading&&(q=!0);for(const [h]of this._tiles)d.has(h)||this._releaseTile(h);x.pool.release(a);return!q};f.clear=function(){this._tiles.clear();this._tileCache.clear();this._visibleTiles.clear()};f.clearCache=function(){this._tileCache.clear()};f._findPlaceholdersForMissingTiles=function(a,b){var c=[];for(const [,
g]of this._tiles)this._addPlaceholderChild(c,g,a,b);c=c.reduce(y,0);1E-6>Math.abs(1-c)||this._addPlaceholderParent(a.id,b)};f._addPlaceholderChild=function(a,b,c,g){if(!(b.key.level<=c.level)&&b.hasData()){{var e=b.key;const d=e.level-c.level;e=c.row===e.row>>d&&c.col===e.col>>d&&c.world===e.world}e&&(this._addToContainer(b),g.add(b.id),a.push(b.key.level-c.level))}};f._addPlaceholderParent=function(a,b){for(;;){{const [g,e,d,n]=a.split("/");a=parseInt(g,10);a=0===a?null:`${a-1}/${parseInt(e,10)>>
1}/${parseInt(d,10)>>1}/${parseInt(n,10)}`}if(!a||b.has(a))break;const c=this._getTile(a);if(c&&c.hasData()){this._addToContainer(c);b.add(c.id);break}}};f._getOrAcquireTile=function(a){let b=this._tiles.get(a);if(b)return b;(b=this._tileCache.pop(a))||(b=this.acquireTile(new r(a)));this._tiles.set(a,b);return b};f._getTile=function(a){let b=this._tiles.get(a);if(b)return b;(b=this._tileCache.pop(a))&&this._tiles.set(a,b);return b};f._releaseTile=function(a){const b=this._tiles.get(a);this.releaseTile(b);
this._removeFromContainer(b);this._tiles.delete(a);b.hasData()?this._tileCache.put(a,b,1):b.dispose()};f._addToContainer=function(a){let b;const c=[],g=this._container;if(!g.contains(a)){var e=this._visibleTiles;for(const [,d]of e)this._canConnectDirectly(a,d)&&c.push(d),l.isNone(b)&&this._canConnectDirectly(d,a)&&(b=d);if(l.isSome(b)){for(const d of c)b.childrenTiles.delete(d),a.childrenTiles.add(d),d.parentTile=a;b.childrenTiles.add(a);a.parentTile=b}else for(const d of c)a.childrenTiles.add(d),
d.parentTile=a;e.set(a.id,a);g.addChild(a)}};f._removeFromContainer=function(a){this._visibleTiles.delete(a.id);this._container.removeChild(a);if(l.isSome(a.parentTile)){a.parentTile.childrenTiles.delete(a);for(const b of a.childrenTiles)l.isSome(a.parentTile)&&a.parentTile.childrenTiles.add(b)}for(const b of a.childrenTiles)b.parentTile=a.parentTile;a.parentTile=null;a.childrenTiles.clear()};f._canConnectDirectly=function(a,b){a=a.key;let {level:c,row:g,col:e,world:d}=b.key;for(b=this._visibleTiles;0<
c;){c--;g>>=1;e>>=1;if(a.level===c&&a.row===g&&a.col===e&&a.world===d)return!0;if(b.has(`${c}/${g}/${e}/${d}`))break}return!1};f._updateCacheSize=function(a){a=a.state.size;if(a[0]!==this._viewSize[0]||a[1]!==this._viewSize[1]){var b=Math.ceil(a[0]/512)+1,c=Math.ceil(a[1]/512)+1;this._viewSize[0]=a[0];this._viewSize[1]=a[1];this._tileCache.maxSize=5*b*c}};return m}();u.TileManager=A;Object.defineProperty(u,"__esModule",{value:!0})});