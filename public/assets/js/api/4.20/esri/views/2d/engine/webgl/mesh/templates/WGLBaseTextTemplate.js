// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/maybe ../../../../../../core/screenUtils ../../../../../../layers/graphics/featureConversionUtils ../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper ../../definitions ../../enums ../../number ../../materialKey/MaterialKey ./shapingUtils".split(" "),function(r,l,t,n,u,v,w,k,p,x){return y=>function(q){function m(...a){a=q.call(this,...a)||this;a._isCIM=!1;a._vertexBoundsScale=1;a.geometryType=w.WGLGeometryType.TEXT;
a._aux=k.i8888to32(0,0,a._referenceSize,a._bitset);return a}r._inheritsLoose(m,q);var h=m.prototype;h.bindTextInfo=function(a,c){this._shapingInfo=a&&a.length?l.andThen(a,d=>x.shapeGlyphs(d,c,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:v.MAGIC_LABEL_LINE_HEIGHT*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM})):null};
h._write=function(a,c,d){const b=c.getDisplayId();this._writeGeometry(a,c,b,d)};h._writeGeometry=function(a,c,d,b){const e=this._shapingInfo;if(!l.isNone(e)){if(l.isSome(this._textPlacement))return c=null!=b?b:c.readLegacyGeometry(),this._writePlacedText(a,d,c,e);if(c=b?n.deltaDecodeGeometry(n.convertFromGeometry(b),2):"esriGeometryPolygon"===c.geometryType?c.readCentroid():c.readUnquantizedGeometry()){if(c.isPoint){const [f,g]=c.coords;return this._writeGlyphs(a,d,{x:f,y:g},e)}c.forEachVertex((f,
g)=>this._writeGlyphs(a,d,{x:f,y:g},e))}}};h._writePlacedText=function(a,c,d,b){var e=l.unwrap(this._textPlacement);if(d=u.CIMMarkerPlacementHelper.getPlacement(d,e,t.pt2px(1)))for(e=d.next();null!=e;){const f=e.getAngle();b.setRotation(f);this._writeGlyphs(a,c,{x:e.tx,y:e.ty},b);b.setRotation(-f);e=d.next()}};h._writeGlyphs=function(a,c,d,b){const e=p.MaterialKeyBase.load(this._materialKey);d=k.i1616to32(Math.round(8*d.x),Math.round(8*d.y));for(const f of b.glyphs){e.textureBinding=f.textureBinding;
a.recordStart(c,e.data,this.geometryType,!1,!0);b=f.bounds;const g=this._vertexBoundsScale;a.vertexBounds(b.x*g,b.y*g,b.width*g,b.height*g);this._writeVertices(a,c,d,f);a.recordEnd()}};h._writeGlyph=function(a,c,d,b,e){var f=p.MaterialKeyBase.load(this._materialKey);d=k.i1616to32(Math.round(8*d),Math.round(8*b));f.textureBinding=e.textureBinding;a.recordStart(c,f.data,this.geometryType,!1,!0);f=e.bounds;b=this._vertexBoundsScale;a.vertexBounds(f.x*b,f.y*b,f.width*b,f.height*b);this._writeVertices(a,
c,d,e);a.recordEnd()};h._writeVertices=function(a,c,d,b){const e=a.vertexCount();this._writeVertexCommon(a,c,d,b);a.vertexWrite(b.offsets.upperLeft);a.vertexWrite(b.texcoords.upperLeft);a.vertexEnd();this._writeVertexCommon(a,c,d,b);a.vertexWrite(b.offsets.upperRight);a.vertexWrite(b.texcoords.upperRight);a.vertexEnd();this._writeVertexCommon(a,c,d,b);a.vertexWrite(b.offsets.lowerLeft);a.vertexWrite(b.texcoords.lowerLeft);a.vertexEnd();this._writeVertexCommon(a,c,d,b);a.vertexWrite(b.offsets.lowerRight);
a.vertexWrite(b.texcoords.lowerRight);a.vertexEnd();a.indexWrite(e+0);a.indexWrite(e+1);a.indexWrite(e+2);a.indexWrite(e+1);a.indexWrite(e+3);a.indexWrite(e+2)};h._writeVertexCommon=function(a,c,d,b){b=this._color;const e=this._haloColor,f=k.i8888to32(0,0,this._referenceSize,this._bitset),g=k.i8888to32(0,0,this._size,this._haloSize);a.vertexWrite(d);a.vertexWrite(c);a.vertexWrite(b);a.vertexWrite(e);a.vertexWrite(g);a.vertexWrite(f);a.vertexWrite(this._minMaxZoom)};return m}(y)});