// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/promiseUtils ../../../../../core/scheduling ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/ensureType ../../../../../core/Logger ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/vec2 ../../../tiling/PagedTileQueue ../../../tiling/TileInfoView ../../../tiling/TileKey ../../../tiling/TileQueue ../../../tiling/TileStrategy".split(" "),
function(m,h,e,r,w,n,y,z,A,B,x,t,C,D,u,E,F){const q=[0,0];e=function(v){function p(a){a=v.call(this,a)||this;a._queue=new Map;a._isPaused=!1;a._scheduledNextHandle=null;a._timestamp=Date.now();a.tileInfoView=null;a._next=a._next.bind(m._assertThisInitialized(a));a._finalize=a._finalize.bind(m._assertThisInitialized(a));return a}m._inheritsLoose(p,v);var b=p.prototype;b.abort=function(a){this._onGoingTile&&this._onGoingTile.tileId===a&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null);
this._queue.delete(a);this._scheduleNext();this.notifyChange("updating")};b.clear=function(){this._queue.clear();this._onGoingTile&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null);this._cancelNext();this.notifyChange("updating")};b.has=function(a){return this._queue.has(a)};b.isOngoing=function(a){return this._onGoingTile&&this._onGoingTile.tileId===a};b.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())};b.push=function(a,c){if(!this._queue.has(a)){var g=r.createAbortController();
this._queue.set(a,{tileId:a,key:u.pool.acquire(a),timestamp:c||this._timestamp,abortController:g});this._scheduleNext();this.notifyChange("updating")}};b.refresh=function(){this._timestamp=Date.now();this.reset()};b.reset=function(){var a=this._onGoingTile;a&&({tileId:a}=a,this.push(a,this._timestamp));this.notifyChange("updating")};b.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext());this.notifyChange("updating")};b._finalize=function(){this._onGoingTile=null;this.notifyChange("updating");
this._scheduleNext()};b._cancelNext=function(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)};b._scheduleNext=function(){this._isPaused||this._scheduledNextHandle||0===this._queue.size||null!=this._onGoingTile||(this._scheduledNextHandle=w.schedule(this._next))};b._next=function(){var a=m._asyncToGenerator(function*(){if(null==this._scheduledNextHandle||0===this._queue.size||this._onGoingTile)this._scheduledNextHandle=null;else{this._scheduledNextHandle=
null;var c=this._peek(),g=c.abortController.signal,{tileId:f,key:k}=c;u.pool.release(k);this._queue.delete(f);this._onGoingTile=c;c=this.process(f,this._timestamp,{signal:g});this.notifyChange("updating");if(r.isPromiseLike(c))try{yield c}catch(l){}this._finalize()}});return function(){return a.apply(this,arguments)}}();b._peek=function(){if(!this.state)throw Error("state not set");const a=this.tileInfoView,c=this.state.center;let g=Number.NEGATIVE_INFINITY,f=Number.POSITIVE_INFINITY,k=null;this._queue.forEach(l=>
{a.getTileCoords(q,l.key);var d=this._timestamp-l.timestamp;isNaN(d)?(d=t.distance(q,c),d<f&&(f=d,k=l)):d===g?(d=t.distance(q,c),d<f&&(f=d,k=l)):d>g&&(g=d,f=Number.POSITIVE_INFINITY,k=l)});return k};m._createClass(p,[{key:"length",get:function(){return this._queue.size}},{key:"updating",get:function(){return 0<this._queue.size||null!=this._onGoingTile}}]);return p}(e);h.__decorate([n.property({readOnly:!0})],e.prototype,"length",null);h.__decorate([n.property({constructOnly:!0})],e.prototype,"process",
void 0);h.__decorate([n.property()],e.prototype,"state",void 0);h.__decorate([n.property({constructOnly:!0})],e.prototype,"tileInfoView",void 0);h.__decorate([n.property({readOnly:!0})],e.prototype,"updating",null);return e=h.__decorate([x.subclass("esri.views.2d.layers.features.support.TileUpdateQueue")],e)});