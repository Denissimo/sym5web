// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/CircularArray ../../../../core/has ../../../../core/maybe ../../../../chunks/mat2d ../../../../chunks/mat2df32 ../../../../chunks/vec2 ../../../../chunks/vec2f32 ./enums ./Utils ./WGLTile ./collisions/MetricReader ./cpuMapped/Geometry".split(" "),function(n,p,t,q,e,k,u,v,w,x,y,z,A,B){let C=0;q=function(f){function g(a,b,c){a=f.call(this,a,b)||this;a.instanceId=C++;a.patchCount=0;a._renderState={current:{geometry:new Map,
metrics:null},next:null,swap:!1,swapFrames:0,locked:!1};a._patches=new t(100);a._lastCommitTime=0;a._lastMessageWasClear=!1;a.transforms.labelMat2d=u.create();a._store=c;return a}p._inheritsLoose(g,f);var d=g.prototype;d.destroy=function(){f.prototype.destroy.call(this);this._renderState.current.geometry.forEach(a=>a.destroy())};d.getGeometry=function(a){return this._renderState.current.geometry.get(a)};d.setTransform=function(a,b){f.prototype.setTransform.call(this,a,b);const c=this.transforms.labelMat2d;
b=a.getScreenTransform(c,b);const h=w.create();v.transformMat2d(h,this.coords,b);k.identity(c);k.translate(c,c,h);k.multiply(c,a.viewMat2d,c)};d.patch=function(a){this.patchCount++;a.clear&&this._lastMessageWasClear||((this._lastMessageWasClear=a.clear)&&50<=this._patches.size&&this._dropPatches(),this._patches.enqueue(a),this.requestRender())};d.commit=function(a){if(this._lastCommitTime!==a.time){this._lastCommitTime=a.time;for(a=0;4>a;a++)this._updateMesh();this._renderState.swap&&(this._swapRenderStates(),
this.requestRender())}};d.lock=function(){this._renderState.locked=!0};d.unlock=function(){this._renderState.locked=!1;this._flushUpdates();this._swap()};d._swapRenderStates=function(){this._renderState.next&&(this._renderState.locked?(this._renderState.swap=!0,this.requestRender()):(this._renderState.swap=!0,0===this._renderState.swapFrames?(this._renderState.swapFrames=8,this.requestRender()):1!==this._renderState.swapFrames--?this.requestRender():this._swap()))};d._swap=function(){this._renderState.swap&&
(this._renderState.swap=!1,e.isSome(this._renderState.next)&&(this._renderState.current.geometry.forEach(a=>a.destroy()),this._renderState.current=this._renderState.next,this._renderState.next=null))};d._flushUpdates=function(){let a=this._patches.maxSize;for(;this._patches.size&&a--;)this._updateMesh(),this._swap()};d._updateMesh=function(){var a=this._patches.peek();e.isSome(a)&&a.clear&&null!==this._renderState.next||(a=this._patches.dequeue(),e.isSome(a)&&(!0===a.clear?this.isReady&&(this._renderState.next=
{geometry:new Map,metrics:null}):(this.requestRender(),this._patch(a),a.end&&(this.ready(),this._swapRenderStates()))))};d._patch=function(a){y.forEachGeometryType(b=>{this._remove(b,a.remove);this._insert(a.type,b,a.addOrUpdate,a.clear)})};d._insert=function(a,b,c,h){try{const r=e.unwrapOr(this._renderState.next,this._renderState.current),l=null==c?void 0:c.data[b],m=r.geometry;e.isNone(l)||(m.has(b)||m.set(b,new B.Geometry(b,this.stage)),m.get(b).insert(a,l),b===x.WGLGeometryType.LABEL&&this._insertLabelMetrics(a,
l.metrics,h))}catch(r){}};d._insertLabelMetrics=function(a,b,c){c=e.unwrapOr(this._renderState.next,this._renderState.current);if(!e.isNone(b))if(b=A.MetricReader.from(b),e.isNone(c.metrics))c.metrics=b;else{if("update"===a)for(a=b.getCursor();a.next();)c.metrics.delete(a.id);c.metrics.link(b)}};d._remove=function(a,b){a=e.unwrapOr(this._renderState.next,this._renderState.current).geometry.get(a);b&&b.length&&a&&(a.remove(b),this._removeLabelMetrics(b))};d._removeLabelMetrics=function(a){const {metrics:b}=
e.unwrapOr(this._renderState.next,this._renderState.current);if(!e.isNone(b)&&a.length)for(const c of a)for(;b.delete(c););};d._dropPatches=function(){const a=[];let b=!1;for(;this._patches.size;){const c=this._patches.dequeue();if(e.isNone(c))break;if(c.clear){if(b)break;b=!0}a.push(c)}this._patches.clear();a.forEach(c=>this._patches.enqueue(c))};p._createClass(g,[{key:"labelMetrics",get:function(){return this._renderState.current.metrics}},{key:"hasData",get:function(){return!!this._renderState.current.geometry.size}}]);
return g}(z.WGLTile);n.FeatureTile=q;Object.defineProperty(n,"__esModule",{value:!0})});