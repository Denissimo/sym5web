// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../config ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec2f32 ../../../../symbols/cim/Rasterizer ./definitions ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./animatedFormats/apng ./animatedFormats/gif ./util/BidiText ./util/Result ./util/symbolUtils ../../../support/QueueProcessor".split(" "),
function(m,H,D,n,I,J,q,w,E,K,L,r,t,M,N,O,P,Q,x,y,R,z,S,T){function U(g){switch(g.type){case "CIMSolidStroke":case "CIMSolidFill":return!0;case "esriSFS":return"esriSFSSolid"===g.style||"esriSFSNull"===g.style;case "esriSLS":return"esriSLSSolid"===g.style||"esriSLSNull"===g.style;default:return!1}}function u(g){switch(g.type){case "esriSMS":case "esriPMS":case "CIMPointSymbol":case "CIMVectorMarker":case "CIMPictureMarker":case "CIMCharacterMarker":return!1;default:return!0}}function V(g,f){return A.apply(this,
arguments)}function A(){A=m._asyncToGenerator(function*(g,f){g=g.imageData?`data:${g.contentType};base64,${g.imageData}`:g.url;var e;if(-1!==g.indexOf(";base64,")){f=g.indexOf(";base64,")+8;f=g.substring(f);f=atob(f);g=new Uint8Array(f.length);for(e=0;e<f.length;e++)g[e]=f.charCodeAt(e);e=g.buffer}else try{const {data:a}=yield D(g,{responseType:"array-buffer",...f});e=a}catch(a){if(!q.isAbortError(a))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${g}`)}return e});
return A.apply(this,arguments)}function F(g,f){f=Math.round(w.pt2px(f)*window.devicePixelRatio);return Math.min(g,f*(128<=f?2:4))}const G=K.create(),v=I.getLogger("esri.views.2d.engine.webgl.TextureManager");let W=function(){function g(f,e,a){this.mosaicType=f;this.page=e;this.sdf=a}g.fromMosaic=function(f,e){return new g(f,e.page,e.sdf)};return g}();return function(){function g(e){this._invalidFontsMap=new Map;this._sdfConverter=new P(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._rasterizer=
new L;this._ongoingRasterizations=new Map;this._imageRequestQueue=new T.QueueProcessor({concurrency:10,process:function(){var a=m._asyncToGenerator(function*(b,d){q.throwIfAborted(d);try{return yield D(b,{responseType:"image",signal:d})}catch(c){if(!q.isAbortError(c))throw new n("mapview-invalid-resource",`Could not fetch requested resource at ${b}`,c);throw c;}});return function(b,d){return a.apply(this,arguments)}}()});this._spriteMosaic=new Q(e,2048,2048,500);this._glyphSource=new O(`${H.fontsUrl}/{fontstack}/{range}.pbf`);
this._glyphMosaic=new N(1024,1024,this._glyphSource)}var f=g.prototype;f.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();this._sdfConverter.dispose();this._sdfConverter=this._rasterizer=this._glyphMosaic=this._spriteMosaic=null;this._hashToBindingIndex.clear();this._bindingInfos=this._hashToBindingIndex=null;this._ongoingRasterizations.clear();this._ongoingRasterizations=null;this._imageRequestQueue.clear();this._imageRequestQueue=null};f.rasterizeItem=
function(){var e=m._asyncToGenerator(function*(a,b,d,c){if(J.isNone(a))return v.error(new n("mapview-null-resource","Unable to rasterize null resource",void 0)),null;switch(a.type){case "CIMTextSymbol":case "esriTS":return a=yield this._rasterizeText(a,d,c),a.forEach(h=>this._setTextureBinding(t.MosaicType.GLYPH,h)),{glyphMosaicItems:a};default:if(a.type&&-1!==a.type.toLowerCase().indexOf("3d"))return v.error(new n("mapview-invalid-type",`MapView does not support symbol type: ${a.type}`,a)),null;
a=yield this._rasterizeSpriteSymbol(a,b,c);z.ok(a)&&a&&this._setTextureBinding(t.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}});return function(a,b,d,c){return e.apply(this,arguments)}}();f.bindTextures=function(e,a,b,d=!1){if(0!==b.textureBinding){var c=this._bindingInfos[b.textureBinding-1];b=c.page;d=d?9987:9729;switch(c.mosaicType){case t.MosaicType.SPRITE:{c=this.sprites.getWidth(b);const h=this.sprites.getHeight(b);c=E.set(G,c,h);this._spriteMosaic.bind(e,d,b,r.TEXTURE_BINDING_SPRITE_ATLAS);
a.setUniform1i("u_texture",r.TEXTURE_BINDING_SPRITE_ATLAS);a.setUniform2fv("u_mosaicSize",c);break}case t.MosaicType.GLYPH:c=E.set(G,this.glyphs.width,this.glyphs.height);this._glyphMosaic.bind(e,d,b,r.TEXTURE_BINDING_GLYPH_ATLAS);a.setUniform1i("u_texture",r.TEXTURE_BINDING_GLYPH_ATLAS);a.setUniform2fv("u_mosaicSize",c);break;default:v.error("mapview-texture-manager",`Cannot handle unknown type ${c.mosaicType}`)}}};f._hashMosaic=function(e,a){return 1|e<<1|(a.sdf?1:0)<<2|a.page<<3};f._setTextureBinding=
function(e,a){const b=this._hashMosaic(e,a);this._hashToBindingIndex.has(b)||(e=W.fromMosaic(e,a),this._hashToBindingIndex.set(b,this._bindingInfos.length+1),this._bindingInfos.push(e));a.textureBinding=this._hashToBindingIndex.get(b)};f._rasterizeText=function(){var e=m._asyncToGenerator(function*(a,b,d){const c=M.getFullyQualifiedFontName(a.font),h=this._invalidFontsMap.has(c);if(b)a=b;else{a=R.bidiText(a.text)[0];b=[];for(let k=0;k<a.length;k++)b.push(a.charCodeAt(k));a=b}try{return yield this._glyphMosaic.getGlyphItems(h?
"arial-unicode-ms-regular":c,a,d)}catch(k){return v.error(new n("mapview-invalid-resource",`Couldn't find font ${c}. Falling back to Arial Unicode MS Regular`,void 0)),this._invalidFontsMap.set(c,!0),this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",a,d)}});return function(a,b,d){return e.apply(this,arguments)}}();f._rasterizeSpriteSymbol=function(){var e=m._asyncToGenerator(function*(a,b,d){if(U(a))return null;const c=S.keyFromSymbol(a);if(this._spriteMosaic.has(c))return this._spriteMosaic.getSpriteItem(c);
if("esriSMS"===a.type&&a.path||a.url||a.imageData)return this._handleAsyncResource(c,a,d);if(b=this._rasterizer.rasterizeJSONResource(a,b)){const {size:h,image:k,sdf:l,simplePattern:p}=b;return this._addItemToMosaic(c,h,{type:"static",data:k},u(a),l,p)}return new n("TextureManager","unrecognized or null rasterized image")});return function(a,b,d){return e.apply(this,arguments)}}();f._handleAsyncResource=function(){var e=m._asyncToGenerator(function*(a,b,d){if(this._ongoingRasterizations.has(a))return this._ongoingRasterizations.get(a);
b="esriSMS"===b.type&&b.path?this._handleSVG(b,a,d):this._handleImage(b,a,d);this._ongoingRasterizations.set(a,b);try{yield b,this._ongoingRasterizations.delete(a)}catch{this._ongoingRasterizations.delete(a)}return b});return function(a,b,d){return e.apply(this,arguments)}}();f._handleSVG=function(){var e=m._asyncToGenerator(function*(a,b,d){a=yield this._sdfConverter.draw(a.path,d);return this._addItemToMosaic(b,[126,126],{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0)});return function(a,
b,d){return e.apply(this,arguments)}}();f._handleGIFOrPNG=function(){var e=m._asyncToGenerator(function*(a,b,d){var c=yield V(a,d);if(z.ok(c)){var h=y.isGIF(c);const k=x.isPNG(c);if(!h&&!k)return new n("mapview-invalid-resource","Image data is neither GIF nor PNG!");let l;try{h&&y.isAnimatedGIF(c)?l=yield y["default"].create(c,d):k&&x.isAnimatedPNG(c)&&(l=yield x["default"].create(c,d))}catch(p){if(!q.isAbortError(p))return new n("mapview-invalid-resource","Could not fetch requested resource!")}if(l&&
z.ok(l))return this._addItemToMosaic(b,[l.width,l.height],{type:"animated",data:l},u(a),!1,!1);d=new Blob([c],{type:h?"image/gif":"image/png"});if((d=yield this._imageFromBlob(d))&&d instanceof HTMLImageElement){c=d.width;h=d.height;"esriPMS"===a.type&&(c=Math.round(F(d.width,a.width)),h=Math.round(c/d.width*d.height));const {size:p,sdf:B,image:C}=this._rasterizer.rasterizeImageResource(c,h,d,a.colorSubstitutions);return this._addItemToMosaic(b,p,{type:"static",data:C},u(a),B,!1)}}return new n("mapview-invalid-resource",
"Could not handle resource!")});return function(a,b,d){return e.apply(this,arguments)}}();f._handleImage=function(){var e=m._asyncToGenerator(function*(a,b,d){var c;(c=a.url&&-1!==a.url.indexOf(".gif")||a.contentType&&"image/gif"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/gif"))||(c=a.url&&-1!==a.url.indexOf(".png")||a.contentType&&"image/png"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/png"));if(c)return this._handleGIFOrPNG(a,b,d);c=a.imageData?`data:${a.contentType};base64,${a.imageData}`:
a.url;try{const {data:h}=yield this._imageRequestQueue.push(c,{...d});-1!==c.indexOf("data:image/svg+xml")&&(h.width=w.pt2px(a.width),h.height=w.pt2px(a.height));let k=h.width,l=h.height;"esriPMS"===a.type&&(k=Math.round(F(h.width,a.width)),l=Math.round(k/h.width*h.height));const {size:p,sdf:B,image:C}=this._rasterizer.rasterizeImageResource(k,l,h,a.colorSubstitutions);return this._addItemToMosaic(b,p,{type:"static",data:C},u(a),B,!1)}catch(h){if(!q.isAbortError(h))return new n("mapview-invalid-resource",
`Could not fetch requested resource at ${c}. ${h.message}`)}});return function(a,b,d){return e.apply(this,arguments)}}();f._imageFromBlob=function(){var e=m._asyncToGenerator(function*(a){a=window.URL.createObjectURL(a);try{const {data:b}=yield this._imageRequestQueue.push(a);window.URL.revokeObjectURL(a);return b}catch(b){window.URL.revokeObjectURL(a);if(!q.isAbortError(b))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${a}`);throw b;}});return function(a){return e.apply(this,
arguments)}}();f._addItemToMosaic=function(e,a,b,d,c,h){return this._spriteMosaic.addSpriteItem(e,a,b,d,c,h)};m._createClass(g,[{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}}]);return g}()});