// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ./BaseFeatureSource".split(" "),function(u,n,x,p,y,l,z){const A=p.getLogger("esri.views.2d.layers.features.sources.FeatureSource");p=function(v){function q(m){return v.call(this,m)||this}n._inheritsLoose(q,v);var w=q.prototype;w._fetchDataTile=function(){var m=n._asyncToGenerator(function*(b){const c=this._subscriptions.get(b.key.id);
let f=!1,r=0,d=0;const k=(g,a)=>{d--;l.throwIfAborted(c);const h=b.id,e=g.reader;g=g.query;e.exceededTransferLimit?(a={id:h,addOrUpdate:e,end:f&&0===d,type:"append"},c.add({message:a,query:g}),this._onMessage(a)):(f=!0,a={id:h,addOrUpdate:e,end:0===d,type:"append"},c.add({message:a,query:g}),this._onMessage(a))};let t=0,B=0;for(;!f&&20>B++;){let g;for(let a=0;a<t+1;a++){const h=r++;d++;g=this._fetchDataTilePage(b,h,c).then(e=>e&&k(e,h)).catch(e=>{f=!0;l.isAbortError(e)||(A.error(new x("mapview-query-error",
"Encountered error when fetching tile",{tile:b,error:e})),this._onMessage({id:b.id,addOrUpdate:null,end:f,type:"append"}))})}yield g;l.throwIfAborted(c);t=Math.min(t+2,6)}});return function(b){return m.apply(this,arguments)}}();w._fetchDataTilePage=function(){var m=n._asyncToGenerator(function*(b,c,f){const r=this._queryInfo;var d={start:this.pageSize*c,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:b.getQuantizationParameters()};y.isSome(this.maxRecordCountFactor)&&(d.maxRecordCountFactor=
this.maxRecordCountFactor);d=this._createQuery(b,d);try{const k=yield this._queue.push({tile:b,query:d,signal:f.signal,depth:c});l.throwIfAborted(f);return k?r!==this._queryInfo?this._fetchDataTilePage(b,c,f):{reader:k,query:d}:null}catch(k){return l.throwIfNotAbortError(k),null}});return function(b,c,f){return m.apply(this,arguments)}}();return q}(z.BaseFeatureSource);u.PagedFeatureSource=p;Object.defineProperty(u,"__esModule",{value:!0})});