// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/mathUtils ../../../../../../core/maybe ../../../../../../core/screenUtils ../../alignmentUtils ../../color ../../definitions ../../enums ../../number ../../materialKey/MaterialKey ./meshUtils ./segmentUtils ./WGLTextTemplate".split(" "),function(y,D,E,p,u,F,v,z,G,H,r,I,J,A,K){const L=E.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),M=(m,k="mapview-labeling")=>
L.error(new D(k,m)),N=function(m){const k=new Map;return h=>{k.has(h)||k.set(h,m(h));return k.get(h)}}(m=>{let k=0;if(0===m)return Infinity;for(;!(m%2);)k++,m/=2;return k});return function(m){function k(a,c,b,e){var d=m.call(this,a,b.font.size,b.haloSize||0,b.color&&z.premultiplyAlphaRGBAArray(b.color)||0,b.haloColor&&z.premultiplyAlphaRGBAArray(b.haloColor)||0,b.horizontalAlignment,b.verticalAlignment,J.isMapAligned(c.labelPlacement)?1:0,b.font.decoration,!1,b.angle||0,b.xoffset,b.yoffset,b.lineWidth,
b.lineHeight,null,null,null,null,null)||this;d._outLineLabelAngle=0;d._refPlacementPadding=0;d._refPlacementDirX=0;d._refPlacementDirY=0;d._refOffsetX=0;d._refOffsetY=0;d._zoomLevel=0;d.geometryType=H.WGLGeometryType.LABEL;var f=!!c.minScale&&e.scaleToZoom(c.minScale)||0;f=p.clamp(f,0,25.5);e=!!c.maxScale&&e.scaleToZoom(c.maxScale)||255;e=p.clamp(e,0,25.5);const [g,q]=v.getAlignmentFromPlacement(c.labelPlacement);d._xAlignD=g;d._yAlignD=q;d._minZoom=f;d._maxZoom=e;d._refPlacementPadding=F.pt2px(b.haloSize)+
G.TEXT_PLACEMENT_PADDING;a=I.LabelMaterialKey.load(a);a.sdf=!0;d._materialKey=a.data;return d}y._inheritsLoose(k,m);k.fromLabelClass=function(a,c){if("esriServerLinePlacementCenterAlong"===a.labelPlacement){const b=a.symbol;b.xoffset=0;b.yoffset=0;b.angle=0;b.font.decoration="none"}return new k(a.materialKey,a,a.symbol,c)};var h=k.prototype;h.setZoomLevel=function(a){this._zoomLevel=a};h.bindReferenceTemplate=function(a){let c=v.getXDirection(this._xAlignD),b=v.getYDirection(this._yAlignD);this._refOffsetY=
this._refOffsetX=0;if(u.isNone(a))this._refSymbolAndPlacementOffset=r.i8888to32(0,0,Math.floor(127*c+127),Math.floor(127*b+127));else{if("circle"===a.boundsType&&(c||b)){var e=Math.sqrt(c*c+b*b);c/=e;b/=e}e=Math.max(a.height,a.width);this._refSymbolAndPlacementOffset=r.i8888to32(4*this._refPlacementPadding,e,Math.floor(127*c+127),Math.floor(127*b+127));this._referenceSize=e;this._refPlacementDirX=c;this._refPlacementDirY=b;this._refOffsetX=a.xOffset;this._refOffsetY=a.yOffset}};h._write=function(a,
c){if(!u.isNone(this._shapingInfo)){var b=this._shapingInfo,e=c.getDisplayId(),d="esriGeometryPolygon"===c.geometryType?c.readLegacyCentroid():c.readLegacyGeometry();if(d)switch(this.current={out:a,inId:e,inShaping:b,zoomLevel:this._zoomLevel},c.geometryType){case "esriGeometryPolyline":this._placeLineLabels(d);break;case "esriGeometryPoint":case "esriGeometryPolygon":this._placePointLabels(d);break;default:M("mapview-labeling",`Geometry of type ${c.geometryType} is not supported`)}}};h._isVisible=
function(a,c){const b=Math.floor(10*this.current.zoomLevel);return Math.floor(10*a)<=b&&b<=Math.floor(10*c)};h._placePointLabels=function(a){const {out:c,inId:b,inShaping:e}=this.current;this._writeGlyphs(c,b,a,e)};h._placeLineLabels=function(a){a=A.smoothPaths(a.paths,this.current.inShaping.bounds.width);const c=this._placeSubdivGlyphs.bind(this),b=(this._shapedBox.width+128)/2;for(const e of a)A.pathDivide(e,b,c)};h._placeSubdivGlyphs=function(a,c,b,e){var d=N(c);b=p.log2(Math.min(b,e-b)/(8+this._shapedBox.width/
2/2));d=Math.max(this._minZoom,this.current.zoomLevel+1-(0===c?b:Math.min(d,b)));b=this._shapedBox.width/2*2**(this.current.zoomLevel-d);this.current.inShaping.isMultiline?0===c&&this._placeStraight(a,d):this._placeCurved(a,d,b)};h._placeStraight=function(a,c){const {out:b,inId:e,inShaping:d}=this.current;this._writeGlyphs(b,e,a,d,c)};h._placeCurved=function(a,c,b){const {out:e,inId:d}=this.current;e.metricStart(d,c,a.x,a.y,0,0,0,0);const f=a.clone(),g=(180/Math.PI*a.angle+180)%360;this._outLineLabelAngle=
Math.round(180/Math.PI*a.angle%360*(254/360));this._placeFirst(f,c,1);this._placeBack(a,f,c,b,1);this._placeForward(a,f,c,b,1);this._outLineLabelAngle=Math.round(254/360*g);this._placeFirst(f,c,0);this._placeBack(a,f,c,b,0);this._placeForward(a,f,c,b,0);e.metricEnd()};h._placeBack=function(a,c,b,e,d){const f=a.clone();for(a=a.backwardLength+0;f.prev()&&!(a>=e);)this._placeOnSegment(f,c,a,b,-1,d),a+=f.length+0};h._placeForward=function(a,c,b,e,d){const f=a.clone();for(a=a.remainingLength+0;f.next()&&
!(a>=e);)this._placeOnSegment(f,c,a,b,1,d),a+=f.length+0};h._placeFirst=function(a,c,b){const e=this.current.inShaping;var d=e.glyphs;const f=this.current.zoomLevel,{out:g,inId:q}=this.current;for(const l of d)d=l.x>e.bounds.x?b:1-b,d=Math.max(0,f+p.log2(Math.abs(l.x+l.width/2-e.bounds.x)/(d*a.remainingLength+(1-d)*a.backwardLength))),d=Math.max(c,d),l.maxZoom=25,l.angle=a.angle+(1-b)*Math.PI,l.minZoom=d,0>a.x||512<=a.x||0>a.y||512<=a.y||(this._writeGlyph(g,q,a.x,a.y,l),b&&this._isVisible(l.minZoom,
l.maxZoom)&&(d=l.bounds,g.metricBoxWrite(d.center[0],d.center[1],d.width,d.height)))};h._placeOnSegment=function(a,c,b,e,d,f){var g=this.current.inShaping.glyphs;const {out:q,inId:l}=this.current,B=this.current.inShaping,C=this.current.zoomLevel;var w=a.x+a.dx/a.length*-d*b,x=a.y+a.dy/a.length*-d*b;for(const n of g)if((g=n.x>B.bounds.x?f:1-f)&&1===d||!g&&-1===d){var t=Math.abs(n.x+n.width/2-B.bounds.x);g=Math.max(0,C+p.log2(t/b)-.1);t=Math.max(e,C+p.log2(t/(b+a.length+0)));0!==g&&(n.angle=a.angle+
(1-f)*Math.PI,n.minZoom=t,n.maxZoom=g,0>w||512<=w||0>x||512<=x||(this._writeGlyph(q,l,w,x,n),f&&this._isVisible(n.minZoom,n.maxZoom)&&(g=n.bounds,q.metricBoxWrite(g.center[0]+(a.x-c.x),g.center[1]+(a.y-c.y),g.width,g.height))))}};h._writeGlyphs=function(a,c,b,e,d=this._minZoom){if(!(0>b.x||512<=b.x||0>b.y||512<=b.y)){var f=b.x+this._refOffsetX;b=b.y-this._refOffsetY;for(const g of e.glyphs)g.minZoom=d,g.maxZoom=this._maxZoom,this._writeGlyph(a,c,f,b,g);e=e.boundsT;a.metricStart(c,d,f,b,this._refPlacementDirX,
this._refPlacementDirY,this._referenceSize,this._materialKey);a.metricBoxWrite(e.center[0],e.center[1],e.width,e.height);a.metricEnd()}};h._writeVertexCommon=function(a,c,b,e){const d=this._color,f=this._haloColor,g=r.i8888to32(0,0,this._size,this._haloSize);e=r.i8888to32(Math.floor(10*Math.max(e.minZoom,this._minZoom)),Math.floor(10*Math.min(e.maxZoom,this._maxZoom)),this._outLineLabelAngle,0);a.vertexWrite(b);a.vertexWrite(c);a.vertexWrite(d);a.vertexWrite(f);a.vertexWrite(g);a.vertexWrite(this._refSymbolAndPlacementOffset);
a.vertexWrite(e)};y._createClass(k,[{key:"_shapedBox",get:function(){return u.unwrap(this._shapingInfo).bounds}}]);return k}(K)});