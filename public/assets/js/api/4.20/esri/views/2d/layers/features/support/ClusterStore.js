// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../geometry ../../../../../core/Evented ../../../../../core/has ../../../../../core/maybe ../../../../../core/accessorSupport/diffUtils ../../../../../geohash/GeohashTree ../../../../../geohash/geohashUtils ../../../../../geometry/support/Ellipsoid ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/projectionSupport ../../../engine/webgl/definitions ../Store2D ./FeatureSetReaderJSON ../../../../../geometry/SpatialReference".split(" "),
function(I,C,K,R,L,x,M,S,D,y,T,N,O,U,E,p,V,W,F){let P=function(z){function r(b,a,c,d,e){a=new U([],[a,c]);b=z.call(this,a,d,null,b)||this;b.geohashBoundsInfo=e;return b}C._inheritsLoose(r,z);r.create=function(b,a,c,d,e,f,l,m){a=new r(a,c,d,f,l);a.displayId=b.createDisplayId(!0);a.referenceId=m;a.tileLevel=e;return a};var g=r.prototype;g.update=function(b,a,c,d,e,f){this.geometry.coords[0]=b;this.geometry.coords[1]=a;this.tileLevel=c;this.attributes=d;this.geohashBoundsInfo=e;this.referenceId=null;
this.referenceId=f;return this};g.toJSON=function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}};C._createClass(r,[{key:"count",get:function(){return this.attributes.cluster_count}}]);return r}(O);K=function(z){function r(b,a,c){var d=z.call(this,b,c)||this;d.events=new R;d._geohashLevel=0;d._aggregateValueRanges={};d._aggregateValueRangesChanged=
!1;d._geohashBuf=[];d._clusters=new Map;d._tiles=new Map;d.geometryInfo=b.geometryInfo;d._spatialReference=a;d._projectionSupportCheck=E.checkProjectionSupport(a,F.WGS84);d._bitsets.geohash=c.getBitset(c.createBitset());d._bitsets.inserted=c.getBitset(c.createBitset());return d}C._inheritsLoose(r,z);var g=r.prototype;g.updateSchema=function(){var b=C._asyncToGenerator(function*(a,c){const d=this._schema;try{yield z.prototype.updateSchema.call(this,a,c),yield this._projectionSupportCheck}catch(f){}const e=
M.diff(d,c);if(!c||x.isNone(e)&&!a.source&&!a.storage.filters)d&&(a.mesh=!0);else{if(M.hasDiff(e,"params.fields")||!this._tree||a.source)this._tree=new S.GeohashTree(this._statisticFields),this._rebuildTree(),L("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing");L("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",e);a.targets[c.name]=!0;a.mesh=!1;this._aggregateValueRanges={}}});return function(a,c){return b.apply(this,arguments)}}();g.sweepFeatures=
function(b,a){this._bitsets.inserted.forEachSet(c=>{b.has(c)||(c=a.lookupByDisplayIdUnsafe(c),this._remove(c))})};g.sweepClusters=function(b,a,c){this._clusters.forEach((d,e)=>{d&&d.tileLevel!==c&&(b.releaseDisplayId(d.displayId),a.unsetAttributeData(d.displayId),this._clusters.delete(e))})};g.onTileData=function(b,a,c,d,e=!0){if(!this._schema||x.isNone(a.addOrUpdate))return a;var f=this._tree,l=this._getTransforms(b,this._spatialReference);{const m=a.addOrUpdate.getCursor();for(;m.next();)this._update(m,
d,f)}if(a.status.mesh||!e)return a;d=[];this._getClustersForTile(d,b,this._schema.params.clusterRadius,c,f,l);a.addOrUpdate=W.FeatureSetReaderJSON.fromOptimizedFeatures(d,"esriGeometryPoint");a.addOrUpdate.attachStorage(c);a.end=!0;for(f=a.addOrUpdate.getCursor();f.next();)l=f.getDisplayId(),this._bitsets.computed.unset(l),this.setComputedAttributes(c,f,l,b.scale);this._aggregateValueRangesChanged&&a.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=
!1);return a};g.onTileUpdate=function({added:b,removed:a}){b.length&&this._setGeohashLevel(b[0].level);if(this._schema){var c=this._schema.params.clusterRadius;a.forEach(d=>{this._tiles.delete(d.key.id);this._markTileClustersForDeletion(d,c)})}};g.getAggregate=function(b){let a=null;this._clusters.forEach(c=>{c&&c.displayId===b&&(a=c.toJSON())});return a};g.getDisplayId=function(b){return(b=this._clusters.get(b))?b.displayId:null};g.getFeatureDisplayIdsForAggregate=function(b){b=this._clusters.get(b);
if(!b)return[];b=b.geohashBoundsInfo;return this._tree.getRegionDisplayIds(b.xLL,b.yLL,b.xTR,b.yTR,b.level)};g.getDisplayIdForReferenceId=function(b){let a;this._clusters.forEach(c=>{c&&c.referenceId===b&&(a=c.displayId)});return a};g.getAggregateValueRanges=function(){return this._aggregateValueRanges};g.forEach=function(b){this._clusters.forEach((a,c)=>{a&&b(a,c)})};g.size=function(){let b=0;this.forEach(a=>b++);return b};g._rebuildTree=function(){this._bitsets.computed.clear();this._bitsets.inserted.clear();
this._tree&&this._tree.clear()};g._remove=function(b){const a=b.getDisplayId(),c=b.getXHydrate(),d=b.getYHydrate(),e=this._geohashBuf[2*a],f=this._geohashBuf[2*a+1];this._bitsets.inserted.has(a)&&(this._bitsets.inserted.unset(a),this._tree.removeCursor(b,c,d,e,f,this._geohashLevel))};g._update=function(b,a,c){const d=b.getDisplayId(),e=this._bitsets.inserted;a=a.isVisible(d);var f=e.has(d);a!==f&&(a?(a=b.getXHydrate(),f=b.getYHydrate(),this._setGeohash(d,a,f)&&(c.insertCursor(b,d,a,f,this._geohashBuf[2*
d],this._geohashBuf[2*d+1],this._geohashLevel),e.set(d))):this._remove(b))};g._setGeohash=function(b,a,c){if(this._bitsets.geohash.has(b))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator)a=a/y.earth.radius*57.29577951308232,D.setGeohashBuf(d,b,57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-1*c/y.earth.radius))),a-360*Math.floor((a+180)/360),12);else{c=E.project({x:a,y:c},this._spatialReference,F.WGS84);if(!c)return!1;D.setGeohashBuf(d,b,c.y,c.x,12)}this._bitsets.geohash.set(b);
return!0};g._getClustersForTile=function(b,a,c,d,e,f,l=!0){var m=this._schema.params.clusterPixelBuffer,q=2*c;c=this._getGeohashLevel(a.key.level);const A=Math.ceil(2**a.key.level*p.TILE_SIZE/q);var u=Math.ceil(m/q)+0,t=Math.ceil(p.TILE_SIZE/q);const {row:G,col:v}=a.key;var h=Math.floor(v*p.TILE_SIZE/q)-u;q=Math.floor(G*p.TILE_SIZE/q)-u;m=h+t+2*u;u=q+t+2*u;for(t=a.tileInfoView.getLODInfoAt(a.key.level);h<=m;h++)for(let B=q;B<=u;B++){var k=h;t.wrap&&(k=0>h?h+A:h%A);const J=t.wrap&&0>h,H=t.wrap&&h%
A!==h;k=this._lookupCluster(d,t,a.key.level,k,B,c,e);if(x.isSome(k)){var n=x.andThen(f,w=>J?w.left:H?w.right:w.tile);if((!l||!x.isNone(n))&&k.count&&x.isSome(n)&&l){const w=k.geometry.clone();let Q=k.attributes;w.coords[0]=N.quantizeX(n,w.coords[0]);w.coords[1]=N.quantizeY(n,w.coords[1]);1===k.count&&x.isSome(k.referenceId)&&(Q={...k.attributes,referenceId:k.referenceId});n=new O(w,Q);n.displayId=k.displayId;b.push(n)}}}};g._getGeohashLevel=function(b){return Math.min(Math.ceil(b/2+2),12)};g._setGeohashLevel=
function(b){b=this._getGeohashLevel(b);b=1*(Math.floor(b/1)+1)-1;this._geohashLevel!==b&&(this._geohashLevel=b,this._rebuildTree(),this._bitsets.geohash.clear())};g._getTransforms=function(b,a){const c={originPosition:"upperLeft",scale:[b.resolution,b.resolution],translate:[b.bounds[0],b.bounds[3]]};a=T.getInfo(a);if(!a)return{tile:c,left:null,right:null};const [d,e]=a.valid;return{tile:c,left:{...c,translate:[e,b.bounds[3]]},right:{...c,translate:[d-e+b.bounds[0],b.bounds[3]]}}};g._getClusterId=
function(b,a,c){return(b&15)<<28|(a&16383)<<14|c&16383};g._markForDeletion=function(b,a,c){b=this._getClusterId(b,a,c);this._clusters.delete(b)};g._getClusterBounds=function(b,a,c){var d=this._schema.params.clusterRadius,e=2*d;a=c%2?a*e:a*e-d;const f=c*e;d=a+e;c=2**b.level*p.TILE_SIZE;b.wrap&&0>a&&(a=0);b.wrap&&d>c&&(d=c);c=f/p.TILE_SIZE;d/=p.TILE_SIZE;e=(f-e)/p.TILE_SIZE;a=b.getXForColumn(a/p.TILE_SIZE);c=b.getYForRow(c);d=b.getXForColumn(d);b=b.getYForRow(e);return[a,c,d,b]};g._lookupCluster=function(b,
a,c,d,e,f,l){const m=this._getClusterId(c,d,e),q=this._clusters.get(m),[A,u,t,G]=this._getClusterBounds(a,d,e);var v={x:A,y:u};e={x:t,y:G};var h=d=a=0,k=0;if(this._spatialReference.isWebMercator)a=v.x/y.earth.radius*57.29577951308232,a-=360*Math.floor((a+180)/360),d=57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-1*v.y/y.earth.radius))),h=e.x/y.earth.radius*57.29577951308232,h-=360*Math.floor((h+180)/360),k=57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-1*e.y/y.earth.radius)));else{d=E.project(v,
this._spatialReference,F.WGS84);e=E.project(e,this._spatialReference,F.WGS84);if(!d||!e)return null;a=d.x;d=d.y;h=e.x;k=e.y}v={geohashX:0,geohashY:0};e={geohashX:0,geohashY:0};D.setGeohashXY(v,d,a,f);D.setGeohashXY(e,k,h,f);d=v.geohashX;h=v.geohashY;k=e.geohashX;e=e.geohashY;a={xLL:d,yLL:h,xTR:k,yTR:e,level:f};d=l.getRegionStatistics(d,h,k,e,f);const {count:n,xTotal:B,yTotal:J,referenceId:H}=d;f=n?B/n:0;l=n?J/n:0;if(0===n)return this._clusters.set(m,null),null;d={cluster_count:n,...d.attributes};
b=x.isSome(q)?q.update(f,l,c,d,a,H):P.create(b,m,f,l,c,d,a,H);0===n&&(b.geometry.coords[0]=(A+t)/2,b.geometry.coords[1]=(u+G)/2);this._clusters.set(m,b);this._updateAggregateValueRangeForCluster(b,b.tileLevel);return b};g._updateAggregateValueRangeForCluster=function(b,a){const c=this._aggregateValueRanges[a]||{minValue:Infinity,maxValue:0},d=c.minValue,e=c.maxValue;c.minValue=Math.min(d,b.count);c.maxValue=Math.max(e,b.count);this._aggregateValueRanges[a]=c;if(d!==c.minValue||e!==c.maxValue)this._aggregateValueRangesChanged=
!0};g._markTileClustersForDeletion=function(b,a){var c=2*a;a=Math.ceil(p.TILE_SIZE/c);const {row:d,col:e}=b.key,f=Math.floor(e*p.TILE_SIZE/c);c=Math.floor(d*p.TILE_SIZE/c);for(let l=f;l<f+a;l++)for(let m=c;m<c+a;m++)this._markForDeletion(b.key.level,l,m)};return r}(V.Store2D);I.ClusterInfo=P;I.ClusterStore=K;Object.defineProperty(I,"__esModule",{value:!0})});