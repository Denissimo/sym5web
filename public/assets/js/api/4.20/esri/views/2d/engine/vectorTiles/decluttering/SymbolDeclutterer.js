// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","./config"],function(w,x,y,z){function A(g,d){if(g.priority-d.priority)return g.priority-d.priority;const a=g.tile.key,b=d.tile.key;return a.world-b.world?a.world-b.world:a.level-b.level?a.level-b.level:a.row-b.row?a.row-b.row:a.col-b.col?a.col-b.col:g.xTile-d.xTile?g.xTile-d.xTile:g.yTile-d.yTile}let B=function(){function g(a,b,h,c,k,l){this._visibleTiles=a;this._symbolRepository=b;this._createCollisionJob=
h;this._assignTileSymbolsOpacity=c;this._symbolLayerSorter=k;this._isLayerVisible=l;this._selectionJob=null;this._selectionJobCompleted=!1;this._collisionJob=null;this._collisionJobCompleted=!1;this._opacityJob=null;this._opacityJobCompleted=!1;this._running=!0}var d=g.prototype;d.setScreenSize=function(a,b){this._screenWidth===a&&this._screenHeight===b||this.restart();this._screenWidth=a;this._screenHeight=b};d.restart=function(){this._selectionJob=null;this._selectionJobCompleted=!1;this._collisionJob=
null;this._collisionJobCompleted=!1;this._opacityJob=null;this._opacityJobCompleted=!1;this._running=!0};d.continue=function(a){this._selectionJob||(this._selectionJob=this._createSelectionJob());if(!this._selectionJobCompleted){var b=performance.now();if(!this._selectionJob.work(a))return!1;this._selectionJobCompleted=!0;a=Math.max(0,a-(performance.now()-b));if(0===a)return!1}this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight));
if(!this._collisionJobCompleted){b=performance.now();if(!this._collisionJob.work(a))return!1;this._collisionJobCompleted=!0;a=Math.max(0,a-(performance.now()-b));if(0===a)return!1}this._opacityJob||(this._opacityJob=this._createOpacityJob());if(!this._opacityJobCompleted){b=performance.now();if(!this._opacityJob.work(a))return!1;this._opacityJobCompleted=!0;a=Math.max(0,a-(performance.now()-b));if(0===a)return!1}this._running=!1;return!0};d._createSelectionJob=function(){const a=this._symbolRepository.uniqueSymbols,
b=[];let h=0,c=0;const k=this._isLayerVisible,l=this._symbolLayerSorter;return{work:function(m){const n=performance.now();for(;c<a.length;c++,h=0){const p=a[c];var e=p.styleLayerUID;if(!k(e)){b[c]||(b[c]={styleLayerUID:e,symbols:[]});continue}b[c]=b[c]||{styleLayerUID:e,symbols:[]};const f=b[c];for(;h<p.uniqueSymbols.length;h++){e=p.uniqueSymbols[h];if(99===h%100&&performance.now()-n>m)return!1;let t=null,u=!1,v=!1;for(const q of e.tileSymbols)if(q.selectedForRendering=!1,!v||!u){const r=q.tile;if(!t||
r.isCoverage||r.neededForCoverage&&!u){t=q;if(r.neededForCoverage||r.isCoverage)v=!0;r.isCoverage&&(u=!0)}}t.selectedForRendering=!0;if(v){f.symbols.push(t);e.show=!0;for(const q of e.parts)q.show=!0}else e.show=!1}}for(const p of b)p.symbols.sort(A);return!0},get sortedSymbols(){return b.sort(l)}}};d._createOpacityJob=function(){function a(k,l){var m=k.symbols;for(const [,e]of m){var n=e;m=l;for(const p of n){n=p.unique;for(const f of n.parts)f.startOpacity+=(m-f.startTime)/z.FADE_DURATION*(.5<f.targetOpacity?
1:-1),f.startOpacity=Math.min(Math.max(f.startOpacity,0),1),f.startTime=m,f.targetOpacity=n.show&&f.show?1:0}}b(k,l);for(const e of k.childrenTiles)a(e,l)}const b=this._assignTileSymbolsOpacity,h=this._visibleTiles;let c=0;return{work(k){const l=performance.now();for(;c<h.length;c++){if(performance.now()-l>k)return!1;const m=h[c];if(y.isSome(m.parentTile))continue;const n=performance.now();a(m,n)}return!0}}};x._createClass(g,[{key:"running",get:function(){return this._running}}]);return g}();w.SymbolDeclutterer=
B;Object.defineProperty(w,"__esModule",{value:!0})});