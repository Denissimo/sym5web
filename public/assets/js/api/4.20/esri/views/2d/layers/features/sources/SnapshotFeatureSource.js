// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/RandomLCG ./BaseFeatureSource ../support/FeatureSetReaderPBFIndirect ../support/UpdateToken".split(" "),function(y,q,z,A,r,w,B,C,D,v){function E(n,k,l){var b=n.getXHydrate();n=n.getYHydrate();b=k.getColumnForX(b);b=Math.floor(k.normalizeCol(b));k=Math.floor(k.getRowForY(n));return`${l}/${k}/${b}`}function x(n,
k){if(r.isNone(n))return null;k=k.transform;const l=n.getQuantizationTransform();if(r.isNone(l)){const [h,t]=k.scale,[u,p]=k.translate;return n.transform(-u/h,p/t,1/h,1/-t)}const [b,a]=l.scale,[c,g]=l.translate,[d,f]=k.scale,[e,m]=k.translate;return n.transform((c-e)/d,(-g+m)/f,b/d,a/f)}const F=A.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");z=function(n){function k(b){var a=n.call(this,b)||this;a.mode="snapshot";a._loading=!0;a._controller=new AbortController;a._downloadPromise=
null;a._didSendEnd=!1;a._queries=[];a._invalidated=!1;a._hasAggregates=!1;a._random=new B(1E3);a._featureCount=b.featureCount;a._store=b.store;a._markedIdsBufId=a._store.storage.createBitset();return a}q._inheritsLoose(k,n);var l=k.prototype;l.destroy=function(){n.prototype.destroy.call(this);this._controller.abort()};l.update=function(b,a){n.prototype.update.call(this,b,a);this._hasAggregates=b.targets.aggregate};l.resend=function(){var b=q._asyncToGenerator(function*(a=!1){yield this._downloadPromise;
this._invalidated||a?(this._invalidated=!1,this._subscriptions.forEach(c=>c.clear()),this._downloadPromise=this._download(this._featureCount),yield this._downloadPromise):(a=this._queries.map(({query:c,reader:g})=>this._sendPatchQuery(c,g)),yield Promise.all(a),this._subscriptions.forEach(c=>{c.requests.done.forEach(g=>this._onMessage(g.message))}))});return function(){return b.apply(this,arguments)}}();l.refresh=function(){var b=q._asyncToGenerator(function*(){yield this.resend(!0)});return function(){return b.apply(this,
arguments)}}();l._sendPatchQuery=function(){var b=q._asyncToGenerator(function*(a,c){const g=r.isSome(a.outFields)?a.outFields:[],d=this._queryInfo.outFields,f=d.filter(h=>-1===g.indexOf(h));if(f.length){var e=a.clone(),m=this._signal;e.returnGeometry=!1;e.returnCentroid=!1;e.outFields=f;a.outFields=d;a=yield this._queue.push({query:e,depth:0,signal:m});w.throwIfAborted({signal:m});c.joinAttributes(a)}});return function(a,c){return b.apply(this,arguments)}}();l._fetchDataTile=function(){var b=q._asyncToGenerator(function*(a){this._downloadPromise||
(this._downloadPromise=this._download(this._featureCount));var c=this._store.search(a);const g=this._subscriptions.get(a.key.id),d=c.length-1;for(let e=0;e<d;e++){var f=x(c[e],a);f={type:"append",id:a.id,addOrUpdate:f,end:!1,status:v.UpdateToken.empty()};g.add({query:null,message:f});this._hasAggregates||(yield w.after(1));this._onMessage(f)}c=x(0<=d?c[d]:null,a);a={type:"append",id:a.id,addOrUpdate:c,end:this._didSendEnd,status:v.UpdateToken.empty()};g.add({query:null,message:a});this._onMessage(a)});
return function(a){return b.apply(this,arguments)}}();l._download=function(){var b=q._asyncToGenerator(function*(a){try{yield this.whenInitialized();const c=this._store.storage.getBitset(this._markedIdsBufId),g=new Set;c.clear();const d=Array.from({length:Math.ceil(a/this.pageSize)},(f,e)=>e).sort((f,e)=>this._random.getInt()-this._random.getInt()).map(f=>this._downloadPage(f,c,g));yield Promise.all(d);this._store.sweepFeatures(c,this._store.storage);this._store.sweepFeatureSets(g)}catch(c){F.error("mapview-snapshot-source",
"Encountered and error when downloading feature snapshot",c)}this._sendEnd();this._loading=!1});return function(a){return b.apply(this,arguments)}}();l._downloadPage=function(){var b=q._asyncToGenerator(function*(a,c,g){var d=this.pageSize;d={start:a*d,num:d,cacheHint:!0};r.isSome(this.maxRecordCountFactor)&&(d.maxRecordCountFactor=this.maxRecordCountFactor);d=this.createQuery(d);const f=this._signal;a=yield this._queue.push({query:d,depth:a,signal:f});w.throwIfAborted({signal:f});this._queries.push({query:d,
reader:a});this._store.insert(a);g.add(a.instance);for(g=a.getCursor();g.next();)c.set(g.getDisplayId());this._send(a)});return function(a,c,g){return b.apply(this,arguments)}}();l._send=function(b){if(this._subscriptions.size){var a=null,c=new Map,g=new Set,d=new Map;this._subscriptions.forEach(e=>{var m,h=e.tile;c.set(h.key.id,null);a=h.tileInfoView;g.add(h.level);const {row:t,col:u}=h.key;h=`${h.level}/${t}/${u}`;const p=null!=(m=d.get(h))?m:[];p.push(e);d.set(h,p)});for(const e of g){const m=
a.getLODInfoAt(e),h=b.getCursor();for(;h.next();){var f=E(h,m,e);const t=h.getIndex();if(d.has(f))for(const u of d.get(f)){f=u.tile.id;let p=c.get(f);r.isNone(p)&&(p=[],c.set(f,p));p.push(t)}}}c.forEach((e,m)=>{if(r.isSome(e)){const h=this._subscriptions.get(m);e=x(D.FeatureSetReaderIndirect.from(b,e),h.tile);m={type:"append",id:m,addOrUpdate:e,end:!1,status:v.UpdateToken.empty()};h.add({query:null,message:m});this._onMessage(m)}})}};l._sendEnd=function(){this._subscriptions.forEach(b=>{const a={type:"append",
id:b.tile.id,addOrUpdate:null,end:!0,status:v.UpdateToken.empty()};b.add({query:null,message:a});this._onMessage(a)});this._didSendEnd=!0};q._createClass(k,[{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}}]);return k}(C.BaseFeatureSource);y.SnapshotFeatureSource=z;Object.defineProperty(y,"__esModule",{value:!0})});