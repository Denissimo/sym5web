// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/pbf ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ./FeatureSetReader ./FeatureSetReaderPBFHeader".split(" "),function(y,z,I,u,v,J,A,K,r,B,L){function M(g){var l=g.getLength();for(l=g.pos()+l;g.pos()<l&&g.next();)switch(g.tag()){case 1:return g.getString();
case 2:return g.getFloat();case 3:return g.getDouble();case 4:return g.getSInt32();case 5:return g.getUInt32();case 6:return g.getInt64();case 7:return g.getUInt64();case 8:return g.getSInt64();case 9:return g.getBool();default:return g.skip(),null}return null}const N=u.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF");u=function(g){function l(a,b,c,f){a=g.call(this,a)||this;a._hasNext=!1;a._isPoints=!1;a._isPolygons=!1;a._featureIndex=-1;a._featureOffset=0;a._cache={area:0,unquantGeometry:void 0,
geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0};a._geometryType=f;a._reader=b;a._header=c;a._hasNext=c.hasFeatures;a._isPoints="esriGeometryPoint"===f;a._isPolygons="esriGeometryPolygon"===f;return a}z._inheritsLoose(l,g);l.fromBuffer=function(a,b,c=!1){a:{try{const h=new J(new Uint8Array(a),new DataView(a));for(;h.next();)switch(h.tag()){case 2:b:{for(var f=h.getMessage();f.next();)switch(f.tag()){case 1:var e=f.getMessage();break b;default:f.skip()}e=null}break a;default:h.skip()}}catch(h){a=
new I("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:h}),N.error(a)}e=null}a=e;c=L.parseHeader(a,"esriGeometryPoint"===b,c);e=B.FeatureSetReader.createInstance();return new l(e,a,c,b)};var d=l.prototype;d.getSize=function(){return this.size};d.getQuantizationTransform=function(){return this._header.transform};d.getCursor=function(){return this.copy()};d.getIndex=function(){return this._featureIndex};d.setIndex=function(a){this._cache.area=0;this._cache.unquantGeometry=void 0;
this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;this._cache.optFeature=void 0;this._featureIndex=a};d.getAttributeHash=function(){let a="";this._header.fields.forEach(({index:b})=>{a+=this._readAttributeAtIndex(b)+"."});return a};d.getObjectId=function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)};d.getDisplayId=function(){return this._header.displayIds[this._featureIndex]};d.setDisplayId=function(a){this._header.displayIds[this._featureIndex]=
a};d.getGroupId=function(){return this._header.groupIds[this._featureIndex]};d.setGroupId=function(a){this._header.groupIds[this._featureIndex]=a};d.readLegacyFeature=function(){if(void 0===this._cache.legacyFeature){var a,b=this.readCentroid();b={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(a=b&&{x:b.coords[0],y:b.coords[1]})?a:null};return this._cache.legacyFeature=b}return this._cache.legacyFeature};d.readOptimizedFeature=
function(){if(void 0===this._cache.optFeature){const a=new K(this.readGeometry(),this.readAttributes(),this.readCentroid());a.objectId=this.getObjectId();a.displayId=this.getDisplayId();return this._cache.optFeature=a}return this._cache.optFeature};d.getXHydrate=function(){const a=this._header.centroid[2*this._featureIndex],b=this.getQuantizationTransform();return v.isNone(b)?a:a*b.scale[0]+b.translate[0]};d.getYHydrate=function(){const a=this._header.centroid[2*this._featureIndex+1],b=this.getQuantizationTransform();
return v.isNone(b)?a:b.translate[1]-a*b.scale[1]};d.getX=function(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx};d.getY=function(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty};d.readLegacyPointGeometry=function(){const a=this.getX(),b=this.getY();return{x:a,y:b}};d.readLegacyGeometry=function(){const a=this.readGeometry();return A.convertToGeometry(a,this.geometryType,!1,!1)};d.readLegacyCentroid=function(){const a=this.readCentroid();if(!a)return null;
const [b,c]=a.coords;return{x:b,y:c}};d.readGeometryArea=function(){this._cache.area||this.readGeometry();return this._cache.area};d.readUnquantizedGeometry=function(){if(void 0===this._cache.unquantGeometry){var a=this.readGeometry();if(!a)return this._cache.unquantGeometry=null;a=a.clone();const b=a.lengths,c=a.coords;for(let f=0,e=2;f<b.length;f++,e+=2){const h=b[f];for(let k=1;k<h;k+=1,e+=2)c[e]+=c[e-2],c[e+1]+=c[e-1]}return this._cache.unquantGeometry=a}return this._cache.unquantGeometry};d.readHydratedGeometry=
function(){if(this._isPoints){if(268435455===this._header.centroid[2*this._featureIndex])return null;var a=this.getXHydrate(),b=this.getYHydrate();return new r([],[a,b])}a=this.readGeometry();if(!a)return null;a=a.clone();b=this.getQuantizationTransform();v.isSome(b)&&A.unquantizeOptimizedGeometry(a,a,this.hasZ,this.hasM,b);return a};d.readGeometry=function(){if(void 0===this._cache.geometry){var a=null;if(this._isPoints){if(268435455===this._header.centroid[2*this._featureIndex])return null;a=this.getX();
var b=this.getY();a=new r([],[a,b])}else{b=this._header.offsets.geometry[this._featureIndex];const c=this._reader;if(0===b)return null;c.move(b);try{a=this._parseGeometry(c)}catch(f){return console.error("Failed to parse geometry!",f),null}}return this._cache.geometry=a}return this._cache.geometry};d.readCentroid=function(){if(void 0===this._cache.centroid){var a=null;a=this._header.centroid[2*this._featureIndex]+this._tx;const b=this._header.centroid[2*this._featureIndex+1]+this._ty;if(268435455===
a){if(a=this._computeCentroid())this._header.centroid[2*this._featureIndex]=a.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=a.coords[1]-this._ty}else a=new r([],[a,b]);return this._cache.centroid=a}return this._cache.centroid};d.copy=function(){var a=this._reader.clone();a=new l(this.instance,a,this._header,this.geometryType);this.copyInto(a);return a};d.next=function(){this._cache.area=0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;
this._cache.legacyFeature=void 0;for(this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size};d._readAttribute=function(a,b){a=this._header.hasField(a)?a:a.toLowerCase().trim();var c=this._header.getFieldIndex(a);if(null!=c)return c=this._readAttributeAtIndex(c),b&&null!=c?this._header.isDateField(a)?new Date(c):c:c};d._readAttributes=function(){const a={};this._header.fields.forEach(({fieldName:b,index:c})=>{a[b]=this._readAttributeAtIndex(c)});
return a};d.copyInto=function(a){g.prototype.copyInto.call(this,a);a._featureIndex=this._featureIndex;a._featureOffset=this._featureOffset;a._hasNext=this._hasNext};d._readAttributeAtIndex=function(a){const b=this._reader;b.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]);return M(b)};d._preprocessPolygon=function(a,b){let c=0,f=0,e=0;var h=!1,k=!1;let C=!1,D=-1;const w=[];let E=0,F=!1;for(let x=0;x<b.length;x++){const t=b[x];var n=a[2*c],q=a[2*c+1],m=0;for(var p=
1;p<t;p++){const G=n+a[2*(c+p)],H=q+a[2*(c+p)+1],O=(G-n)*(H+q);n=G;q=H;m+=.5*O}(n=0<m)&&F&&(f+=t);n||(D++,F=!1);if(1E6<=D)break;E+=m;h&&n&&k&&(C=!0);a[2*e]=a[2*f];a[2*e++ +1]=a[2*f++ +1];h=1;k=a[2*f];m=a[2*f++ +1];for(n=2;n<t;n++)q=a[2*f],p=a[2*f++ +1],0===k*p-q*m&&0<k*q+m*p?(k+=q,m+=p):(a[2*e]=k,a[2*e++ +1]=m,h++,k=q,m=p);a[2*e]=k;a[2*e++ +1]=m;h++;w.push(h);h=!1;k=!0;c+=t}return w.length?(this._cache.area=Math.abs(E),new r(w,a,C)):null};d._parseGeometry=function(a){var b=a.getLength();const c=a.pos()+
b;b=[];const f=[];for(;a.pos()<c&&a.next();)switch(a.tag()){case 2:var e=a.getUInt32();for(e=a.pos()+e;a.pos()<e;)f.push(a.getUInt32());break;case 3:e=a.getUInt32();for(e=a.pos()+e;a.pos()<e;)b.push(a.getSInt32()),b.push(a.getSInt32()),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();break;default:a.skip()}a=0;for(const h of f)b[2*a]+=this._tx,b[2*a+1]+=this._ty,a+=h;return this._isPolygons?this._preprocessPolygon(b,f):new r(f,b)};z._createClass(l,[{key:"geometryType",get:function(){return this._geometryType}},
{key:"size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}}]);return l}(B.FeatureSetReader);y.FeatureSetReaderPBF=u;Object.defineProperty(y,"__esModule",
{value:!0})});