// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Program ../../../webgl/ProgramCache ../../../webgl/Renderbuffer ../../../webgl/RenderingContext ../../../webgl/ShaderCompiler ../../../webgl/Texture ../../../webgl/VertexArrayObject ./definitions ./Utils ./util/debug".split(" "),function(z,A,B,
C,t,e,G,I,H,J,K,L,M,N,D,O,l,n,E){const u=t.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),v=E.createDebugLogger(E.DEBUG_ATTR_UPDATES,u);let F=function(){function m(a,b,d){this._lastTexture=this._texture=null;this._fbos={};this.texelSize=4;const {buffer:c,pixelType:g,textureOnly:h}=a;a=n.getPixelArrayCtor(g);this.shared=d;this.pixelType=g;this.size=b;this.textureOnly=h;h||(this.data=new a(e.unwrap(c)));this._resetRange()}var f=m.prototype;f.destroy=function(){e.andThen(this._texture,a=>
a.dispose());for(const a in this._fbos)e.andThen(this._fbos[a],b=>{"0"===a&&b.detachColorTexture();b.dispose()}),this._fbos[a]=null;this._texture=null};f.setData=function(a,b,d){a&=2147483647;const c=e.unwrap(this.data);b=a*this.texelSize+b;!c||b>=c.length||(c[b]=d,this.dirtyStart=Math.min(this.dirtyStart,a),this.dirtyEnd=Math.max(this.dirtyEnd,a))};f.getData=function(a,b){if(e.isNone(this.data))return null;a=(a&2147483647)*this.texelSize+b;return!this.data||a>=this.data.length?null:this.data[a]};
f.getTexture=function(a){return e.unwrapOr(this._texture,()=>this._initTexture(a))};f.getFBO=function(a,b=0){if(e.isNone(this._fbos[b])){const d=0===b?this.getTexture(a):this._textureDesc;this._fbos[b]=new H(a,{colorTarget:0,depthStencilTarget:0},d)}return this._fbos[b]};f.updateTexture=function(a,b){if(!this.locked){try{const d=this.dirtyStart,c=this.dirtyEnd;if(!this.hasDirty)return;this._resetRange();const g=e.unwrap(this.data).buffer,h=this.getTexture(a),k=(d-d%this.size)/this.size,q=(c-c%this.size)/
this.size,p=k*this.size*4,w=4*(this.size+q*this.size)-p,r=n.getPixelArrayCtor(this.pixelType),x=new r(g,p*r.BYTES_PER_ELEMENT,w),y=this.size;a=q-k+1;if(a>this.size){u.error(new B("mapview-webgl","Out-of-bounds index when updating AttributeData"));return}h.updateData(0,0,k,y,a,x)}catch(d){}b()}};f.update=function(a){const {data:b,start:d,end:c}=a;if(e.isSome(b)){const g=this.data,h=d*this.texelSize;for(let k=0;k<b.length;k++)a.layout&1<<k%this.texelSize&&(g[h+k]=b[k])}this.dirtyStart=Math.min(this.dirtyStart,
d);this.dirtyEnd=Math.max(this.dirtyEnd,c)};f.resize=function(a,b){const d=this.size;this.size=b;this.textureOnly?d!==this.size&&(this._lastTexture=this._texture,this._texture=null):(b=n.getPixelArrayCtor(this.pixelType),this.destroy(),this.data=new b(e.unwrap(a.buffer)))};f._resetRange=function(){this.dirtyStart=2147483647;this.dirtyEnd=0};f._initTexture=function(a){const b=new D(a,this._textureDesc,e.unwrapOr(this.data,void 0));if(e.isSome(this._lastTexture)&&this._fbos[0]){const g=this._lastTexture.descriptor.width,
h=this._lastTexture.descriptor.height,k=this._lastTexture.descriptor.dataType,q=this._lastTexture.descriptor.pixelFormat,p=this.getFBO(a);var d=n.getPixelBytes(k),c=n.getPixelArrayCtor(k);d=new ArrayBuffer(g*h*d*this.texelSize);c=new c(d);d=a.getBoundFramebufferObject();const {x:w,y:r,width:x,height:y}=a.getViewport();a.bindFramebuffer(p);p.readPixels(0,0,g,h,q,k,c);b.updateData(0,0,0,2*g,h/2,c);a.setViewport(w,r,x,y);a.bindFramebuffer(d)}this.destroy();return this._texture=b};A._createClass(m,[{key:"_textureDesc",
get:function(){return{target:3553,wrapMode:33071,pixelFormat:6408,dataType:this.pixelType,samplingMode:9728,width:this.size,height:this.size}}},{key:"locked",get:function(){return 5121===this.pixelType&&this.shared&&!this.textureOnly&&C("esri-atomics")&&this.data?1===Atomics.load(this.data,0):!1}},{key:"hasDirty",get:function(){return this.dirtyEnd>=this.dirtyStart}}]);return m}();t=function(){function m(a){this._onUpdate=a;this._locked=this._forceNextUpload=this._initialized=!1}var f=m.prototype;
f.initialize=function(a){const {blocks:b,shared:d,size:c}=a;this.shared=d;this.size=c;v("Initializing AttributeStoreView",a);if(e.isNone(this._data))this._data=e.mapMany(b,g=>new F(g,c,d));else for(a=0;a<this._data.length;a++){const g=this._data[a],h=b[a];e.isSome(h)&&(e.isNone(g)?this._data[a]=new F(h,c,d):g.resize(h,c))}this._initialized=!0};f.destroy=function(){e.andThen(this._data,a=>e.mapMany(a,b=>b.destroy()));e.andThen(this._defaultTexture,a=>a.dispose())};f.isUpdating=function(){if(e.isNone(this._data))return!0;
const a=e.isSome(this._pendingAttributeUpdate);C("esri-2d-log-updating")&&console.log(`Updating AttributeStoreView ${a}
  -> hasPendingUpdate ${a}`);return a};f.getBlock=function(a){return e.isNone(this._data)?null:this._data[a]};f.setLabelMinZoom=function(a,b){this.setData(a,0,1,b)};f.getLabelMinZoom=function(a){return this.getData(a,0,1,255)};f.getFilterFlags=function(a){return this.getData(a,0,0,0)};f.getVVSize=function(a){return this.getData(a,l.ATTRIBUTE_DATA_VV,0,0)};f.getData=function(a,b,d,c){if(!this._data)return 0;b=e.unwrap(this._data)[b];if(e.isNone(b))return 0;a=b.getData(a,d);return e.isSome(a)?a:c};
f.setData=function(a,b,d,c){b=e.unwrap(this._data)[b];e.unwrap(b).setData(a,d,c)};f.lockTextureUpload=function(){this._locked=!0};f.unlockTextureUpload=function(){this._locked=!1};f.forceTextureUpload=function(){this._forceNextUpload=!0};f.requestUpdate=function(){var a=A._asyncToGenerator(function*(b){if(this._pendingAttributeUpdate)u.error(new B("mapview-webgl","Tried to update attribute data with a pending update"));else{var d=G.createResolver();v("AttributeStoreView Update Requested",b);this._pendingAttributeUpdate=
{data:b,resolver:d};return d.promise}});return function(b){return a.apply(this,arguments)}}();f.update=function(){if(this._initialized&&e.isSome(this._pendingAttributeUpdate)){const {data:a,resolver:b}=this._pendingAttributeUpdate,d=e.unwrap(this._data);for(let c=0;c<a.blocks.length;c++){const g=a.blocks[c];e.andThen(d[c],h=>e.andThen(g,k=>{v(`Updating block ${c}`,k);h.update(k)}))}this._pendingAttributeUpdate=null;b();this._onUpdate()}};f.bindTextures=function(a){this.update();const b=this._getDefaultTexture(a);
if(this._initialized){var d=e.unwrap(this._data);if(!this._locked||this._forceNextUpload)e.forEachSome(d,c=>c.updateTexture(a,()=>this._onUpdate())),this._forceNextUpload=!1;a.bindTexture(e.mapOr(d[0],b,c=>c.getTexture(a)),l.TEXTURE_BINDING_ATTRIBUTE_DATA_0);a.bindTexture(e.mapOr(d[1],b,c=>c.getTexture(a)),l.TEXTURE_BINDING_ATTRIBUTE_DATA_1);a.bindTexture(e.mapOr(d[2],b,c=>c.getTexture(a)),l.TEXTURE_BINDING_ATTRIBUTE_DATA_2);a.bindTexture(e.mapOr(d[3],b,c=>c.getTexture(a)),l.TEXTURE_BINDING_ATTRIBUTE_DATA_3)}else a.bindTexture(b,
l.TEXTURE_BINDING_ATTRIBUTE_DATA_0),a.bindTexture(b,l.TEXTURE_BINDING_ATTRIBUTE_DATA_1),a.bindTexture(b,l.TEXTURE_BINDING_ATTRIBUTE_DATA_2),a.bindTexture(b,l.TEXTURE_BINDING_ATTRIBUTE_DATA_3)};f._getDefaultTexture=function(a){e.isNone(this._defaultTexture)&&(this._defaultTexture=new D(a,{wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array(4)));return this._defaultTexture};return m}();z.AttributeStoreView=t;Object.defineProperty(z,"__esModule",{value:!0})});