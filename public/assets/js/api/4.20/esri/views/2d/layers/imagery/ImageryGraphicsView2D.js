// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Graphic ../../../../request ../../../../core/Accessor ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/enumeration ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/Extent ../../../../layers/support/rasterFunctions/rasterProjectionHelper ../../../../layers/support/rasterFunctions/vectorFieldUtils ../../../../support/GraphicsCollection ../../engine/Container ../graphics/GraphicContainer ../graphics/GraphicsView2D".split(" "),
function(q,h,A,B,e,C,D,x,E,l,U,V,F,G,y,H,I,J,K,L,M){const N=C.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");e=function(z){function r(){var a=z.apply(this,arguments)||this;a.attached=!1;a.container=new K.Container;a.updateRequested=!1;a._graphicsView=null;a._projectFullExtentPromise=null;a._previousExtents=[];a._previousSymbolTileResolution=0;a._previousRendererSignature="";a.type="Graphics";a._graphics=new J["default"];a._updateGraphics=x.debounce(function(){var f=q._asyncToGenerator(function*(m,
d){if(m.stationary){var b=m.state;b=new y({xmin:b.extent.xmin,ymin:b.extent.ymin,xmax:b.extent.xmax,ymax:b.extent.ymax,spatialReference:b.spatialReference});var [O,P]=m.state.size,g={};g.timeExtent=a.timeExtent;g.requestAsImageElement=!1;g.signal=d;null==a._projectFullExtentPromise&&(a._projectFullExtentPromise=a._getProjectedFullExtent(b.spatialReference));d="vector-field"===a.layer.renderer.type?a.layer.renderer.symbolTileSize:50;var k=yield a._projectFullExtentPromise,{extent:t,resolution:u,width:Q,
height:R}=I.snapImageToSymbolTile(b,O,P,d,k);b=yield a.layer.fetchImage(t,Q,R,g);g=a.layer.renderer;if("vector-field"===g.type){d=b.pixelData.pixelBlock;k=g.sizeVariables[0];k.minDataValue&&k.maxDataValue||(k.minDataValue=d.statistics[0].minValue,k.maxDataValue=d.statistics[0].maxValue);a._pixelData={extent:t,pixelBlock:b.pixelData.pixelBlock};d=JSON.stringify(a.layer.renderer);k=a._previousRendererSignature===d;const S=.01>Math.abs(a._previousSymbolTileResolution-u)/u,v=t.clone().normalize(),T=a._previousExtents.some(n=>
v.some(p=>n.intersects(p))),w=k&&S&&T?a._previousExtents:[];b=yield g.getGraphicsFromPixelData(b.pixelData,"vector-uv"===a.layer.rasterInfo.dataType,w);w.length?(g=a._graphics.items.filter(n=>D.isSome(n.geometry)&&w.some(p=>p.intersects(n.geometry))&&!v.some(p=>p.intersects(n.geometry))),a._graphics.removeMany(g),a._graphics.addMany(b)):a._graphics.set("items",b);a._graphicsView.update(m);a._previousExtents=v;a._previousRendererSignature=d;a._previousSymbolTileResolution=u}}});return function(m,d){return f.apply(this,
arguments)}}());return a}q._inheritsLoose(r,z);var c=r.prototype;c.destroy=function(){this.attached&&(this.detach(),this.attached=!1);this.updateRequested=!1};c.update=function(a){this._updateGraphics(a).catch(f=>{x.isAbortError(f)||N.error(f)})};c.hitTest=function(a,f){a=this.view.toMap(E.createScreenPoint(a,f));return Promise.resolve(new A({attributes:{},geometry:a,layer:this.layer}))};c.attach=function(){this._graphicsView=new M({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>
this.requestUpdate(),container:new L(this.view.featuresTilingScheme)});this.attached=!0};c.detach=function(){this._graphics.destroy();this._graphicsView.destroy();this.container.removeChild(this._graphicsView.container);this._graphicsView=null};c.moveStart=function(){};c.viewChange=function(){};c.moveEnd=function(){};c.install=function(a){this.container.addChild(this._graphicsView.container);a.addChild(this.container)};c.uninstall=function(a){this.container.removeChild(this._graphicsView.container);
a.removeChild(this.container)};c.isUpdating=function(){return this._graphicsView.updating||this.updateRequested};c.getPixelData=function(){return this.updating?null:this._pixelData};c.redraw=function(){};c.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())};c._getProjectedFullExtent=function(){var a=q._asyncToGenerator(function*(f){try{return yield H.projectExtent(this.layer.fullExtent,f)}catch(m){try{const d=(yield B(this.layer.url,{query:{option:"footprints",
outSR:f.wkid||JSON.stringify(f.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return d?y.fromJSON(d):null}catch{return null}}});return function(f){return a.apply(this,arguments)}}();q._createClass(r,[{key:"updating",get:function(){return!this.attached||this.isUpdating()}}]);return r}(e);h.__decorate([l.property()],e.prototype,"attached",void 0);h.__decorate([l.property()],e.prototype,"container",void 0);h.__decorate([l.property()],e.prototype,"layer",void 0);h.__decorate([l.property()],
e.prototype,"timeExtent",void 0);h.__decorate([l.property()],e.prototype,"view",void 0);h.__decorate([l.property()],e.prototype,"updateRequested",void 0);h.__decorate([l.property()],e.prototype,"updating",null);h.__decorate([F.enumeration({graphics:"Graphics"})],e.prototype,"type",void 0);return e=h.__decorate([G.subclass("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],e)});