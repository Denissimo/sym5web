// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../request ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../rest/support/Query ../controllers/support/sourceAdapters ./DataTileSource ../../../../support/QueueProcessor".split(" "),function(r,g,w,x,t,q,h,m,y,z,A,u){const B=q.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");q=function(k){function n(b){var a=
k.call(this,b)||this;a.type="feature";a.mode="on-demand";a._adapter=z.createSourceAdapter(b.serviceInfo);a._queue=new u.QueueProcessor({concurrency:8,process:function(){var d=g._asyncToGenerator(function*(c){m.throwIfAborted(c);if(h.isSome(c.tile)){var e=c.tile.key.id;const {signal:l}=c;e=t("esri-tiles-debug")?{tile:e.replace(/\//g,"."),depth:c.depth}:void 0;return a._adapter.executeQuery(c.query,{query:e,signal:l})}return a._adapter.executeQuery(c.query,c)});return function(c){return d.apply(this,
arguments)}}()});a._patchQueue=new u.QueueProcessor({concurrency:8,process:function(){var d=g._asyncToGenerator(function*(c){m.throwIfAborted(c);if(h.isSome(c.tile)){var e=c.tile.key.id;const {signal:l}=c;e=t("esri-tiles-debug")?{tile:e.replace(/\//g,"."),depth:c.depth}:void 0;return a._adapter.executeQuery(c.query,{query:e,signal:l})}return a._adapter.executeQuery(c.query,c)});return function(c){return d.apply(this,arguments)}}()});return a}g._inheritsLoose(n,k);var f=n.prototype;f.destroy=function(){k.prototype.destroy.call(this);
this._adapter.destroy();this._queue.destroy();this._patchQueue.destroy()};f.enableEvent=function(b,a){};f.subscribe=function(b){k.prototype.subscribe.call(this,b);const a=this._subscriptions.get(b.id);this._fetchDataTile(b).catch(d=>{m.isAbortError(d)||B.error(new x("mapview-query-error","Encountered error when fetching tile",{tile:b,error:d}))}).then(()=>a.end())};f.unsubscribe=function(b){k.prototype.unsubscribe.call(this,b)};f.readers=function(b){return this._subscriptions.get(b).readers()};f.query=
function(){var b=g._asyncToGenerator(function*(a){return this._adapter.executeQuery(a)});return function(a){return b.apply(this,arguments)}}();f.queryLastEditDate=function(){var b=g._asyncToGenerator(function*(){const a=this._serviceInfo.source;return(yield w(a.path,{query:{...a.query,f:"json"},responseType:"json"})).data.editingInfo.lastEditDate});return function(){return b.apply(this,arguments)}}();f.createTileQuery=function(b){const a=this.createQuery();a.quantizationParameters=b.getQuantizationParameters();
a.resultType="tile";a.geometry=b.extent;"esriGeometryPolyline"===this._serviceInfo.geometryType&&(a.maxAllowableOffset=b.resolution);this._serviceInfo.capabilities.query.supportsQuantization||(a.quantizationParameters=null,a.maxAllowableOffset=b.resolution);return a};f._createQuery=function(b,a){const d=new y({...this._queryInfo,historicMoment:this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null,...a});this._serviceInfo.capabilities.query.supportsQuantization||(a.quantizationParameters=
null,d.maxAllowableOffset=b.resolution);a.quantizationParameters&&"esriGeometryPolyline"===this._serviceInfo.geometryType&&(d.maxAllowableOffset=b.resolution);d.resultType="tile";d.geometry=b.extent;return d};f._executePatchQuery=function(){var b=g._asyncToGenerator(function*(a,d,c,e){d=d.clone();d.outFields=[this._serviceInfo.objectIdField,...c];d.returnCentroid=!1;d.returnGeometry=!1;c=h.isSome(d.start)?d.start/8E3:0;return this._patchQueue.push({tile:a,query:d,signal:e.signal,depth:c})});return function(a,
d,c,e){return b.apply(this,arguments)}}();f._resend=function(){var b=g._asyncToGenerator(function*(a,d){const {query:c,message:e}=a,l=h.isSome(c.outFields)?c.outFields:[];a=this._queryInfo.outFields;const v=a.filter(p=>-1===l.indexOf(p));if(h.isNone(e.addOrUpdate))this._onMessage({...e,type:"append"});else if(v.length)try{const p=this._subscriptions.get(e.id).tile,C=yield this._executePatchQuery(p,c,v,d);m.throwIfAborted(d);c.outFields=a;e.addOrUpdate.joinAttributes(C);this._onMessage({...e,end:e.end,
type:"append"})}catch(p){}else this._onMessage({...e,type:"append"})});return function(a,d){return b.apply(this,arguments)}}();f._resendSubscription=function(){var b=g._asyncToGenerator(function*(a){if(a.empty)return this._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const d=a.signal;for(const c of a.requests.done)yield this._resend(c,{signal:d});if(h.isSome(a.edits))return this._onMessage(a.edits)});return function(a){return b.apply(this,arguments)}}();f.resend=function(){var b=
g._asyncToGenerator(function*(){const a=Array.from(this._subscriptions.values());yield Promise.all(a.map(d=>this._resendSubscription(d)))});return function(){return b.apply(this,arguments)}}();g._createClass(n,[{key:"updating",get:function(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(b=>!b.done)}},{key:"maxRecordCountFactor",get:function(){const {query:b}=this._serviceInfo.capabilities;return b.supportsMaxRecordCountFactor?4:null}},{key:"maxPageSize",get:function(){var b,
{query:a}=this._serviceInfo.capabilities;a=null!=(b=a.maxRecordCount)?b:8E3;b=h.unwrapOr(this.maxRecordCountFactor,1);return a*b}},{key:"pageSize",get:function(){return Math.min(8E3,this.maxPageSize)}}]);return n}(A.DataTileSource);r.BaseFeatureSource=q;Object.defineProperty(r,"__esModule",{value:!0})});