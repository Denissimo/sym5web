// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/maybe ../../../../../../core/screenUtils ../../../../../../chunks/mat2df32 ../../../../../../chunks/vec2f32 ../../color ../../definitions ../../number ../../materialKey/MaterialKey ./util ./WGLBaseMarkerTemplate ./WGLDynamicMeshTemplate ../../util/Result".split(" "),function(z,A,B,C,f,D,E,t,u,h,F,g,G,H,I){const J=E.create(),K=D.create(),L=B.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");
return function(y){function n(a,k,l){var b=y.call(this,a)||this;b._cimMarkerLayer=a;b._minMaxZoom=h.i1616to32(Math.round(k*u.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(l*u.MIN_MAX_ZOOM_PRECISION_FACTOR));g.isFunction(a.color)?b._dynamicPropertyMap.set("_fillColor",(e,c,d)=>t.premultiplyAlphaRGBA(a.color(e,c,d))):b._fillColor=t.premultiplyAlphaRGBA(a.color);g.isFunction(a.outlineColor)?b._dynamicPropertyMap.set("_outlineColor",(e,c,d)=>t.premultiplyAlphaRGBA(a.outlineColor(e,c,d))):b._outlineColor=
t.premultiplyAlphaRGBA(a.outlineColor);g.isFunction(a.size)?b._dynamicPropertyMap.set("_size",(e,c,d)=>f.pt2px(a.size(e,c,d))):b._size=f.pt2px(a.size);g.isFunction(a.scaleX)?b._dynamicPropertyMap.set("_scaleX",a.scaleX):b._scaleX=a.scaleX;g.isFunction(a.offsetX)?b._dynamicPropertyMap.set("xOffset",(e,c,d)=>f.pt2px(a.offsetX(e,c,d))):b.xOffset=f.pt2px(a.offsetX);g.isFunction(a.offsetY)?b._dynamicPropertyMap.set("yOffset",(e,c,d)=>f.pt2px(a.offsetY(e,c,d))):b.yOffset=f.pt2px(a.offsetY);g.isFunction(a.outlineWidth)?
b._dynamicPropertyMap.set("_outlineWidth",(e,c,d)=>f.pt2px(a.outlineWidth(e,c,d))):b._outlineWidth=f.pt2px(a.outlineWidth);g.isFunction(a.rotation)?b._dynamicPropertyMap.set("_angle",a.rotation):b._angle=a.rotation;b._scaleFactor=C.unwrapOr(a.scaleFactor,1);b._markerPlacement=a.markerPlacement;b._effects=a.effects;b._bitSet=(1===a.alignment?1:0)|(a.colorLocked?1:0)<<1|(a.scaleSymbolsProportionally?1:0)<<3;b._materialKey=a.materialKey;return b}z._inheritsLoose(n,y);n.fromCIMMarker=function(a,k){const [l,
b]=g.getMinMaxZoom(a.scaleInfo,k);return new n(a,l,b)};n.prototype.bindFeature=function(a,k,l){const b=a.readLegacyFeature();this._dynamicPropertyMap.forEach((M,N)=>{this[N]=M(b,k,l)});a=this._cimMarkerLayer.materialHash;a="function"===typeof a?a(b,k,l):a;if((a=this._materialCache.get(a))&&I.ok(a.spriteMosaicItem)&&a.spriteMosaicItem){a=a.spriteMosaicItem;var e=this._cimMarkerLayer.sizeRatio,c=a.width/a.height*this._scaleX,d=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,m=this._size,
p=m*c,O=this.xOffset,P=this.yOffset;this.xOffset*=this._scaleFactor;this.yOffset*=this._scaleFactor;var q=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/f.pt2px(this._cimMarkerLayer.frameHeight):1,v=this._outlineWidth*q,w=f.pt2px(this._cimMarkerLayer.referenceSize),x=q=0,r=this._cimMarkerLayer.anchorPoint;r&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(q=-r.x/(this._size*c),x=r.y/this._size):(q=r.x,x=r.y));this._sizeOutlineWidth=h.i8888to32(Math.round(Math.min(Math.sqrt(128*
p),255)),Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*v),255)),Math.round(Math.min(Math.sqrt(128*w),255)));this.angle=d;this._bitestAndDistRatio=h.i1616to32(this._bitSet,Math.round(64*e));c=a.rect.x+u.SPRITE_PADDING;d=a.rect.y+u.SPRITE_PADDING;v=c+a.width;w=d+a.height;this._texUpperLeft=h.i1616to32(c,d);this._texUpperRight=h.i1616to32(v,d);this._texBottomLeft=h.i1616to32(c,w);this._texBottomRight=h.i1616to32(v,w);c=F.MarkerMaterialKey.load(this._materialKey);c.sdf=
a.sdf;c.pattern=!0;c.textureBinding=a.textureBinding;this._materialKey=c.data;this._anchorX=.5-(.5+q)*a.width/a.width;this._anchorY=.5-(.5+x)*a.height/a.height;p=p*e*this._scaleFactor;m=m*e*this._scaleFactor;p*=a.rect.width/a.width;m*=a.rect.height/a.height;this._computedWidth=p;this._computedHeight=m;this._applyTransformation(K,J);this.xOffset=O;this.yOffset=P}else L.error(new A("mapview-cim","Encountered an error when binding feature"))};return n}(G(H))});