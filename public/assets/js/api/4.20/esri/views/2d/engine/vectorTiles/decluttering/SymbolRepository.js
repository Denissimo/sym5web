// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","./util"],function(v,z,q,r){let B=function(){function t(b,a,c){this.tileCoordRange=b;this._visibleTiles=a;this._createUnique=c;this._tiles=new Map;this._uniqueSymbolsReferences=new Map}var k=t.prototype;k.add=function(b,a){this._uniqueSymbolLayerArray=null;let c=this._tiles.get(b.id);c||(c={symbols:new Map},this._tiles.set(b.id,c));var d=new Map;if(a)for(var e of a)c.symbols.has(e)&&(d.set(e,c.symbols.get(e)),
c.symbols.delete(e));else for(var [f]of b.layerData)c.symbols.has(f)&&(d.set(f,c.symbols.get(f)),c.symbols.delete(f));this._removeSymbols(d);a=b.symbols;d=new Map;for(const [g,h]of a)if(e=h.length,32<=e){f=this.tileCoordRange;do f/=2,e/=4;while(8<e&&64<f);e=new r.GridIndex(this.tileCoordRange,this.tileCoordRange,f);d.set(g,{flat:h,index:e});c.symbols.set(g,{flat:h,index:e});for(const l of h)e.getCell(l.xTile,l.yTile).push(l)}else d.set(g,{flat:h}),c.symbols.set(g,{flat:h});this._addSymbols(b.key,
a)};k.deleteStyleLayers=function(b){this._uniqueSymbolLayerArray=null;for(const [a,c]of this._tiles){const d=new Map;for(const e of b)c.symbols.has(e)&&(d.set(e,c.symbols.get(e)),c.symbols.delete(e));this._removeSymbols(d);0===c.symbols.size&&this._tiles.delete(a)}};k.removeTile=function(b){this._uniqueSymbolLayerArray=null;const a=this._tiles.get(b.id);if(a){var c=new Map;for(const [d]of b.symbols)a.symbols.has(d)&&(c.set(d,a.symbols.get(d)),a.symbols.delete(d));this._removeSymbols(c);0===a.symbols.size&&
this._tiles.delete(b.id)}};k._removeSymbols=function(b){for(const [c,{flat:d}]of b)for(const e of d){b=e.unique;var a=b.tileSymbols;const f=a.length-1;for(let g=0;g<f;g++)if(a[g]===e){a[g]=a[f];break}a.length=f;0===f&&(a=this._uniqueSymbolsReferences.get(c),a.delete(b),0===a.size&&this._uniqueSymbolsReferences.delete(c));e.unique=null}};k._addSymbols=function(b,a){if(0!==a.size){var c=this._visibleTiles;for(const d of c)d.parentTile||d.key.world!==b.world||d.key.level===b.level&&!d.key.equals(b)||
this._matchSymbols(d,b,a);for(const [d,e]of a)for(const f of e)q.isNone(f.unique)&&(b=this._createUnique(),f.unique=b,b.tileSymbols.push(f),a=this._uniqueSymbolsReferences.get(d),a||(a=new Set,this._uniqueSymbolsReferences.set(d,a)),a.add(b))}};k._matchSymbols=function(b,a,c){if(b.key.level>a.level){var d=b.key.level-a.level;if(b.key.row>>d!==a.row||b.key.col>>d!==a.col)return}if(a.level>b.key.level&&(d=a.level-b.key.level,a.row>>d!==b.key.row||a.col>>d!==b.key.col))return;if(a.equals(b.key))for(var e of b.childrenTiles)this._matchSymbols(e,
a,c);else{e=new Map;for(const [h,l]of c){var f=[];for(const m of l)c=r.tileCoordChange(this.tileCoordRange,m.xTile,a.level,a.col,b.key.level,b.key.col),d=r.tileCoordChange(this.tileCoordRange,m.yTile,a.level,a.row,b.key.level,b.key.row),0<=c&&c<this.tileCoordRange&&0<=d&&d<this.tileCoordRange&&f.push({symbol:m,xTransformed:c,yTransformed:d});c=[];d=b.key.level<a.level?1:1<<b.key.level-a.level;const n=this._tiles.get(b.id).symbols.get(h);if(n){const m=n.flat;for(const u of f){var g=!1;let w;const x=
u.xTransformed,y=u.yTransformed;w=q.isSome(n.index)?n.index.getCell(x,y):m;f=u.symbol;const A=f.hash;for(const p of w)if(A===p.hash&&Math.abs(x-p.xTile)<=d&&Math.abs(y-p.yTile)<=d){g=p.unique;f.unique=g;g.tileSymbols.push(f);g=!0;break}g||c.push(f)}}0<c.length&&e.set(h,c)}for(const h of b.childrenTiles)this._matchSymbols(h,a,e)}};k._createUniqueSymbolLayerArray=function(){var b=this._uniqueSymbolsReferences;const a=Array(b.size);let c=0;for(const [d,e]of b){const f=Array(e.size);b=0;for(const g of e)f[b++]=
g;a[c]={styleLayerUID:d,uniqueSymbols:f};c++}return a};z._createClass(t,[{key:"uniqueSymbols",get:function(){q.isNone(this._uniqueSymbolLayerArray)&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray());return this._uniqueSymbolLayerArray}}]);return t}();v.SymbolRepository=B;Object.defineProperty(v,"__esModule",{value:!0})});