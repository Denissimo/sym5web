// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Error ../../../../../core/Logger ../../../../../core/LRUCache ../../../../../support/arcadeOnDemand ../../../../../symbols/cim/cimSymbolUtils ../../../../../symbols/cim/utils ../../../arcade/callExpressionWithFeature ../../../layers/features/schemaUtils".split(" "),function(G,r,n,H,I,J,K,q,L,M,N){function B(h,f,g){return x.apply(this,arguments)}function x(){x=n._asyncToGenerator(function*(h,f,g){switch(h.type){case "simple":return u.fromBasicRenderer(h,
f,g);case "map":return C.fromUVRenderer(h,f,g);case "interval":return D.fromCBRenderer(h,f,g);case "dictionary":return E.fromDictionaryRenderer(h,f,g);case "subtype":return F.fromSubtypes(h,f,g)}});return x.apply(this,arguments)}function O(h,f){return y.apply(this,arguments)}function y(){y=n._asyncToGenerator(function*(h,f){const g=h||1;if("number"===typeof g)return(a,d,c)=>g;const b=yield K.createRendererExpression(g,f.spatialReference,f.fields);return(a,d,c)=>M(b,a,{$view:c},f.geometryType,d)||
1});return y.apply(this,arguments)}const z=I.getLogger("esri/views/2d/engine/webgl/util/Matcher");let u=function(){function h(){this.type="feature";this._defaultResult=null}h.fromBasicRenderer=function(){var g=n._asyncToGenerator(function*(b,a,d){const c=new h;b.symbol&&(b=yield q.expandSymbol(b.symbol,d),a=a.createTemplateGroup(b,null),c.setDefault(a));return c});return function(b,a,d){return g.apply(this,arguments)}}();var f=h.prototype;f.size=function(){return 1};f.getDefault=function(){return this._defaultResult};
f.setDefault=function(g){this._defaultResult=g};f.match=function(g,b,a,d,c){return this.getDefault()};f.analyze=function(){var g=n._asyncToGenerator(function*(b,a,d,c,e){return null});return function(b,a,d,c,e){return g.apply(this,arguments)}}();return h}(),F=function(h){function f(g,b){var a=h.call(this)||this;a._subMatchers=g;a._subtypeField=b;return a}n._inheritsLoose(f,h);f.fromSubtypes=function(){var g=n._asyncToGenerator(function*(b,a,d){const c=new Map,e=[];for(const k in b.renderers){const p=
parseInt(k,10),m=B(b.renderers[k],a,d).then(l=>c.set(p,l));e.push(m)}yield Promise.all(e);return new f(c,b.subtypeField)});return function(b,a,d){return g.apply(this,arguments)}}();f.prototype.match=function(g,b,a,d,c){var e=b.readAttribute(this._subtypeField);return(e=this._subMatchers.get(e))?e.match(g,b,a,d,c):null};return f}(u),D=function(h){function f(b,a,d,c){var e=h.call(this)||this;e.type="interval";e._intervals=[];e._isMaxInclusive=a;e._fieldIndex=c;e._field=b;e._normalizationInfo=d;return e}
n._inheritsLoose(f,h);f.fromCBRenderer=function(){var b=n._asyncToGenerator(function*(a,d,c){const {isMaxInclusive:e,normalizationField:k,normalizationTotal:p,normalizationType:m}=a,l=new f(a.field,e,{normalizationField:k,normalizationTotal:p,normalizationType:m},a.fieldIndex),t=yield q.expandSymbol(a.backgroundFillSymbol,c);yield Promise.all(a.intervals.map(function(){var v=n._asyncToGenerator(function*(w){var A=yield q.expandSymbol(w.symbol,c);A=yield d.createTemplateGroup(A,t);l.add({min:w.min,
max:w.max},A)});return function(w){return v.apply(this,arguments)}}()));if(a=yield q.expandSymbol(a.defaultSymbol,c))a=yield d.createTemplateGroup(a,t),l.setDefault(a);return l});return function(a,d,c){return b.apply(this,arguments)}}();var g=f.prototype;g.add=function(b,a){this._intervals.push({interval:b,result:a});this._intervals.sort((d,c)=>d.interval.min-c.interval.min)};g.size=function(){return h.prototype.size.call(this)+this._intervals.length};g.match=function(b,a,d,c,e){if(null==this._fieldIndex&&
!this._field)return this.getDefault();b=null!=this._fieldIndex?a.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(a);if(!b&&(null===b||void 0===b||isNaN(b)))return this.getDefault();for(a=0;a<this._intervals.length;a++){const {interval:k,result:p}=this._intervals[a];d=this._isMaxInclusive?b<=k.max:b<k.max;if(b>=k.min&&d)return p}return this.getDefault()};g._needsNormalization=function(){const b=this._normalizationInfo;return b&&(b.normalizationField||b.normalizationTotal||b.normalizationType)};
g._getValueFromField=function(b){const a=b.readAttribute(this._field);if(!this._needsNormalization()||null==a)return a;const {normalizationField:d,normalizationTotal:c,normalizationType:e}=this._normalizationInfo;b=!!d&&b.readAttribute(d);if(e)switch(e){case "esriNormalizeByField":return(b||void 0)&&a/b;case "esriNormalizeByLog":return Math.log(a)*Math.LOG10E;case "esriNormalizeByPercentOfTotal":return a/c*100;default:z.error(`Found unknown normalization type: ${e}`)}else z.error("Normalization is required, but no type was set!")};
return f}(u),C=function(h){function f(b,a,d){var c=h.call(this)||this;c.type="map";c._nullResult=null;c._resultsMap=new Map;c._fieldsIndex=d;c._fields=b;c._seperator=a||"";return c}n._inheritsLoose(f,h);f.fromUVRenderer=function(){var b=n._asyncToGenerator(function*(a,d,c){const e=a.fieldDelimiter,k=[a.field];a.field2&&k.push(a.field2);a.field3&&k.push(a.field3);const p=yield q.expandSymbol(a.backgroundFillSymbol,c),m=new f(k,e,a.fieldIndex);yield Promise.all(a.map.map(function(){var l=n._asyncToGenerator(function*(t){var v=
yield q.expandSymbol(t.symbol,c);v=yield d.createTemplateGroup(v,p);"\x3cNull\x3e"===t.value?m.setNullResult(v):m.add(t.value,v)});return function(t){return l.apply(this,arguments)}}()));if(a=yield q.expandSymbol(a.defaultSymbol,c))a=yield d.createTemplateGroup(a,p),m.setDefault(a);return m});return function(a,d,c){return b.apply(this,arguments)}}();var g=f.prototype;g.setNullResult=function(b){this._nullResult=b};g.add=function(b,a){this._resultsMap.set(b.toString(),a)};g.size=function(){return h.prototype.size.call(this)+
this._resultsMap.size};g.match=function(b,a,d,c,e){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();b=null!=this._fieldsIndex?a.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(a);if(null!==this._nullResult&&(null==b||""===b||"\x3cNull\x3e"===b))return this._nullResult;if(!b&&null==b)return this.getDefault();b=b.toString();return this._resultsMap.has(b)?this._resultsMap.get(b):this.getDefault()};g._getValueFromFields=function(b){const a=[];for(const d of this._fields){const c=
b.readAttribute(d);null==c||""===c?a.push("\x3cNull\x3e"):a.push(c)}return a.join(this._seperator)};return f}(u),E=function(h){function f(b,a,d,c){var e=h.call(this)||this;e.type="dictionary";e._groupIdCache=new J(100);e._renderer=b;e._fieldMap=b.fieldMap;e._symbolFields=b.getSymbolFields();e._templates=a;e._info=d;e._scaleFn=c;return e}n._inheritsLoose(f,h);f.fromDictionaryRenderer=function(){var b=n._asyncToGenerator(function*(a,d,c){a=(yield new Promise(function(k,p){G(["../../../../../renderers/DictionaryRenderer"],
function(m){k(Object.freeze({__proto__:null,"default":m}))},p)})).default.fromJSON(a.renderer);yield a.fetchResources({spatialReference:c.spatialReference,fields:c.fields});const e=yield O(a.scaleExpression,c);return new f(a,d,c,e)});return function(a,d,c){return b.apply(this,arguments)}}();var g=f.prototype;g._analyzeFeature=function(){var b=n._asyncToGenerator(function*(a,d,c,e){a=a.readLegacyFeature();const k=this._scaleFn(a,d,c);d=this._attributeHash(a)+"-"+k;const p=this._groupIdCache.get(d);
if(p)return p;c=yield this._renderer.getSymbolAsync(a,{...c,spatialReference:this._info.spatialReference,abortOptions:e,fields:this._info.fields});c=N.createSymbolSchema(c,this._renderer);e=q.expandSymbol(c,this._info,e).then(m=>{if("expanded-cim"!==m.type)return z.error(new H("mapview-bad-type",`Found unexpected type ${m.type} in dictionary response`)),null;m.hash+="-"+k;for(const l of m.layers)l.scaleFactor=k,l.templateHash+="-"+k,"text"===l.type&&"string"===typeof l.text&&-1<l.text.indexOf("[")&&
(l.text=L.createLabelOverrideFunction(this._fieldMap,l.text,l.cim.textCase));return this._templates.createTemplateGroup(m,null)});this._groupIdCache.put(d,e,1);return e});return function(a,d,c,e){return b.apply(this,arguments)}}();g.analyze=function(){var b=n._asyncToGenerator(function*(a,d,c,e,k){a=d.getCursor();for(d=[];a.next();)d.push(this._analyzeFeature(a,c,e,k));return Promise.all(d)});return function(a,d,c,e,k){return b.apply(this,arguments)}}();g.match=function(b,a,d,c,e){return null};g._attributeHash=
function(b){let a="";for(const d of this._symbolFields){const c=this._fieldMap[d];c&&(a+=b.attributes[c]+"-")}return a};return f}(u);r.DictionaryMatcher=E;r.FeatureMatcher=u;r.IntervalMatcher=D;r.MapMatcher=C;r.SubtypeMatcher=F;r.createMatcher=B;Object.defineProperty(r,"__esModule",{value:!0})});