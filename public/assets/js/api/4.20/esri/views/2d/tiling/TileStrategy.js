// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["./TileCache","./TileCoverage","./TileKey"],function(D,z,E){const l=new E(0,0,0,0),d=new Map,m=[],r=[];return function(){function A(a){this._previousScale=Number.POSITIVE_INFINITY;this.cachePolicy="keep";this.coveragePolicy="closest";this.resampling=!0;this.tileIndex=new Map;this.tiles=[];this.buffer=192;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this.resampling=null==a.resampling||!!a.resampling;a.cachePolicy&&(this.cachePolicy=a.cachePolicy);
a.coveragePolicy&&(this.coveragePolicy=a.coveragePolicy);null!=a.buffer&&(this.buffer=a.buffer);a.cacheSize&&(this._tileCache=new D(a.cacheSize,this.tileInfoView,e=>{this.releaseTile(e)}))}var n=A.prototype;n.destroy=function(){this.tileIndex.clear()};n.update=function(a){const {resampling:e,tileIndex:b}=this,p=this.tileInfoView.getTileCoverage(a.state,this.buffer,this.coveragePolicy);r.length=0;m.length=0;d.clear();if(p){var {minScale:F,maxScale:G}=this.tileInfoView.tileInfo,{spans:B,lodInfo:w}=
p,{level:t}=w,{scale:u,center:H,resolution:I}=a.state,x=!a.stationary&&u>this._previousScale;this._previousScale=u;this.tiles.length=0;if(!e&&(u>F||u<G))return this.tiles.length=0,d.clear(),b.forEach(c=>{this.releaseTile(c)}),b.clear(),r.length=0,m.length=0,d.clear(),z.pool.release(p),!0;b.forEach(c=>c.visible=!0);var y=a=0;if(0<B.length)for(const {row:c,colFrom:h,colTo:v}of B)for(let k=h;k<=v;k++){a++;const f=l.set(t,c,w.normalizeCol(k),w.getWorldForColumn(k)).id;if(b.has(f)){var g=b.get(f);g.isReady?
(d.set(f,g),y++):x||this._addParentTile(f,d)}else{if(this._tileCache&&this._tileCache.has(f)){if(g=this._tileCache.pop(f),this.tileIndex.set(f,g),g.isReady){d.set(f,g);y++;continue}}else g=this.acquireTile(l),this.tileIndex.set(f,g);x||this._addParentTile(f,d)}}var C=y===a;b.forEach((c,h)=>{l.set(h);if(!d.has(h)){var v=this.tileInfoView.intersects(p,l),k="purge"===this.cachePolicy?l.level!==t:l.level>t;!v||!x&&C?!k&&v||m.push(h):c.isReady?r.push(h):k&&m.push(h)}});for(var q of r)(a=b.get(q))&&a.isReady&&
d.set(q,a);for(const c of m)q=b.get(c),this._tileCache?this._tileCache.add(q):this.releaseTile(q),b.delete(c);d.forEach(c=>this.tiles.push(c));b.forEach(c=>{d.has(c.key.id)||(c.visible=!1)});this._tileCache&&this._tileCache.prune(t,H,I);z.pool.release(p);d.clear();return C}};n.clear=function(a=!0){const {tileIndex:e}=this;a&&e.forEach(b=>{this.releaseTile(b)});e.clear()};n.updateCacheSize=function(a){this._tileCache&&(this._tileCache.maxSize=a)};n._addParentTile=function(a,e){let b=null;for(;;){a=
this.tileInfoView.getTileParentId(a);if(!a)break;if(this.tileIndex.has(a)){if((b=this.tileIndex.get(a))&&b.isReady){e.has(b.key.id)||e.set(b.key.id,b);break}}else if(this._tileCache&&this._tileCache.has(a)&&(b=this._tileCache.pop(a),this.tileIndex.set(a,b),b&&b.isReady)){e.has(b.key.id)||e.set(b.key.id,b);break}}};return A}()});