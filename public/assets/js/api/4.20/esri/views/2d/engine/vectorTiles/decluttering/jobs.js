// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/mat3f32","./config","./util"],function(B,F,G,H){let M=function(){function C(l,c,k,e,f,d){this._symbols=l;this._styleRepository=e;this._zoom=f;this._currentSymbolCursor=this._currentLayerCursor=0;this._styleProps=new Map;this._allNeededMatrices=new Map;this._gridIndex=new H.GridIndex(c,k,G.COLLISION_GRID_CELL_SIZE);this._si=Math.sin(Math.PI*d/180);this._co=Math.cos(Math.PI*d/180);for(const g of l)for(const h of g.symbols)this._allNeededMatrices.has(h.tile)||
this._allNeededMatrices.set(h.tile,F.clone(h.tile.transforms.tileUnitsToPixels))}var D=C.prototype;D.work=function(l){const c=this._gridIndex,k=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const A=this._symbols[this._currentLayerCursor],E=this._getProperties(A.styleLayerUID);for(;this._currentSymbolCursor<A.symbols.length;this._currentSymbolCursor++){if(99===this._currentSymbolCursor%100&&performance.now()-k>l)return!1;
var e=A.symbols[this._currentSymbolCursor];if(!e.unique.show)continue;{var f=e,d=this._si,g=this._co,h=this._allNeededMatrices.get(e.tile),n=this._zoom;const {iconRotationAlignment:b,textRotationAlignment:q,iconTranslate:r,iconTranslateAnchor:t,textTranslate:u,textTranslateAnchor:m}=E;var v=0;for(const a of f.colliders){const [w,x]=0===a.partIndex?r:u;var y=0===a.partIndex?t:m,p=a.minLod<=n&&n<=a.maxLod;v+=p?0:1;a.enabled=p;a.xScreen=a.xTile*h[0]+a.yTile*h[3]+h[6];a.yScreen=a.xTile*h[1]+a.yTile*h[4]+
h[7];0===y?(a.xScreen+=g*w-d*x,a.yScreen+=d*w+g*x):(a.xScreen+=w,a.yScreen+=x);1===(0===a.partIndex?b:q)?(a.dxScreen=a.dxPixels,a.dyScreen=a.dyPixels):(a.dxScreen=g*(a.dxPixels+a.width/2)-d*(a.dyPixels+a.height/2)-a.width/2,a.dyScreen=d*(a.dxPixels+a.width/2)+g*(a.dyPixels+a.height/2)-a.height/2)}0<f.colliders.length&&v===f.colliders.length&&(f.unique.show=!1)}f=e.unique;if(!f.show)continue;const {iconAllowOverlap:I,iconIgnorePlacement:J,textAllowOverlap:K,textIgnorePlacement:L}=E;for(const b of e.colliders)if(b.enabled&&
(d=f.parts[b.partIndex],d.show)){if(g=!(b.partIndex?K:I))a:{g=b.xScreen+b.dxScreen;h=b.yScreen+b.dyScreen;n=g+b.width;v=h+b.height;const [q,r,t,u]=c.getCellSpan(g,h,n,v);for(y=r;y<=u;y++)for(p=q;p<=t;p++){var z=c.cells[y][p];for(const m of z){z=m.xScreen+m.dxScreen;const a=m.yScreen+m.dyScreen,w=z+m.width,x=a+m.height;if(!(n<z||g>w||v<a||h>x)){g=!0;break a}}}g=!1}g&&(b.hard?f.show=!1:d.show=!1)}if(f.show)for(const b of e.colliders){if(!b.enabled)continue;if(b.partIndex?L:J)continue;if(!f.parts[b.partIndex].show)continue;
e=b.xScreen+b.dxScreen;d=b.yScreen+b.dyScreen;const [q,r,t,u]=this._gridIndex.getCellSpan(e,d,e+b.width,d+b.height);for(e=r;e<=u;e++)for(d=q;d<=t;d++)this._gridIndex.cells[e][d].push(b)}}}return!0};D._getProperties=function(l){var c=this._styleProps.get(l);if(c)return c;c=this._zoom;const k=this._styleRepository.getStyleLayerByUID(l);var e=0!==k.getLayoutValue("symbol-placement",c);let f=k.getLayoutValue("icon-rotation-alignment",c);2===f&&(f=e?0:1);let d=k.getLayoutValue("text-rotation-alignment",
c);2===d&&(d=e?0:1);e=k.getPaintValue("icon-translate",c);const g=k.getPaintValue("icon-translate-anchor",c),h=k.getPaintValue("text-translate",c),n=k.getPaintValue("text-translate-anchor",c);c={iconAllowOverlap:k.getLayoutValue("icon-allow-overlap",c),iconIgnorePlacement:k.getLayoutValue("icon-ignore-placement",c),textAllowOverlap:k.getLayoutValue("text-allow-overlap",c),textIgnorePlacement:k.getLayoutValue("text-ignore-placement",c),iconRotationAlignment:f,textRotationAlignment:d,iconTranslateAnchor:g,
iconTranslate:e,textTranslateAnchor:n,textTranslate:h};this._styleProps.set(l,c);return c};return C}();B.CollisionJob=M;Object.defineProperty(B,"__esModule",{value:!0})});