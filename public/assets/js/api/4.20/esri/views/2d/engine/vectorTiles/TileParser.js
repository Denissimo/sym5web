// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/pbf ../../../../core/promiseUtils ./Feature ./IndexMemoryBuffer ./SourceLayerData ./VertexMemoryBuffer ./buckets/CircleBucket ./buckets/FillBucket ./buckets/LineBucket ./buckets/SymbolBucket ../webgl/TileClipper ../../tiling/enums".split(" "),function(y,z,A,B,t,C,u,D,E,F,G,w,H){return function(){function x(a,b,c,d,f){this._pbfTiles={};this._tileClippers={};this._client=c;this._tile=b;if(f){this._styleLayerUIDs=new Set;for(const h of f)this._styleLayerUIDs.add(h)}this._styleRepository=
d;this._layers=this._styleRepository.layers;const [g,l,v]=b.tileKey.split("/").map(parseFloat);this._level=g;b=8+Math.max(5*(this._level-14),0);for(const h of Object.keys(a))c=a[h],this._pbfTiles[h]=new z(new Uint8Array(c.protobuff),new DataView(c.protobuff)),c.refKey&&([c]=c.refKey.split("/").map(parseFloat),c=g-c,0<c&&(d=(1<<c)-1,this._tileClippers[h]=new w.TileClipper(c,l&d,v&d,8,b))),this._tileClippers[h]||(this._tileClippers[h]=new w.SimpleBuilder)}var m=x.prototype;m._canParseStyleLayer=function(a){return!this._styleLayerUIDs||
this._styleLayerUIDs.has(a)};m.parse=function(){var a=y._asyncToGenerator(function*(b){const c=this._initialize(b),{returnedBuckets:d}=c;this._processLayers(c);this._linkReferences(c);this._filterFeatures(c);const f=new Set,g={};for(const l of d)l.getResources(l.tileClipper,f,g);if(this._tile.status===H.TileStatus.INVALID)return Promise.resolve([]);b=this._fetchResources(f,g,b);return Promise.all(b).then(()=>this._processFeatures(c.returnedBuckets))});return function(b){return a.apply(this,arguments)}}();
m._initialize=function(a){a=a&&a.signal;const b=this._parseTileData(this._pbfTiles),c=this._layers,d=this._level,f=this._tileClippers,g=new Map;return{signal:a,sourceNameToTileData:b,layers:c,zoom:d,sourceNameToTileClipper:f,sourceNameToUniqueSourceLayerBuckets:{},sourceNameToUniqueSourceLayers:{},returnedBuckets:[],layerIdToBucket:{},referencerUIDToReferencedId:g}};m._processLayers=function(a){const {sourceNameToTileData:b,layers:c,zoom:d,sourceNameToTileClipper:f,sourceNameToUniqueSourceLayerBuckets:g,
sourceNameToUniqueSourceLayers:l,returnedBuckets:v,layerIdToBucket:h,referencerUIDToReferencedId:r}=a;for(a=c.length-1;0<=a;a--){const e=c[a];if(!this._canParseStyleLayer(e.uid)||e.minzoom&&d<Math.floor(e.minzoom)||e.maxzoom&&d>=e.maxzoom||0===e.type)continue;if(!b[e.source]||!f[e.source])continue;var n=f[e.source];const q=e.sourceLayer;var p=b[e.source][q];if(p){var k=l[e.source];k||(k=l[e.source]=new Set);k.add(e.sourceLayer);if(e.refLayerId)r.set(e.uid,e.refLayerId);else if(k=this._createBucket(e))k.layerUIDs=
[e.uid],k.layerExtent=p.extent,k.tileClipper=n,(n=g[e.source])||(n=g[e.source]={}),(p=n[q])||(p=n[q]=[]),p.push(k),v.push(k),h[e.id.toLowerCase()]=k}}};m._linkReferences=function(a){const {layerIdToBucket:b,referencerUIDToReferencedId:c}=a;c.forEach((d,f)=>{d=d.toLowerCase();b[d]&&b[d].layerUIDs.push(f)})};m._filterFeatures=function(a){const {signal:b,sourceNameToTileData:c,sourceNameToUniqueSourceLayerBuckets:d,sourceNameToUniqueSourceLayers:f}=a;a=10*this._level;const g=10*(this._level+1),l=[],
v=[];for(const p of Object.keys(f))f[p].forEach(k=>{l.push(k);v.push(p)});for(let p=0;p<l.length;p++){var h=v[p],r=l[p];if(!c[h]||!d[h])continue;const k=c[h][r];if((h=d[h][r])&&0!==h.length){if(A.isAborted(b))break;for(r=k.getData();r.nextTag(2);){var n=r.getMessage();const e=new B(n,k);n.release();if(n=e.values){const q=n._minzoom;if(q&&q>=g)continue;if((n=n._maxzoom)&&n<=a)continue}for(const q of h)q.pushFeature(e)}}}};m._fetchResources=function(a,b,c){const d=[],f=this._tile.getWorkerTileHandler();
0<a.size&&(a=f.fetchSprites(a,this._client,c),d.push(a));for(const g in b)a=b[g],0<a.size&&(a=f.fetchGlyphs(this._tile.tileKey,g,a,this._client,c),d.push(a));return d};m._processFeatures=function(a){a=a.filter(b=>b.hasFeatures()||this._canParseStyleLayer(b.layer.uid));for(const b of a)b.processFeatures(b.tileClipper);return a};m._parseTileData=function(a){const b={};for(const c of Object.keys(a)){const d=a[c],f={};for(;d.next();)switch(d.tag()){case 3:{const g=d.getMessage(),l=new C(g);g.release();
f[l.name]=l;break}default:d.skip()}b[c]=f}return b};m._createBucket=function(a){switch(a.type){case 0:return null;case 1:return this._createFillBucket(a);case 2:return this._createLineBucket(a);case 4:return this._createCircleBucket(a);case 3:return this._createSymbolBucket(a)}};m._createFillBucket=function(a){return new E(a,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new u.FillVertexBuffer(a.fillMaterial.getStride()),new t.TriangleIndexBuffer,new u.OutlineVertexBuffer(a.outlineMaterial.getStride()),
new t.TriangleIndexBuffer)};m._createLineBucket=function(a){return new F(a,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new u.LineVertexBuffer(a.lineMaterial.getStride()),new t.TriangleIndexBuffer)};m._createCircleBucket=function(a){return new D(a,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new u.CircleVertexBuffer(a.circleMaterial.getStride()),new t.TriangleIndexBuffer)};m._createSymbolBucket=function(a){const b=this._tile;return new G(a,this._level,new u.SymbolVertexBuffer(a.iconMaterial.getStride()),
new t.TriangleIndexBuffer,new u.SymbolVertexBuffer(a.textMaterial.getStride()),new t.TriangleIndexBuffer,b.placementEngine,b.getWorkerTileHandler())};return x}()});