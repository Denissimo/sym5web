// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../chunks/mat3 ../../../chunks/mat3f32 ../../../chunks/vec2f32 ../../../layers/support/rasterFunctions/pixelUtils ./DisplayObject ../../webgl/rasterUtils".split(" "),function(p,q,t,g,u,k,v,n,l){const w={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"};n=function(r){function m(a=
null,b=null,d=null){var c=r.call(this)||this;c._textureInvalidated=!0;c._memoryUsed=null;c._supportsBilinear=!0;c.stencilRef=0;c.coordScale=[1,1];c._symbolizerParameters=null;c.height=null;c.isRendereredSource=!1;c.pixelRatio=1;c.resolution=0;c.rotation=0;c._source=null;c.rawPixelData=null;c._suspended=!1;c._bandIds=null;c._interpolation=null;c._transformGrid=null;c.width=null;c.x=0;c.y=0;c.transforms={dvs:u.create()};c.source=a;c.transformGrid=b;c.interpolation=d;return c}q._inheritsLoose(m,r);var f=
m.prototype;f.destroy=function(){const a=this.getTextures();null==a?void 0:a.textures.forEach(b=>b.dispose());this._colormapTexture=this._transformGridTexture=this._rasterTexture=null};f.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())};f.setTransform=function(a){const b=g.identity(this.transforms.dvs),[d,c]=a.toScreenNoRotation([0,0],this.x,this.y);var e=this.resolution/this.pixelRatio/a.resolution;const h=e*this.width;e*=this.height;const x=
Math.PI*this.rotation/180;g.translate(b,b,k.fromValues(d,c));g.translate(b,b,k.fromValues(h/2,e/2));g.rotate(b,b,-x);g.translate(b,b,k.fromValues(-h/2,-e/2));g.scaleByVec2(b,b,k.fromValues(h,e));g.multiply(this.transforms.dvs,a.displayViewMat3,b)};f.getTextures=function(){if(!this._rasterTexture)return null;const a=[],b=[];this._transformGridTexture&&(b.push(this._transformGridTexture),a.push("u_transformGrid"));this._rasterTexture&&(b.push(this._rasterTexture),a.push("u_image"));this._colormapTexture&&
(b.push(this._colormapTexture),a.push("u_colormap"));return{names:a,textures:b}};f.getMemoryUsage=function(){if(t.isNone(this._memoryUsed)){const a=this.getTextures();if(null==a)return 0;this._memoryUsed=a.textures.map(b=>b.descriptor.width*b.descriptor.height*4).reduce((b,d)=>b+d)}return this._memoryUsed};f.onAttach=function(){this.invalidateTexture()};f.onDetach=function(){this.invalidateTexture()};f.updateTexture=function({context:a}){if(this.stage)this._textureInvalidated&&(this._textureInvalidated=
!1,b=(b=this.source)&&b.pixels&&0<b.pixels.length,this._createOrDestroyRasterTexture(a),this._rasterTexture&&(b?(this._updateColormapTexture(a),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=l.createTransformTexture(a,this.transformGrid))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()));else{var b,d,c;null==(b=this._rasterTexture)?void 0:b.dispose();null==(d=this._transformGridTexture)?void 0:d.dispose();null==(c=this._colormapTexture)?
void 0:c.dispose();this._colormapTexture=this._transformGridTexture=this._rasterTextureBandIds=this._rasterTexture=null}};f._createOrDestroyRasterTexture=function(a){var b,d;const c=this.source?v.extractBands(this.source,this.bandIds):null;if(c&&c.pixels&&0<c.pixels.length){var e=null==this._rasterTextureBandIds&&null==this.bandIds||this._rasterTextureBandIds&&this.bandIds&&this._rasterTextureBandIds.join("")===this.bandIds.join("");if(this._rasterTexture){if(e)return;this._rasterTexture.dispose();
this._rasterTexture=this._rasterTextureBandIds=null}e=this.interpolation||"nearest";var h=this.isRendereredSource||!(null!=(b=a.capabilities.textureFloat)&&b.textureFloat);this._rasterTexture=l.createRasterTexture(a,c,e,h);this._supportsBilinear=null==(d=a.capabilities.textureFloat)?void 0:d.textureFloatLinear;this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}else this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=this._rasterTextureBandIds=null)};f._updateColormapTexture=
function(a){const b=this._colormap,d=this.symbolizerParameters.colormap;if(!d)this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormap=null;else if(!b)this._colormapTexture=l.createColormapTexture(a,d),this._colormap=d;else if(d.length!==b.length||d.some((c,e)=>c!==b[e]))this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=l.createColormapTexture(a,d),this._colormap=d};q._createClass(m,[{key:"symbolizerParameters",
get:function(){return this._symbolizerParameters||w},set:function(a){this._symbolizerParameters=a}},{key:"source",get:function(){return this._source},set:function(a){this._source=a;this._rasterTexture&&(this._rasterTexture.dispose(),this._memoryUsed=this._rasterTextureBandIds=this._rasterTexture=null)}},{key:"suspended",get:function(){return this._suspended},set:function(a){this._suspended&&!a&&this.stage&&(this.ready(),this.requestRender());this._suspended=a}},{key:"bandIds",get:function(){return this._bandIds},
set:function(a){this._bandIds=a;this.invalidateTexture()}},{key:"interpolation",get:function(){return this._interpolation},set:function(a){this._interpolation=a;this._rasterTexture&&this._rasterTexture.setSamplingMode(!this._supportsBilinear||"bilinear"!==a&&"cubic"!==a?9728:9729)}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(a){this._transformGrid=a;this._transformGridTexture&&(this._transformGridTexture.dispose(),this._memoryUsed=this._transformGridTexture=null)}}]);
return m}(n.DisplayObject);p.RasterBitmap=n;Object.defineProperty(p,"__esModule",{value:!0})});