// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec2 ../../support/QueueProcessor".split(" "),function(x,m,h,p,F,G,H,I,B,C,D){function E(q,r){q.length=0;r.forEach(d=>q.push(d));return q}const w=new Set,u=[],t=new Map,y=[0,0];h=function(q){function r(a){a=
q.call(this,a)||this;a._keyToItem=new Map;a.concurrency=6;a.strategy="scale-first";a.tileInfoView=null;return a}x._inheritsLoose(r,q);var d=r.prototype;d.initialize=function(){const {concurrency:a,process:g,strategy:k}=this;this._queue=new D.QueueProcessor({concurrency:a,process:(b,c)=>{b=this._keyToItem.get(b);return g(b,{signal:c})},peeker:"scale-first"===k?b=>this._peekByScaleFirst(b):b=>this._peekByCenterFirst(b)})};d.destroy=function(){this.clear();this._queue.destroy();this._queue=null};d.abort=
function(a){this._queue.abort("string"===typeof a?a:a.id)};d.clear=function(){this._queue.clear();this._keyToItem.clear();this.notifyChange("updating")};d.has=function(a){return"string"===typeof a?this._keyToItem.has(a):this._keyToItem.has(a.id)};d.isOngoing=function(a){a="string"===typeof a?a:a.id;return this.has(a)&&this._queue.isOngoing(a)};d.pause=function(){this._queue.pause()};d.push=function(a){const g=a.key.id;if(this._queue.has(g))return this._queue.get(g);const k=this._queue.push(g),b=()=>
{this._keyToItem.delete(g);this.notifyChange("updating")};this._keyToItem.set(g,a);k.then(b,b);this.notifyChange("updating");return k};d.reset=function(){this._queue.reset()};d.resume=function(){this._queue.resume()};d._peekByScaleFirst=function(a){if(!this.state)return a.values().next().value;const g=this.tileInfoView;let k=Number.NEGATIVE_INFINITY,b=Number.POSITIVE_INFINITY;a.forEach(f=>{f=this._keyToItem.get(f);const e=this.tileInfoView.getTileScale(f.key);t.has(e)||(t.set(e,[]),k=Math.max(e,k),
b=Math.min(e,b));t.get(e).push(f.key);w.add(e)});let c=this.state.scale;t.has(c)||(E(u,w),u.sort(),c=u.reduce((f,e)=>Math.abs(e-c)<Math.abs(f-c)?e:f,u[0]));c=Math.min(c,k);c=Math.max(c,b);a=t.get(c);const l=g.getClosestInfoForScale(c),n=l.getColumnForX(this.state.center[0]),v=l.getRowForY(this.state.center[1]);a.sort((f,e)=>{const z=l.denormalizeCol(f.col,f.world),A=l.denormalizeCol(e.col,e.world);return Math.sqrt((n-z)*(n-z)+(v-f.row)*(v-f.row))-Math.sqrt((n-A)*(n-A)+(v-e.row)*(v-e.row))});w.clear();
t.clear();return a[0].id};d._peekByCenterFirst=function(a){if(!this.state)return a.values().next().value;const g=this.tileInfoView,k=this.state.center;let b=Number.POSITIVE_INFINITY,c=null;a.forEach(l=>{l=this._keyToItem.get(l);g.getTileCoords(y,l.key);const n=C.distance(y,k);n<b&&(b=n,c=l.key)});return c.id};x._createClass(r,[{key:"length",get:function(){return this._queue?this._queue.length:0}},{key:"onGoingCount",get:function(){return this._keyToItem.size}},{key:"updating",get:function(){return 0<
this.length||0<this.onGoingCount}}]);return r}(h);m.__decorate([p.property({constructOnly:!0})],h.prototype,"concurrency",void 0);m.__decorate([p.property({constructOnly:!0})],h.prototype,"process",void 0);m.__decorate([p.property()],h.prototype,"state",void 0);m.__decorate([p.property({constructOnly:!0})],h.prototype,"strategy",void 0);m.__decorate([p.property({constructOnly:!0})],h.prototype,"tileInfoView",void 0);m.__decorate([p.property({readOnly:!0})],h.prototype,"updating",null);return h=m.__decorate([B.subclass("esri.views.2d.tiling.TileQueue")],
h)});