// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../geometry/support/spatialReferenceUtils ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(v,w,x,y,z,u){const g=new z("0/0/0/0");let A=function(){function t(a,b,c,e,h,f,l,r){this.x=a;this.ymin=b;this.ymax=c;this.invM=e;this.leftAdjust=h;this.rightAdjust=f;this.leftBound=l;this.rightBound=r}t.create=function(a,b){a[1]>b[1]&&([a,b]=[b,a]);const [c,e]=a,[h,f]=b;a=h-c;b=f-e;b=0!==b?a/b:0;const l=(Math.ceil(e)-e)*b,r=(Math.floor(e)-
e)*b;return new t(c,Math.floor(e),Math.ceil(f),b,0>a?l:r,0>a?r:l,0>a?h:c,0>a?c:h)};var k=t.prototype;k.incrRow=function(){this.x+=this.invM};k.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};k.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return t}();const p=[[0,0],[0,0],[0,0],[0,0]];return function(){function t(a,b){this.tileInfo=a;this.fullExtent=b;this.scales=[];this._lodInfos=null;this._infoByScale={};this._infoByLevel={};const c=
a.lods.slice();c.sort(function(h,f){return f.scale-h.scale});const e=this._lodInfos=c.map(h=>x.create(a,h,b));c.forEach((h,f)=>{this._infoByLevel[h.level]=e[f];this._infoByScale[h.scale]=e[f];this.scales[f]=h.scale},this);this._wrap=a.isWrappable}var k=t.prototype;k.getLODInfoAt=function(a){return this._infoByLevel["number"===typeof a?a:a.level]};k.getTileBounds=function(a,b,c=!1){g.set(b);return(b=this._infoByLevel[g.level])?b.getTileBounds(a,g,c):a};k.getTileCoords=function(a,b,c=!1){g.set(b);return(b=
this._infoByLevel[g.level])?b.getTileCoords(a,g,c):a};k.getTileCoverage=function(a,b=192,c="closest"){c="closest"===c?this.getClosestInfoForScale(a.scale):this.getSmallestInfoForScale(a.scale);const e=y.pool.acquire(c),h=this._wrap;var f=Infinity;let l=-Infinity;const r=e.spans;p[0][0]=p[0][1]=p[1][1]=p[3][0]=-b;p[1][0]=p[2][0]=a.size[0]+b;p[2][1]=p[3][1]=a.size[1]+b;for(d of p)a.toMap(d,d),d[0]=c.getColumnForX(d[0]),d[1]=c.getRowForY(d[1]);a=[];var d=3;for(b=0;4>b;b++)p[b][1]===p[d][1]?d=b:(d=A.create(p[b],
p[d]),f=Math.min(d.ymin,f),l=Math.max(d.ymax,l),void 0===a[d.ymin]&&(a[d.ymin]=[]),a[d.ymin].push(d),d=b);if(null==f||null==l||100<l-f)return null;for(b=[];f<l;){null!=a[f]&&(b=b.concat(a[f]));d=Infinity;var m=-Infinity;for(var n=b.length-1;0<=n;n--){var q=b[n];d=Math.min(d,q.getLeftCol());m=Math.max(m,q.getRightCol())}d=Math.floor(d);m=Math.floor(m);if(f>=c.first[1]&&f<=c.last[1])if(h)if(c.size[0]<c.worldSize[0])for(n=Math.floor(m/c.worldSize[0]),q=Math.floor(d/c.worldSize[0]);q<=n;q++)r.push(new u(f,
Math.max(c.getFirstColumnForWorld(q),d),Math.min(c.getLastColumnForWorld(q),m)));else r.push(new u(f,d,m));else d>c.last[0]||m<c.first[0]||(d=Math.max(d,c.first[0]),m=Math.min(m,c.last[0]),r.push(new u(f,d,m)));f+=1;for(d=b.length-1;0<=d;d--)m=b[d],m.ymax>=f?m.incrRow():b.splice(d,1)}return e};k.getTileParentId=function(a){g.set(a);a=this._lodInfos.indexOf(this._infoByLevel[g.level])-1;if(0>a)return null;this._getTileIdAtLOD(g,this._lodInfos[a],g);return g.id};k.getTileResolution=function(a){return(a=
this._infoByLevel["object"===typeof a?a.level:a])?a.resolution:-1};k.getTileScale=function(a){return(a=this._infoByLevel[a.level])?a.scale:-1};k.intersects=function(a,b){g.set(b);b=this._infoByLevel[g.level];const c=a.lodInfo;if(c.resolution>b.resolution){this._getTileIdAtLOD(g,c,g);var e=c.denormalizeCol(g.col,g.world);for(var h of a.spans)if(h.row===g.row&&h.colFrom<=e&&h.colTo>=e)return!0}if(c.resolution<b.resolution){const [l,r,d,m]=a.spans.reduce((n,q)=>{n[0]=Math.min(n[0],q.row);n[1]=Math.max(n[1],
q.row);n[2]=Math.min(n[2],q.colFrom);n[3]=Math.max(n[3],q.colTo);return n},[Infinity,-Infinity,Infinity,-Infinity]);e=b.denormalizeCol(g.col,g.world);a=c.getColumnForX(b.getXForColumn(e));h=c.getRowForY(b.getYForRow(g.row));e=c.getColumnForX(b.getXForColumn(e+1))-1;b=c.getRowForY(b.getYForRow(g.row+1))-1;return!(a>m||e<d||h>r||b<l)}const f=c.denormalizeCol(g.col,g.world);return a.spans.some(l=>l.row===g.row&&l.colFrom<=f&&l.colTo>=f)};k.normalizeBounds=function(a,b,c){a[0]=b[0];a[1]=b[1];a[2]=b[2];
a[3]=b[3];this._wrap&&(b=w.getInfo(this.tileInfo.spatialReference),c=-c*(b.valid[1]-b.valid[0]),a[0]+=c,a[2]+=c);return a};k.getSmallestInfoForScale=function(a){const b=this.scales;if(this._infoByScale[a])return this._infoByScale[a];if(a>b[0])return this._infoByScale[b[0]];for(let c=1;c<b.length-1;c++)if(a>b[c]+1E-6)return this._infoByScale[b[c-1]];return this._infoByScale[b[b.length-1]]};k.getClosestInfoForScale=function(a){const b=this.scales;if(this._infoByScale[a])return this._infoByScale[a];
a=b.reduce((c,e)=>Math.abs(e-a)<Math.abs(c-a)?e:c,b[0]);return this._infoByScale[a]};k.scaleToLevel=function(a){const b=this.scales;if(this._infoByScale[a])return this._infoByScale[a].level;for(let c=b.length-1;0<=c;c--)if(a<b[c])return c===b.length-1?this._infoByScale[b[b.length-1]].level:this._infoByScale[b[c]].level+(b[c]-a)/(b[c]-b[c+1]);return this._infoByScale[b[0]].level};k.scaleToZoom=function(a){return this.tileInfo.scaleToZoom(a)};k._getTileIdAtLOD=function(a,b,c){const e=this._infoByLevel[c.level];
a.set(c);if(b.resolution<e.resolution)return null;if(b.resolution===e.resolution)return a;a.level=b.level;a.col=Math.floor(c.col*e.resolution/b.resolution+.01);a.row=Math.floor(c.row*e.resolution/b.resolution+.01);return a};v._createClass(t,[{key:"spatialReference",get:function(){return this.tileInfo.spatialReference}}]);return t}()});