// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/promiseUtils"],function(t,x,v,z){function G(a,d=0,b=a.length-d){let c=-1;for(let e=d,h=d+b;e<h;e++)c=c>>>8^A[(c^a[e])&255];return c^-1}function B(a){const d=a.constructor===Uint8Array?a:new Uint8Array(a);return y.some((b,c)=>b!==d[c])?!1:!0}function H(a,d){const b=new Uint8Array(d);if(y.some((m,l)=>m!==b[l]))return I;let c=!1;w(b,m=>!(c="acTL"===m));if(!c)return C;const e=[],h=[];let g=
null,f=null,q=0;w(b,(m,l,k,u)=>{const n=new DataView(l.buffer);switch(m){case "IHDR":g=l.subarray(k+8,k+8+u);a.width=n.getUint32(k+8);a.height=n.getUint32(k+12);break;case "acTL":a.numPlays=n.getUint32(k+8+4);break;case "fcTL":f&&(a.frames.push(f),q++);f=new J;f.width=n.getUint32(k+8+4);f.height=n.getUint32(k+8+8);f.left=n.getUint32(k+8+12);f.top=n.getUint32(k+8+16);m=n.getUint16(k+8+20);l=n.getUint16(k+8+22);0===l&&(l=100);f.delay=1E3*m/l;10>=f.delay&&(f.delay=100);a.playTime+=f.delay;f.disposeOp=
n.getUint8(k+8+24);f.blendOp=n.getUint8(k+8+25);f.dataParts=[];0===q&&2===f.disposeOp&&(f.disposeOp=1);break;case "fdAT":f&&f.dataParts.push(l.subarray(k+8+4,k+8+u));break;case "IDAT":f&&f.dataParts.push(l.subarray(k+8,k+8+u));break;case "IEND":h.push(D(l,k,12+u));break;default:e.push(D(l,k,12+u))}});if(0===a.frames.length)return C;a.frameCount=a.frames.length;const p=new Blob(e),K=new Blob(h);a.frames.forEach(m=>{let l=[];l.push(y);g.set(E(m.width),0);g.set(E(m.height),4);l.push(F("IHDR",g));l.push(p);
m.dataParts.forEach(k=>l.push(F("IDAT",k)));l.push(K);m.data=new Blob(l,{type:"image/png"});delete m.dataParts;l=null});return a}function w(a,d){const b=new DataView(a.buffer);let c=8;let e,h;do{e=b.getUint32(c);var g=c+4;g=Array.prototype.slice.call(a.subarray(g,g+4));g=String.fromCharCode.apply(String,g);h=d(g,a,c,e);c+=12+e}while(!1!==h&&"IEND"!==g&&c<a.length)}function L(a){const d=new Uint8Array(a.length);for(let b=0;b<a.length;b++)d[b]=a.charCodeAt(b);return d}function D(a,d,b){const c=new Uint8Array(b);
c.set(a.subarray(d,d+b));return c}function F(a,d){const b=a.length+d.length,c=new Uint8Array(b+8),e=new DataView(c.buffer);e.setUint32(0,d.length);c.set(L(a),4);c.set(d,8);a=G(c,4,b);e.setUint32(b+4,a);return c}function E(a){return new Uint8Array([a>>>24&255,a>>>16&255,a>>>8&255,a&255])}const A=new Uint32Array(256);for(var r=0;256>r;r++){let a=r;for(let d=0;8>d;d++)a=0!==(a&1)?3988292384^a>>>1:a>>>1;A[r]=a}const I=new v("Not a PNG"),C=new v("Not an animated PNG"),y=new Uint8Array([137,80,78,71,13,
10,26,10]);r=function(){function a(){this.playTime=this.numPlays=this.height=this.width=0;this.frames=[];this.playing=this.paused=!1;this.playSpeed=1;this.currentFrameNumber=0;this._lastUsedFrame=-1}a.create=function(){var b=x._asyncToGenerator(function*(c,e){const h=new a;try{yield h._load(c,e)}catch(g){if(!z.isAbortError(g))return new v("invalid-resource",`Could not load PNG: ${g.message}`)}return h});return function(c,e){return b.apply(this,arguments)}}();var d=a.prototype;d.play=function(){this.playing||
(this.paused=!1,this.playing=!0,this._play())};d.pause=function(){this.paused=!0;this.playing=!1;clearTimeout(this.timerID)};d.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()};d.bindFrame=function(b,c,e){b.bindTexture(c,e);b=this.frameChanged();if(!b)return!1;e=this.currentFrame;const h=e.frameData,g=c.descriptor;(e.left||e.top||e.width!==g.width||e.height!==g.height)&&c.setData(null);c.updateData(0,e.left,e.top,e.width,e.height,h);this.updateUsedFrame();return b};d.frameChanged=
function(){return this._lastUsedFrame!==this.currentFrameNumber};d.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber};d._load=function(){var b=x._asyncToGenerator(function*(c,e){try{const h=H(this,c);if(h!==this)return h;this._resizeCanvas=document.createElement("canvas");this._resizeCanvas.width=this.width;this._resizeCanvas.height=this.height;yield Promise.all(this.frames.map(g=>g.createImage(this._resizeCanvas)))}catch(h){if(!z.isAbortError(h))return new v("invalid-resource",
"Could not parse PNG")}this.play()});return function(c,e){return b.apply(this,arguments)}}();d._play=function(){if(0===this.playSpeed)this.pause();else{if(0>this.playSpeed){--this.currentFrameNumber;0>this.currentFrameNumber&&(this.currentFrameNumber=this.frames.length-1);var b=this.currentFrameNumber;--b;0>b&&(b=this.frames.length-1);b=-this.frames[b].delay/this.playSpeed}else this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,b=1*this.frames[this.currentFrameNumber].delay/this.playSpeed;
var c=this.frames[this.currentFrameNumber];this.currentFrame={frameData:c.imageData,top:c.top,left:c.left,width:c.width,height:c.height};this.timerID=window.setTimeout(()=>this._play(),b)}};return a}();let J=function(){function a(){this.blendOp=this.disposeOp=this.delay=this.height=this.width=this.top=this.left=0;this.imageData=this.data=null}a.prototype.createImage=function(){var d=x._asyncToGenerator(function*(b){if(null===this.imageData)return new Promise((c,e)=>{const h=URL.createObjectURL(this.data),
g=document.createElement("img");g.onload=()=>{URL.revokeObjectURL(h);{b.width=g.width;b.height=g.height;var f=b.getContext("2d");f.drawImage(g,0,0,g.width,g.height);f=f.getImageData(0,0,g.width,g.height);f=new Uint8Array(f.data);let q;for(let p=0;p<f.length;p+=4)q=f[p+3]/255,f[p]*=q,f[p+1]*=q,f[p+2]*=q;f=new ImageData(new Uint8ClampedArray(f.buffer),g.width,g.height)}this.imageData=f;c()};g.onerror=()=>{URL.revokeObjectURL(h);this.imageData=null;e(Error("Image creation error"))};g.src=h})});return function(b){return d.apply(this,
arguments)}}();return a}();t.default=r;t.getPNGSize=function(a){a=new Uint8Array(a);let d,b;w(a,(c,e,h)=>{e=new DataView(e.buffer);"IHDR"===c&&(d=e.getUint32(h+8),b=e.getUint32(h+12))});return[d,b]};t.isAnimatedPNG=function(a){a=new Uint8Array(a);if(!B(a))return!1;let d=!1;w(a,b=>!(d="acTL"===b));return d};t.isPNG=B;Object.defineProperty(t,"__esModule",{value:!0})});