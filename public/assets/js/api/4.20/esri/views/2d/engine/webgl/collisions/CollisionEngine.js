// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/maybe ../../../../../core/screenUtils ../definitions ./CollisionGrid ./visualVariableSimpleUtils".split(" "),function(A,y,D,B,t,E){function u(n,h){const e=[];n.forEachTile(c=>e.push(c));e.sort((c,f)=>c.instanceId-f.instanceId);e.forEach(c=>{y.isSome(c.labelMetrics)&&c.isReady&&h(c,c.labelMetrics.getCursor())})}function F(n){return h=>D.pt2px(E.getSizeForValueSimple(h,n))}function G(n){for(const h of n)if(n=h.labelingInfo||[],h.labelsVisible&&n.length&&n.some(e=>
"none"===e.deconflictionStrategy))return!0;return!1}let I=function(){function n(){}var h=n.prototype;h.run=function(e,c,f){const g=[];for(const d of e)a:{e=g;var b=d;if("feature"!==b.layer.type&&"csv"!==b.layer.type&&"geojson"!==b.layer.type&&"ogc-feature"!==b.layer.type&&"stream"!==b.layer.type&&"subtype-group"!==b.layer.type&&"wfs"!==b.layer.type)break a;const v=b.layer.geometryType,w=!G("subtype-group"===b.layer.type?b.layer.sublayers.items:[b.layer]),q={};if("subtype-group"!==b.layer.type){if("heatmap"===
b.layer.renderer.type)break a;b:{var a=b.layer.renderer;if(a="visualVariables"in a&&a.visualVariables)for(const x of a)if("size"===x.type){a=F(x);break b}a=null}q[0]=a}b=b.tileRenderer;y.isNone(b)||e.push({tileRenderer:b,vvEvaluators:q,deconflictionEnabled:w,geometryType:v})}this._transformMetrics(g,c);this._runCollision(g,c,f)};h._runCollision=function(e,c,f){const [g,b]=c.state.size;c=new t.CollisionBitsetGrid(g,b);for(const {tileRenderer:a,deconflictionEnabled:d}of e){const v=a.featuresView.attributeView;
if(!d){u(a,(w,q)=>{for(;q.nextId();)v.setLabelMinZoom(q.id,0)});break}this._prepare(a);this._collideVisible(c,a,f);this._collideInvisible(c,a)}};h._isFiltered=function(e,c,f){e=c.getFilterFlags(e);c=!f.effect||f.effect.excludedLabelsVisible||!!(e&B.EFFECT_FLAG_0);return!((!f.hasFilter||e&B.FILTER_FLAG_0)&&c)};h._prepare=function(e){const c=e.featuresView.attributeView,f=new Set;u(e,(g,b)=>{for(;b.nextId();)f.has(b.id)||(f.add(b.id),this._isFiltered(b.id,c,e.layerView)?c.setLabelMinZoom(b.id,254):
0!==c.getLabelMinZoom(b.id)?c.setLabelMinZoom(b.id,255):c.setLabelMinZoom(b.id,0))})};h._collideVisible=function(e,c,f){const g=c.featuresView.attributeView,b=new Set;u(c,(a,d)=>{for(;d.nextId();)if(!b.has(d.id))if(a.key.level!==f)g.setLabelMinZoom(d.id,254);else if(0===g.getLabelMinZoom(d.id))switch(e.insertMetrics(d)){case t.HAS_COLLISION:g.setLabelMinZoom(d.id,254);b.add(d.id);break;case t.NONE:g.setLabelMinZoom(d.id,0),b.add(d.id)}})};h._collideInvisible=function(e,c){const f=c.featuresView.attributeView,
g=new Set;u(c,(b,a)=>{for(;a.nextId();)if(!g.has(a.id)&&255===f.getLabelMinZoom(a.id))switch(e.insertMetrics(a)){case t.HAS_COLLISION:f.setLabelMinZoom(a.id,255);g.add(a.id);break;case t.NONE:f.setLabelMinZoom(a.id,0),g.add(a.id)}})};h._transformMetrics=function(e,c){for(const {tileRenderer:f,geometryType:g,vvEvaluators:b}of e)u(f,(a,d)=>{const v=f.featuresView.attributeView;a=a.transforms.labelMat2d;a[4]=Math.round(a[4]);a[5]=Math.round(a[5]);const w=a[4],q=a[5],x="polyline"===g;for(;d.next();){const H=
d.boundsCount,z=d.anchorX,C=d.anchorY;var p=0,r=0,k=b[0];y.isSome(k)&&(p=v.getVVSize(d.id),p=k(p),r=isNaN(p)||null==p||Infinity===p?d.size:p,p=r/2*d.directionX,r=r/2*d.directionY);for(k=0;k<H;k++){var l=z,m=d.anchorY;x?(l=l+d.boundsCenterX(k)+p,m=m+d.boundsCenterY(k)+r,c.state.rotation?(l=a[0]*l+a[2]*m+a[4],m=a[1]*l+a[3]*m+a[5]):(l+=w,m+=q),d.setBoundsComputedAnchorX(k,Math.floor(l)),d.setBoundsComputedAnchorY(k,Math.floor(m))):(c.state.rotation?(l=a[0]*z+a[2]*C+a[4],m=a[1]*z+a[3]*C+a[5]):(l+=w,m+=
q),l=l+d.boundsCenterX(k)+p,m=m+d.boundsCenterY(k)+r,d.setBoundsComputedAnchorX(k,l),d.setBoundsComputedAnchorY(k,m))}}})};return n}();A.CollisionEngine=I;Object.defineProperty(A,"__esModule",{value:!0})});