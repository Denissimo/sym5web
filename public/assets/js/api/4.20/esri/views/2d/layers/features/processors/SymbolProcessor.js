// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/jsonMap ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/diffUtils ../../../../../geometry/SpatialReference ../../../engine/webgl/Utils ../../../engine/webgl/cpuMapped/DisplayRecordReader ../../../engine/webgl/mesh/MeshData ../../../engine/webgl/mesh/factories/WGLMeshFactory ../../../engine/webgl/mesh/templates/WGLTemplateStore ../../../engine/webgl/util/BidiText ../../../engine/webgl/util/Matcher ../textUtils ./BaseProcessor ../support/AttributeStore".split(" "),
function(t,B,v,C,D,m,u,P,Q,R,E,w,F,G,H,I,J,K,L,x,M,N,O){function y(n,q){return(!n.minScale||n.minScale>=q)&&(!n.maxScale||n.maxScale<=q)}function z(n){n=n.message;const q={message:{data:{},tileKey:n.tileKey},transferList:[]};for(const a in n.data){var f=n.data[a];q.message.data[a]=null;if(m.isSome(f)){var c=f.stride;const b=f.indices.slice(0),d=f.vertices.slice(0),e=f.records.slice(0);f=m.andThen(f.metrics,g=>g.slice(0));c={stride:c,indices:b,vertices:d,records:e,metrics:f};q.transferList.push(b,
d,e);q.message.data[a]=c}}return q}D.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");v=function(n){function q(){var c=n.apply(this,arguments)||this;c.type="symbol";c._matchers={feature:null,aggregate:null};c._bufferData=new Map;return c}t._inheritsLoose(q,n);var f=q.prototype;f.initialize=function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])};f.destroy=function(){};f.update=function(){var c=t._asyncToGenerator(function*(a,b){b=b.schema.processors[0];
if("symbol"===b.type){var d=w.diff(this._schema,b);w.hasDiff(d,"mesh")&&(C("esri-2d-update-debug")&&console.debug("Applying Update - Processor:",d),a.mesh=!0,a.why.mesh.push("Symbology changed"),this._schema=b,this._factory=this._createFactory(b),this._factory.update(b,this.tileStore.tileScheme.tileInfo))}});return function(a,b){return c.apply(this,arguments)}}();f.onTileMessage=function(c,a,b,d){u.throwIfAborted(d);return this._onTileData(c,a,b,d)};f.onTileClear=function(c){this._bufferData.delete(c.key.id);
return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:c.id,data:{clear:!0}})};f.onTileError=function(c,a,b){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:c.id,error:a},{signal:b.signal})};f.onTileUpdate=function(c){for(const a of c.removed)this._bufferData.has(a.key.id)&&(this._bufferData.get(a.key.id).forEach(b=>{const d=new Set;G.forEachGeometryType(e=>{e=b.message.data[e];if(m.isSome(e))for(e=H.DisplayRecordReader.from(e.records).getCursor();e.next();)d.add(e.id)});
return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:b.message.tileKey,data:{type:"update",addOrUpdate:null}})}),this._bufferData.delete(a.key.id));for(const a of c.added)this._bufferData.forEach(b=>{for(const d of b)d.message.tileKey===a.id&&this._updateTileMesh("append",a,z(d),[],!1,!1,null)})};f._addBufferData=function(c,a){this._bufferData.has(c)||this._bufferData.set(c,[]);this._bufferData.get(c).push(z(a))};f._createFactory=function(c){const {geometryType:a,objectIdField:b,fields:d}=
this.service,e=F.fromJSON(this.spatialReference),g={geometryType:a,fields:d,spatialReference:e},h=new K.WGLTemplateStore((p,r)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",p,r),this.tileStore.tileScheme.tileInfo),{matcher:l,aggregateMatcher:k}=c.mesh;this._store=h;this._matchers.feature=x.createMatcher(l,h,g);this._matchers.aggregate=m.andThen(k,p=>x.createMatcher(p,h,g));return new J.WGLMeshFactory(a,b,h)};f._onTileData=function(){var c=t._asyncToGenerator(function*(a,b,d,e){const {type:g,
addOrUpdate:h,remove:l}=b,k=b.end;if(!h)return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:a.id,data:{type:g,addOrUpdate:null,remove:l,clear:!1,end:k}},e);d=this._processFeatures(a,h,d,e);try{const p=yield d;if(m.isNone(p))return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:a.id,data:{type:g,addOrUpdate:null,remove:l,clear:!1,end:k}},e);for(const r of p)a.key.id!==r.message.tileKey&&this._addBufferData(a.key.id,r);yield u.all(p.map(r=>{const A=a.key.id===r.message.tileKey;
return this._updateTileMesh(g,a,r,A?b.remove:[],A&&b.end,b.clear,e.signal)}))}catch(p){this._handleError(a,p,e)}});return function(a,b,d,e){return c.apply(this,arguments)}}();f._updateTileMesh=function(){var c=t._asyncToGenerator(function*(a,b,d,e,g,h,l){h=d.message.tileKey;h!==b.key.id&&(g=!1);b=m.andThen(d,k=>k.message);d=m.andThen(d,k=>k.transferList)||[];a={type:a,addOrUpdate:b,remove:e,clear:!1,end:g};l={transferList:m.unwrap(d)||[],signal:l};u.throwIfAborted(l);return this.remoteClient.invoke("tileRenderer.onTileData",
{tileKey:h,data:a},l)});return function(a,b,d,e,g,h,l){return c.apply(this,arguments)}}();f._processFeatures=function(){var c=t._asyncToGenerator(function*(a,b,d,e){if(m.isNone(b)||!b.hasFeatures)return null;const g={transform:a.transform,hasZ:!1,hasM:!1},h=this._factory,l={viewingMode:"",scale:a.scale},k=yield this._matchers.feature,p=yield this._matchers.aggregate;u.throwIfAborted(e);const r=this._getLabelInfos(a,b);yield h.analyze(b.getCursor(),k,p,g,l);u.throwIfAborted(e);return this._writeFeatureSet(a,
b,g,r,h,d)});return function(a,b,d,e){return c.apply(this,arguments)}}();f._writeFeatureSet=function(c,a,b,d,e,g){var h=a.getSize();g=new I.MeshData(c.key.id,{features:h,records:h,metrics:0},"simple"===this._schema.mesh.matcher.type&&this._schema.mesh.matcher.isDotDensity,g,!0);h={viewingMode:"",scale:c.scale};for(a=a.getCursor();a.next();)try{const l=a.getDisplayId(),k=m.isSome(d)?d.get(l):null;e.writeCursor(g,a,b,h,c.level,k)}catch(l){}return g.serialize(c.tileInfoView.tileInfo.isWrappable)};f._handleError=
function(c,a,b){if(!u.isAbortError(a))return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:c.id,error:a.message},{signal:b.signal})};f._getLabelingSchemaForScale=function(c){var a=this._schema.mesh.labels;if(m.isNone(a))return null;if("subtype"===a.type){const b={type:"subtype",classes:{}};let d=!1;for(const e in a.classes){const g=a.classes[e].filter(h=>y(h,c.scale));d=d||!!g.length;b.classes[e]=g}return d?b:null}a=a.classes.filter(b=>y(b,c.scale));return a.length?{type:"simple",classes:a}:
null};f._getLabels=function(c,a){if("subtype"===a.type){var b;const d=m.unwrapOrThrow(this.service.subtypeField,"Expected to find subtype Field");c=c.readAttribute(d);return null==c?[]:null!=(b=a.classes[c])?b:[]}return a.classes};f._getLabelInfos=function(c,a){c=this._getLabelingSchemaForScale(c);if(m.isNone(c))return null;const b=new Map;for(a=a.getCursor();a.next();){const e=a.getDisplayId(),g=[],h=O.isAggregateId(e),l=h&&1!==a.readAttribute("cluster_count")?"aggregate":"feature";var d=this._getLabels(a,
c);for(const k of d){if(k.target!==l)continue;d=a.getStorage();d=h&&"feature"===l?d.getComputedStringAtIndex(a.readAttribute("referenceId"),k.fieldIndex):d.getComputedStringAtIndex(e,k.fieldIndex);if(!d)continue;d=L.bidiText(d.toString());const p=d[1];this._store.getMosaicItem(k.symbol,M.codepoints(d[0])).then(r=>{g[k.index]={glyphs:r.glyphMosaicItems,rtl:p,index:k.index}})}b.set(e,g)}return b};t._createClass(q,[{key:"supportsTileUpdates",get:function(){return!0}}]);return q}(N);return v=B.__decorate([E.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],
v)});