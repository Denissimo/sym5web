// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Program ../../../webgl/ProgramCache ../../../webgl/Renderbuffer ../../../webgl/RenderingContext ../../../webgl/ShaderCompiler ../../../webgl/Texture ../../../webgl/VertexArrayObject ../brushes ../vectorTiles/shaders/VTLMaterialManager ./BitBlitRenderer ./enums ./MaterialManager ./TextureManager ./effects/AnimationEffect ./effects/BlendEffect ./effects/FeatureEffect ./effects/HighlightEffect ./effects/HittestEffect ./effects/post-processing/EffectManager ./painter/RenderPass".split(" "),
function(u,l,H,q,I,J,v,K,L,M,N,h,w,x,m,y,z,A,B,r,C,D,E,F){function t(k,e,a){return 1!==a||l.isSome(k)&&"normal"!==k||l.isSome(e)&&0<e.length}return function(){function k(a,d){this.context=a;this._blitRenderer=new x.BitBlitRenderer;this._brushCache=new Map;this._vtlMaterialManager=new w;this._blendEffect=new B.BlendEffect;this.effects={highlight:new C,hittest:new D.HittestEffect,integrate:new A.AnimationEffect,insideEffect:new r.FeatureEffect("inside"),outsideEffect:new r.FeatureEffect("outside")};
this.materialManager=new y(a);this.textureManager=new z(d);this._effectsManager=new E.EffectManager(d)}var e=k.prototype;e.getRenderTarget=function(){return this._renderTarget};e.setRenderTarget=function(a){this._renderTarget=a};e.getFbos=function(a,d){if(a!==this._lastWidth||d!==this._lastHeight){this._lastWidth=a;this._lastHeight=d;if(this._fbos){for(var b in this._fbos)this._fbos[b].resize(a,d);return this._fbos}b={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:a,
height:d};const c={colorTarget:0,depthStencilTarget:3};this._stencilBuf=a=new v(this.context,{width:a,height:d,internalFormat:34041});this._fbos={output:new q(this.context,c,b,a),blend:new q(this.context,c,b,a),effect0:new q(this.context,c,b,a)}}return this._fbos};e.getSharedStencilBuffer=function(){return this._stencilBuf};e.beforeRenderLayers=function(a,d=null){const {width:b,height:c}=a.getViewport();this._prevFBO=a.getBoundFramebufferObject();const f=this.getFbos(b,c);a.bindFramebuffer(f.output);
a.setColorMask(!0,!0,!0,!0);a.setDepthWriteEnabled(!0);if(l.isSome(d)){const {r:n,g,b:G,a:p}=d.color;a.setClearColor(p*n/255,p*g/255,p*G/255,p)}else a.setClearColor(0,0,0,0);a.setClearDepth(1);a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT);a.setDepthWriteEnabled(!1)};e.beforeRenderLayer=function(a,d,b){const {context:c,blendMode:f,effects:n,requireFBO:g}=a;g||t(f,n,b)?(c.bindFramebuffer(this._fbos.blend),c.setColorMask(!0,!0,!0,!0),c.setClearColor(0,0,0,0),c.setDepthWriteEnabled(!0),c.setClearDepth(1),
c.clear(c.gl.COLOR_BUFFER_BIT|c.gl.DEPTH_BUFFER_BIT),c.setDepthWriteEnabled(!1)):(a=this._getOutputFBO(),c.bindFramebuffer(a));c.setDepthWriteEnabled(!1);c.setDepthTestEnabled(!1);c.setStencilTestEnabled(!0);c.setClearStencil(d);c.setStencilWriteMask(255);c.clear(c.gl.STENCIL_BUFFER_BIT)};e.compositeLayer=function(a,d){const {context:b,blendMode:c,effects:f,requireFBO:n}=a;if(n||t(c,f,d)){l.isSome(f)&&0<f.length&&a.drawPhase===m.WGLDrawPhase.MAP&&this._applyEffects(a,f);var g=this._getOutputFBO();
b.bindFramebuffer(g);b.setStencilTestEnabled(!1);b.setStencilWriteMask(0);b.setBlendingEnabled(!0);b.setBlendFunctionSeparate(1,771,1,771);b.setColorMask(!0,!0,!0,!0);g=l.isSome(c)?c:"normal";this._blendEffect.draw(a,this._fbos.blend.colorTexture,9728,g,d)}};e.renderLayers=function(a){a.bindFramebuffer(this._prevFBO);if(this._fbos){var d=this._getOutputFBO();a.setStencilTestEnabled(!1);a.setStencilWriteMask(0);this.blitTexture(a,d.colorTexture,9728)}};e.dispose=function(){this.materialManager.dispose();
this.textureManager.dispose();this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null);this._brushCache&&(this._brushCache.forEach(a=>a.dispose()),this._brushCache.clear(),this._brushCache=null);if(this._fbos)for(const a in this._fbos)this._fbos[a]&&this._fbos[a].dispose();if(this.effects)for(const a in this.effects)this.effects[a]&&this.effects[a].dispose();this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null);this._prevFBO=null};e.getGeometryBrush=
function(a){a={[m.WGLGeometryType.FILL]:h.brushes.fill,[m.WGLGeometryType.LINE]:h.brushes.line,[m.WGLGeometryType.MARKER]:h.brushes.marker,[m.WGLGeometryType.TEXT]:h.brushes.text}[a];let d=this._brushCache.get(a);void 0===d&&(d=new a,this._brushCache.set(a,d));return this._brushCache.get(a)};e.renderObject=function(a,d,b,c){b=h.brushes[b];if(!b)return null;let f=this._brushCache.get(b);void 0===f&&(f=new b,this._brushCache.set(b,f));f.prepareState(a,d,c);f.draw(a,d,c)};e.renderObjects=function(a,
d,b,c){b=h.brushes[b];if(!b)return null;let f=this._brushCache.get(b);void 0===f&&(f=new b,this._brushCache.set(b,f));f.drawMany(a,d,c)};e.registerRenderPass=function(a){const d=a.brushes.map(b=>{this._brushCache.has(b)||this._brushCache.set(b,new b);return this._brushCache.get(b)});return new F(d,a)};e.setHighlightOptions=function(a){this.effects.highlight.setHighlightOptions(a)};e.blitTexture=function(a,d,b,c=1){a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(1,771,1,771);a.setColorMask(!0,
!0,!0,!0);this._blitRenderer.render(a,d,b,c)};e.getPostProcessingEffects=function(a){return this._effectsManager.getPostProcessingEffects(a)};e._getOutputFBO=function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output};e._applyEffects=function(a,d){const {context:b}=a;d=this._effectsManager.getPostProcessingEffects(d);for(const {postProcessingEffect:c,effect:f}of d)b.bindFramebuffer(this._fbos.blend),c.draw(a,this._fbos.blend,f)};u._createClass(k,[{key:"vectorTilesMaterialManager",
get:function(){return this._vtlMaterialManager}}]);return k}()});