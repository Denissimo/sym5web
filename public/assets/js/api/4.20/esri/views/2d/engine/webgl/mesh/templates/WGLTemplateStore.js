// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../symbols/support/defaults ./WGLDynamicFillTemplate ./WGLDynamicLineTemplate ./WGLDynamicMarkerTemplate ./WGLDynamicTextTemplate ./WGLFillTemplate ./WGLLineTemplate ./WGLMarkerTemplate ./WGLTextTemplate ../../util/Lock ../../util/Result ../../../../layers/features/schemaUtils ../../../../layers/features/textUtils".split(" "),
function(p,g,A,q,B,r,C,D,E,F,t,v,n,w,x,h,u,G){function l(k,e){const b=k.length;k.push(null);e.then(a=>k[b]=a);return k}function y(k){return!!(k&1)}const f=q.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),z=[];q=function(){function k(b,a){this._templateIdCounter=this._idCounter=1;this._idToTemplateGroup=new Map;this._symbolToTemplate=new Map;this._fetchQueue=[];this._idToResolver=new Map;this._cimTemplateCache=new Map;this._cimAnalyses=[];this._lock=new x["default"];this._fetchResource=
b;this._tileInfo=a}var e=k.prototype;e.createTemplateGroup=function(b,a){this._initErrorTemplates();const c=b.hash;if(this._symbolToTemplate.has(c))return this._symbolToTemplate.get(c);const d=[];a&&this._createMeshTemplates(d,a,!0);this._createMeshTemplates(d,b,!1);b=this._createGroupId("expanded-cim"===b.type);this._idToTemplateGroup.set(b,d);this._symbolToTemplate.set(c,b);return b};e.getTemplateGroup=function(b){return this._idToTemplateGroup.has(b)?this._idToTemplateGroup.get(b):z};e.getDynamicTemplateGroup=
function(b){if(!this._idToTemplateGroup.has(b))return z;y(b)||f.error("mapview-template-store",`Id ${b} does not refer to a dynamic template`);return this._idToTemplateGroup.get(b)};e.getMosaicItem=function(b,a){const c=this._createTemplateId(),d=new Promise(m=>this._idToResolver.set(c,m));this._fetchQueue.push({symbol:b,id:c,glyphIds:a});return d};e.finalize=function(b){return this._fetchQueue.length||this._lock.isHeld()?x.withLock(this._lock,this._fetchAllQueuedResources.bind(this),b):Promise.resolve()};
e._initErrorTemplates=function(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],u.createSymbolSchema(r.errorPolygonSymbol2D),!1),marker:this._createMeshTemplates([],u.createSymbolSchema(r.errorPointSymbol2D),!1),line:this._createMeshTemplates([],u.createSymbolSchema(r.errorPolylineSymbol2D),!1)})};e._fetchAllQueuedResources=function(b){if(!this._fetchQueue.length)return Promise.resolve();const a=this._fetchQueue,c=this._cimAnalyses;this._fetchQueue=[];this._cimAnalyses=
[];return Promise.all(c).then(()=>this._fetchResource(a,b).then(d=>{for(const {id:m,mosaicItem:H}of d)this._idToResolver.get(m)(H),this._idToResolver.delete(m)})).catch(d=>{B.isAbortError(d)?this._fetchQueue=this._fetchQueue.concat(a):"worker:port-closed"!==d.name&&f.error(new A("mapview-template-store","Unable to fetch requested texture resources",d))})};e._createGroupId=function(b){return this._idCounter++<<1|(b?1:0)};e._createTemplateId=function(){return this._templateIdCounter++};e._createSMS=
function(){var b=g._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(a);return h.ok(c,f)?n.fromSimpleMarker(a,c):this._markerError});return function(a){return b.apply(this,arguments)}}();e._createPMS=function(){var b=g._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(a);return h.ok(c,f)?n.fromPictureMarker(a,c):this._markerError});return function(a){return b.apply(this,arguments)}}();e._createSFS=function(){var b=g._asyncToGenerator(function*(a,
c){const {spriteMosaicItem:d}=yield this.getMosaicItem(a);return h.ok(d,f)?t.fromSimpleFill(a,d,c):this._fillError});return function(a,c){return b.apply(this,arguments)}}();e._createPFS=function(){var b=g._asyncToGenerator(function*(a,c){const {spriteMosaicItem:d}=yield this.getMosaicItem(a);return h.ok(d,f)?t.fromPictureFill(a,d,c):this._fillError});return function(a,c){return b.apply(this,arguments)}}();e._createSLS=function(){var b=g._asyncToGenerator(function*(a,c){({spriteMosaicItem:c}=yield this.getMosaicItem(a));
return h.ok(c,f)?v.fromSimpleLine(a,c):this._lineError});return function(a,c){return b.apply(this,arguments)}}();e._createLMS=function(){var b=g._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(a);return h.ok(c,f)?n.fromLineSymbolMarker(a,c):this._markerError});return function(a){return b.apply(this,arguments)}}();e._createTS=function(){var b=g._asyncToGenerator(function*(a){const {glyphMosaicItems:c}=yield this.getMosaicItem(a);return w.fromText(a,c)});return function(a){return b.apply(this,
arguments)}}();e._createCIMText=function(){var b=g._asyncToGenerator(function*(a){const {glyphMosaicItems:c}=yield this.getMosaicItem(a.cim,G.codepoints(a.text));return h.ok(c,f)?w.fromCIMText(a,c,this._tileInfo):this._textError});return function(a){return b.apply(this,arguments)}}();e._createCIMFill=function(){var b=g._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(a.cim);return h.ok(c,f)?t.fromCIMFill(a,c,this._tileInfo):this._fillError});return function(a){return b.apply(this,
arguments)}}();e._createCIMLine=function(){var b=g._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(a.cim);return h.ok(c,f)?v.fromCIMLine(a,c,this._tileInfo):this._lineError});return function(a){return b.apply(this,arguments)}}();e._createCIMMarker=function(){var b=g._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(a.cim);return h.ok(c,f)?n.fromCIMMarker(a,c,this._tileInfo):this._markerError});return function(a){return b.apply(this,
arguments)}}();e._createCIM=function(){var b=g._asyncToGenerator(function*(a){const c=a.templateHash;if(this._cimTemplateCache.has(c))return this._cimTemplateCache.get(c);a={...a,cim:{...a.cim,mosaicHash:a.materialHash}};let d;switch(a.type){case "marker":d=this._createCIMMarker(a);break;case "line":d=this._createCIMLine(a);break;case "fill":d=this._createCIMFill(a);break;case "text":d=this._createCIMText(a)}d.then(m=>this._cimTemplateCache.set(c,m));return d});return function(a){return b.apply(this,
arguments)}}();e._createDynamicCIM=function(b){const a=b.templateHash;if(this._cimTemplateCache.has(a))return this._cimTemplateCache.get(a);let c;switch(b.type){case "marker":c=E.fromCIMMarker(b,this._tileInfo);break;case "line":c=D.fromCIMLine(b,this._tileInfo);break;case "fill":c=C.fromCIMFill(b,this._tileInfo);break;case "text":c=F.fromCIMText(b,this._tileInfo)}this._cimTemplateCache.set(a,c);return c};e._createPrimitiveMeshTemplates=function(b,a,c){switch(a.type){case "esriSMS":return l(b,this._createSMS(a));
case "esriPMS":return l(b,this._createPMS(a));case "esriSFS":return l(b,this._createSFS(a,c));case "line-marker":return l(b,this._createLMS(a));case "esriPFS":return l(b,this._createPFS(a,c));case "esriSLS":return l(b,this._createSLS(a,!1));case "esriTS":return l(b,this._createTS(a));default:return f.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),b}};e._createMeshTemplates=function(b,a,c){if(-1!==a.type.indexOf("3d"))return f.error("3D symbols are not supported with MapView"),
b;if("expanded-cim"===a.type){for(const d of a.layers)"function"===typeof d.materialHash?b.push(this._createDynamicCIM(d)):l(b,this._createCIM(d));return b}if("composite-symbol"===a.type){for(const d of a.layers)this._createPrimitiveMeshTemplates(b,d,c);return b}return"cim"===a.type||"label"===a.type||"web-style"===a.type?b:this._createPrimitiveMeshTemplates(b,a,c)};g._createClass(k,[{key:"_markerError",get:function(){return this._errorTemplates.marker[0]}},{key:"_fillError",get:function(){return this._errorTemplates.fill[0]}},
{key:"_lineError",get:function(){return this._errorTemplates.line[0]}},{key:"_textError",get:function(){return this._errorTemplates.line[0]}}]);return k}();p.WGLTemplateStore=q;p.isDynamicId=y;Object.defineProperty(p,"__esModule",{value:!0})});