// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/Logger ../../core/Queue ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ./keys ./handlers/LatestPointerType".split(" "),function(l,t,m,w,x,u,p,E,F,G,y,v,z){const r=x.getLogger("esri.views.input.InputManager");l.InputManager=function(n){function k(a){var b=n.call(this,a)||this;
b._pointerCaptures=new Map;b._nameToGroup={};b._handlers=[];b._currentPropagation=null;b._updateDependenciesAfterPropagation=!1;b._sourceEvents=new Set;b._keyModifiers=new Set;b._activeKeyModifiers=new Set;b._stoppedPropagationEventIds=new Set;b.primaryKey=v.primaryKey;b.latestPointerType="mouse";b.test={timestamp:void 0,hasCurrentPropagation:()=>!!b._currentPropagation};return b}t._inheritsLoose(k,n);var e=k.prototype;e.initialize=function(){this.eventSource.onEventReceived=this._onEventReceived.bind(this);
this._installRecognizers()};e.destroy=function(){const a=Object.keys(this._nameToGroup);for(const b of a)this.uninstallHandlers(b);this._currentPropagation=this.eventSource=null};e.installHandlers=function(a,b,c=q.INTERNAL){if(this._nameToGroup[a])r.error("There is already an InputHandler group registered under the name `"+a+"`");else if(0===b.length)r.error("Can't register a group of zero handlers");else{var d={name:a,handlers:b.map(g=>({handler:g,active:!0,removed:!1,priorityIndex:0,groupPriority:c,
eventCallback:null,uninstallCallback:null}))};this._nameToGroup[a]=d;for(a=d.handlers.length-1;0<=a;a--){const g=d.handlers[a];this._handlers.push(g);g.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(f,h,A,B,C)=>{this._emitInputEvent(g.priorityIndex+1,f,h,A,C,B)},setPointerCapture:(f,h)=>{this._setPointerCapture(d,g,f,h)},setEventCallback:f=>{g.eventCallback=f},setUninstallCallback:f=>{g.uninstallCallback=f},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}};
e.uninstallHandlers=function(a){const b=this._nameToGroup[a];b?(b.handlers.forEach(c=>{c.removed=!0;c.uninstallCallback()}),delete this._nameToGroup[a],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):r.error("There is no InputHandler group registered under the name `"+a+"`")};e.hasHandlers=function(a){return void 0!==this._nameToGroup[a]};e.updateDependencies=function(){if(this._currentPropagation)this._updateDependenciesAfterPropagation=
!0;else{this._updateDependenciesAfterPropagation=!1;var a=new Set,b=new Set;this._handlersPriority=[];for(var c=this._handlers.length-1;0<=c;c--){var d=this._handlers[c];d.priorityIndex=c;this._handlersPriority.push(d)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(c=this._handlersPriority.length-1;0<=c;c--){d=this._handlersPriority[c];d.priorityIndex=c;let g=d.handler.hasSideEffects;if(!g)for(const f of d.handler.outgoingEventTypes)if(a.has(f)){g=!0;break}if(g)for(const f of d.handler.incomingEventMatches){a.add(f.eventType);
for(const h of f.keyModifiers)v.isSystemModifier(h)||b.add(h)}d.active=g}this._sourceEvents=a;this._keyModifiers=b;0<this._pointerCaptures.size&&this._sourceEvents.add("pointer-capture-lost");0<this._keyModifiers.size&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up"));this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}};e._setLatestPointerType=function(a){this._set("latestPointerType",a)};e._onEventReceived=function(a,b){"pointer-capture-lost"===a&&this._pointerCaptures.delete(b.native.pointerId);
this._updateKeyModifiers(a,b);this._emitInputEventFromSource(a,b,null!=this.test.timestamp?this.test.timestamp:b.native?b.native.timestamp:void 0,b.native?b.native.cancelable:void 0)};e._updateKeyModifiers=function(a,b){if(b){var c=!1,d=()=>{if(!c){const f=new Set;this._activeKeyModifiers.forEach(h=>{f.add(h)});this._activeKeyModifiers=f;c=!0}},g=(f,h)=>{h&&!this._activeKeyModifiers.has(f)?(d(),this._activeKeyModifiers.add(f)):!h&&this._activeKeyModifiers.has(f)&&(d(),this._activeKeyModifiers.delete(f))};
if("key-down"===a||"key-up"===a){const f=b.key;this._keyModifiers.has(f)&&g(f,"key-down"===a)}a=b.native;g("Alt",!(!a||!a.altKey));g("Ctrl",!(!a||!a.ctrlKey));g("Shift",!(!a||!a.shiftKey));g("Meta",!(!a||!a.metaKey));g("Primary",this._activeKeyModifiers.has(this.primaryKey))}};e._installRecognizers=function(){this._latestPointerTypeHandler=new z.LatestPointerType(a=>this._setLatestPointerType(a));0<this.recognizers.length&&this.installHandlers("default",this.recognizers,q.INTERNAL);this.installHandlers("input-manager-logic",
[this._latestPointerTypeHandler],q.INTERNAL)};e._setPointerCapture=function(a,b,c,d){a=a.name+"-"+b.priorityIndex;b=this._pointerCaptures.get(c.pointerId)||new Set;this._pointerCaptures.set(c.pointerId,b);d?(b.add(a),1===b.size&&this.eventSource&&this.eventSource.setPointerCapture(c,!0)):b.has(a)&&(b.delete(a),0===b.size&&(this._pointerCaptures.delete(c.pointerId),this.eventSource&&this.eventSource.setPointerCapture(c,!1)))};e._garbageCollectRemovedHandlers=function(){this._handlers=this._handlers.filter(a=>
!a.removed);this.updateDependencies()};e._emitInputEventFromSource=function(a,b,c,d){this._emitInputEvent(0,a,b,c,d)};e._emitInputEvent=function(a,b,c,d,g,f){d=void 0!==d?d:this._currentPropagation?this._currentPropagation.timestamp:performance.now();a={event:new D(b,c,d,f||this._activeKeyModifiers,void 0!==g?g:!1),priorityIndex:a};this._currentPropagation?this._currentPropagation.events.push(a):this._doNewPropagation(a)};e._doNewPropagation=function(a){this._currentPropagation={events:new u,currentHandler:null,
needsHandlerGarbageCollect:!1,timestamp:a.event.timestamp};this._currentPropagation.events.push(a);this._continuePropagation()};e._continuePropagation=function(){const a=this._currentPropagation;if(a){for(;0<this._currentPropagation.events.length;){const {event:b,priorityIndex:c}=this._currentPropagation.events.pop(),d=b.data&&b.data.eventId;if(null==d||!this._stoppedPropagationEventIds.has(d))for(a.currentHandler=this._handlersPriority[c];a.currentHandler;){if(a.currentHandler.removed)a.needsHandlerGarbageCollect=
!0;else{a.currentHandler.active&&!b.shouldStopPropagation()&&a.currentHandler.eventCallback(b);if(b.shouldStopPropagation()){null!=d&&this._stoppedPropagationEventIds.add(d);break}if(b.shouldPausePropagation(()=>this._continuePropagation())){this._pausePropagation({event:b,priorityIndex:a.currentHandler.priorityIndex+1});return}}a.currentHandler=this._handlersPriority[a.currentHandler.priorityIndex+1]}}a.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers();this.hasPendingInputs||this._stoppedPropagationEventIds.clear();
this._currentPropagation=null;this._updateDependenciesAfterPropagation&&this.updateDependencies()}};e._pausePropagation=function(a){const b=new u;for(b.push(a);this._currentPropagation.events.length;)b.push(this._currentPropagation.events.pop());this._currentPropagation.events=b;this._currentPropagation.currentHandler=null};e._compareHandlerPriority=function(a,b){if(a.handler.hasSideEffects!==b.handler.hasSideEffects)return a.handler.hasSideEffects?1:-1;if(a.groupPriority!==b.groupPriority)return a.groupPriority>
b.groupPriority?-1:1;for(const c of a.handler.incomingEventMatches)for(const d of b.handler.incomingEventMatches){if(c.eventType!==d.eventType)continue;const g=c.keyModifiers.filter(f=>-1!==d.keyModifiers.indexOf(f));if(g.length===c.keyModifiers.length!==(g.length===d.keyModifiers.length))return c.keyModifiers.length>d.keyModifiers.length?-1:1}return a.priorityIndex>b.priorityIndex?-1:1};e._sortHandlersPriority=function(a){const b=[];for(const c of a){for(a=0;a<b.length&&0<=this._compareHandlerPriority(c,
b[a]);)a++;b.splice(a,0,c)}return b};t._createClass(k,[{key:"hasPendingInputs",get:function(){return this._handlers.some(a=>a.handler.hasPendingInputs)}},{key:"debug",get:function(){const a=b=>{const c=this._setPointerCapture;this._setPointerCapture=()=>{};b();this._setPointerCapture=c};return{injectEvent:(b,c)=>{a(()=>{this._onEventReceived(b,c)})},disablePointerCapture:a}}}]);return k}(w);m.__decorate([p.property({readOnly:!0})],l.InputManager.prototype,"hasPendingInputs",null);m.__decorate([p.property()],
l.InputManager.prototype,"eventSource",void 0);m.__decorate([p.property()],l.InputManager.prototype,"recognizers",void 0);m.__decorate([p.property({readOnly:!0})],l.InputManager.prototype,"latestPointerType",void 0);l.InputManager=m.__decorate([y.subclass("esri.views.input.InputManager")],l.InputManager);let D=function(){function n(e,a,b,c,d){this.type=e;this.data=a;this.timestamp=b;this.modifiers=c;this.cancelable=d;this._propagationState=0;this._resumeCallback=null}var k=n.prototype;k.stopPropagation=
function(){this._propagationState|=1};k.shouldStopPropagation=function(){return 0!==(this._propagationState&1)};k.async=function(e){this._propagationState|=2;const a=(b,c)=>{this._propagationState&=-3;const d=this._resumeCallback;this._resumeCallback=null;d&&d();if(c)throw b;return b};return("function"===typeof e?e():e).then(b=>a(b,!1),b=>a(b,!0))};k.shouldPausePropagation=function(e){return this._propagationState&2?(this._resumeCallback=e,!0):!1};k.preventDefault=function(){this.data.native.preventDefault()};
return n}();const q={DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};l.ViewEventPriorities=q;Object.defineProperty(l,"__esModule",{value:!0})});