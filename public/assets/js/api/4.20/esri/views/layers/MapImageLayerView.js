// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/Logger ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/ExportImageParameters ../../renderers/support/clickToleranceUtils ../../support/arcadeOnDemand ./support/popupUtils".split(" "),
function(r,k,f,E,w,F,l,t,L,M,N,G,H,I,J,K,x){t=b=>{b=function(u){function n(){return u.apply(this,arguments)||this}k._inheritsLoose(n,u);var m=n.prototype;m.initialize=function(){this.exportImageParameters=new I.ExportImageParameters({layer:this.layer})};m.destroy=function(){this.exportImageParameters.destroy();this.exportImageParameters=null};m.fetchPopupFeatures=function(){var c=k._asyncToGenerator(function*(v,p){var y=this,{layer:g}=this;if(!v)return Promise.reject(new E("mapimagelayerview:fetchPopupFeatures",
"Nothing to fetch without area",{layer:g}));const z=this.get("view.scale"),A=[],B=function(){var e=k._asyncToGenerator(function*(a){var d=0===a.minScale||z<=a.minScale;const h=0===a.maxScale||z>=a.maxScale;a.visible&&d&&h&&(a.sublayers?a.sublayers.forEach(B):a.popupEnabled&&(d=x.getFetchPopupTemplate(a,{...p,defaultPopupTemplateEnabled:!1}),w.isSome(d)&&A.unshift({sublayer:a,popupTemplate:d})))});return function(a){return e.apply(this,arguments)}}();g=g.sublayers.toArray().reverse().map(B);yield Promise.all(g);
g=A.map(function(){var e=k._asyncToGenerator(function*({sublayer:a,popupTemplate:d}){yield a.load().catch(()=>{});const h=a.createQuery();var q=w.isSome(p)?p.event:null;q=J.calculateTolerance({renderer:a.renderer,event:q});const C=y.createFetchPopupFeaturesQueryGeometry(v,q);h.geometry=C;h.outFields=yield x.getRequiredFields(a,d);const D=yield y._loadArcadeModules(d);D&&D.arcadeUtils.hasGeometryOperations(d)||(h.maxAllowableOffset=C.width/q);return(yield a.queryFeatures(h)).features});return function(a){return e.apply(this,
arguments)}}());return(yield F.eachAlways(g)).reduce((e,a)=>a.value?[...e,...a.value]:e,[]).filter(e=>null!=e)});return function(v,p){return c.apply(this,arguments)}}();m.canResume=function(){var c;return!u.prototype.canResume.call(this)||null!=(c=this.timeExtent)&&c.isEmpty?!1:!0};m._loadArcadeModules=function(c){if(c.get("expressionInfos.length"))return K.loadArcade()};k._createClass(n,[{key:"exportImageVersion",get:function(){var c;null==(c=this.exportImageParameters)?void 0:c.commitProperty("version");
this.commitProperty("timeExtent");return(this._get("exportImageVersion")||0)+1}}]);return n}(b);f.__decorate([l.property()],b.prototype,"exportImageParameters",void 0);f.__decorate([l.property({readOnly:!0})],b.prototype,"exportImageVersion",null);f.__decorate([l.property()],b.prototype,"layer",void 0);f.__decorate([l.property()],b.prototype,"suspended",void 0);f.__decorate([l.property(H.combinedViewLayerTimeExtentProperty)],b.prototype,"timeExtent",void 0);return b=f.__decorate([G.subclass("esri.views.layers.MapImageLayerView")],
b)};r.MapImageLayerView=t;r.default=t;Object.defineProperty(r,"__esModule",{value:!0})});