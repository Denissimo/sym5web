// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/accessorSupport/ensureType ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/fieldUtils ../../rest/support/Query ../../support/arcadeOnDemand ./support/FeatureEffect ./support/FeatureFilter ./support/popupUtils".split(" "),
function(x,t,m,A,u,q,B,y,p,K,L,M,E,F,f,G,H,I,J,v){const C=u.getLogger("esri.views.layers.FeatureLayerView");u=h=>{h=function(z){function w(...b){b=z.call(this,...b)||this;b._updatingRequiredFieldsPromise=null;b.effect=null;b.filter=null;b.timeExtent=null;b.layer=null;b.requiredFields=[];b.view=null;return b}t._inheritsLoose(w,z);var l=w.prototype;l.initialize=function(){y.init(this,"layer.renderer layer.labelingInfo layer.elevationInfo.featureExpressionInfo layer.displayField filter effect layer.timeInfo layer.floorInfo timeExtent".split(" "),
()=>this._handleRequiredFieldsChange(),!0);y.on(this,"view.floors","change",()=>this._handleRequiredFieldsChange());y.on(this,"layer.sublayer","change",()=>this._handleRequiredFieldsChange())};l.highlight=function(b){throw Error("missing implementation");};l.createQuery=function(){var b={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};b=q.isSome(this.filter)?this.filter.createQuery(b):new G(b);q.isSome(this.timeExtent)&&(b.timeExtent=q.isSome(b.timeExtent)?b.timeExtent.intersection(this.timeExtent):
this.timeExtent.clone());return b};l.queryFeatures=function(b,c){throw Error("missing implementation");};l.queryObjectIds=function(b,c){throw Error("missing implementation");};l.queryFeatureCount=function(b,c){throw Error("missing implementation");};l.queryExtent=function(b,c){throw Error("missing implementation");};l._loadArcadeModules=function(b){if(b.get("expressionInfos.length"))return H.loadArcade()};l._handleRequiredFieldsChange=function(){const b=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",
b);b.then(()=>{this._updatingRequiredFieldsPromise===b&&this._set("_updatingRequiredFieldsPromise",null)})};l._updateRequiredFields=function(){var b=t._asyncToGenerator(function*(){if(this.layer&&this.view){var c="3d"===this.view.type,{layer:a,layer:{fieldsIndex:n,objectIdField:k}}=this,e="renderer"in a&&a.renderer,g=a.featureReduction,d=new Set;e=yield B.eachAlways([e?e.collectRequiredFields(d,n):null,f.collectLabelingFields(d,a),c?f.collectElevationFields(d,a):null,q.isSome(this.filter)?f.collectFilterFields(d,
a,this.filter):null,this.effect?f.collectFilterFields(d,a,this.effect.filter):null,g?f.collectFeatureReductionFields(d,a,g):null]);a.timeInfo&&this.timeExtent&&f.collectFields(d,a.fieldsIndex,[a.timeInfo.startField,a.timeInfo.endField]);"feature"===a.type&&a.floorInfo&&f.collectFields(d,a.fieldsIndex,[a.floorInfo.floorField]);"subtype-group"===a.type&&(f.collectField(d,n,a.subtypeField),g=a.sublayers.map(r=>{var D;return Promise.all([null==(D=r.renderer)?void 0:D.collectRequiredFields(d,n),f.collectLabelingFields(d,
r)])}),yield B.eachAlways(g));for(const r of e)r.error&&C.error(r.error);f.collectField(d,n,k);c&&"displayField"in a&&a.displayField&&f.collectField(d,n,a.displayField);c=Array.from(d).sort();this._set("requiredFields",c)}});return function(){return b.apply(this,arguments)}}();l.validateFetchPopupFeatures=function(b){if(q.isNone(b))return null;for(const c of b.clientGraphics){const a=c.layer;if("popupEnabled"in a&&!a.popupEnabled)return new A("featurelayerview:fetchPopupFeatures","Popups are disabled",
{layer:a});if("popupTemplate"in a&&!v.getFetchPopupTemplate(a,b))return new A("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})}};l.fetchClientPopupFeatures=function(){var b=t._asyncToGenerator(function*(c){var a=q.isSome(c)?c.clientGraphics:null;if(!a||0===a.length)return Promise.resolve([]);const n=[],k=[],e=yield this.createPopupQuery(c);for(const d of a){var {layer:g}=d;if(!("popupEnabled"in g))continue;a=f.unpackFieldNames(this.layer.fieldsIndex,e.outFields);
g=v.getFetchPopupTemplate(g,c);if(!q.isSome(g))continue;const r=yield this._loadArcadeModules(g);r&&r.arcadeUtils.hasGeometryOperations(g)||!f.featureHasFields(a,d)?k.push(d):n.push(d)}if("stream"===this.layer.type||0===k.length)return Promise.resolve(n);e.objectIds=k.map(d=>d.attributes[this.layer.objectIdField]);return this.layer.queryFeatures(e).then(d=>n.concat(d.features)).catch(()=>k)});return function(c){return b.apply(this,arguments)}}();l.createPopupQuery=function(){var b=t._asyncToGenerator(function*(c){const a=
this.layer.createQuery(),n=new Set;var k=!1,e=q.isSome(c)&&c.clientGraphics?c.clientGraphics.map(g=>g.layer):[this.layer];for(const g of e)if("popupEnabled"in g&&(e=v.getFetchPopupTemplate(g,c),q.isSome(e))){k=(k=yield this._loadArcadeModules(e))&&k.arcadeUtils.hasGeometryOperations(e);k=!("point"!==this.layer.geometryType&&!k);e=yield v.getRequiredFields(this.layer,e);for(const d of e)n.add(d)}a.returnGeometry=k;a.returnZ=k;a.returnM=k;a.outFields=Array.from(n);a.outSpatialReference=this.view.spatialReference;
return a});return function(c){return b.apply(this,arguments)}}();l.canResume=function(){return!z.prototype.canResume.call(this)||q.isSome(this.timeExtent)&&this.timeExtent.isEmpty?!1:!0};t._createClass(w,[{key:"availableFields",get:function(){const {layer:b,layer:{fieldsIndex:c},requiredFields:a}=this;return"outFields"in b&&b.outFields?f.fixFields(c,[...f.unpackFieldNames(c,b.outFields),...a]):f.fixFields(c,a)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(b){C.error("#maximumNumberOfFeatures\x3d",
"Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]);return w}(h);m.__decorate([p.property()],h.prototype,"_updatingRequiredFieldsPromise",void 0);m.__decorate([p.property({readOnly:!0})],h.prototype,"availableFields",null);m.__decorate([p.property({type:I})],h.prototype,"effect",void 0);m.__decorate([p.property({type:J})],h.prototype,"filter",void 0);m.__decorate([p.property(F.combinedViewLayerTimeExtentProperty)],h.prototype,
"timeExtent",void 0);m.__decorate([p.property()],h.prototype,"layer",void 0);m.__decorate([p.property({type:Number})],h.prototype,"maximumNumberOfFeatures",null);m.__decorate([p.property({readOnly:!0,type:Boolean})],h.prototype,"maximumNumberOfFeaturesExceeded",null);m.__decorate([p.property({readOnly:!0})],h.prototype,"requiredFields",void 0);m.__decorate([p.property()],h.prototype,"suspended",void 0);m.__decorate([p.property()],h.prototype,"view",void 0);return h=m.__decorate([E.subclass("esri.views.layers.FeatureLayerView")],
h)};x.FeatureLayerView=u;x.default=u;Object.defineProperty(x,"__esModule",{value:!0})});