// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../Graphic ../../../core/Collection ../../../core/Evented ../../../core/Handles ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/Logger ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/coordsUtils ../../../layers/GraphicsLayer ../../../symbols/SimpleMarkerSymbol ../../2d/interactive/SnappingVisualizer2D ./drawUtils ./GraphicMover ./layerUtils ./settings ../../input/InputManager ../../interactive/keybindings ../../interactive/editGeometry/EditGeometryHelper ../../interactive/snapping/SnappingContext ../../../geometry/Point".split(" "),
function(D,u,v,z,H,t,I,w,J,E,x,ha,ia,ja,ka,K,A,L,B,M,N,O,P,Q,R,S,T,U,C){let V=function(p,q,d){this.graphic=p;this.mover=q;this.selected=d;this.type="reshape-start"},W=function(p,q,d){this.graphic=p;this.mover=q;this.selected=d;this.type="reshape"},X=function(p,q,d){this.graphic=p;this.mover=q;this.selected=d;this.type="reshape-stop"},Y=function(p,q,d){this.mover=p;this.dx=q;this.dy=d;this.type="move-start"},Z=function(p,q,d){this.mover=p;this.dx=q;this.dy=d;this.type="move"},aa=function(p,q,d){this.mover=
p;this.dx=q;this.dy=d;this.type="move-stop"},ba=function(p){this.added=p;this.type="vertex-select"},ca=function(p){this.removed=p;this.type="vertex-deselect"},da=function(p,q,d,a){this.added=p;this.graphic=q;this.oldGraphic=d;this.vertices=a;this.type="vertex-add"},ea=function(p,q,d,a){this.removed=p;this.graphic=q;this.oldGraphic=d;this.vertices=a;this.type="vertex-remove"};v=Q.settings.reshapeGraphics;const F={vertices:{default:new B({style:"circle",size:v.vertex.size,color:v.vertex.color,outline:{color:v.vertex.outlineColor,
width:1}}),hover:new B({style:"circle",size:v.vertex.hoverSize,color:v.vertex.hoverColor,outline:{color:v.vertex.hoverOutlineColor,width:1}}),selected:new B({style:"circle",size:v.selected.size,color:v.selected.color,outline:{color:v.selected.outlineColor,width:1}})},midpoints:{default:new B({style:"circle",size:v.midpoint.size,color:v.midpoint.color,outline:{color:v.midpoint.outlineColor,width:1}}),hover:new B({style:"circle",size:v.midpoint.size,color:v.midpoint.color,outline:{color:v.midpoint.outlineColor,
width:1}})}};t=function(p){function q(a){a=p.call(this,a)||this;a._activeOperationInfo=null;a._handles=new I;a._graphicAttributes={esriSketchTool:"box"};a._mover=null;a._snappingTask=null;a._stagedVertex=null;a._viewHandles=new I;a.callbacks={onReshapeStart(){},onReshape(){},onReshapeStop(){},onMoveStart(){},onMove(){},onMoveStop(){},onGraphicClick(){}};a.enableMidpoints=!0;a.enableMovement=!0;a.enableVertices=!0;a.graphic=null;a.vertexGraphics=new H;a.layer=null;a.midpointGraphics=new H;a.midpointSymbol=
new B({style:"circle",size:6,color:[200,200,200],outline:{color:[100,100,100],width:1}});a.selectedVertices=[];a.snappingManager=null;a.type="reshape";a.view=null;return a}D._inheritsLoose(q,p);var d=q.prototype;d.initialize=function(){this._setup();this._handles.add([E.whenOnce(this,"view.ready",()=>{const {layer:a,view:b}=this;P.addUniqueLayer(b,a);this._viewHandles.add([b.on("key-down",c=>this._keyDownHandler(c),R.ViewEventPriorities.TOOL)])}),E.pausable(this,"graphic",()=>this.refresh()),E.pausable(this,
"layer",(a,b)=>{b&&(this._clearSelection(),this._resetGraphics(b));this.refresh()}),E.pausable(this,"enableMidpoints",()=>{this.refresh()})])};d.destroy=function(){var a;this._reset();null==(a=this._mover)?void 0:a.destroy();this._mover=null;this._handles=w.destroyMaybe(this._handles);this._viewHandles=w.destroyMaybe(this._viewHandles)};d.isUIGraphic=function(a){const b=[];this.graphic&&b.push(this.graphic);b.concat(this.vertexGraphics.items,this.midpointGraphics.items);return b.length&&b.includes(a)};
d.refresh=function(){this._reset();this._setup()};d.reset=function(){this.graphic=null};d.clearSelection=function(){this._clearSelection()};d.removeSelectedVertices=function(){this.selectedVertices.length&&this._removeVertices(this.selectedVertices)};d._setup=function(){const {graphic:a,layer:b}=this;a&&b&&!w.isNone(a.geometry)&&(this._setupGraphics(),this._setupMover())};d._setUpGeometryHelper=function(){const a=this.graphic.geometry;w.isNone(a)||"point"!==a.type&&"polygon"!==a.type&&"polyline"!==
a.type||(this._geometryHelper=T.EditGeometryHelper.fromGeometry(a,"local"))};d._saveSnappingContextForHandle=function(a,b){var c;this._snappingGraphicsLayer=new L({listMode:"hide",internal:!0,title:"Reshape snapping layer"});this.view.map.layers.add(this._snappingGraphicsLayer);this._snappingContext=new U.SnappingContext({geometry:this._geometryHelper,elevationInfo:{mode:"on-the-ground",offset:0},pointer:(null==(c=b.viewEvent)?void 0:c.pointerType)||"mouse",excludeFeature:this.graphic,visualizer:new M.SnappingVisualizer2D(this._snappingGraphicsLayer),
vertexHandle:this._getVertexFromEditGeometry(a)})};d._reset=function(){this._clearSelection();this._resetGraphics();this._resetSnappingStateVars();this._activeOperationInfo=null;this._mover&&this._mover.destroy();this._mover=null;this.view.cursor="default"};d._resetSnappingStateVars=function(){var a;w.isSome(this.snappingManager)&&this.snappingManager.doneSnapping();w.isSome(this._snappingGraphicsLayer)&&(this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy());
null==(a=this._geometryHelper)?void 0:a.destroy();this._geometryHelper=null;this._snappingTask=w.abortMaybe(this._snappingTask);this._stagedVertex=this._snappingContext=this._snappingTask=null};d._resetGraphics=function(a){this._removeMidpointGraphics(a);this._removeVertexGraphics(a);this._set("selectedVertices",[])};d._removeMidpointGraphics=function(a){(a=a||this.layer)&&a.removeMany(this.midpointGraphics.items);this.midpointGraphics.items.forEach(b=>b.destroy());this.midpointGraphics.removeAll()};
d._removeVertexGraphics=function(a){(a=a||this.layer)&&a.removeMany(this.vertexGraphics.items);this.vertexGraphics.items.forEach(b=>b.destroy());this.vertexGraphics.removeAll()};d._getCoordinatesForUI=function(a){const b=A.geometryToCoordinates(a.clone());if("polygon"===a.type)for(const c of b)a=c[c.length-1],c[0][0]===a[0]&&c[0][1]===a[1]&&2<c.length&&c.pop();return b};d._setupGraphics=function(){var a=this.graphic.geometry;!w.isSome(a)||"polyline"!==a.type&&"polygon"!==a.type||(a=this._getCoordinatesForUI(a),
this.enableMidpoints&&this._setUpMidpointGraphics(a),this.enableVertices&&this._setUpVertexGraphics(a))};d._setUpMidpointGraphics=function(a){this._removeMidpointGraphics();a=this._createMidpointGraphics(a);this.midpointGraphics.addMany(a);this.layer.addMany(a)};d._setUpVertexGraphics=function(a){this._removeVertexGraphics();a=this._createVertexGraphics(a);this.vertexGraphics.addMany(a);this._storeRelatedVertexIndices();this.layer.addMany(a)};d._createVertexGraphics=function(a){const {_graphicAttributes:b,
symbols:c,view:{spatialReference:e}}=this,h=[];null==a?void 0:a.forEach((f,l)=>{f.forEach((g,m)=>{var n;const [k,r]=g;h.push(new z({geometry:new C({x:k,y:r,spatialReference:e}),symbol:null==c?void 0:null==(n=c.vertices)?void 0:n.default,attributes:{...b,pathIndex:l,pointIndex:m}}))})});return h};d._createMidpointGraphics=function(a){const {_graphicAttributes:b,symbols:c,view:{spatialReference:e}}=this,h=[];null==a?void 0:a.forEach((f,l)=>{f.forEach((g,m)=>{const [n,k]=g;g=f[m+1]?m+1:0;if("polygon"===
w.get(this.graphic.geometry,"type")||0!==g){const [r,y]=f[g],[G,fa]=A.getMidpoint([n,k],[r,y]);h.push(new z({geometry:new C({x:G,y:fa,spatialReference:e}),symbol:c.midpoints.default,attributes:{...b,pathIndex:l,pointIndexStart:m,pointIndexEnd:g}}))}})});return h};d._storeRelatedVertexIndices=function(){const a=this.vertexGraphics.items;if(a){var b=a.map(({geometry:c})=>({x:c.x,y:c.y}));for(let c=0;c<b.length;c++){const e=[];for(let h=0;h<b.length;h++){if(c===h)continue;const f=b[c],l=b[h];f.x===l.x&&
f.y===l.y&&e.push(h)}a[c].attributes.relatedGraphicIndices=e}}};d._setupMover=function(){const {enableMovement:a,graphic:b,midpointGraphics:c,vertexGraphics:e,view:h}=this,f="point"===w.get(b.geometry,"type"),l=e.concat(c).items;a&&l.push(b);this._mover=new O({enableMoveAllGraphics:!1,indicatorsEnabled:f,graphics:l,view:h,callbacks:{onGraphicClick:g=>this._onGraphicClickCallback(g),onGraphicMoveStart:g=>this._onGraphicMoveStartCallback(g),onGraphicMove:g=>this._onGraphicMoveCallback(g),onGraphicMoveStop:g=>
this._onGraphicMoveStopCallback(g),onGraphicPointerOver:g=>this._onGraphicPointerOverCallback(g),onGraphicPointerOut:g=>this._onGraphicPointerOutCallback(g)}})};d._onGraphicClickCallback=function(a){a.viewEvent.stopPropagation();const b=a.graphic;if(b===this.graphic){if(this.clearSelection(),this.emit("graphic-click",a),this.callbacks.onGraphicClick)this.callbacks.onGraphicClick(a)}else if(this._isMidpoint(b)){if(2!==a.viewEvent.button){a=this.graphic.clone();var c=this._createVertexFromMidpoint(b);
this.refresh();this._emitVertexAddEvent([b],a,c)}}else this._isVertex(b)&&(a.viewEvent.stopPropagation(),2===a.viewEvent.button?this._removeVertices(b):(a.viewEvent.native.shiftKey||this._clearSelection(),this.selectedVertices.includes(b)?this._removeFromSelection(b,!0):this._addToSelection(b)))};d._setUpOperation=function(a){const {graphic:b,dx:c,dy:e}=a,h=b===this.graphic;this._resetSnappingStateVars();this._setUpGeometryHelper();this._saveSnappingContextForHandle(b,a);this._activeOperationInfo=
{target:this.graphic,mover:b,operationType:h?"move":"reshape",totalDx:c,totalDy:e}};d._onGraphicMoveStartCallback=function(a){const b=a.graphic,{dx:c,dy:e}=a;if(b===this.graphic)this._clearSelection(),this._resetGraphics(),this._setUpOperation(a),this._emitMoveStartEvent(c,e),"point"===this._geometryHelper.geometry.type&&this._onHandleMove(b,c,e,a,()=>this._emitMoveEvent(c,e));else{if(!this.selectedVertices.includes(b)){this._clearSelection();if(this._isMidpoint(b)){const h=this.graphic.clone(),f=
this._createVertexFromMidpoint(b);this._emitVertexAddEvent([b],h,f)}this._addToSelection(b)}this._setUpOperation(a);this._emitReshapeStartEvent(b);this._onHandleMove(b,c,e,a,()=>this._emitReshapeEvent(b))}};d._onGraphicMoveCallback=function(a){const {graphic:b,dx:c,dy:e}=a;this._activeOperationInfo.totalDx+=c;this._activeOperationInfo.totalDy+=e;const {operationType:h}=this._activeOperationInfo,{geometry:f}=this._geometryHelper;"move"===h?"point"===f.type?this._onHandleMove(b,c,e,a,()=>this._emitMoveEvent(c,
e)):this._emitMoveEvent(c,e):this._onHandleMove(b,c,e,a,()=>this._emitReshapeEvent(b))};d._onGraphicMoveStopCallback=function(a){const {graphic:b,dx:c,dy:e}=a;this._activeOperationInfo.totalDx+=c;this._activeOperationInfo.totalDy+=e;b===this.graphic?(this._emitMoveStopEvent(),this.refresh()):(this._onHandleMove(b,c,e,a,()=>this._emitReshapeStopEvent(b)),this._resetSnappingStateVars(),this._activeOperationInfo=null,this._isMidpoint(b)&&this.refresh())};d._updateMidpointGraphicLocations=function(a){for(const b of this.midpointGraphics){const {pathIndex:c,
pointIndexStart:e,pointIndexEnd:h}=b.attributes,[f,l]=a[c][e],[g,m]=a[c][h],[n,k]=A.getMidpoint([f,l],[g,m]);b.geometry=new C({x:n,y:k,spatialReference:this.view.spatialReference})}};d._getIndicesForVertexGraphic=function({attributes:a}){return[(null==a?void 0:a.pathIndex)||0,(null==a?void 0:a.pointIndex)||0]};d._getVertexFromEditGeometry=function(a){var b;const [c,e]=this._getIndicesForVertexGraphic(a);return null==(b=this._geometryHelper)?void 0:b.editGeometry.components[c].vertices[e]};d._onHandleMove=
function(a,b,c,e,h){var f=this;w.abortMaybe(this._snappingTask);const l=a.geometry,g="graphic-move-stop"===e.type;if(w.isSome(this.snappingManager)&&2>this.selectedVertices.length&&!g){const m=this.snappingManager;this._stagedVertex=m.update(l,this._snappingContext);this._syncGeometryAfterVertexMove(a,new C(this._stagedVertex),b,c,g);h();this._snappingTask=J.createTask(function(){var n=D._asyncToGenerator(function*(k){k=yield m.snap(l,f._snappingContext,k);k.valid&&(f._stagedVertex=k.apply(),f._syncGeometryAfterVertexMove(a,
new C(f._stagedVertex),b,c,g),h())});return function(k){return n.apply(this,arguments)}}())}else e=w.isSome(this._stagedVertex)?new C(this._stagedVertex):l,this._syncGeometryAfterVertexMove(a,e,b,c,g),h()};d._syncGeometryAfterVertexMove=function(){var a=D._asyncToGenerator(function*(b,c,e,h,f=!1){const l=this._geometryHelper.geometry;if("point"===l.type)b.geometry=c;else{const {x:g,y:m}=c,[n,k]=this._getIndicesForVertexGraphic(b);let r=A.geometryToCoordinates(l);const y=r[n].length-1;r[n][k]=[g,m];
"polygon"===l.type&&(0===k?r[n][y]=[g,m]:k===y&&(r[n][0]=[g,m]));this._isVertex(b)&&(r=this._moveRelatedCoordinates(r,b,g,m),r=this._moveSelectedHandleCoordinates(r,b,e,h,"polygon"===l.type),this._updateMidpointGraphicLocations(r));this.graphic.geometry=l.clone();this._syncEditGeometryAfterVertexMove(b,g,m);f&&(this._mover?this._mover.updateGeometry(this._mover.graphics.indexOf(b),c):b.geometry=c)}});return function(b,c,e,h){return a.apply(this,arguments)}}();d._moveRelatedCoordinates=function(a,
b,c,e){var {relatedGraphicIndices:h}=b.attributes;for(const f of h){h=this.vertexGraphics.getItemAt(f);const {pathIndex:l,pointIndex:g}=h.attributes;a[l][g]=[c,e];h.geometry=b.geometry}return a};d._moveSelectedHandleCoordinates=function(a,b,c,e,h){for(const l of this.selectedVertices)if(l!==b){const {pathIndex:g,pointIndex:m,relatedGraphicIndices:n}=l.attributes,k=N.cloneMove(l.geometry,c,e,this.view);var f=a[g].length-1;a[g][m]=[k.x,k.y];l.geometry=k;h&&(0===m?a[g][f]=[k.x,k.y]:m===f&&(a[g][0]=[k.x,
k.y]));for(const r of n){f=this.vertexGraphics.getItemAt(r);const {pathIndex:y,pointIndex:G}=f.attributes;a[y][G]=[k.x,k.y];f.geometry=k}}return a};d._syncEditGeometryAfterVertexMove=function(a,b,c){a=this._getVertexFromEditGeometry(a);this._geometryHelper.moveVertices([a],b-a.pos[0],c-a.pos[1],0)};d._onGraphicPointerOverCallback=function(a){a=a.graphic;this._isVertex(a)&&!this._isSelected(a)&&(a.symbol=this.symbols.vertices.hover);this._updateHoverCursor(a)};d._onGraphicPointerOutCallback=function(a){a=
a.graphic;this._isVertex(a)&&!this._isSelected(a)&&(a.symbol=this.symbols.vertices.default);this.view.cursor="default"};d._createVertexFromMidpoint=function(a){const {_graphicAttributes:b,graphic:c}=this;var e=c.geometry;if(w.isNone(e)||"polygon"!==e.type&&"polyline"!==e.type)return[];e=e.clone();const h=[],{pathIndex:f,pointIndexStart:l,pointIndexEnd:g}=a.attributes,{x:m,y:n}=a.geometry,k=0===g?l+1:g,r=A.geometryToCoordinates(e);r[f].splice(k,0,[m,n]);a.attributes={...b,pathIndex:f,pointIndex:k,
relatedGraphicIndices:[]};h.push({coordinates:r[f][k],componentIndex:f,vertexIndex:k});this.graphic.geometry=e;return h};d._addToSelection=function(a){a instanceof z&&(a=[a]);for(const b of a)b.symbol=this.symbols.vertices.selected;this._set("selectedVertices",this.selectedVertices.concat(a));this._emitSelectEvent(a)};d._removeFromSelection=function(a,b){const {vertices:c}=this.symbols;b=b?c.hover:c.default;a instanceof z&&(a=[a]);for(const e of a)this.selectedVertices.splice(this.selectedVertices.indexOf(e),
1),this._set("selectedVertices",this.selectedVertices),e.set("symbol",b);this._emitDeselectEvent(a)};d._clearSelection=function(){if(this.selectedVertices.length){const a=this.selectedVertices;for(const b of this.selectedVertices)b.set("symbol",this.symbols.vertices.default);this._set("selectedVertices",[]);this._emitDeselectEvent(a)}};d._keyDownHandler=function(a){S.SKETCH_KEYS.delete.includes(a.key)&&!a.repeat&&this.selectedVertices.length&&this._removeVertices(this.selectedVertices)};d._removeVertices=
function(a){var b=this.graphic.geometry;if(!(w.isNone(b)||"polygon"!==b.type&&"polyline"!==b.type||"polygon"===b.type&&4>this.vertexGraphics.length||3>this.vertexGraphics.length)){a instanceof z&&(a=[a]);var c=this.graphic.clone();b=b.clone();var e=A.geometryToCoordinates(b),h=[];a instanceof z&&(a=[a]);for(const f of a){const {x:l,y:g}=f.geometry;for(let m=0;m<e.length;m++){const n=e[m];for(let k=0;k<n.length;k++){const [r,y]=n[k];l===r&&g===y&&(h.push({coordinates:e[m][k],componentIndex:m,vertexIndex:k}),
e[m].splice(Number(k),1))}}}if("polygon"===b.type)for(const f of e){const [l,g]=f[0],[m,n]=f[f.length-1];(1===f.length||3>f.length&&l===m&&g===n)&&e.splice(e.indexOf(f),1);2<f.length&&(l!==m||g!==n)&&f.push(f[0])}else for(const f of e)1===f.length&&e.splice(e.indexOf(f),1);this.graphic.geometry=b;this.refresh();this._emitVertexRemoveEvent(a,c,h)}};d._isVertex=function(a){return this.vertexGraphics.includes(a)};d._isSelected=function(a){return this._isVertex(a)&&this.selectedVertices.includes(a)};
d._isMidpoint=function(a){return this.midpointGraphics.includes(a)};d._updateHoverCursor=function(a){this.view.cursor=this._isMidpoint(a)?"copy":"move"};d._emitMoveStartEvent=function(a,b){a=new Y(this.graphic,a,b);this.emit("move-start",a);if(this.callbacks.onMoveStart)this.callbacks.onMoveStart(a)};d._emitMoveEvent=function(a,b){a=new Z(this.graphic,a,b);this.emit("move",a);if(this.callbacks.onMove)this.callbacks.onMove(a)};d._emitMoveStopEvent=function(){const {totalDx:a,totalDy:b}=this._activeOperationInfo,
c=new aa(this.graphic,a,b);this.emit("move-stop",c);if(this.callbacks.onMoveStop)this.callbacks.onMoveStop(c)};d._emitReshapeStartEvent=function(a){a=new V(this.graphic,a,this.selectedVertices);this.emit("reshape-start",a);if(this.callbacks.onReshapeStart)this.callbacks.onReshapeStart(a)};d._emitReshapeEvent=function(a){a=new W(this.graphic,a,this.selectedVertices);this.emit("reshape",a);if(this.callbacks.onReshape)this.callbacks.onReshape(a)};d._emitReshapeStopEvent=function(a){a=new X(this.graphic,
a,this.selectedVertices);this.emit("reshape-stop",a);if(this.callbacks.onReshapeStop)this.callbacks.onReshapeStop(a)};d._emitSelectEvent=function(a){a=new ba(a);this.emit("select",a);if(this.callbacks.onVertexSelect)this.callbacks.onVertexSelect(a)};d._emitDeselectEvent=function(a){a=new ca(a);this.emit("deselect",a);if(this.callbacks.onVertexDeselect)this.callbacks.onVertexDeselect(a)};d._emitVertexAddEvent=function(a,b,c){a=new da(a,this.graphic,b,c);this.emit("vertex-add",a);if(this.callbacks.onVertexAdd)this.callbacks.onVertexAdd(a)};
d._emitVertexRemoveEvent=function(a,b,c){a=new ea(a,this.graphic,b,c);this.emit("vertex-remove",a);if(this.callbacks.onVertexRemove)this.callbacks.onVertexRemove(a)};D._createClass(q,[{key:"state",get:function(){const a=!!this.get("view.ready"),b=!(!this.get("graphic")||!this.get("layer"));return a&&b?"active":a?"ready":"disabled"}},{key:"symbols",set:function(a){const {midpoints:b=F.midpoints,vertices:c=F.vertices}=a||{};this._set("symbols",{midpoints:b,vertices:c})}}]);return q}(t.EventedAccessor);
u.__decorate([x.property()],t.prototype,"callbacks",void 0);u.__decorate([x.property()],t.prototype,"enableMidpoints",void 0);u.__decorate([x.property()],t.prototype,"enableMovement",void 0);u.__decorate([x.property()],t.prototype,"enableVertices",void 0);u.__decorate([x.property()],t.prototype,"graphic",void 0);u.__decorate([x.property({readOnly:!0})],t.prototype,"vertexGraphics",void 0);u.__decorate([x.property()],t.prototype,"layer",void 0);u.__decorate([x.property({readOnly:!0})],t.prototype,
"midpointGraphics",void 0);u.__decorate([x.property()],t.prototype,"midpointSymbol",void 0);u.__decorate([x.property({readOnly:!0})],t.prototype,"selectedVertices",void 0);u.__decorate([x.property()],t.prototype,"snappingManager",void 0);u.__decorate([x.property({readOnly:!0})],t.prototype,"state",null);u.__decorate([x.property({value:F})],t.prototype,"symbols",null);u.__decorate([x.property({readOnly:!0})],t.prototype,"type",void 0);u.__decorate([x.property()],t.prototype,"view",void 0);return t=
u.__decorate([K.subclass("esri.views.draw.support.Reshape")],t)});