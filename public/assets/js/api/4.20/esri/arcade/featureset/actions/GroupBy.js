// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../../../chunks/languageUtils ./Adapted ./AttributeFilter ./OrderBy ../support/FeatureSet ../support/IdSet ../support/OrderbyClause ../support/shared ../support/sqlUtils ../support/stats ../support/StatsField ../../../core/MD5 ../../../core/promiseUtils ../../../core/sql/WhereClause ../../../geometry/SpatialReference ../../../layers/support/Field ../../../layers/support/FieldsIndex".split(" "),function(G,A,H,y,I,B,C,u,D,r,p,t,E,F,
n,v,J,z,K){function L(w){if(!w)return"COUNT";switch(w.toLowerCase()){case "max":return"MAX";case "var":case "variance":return"VAR";case "avg":case "average":case "mean":return"AVG";case "min":return"MIN";case "sum":return"SUM";case "stdev":case "stddev":return"STDDEV"}return"COUNT"}return function(w){function x(b){var c=w.call(this,b)||this;c._decodedStatsfield=[];c._decodedGroupbyfield=[];c._candosimplegroupby=!0;c.phsyicalgroupbyfields=[];c.objectIdField="ROW__ID";c._internalObjectIdField="ROW__ID";
c._adaptedFields=[];c.declaredClass="esri.arcade.featureset.actions.Aggregate";c._uniqueIds=1;c._maxQuery=10;c._maxProcessing=10;c._parent=b.parentfeatureset;c._config=b;return c}G._inheritsLoose(x,w);var k=x.prototype;k.isTable=function(){return!0};k._getSet=function(b){return null===this._wset?this._getFilteredSet("",null,null,null,b).then(c=>this._wset=c):n.resolve(this._wset)};k._isInFeatureSet=function(){return r.IdState.InFeatureSet};k.nextUniqueName=function(b){for(;1===b["T"+this._uniqueIds.toString()];)this._uniqueIds++;
const c="T"+this._uniqueIds.toString();b[c]=1;return c};k.convertToEsriFieldType=function(b){return b};k._initialiseFeatureSet=function(){const b={};var c=!1;let d=1;var a=this._parent?this._parent.getFieldsIndex():new K([]);this.objectIdField="ROW__ID";for(this.globalIdField="";!1===c;){let m=!1;for(var f=0;f<this._config.groupbyfields.length;f++)if(this._config.groupbyfields[f].name.toLowerCase()===this.objectIdField.toLowerCase()){m=!0;break}if(!1===m)for(f=0;f<this._config.statsfields.length;f++)if(this._config.statsfields[f].name.toLowerCase()===
this.objectIdField.toLowerCase()){m=!0;break}!1===m?c=!0:(this.objectIdField="ROW__ID"+d.toString(),d++)}for(var h of this._config.statsfields)c=new E,c.field=h.name,c.tofieldname=h.name,c.workingexpr=h.expression instanceof v.WhereClause?h.expression:v.WhereClause.create(h.expression,a),c.typeofstat=L(h.statistic),this._decodedStatsfield.push(c);this._decodedGroupbyfield=[];for(var e of this._config.groupbyfields)h={name:e.name,singlefield:null,tofieldname:e.name,expression:e.expression instanceof
v.WhereClause?e.expression:v.WhereClause.create(e.expression,a)},this._decodedGroupbyfield.push(h);if(null!==this._parent){this.geometryType=this._parent.geometryType;this.spatialReference=this._parent.spatialReference;this.hasM=this._parent.hasM;this.hasZ=this._parent.hasZ;this.typeIdField="";for(const m of this._parent.fields)b[m.name.toUpperCase()]=1;this.types=null}else this.geometryType=r.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null,this.spatialReference=new J({wkid:4326});
this.fields=[];a=new E;a.field=this.nextUniqueName(b);a.tofieldname=this.objectIdField;a.workingexpr=v.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex());a.typeofstat="MIN";this._decodedStatsfield.push(a);for(var l of this._decodedGroupbyfield){a=new z;l.name=this.nextUniqueName(b);a.name=l.tofieldname;a.alias=a.name;if(p.isSingleField(l.expression)){e=this._parent.getField(p.toWhereClause(l.expression,r.FeatureServiceDatabaseType.Standardised));if(!e)throw Error("Field is not present for Aggregation");
l.name=e.name;l.singlefield=e.name;this.phsyicalgroupbyfields.push(e.name);a.type=e.type}else a.type=this.convertToEsriFieldType(p.predictType(l.expression,this._parent.fields)),e=new z,e.name=l.name,e.alias=e.name,this.phsyicalgroupbyfields.push(l.name),this._adaptedFields.push(new y.SqlExpressionAdapted(e,l.expression)),this._candosimplegroupby=!1;this.fields.push(a)}if(0<this._adaptedFields.length)for(var g of this._parent.fields)this._adaptedFields.push(new y.OriginalField(g));for(l=0;l<this._decodedStatsfield.length;l++){g=
new z;a=null;a=this._decodedStatsfield[l];a.field=this.nextUniqueName(b);a.tofieldname===this.objectIdField&&(this._internalObjectIdField=a.field);g.name=a.tofieldname;g.alias=g.name;a=null!==a.workingexpr?p.isSingleField(a.workingexpr)?p.toWhereClause(a.workingexpr,r.FeatureServiceDatabaseType.Standardised):"":"";switch(this._decodedStatsfield[l].typeofstat){case "SUM":if(""!==a){a=this._parent.getField(a);if(!a)throw Error("Field is not present for Aggregation");g.type=a.type}else g.type="double";
break;case "MIN":case "MAX":if(""!==a){a=this._parent.getField(a);if(!a)throw Error("Field is not present for Aggregation");g.type=a.type}else g.type="double";break;case "COUNT":g.type="integer";break;case "STDDEV":case "VAR":case "AVG":if(""!==a&&(a=this._parent.getField(a),!a))throw Error("Field is not present for Aggregation");g.type="double"}this.fields.push(g)}};k._canDoAggregates=function(){return n.resolve(!1)};k._getFeatures=function(b,c,d,a){const f=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(b,
f)?this._expandPagedSet(b,f,0,0,a).then(()=>this._getFeatures(b,c,d,a)):n.resolve("success")};k._getFilteredSet=function(b,c,d,a,f){if(""!==b)return n.resolve(new u([],[],!0,null));let h=null;var e=!1,l=!1;return this._ensureLoaded().then(()=>{if(null!==d)for(var g=0;g<this._decodedStatsfield.length;g++)if(!0===p.scanForField(d,this._decodedStatsfield[g].tofieldname)){l=!0;d=null;break}if(null!==a){e=!0;for(g=0;g<this._decodedStatsfield.length;g++)if(!0===a.scanForField(this._decodedStatsfield[g].tofieldname)){a=
null;e=!1;break}if(null!==a)for(const m of this._decodedGroupbyfield)if(null===m.singlefield&&!0===a.scanForField(m.tofieldname)){a=null;e=!1;break}}return!1===this._candosimplegroupby?n.resolve(!1):this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)}).then(g=>{if(g){g=null;d&&(g=this._reformulateWhereClauseWithoutGroupByFields(d));var m=null;a&&(m=this._reformulateOrderClauseWithoutGroupByFields(a));return this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,
this._decodedStatsfield,"",null,g,m,this._internalObjectIdField).then(q=>{this._checkCancelled(f);return h=!0===l?new u(q._candidates.slice(0).concat(q._known.slice(0)),[],!0===e?q._ordered:!1,this._clonePageDefinition(q.pagesDefinition)):new u(q._candidates.slice(0),q._known.slice(0),!0===e?q._ordered:!1,this._clonePageDefinition(q.pagesDefinition))})}g=this._parent;0<this._adaptedFields.length&&(g=new y.AdaptedFeatureSet({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null}));
!0===l?h=new u(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new B({parentfeatureset:g,orderbyclause:new D(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}}):(null!==d&&(m=null,d&&(m=this._reformulateWhereClauseWithoutGroupByFields(d)),g=new I({parentfeatureset:g,whereclause:m})),h=new u(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,
resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new B({parentfeatureset:g,orderbyclause:new D(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}}));return h})};k._reformulateWhereClauseWithoutStatsFields=function(b){for(const c of this._decodedStatsfield)b=p.reformulateWithoutField(b,c.tofieldname,p.toWhereClause(c.workingexpr,r.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex());
return b};k._reformulateWhereClauseWithoutGroupByFields=function(b){for(const c of this._decodedGroupbyfield)c.tofieldname!==c.name&&(b=p.reformulateWithoutField(b,c.tofieldname,p.toWhereClause(c.expression,r.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()));return b};k._reformulateOrderClauseWithoutGroupByFields=function(b){const c=[];for(const d of this._decodedGroupbyfield)d.tofieldname!==d.name&&c.push({field:d.tofieldname,newfield:d.name});return 0<c.length?b.replaceFields(c):
b};k._clonePageDefinition=function(b){return null===b?null:!0===b.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:b.resultRecordCount,resultOffset:b.resultOffset,internal:b.internal}:this._parent._clonePageDefinition(b)};k._refineSetBlock=function(b,c,d){try{if(!0===this._checkIfNeedToExpandCandidatePage(b,this._maxQuery))return this._expandPagedSet(b,this._maxQuery,0,0,d).then(()=>this._refineSetBlock(b,c,d));this._checkCancelled(d);this._refineKnowns(b,
c);return n.resolve(b)}catch(a){return n.reject(a)}};k._expandPagedSet=function(b,c,d,a,f){return this._expandPagedSetFeatureSet(b,c,d,a,f)};k._getPhysicalPage=function(b,c,d){return!0===b.pagesDefinition.aggregatefeaturesetpagedefinition?n.create((a,f)=>{this._sequentialGetPhysicalItem(b,b.pagesDefinition.resultRecordCount,d,[]).then(h=>{a(h)},f)}):this._getAgregagtePhysicalPage(b,c,d).then(a=>{for(const f of a){const h={geometry:f.geometry,attributes:{}};for(const e of this._decodedGroupbyfield)h.attributes[e.tofieldname]=
f.attributes[e.name];for(const e of this._decodedStatsfield)h.attributes[e.tofieldname]=f.attributes[e.field];this._featureCache[h.attributes[this.objectIdField]]=new A(h)}return a.length})};k._sequentialGetPhysicalItem=function(b,c,d,a){return n.create((f,h)=>{null===b.pagesDefinition.internal.iterator&&(b.pagesDefinition.internal.iterator=b.pagesDefinition.internal.subfeatureset.iterator(d));!0===b.pagesDefinition.internal.fullyResolved?f(a.length):0===c?f(a.length):this._nextAggregateItem(b,c,
d,a,e=>{null===e?f(a.length):(--c,f(this._sequentialGetPhysicalItem(b,c,d,a)))},h)})};k._nextAggregateItem=function(b,c,d,a,f,h){try{H.tick(b.pagesDefinition.internal.iterator.next()).then(e=>{if(null===e)null!==b.pagesDefinition.internal.workingItem&&(e=this._calculateAndAppendAggregateItem(b.pagesDefinition.internal.workingItem),a.push(e),b.pagesDefinition.internal.workingItem=null,b.pagesDefinition.internal.set.push(e.attributes[this.objectIdField])),b.pagesDefinition.internal.fullyResolved=!0,
f(null);else{const l=this._generateAggregateHash(e);if(null===b.pagesDefinition.internal.workingItem)b.pagesDefinition.internal.workingItem={features:[e],id:l};else{if(l!==b.pagesDefinition.internal.workingItem.id){const g=this._calculateAndAppendAggregateItem(b.pagesDefinition.internal.workingItem);a.push(g);b.pagesDefinition.internal.workingItem=null;b.pagesDefinition.internal.set.push(g.attributes[this.objectIdField]);--c;b.pagesDefinition.internal.workingItem={features:[e],id:l};f(g);return}b.pagesDefinition.internal.workingItem.features.push(e)}this._nextAggregateItem(b,
c,d,a,f,h)}},h)}catch(e){h(e)}};k._calculateFieldStat=function(b,c,d){const a=[];for(let f=0;f<b.features.length;f++)if(null!==c.workingexpr){const h=c.workingexpr.calculateValue(b.features[f]);null!==h&&a.push(h)}else a.push(null);switch(c.typeofstat){case "MIN":d.attributes[c.tofieldname]=t.calculateStat("min",a,-1);break;case "MAX":d.attributes[c.tofieldname]=t.calculateStat("max",a,-1);break;case "SUM":d.attributes[c.tofieldname]=t.calculateStat("sum",a,-1);break;case "COUNT":d.attributes[c.tofieldname]=
a.length;break;case "VAR":d.attributes[c.tofieldname]=t.calculateStat("var",a,-1);break;case "STDDEV":d.attributes[c.tofieldname]=t.calculateStat("stddev",a,-1);break;case "AVG":d.attributes[c.tofieldname]=t.calculateStat("avg",a,-1)}return!0};k._calculateAndAppendAggregateItem=function(b){const c={attributes:{},geometry:null};for(var d of this._decodedGroupbyfield){var a=d.singlefield?b.features[0].attributes[d.singlefield]:d.expression.calculateValue(b.features[0]);c.attributes[d.tofieldname]=a}for(const f of this._decodedStatsfield)this._calculateFieldStat(b,
f,c);d=[];for(a=0;a<this._decodedStatsfield.length;a++)d.push(this._calculateFieldStat(b,this._decodedStatsfield[a],c));this._featureCache[c.attributes[this.objectIdField]]=new A({attributes:c.attributes,geometry:c.geometry});return c};k._generateAggregateHash=function(b){let c="";for(const d of this._decodedGroupbyfield){const a=d.singlefield?b.attributes[d.singlefield]:d.expression.calculateValue(b);c=null===a||void 0===a?c+":":c+(":"+a.toString())}return F.createMD5Hash(c,F.outputTypes.String)};
k._stat=function(){return n.resolve({calculated:!1})};k.getFeatureByObjectId=function(){return n.resolve(null)};x.registerAction=function(){C._featuresetFunctions.groupby=function(b,c){return new x({parentfeatureset:this,groupbyfields:b,statsfields:c})}};return x}(C)});