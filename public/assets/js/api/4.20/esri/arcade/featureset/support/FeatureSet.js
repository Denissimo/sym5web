// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ./FeatureSetIterator ./IdSet ./shared ./cache ./stats ../../../core/promiseUtils ../../../core/sql/WhereClause ../../../geometry/geometryEngineAsync ../../../geometry/SpatialReference ../../../layers/support/FieldsIndex".split(" "),function(x,y,v,n,t,q,k,r,u,z,A){let w=function(){function l(a){this.featureSetQueryInterceptor=this.recentlyUsedQueries=null;this._idstates=[];this._mainSetInUse=this._wset=this._parent=null;this._maxProcessing=200;this._maxQuery=
500;this._totalCount=-1;this._databaseType=n.FeatureServiceDatabaseType.NotEvaluated;this._databaseTypeProbed=null;this.declaredRootClass="esri.arcade.featureset.support.FeatureSet";this._featureCache=[];this.fields=this.types=null;this.globalIdField=this.objectIdField=this.geometryType="";this.spatialReference=null;this.loaded=this._transparent=this.hasZ=this.hasM=!1;this._fieldsIndex=this._loadPromise=null;a&&a.lrucache&&(this.recentlyUsedQueries=a.lrucache);a&&a.interceptor&&(this.featureSetQueryInterceptor=
a.interceptor)}var f=l.prototype;f.optimisePagingFeatureQueries=function(a){this._parent&&this._parent.optimisePagingFeatureQueries(a)};f._hasMemorySource=function(){return!0};f.prop=function(a,b){if(void 0===b)return this[a];void 0!==this[a]&&(this[a]=b);return this};f.end=function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent};f._ensureLoaded=function(){return this.load()};f.load=function(){null===this._loadPromise&&(this._loadPromise=k.create((a,b)=>
{!0===this._parent.loaded?(this._initialiseFeatureSet(),a(this)):this._parent.load().then(()=>{try{this._initialiseFeatureSet(),a(this)}catch(d){b(d)}},b)}));return this._loadPromise};f._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=
this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.globalIdField=this.objectIdField=this.typeIdField="",this.spatialReference=new z({wkid:4326}),this.geometryType=n.layerGeometryEsriConstants.point)};f.getField=function(a,b){let d;if(b=b||this.fields)a=a.toLowerCase(),b.some(c=>{c&&c.name.toLowerCase()===a&&(d=c);return!!d});return d};f.getFieldsIndex=function(){null===this._fieldsIndex&&(this._fieldsIndex=new A(this.fields));return this._fieldsIndex};
f._maxProcessingRate=function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())};f._maxQueryRate=function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery};f._checkCancelled=function(a){if(null!==a&&a.aborted)throw Error("Operation has been cancelled.");};f.nativeCapabilities=function(){return this._parent.nativeCapabilities()};f._canDoAggregates=function(a,
b,d,c,e){return null===this._parent?k.resolve(!1):this._parent._canDoAggregates(a,b,d,c,e)};f._getAggregatePagesDataSourceDefinition=function(a,b,d,c,e,g,h){return null===this._parent?k.reject(Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(a,b,d,c,e,g,h)};f._getAgregagtePhysicalPage=function(a,b,d){return null===this._parent?k.reject(Error("Should never be called")):this._parent._getAgregagtePhysicalPage(a,b,d)};f.databaseType=function(){if(this._databaseType===
n.FeatureServiceDatabaseType.NotEvaluated){if(null!==t.applicationCache){var a=t.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==a)return a}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;const b=[{thetype:n.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) \x3d CAST( '2015-01-01' as DATETIME)) AND OBJECTID\x3c0"},{thetype:n.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') \x3d TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID\x3c0"},
{thetype:n.FeatureServiceDatabaseType.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' \x3d date '2015-01-01 10:10:10') AND OBJECTID\x3c0"}];a=k.create((d,c)=>{this._getDatabaseTypeImpl(b,0).then(e=>{this._databaseType=e;d(this._databaseType)},e=>{c(e)})});null!==t.applicationCache&&(t.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),a),a=a.catch(d=>{t.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey());throw d;}));return this._databaseTypeProbed=
a}return k.resolve(this._databaseType)};f._cacheableFeatureSetSourceKey=function(){return"MUSTBESET"};f._getDatabaseTypeImpl=function(a,b){return b>=a.length?k.resolve(n.FeatureServiceDatabaseType.StandardisedNoInterval):this._runDatabaseProbe(a[b].testwhere).then(d=>!0===d?a[b].thetype:this._getDatabaseTypeImpl(a,b+1))};f._runDatabaseProbe=function(a){return null!==this._parent?this._parent._runDatabaseProbe(a):k.reject(Error("Not Implemented"))};f.isTable=function(){return this._parent.isTable()};
f._featureFromCache=function(a){if(void 0!==this._featureCache[a])return this._featureCache[a]};f._isInFeatureSet=function(a){return n.IdState.Unknown};f._getSet=function(a){throw Error("Not implemented in abstract class");};f._getFeature=function(a,b,d){try{return this._checkCancelled(d),void 0!==this._featureFromCache(b)?k.resolve(this._featureFromCache(b)):this._getFeatures(a,b,this._maxProcessingRate(),d).then(()=>{this._checkCancelled(d);return void 0!==this._featureFromCache(b)?this._featureFromCache(b):
k.reject(Error("Feature Not Found"))})}catch(c){return k.reject(c)}};f._getFeatureBatch=function(a,b){try{this._checkCancelled(b);const d=new v([],a,!1,null),c=[];return this._getFeatures(d,-1,a.length,b).then(()=>{this._checkCancelled(b);for(const e of a)void 0!==this._featureFromCache(e)&&c.push(this._featureFromCache(e));return c})}catch(d){return k.reject(d)}};f._getFeatures=function(a,b,d,c){return k.resolve("success")};f._getFilteredSet=function(a,b,d,c,e){throw Error("Not implemented in abstract class");
};f._refineSetBlock=function(a,b,d){try{if(!0===this._checkIfNeedToExpandCandidatePage(a,this._maxQueryRate()))return this._expandPagedSet(a,this._maxQueryRate(),0,0,d).then(()=>this._refineSetBlock(a,b,d));this._checkCancelled(d);const c=a._candidates.length;this._refineKnowns(a,b);let e=c-a._candidates.length;return 0===a._candidates.length||e>=b?k.resolve(a):this._refineIfParentKnown(a,b-e,d).then(()=>{this._checkCancelled(d);this._refineKnowns(a,b-e);e=c-a._candidates.length;if(e<b&&0<a._candidates.length){const g=
b-e,h=this._prepareFetchAndRefineSet(a._candidates);return this._fetchAndRefineFeatures(h,h.length>g?g:a._candidates.length,d).then(()=>{this._checkCancelled(d);this._refineKnowns(a,b-e);return a})}return a})}catch(c){return k.reject(c)}};f._fetchAndRefineFeatures=function(a,b,d){return null};f._prepareFetchAndRefineSet=function(a){const b=[];for(let d=0;d<a.length;d++)this._isPhysicalFeature(a[d])&&b.push(a[d]);return b};f._isPhysicalFeature=function(a){return null===this._parent?!0:this._parent._isPhysicalFeature(a)};
f._refineKnowns=function(a,b){let d=0,c=null;const e=[];b=this._maxQueryRate();for(let g=0;g<a._candidates.length&&"GETPAGES"!==a._candidates[g];g++){let h=!1;const m=this._candidateIdTransform(a._candidates[g]);m!==a._candidates[g]&&(h=!0);const p=this._isInFeatureSet(m);if(p===n.IdState.InFeatureSet)!0===h?0>a._known.indexOf(m)&&(a._known.push(m),d+=1):(a._known.push(a._candidates[g]),d+=1),null===c?c={start:g,end:g}:c.end===g-1?c.end=g:(e.push(c),c={start:g,end:g});else if(p===n.IdState.NotInFeatureSet)null===
c?c={start:g,end:g}:c.end===g-1?c.end=g:(e.push(c),c={start:g,end:g}),d+=1;else if(p===n.IdState.Unknown&&(d+=1,!0===a._ordered))break;if(d>=b)break}null!==c&&e.push(c);for(b=e.length-1;0<=b;b--)a._candidates.splice(e[b].start,e[b].end-e[b].start+1)};f._refineIfParentKnown=function(a,b,d){const c=new v([],[],a._ordered,null);c._candidates=a._candidates.slice(0);return this._parent._refineSetBlock(c,b,d)};f._candidateIdTransform=function(a){return this._parent._candidateIdTransform(a)};f._checkIfNeedToExpandKnownPage=
function(a,b){if(null===a.pagesDefinition)return!1;let d=0;for(let c=a._lastFetchedIndex;c<a._known.length;c++){if("GETPAGES"===a._known[c])return!0;if(void 0===this._featureCache[a._known[c]]&&(d+=1,d>=b))break}return!1};f._checkIfNeedToExpandCandidatePage=function(a,b){if(null===a.pagesDefinition)return!1;let d=0;for(let c=0;c<a._candidates.length;c++){if("GETPAGES"===a._candidates[c])return!0;d+=1;if(d>=b)break}return!1};f._expandPagedSet=function(a,b,d,c,e){return null===this._parent?k.reject(Error("Parent Paging not implemented")):
this._parent._expandPagedSet(a,b,d,c,e)};f._expandPagedSetFeatureSet=function(a,b,d,c,e){0<a._known.length&&"GETPAGES"===a._known[a._known.length-1]&&(c=1);0===c&&0<a._candidates.length&&"GETPAGES"===a._candidates[a._candidates.length-1]&&(c=2);return 0===c?k.resolve("finished"):this._getPage(a,c,e).then(g=>d+g<b?this._expandPagedSet(a,b,d+g,0,e):"success")};f._getPage=function(a,b,d){const c=1===b?a._known:a._candidates;if(a.pagesDefinition.internal.set.length>a.pagesDefinition.resultOffset||!0===
a.pagesDefinition.internal.fullyResolved){--c.length;let g=0;for(var e=0;e<a.pagesDefinition.resultRecordCount&&!(a.pagesDefinition.resultOffset+e>=a.pagesDefinition.internal.set.length);e++)c[c.length]=a.pagesDefinition.internal.set[a.pagesDefinition.resultOffset+e],g++;a.pagesDefinition.resultOffset+=g;e=!1;!0===a.pagesDefinition.internal.fullyResolved&&a.pagesDefinition.internal.set.length<=a.pagesDefinition.resultOffset&&(e=!0);!1===e&&c.push("GETPAGES");return k.resolve(g)}return this._getPhysicalPage(a,
b,d).then(()=>this._getPage(a,b,d))};f._getPhysicalPage=function(a,b,d){return null};f._clonePageDefinition=function(a){return null===this._parent?null:this._parent._clonePageDefinition(a)};f._first=function(a){return this.iterator(a).next()};f.first=function(a){return this._first(a)};f.calculateStatistic=function(a,b,d,c){return this._ensureLoaded().then(()=>this._stat(a,b,"",null,null,d,c).then(e=>!1===e.calculated?this._manualStat(a,b,d,c).then(g=>g.result):e.result))};f._manualStat=function(a,
b,d,c){switch(a.toLowerCase()){case "count":return q.count(this,c).then(e=>({calculated:!0,result:e}));case "distinct":return q.distinct(this,b,d).then(e=>({calculated:!0,result:e}));case "avg":case "mean":return q.mean(this,b,c).then(e=>({calculated:!0,result:e}));case "stdev":return q.stdev(this,b,c).then(e=>({calculated:!0,result:e}));case "variance":return q.variance(this,b,c).then(e=>({calculated:!0,result:e}));case "sum":return q.sum(this,b,c).then(e=>({calculated:!0,result:e}));case "min":return q.min(this,
b,c).then(e=>({calculated:!0,result:e}));case "max":return q.max(this,b,c).then(e=>({calculated:!0,result:e}));default:return k.resolve({calculated:!0,result:0})}};f._stat=function(a,b,d,c,e,g,h){return this._parent._stat(a,b,d,c,e,g,h).then(m=>!1===m.calculated?null===e&&""===d&&null===c?this._manualStat(a,b,g,h):{calculated:!1}:m)};f._unionAllGeomSelf=function(a){const b=this.iterator(this._defaultTracker(a)),d=[];return k.create((c,e)=>{this._unionShapeInBatches(d,b,c,e)})};f._unionAllGeom=function(a){return k.create((b,
d)=>{const c=this.iterator(this._defaultTracker(a));this._unionShapeInBatches([],c,b,d)})};f._unionShapeInBatches=function(a,b,d,c){b.next().then(e=>{try{null!==e&&null!==e.geometry&&a.push(e.geometry),30<a.length||null===e&&1<a.length?u.union(a).then(g=>{try{null===e?d(g):(a=[g],this._unionShapeInBatches(a,b,d,c))}catch(h){c(h)}},c):null===e?1===a.length?d(a[0]):d(null):this._unionShapeInBatches(a,b,d,c)}catch(g){c(g)}},c)};f.iterator=function(a){return new y(this,a)};f.intersection=function(a,b=
!1){return l._featuresetFunctions.intersection.bind(this)(a,b)};f.difference=function(a,b=!1,d=!0){return l._featuresetFunctions.difference.bind(this)(a,b,d)};f.symmetricDifference=function(a,b=!1,d=!0){return l._featuresetFunctions.symmetricDifference.bind(this)(a,b,d)};f.morphShape=function(a,b,d="unknown",c=null){return l._featuresetFunctions.morphShape.bind(this)(a,b,d,c)};f.morphShapeAndAttributes=function(a,b,d="unknown"){return l._featuresetFunctions.morphShapeAndAttributes.bind(this)(a,b,
d)};f.union=function(a,b=!1){return l._featuresetFunctions.union.bind(this)(a,b)};f.intersects=function(a){return l._featuresetFunctions.intersects.bind(this)(a)};f.envelopeIntersects=function(a){return l._featuresetFunctions.envelopeIntersects.bind(this)(a)};f.contains=function(a){return l._featuresetFunctions.contains.bind(this)(a)};f.overlaps=function(a){return l._featuresetFunctions.overlaps.bind(this)(a)};f.relate=function(a,b){return l._featuresetFunctions.relate.bind(this)(a,b)};f.within=function(a){return l._featuresetFunctions.within.bind(this)(a)};
f.touches=function(a){return l._featuresetFunctions.touches.bind(this)(a)};f.top=function(a){return l._featuresetFunctions.top.bind(this)(a)};f.crosses=function(a){return l._featuresetFunctions.crosses.bind(this)(a)};f.buffer=function(a,b,d,c=!0){return l._featuresetFunctions.buffer.bind(this)(a,b,d,c)};f.filter=function(a,b=null){return l._featuresetFunctions.filter.bind(this)(a,b)};f.orderBy=function(a){return l._featuresetFunctions.orderBy.bind(this)(a)};f.dissolve=function(a,b){return l._featuresetFunctions.dissolve.bind(this)(a,
b)};f.groupby=function(a,b){return l._featuresetFunctions.groupby.bind(this)(a,b)};f.reduce=function(a,b=null,d){return k.create((c,e)=>{this._reduceImpl(this.iterator(this._defaultTracker(d)),a,b,0,c,e,0)})};f._reduceImpl=function(a,b,d,c,e,g,h){try{h++,1E3<h?setTimeout(()=>{h=0;this._reduceImpl(a,b,d,c,e,g,h)}):a.next().then(m=>{try{if(null===m)e(d);else{const p=b(d,m,c,this);k.isPromiseLike(p)?p.then(B=>{this._reduceImpl(a,b,B,c+1,e,g,h)},g):this._reduceImpl(a,b,p,c+1,e,g,h)}}catch(p){g(p)}},g)}catch(m){g(m)}};
f.removeField=function(a){return l._featuresetFunctions.removeField.bind(this)(a)};f.addField=function(a,b,d=null){return l._featuresetFunctions.addField.bind(this)(a,b,d)};f.sumArea=function(a,b=!1,d){const c=n.convertSquareUnitsToCode(a);return this.reduce((e,g)=>null===g.geometry?0:b?u.geodesicArea(g.geometry,c).then(h=>e+h):u.planarArea(g.geometry,c).then(h=>e+h),0,d)};f.sumLength=function(a,b=!1,d){const c=n.convertLinearUnitsToCode(a);return this.reduce((e,g)=>null===g.geometry?0:b?u.geodesicLength(g.geometry,
c).then(h=>e+h):u.planarLength(g.geometry,c).then(h=>e+h),0,d)};f._substituteVars=function(a,b){if(null!==b){const d={};for(const c in b)d[c.toLowerCase()]=b[c];a.parameters=d}};f.distinct=function(a,b=1E3,d=null,c){return this.load().then(()=>{const e=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(e,d);return this.calculateStatistic("distinct",e,b,this._defaultTracker(c))})};f.min=function(a,b=null,d){return this.load().then(()=>{const c=r.WhereClause.create(a,this.getFieldsIndex());
this._substituteVars(c,b);return this.calculateStatistic("min",c,-1,this._defaultTracker(d))})};f.max=function(a,b=null,d){return this.load().then(()=>{const c=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(c,b);return this.calculateStatistic("max",c,-1,this._defaultTracker(d))})};f.avg=function(a,b=null,d){return this.load().then(()=>{const c=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(c,b);return this.calculateStatistic("avg",c,-1,this._defaultTracker(d))})};
f.sum=function(a,b=null,d){return this.load().then(()=>{const c=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(c,b);return this.calculateStatistic("sum",c,-1,this._defaultTracker(d))})};f.stdev=function(a,b=null,d){return this.load().then(()=>{const c=r.WhereClause.create(a,this.getFieldsIndex());this._substituteVars(c,b);return this.calculateStatistic("stdev",c,-1,this._defaultTracker(d))})};f.variance=function(a,b=null,d){return this.load().then(()=>{const c=r.WhereClause.create(a,
this.getFieldsIndex());this._substituteVars(c,b);return this.calculateStatistic("variance",c,-1,this._defaultTracker(d))})};f.count=function(a){return this.load().then(()=>this.calculateStatistic("count",r.WhereClause.create("1",this.getFieldsIndex()),-1,this._defaultTracker(a)))};f._defaultTracker=function(a){return a?a:{aborted:!1}};f.forEach=function(a,b){return k.create((d,c)=>{this._forEachImpl(this.iterator(this._defaultTracker(b)),a,this,d,c,0)})};f._forEachImpl=function(a,b,d,c,e,g){try{g++,
1E3<g?setTimeout(()=>{g=0;this._forEachImpl(a,b,d,c,e,g)},0):a.next().then(h=>{try{if(null===h)c(d);else{const m=b(h);void 0===m||null===m?this._forEachImpl(a,b,d,c,e,g):k.isPromiseLike(m)?m.then(()=>{try{this._forEachImpl(a,b,d,c,e,g)}catch(p){e(p)}},e):this._forEachImpl(a,b,d,c,e,g)}}catch(m){e(m)}},e)}catch(h){e(h)}};f.convertToJSON=function(a){const b={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let d=0;d<this.fields.length;d++)b.layerDefinition.fields.push(n.esriFieldToJson(this.fields[d]));
return this.reduce((d,c)=>{d={geometry:c.geometry&&c.geometry.toJSON(),attributes:{}};for(const e in c.attributes)d.attributes[e]=c.attributes[e];b.featureSet.features.push(d);return 1},0,a).then(()=>b)};f.castToText=function(){return"object, FeatureSet"};f.queryAttachments=function(a,b,d,c){return this._parent.queryAttachments(a,b,d,c)};f.serviceUrl=function(){return this._parent.serviceUrl()};f.subtypes=function(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map(a=>
({name:a.name,code:a.id})):[]}:null};f.relationshipMetaData=function(){return this._parent.relationshipMetaData()};f.schema=function(){const a=[];for(const b of this.fields)a.push(n.esriFieldToJson(b));return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===n.layerGeometryEsriRestConstants[this.geometryType]?"":n.layerGeometryEsriRestConstants[this.geometryType],fields:a}};f.convertToText=function(a,b){return"schema"===a?this._ensureLoaded().then(()=>JSON.stringify(this.schema())):
"featureset"===a?this._ensureLoaded().then(()=>{const d=[];return this.reduce((c,e)=>{c={geometry:e.geometry?e.geometry.toJSON():null,attributes:e.attributes};null!==c.geometry&&c.geometry.spatialReference&&delete c.geometry.spatialReference;d.push(c);return 1},0,b).then(()=>{const c=this.schema();c.features=d;c.spatialReference=this.spatialReference.toJSON();return JSON.stringify(c)})}):k.resolve(this.castToText())};f.getFeatureByObjectId=function(a,b){return this._parent.getFeatureByObjectId(a,
b)};f.getOwningSystemUrl=function(){return this._parent.getOwningSystemUrl()};f.getIdentityUser=function(){return this._parent.getIdentityUser()};x._createClass(l,[{key:"gdbVersion",get:function(){return this._parent?this._parent.gdbVersion:""}}]);return l}();w._featuresetFunctions={};return w});