// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/promiseUtils ../../../core/sql/WhereClause ../../../geometry/SpatialReference".split(" "),function(w,t,q,l,r,k,u,x){return function(v){function n(b){var a=v.call(this,b)||this;a.declaredClass="esri.arcade.featureset.actions.AttributeFilter";a._maxProcessing=1E3;a._parent=b.parentfeatureset;b.whereclause instanceof u.WhereClause?(a._whereclause=b.whereclause,
a._whereClauseFunction=null):(a._whereClauseFunction=b.whereclause,a._whereclause=null);return a}w._inheritsLoose(n,v);var f=n.prototype;f._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,
this.types=this._parent.types):(this.fields=[],this.globalIdField=this.objectIdField=this.typeIdField="",this.spatialReference=new x({wkid:4326}),this.geometryType=l.layerGeometryEsriConstants.point)};f._getSet=function(b){return null===this._wset?this._ensureLoaded().then(()=>this._parent._getFilteredSet("",null,this._whereclause,null,b)).then(a=>{this._checkCancelled(b);return this._wset=null!==this._whereClauseFunction?new q(a._candidates.slice(0).concat(a._known.slice(0)),[],a._ordered,this._clonePageDefinition(a.pagesDefinition)):
new q(a._candidates.slice(0),a._known.slice(0),a._ordered,this._clonePageDefinition(a.pagesDefinition))}):k.resolve(this._wset)};f._isInFeatureSet=function(b){let a=this._parent._isInFeatureSet(b);if(a===l.IdState.NotInFeatureSet)return a;a=this._idstates[b];return void 0===a?l.IdState.Unknown:a};f._getFeature=function(b,a,e){return this._parent._getFeature(b,a,e)};f._getFeatures=function(b,a,e,g){return this._parent._getFeatures(b,a,e,g)};f._featureFromCache=function(b){return this._parent._featureFromCache(b)};
f.executeWhereClause=function(b){return this._whereclause.testFeature(b)};f.executeWhereClauseDeferred=function(b){if(null!==this._whereClauseFunction)try{const a=this._whereClauseFunction(b);return k.isPromiseLike(a)?a:k.resolve(a)}catch(a){return k.reject(a)}return k.resolve(this.executeWhereClause(b))};f._fetchAndRefineFeatures=function(b,a,e){const g=new q([],b,!1,null),c=Math.min(a,b.length);return this._parent._getFeatures(g,-1,c,e).then(()=>{this._checkCancelled(e);if(null==this._whereClauseFunction){for(var d=
0;d<c;d++){var h=this._parent._featureFromCache(b[d]);!0===this.executeWhereClause(h)?this._idstates[b[d]]=l.IdState.InFeatureSet:this._idstates[b[d]]=l.IdState.NotInFeatureSet}return"success"}d=[];for(h=0;h<c;h++){const p=this._parent._featureFromCache(b[h]);d.push(this.executeWhereClauseDeferred(p))}return k.all(d).then(p=>{for(let m=0;m<a;m++)this._idstates[b[m]]=!0===p[m]?l.IdState.InFeatureSet:l.IdState.NotInFeatureSet;return"success"})})};f._getFilteredSet=function(b,a,e,g,c){null===this._whereClauseFunction&&
(null!==e?null!==this._whereclause&&(e=r.combine(this._whereclause,e)):e=this._whereclause);return this._ensureLoaded().then(()=>this._parent._getFilteredSet(b,a,e,g,c)).then(d=>{this._checkCancelled(c);return null!==this._whereClauseFunction?new q(d._candidates.slice(0).concat(d._known.slice(0)),[],d._ordered,this._clonePageDefinition(d.pagesDefinition)):new q(d._candidates.slice(0),d._known.slice(0),d._ordered,this._clonePageDefinition(d.pagesDefinition))})};f._stat=function(b,a,e,g,c,d,h){if(null!==
this._whereClauseFunction)return null===c&&""===e&&null===g?this._manualStat(b,a,d,h):k.resolve({calculated:!1});let p=this._whereclause;null!==c&&null!==this._whereclause&&(p=r.combine(this._whereclause,c));return this._parent._stat(b,a,e,g,p,d,h).then(m=>!1===m.calculated?null===c&&""===e&&null===g?this._manualStat(b,a,d,h):{calculated:!1}:m)};f._canDoAggregates=function(b,a,e,g,c){if(null!==this._whereClauseFunction)return k.resolve(!1);null!==c?null!==this._whereclause&&(c=r.combine(this._whereclause,
c)):c=this._whereclause;return null===this._parent?k.resolve(!1):this._parent._canDoAggregates(b,a,e,g,c)};f._getAggregatePagesDataSourceDefinition=function(b,a,e,g,c,d,h){if(null===this._parent)return k.reject(Error("Should never be called"));null!==c?null!==this._whereclause&&(c=r.combine(this._whereclause,c)):c=this._whereclause;return this._parent._getAggregatePagesDataSourceDefinition(b,a,e,g,c,d,h)};n.registerAction=function(){t._featuresetFunctions.filter=function(b){if("function"===typeof b)return new n({parentfeatureset:this,
whereclause:b});let a=null;b instanceof u.WhereClause&&(a=b);return new n({parentfeatureset:this,whereclause:a})}};return n}(t)});