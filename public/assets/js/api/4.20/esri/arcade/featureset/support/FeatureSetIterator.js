// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define(["../../../core/promiseUtils"],function(k){return function(){function n(a,b){this._lastId=-1;this._progress=b;this._parent=a}var m=n.prototype;m.reset=function(){this._lastId=-1};m.nextBatch=function(a){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(d=>this.nextBatch(a),d=>this.nextBatch(a));var b=null,c=!1;const h=[];b=k.create((d,e)=>{this._parent._getSet(this._progress).then(f=>{var l=f._known.length-1;"GETPAGES"===f._known[f._known.length-1]&&--l;if(this._lastId+
a>l&&0<f._known.length&&"GETPAGES"===f._known[f._known.length-1])this._parent._expandPagedSet(f,this._parent._maxQueryRate(),0,0,this._progress).then(g=>{c=!0;this._parent._mainSetInUse=null;this.nextBatch(a).then(d,e)},g=>{c=!0;this._parent._mainSetInUse=null;e(g)});else if(l>=this._lastId+a||0===f._candidates.length){for(l=0;l<a;l++){const g=l+this._lastId+1;if(g>=f._known.length)break;h[l]=f._known[g]}this._lastId+=h.length;0===h.length&&(c=!0,this._parent._mainSetInUse=null,d([]));this._parent._getFeatureBatch(h,
this._progress).then(g=>{c=!0;this._parent._mainSetInUse=null;d(g)},g=>{c=!0;this._parent._mainSetInUse=null;e(g)})}else this._parent._refineSetBlock(f,this._parent._maxProcessingRate(),this._progress).then(()=>{c=!0;this._parent._mainSetInUse=null;this.nextBatch(a).then(d,e)},g=>{c=!0;this._parent._mainSetInUse=null;e(g)})},f=>{c=!0;this._parent._mainSetInUse=null;e(f)})});!1===c&&(this._parent._mainSetInUse=b,c=!0);return b};m.next=function(){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(c=>
this.next(),c=>this.next());var a=null,b=!1;a=k.create((c,h)=>{this._parent._getSet(this._progress).then(d=>{this._lastId<d._known.length-1?"GETPAGES"===d._known[this._lastId+1]?this._parent._expandPagedSet(d,this._parent._maxQueryRate(),0,0,this._progress).then(e=>{b=!0;this._parent._mainSetInUse=null;return this.next()}).then(c,h):(this._lastId+=1,this._parent._getFeature(d,d._known[this._lastId],this._progress).then(e=>{b=!0;this._parent._mainSetInUse=null;c(e)},e=>{b=!0;this._parent._mainSetInUse=
null;h(e)})):0<d._candidates.length?this._parent._refineSetBlock(d,this._parent._maxProcessingRate(),this._progress).then(()=>{b=!0;this._parent._mainSetInUse=null;this.next().then(c,h)},e=>{b=!0;this._parent._mainSetInUse=null;h(e)}):(b=!0,this._parent._mainSetInUse=null,c(null))},d=>{b=!0;this._parent._mainSetInUse=null;h(d)})});!1===b&&(this._parent._mainSetInUse=a,b=!0);return a};m.count=function(){return-1!==this._parent._totalCount?k.resolve(this._parent._totalCount):this._parent._getSet(this._progress).then(a=>
this._refineAllSets(a)).then(a=>{this._parent._totalCount=a._known.length;return k.resolve(this._parent._totalCount)})};m._refineAllSets=function(a){return 0<a._known.length&&"GETPAGES"===a._known[a._known.length-1]?this._parent._expandPagedSet(a,this._parent._maxQueryRate(),0,1,this._progress).then(b=>this._refineAllSets(a)).then(b=>k.resolve(b)):0<a._candidates.length?"GETPAGES"===a._known[a._candidates.length-1]?this._parent._expandPagedSet(a,this._parent._maxQueryRate(),0,2,this._progress).then(b=>
this._refineAllSets(a)).then(b=>k.resolve(b)):this._parent._refineSetBlock(a,this._parent._maxProcessingRate(),this._progress).then(b=>0<b._candidates.length?this._refineAllSets(b):k.resolve(b)):k.resolve(a)};return n}()});