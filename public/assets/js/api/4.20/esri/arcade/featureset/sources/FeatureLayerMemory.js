// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/promiseUtils ../../../geometry/Geometry ../../../layers/FeatureLayer ../../../layers/support/FeatureType ../../../layers/support/Field ../../../rest/support/Query".split(" "),function(w,z,A,r,t,B,h,C,D,E,x,v){return function(y){function p(a){var b=y.call(this,a)||this;b.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory";b._removeGeometry=
!1;b._overrideFields=null;b._forceIsTable=!1;a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;!0===a.isTable&&(b._forceIsTable=!0);void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}w._inheritsLoose(p,y);var e=p.prototype;e._maxQueryRate=function(){return t.defaultMaxRecords};e.end=function(){return this._layer};e.optimisePagingFeatureQueries=
function(){};e.load=function(){null===this._loadPromise&&(this._loadPromise=h.create((a,b)=>{!0===this._layer.loaded?(this._initialiseFeatureSet(),a(this)):(this._layer.when().then(()=>{try{this._initialiseFeatureSet(),a(this)}catch(c){b(c)}},b),this._layer.load())}));return this._loadPromise};e._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(this._layer.outFields&&
(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){var a=[];for(var b of this.fields)if("oid"===b.type)a.push(b);else for(const c of this._layer.outFields)if(c.toLowerCase()===b.name.toLowerCase()){a.push(b);break}this.fields=a}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{a=[];b=[];for(const c of this.fields)if("oid"===c.type)a.push(c),b.push(c.name);else for(const d of this._overrideFields)if(d.toLowerCase()===
c.name.toLowerCase()){a.push(c);b.push(c.name);break}this.fields=a;this._overrideFields=b}this.objectIdField=this._layer.objectIdField;for(const c of this.fields)"global-id"===c.type&&(this.globalIdField=c.name);this.hasM=this._layer.supportsM;this.hasZ=this._layer.supportsZ;this._databaseType=t.FeatureServiceDatabaseType.Standardised;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};e.isTable=function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||
!this._layer.geometryType};e._isInFeatureSet=function(){return t.IdState.InFeatureSet};e._candidateIdTransform=function(a){return a};e._getSet=function(a){return null===this._wset?this._ensureLoaded().then(()=>this._getFilteredSet("",null,null,null,a)).then(b=>this._wset=b):h.resolve(this._wset)};e._changeFeature=function(a){const b={};for(const c of this.fields)b[c.name]=a.attributes[c.name];return new z({geometry:!0===this._removeGeometry?null:a.geometry,attributes:b})};e._getFilteredSet=function(a,
b,c,d,g){let m="",q=!1;null!==d&&(m=d.constructClause(),q=!0);if(this.isTable()&&b&&null!==a&&""!==a)return a=new r([],[],!0,null),h.resolve(a);d=new v;d.where=null===c?null===b?"1\x3d1":"":B.toWhereClause(c,t.FeatureServiceDatabaseType.Standardised);d.spatialRelationship=this._makeRelationshipEnum(a);d.outSpatialReference=this.spatialReference;d.orderByFields=""!==m?m.split(","):null;d.geometry=null===b?null:b;d.returnGeometry=!0;d.relationParameter=this._makeRelationshipParam(a);return this._layer.queryFeatures(d).then(u=>
{if(null===u)return new r([],[],q,null);this._checkCancelled(g);const n=[];u.features.forEach(f=>{const k=f.attributes[this._layer.objectIdField];n.push(k);this._featureCache[k]=this._changeFeature(f)});return new r([],n,q,null)})};e._makeRelationshipEnum=function(a){if(0<=a.indexOf("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";
case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};e._makeRelationshipParam=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?a.split(":")[1]:""};e._queryAllFeatures=function(){if(this._wset)return h.resolve(this._wset);const a=new v;a.where="1\x3d1";return this._ensureLoaded().then(()=>{if(this._layer.source&&this._layer.source.items){const b=
[];this._layer.source.items.forEach(c=>{const d=c.attributes[this._layer.objectIdField];b.push(d);this._featureCache[d]=this._changeFeature(c)});return this._wset=new r([],b,!1,null)}return this._layer.queryFeatures(a).then(b=>{const c=[];b.features.forEach(d=>{const g=d.attributes[this._layer.objectIdField];c.push(g);this._featureCache[g]=this._changeFeature(d)});return this._wset=new r([],c,!1,null)})})};e._getFeatures=function(a,b,c){const d=[];-1!==b&&void 0===this._featureCache[b]&&d.push(b);
for(let g=a._lastFetchedIndex;g<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[g]]&&(a._known[g]!==b&&d.push(a._known[g]),d.length>c));g++);return 0===d.length?h.resolve("success"):h.reject(Error("Unaccounted for Features. Not in Feature Collection"))};e._refineSetBlock=function(a){return h.resolve(a)};e._stat=function(){return h.resolve({calculated:!1})};e._canDoAggregates=function(){return h.resolve(!1)};e.relationshipMetaData=function(){return[]};p._cloneAttr=function(a){const b=
{};for(const c in a)b[c]=a[c];return b};e.nativeCapabilities=function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}};p.create=function(a,b){var c=a.layerDefinition.objectIdField,d=a.layerDefinition.typeIdField?a.layerDefinition.typeIdField:"";const g=[];if(a.layerDefinition.types)for(var m of a.layerDefinition.types)g.push(E.fromJSON(m));let q=a.layerDefinition.geometryType;void 0===q&&
(q=a.featureSet.geometryType||"");m=a.featureSet.features;const u=b.toJSON();if(""===c||void 0===c){var n=!1;for(var f of a.layerDefinition.fields)if("oid"===f.type||"esriFieldTypeOID"===f.type){c=f.name;n=!0;break}if(!1===n){c="FID";f=!0;for(n=0;f;){let l=!0;for(var k of a.layerDefinition.fields)if(k.name===c){l=!1;break}!0===l?f=!1:(n++,c="FID"+n.toString())}a.layerDefinition.fields.push({type:"esriFieldTypeOID",name:c,alias:c});k=[];for(f=0;f<m.length;f++)k.push({geometry:a.featureSet.features[f].geometry,
attributes:a.featureSet.features[f].attributes?this._cloneAttr(a.featureSet.features[f].attributes):{}}),k[f].attributes[c]=f;m=k}}k=[];for(const l of a.layerDefinition.fields)l instanceof x?k.push(l):k.push(x.fromJSON(l));a=q;switch(a){case "esriGeometryPoint":a="point";break;case "esriGeometryPolyline":a="polyline";break;case "esriGeometryPolygon":a="polygon";break;case "esriGeometryExtent":a="extent";break;case "esriGeometryMultipoint":a="multipoint"}for(const l of m)l.geometry&&!1===l.geometry instanceof
C&&(l.geometry.type=a,void 0===l.geometry.spatialReference&&(l.geometry.spatialReference=u));d={outFields:["*"],source:m,fields:k,types:g,typeIdField:d,objectIdField:c,spatialReference:b};d.geometryType=a?a:"point";d=new D(d);return new p({layer:d,spatialReference:b,isTable:null===a||""===a})};e.queryAttachments=function(){return h.resolve([])};e.getFeatureByObjectId=function(a){const b=new v;b.where=this.objectIdField+"\x3d"+a.toString();return this._layer.queryFeatures(b).then(c=>1===c.features.length?
c.features[0]:null)};e.getOwningSystemUrl=function(){return h.resolve("")};e.getIdentityUser=function(){return h.resolve("")};w._createClass(p,[{key:"gdbVersion",get:function(){return""}}]);return p}(A)});