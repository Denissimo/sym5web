// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../kernel ../Error ../Logger ../promiseUtils ./utils ./workerFactory".split(" "),function(r,u,v,w,n,l,x){const y=w.getLogger("esri.core.workers"),{ABORT:t,INVOKE:z,OPEN:A,OPENED:B,RESPONSE:m}=l.MessageType;return function(){function p(a,c){this._outJobs=new Map;this._inJobs=new Map;this.worker=a;this.id=c;a.addEventListener("message",this._onMessage.bind(this));a.addEventListener("error",b=>{b.preventDefault();y.error(b)})}p.create=function(){var a=
r._asyncToGenerator(function*(c){const b=yield x.createWorker();return new p(b,c)});return function(c){return a.apply(this,arguments)}}();var d=p.prototype;d.terminate=function(){this.worker.terminate()};d.open=function(){var a=r._asyncToGenerator(function*(c,b={}){const {signal:e}=b,f=l.newJobId();return new Promise((h,q)=>{const k=n.onAbortOrThrow(e,()=>{this._outJobs.delete(f);this._post({type:t,jobId:f})});this._outJobs.set(f,{resolve:h,reject:q,abortHandle:k});this._post({type:A,jobId:f,modulePath:c})})});
return function(c){return a.apply(this,arguments)}}();d._onMessage=function(a){if(a=l.receiveMessage(a))switch(a.type){case B:this._onOpenedMessage(a);break;case m:this._onResponseMessage(a);break;case t:this._onAbortMessage(a);break;case z:this._onInvokeMessage(a)}};d._onAbortMessage=function(a){const c=this._inJobs;a=a.jobId;const b=c.get(a);b&&(b.controller&&b.controller.abort(),c.delete(a))};d._onInvokeMessage=function(a){const {methodName:c,jobId:b,data:e,abortable:f}=a;a=f?n.createAbortController():
null;const h=this._inJobs,q=u.workerMessages[c];let k;try{if("function"!==typeof q)throw new TypeError(`${c} is not a function`);k=q.call(null,e,{signal:a?a.signal:null})}catch(g){this._post({type:m,jobId:b,error:l.toInvokeError(g)});return}n.isPromiseLike(k)?(h.set(b,{controller:a,promise:k}),k.then(g=>{h.has(b)&&(h.delete(b),this._post({type:m,jobId:b},g))},g=>{h.has(b)&&(h.delete(b),g||(g={message:"Error encountered at method"+c}),n.isAbortError(g)||this._post({type:m,jobId:b,error:l.toInvokeError(g||
{message:`Error encountered at method ${c}`})}))})):this._post({type:m,jobId:b},k)};d._onOpenedMessage=function(a){var c;const {jobId:b,data:e}=a;if(a=this._outJobs.get(b))this._outJobs.delete(b),null==(c=a.abortHandle)?void 0:c.remove(),a.resolve(e)};d._onResponseMessage=function(a){var c;const {jobId:b,error:e,data:f}=a;if(a=this._outJobs.get(b))this._outJobs.delete(b),null==(c=a.abortHandle)?void 0:c.remove(),e?a.reject(v.fromJSON(JSON.parse(e))):a.resolve(f)};d._post=function(a,c,b){return l.postMessage(this.worker,
a,c,b)};return p}()});