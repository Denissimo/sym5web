// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../ArrayPool ../lang ../ReentrantObjectPool ../scheduling ../SetUtils ./get ./trackingUtils ./utils".split(" "),function(k,C,v,D,E,F,w,x,q){function y(a){g.delete(a);g.add(a);r||(r=E.schedule(z))}function A(a){if(!a.removed){var {callback:b,path:e,oldValue:d,target:c}=a,h=a.getValue();v.equals(d,h)||(a.oldValue=h,b.call(c,h,d,e,c))}}function z(){let a=10;for(;r&&a--;){r=null;const e=G(),d=t.acquire();for(const c of e){var b=c.uid;A(c);b===c.uid&&c.removed&&d.push(c)}for(const c of g)c.removed&&
(d.push(c),g.delete(c));for(b=0;b<d.length;b++)m.pool.release(d[b]);t.release(d);t.release(e);u.forEach(c=>c())}}function G(){const a=t.acquire();a.length=g.size;let b=0;for(const e of g)a[b]=e,++b;g.clear();return a}function H(a,b,e){let d=q.parse(a,b,e,(c,h,n)=>{let f,l,p=x.reactionAsync(()=>w.valueOf(c,h),(I,J)=>{c.__accessor__.destroyed||f&&f.uid!==l?d.remove():(f||(f=m.pool.acquire(c,h,I,n,J),l=f.uid),y(f))});return{remove:q.once(function(){p.remove();f&&(f.uid!==l||f.removed||(f.removed=!0,
y(f)),f=null);d=p=null})}});return d}function K(a,b,e){const d=q.parse(a,b,e,(c,h,n)=>{let f=!1;return x.reaction(()=>w.valueOf(c,h),(l,p)=>{c.__accessor__.destroyed?d.remove():f||(f=!0,v.equals(p,l)||n.call(c,l,p,h,c),f=!1)})});return d}function B(a,b,e,d=!1){return!a.__accessor__||a.__accessor__.destroyed?{remove(){}}:d?K(a,b,e):H(a,b,e)}let m=function(){function a(){this.uid=0;this.getValue=this.callback=this.oldValue=this.path=this.target=null;this.removed=!1;this.propertyPath=null}var b=a.prototype;
b.acquire=function(e,d,c,h,n){this.target=e;this.path=d;this.oldValue=c;this.callback=h;this.getValue=n;this.propertyPath=q.pathToStringOrArray(d);this.uid=++a.uid;this.removed=!1};b.release=function(){this.target=this.path=this.propertyPath=this.callback=this.oldValue=null;this.uid=++a.uid;this.removed=!0};return a}();m.pool=new D.ReentrantObjectPool(m);m.uid=0;const t=new C,g=new Set;let r;const u=new Set;k.afterDispatch=function(a){u.add(a);return{remove(){u.delete(a)}}};k.default=B;k.dispatch=
z;k.dispatchTarget=function(a){const b=Array.from(g);for(let e=0;e<b.length;e++){const d=b[e];d.target===a&&(A(d),g.delete(d))}};k.isValueInUse=function(a){return F.someSet(g,b=>b.oldValue===a)};k.removeTarget=function(a){for(const b of g.values())b.target===a&&(b.removed=!0)};k.watch=B;Object.defineProperty(k,"__esModule",{value:!0})});