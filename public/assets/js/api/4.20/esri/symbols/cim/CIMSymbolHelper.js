// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../Color ../../core/Logger ../../core/mathUtils ./CIMPlacements ./CIMSymbolDrawHelper ./packingUtils".split(" "),function(n,y,q,z,w,r,A){function t(g,a){switch(a.type){case "CIMSymbolReference":g.drawSymbol(a.symbol,{type:"point",x:0,y:0});break;case "CIMPointSymbol":g.drawSymbol(a,{type:"point",x:0,y:0});break;case "CIMVectorMarker":{const b=new w.Placement;g.drawMarker(a,b)}}return g.envelope()}const x=Math.PI,B=x/2,u=q.getLogger("esri.symbols.cim.CIMSymbolHelper");q=function(){function g(){}
g.getEnvelope=function(a){const b=new r.EnvDrawHelper;if(Array.isArray(a)){let c;for(const d of a)c?c.union(t(b,d)):c=t(b,d);return c}return t(b,a)};g.getTextureAnchor=function(a){a=this.getEnvelope(a);if(!a||0>=a.width||0>=a.height)return[0,0,0];const b=96/72,c=a.height*b+2;return[(a.x+.5*a.width)*b/(a.width*b+2),-(a.y+.5*a.height)*b/c,c]};g.rasterize=function(a,b,c,d=!0){var e=c||this.getEnvelope(b);if(!e||0>=e.width||0>=e.height)return[null,0,0,0,0];var f=96/72;const l=(e.x+.5*e.width)*f,h=(e.y+
.5*e.height)*f;a.width=e.width*f;a.height=e.height*f;c||(a.width+=2,a.height+=2);c=a.getContext("2d");f=r.Transformation.createScale(f,-f);f.translate(.5*a.width-l,.5*a.height+h);f=new r.CanvasDrawHelper(c,f);switch(b.type){case "CIMPointSymbol":f.drawSymbol(b,{type:"point",x:0,y:0});break;case "CIMVectorMarker":e=new w.Placement,f.drawMarker(b,e)}b=c.getImageData(0,0,a.width,a.height);b=new Uint8Array(b.data);if(d)for(c=0;c<b.length;c+=4)d=b[c+3]/255,b[c]*=d,b[c+1]*=d,b[c+2]*=d;return[b,a.width,
a.height,-l/a.width,-h/a.height]};g.fromSimpleMarker=function(a){var b=a.style;if("circle"===b||"esriSMSCircle"===b){var c=Math.acos(.995);var d=Math.ceil(x/c/4);0===d&&(d=1);c=B/d;d*=4;b=[];b.push([50,0]);for(let f=1;f<d;f++)b.push([50*Math.cos(f*c),-50*Math.sin(f*c)]);b.push([50,0]);c={rings:[b]};d={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("cross"===b||"esriSMSCross"===b)c={rings:[[[0,50],[0,0],[50,0],[50,-0],[0,-0],[0,-50],[-0,-50],[-0,-0],[-50,-0],[-50,0],[-0,0],[-0,50],[0,50]]]},d={xmin:-50,
ymin:-50,xmax:50,ymax:50};else if("diamond"===b||"esriSMSDiamond"===b)c={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},d={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===b||"esriSMSSquare"===b)c={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},d={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===b||"esriSMSX"===b)c={rings:[[[0,0],[50,50],[50,50],[0,0],[50,-50],[50,-50],[0,-0],[-50,-50],[-50,-50],[-0,0],[-50,50],[-50,50],[0,0]]]},d={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("triangle"===
b||"esriSMSTriangle"===b)d=2/3*100,b=d-100,c={rings:[[[-57.735026918962575,b],[0,d],[57.735026918962575,b],[-57.735026918962575,b]]]},d={xmin:-57.735026918962575,ymin:b,xmax:57.735026918962575,ymax:d};else if("arrow"===b||"esriSMSArrow"===b)c={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},d={xmin:-50,ymin:-50,xmax:50,ymax:50};if(c&&d){var e=[{type:"CIMSolidFill",enable:!0,color:a.color}];a.outline&&e.push({type:"CIMSolidStroke",enable:!0,width:a.outline.width,color:a.outline.color});
e={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:a.angle,size:a.size,offsetX:a.xoffset,offsetY:a.yoffset,frame:d,markerGraphics:[{type:"CIMMarkerGraphic",geometry:c,symbol:{type:"CIMPolygonSymbol",symbolLayers:e}}]}]}}return e};g.fromCIMHatchFill=function(a){const b=void 0!==a.separation?a.separation:4,c=b/2;for(var d=this._getLineSymbolPeriod(a.lineSymbol)||4;4>d;)d*=2;d/=2;return{type:"CIMVectorMarker",frame:{xmin:-d,xmax:d,ymin:-c,ymax:c},markerGraphics:[{type:"CIMMarkerGraphic",
geometry:{paths:[[[-d,0],[d,0]]]},symbol:a.lineSymbol}],size:b}};g._getLineSymbolPeriod=function(a){if(a){const b=this._getEffectsRepeat(a.effects);if(b)return b;if(a.symbolLayers)for(const c of a.symbolLayers)if((a=this._getEffectsRepeat(c.effects))||c&&(a=this._getPlacementRepeat(c.markerPlacement)))return a}return 0};g._getEffectsRepeat=function(a){if(a)for(var b of a)if(b)switch(b.type){case "CIMGeometricEffectDashes":if((a=b.dashTemplate)&&a.length){b=0;for(const c of a)b+=c;a.length&1&&(b*=
2);return b}break;case "CIMGeometricEffectWave":return b.period;default:u.error(`unsupported geometric effect type ${b.type}`)}return 0};g._getPlacementRepeat=function(a){if(a)switch(a.type){case "CIMMarkerPlacementAlongLineSameSize":case "CIMMarkerPlacementAlongLineRandomSize":case "CIMMarkerPlacementAlongLineVariableSize":if((a=a.placementTemplate)&&a.length){let b=0;for(const c of a)b+=c;a.length&1&&(b*=2);return b}}return 0};g.fromCIMInsidePolygon=function(a){var b=a.markerPlacement;const c={type:a.type,
...a,markerPlacement:null,anchorPoint:null};let d,e;!0===b.shiftOddRows?(a=b.stepX/2,d=b.stepY,e=2*b.stepY,b=[{x:-a,y:0},{x:a,y:0},{x:0,y:d},{x:0,y:-d}].map(f=>({type:"CIMMarkerGraphic",geometry:f,symbol:{type:"CIMPointSymbol",symbolLayers:[c]}}))):(a=b.stepX/2,d=b.stepY/2,e=b.stepY,b=[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMPointSymbol",symbolLayers:[c]}}]);return{type:"CIMVectorMarker",frame:{xmin:-a,xmax:a,ymin:-d,ymax:d},markerGraphics:b,size:e}};g.getFillColor=function(a){if(!a)return null;
switch(a.type){case "CIMPolygonSymbol":if(a.symbolLayers)for(const b of a.symbolLayers)if(a=g.getFillColor(b),null!=a)return a;break;case "CIMTextSymbol":return g.getFillColor(a.symbol);case "CIMSolidFill":return a.color}};g.getStrokeColor=function(a){if(a)switch(a.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(a.symbolLayers)for(const b of a.symbolLayers)if(a=g.getStrokeColor(b),void 0!==a)return a;break;case "CIMTextSymbol":return g.getStrokeColor(a.symbol);case "CIMSolidStroke":return a.color}};
g.getStrokeWidth=function(a){if(a)switch(a.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(a.symbolLayers)for(const b of a.symbolLayers)if(a=g.getStrokeWidth(b),void 0!==a)return a;break;case "CIMTextSymbol":return g.getStrokeWidth(a.symbol);case "CIMSolidStroke":case "CIMGradientStroke":case "CIMPictureStroke":return a.width}};g.getSize=function(a){if(a)switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":{let b=0;if(a.symbolLayers)for(const c of a.symbolLayers)a=
g.getSize(c),a>b&&(b=a);return b}case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":return a.width;case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":return a.size}};g.getMarkerScaleRatio=function(a){if(a)switch(a.type){case "CIMVectorMarker":if(!1!==a.scaleSymbolsProportionally&&a.frame)return a.size/(a.frame.ymax-a.frame.ymin)}return 1};return g}();let C=function(){function g(){}g.rasterizeSimpleFill=function(a,b,c){"solid"!==b&&"none"!==b&&"esriSFSSolid"!==
b&&"esriSFSNull"!==b||console.error("Unexpected: style does not require rasterization");c=z.nextPowerOfTwo(Math.ceil(c));var d=this._isHorizontalOrVertical(b)?8*c:16*c;const e=2*c;a.width=d;a.height=d;const f=a.getContext("2d");f.strokeStyle="#FFFFFF";f.lineWidth=c;f.beginPath();if("vertical"===b||"cross"===b||"esriSFSCross"===b||"esriSFSVertical"===b)f.moveTo(d/2,-e),f.lineTo(d/2,d+e);if("horizontal"===b||"cross"===b||"esriSFSCross"===b||"esriSFSHorizontal"===b)f.moveTo(-e,d/2),f.lineTo(d+e,d/2);
if("forward-diagonal"===b||"diagonal-cross"===b||"esriSFSDiagonalCross"===b||"esriSFSForwardDiagonal"===b)f.moveTo(-e,-e),f.lineTo(d+e,d+e),f.moveTo(d-e,-e),f.lineTo(d+e,e),f.moveTo(-e,d-e),f.lineTo(e,d+e);if("backward-diagonal"===b||"diagonal-cross"===b||"esriSFSBackwardDiagonal"===b||"esriSFSDiagonalCross"===b)f.moveTo(d+e,-e),f.lineTo(-e,d+e),f.moveTo(e,-e),f.lineTo(-e,e),f.moveTo(d+e,d-e),f.lineTo(d-e,d+e);f.stroke();b=f.getImageData(0,0,a.width,a.height);b=new Uint8Array(b.data);for(d=0;d<b.length;d+=
4)c=b[d+3]/255,b[d]*=c,b[d+1]*=c,b[d+2]*=c;return[b,a.width,a.height]};g.rasterizeSimpleLine=function(a,b){switch(b){case "butt":b="Butt";break;case "square":b="Square";break;default:b="Round"}const c="Butt"===b;switch(a){case "dash":case "esriSLSDash":a=c?[4,3]:[3,4];break;case "dash-dot":case "esriSLSDashDot":a=c?[4,3,1,3]:[3,4,0,4];break;case "dot":case "esriSLSDot":a=c?[1,3]:[0,4];break;case "long-dash":case "esriSLSLongDash":a=c?[8,3]:[7,4];break;case "long-dash-dot":case "esriSLSLongDashDot":a=
c?[8,3,1,3]:[7,4,0,4];break;case "long-dash-dot-dot":case "esriSLSDashDotDot":a=c?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case "short-dash":case "esriSLSShortDash":a=c?[4,1]:[3,2];break;case "short-dash-dot":case "esriSLSShortDashDot":a=c?[4,1,1,1]:[3,2,0,2];break;case "short-dash-dot-dot":case "esriSLSShortDashDotDot":a=c?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case "short-dot":case "esriSLSShortDot":a=c?[1,1]:[0,2];break;case "solid":case "esriSLSSolid":case "none":u.error("Unexpected: style does not require rasterization");
a=[0,0];break;default:u.error(`Tried to rasterize SLS, but found an unexpected style: ${a}!`),a=[0,0]}return this.rasterizeDash(a,b)};g.rasterizeDash=function(a,b){var c="Butt"===b,d="Square"===b;b=!c&&!d;1===a.length%2&&(a=[...a,...a]);var e=0;for(var f of a)e+=f;f=Math.round(15.5*e);e=new Float32Array(31*f);let l=0,h=0,k=.5,v=!0;for(var p of a){l=h;for(h+=15.5*p;k<=h;){for(a=.5;31>a;){const m=b?(a-15.5)*(a-15.5):Math.abs(a-15.5);e[(a-.5)*f+k-.5]=v?c?Math.max(Math.max(l+7.75-k,m),Math.max(k-h+7.75,
m)):m:b?Math.min((k-l)*(k-l)+m,(k-h)*(k-h)+m):d?Math.min(Math.max(k-l,m),Math.max(h-k,m)):Math.min(Math.max(k-l+7.75,m),Math.max(h+7.75-k,m));a++}k++}v=!v}c=e.length;p=new Uint8Array(4*c);for(d=0;d<c;++d)A.packFloatRGBA((b?Math.sqrt(e[d]):e[d])/15.5,p,4*d);return[p,f,31]};g._isHorizontalOrVertical=function(a){return"vertical"===a||"horizontal"===a||"cross"===a||"esriSFSCross"===a||"esriSFSVertical"===a||"esriSFSHorizontal"===a};return g}(),D=function(){function g(){}g.findApplicableOverrides=function(a,
b,c){if(b){if(a.primitiveName){let d=!1;for(const e of c)if(e.primitiveName===a.primitiveName){d=!0;break}if(!d)for(const e of b)e.primitiveName===a.primitiveName&&c.push(e)}switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(a.effects)for(const d of a.effects)g.findApplicableOverrides(d,b,c);if(a.symbolLayers)for(const d of a.symbolLayers)g.findApplicableOverrides(d,b,c);break;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":case "CIMSolidFill":case "CIMPictureFill":case "CIMHatchFill":case "CIMGradientFill":case "CIMVectorMarker":case "CIMCharacterMarker":case "CIMPictureMarker":if(a.effects)for(const d of a.effects)g.findApplicableOverrides(d,
b,c);a.markerPlacement&&g.findApplicableOverrides(a.markerPlacement,b,c);if("CIMVectorMarker"===a.type){if(a.markerGraphics)for(const d of a.markerGraphics)g.findApplicableOverrides(d,b,c),g.findApplicableOverrides(d.symbol,b,c)}else"CIMCharacterMarker"===a.type?g.findApplicableOverrides(a.symbol,b,c):"CIMHatchFill"===a.type&&g.findApplicableOverrides(a.lineSymbol,b,c)}}};g.applyOverrides=function(a,b,c,d){if(b){if(a.primitiveName)for(const f of b)if(f.primitiveName===a.primitiveName){var e=(e=f.propertyName)?
e.charAt(0).toLowerCase()+e.substr(1):e;d&&d.push({cim:a,nocapPropertyName:e,value:a[e]});f.expression&&(f.value=g.toValue(f.propertyName,f.expression));if(c){let l=!1;for(const h of c)h.primitiveName===a.primitiveName&&(l=!0);l||c.push(f)}a[e]=f.value}switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(a.effects)for(const f of a.effects)g.applyOverrides(f,b,c,d);if(a.symbolLayers)for(const f of a.symbolLayers)g.applyOverrides(f,b,c,d);break;case "CIMSolidStroke":case "CIMSolidFill":case "CIMVectorMarker":if(a.effects)for(const f of a.effects)g.applyOverrides(f,
b,c,d);if("CIMVectorMarker"===a.type&&a.markerGraphics)for(const f of a.markerGraphics)g.applyOverrides(f,b,c,d),g.applyOverrides(f.symbol,b,c,d)}}};g.restoreOverrides=function(a){for(const b of a)b.cim[b.nocapPropertyName]=b.value};g.buildOverrideKey=function(a){let b="";for(const c of a)void 0!==c.value&&(b+=`${c.primitiveName}${c.propertyName}${JSON.stringify(c.value)}`);return b};g.toValue=function(a,b){return"DashTemplate"===a?b.split(" ").map(c=>Number(c)):"Color"===a?(a=(new y(b)).toRgba(),
a[3]*=255,a):b};return g}();n.CIMSymbolHelper=q;n.OverrideHelper=D;n.SymbolHelper=C;Object.defineProperty(n,"__esModule",{value:!0})});