// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.20/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../request ../../core/promiseUtils ../../core/screenUtils ../../core/string ../../geometry/support/jsonUtils ./cimAnalyzer ./Rasterizer ./TextRasterizer ./utils ../support/cimSymbolUtils ../support/Symbol3DAnchorPosition2D".split(" "),function(B,E,R,S,t,T,D,G,U,V,q,W,X){function Y(l){return(l?Object.keys(l):[]).map(r=>({name:r,alias:r,type:"string"===typeof l[r]?"esriFieldTypeString":"esriFieldTypeDouble"}))}function Z(l){if(!(l&&l.data&&l.data.symbol))return null;
switch(l.data.symbol.type){case "CIMPointSymbol":case "CIMTextSymbol":return"esriGeometryPoint";case "CIMLineSymbol":return"esriGeometryPolyline";case "CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function C(l,r,a,b){if("function"===typeof l.materialHash){const d=l.materialHash;r=d(r,a,b);l=G.analyzeCIMResource(l.cim,l.materialOverrides)}else r=l.materialHash,l=l.cim;return{analyzedCIM:l,hash:r}}B.GeometryStyle=void 0;(function(l){l.Legend="legend";l.Preview="preview"})(B.GeometryStyle||
(B.GeometryStyle={}));const F=(l,r,a)=>l&&l.targetSize?a?l.targetSize/t.pt2px(Math.max(a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin)):l.targetSize/r.referenceSize:l&&l.scaleFactor?l.scaleFactor:1,H={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,
100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};let aa=function(){function l(a,b){this._spatialReference=a;this._avoidSDF=b;this._resourceCache=new Map;this._rasterizer=new U;this._textRasterizer=new V.TextRasterizer;this._pictureMarkerCache=
new Map}var r=l.prototype;r.rasterizeCIMSymbolAsync=function(){var a=E._asyncToGenerator(function*(b,d,f,c,k,h,g,e){c=c||(d?null!=d.centroid?"esriGeometryPolygon":D.getJsonType(d.geometry):null)||Z(b);b=yield this.analyzeCIMSymbol(b,d?Y(d.attributes):null,f,c,e);return this.rasterizeCIMSymbol(b,d,c,k,h,g)});return function(b,d,f,c,k,h,g,e){return a.apply(this,arguments)}}();r.analyzeCIMSymbol=function(){var a=E._asyncToGenerator(function*(b,d,f,c,k){const h=[];yield G.analyzeCIMSymbol(b.data,d?{geometryType:c,
spatialReference:this._spatialReference,fields:d}:null,h,this._avoidSDF);S.throwIfAborted(k);let g;for(const e of h){if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type||"CIMPictureStroke"===e.cim.type)g||(g=[]),g.push(this.fetchPictureMarkerResource(e,k));f&&"text"===e.type&&"string"===typeof e.text&&-1<e.text.indexOf("[")&&(e.text=q.createLabelOverrideFunction(f,e.text,e.cim.textCase))}g&&(yield Promise.all(g));return h});return function(b,d,f,c,k){return a.apply(this,arguments)}}();
r.fetchPictureMarkerResource=function(){var a=E._asyncToGenerator(function*(b,d){const f=b.materialHash;this._pictureMarkerCache.get(f)||(b=(yield R(b.cim.url,{responseType:"image",signal:d&&d.signal})).data,this._pictureMarkerCache.set(f,b))});return function(b,d){return a.apply(this,arguments)}}();r.rasterizeCIMSymbol=function(a,b,d,f,c,k){const h=[];for(const e of a){f&&"function"===typeof f.scaleFactor&&(f.scaleFactor=f.scaleFactor(b,c,k));a=this._getRasterizedResource(e,b,d,f,c,k);if(!a)continue;
let n=0,m=a.anchorX||0,p=a.anchorY||0,x=!1,u=0;var g=0;if("esriGeometryPoint"===d)if(g=F(f,e,null),u=q.evaluateValueOrFunction(e.offsetX,b,c,k)*g||0,g=q.evaluateValueOrFunction(e.offsetY,b,c,k)*g||0,"marker"===e.type)n=q.evaluateValueOrFunction(e.rotation,b,c,k)||0,x=e.rotateClockwise?e.rotateClockwise:!1;else if("text"===e.type){n=q.evaluateValueOrFunction(e.angle,b,c,k)||0;if(void 0!==e.horizontalAlignment)switch(e.horizontalAlignment){case "left":m=-.5;break;case "right":m=.5;break;default:m=0}if(void 0!==
e.verticalAlignment)switch(e.verticalAlignment){case "top":p=.5;break;case "bottom":p=-.5;break;case "baseline":p=-.25;break;default:p=0}}null!=a&&h.push({angle:n,rotateClockWise:x,anchorX:m,anchorY:p,offsetX:u,offsetY:g,rasterizedResource:a})}return this.getSymbolImage(h)};r.getSymbolImage=function(a){const b=document.createElement("canvas"),d=b.getContext("2d");var f=0,c=0,k=0,h=0,g=[];for(var e=0;e<a.length;e++){var n=a[e],m=n.rasterizedResource;if(!m)continue;var p=m.size,x=n.offsetX;const I=
n.offsetY,J=n.anchorX,K=n.anchorY,L=n.rotateClockWise||!1;n=n.angle;var u=t.pt2px(x)-p[0]*(.5+J);let y=t.pt2px(I)-p[1]*(.5+K),A=u+p[0];var w=y+p[1];if(n){L&&(n=-n);var v=Math.sin(n*Math.PI/180);const z=Math.cos(n*Math.PI/180);p=u*z-y*v;const M=u*v+y*z,N=u*z-w*v,O=u*v+w*z,P=A*z-w*v;w=A*v+w*z;const Q=A*z-y*v;v=A*v+y*z;u=Math.min(p,N,P,Q);y=Math.min(M,O,w,v);A=Math.max(p,N,P,Q);w=Math.max(M,O,w,v)}f=u<f?u:f;c=y<c?y:c;k=A>k?A:k;h=w>h?w:h;u=d.createImageData(m.size[0],m.size[1]);u.data.set(new Uint8ClampedArray(m.image.buffer));
g.push({offsetX:x,offsetY:I,rotateClockwise:L,angle:n,rasterizedImage:u,anchorX:J,anchorY:K})}b.width=k-f;b.height=h-c;a=-f;for(f=0;f<g.length;f++)c=g[f],k=this._imageDataToCanvas(c.rasterizedImage),e=a-c.rasterizedImage.width*(.5+c.anchorX),m=h-c.rasterizedImage.height*(.5-c.anchorY),c.angle?(x=(360-c.angle)*Math.PI/180,d.save(),d.translate(t.pt2px(c.offsetX),-t.pt2px(c.offsetY)),d.translate(a,h),d.rotate(x),d.translate(-a,-h),d.drawImage(k,e,m),d.restore()):d.drawImage(k,e+t.pt2px(c.offsetX),m-
t.pt2px(c.offsetY));g=new X["default"]({x:a/b.width-.5,y:h/b.height-.5});return{imageData:0!==b.width&&0!==b.height?d.getImageData(0,0,b.width,b.height):d.createImageData(1,1),anchorPosition:g}};r._imageDataToCanvas=function(a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const b=this._imageDataCanvas,d=b.getContext("2d");b.width=a.width;b.height=a.height;d.putImageData(a,0,0);return b};r._imageTo32Array=function(a,b,d){this._imageDataCanvas||(this._imageDataCanvas=
document.createElement("canvas"));const f=this._imageDataCanvas,c=f.getContext("2d");f.width=b;f.height=d;c.drawImage(a,0,0,b,d);return new Uint32Array(c.getImageData(0,0,b,d).data.buffer)};r._getRasterizedResource=function(a,b,d,f,c,k){if("esriGeometryPolyline"===d||"esriGeometryPolygon"===d){var h=f&&f.style?f.style:B.GeometryStyle.Legend;h="esriGeometryPolyline"===d?H.stroke[h]:H.fill[h];if("line"===a.type)if("CIMSolidStroke"===a.cim.type){({analyzedCIM:g,hash:e}=C(a,b,c,k));var g=this._embedCIMLayerInVectorMarker(g,
h)}else{if("CIMPictureStroke"===a.cim.type){var e=q.evaluateValueOrFunction(a.width,b,c,k);const {image:n,width:m,height:p}=this._getPictureResource(a,e);return this._rasterizePictureResource(a,n,m,p,h,e)}return null}else if("marker"===a.type)if("CIMPictureMarker"!==a.cim.type&&"CIMVectorMarker"===a.cim.type)a.cim.offsetX=q.evaluateValueOrFunction(a.offsetX,b,c,k),a.cim.offsetY=q.evaluateValueOrFunction(a.offsetY,b,c,k),a.cim.rotation=q.evaluateValueOrFunction(a.rotation,b,c,k),a.cim.markerPlacement=
a.markerPlacement,{analyzedCIM:g}=C(a,b,c,k),e=T.numericHash(JSON.stringify(g)).toString(),g=this._embedCIMLayerInVectorMarker(g,h);else return null;else{if("text"===a.type)return null;if("fill"===a.type){if("CIMHatchFill"===a.cim.type||"CIMVectorMarker"===a.cim.type||"CIMPictureMarker"===a.cim.type||"CIMPictureFill"===a.cim.type)return e=a.cim.size||a.cim.height,"CIMPictureMarker"===a.cim.type||"CIMPictureFill"===a.cim.type?{image:e,width:b,height:c}=this._getPictureResource(a,e):({analyzedCIM:g,
hash:e}=C(a,b,c,k),c=this._rasterizer.rasterizeJSONResource(g,1,this._avoidSDF),e=c.image,b=c.size[0],c=c.size[1]),this._rasterizePictureResource(a,e,b,c,h,null);if("CIMSolidFill"===a.cim.type)({analyzedCIM:g,hash:e}=C(a,b,c,k)),g=this._embedCIMLayerInVectorMarker(g,h);else return null}}}else{if("text"===a.type)return h=this._rasterizeTextResource(a,b,f,c,k);({analyzedCIM:g,hash:e}=C(a,b,c,k));h=F(f,a,null);if("CIMPictureMarker"===a.cim.type){h*=q.evaluateValueOrFunction(a.size,b,c,k);const {image:n,
width:m,height:p}=this._getPictureResource(a,h);return h={image:n,size:[m,p],sdf:!1,simplePattern:!1,anchorX:a.anchorPoint?a.anchorPoint.x:0,anchorY:a.anchorPoint?a.anchorPoint.y:0}}W.scaleCIMMarker(g,h,{preserveOutlineWidth:!1})}e+=d;f&&(e+=JSON.stringify(f));a=this._resourceCache;if(a.has(e))return a.get(e);h=this._rasterizer.rasterizeJSONResource(g,window.devicePixelRatio||1,this._avoidSDF);a.set(e,h);return h};r._rasterizeTextResource=function(a,b,d,f,c){var k=F(d,a,null);d=q.evaluateValueOrFunction(a.text,
b,f,c);if(!d||0===d.length)return null;const h=q.evaluateValueOrFunction(a.fontName,b,f,c),g=q.evaluateValueOrFunction(a.style,b,f,c),e=q.evaluateValueOrFunction(a.weight,b,f,c),n=q.evaluateValueOrFunction(a.decoration,b,f,c);k*=q.evaluateValueOrFunction(a.size,b,f,c);const m=q.evaluateValueOrFunction(a.horizontalAlignment,b,f,c),p=q.evaluateValueOrFunction(a.verticalAlignment,b,f,c),x=q.colorToArray(q.evaluateValueOrFunction(a.color,b,f,c)),u=q.colorToArray(q.evaluateValueOrFunction(a.outlineColor,
b,f,c));a=q.evaluateValueOrFunction(a.outlineSize,b,f,c);return this._textRasterizer.rasterizeText(d,{color:x,size:k,horizontalAlignment:m,verticalAlignment:p,font:{family:h,style:g,weight:e,decoration:n},halo:{size:a||0,color:u,style:g},pixelRatio:1,premultiplyColors:!this._avoidSDF})};r._rasterizePictureResource=function(a,b,d,f,c,k){const h=document.createElement("canvas");var g=h.getContext("2d");h.height=t.pt2px(Math.max(Math.abs(c.frame.ymax-c.frame.ymin),k));h.width=t.pt2px(Math.abs(c.frame.xmax-
c.frame.xmin));d=g.createImageData(d,f);d.data.set(new Uint8ClampedArray(b.buffer));b=this._imageDataToCanvas(d);b=g.createPattern(b,"repeat");d=Math.cos((-a.cim.rotation||0)*Math.PI/180);f=Math.sin((-a.cim.rotation||0)*Math.PI/180);b.setTransform({m11:d,m12:f,m21:-f,m22:d,m41:t.pt2px(a.cim.offsetX)||0,m42:t.pt2px(a.cim.offsetY)||0});a=c.canvasPaths;let e,n;if(D.isPolygon(a)){var m=a.rings;g.fillStyle=b;e=g.fill;n=["evenodd"]}else D.isPolyline(a)&&(m=a.paths,g.strokeStyle=b,g.lineWidth=k,e=g.stroke,
m[0][0][1]=h.height/2,m[0][1][1]=h.height/2);g.beginPath();for(const p of m)if(k=p?p.length:0,1<k){m=p[0];g.moveTo(t.pt2px(m[0]),t.pt2px(m[1]));for(a=1;a<k;++a)m=p[a],g.lineTo(t.pt2px(m[0]),t.pt2px(m[1]));g.closePath()}e.apply(g,n);g=g.getImageData(0,0,h.width,h.height);g=new Uint8Array(g.data);return{size:[h.width,h.height],image:new Uint32Array(g.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}};r._getPictureResource=function(a,b){a=this._pictureMarkerCache.get(a.materialHash);if(!a)return null;
const d=a.height/a.width,f=b?1<d?t.pt2px(b):t.pt2px(b)/d:a.width;b=b?1<d?t.pt2px(b)*d:t.pt2px(b):a.height;return{image:this._imageTo32Array(a,f,b),width:f,height:b}};r._embedCIMLayerInVectorMarker=function(a,b){const d=D.isPolygon(b.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:b.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:b.geometry,symbol:{type:d,symbolLayers:[a]}}]}};return l}();B.CIMSymbolRasterizer=aa;Object.defineProperty(B,"__esModule",{value:!0})});